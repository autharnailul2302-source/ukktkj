<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Try Out Mandiri UKK TKJ</title>
    
    <script>
        window.onerror = function(message, source, lineno, colno, error) {
            if(message.includes("ResizeObserver")) return;
            // alert("Sistem Error: " + message + "\nBaris: " + lineno); // Silent error for production smoothness
            console.error(message, lineno);
        };
    </script>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- Firebase SDK (Modular) -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, getDocs, doc, updateDoc, deleteDoc, setDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- FIX: EXPOSE FIREBASE FUNCTIONS TO GLOBAL SCOPE ---
        window.getDocs = getDocs;
        window.collection = collection;
        window.addDoc = addDoc;
        window.onSnapshot = onSnapshot;
        window.query = query;
        window.doc = doc;
        window.updateDoc = updateDoc;
        window.deleteDoc = deleteDoc;
        window.setDoc = setDoc;
        // -----------------------------------------------------

        window.db = null;
        window.auth = null;
        window.appId = 'ukktkj'; 
        window.isFirebaseReady = false;
        window.currentExamToken = "TKJ2025"; 
        window.allQuestionsDB = []; 
        window.currentExamDocId = null; // ID dokumen ujian siswa saat ini

        async function initFirebase() {
            try {
                let firebaseConfig;
                const customConfig = {
                    apiKey: "AIzaSyAdqApOvuUXrZUO19NfiqZCLSyUYR74w5M",
                    authDomain: "waliq-ded98.firebaseapp.com",
                    projectId: "waliq-ded98",
                    storageBucket: "waliq-ded98.firebasestorage.app",
                    messagingSenderId: "915222555864",
                    appId: "1:915222555864:web:25320841c97661172e3bad",
                    measurementId: "G-K51RW0YQ0M"
                };

                if (customConfig.apiKey && customConfig.apiKey !== "GANTI_DENGAN_API_KEY_ANDA") {
                    console.log("Menggunakan Konfigurasi Manual");
                    firebaseConfig = customConfig;
                } else if (typeof __firebase_config !== 'undefined') {
                    firebaseConfig = JSON.parse(__firebase_config);
                } else {
                    updateConnectionStatus(false, "Offline (Perlu Config)");
                    alert("Mode Offline: Config Firebase belum diatur.");
                    return;
                }

                if (typeof __app_id !== 'undefined') window.appId = __app_id;

                const app = initializeApp(firebaseConfig);
                window.auth = getAuth(app);
                window.db = getFirestore(app);

                try {
                    if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                        await signInWithCustomToken(window.auth, __initial_auth_token);
                    } else {
                        await signInAnonymously(window.auth);
                    }
                } catch (authErr) {
                    console.error("Auth Error:", authErr);
                    let pesan = "Gagal Login Database: " + authErr.message;
                    if (authErr.code === 'auth/operation-not-allowed') pesan = "⚠️ ERROR: Aktifkan Anonymous Auth di Firebase Console.";
                    alert(pesan);
                    throw authErr;
                }
                
                window.isFirebaseReady = true;
                console.log("Firebase Connected");
                updateConnectionStatus(true, "Terhubung ke Server");
                
                listenForToken();
                listenForQuestions(); 
                
                if (window.currentUserRole === 'teacher') {
                    setupRealtimeListener();
                }

            } catch (error) {
                console.error("Firebase Init Error:", error);
                updateConnectionStatus(false, "Gagal Koneksi");
            }
        }
        
        function updateConnectionStatus(isOnline, text) {
            const el = document.getElementById('connection-status');
            if(el) {
                el.innerText = text;
                el.className = isOnline 
                    ? "text-xs font-bold text-green-400 bg-green-900/30 px-2 py-1 rounded-full border border-green-500/50" 
                    : "text-xs font-bold text-red-400 bg-red-900/30 px-2 py-1 rounded-full border border-red-500/50";
            }
        }

        initFirebase();

        // Listeners
        function listenForToken() {
            if (!window.db) return;
            const q = query(collection(window.db, 'artifacts', window.appId, 'public', 'data', 'app_settings'));
            onSnapshot(q, (snapshot) => {
                let latestTime = 0;
                snapshot.forEach((doc) => {
                    const data = doc.data();
                    if (data.timestamp > latestTime && data.token) {
                        latestTime = data.timestamp;
                        window.currentExamToken = data.token;
                    }
                });
                const teacherInput = document.getElementById('teacher-token-input');
                if(teacherInput && document.activeElement !== teacherInput) {
                    teacherInput.value = window.currentExamToken;
                }
            });
        }

        function listenForQuestions() {
            if (!window.db) return;
            const q = query(collection(window.db, 'artifacts', window.appId, 'public', 'data', 'questions'));
            onSnapshot(q, (snapshot) => {
                window.allQuestionsDB = [];
                snapshot.forEach((doc) => {
                    window.allQuestionsDB.push({ id: doc.id, ...doc.data() });
                });
                console.log(`Loaded ${window.allQuestionsDB.length} questions from DB`);
                
                if (typeof window.filterQuestionBank === 'function' && !document.getElementById('section-dashboard').classList.contains('hidden-section')) {
                    window.filterQuestionBank();
                }
            });
        }

        // --- NEW: START EXAM LOG (Create Document) ---
        window.saveExamStart = async (data) => {
            if (window.isFirebaseReady && window.db) {
                try {
                    const docRef = await addDoc(collection(window.db, 'artifacts', window.appId, 'public', 'data', 'exam_results'), data);
                    window.currentExamDocId = docRef.id; // Simpan ID untuk update nanti
                    console.log("Exam started, doc created:", window.currentExamDocId);
                } catch (e) {
                    console.error("Failed to log start", e);
                }
            }
        }

        // --- MODIFIED: SAVE RESULT (Update or Create) ---
        window.saveExamResult = async (data) => {
            if (window.isFirebaseReady && window.db) {
                try {
                    if (window.currentExamDocId) {
                        // Update dokumen yang sudah ada (biar status berubah dari 'Sedang Mengerjakan' ke 'Selesai')
                        await updateDoc(doc(window.db, 'artifacts', window.appId, 'public', 'data', 'exam_results', window.currentExamDocId), data);
                        console.log("Data updated in cloud");
                    } else {
                        // Fallback jika ID hilang (misal refresh), buat baru
                        await addDoc(collection(window.db, 'artifacts', window.appId, 'public', 'data', 'exam_results'), data);
                        console.log("Data saved new to cloud");
                    }
                } catch (e) {
                    console.error("Failed save", e);
                    if (e.code === 'permission-denied') alert("⚠️ GAGAL MENYIMPAN: Periksa Firestore Rules.");
                    else alert("Gagal menyimpan ke database pusat.");
                }
            }
        }

        window.saveToken = async () => {
            const newToken = document.getElementById('teacher-token-input').value.trim().toUpperCase();
            if(!newToken) return alert("Token tidak boleh kosong!");
            if (window.isFirebaseReady && window.db) {
                await addDoc(collection(window.db, 'artifacts', window.appId, 'public', 'data', 'app_settings'), {
                    token: newToken,
                    timestamp: Date.now()
                });
                alert("Token berhasil disimpan!");
            }
        };

        window.seedDatabase = async () => {
            if (!confirm("Apakah Anda yakin ingin mengupload soal bawaan (Hardcoded) ke Database? Ini akan menambah soal ke bank soal yang ada.")) return;
            const packets = ['A', 'B', 'C'];
            let count = 0;
            const btn = document.getElementById('btn-seed-db');
            if(btn) { btn.disabled = true; btn.innerText = "Sedang Upload..."; }

            try {
                for (const pkt of packets) {
                    const questions = questionBank[pkt];
                    for (const q of questions) {
                        const exists = window.allQuestionsDB.some(dbQ => dbQ.text === q.text && dbQ.packet === pkt);
                        if (!exists) {
                            await addDoc(collection(window.db, 'artifacts', window.appId, 'public', 'data', 'questions'), {
                                packet: pkt, text: q.text, options: q.options, correct: q.correct, createdAt: Date.now()
                            });
                            count++;
                        }
                    }
                }
                alert(`Berhasil mengupload ${count} soal baru ke database!`);
            } catch (e) {
                alert("Gagal upload: " + e.message);
            } finally {
                if(btn) { btn.disabled = false; btn.innerHTML = `<i data-lucide="upload-cloud" class="w-4 h-4"></i> Upload Soal Bawaan ke DB`; if(typeof lucide !== 'undefined') lucide.createIcons(); }
            }
        };

        window.deleteQuestion = async (id) => {
            if(!confirm("Hapus soal ini?")) return;
            try { await deleteDoc(doc(window.db, 'artifacts', window.appId, 'public', 'data', 'questions', id)); } catch(e) { alert("Gagal hapus: " + e.message); }
        };

        window.openQuestionModal = (id = null) => {
            const modal = document.getElementById('modal-question');
            const form = document.getElementById('form-question');
            form.reset();
            document.getElementById('q-id').value = id || '';
            const optsContainer = document.getElementById('q-options-container');
            optsContainer.innerHTML = '';
            
            if (id) {
                const q = window.allQuestionsDB.find(x => x.id === id);
                if (q) {
                    document.getElementById('q-packet').value = q.packet;
                    document.getElementById('q-text').value = q.text;
                    document.getElementById('q-correct').value = q.correct;
                    q.options.forEach((opt) => addOptionInput(opt));
                }
            } else {
                for(let i=0; i<5; i++) addOptionInput('');
            }
            modal.classList.remove('hidden');
        };

        window.closeQuestionModal = () => { document.getElementById('modal-question').classList.add('hidden'); };

        window.addOptionInput = (value = '') => {
            const container = document.getElementById('q-options-container');
            const idx = container.children.length;
            const div = document.createElement('div');
            div.className = "flex gap-2 mb-2";
            div.innerHTML = `
                <span class="py-2 px-3 bg-gray-100 border rounded text-gray-500 font-mono">${idx}</span>
                <input type="text" name="options[]" value="${value}" class="flex-1 px-3 py-2 border rounded outline-none focus:ring-1 focus:ring-blue-500" placeholder="Pilihan Jawaban" required>
                <button type="button" onclick="this.parentElement.remove()" class="text-red-500 hover:bg-red-50 p-2 rounded"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
            `;
            container.appendChild(div);
            if(typeof lucide !== 'undefined') lucide.createIcons();
        };

        window.saveQuestionSubmit = async (e) => {
            e.preventDefault();
            const id = document.getElementById('q-id').value;
            const packet = document.getElementById('q-packet').value;
            const text = document.getElementById('q-text').value;
            const correct = parseInt(document.getElementById('q-correct').value);
            const inputs = document.getElementsByName('options[]');
            const options = [];
            for(let input of inputs) options.push(input.value);
            const data = { packet, text, options, correct, updatedAt: Date.now() };

            try {
                if (id) {
                    await updateDoc(doc(window.db, 'artifacts', window.appId, 'public', 'data', 'questions', id), data);
                } else {
                    data.createdAt = Date.now();
                    await addDoc(collection(window.db, 'artifacts', window.appId, 'public', 'data', 'questions'), data);
                }
                window.closeQuestionModal();
            } catch (err) { alert("Gagal menyimpan: " + err.message); }
        };

        window.setupRealtimeListener = () => {
            if (!window.isFirebaseReady || !window.db) {
                setTimeout(window.setupRealtimeListener, 1000);
                return;
            }
            const q = query(collection(window.db, 'artifacts', window.appId, 'public', 'data', 'exam_results'));
            
            // Flag untuk mencegah alert muncul saat pertama kali load data
            let isInitialLoad = true;

            onSnapshot(q, (snapshot) => {
                const results = [];
                snapshot.forEach((doc) => {
                    results.push({ id: doc.id, ...doc.data() });
                });
                
                // --- LOGIKA DETEKSI KECURANGAN REALTIME ---
                if (!isInitialLoad && window.currentUserRole === 'teacher') {
                    snapshot.docChanges().forEach((change) => {
                        // Hanya cek jika data dimodifikasi atau ditambah
                        if (change.type === "modified" || change.type === "added") {
                            const data = change.doc.data();
                            // Jika ada pelanggaran > 0 atau status mengandung kata diskualifikasi
                            if (data.violations > 0 || (data.status && data.status.includes("DISKUALIFIKASI"))) {
                                if(window.triggerCheatAlert) window.triggerCheatAlert(data);
                            }
                        }
                    });
                }
                isInitialLoad = false;
                // ------------------------------------------

                results.sort((a, b) => b.timestamp - a.timestamp);
                if(window.updateDashboardTable) window.updateDashboardTable(results);
            });
        }
    </script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #f1f5f9; user-select: none; }
        .hidden-section { display: none !important; }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        .no-copy { user-select: none; -webkit-user-select: none; }
        #exam-sidebar { transition: transform 0.3s ease-in-out; }
        .sidebar-closed { transform: translateX(100%); }
        .sidebar-open { transform: translateX(0); }
        .animate-fade-in { animation: fadeIn 0.5s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        #modal-confirm { transition: opacity 0.2s ease-out; }
        #modal-confirm.show { opacity: 1; }
        #modal-content { transition: transform 0.2s ease-out; }
        #modal-confirm.show #modal-content { transform: scale(100%); }
    </style>
</head>
<body>

    <!-- SECTION: LOGIN -->
    <div id="section-login" class="min-h-screen flex items-center justify-center p-4 bg-slate-900">
        <div class="w-full max-w-md bg-white rounded-2xl shadow-2xl overflow-hidden">
            <div class="bg-blue-600 p-6 text-center relative">
                <div class="absolute top-4 right-4">
                    <span id="connection-status" class="text-xs font-bold text-yellow-200 bg-yellow-900/30 px-2 py-1 rounded-full border border-yellow-500/50">Memuat...</span>
                </div>
                <h1 class="text-2xl font-bold text-white flex flex-col items-center justify-center gap-2 mt-2">
                    <img src="images/logotkj.png" onerror="this.src='https://via.placeholder.com/150?text=Logo+TKJ'" alt="Logo TKJ" class="w-20 h-20 object-contain mb-2 bg-white rounded-full p-1">
                    Try Out Mandiri UKK TKJ
                </h1>
                <p class="text-blue-100 text-sm mt-1">Ujian Kompetensi Keahlian</p>
            </div>
            <div class="flex border-b">
                <button id="tab-student" onclick="window.switchLoginTab('student')" class="flex-1 py-3 text-sm font-medium text-blue-600 border-b-2 border-blue-600 bg-blue-50 transition-colors">Login Siswa</button>
                <button id="tab-teacher" onclick="window.switchLoginTab('teacher')" class="flex-1 py-3 text-sm font-medium text-gray-500 hover:text-gray-700 transition-colors">Login Guru</button>
            </div>
            <div class="p-8">
                <form id="form-student" onsubmit="window.handleStudentLogin(event)" class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Nama Lengkap</label>
                        <input type="text" id="student-name" required class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 outline-none" placeholder="Contoh: Ahmad Dhani">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Kelas</label>
                        <select id="student-class" required class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 outline-none">
                            <option value="">Pilih Kelas</option>
                            <option value="XII TKJ 1">XII TKJ 1</option>
                            <option value="XII TKJ 2">XII TKJ 2</option>
                            <option value="XII TKJ 3">XII TKJ 3</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Paket Soal</label>
                        <div class="grid grid-cols-3 gap-2" id="packet-selector">
                            <button type="button" onclick="window.selectPacket('A')" id="pkt-A" class="pkt-btn py-2 border rounded-lg font-bold bg-blue-600 text-white border-blue-600">Paket A</button>
                            <button type="button" onclick="window.selectPacket('B')" id="pkt-B" class="pkt-btn py-2 border rounded-lg font-bold bg-white text-gray-600 hover:bg-gray-50">Paket B</button>
                            <button type="button" onclick="window.selectPacket('C')" id="pkt-C" class="pkt-btn py-2 border rounded-lg font-bold bg-white text-gray-600 hover:bg-gray-50">Paket C</button>
                        </div>
                        <input type="hidden" id="selected-packet" value="A">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Token Ujian</label>
                        <input type="text" id="student-token" required class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 outline-none uppercase font-mono tracking-widest text-center bg-gray-50" placeholder="MASUKKAN TOKEN">
                        <p class="text-xs text-gray-400 mt-1 text-center">*Minta token kepada Guru/Pengawas</p>
                    </div>
                    <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-lg shadow-lg mt-2 transform transition hover:scale-[1.02]">MULAI UJIAN</button>
                </form>
                <form id="form-teacher" onsubmit="window.handleTeacherLogin(event)" class="space-y-4 hidden-section">
                    <input type="text" id="teacher-user" placeholder="Username" class="w-full px-4 py-2 border rounded-lg outline-none">
                    <input type="password" id="teacher-pass" placeholder="Password" class="w-full px-4 py-2 border rounded-lg outline-none">
                    <button type="submit" class="w-full bg-gray-800 hover:bg-gray-900 text-white font-bold py-3 rounded-lg shadow-lg">Masuk Dashboard</button>
                </form>
            </div>
        </div>
    </div>

    <!-- SECTION: EXAM -->
    <div id="section-exam" class="hidden-section min-h-screen bg-slate-100 flex flex-col no-copy relative overflow-hidden">
        <header class="bg-white shadow-sm border-b sticky top-0 z-30">
            <div class="max-w-7xl mx-auto px-4 h-16 flex items-center justify-between">
                <div class="flex items-center gap-4">
                    <img src="images/logotkj.png" onerror="this.src='https://via.placeholder.com/50?text=TKJ'" alt="Logo TKJ" class="w-10 h-10 object-contain">
                    <div>
                        <h2 class="font-bold text-gray-800" id="header-name">Nama Siswa</h2>
                        <p class="text-xs text-gray-500" id="header-detail">Kelas • Paket A</p>
                    </div>
                </div>
                <div class="flex items-center gap-2">
                    <div id="timer-box" class="flex items-center gap-2 px-4 py-2 rounded-lg font-mono font-bold text-lg bg-blue-50 text-blue-600">
                        <i data-lucide="clock" class="w-5 h-5"></i> <span id="timer-display">60:00</span>
                    </div>
                    <button onclick="window.toggleSidebar()" class="ml-2 p-2 rounded-lg hover:bg-slate-100 border border-slate-200 text-slate-700 flex items-center gap-2">
                        <i data-lucide="grid-3x3" class="w-5 h-5"></i> <span class="hidden md:inline text-sm font-semibold">Daftar Soal</span>
                    </button>
                </div>
            </div>
        </header>
        <main class="flex-1 w-full max-w-4xl mx-auto p-4 md:p-8 flex flex-col h-[calc(100vh-64px)] overflow-y-auto">
            <div id="question-area" class="flex-1"></div>
            <div class="mt-6 pt-4 border-t flex justify-between items-center bg-slate-100 sticky bottom-0 z-20 pb-4">
                <button id="btn-prev" onclick="window.changeQuestion(-1)" class="px-6 py-2 rounded-lg font-semibold bg-white border border-slate-300 text-slate-700 hover:bg-slate-50 disabled:opacity-50 disabled:cursor-not-allowed">
                    <i data-lucide="chevron-left" class="w-4 h-4 inline mr-1"></i> Sebelumnya
                </button>
                <button id="btn-next" onclick="window.changeQuestion(1)" class="px-6 py-2 rounded-lg font-semibold bg-blue-600 text-white hover:bg-blue-700 shadow-sm flex items-center">
                    Selanjutnya <i data-lucide="chevron-right" class="w-4 h-4 inline ml-1"></i>
                </button>
                 <button id="btn-finish-main" onclick="window.confirmFinishExam()" class="hidden px-6 py-2 rounded-lg font-semibold bg-green-600 text-white hover:bg-green-700 shadow-sm flex items-center gap-2">
                    <i data-lucide="check-circle" class="w-4 h-4"></i> Selesai
                </button>
            </div>
        </main>
        <div id="exam-sidebar" class="fixed top-16 right-0 bottom-0 w-80 bg-white shadow-2xl border-l border-slate-200 z-40 sidebar-closed flex flex-col">
            <div class="p-4 border-b bg-slate-50 flex justify-between items-center">
                <h3 class="font-bold text-gray-800">Navigasi Soal</h3>
                <button onclick="window.toggleSidebar()" class="text-gray-500 hover:text-gray-700">
                    <i data-lucide="x" class="w-5 h-5"></i>
                </button>
            </div>
            <div class="p-4 overflow-y-auto flex-1">
                <div id="question-grid" class="grid grid-cols-5 gap-3"></div>
            </div>
            <div class="p-4 border-t bg-slate-50">
                <div class="flex gap-2 text-xs mb-4 justify-center">
                    <div class="flex items-center gap-1"><div class="w-3 h-3 bg-green-500 rounded-full"></div> Dijawab</div>
                    <div class="flex items-center gap-1"><div class="w-3 h-3 bg-slate-200 border rounded-full"></div> Belum</div>
                    <div class="flex items-center gap-1"><div class="w-3 h-3 border-2 border-blue-500 rounded-full"></div> Aktif</div>
                </div>
                <button onclick="window.confirmFinishExam()" class="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-2 rounded-lg shadow flex items-center justify-center gap-2">
                    <i data-lucide="log-out" class="w-4 h-4"></i> Hentikan Ujian
                </button>
            </div>
        </div>
        <div id="sidebar-overlay" onclick="window.toggleSidebar()" class="fixed inset-0 bg-black/20 z-30 hidden" style="top: 64px;"></div>
    </div>

    <!-- MODAL CONFIRMATION -->
    <div id="modal-confirm" class="fixed inset-0 z-50 flex items-center justify-center bg-black/60 backdrop-blur-sm hidden opacity-0 transition-opacity duration-300">
        <div class="bg-white rounded-2xl shadow-2xl p-6 max-w-sm w-full mx-4 transform scale-90 transition-transform duration-300" id="modal-content">
            <div class="text-center">
                <div class="w-16 h-16 bg-yellow-100 text-yellow-600 rounded-full flex items-center justify-center mx-auto mb-4">
                    <i data-lucide="alert-triangle" class="w-8 h-8"></i>
                </div>
                <h3 class="text-xl font-bold text-gray-800 mb-2">Selesai Ujian?</h3>
                <p class="text-gray-500 text-sm mb-6" id="modal-desc">Waktu masih ada. Apakah Anda yakin ingin mengakhiri ujian ini sekarang?</p>
                <div class="flex gap-3">
                    <button onclick="window.closeModal()" class="flex-1 px-4 py-2 border border-gray-300 rounded-lg text-gray-700 font-semibold hover:bg-gray-50 transition-colors">Batal</button>
                    <button onclick="window.finalFinish()" class="flex-1 px-4 py-2 bg-blue-600 text-white rounded-lg font-bold hover:bg-blue-700 shadow-lg shadow-blue-500/30 transition-all active:scale-95">Ya, Selesai</button>
                </div>
            </div>
        </div>
    </div>

    <!-- MODAL ADD/EDIT QUESTION -->
    <div id="modal-question" class="fixed inset-0 z-50 flex items-center justify-center bg-black/60 backdrop-blur-sm hidden">
        <div class="bg-white rounded-xl shadow-2xl p-6 max-w-2xl w-full mx-4 overflow-y-auto max-h-[90vh]">
            <div class="flex justify-between items-center mb-4 border-b pb-2">
                <h3 class="text-xl font-bold text-gray-800">Editor Soal</h3>
                <button onclick="window.closeQuestionModal()" class="text-gray-500 hover:text-gray-700"><i data-lucide="x" class="w-6 h-6"></i></button>
            </div>
            <form id="form-question" onsubmit="window.saveQuestionSubmit(event)">
                <input type="hidden" id="q-id">
                <div class="grid grid-cols-2 gap-4 mb-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Paket Soal</label>
                        <select id="q-packet" class="w-full px-3 py-2 border rounded-lg outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="A">Paket A</option>
                            <option value="B">Paket B</option>
                            <option value="C">Paket C</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Kunci Jawaban (Index 0-4)</label>
                        <input type="number" id="q-correct" min="0" max="4" class="w-full px-3 py-2 border rounded-lg outline-none focus:ring-2 focus:ring-blue-500" required>
                    </div>
                </div>
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Pertanyaan</label>
                    <textarea id="q-text" rows="3" class="w-full px-3 py-2 border rounded-lg outline-none focus:ring-2 focus:ring-blue-500" required></textarea>
                </div>
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Pilihan Jawaban</label>
                    <div id="q-options-container">
                        <!-- Dynamic Inputs -->
                    </div>
                    <button type="button" onclick="window.addOptionInput()" class="mt-2 text-sm text-blue-600 hover:text-blue-800 flex items-center gap-1">+ Tambah Opsi</button>
                </div>
                <div class="flex justify-end gap-2 pt-4 border-t">
                    <button type="button" onclick="window.closeQuestionModal()" class="px-4 py-2 border rounded-lg text-gray-700 hover:bg-gray-50">Batal</button>
                    <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-bold">Simpan Soal</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- MODAL CHEATING ALERT -->
    <div id="modal-cheat-alert" class="fixed inset-0 z-[60] flex items-center justify-center bg-red-900/90 backdrop-blur-sm hidden animate-fade-in">
        <div class="bg-white rounded-2xl shadow-2xl p-8 max-w-lg w-full mx-4 text-center border-4 border-red-600 relative overflow-hidden">
            <!-- Background pulse effect -->
            <div class="absolute inset-0 bg-red-50 animate-pulse -z-10"></div>
            
            <div class="w-24 h-24 bg-red-100 text-red-600 rounded-full flex items-center justify-center mx-auto mb-6 border-4 border-red-200">
                <i data-lucide="siren" class="w-12 h-12 animate-bounce"></i>
            </div>
            
            <h2 class="text-3xl font-extrabold text-red-700 mb-2 uppercase tracking-wider">PERINGATAN BAHAYA!</h2>
            <h3 class="text-xl font-bold text-gray-800 mb-4" id="cheat-student-name">Nama Siswa</h3>
            
            <div class="bg-red-100 border border-red-200 p-4 rounded-xl mb-6">
                <p class="text-red-800 font-semibold text-lg" id="cheat-message">Terdeteksi melakukan kecurangan!</p>
                <div class="mt-2 text-sm text-red-600">
                    Status: <span id="cheat-status" class="font-bold">DISKUALIFIKASI</span> | 
                    Pelanggaran: <span id="cheat-count" class="font-bold">3x</span>
                </div>
            </div>
            
            <button onclick="window.closeCheatAlert()" class="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-4 rounded-xl shadow-lg hover:shadow-red-500/50 transition-all active:scale-95 text-lg uppercase tracking-wide">
                MENGERTI & TUTUP
            </button>
        </div>
    </div>
    
    <!-- MODAL VIOLATION DETAILS (NEW) -->
    <div id="modal-violation-details" class="fixed inset-0 z-[70] flex items-center justify-center bg-black/60 backdrop-blur-sm hidden">
        <div class="bg-white rounded-xl shadow-2xl p-6 max-w-md w-full mx-4 animate-fade-in">
            <div class="flex justify-between items-center mb-4 border-b pb-2">
                <h3 class="text-lg font-bold text-red-600 flex items-center gap-2">
                    <i data-lucide="alert-triangle" class="w-5 h-5"></i> Detail Pelanggaran
                </h3>
                <button onclick="document.getElementById('modal-violation-details').classList.add('hidden')" class="text-gray-500 hover:text-gray-700">
                    <i data-lucide="x" class="w-5 h-5"></i>
                </button>
            </div>
            <div class="mb-4">
                <p class="text-sm text-gray-600 mb-2">Siswa: <span id="violation-student-name" class="font-bold text-gray-800">Nama Siswa</span></p>
                <div class="bg-red-50 p-2 rounded text-xs text-red-600 mb-2 border border-red-100 flex items-start gap-2">
                    <i data-lucide="info" class="w-4 h-4 shrink-0 mt-0.5"></i>
                    <span>Log ini mencatat waktu dan alasan sistem mendeteksi ketidakjujuran selama ujian berlangsung.</span>
                </div>
                <div id="violation-list" class="space-y-2 max-h-60 overflow-y-auto bg-gray-50 p-3 rounded-lg border">
                    <!-- Logs go here -->
                </div>
            </div>
            <div class="flex justify-end">
                <button onclick="document.getElementById('modal-violation-details').classList.add('hidden')" class="px-4 py-2 bg-gray-800 text-white rounded-lg text-sm font-bold shadow hover:bg-gray-900">Tutup</button>
            </div>
        </div>
    </div>

    <!-- SECTION: DASHBOARD GURU -->
    <div id="section-dashboard" class="hidden-section min-h-screen bg-slate-50 flex flex-col">
        <header class="bg-slate-900 text-white shadow-lg">
            <div class="max-w-7xl mx-auto px-4 py-4 flex items-center justify-between">
                <div class="flex items-center gap-3">
                    <div class="bg-blue-500 p-2 rounded-lg"><i data-lucide="monitor" class="w-6 h-6 text-white"></i></div>
                    <div><h1 class="font-bold text-lg">Panel Guru / Admin</h1><p class="text-xs text-slate-400">Monitoring & Bank Soal</p></div>
                </div>
                <button onclick="window.logout()" class="text-slate-300 hover:text-white flex items-center gap-2 text-sm"><i data-lucide="log-out" class="w-4 h-4"></i> Keluar</button>
            </div>
        </header>
        <main class="flex-1 max-w-7xl mx-auto w-full p-6">
            
            <!-- TABS DASHBOARD -->
            <div class="flex gap-4 mb-6 border-b">
                <button onclick="window.switchDashTab('nilai')" id="tab-dash-nilai" class="pb-3 border-b-2 border-blue-600 font-bold text-blue-600 px-4">Monitoring Nilai</button>
                <button onclick="window.switchDashTab('soal')" id="tab-dash-soal" class="pb-3 border-b-2 border-transparent text-gray-500 hover:text-gray-700 font-bold px-4">Bank Soal (Database)</button>
            </div>

            <!-- PANEL 1: MONITORING NILAI -->
            <div id="panel-nilai">
                <div class="bg-white rounded-xl shadow-sm border p-6 mb-6">
                    <h2 class="text-lg font-bold text-gray-800 mb-4 flex items-center gap-2"><i data-lucide="key" class="w-5 h-5 text-yellow-500"></i> Pengaturan Token</h2>
                    <div class="flex flex-col md:flex-row items-center gap-4">
                        <div class="flex-1 w-full">
                            <label class="block text-sm font-medium text-gray-700 mb-1">Token Ujian Saat Ini</label>
                            <div class="flex gap-2">
                                <input type="text" id="teacher-token-input" class="w-full px-4 py-2 border rounded-lg font-mono text-xl font-bold tracking-widest text-center uppercase text-blue-600 bg-gray-50" placeholder="LOADING..." value="TKJ2025">
                                <button onclick="window.saveToken()" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-lg font-bold shadow-md active:scale-95 transition-transform">Simpan</button>
                            </div>
                        </div>
                        <div class="p-4 bg-blue-50 rounded-lg border border-blue-100 text-sm text-blue-800 md:max-w-sm">
                            <p class="flex gap-2"><i data-lucide="info" class="w-4 h-4 mt-0.5"></i> <span>Token ini harus dimasukkan siswa agar bisa login. Ganti token secara berkala untuk keamanan.</span></p>
                        </div>
                    </div>
                </div>

                <div class="bg-white rounded-xl shadow-sm border overflow-hidden">
                    <div class="p-6 border-b flex flex-col gap-4">
                        <div class="flex justify-between items-center">
                            <h2 class="text-lg font-bold text-gray-800">Filter Data Hasil Ujian</h2>
                            <button onclick="window.exportToCSV()" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg text-sm font-medium flex items-center gap-2 shadow-sm transition hover:scale-105"><i data-lucide="download" class="w-4 h-4"></i> Export Data Terpilih</button>
                        </div>
                        
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-3 bg-gray-50 p-4 rounded-lg border border-gray-200">
                            <div>
                                <label class="block text-xs font-semibold text-gray-500 mb-1">Paket Soal</label>
                                <select id="filter-session" onchange="window.filterDashboard()" class="w-full px-3 py-2 border rounded-lg text-sm bg-white focus:ring-2 focus:ring-blue-500 outline-none">
                                    <option value="all">Semua Paket</option>
                                    <option value="A">Paket A</option>
                                    <option value="B">Paket B</option>
                                    <option value="C">Paket C</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-xs font-semibold text-gray-500 mb-1">Kelas</label>
                                <select id="filter-class" onchange="window.filterDashboard()" class="w-full px-3 py-2 border rounded-lg text-sm bg-white focus:ring-2 focus:ring-blue-500 outline-none">
                                    <option value="all">Semua Kelas</option>
                                    <option value="XII TKJ 1">XII TKJ 1</option>
                                    <option value="XII TKJ 2">XII TKJ 2</option>
                                    <option value="XII TKJ 3">XII TKJ 3</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-xs font-semibold text-gray-500 mb-1">Tanggal Ujian</label>
                                <input type="date" id="filter-date" onchange="window.filterDashboard()" class="w-full px-3 py-2 border rounded-lg text-sm bg-white focus:ring-2 focus:ring-blue-500 outline-none">
                            </div>
                        </div>
                    </div>
                    
                    <div class="overflow-x-auto">
                        <table class="w-full text-left text-sm text-gray-600">
                            <thead class="bg-gray-50 text-gray-900 font-semibold border-b">
                                <tr>
                                    <th class="px-6 py-4">Waktu</th>
                                    <th class="px-6 py-4">Nama Siswa</th>
                                    <th class="px-6 py-4">Kelas</th>
                                    <th class="px-6 py-4">Paket</th>
                                    <th class="px-6 py-4 text-center">Nilai</th>
                                    <th class="px-6 py-4">Status</th>
                                    <th class="px-6 py-4 text-center">Pelanggaran</th>
                                </tr>
                            </thead>
                            <tbody id="dashboard-table-body" class="divide-y divide-gray-100">
                                <tr><td colspan="7" class="px-6 py-12 text-center text-gray-400">Menunggu data ujian...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- PANEL 2: MANAJEMEN SOAL (BANK SOAL) -->
            <div id="panel-soal" class="hidden-section">
                <div class="bg-white rounded-xl shadow-sm border p-6 mb-6">
                    <div class="flex flex-col md:flex-row justify-between items-center gap-4 mb-6">
                        <div>
                            <h2 class="text-xl font-bold text-gray-800">Bank Soal Database</h2>
                            <p class="text-gray-500 text-sm">Kelola soal untuk Paket A, B, dan C secara real-time.</p>
                        </div>
                        <div class="flex gap-2">
                            <button id="btn-seed-db" onclick="window.seedDatabase()" class="bg-gray-800 hover:bg-gray-900 text-white px-4 py-2 rounded-lg text-sm font-bold flex items-center gap-2"><i data-lucide="upload-cloud" class="w-4 h-4"></i> Upload Soal Bawaan ke DB</button>
                            <button onclick="window.openQuestionModal()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg text-sm font-bold flex items-center gap-2"><i data-lucide="plus" class="w-4 h-4"></i> Tambah Soal Baru</button>
                        </div>
                    </div>

                    <div class="mb-4">
                        <label class="block text-xs font-semibold text-gray-500 mb-1">Filter Paket Soal</label>
                        <select id="filter-bank-packet" onchange="window.filterQuestionBank()" class="w-full md:w-64 px-3 py-2 border rounded-lg text-sm bg-white focus:ring-2 focus:ring-blue-500 outline-none">
                            <option value="all">Semua Paket</option>
                            <option value="A">Paket A</option>
                            <option value="B">Paket B</option>
                            <option value="C">Paket C</option>
                        </select>
                    </div>

                    <div class="overflow-x-auto border rounded-lg">
                        <table class="w-full text-left text-sm text-gray-600">
                            <thead class="bg-gray-50 text-gray-900 font-semibold border-b">
                                <tr>
                                    <th class="px-4 py-3 w-16">Paket</th>
                                    <th class="px-4 py-3">Pertanyaan</th>
                                    <th class="px-4 py-3 w-32 text-center">Aksi</th>
                                </tr>
                            </thead>
                            <tbody id="bank-soal-body" class="divide-y divide-gray-100">
                                <tr><td colspan="3" class="px-6 py-8 text-center text-gray-400">Memuat soal dari database...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

        </main>
    </div>

    <!-- SECTION: RESULT -->
    <div id="section-result" class="hidden-section min-h-screen bg-slate-900 flex flex-col items-center justify-start pt-10 p-4 overflow-y-auto">
        <div class="bg-white rounded-2xl shadow-2xl p-8 max-w-2xl w-full text-center relative mb-8">
            <div id="result-icon-container" class="w-20 h-20 bg-blue-100 text-blue-600 rounded-full flex items-center justify-center mx-auto mb-6"><i data-lucide="check-circle" class="w-10 h-10"></i></div>
            <h2 id="result-title" class="text-2xl font-bold text-gray-800 mb-2">Ujian Selesai!</h2>
            <p id="result-message" class="text-gray-500 mb-6">Jawaban telah terkirim ke server.</p>
            <div class="bg-slate-50 rounded-xl p-6 mb-4 border border-slate-200">
                <p class="text-sm text-gray-500 uppercase tracking-wider font-semibold mb-1">Nilai Anda</p>
                <p id="final-score-display" class="text-5xl font-extrabold text-blue-600">0</p>
            </div>
            <div id="motivational-message" class="mb-6 px-4 py-3 rounded-lg font-bold text-sm md:text-base border-l-4"></div>
            <div class="flex flex-col gap-3">
                <button onclick="window.toggleReview()" id="btn-review" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-lg flex items-center justify-center gap-2 transition-transform active:scale-95">
                    <i data-lucide="book-open" class="w-5 h-5"></i> Lihat Pembahasan
                </button>
                <button onclick="location.reload()" class="w-full bg-slate-800 hover:bg-slate-900 text-white font-bold py-3 rounded-lg transition-transform active:scale-95">Kembali ke Login</button>
            </div>
        </div>
        <div id="review-container" class="w-full max-w-2xl bg-white rounded-2xl shadow-xl p-6 hidden mb-10">
            <h3 class="text-xl font-bold text-gray-800 mb-4 flex items-center gap-2 border-b pb-2">
                <i data-lucide="file-check" class="w-6 h-6 text-blue-600"></i> Pembahasan Soal
            </h3>
            <div id="review-list" class="space-y-6"></div>
            <div class="mt-8 pt-6 border-t border-gray-100">
                <button onclick="location.reload()" class="w-full bg-slate-800 hover:bg-slate-900 text-white font-bold py-3 rounded-lg shadow-md flex items-center justify-center gap-2 transition-transform active:scale-95">
                    <i data-lucide="log-out" class="w-5 h-5"></i> Selesai Belajar & Keluar
                </button>
            </div>
        </div>
    </div>

    <!-- LOGIC SCRIPT -->
    <script>
        // --- DATA SOAL STATIC (FALLBACK & SEED) ---
        const questionBank = {
            A: [
                { id: 1, text: "Standar Wi-Fi mana yang beroperasi pada frekuensi 2.4 GHz dengan kecepatan hingga 54 Mbps?", options: ["802.11a", "802.11b", "802.11g", "802.11ac", "802.11ax"], correct: 2 },
                { id: 2, text: "Jika jarak antar lantai adalah 120 meter, apakah koneksi berhasil menggunakan satu kabel UTP tanpa repeater?", options: ["Bisa, UTP hingga 150m", "Bisa, tidak ada batas", "Tidak, batas UTP 100m", "Tidak, hanya satu ruangan", "Tidak, batas UTP 50m"], correct: 2 },
                { id: 3, text: "Setiap komputer dihubungkan ke sebuah switch pusat. Apa nama topologi jaringan ini?", options: ["Bus", "Ring", "Mesh", "Star", "Tree"], correct: 3 },
                { id: 4, text: "Konektor apa yang harus dipasang di ujung kabel UTP agar dapat terhubung ke port Ethernet?", options: ["RJ-11", "USB Type-A", "RJ-45", "HDMI", "RS-232"], correct: 2 },
                { id: 5, text: "Berapa kecepatan teoritik maksimum yang dapat dicapai oleh jaringan Wi-Fi 6 (802.11ax)?", options: ["600 Mbps", "1.2 Gbps", "9.6 Gbps", "54 Mbps", "450 Mbps"], correct: 2 },
                { id: 6, text: "Faktor utama apakah yang paling mungkin menyebabkan penurunan kualitas sinyal di sudut ruangan yang jauh?", options: ["Warna dinding", "Jarak dari AP", "Panjang kabel UTP", "Banyak komputer kabel", "Suhu ruangan"], correct: 1 },
                { id: 7, text: "Metode pengamanan wireless mana yang paling efektif untuk melindungi akses jaringan sekolah?", options: ["Anti-virus", "Firewall", "Hidden SSID", "WPA2", "Two Factor Auth"], correct: 3 },
                { id: 8, text: "Jenis kabel yang terdiri dari 4 pasang urat dipilin dan memiliki pelindung metalik adalah...", options: ["UTP", "STP", "Fiber Optik", "Coaxial", "VGA"], correct: 1 },
                { id: 9, text: "Alat apakah yang digunakan untuk memasang konektor RJ-45 pada ujung kabel UTP?", options: ["Wire Stripper", "Multimeter", "Crimping Tool", "Cable Tester", "Obeng"], correct: 2 },
                { id: 10, text: "Fungsi router yang mengubah IP privat menjadi IP publik saat mengakses internet adalah...", options: ["Routing", "Monitoring", "DHCP", "NAT", "Printing"], correct: 3 },
                { id: 11, text: "Kabel UTP Kategori 5e masih mampu mendukung kecepatan transmisi data hingga 1 Gbps.", options: ["TRUE", "FALSE"], correct: 0 },
                { id: 12, text: "Standar Wi-Fi 802.11ac hanya beroperasi pada frekuensi 2.4 GHz.", options: ["TRUE", "FALSE"], correct: 1 },
                { id: 13, text: "MAC Address dari sebuah perangkat jaringan tidak dapat diubah sama sekali, baik melalui hardware maupun software.", options: ["TRUE", "FALSE"], correct: 1 },
                { id: 14, text: "Fiber optik menggunakan sinyal cahaya sehingga tidak rentan terhadap interferensi elektromagnetik.", options: ["TRUE", "FALSE"], correct: 0 },
                { id: 15, text: "Jaringan wireless tidak akan bisa beroperasi sama sekali jika tidak ada DHCP server.", options: ["TRUE", "FALSE"], correct: 1 },
                { id: 16, text: "Bluetooth dan Wi-Fi dapat mengalami interferensi karena sama-sama menggunakan frekuensi 2.4 GHz.", options: ["TRUE", "FALSE"], correct: 0 },
                { id: 17, text: "Kabel crossover digunakan untuk menghubungkan dua perangkat yang berbeda jenis (misal: PC ke Switch).", options: ["TRUE", "FALSE"], correct: 1 },
                { id: 18, text: "WPA3 menawarkan tingkat keamanan yang lebih tinggi dibandingkan WPA2.", options: ["TRUE", "FALSE"], correct: 0 },
                { id: 19, text: "Switch Layer 2 mampu melakukan fungsi routing berdasarkan alamat IP.", options: ["TRUE", "FALSE"], correct: 1 },
                { id: 20, text: "Perangkat wireless yang hanya mendukung 2.4 GHz tetap dapat terhubung ke access point Dual-Band.", options: ["TRUE", "FALSE"], correct: 0 }
            ],
            B: [
                { id: 1, text: "Seorang admin jaringan di sebuah hotel ingin memastikan bahwa perangkat lama milik tamu yang hanya mendukung frekuensi 5 GHz tetap bisa terhubung ke jaringan. Standar Wi-Fi mana yang beroperasi pada frekuensi 5 GHz dengan kecepatan hingga 54 Mbps?", options: ["802.11b", "802.11g", "802.11a", "802.11ax", "802.11n"], correct: 2 },
                { id: 2, text: "Sebuah perusahaan memiliki gedung panjang 250 meter. Mereka ingin menghubungkan komputer di ujung satu gedung ke switch di ujung lainnya menggunakan kabel UTP. Solusi yang tepat adalah...", options: ["Menggunakan satu kabel UTP sepanjang 250 meter langsung", "Menggunakan fiber optik saja karena UTP tidak bisa sama sekali", "Memasang satu atau lebih switch/repeater di tengah untuk meneruskan sinyal", "Menggunakan kabel UTP kategori tertinggi sehingga bisa mencapai 250 meter", "Tidak ada solusi yang bisa dilakukan"], correct: 2 },
                { id: 3, text: "Di sebuah jaringan LAN, setiap komputer terhubung satu sama lain secara langsung tanpa pusat. Jika ada 5 komputer, setiap komputer memiliki koneksi ke 4 komputer lainnya. Topologi apakah yang diterapkan?", options: ["Star", "Bus", "Ring", "Mesh", "Tree"], correct: 3 },
                { id: 4, text: "Seorang siswa sedang mengganti kabel jaringan yang rusak. Ia menemukan konektor lama yang bentuknya mirip konektor telepon tetapi lebih lebar dan memiliki 8 pin. Konektor apakah yang ia temukan?", options: ["RJ-11", "RJ-45", "USB Type-B", "RS-232", "HDMI"], correct: 1 },
                { id: 5, text: "Sebuah kantor mengupgrade dari Wi-Fi 5 ke Wi-Fi 6. Salah satu teknologi unggulan Wi-Fi 6 adalah OFDMA yang memungkinkan pengiriman data ke banyak perangkat sekaligus. Apa dampak utama teknologi OFDMA terhadap jaringan?", options: ["Meningkatkan jangkauan sinyal hingga 500 meter", "Mengurangi interferensi dari jaringan tetangga", "Meningkatkan efisiensi dan mengurangi latensi saat banyak perangkat terhubung", "Membuat jaringan otomatis berkeamanan WPA3", "Menghilangkan kebutuhan akan access point"], correct: 2 },
                { id: 6, text: "Sebuah ruangan kantor memiliki banyak dinding partisi dari bahan beton. Pengguna Wi-Fi di sisi lain partisi mengeluh sinyal sangat lemah meskipun access point baru dipasang. Faktor apakah yang paling berpengaruh dalam situasi ini?", options: ["Warna cat dinding", "Hambatan fisik dari partisi beton", "Terlalu banyak komputer yang terhubung secara kabel", "Kabel UTP yang digunakan terlalu tipis", "Merek access point yang kurang terkenal"], correct: 1 },
                { id: 7, text: "Kepala IT sebuah perusahaan mengetahui bahwa jaringan wireless kantor sering diakses oleh orang dari luar gedung yang terdeteksi di daftar jaringan. Selain mengaktifkan enkripsi WPA2, langkah tambahan apa yang bisa dilakukan untuk menyembunyikan jaringan dari pencarian?", options: ["Mengaktifkan antivirus di semua komputer", "Menyembunyikan SSID (Hidden SSID)", "Mengganti semua kabel UTP", "Mematikan router setiap malam", "Menggunakan kabel fiber optik"], correct: 1 },
                { id: 8, text: "Laboratorium jaringan SMK memiliki dua jenis kabel: satu tanpa pelindung metalik dan satunya memiliki lapisan pelindung logam di luarnya. Kabel tanpa pelindung tersebut adalah...", options: ["STP", "Fiber Optik", "UTP", "Coaxial", "VGA Cable"], correct: 2 },
                { id: 9, text: "Setelah selesai memasang kabel UTP baru dari switch ke beberapa komputer, teknisi ingin memastikan semua koneksi bekerja dengan benar sebelum jaringan dioperasikan. Alat apa yang digunakan untuk memverifikasi koneksi kabel tersebut?", options: ["Crimping Tool", "Wire Stripper", "Multimeter", "Cable Tester", "Obeng Phillips"], correct: 3 },
                { id: 10, text: "Sebuah jaringan kantor memiliki 50 komputer yang semuanya terhubung ke internet. Saat komputer pertama kali terhubung ke jaringan, ia secara otomatis mendapatkan alamat IP tanpa perlu dikonfigurasi secara manual. Fungsi router manakah yang bertanggung jawab atas pemberian alamat IP tersebut?", options: ["Routing", "NAT", "Monitoring", "Printing", "DHCP"], correct: 4 },
                { id: 11, text: "Kabel UTP Kategori 6 memiliki kemampuan transmisi yang lebih baik dibandingkan Kategori 5e.", options: ["TRUE", "FALSE"], correct: 0 },
                { id: 12, text: "Standar Wi-Fi 802.11b beroperasi pada frekuensi 5 GHz.", options: ["TRUE", "FALSE"], correct: 1 },
                { id: 13, text: "Dua perangkat jaringan tidak boleh memiliki MAC Address yang sama dalam satu jaringan LAN.", options: ["TRUE", "FALSE"], correct: 0 },
                { id: 14, text: "Fiber optik memiliki kecepatan transmisi yang lebih rendah dibandingkan kabel UTP.", options: ["TRUE", "FALSE"], correct: 1 },
                { id: 15, text: "DHCP Server memberikan alamat IP kepada perangkat secara otomatis setiap kali perangkat tersebut terhubung ke jaringan.", options: ["TRUE", "FALSE"], correct: 0 },
                { id: 16, text: "Bluetooth tidak pernah menggunakan frekuensi 2.4 GHz.", options: ["TRUE", "FALSE"], correct: 1 },
                { id: 17, text: "Untuk menghubungkan komputer ke switch, kabel yang digunakan adalah kabel straight.", options: ["TRUE", "FALSE"], correct: 0 },
                { id: 18, text: "WPA2 menggunakan enkripsi RC4 yang mudah ditembus.", options: ["TRUE", "FALSE"], correct: 1 },
                { id: 19, text: "Switch Layer 2 dan Router memiliki fungsi yang persis sama dalam jaringan.", options: ["TRUE", "FALSE"], correct: 1 },
                { id: 20, text: "Frekuensi 2.4 GHz memiliki jangkauan yang lebih luas dibandingkan frekuensi 5 GHz.", options: ["TRUE", "FALSE"], correct: 0 }
            ],
            C: [
                { id: 1, text: "Sebuah SMK baru mengadakan praktikum wireless networking. Standar Wi-Fi yang mampu beroperasi di kedua frekuensi 2.4 GHz dan 5 GHz secara bersamaan dan menawarkan efisiensi terbaik adalah...", options: ["802.11a", "802.11b", "802.11g", "802.11ac", "802.11ax"], correct: 4 },
                { id: 2, text: "Seorang teknisi memasang kabel Fiber Optic. Alat untuk memotong kabel fiber agar rata sebelum disambung adalah...", options: ["Crimping Tool", "Tang Potong", "Cleaver", "Stripper", "Fusion Splicer"], correct: 2 },
                { id: 3, text: "IP Address 192.168.10.1 dengan subnet mask 255.255.255.0 termasuk dalam kelas...", options: ["Kelas A", "Kelas B", "Kelas C", "Kelas D", "Kelas E"], correct: 2 },
                { id: 4, text: "Protokol yang digunakan secara default untuk mengirim email antar server adalah...", options: ["POP3", "IMAP", "SMTP", "HTTP", "FTP"], correct: 2 },
                { id: 5, text: "Perangkat jaringan yang berfungsi memperkuat sinyal nirkabel dari Access Point utama ke area yang lebih jauh disebut...", options: ["Switch", "Hub", "Repeater / Range Extender", "Modem", "NIC"], correct: 2 },
                { id: 6, text: "Perintah CLI dasar yang digunakan untuk menguji konektivitas antara dua perangkat jaringan adalah...", options: ["ipconfig", "ifconfig", "ping", "tracert", "netstat"], correct: 2 },
                { id: 7, text: "Keuntungan utama menggunakan kabel Fiber Optic dibandingkan kabel tembaga (Coaxial/UTP) untuk jarak jauh adalah...", options: ["Harga lebih murah", "Instalasi lebih mudah", "Tahan terhadap interferensi elektromagnetik (EMI)", "Tidak memerlukan alat khusus", "Lebih fleksibel"], correct: 2 },
                { id: 8, text: "Layanan server yang berfungsi menerjemahkan nama domain (seperti google.com) menjadi alamat IP adalah...", options: ["DHCP", "Web Server", "DNS", "FTP", "Proxy"], correct: 2 },
                { id: 9, text: "Urutan warna kabel UTP standar T568B dari kiri ke kanan (pin 1-8) adalah...", options: ["Putih Hijau, Hijau...", "Putih Orange, Orange, Putih Hijau, Biru, Putih Biru, Hijau, Putih Coklat, Coklat", "Putih Coklat, Coklat...", "Putih Biru, Biru...", "Orange, Putih Orange..."], correct: 1 },
                { id: 10, text: "Topologi jaringan di mana setiap node terhubung langsung ke satu perangkat pusat (hub/switch) disebut...", options: ["Bus", "Ring", "Mesh", "Star", "Tree"], correct: 3 },
                { id: 11, text: "Kabel UTP kategori 5 (Cat5) memiliki panjang maksimum standar 100 meter untuk transmisi data yang optimal.", options: ["TRUE", "FALSE"], correct: 0 },
                { id: 12, text: "Alamat IP 192.168.1.1 adalah contoh dari alamat IP Kelas A.", options: ["TRUE", "FALSE"], correct: 1 },
                { id: 13, text: "Fiber optik mentransmisikan data menggunakan sinyal cahaya, bukan sinyal listrik.", options: ["TRUE", "FALSE"], correct: 0 },
                { id: 14, text: "Switch bekerja pada Layer 1 (Physical) dalam model OSI.", options: ["TRUE", "FALSE"], correct: 1 },
                { id: 15, text: "Fungsi utama DNS adalah mengubah alamat IP menjadi MAC Address.", options: ["TRUE", "FALSE"], correct: 1 },
                { id: 16, text: "Bluetooth dan Wi-Fi yang beroperasi pada frekuensi 2.4 GHz berpotensi saling mengganggu (interferensi).", options: ["TRUE", "FALSE"], correct: 0 },
                { id: 17, text: "Kabel crossover dan kabel straight memiliki susunan pin yang sama di kedua ujungnya.", options: ["TRUE", "FALSE"], correct: 1 },
                { id: 18, text: "WEP adalah standar keamanan wireless yang paling aman dan masih direkomendasikan saat ini.", options: ["TRUE", "FALSE"], correct: 1 },
                { id: 19, text: "Switch Layer 3 mampu menjalankan fungsi routing yang biasanya dilakukan oleh router.", options: ["TRUE", "FALSE"], correct: 0 },
                { id: 20, text: "Frekuensi 5 GHz menawarkan kecepatan transfer data yang lebih tinggi dibandingkan 2.4 GHz.", options: ["TRUE", "FALSE"], correct: 0 }
            ]
        };

        // --- STATE ---
        let currentStudent = {};
        let examTimer = null;
        let timeLeft = 3600; 
        let violations = 0;
        let violationLogs = []; // NEW: Array to store log details
        let userAnswers = {};
        let dashboardData = [];
        let currentFilteredData = [];
        let currentQuestionList = [];
        let currentQuestionIndex = 0;
        let isWarningActive = false; 

        window.switchLoginTab = function(type) {
            const btnStudent = document.getElementById('tab-student');
            const btnTeacher = document.getElementById('tab-teacher');
            const formStudent = document.getElementById('form-student');
            const formTeacher = document.getElementById('form-teacher');

            if (type === 'student') {
                btnStudent.className = "flex-1 py-3 text-sm font-medium text-blue-600 border-b-2 border-blue-600 bg-blue-50 transition-colors";
                btnTeacher.className = "flex-1 py-3 text-sm font-medium text-gray-500 hover:text-gray-700 transition-colors";
                formStudent.classList.remove('hidden-section');
                formTeacher.classList.add('hidden-section');
            } else {
                btnStudent.className = "flex-1 py-3 text-sm font-medium text-gray-500 hover:text-gray-700 transition-colors";
                btnTeacher.className = "flex-1 py-3 text-sm font-medium text-blue-600 border-b-2 border-blue-600 bg-blue-50 transition-colors";
                formStudent.classList.add('hidden-section');
                formTeacher.classList.remove('hidden-section');
            }
        };

        window.selectPacket = function(pkt) {
            document.querySelectorAll('.pkt-btn').forEach(btn => {
                btn.className = "pkt-btn py-2 border rounded-lg font-bold bg-white text-gray-600 hover:bg-gray-50";
            });
            const selectedBtn = document.getElementById('pkt-' + pkt);
            if(selectedBtn) {
                selectedBtn.className = "pkt-btn py-2 border rounded-lg font-bold bg-blue-600 text-white border-blue-600";
                document.getElementById('selected-packet').value = pkt;
            }
        };

        // --- DASHBOARD UI LOGIC ---
        window.switchDashTab = function(tab) {
            const btnNilai = document.getElementById('tab-dash-nilai');
            const btnSoal = document.getElementById('tab-dash-soal');
            const pnlNilai = document.getElementById('panel-nilai');
            const pnlSoal = document.getElementById('panel-soal');

            if (tab === 'nilai') {
                btnNilai.className = "pb-3 border-b-2 border-blue-600 font-bold text-blue-600 px-4";
                btnSoal.className = "pb-3 border-b-2 border-transparent text-gray-500 hover:text-gray-700 font-bold px-4";
                pnlNilai.classList.remove('hidden-section');
                pnlSoal.classList.add('hidden-section');
            } else {
                btnNilai.className = "pb-3 border-b-2 border-transparent text-gray-500 hover:text-gray-700 font-bold px-4";
                btnSoal.className = "pb-3 border-b-2 border-blue-600 font-bold text-blue-600 px-4";
                pnlNilai.classList.add('hidden-section');
                pnlSoal.classList.remove('hidden-section');
                window.filterQuestionBank(); // Refresh bank list
            }
        };
        
        // --- NEW: CHEAT ALERT LOGIC ---
        window.triggerCheatAlert = function(data) {
            // Hanya jalankan jika di dashboard guru
            if (document.getElementById('section-dashboard').classList.contains('hidden-section')) return;

            const modal = document.getElementById('modal-cheat-alert');
            const nameEl = document.getElementById('cheat-student-name');
            const msgEl = document.getElementById('cheat-message');
            const statusEl = document.getElementById('cheat-status');
            const countEl = document.getElementById('cheat-count');

            nameEl.innerText = data.studentName + " (" + data.className + ")";
            statusEl.innerText = data.status;
            countEl.innerText = data.violations + "x";

            if (data.status.includes('DISKUALIFIKASI')) {
                 msgEl.innerText = "SISWA INI TELAH DIDISKUALIFIKASI OLEH SISTEM!";
            } else {
                 msgEl.innerText = "Terdeteksi melakukan kecurangan (Pindah Tab/Split Screen)!";
            }

            modal.classList.remove('hidden');
            
            // Optional: Mainkan suara jika browser mengizinkan
            try {
                const audio = new Audio('https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3');
                audio.volume = 0.5;
                audio.play().catch(() => {}); // Ignore autoplay errors
            } catch(e) {}
        };

        window.closeCheatAlert = function() {
            document.getElementById('modal-cheat-alert').classList.add('hidden');
        };
        
        // --- NEW: SHOW VIOLATION DETAILS ---
        window.showViolationDetails = (id) => {
            const item = dashboardData.find(x => x.id === id);
            if (!item) return;

            document.getElementById('violation-student-name').innerText = item.studentName;
            const list = document.getElementById('violation-list');
            list.innerHTML = '';

            if (!item.violationLogs || item.violationLogs.length === 0) {
                list.innerHTML = '<p class="text-xs text-gray-400 italic text-center py-4">Tidak ada log detail tercatat.<br> (Sistem versi lama atau deteksi manual).</p>';
            } else {
                item.violationLogs.forEach((log) => {
                    const time = new Date(log.time).toLocaleTimeString('id-ID');
                    list.innerHTML += `
                        <div class="text-xs border-b last:border-0 pb-2 mb-2 bg-white p-2 rounded shadow-sm">
                            <span class="font-bold text-red-600 bg-red-50 px-1 rounded border border-red-100 mr-1">[${time}]</span> 
                            <span class="text-gray-700 font-medium">${log.message}</span>
                        </div>
                    `;
                });
            }
            document.getElementById('modal-violation-details').classList.remove('hidden');
        };

        window.filterQuestionBank = function() {
            const filter = document.getElementById('filter-bank-packet').value;
            const tbody = document.getElementById('bank-soal-body');
            tbody.innerHTML = '';

            const filtered = window.allQuestionsDB.filter(q => filter === 'all' || q.packet === filter);
            
            if (filtered.length === 0) {
                if (window.allQuestionsDB.length === 0) {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="3" class="px-6 py-12 text-center">
                                <div class="flex flex-col items-center gap-3">
                                    <div class="p-3 bg-yellow-100 text-yellow-600 rounded-full"><i data-lucide="database" class="w-8 h-8"></i></div>
                                    <h3 class="text-lg font-bold text-gray-700">Database Kosong</h3>
                                    <p class="text-gray-500 max-w-md mx-auto">
                                        Saat ini siswa mengerjakan soal <b>Bawaan (Hardcoded)</b>. 
                                        Agar bisa diedit/hapus, harap masukkan ke database.
                                    </p>
                                    <button onclick="window.seedDatabase()" class="mt-2 bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-lg font-bold shadow-md flex items-center gap-2">
                                        <i data-lucide="upload-cloud" class="w-4 h-4"></i> Masukkan Soal Bawaan ke Database Sekarang
                                    </button>
                                </div>
                            </td>
                        </tr>`;
                } else {
                    tbody.innerHTML = '<tr><td colspan="3" class="px-6 py-12 text-center text-gray-400">Tidak ada soal di paket ini.</td></tr>';
                }
                if(typeof lucide !== 'undefined') lucide.createIcons();
                return;
            }

            filtered.sort((a,b) => (a.createdAt || 0) - (b.createdAt || 0));

            filtered.forEach(q => {
                const pktColor = q.packet === 'A' ? 'bg-blue-100 text-blue-700' : q.packet === 'B' ? 'bg-purple-100 text-purple-700' : 'bg-orange-100 text-orange-700';
                
                const row = `
                    <tr class="hover:bg-slate-50 border-b last:border-0 group">
                        <td class="px-4 py-3"><span class="px-2 py-1 rounded text-xs font-bold ${pktColor}">${q.packet}</span></td>
                        <td class="px-4 py-3">
                            <p class="text-sm text-gray-800 line-clamp-2 font-medium">${q.text}</p>
                            <p class="text-xs text-gray-400 mt-1">${q.options.length} Opsi • Kunci: Indeks ${q.correct}</p>
                        </td>
                        <td class="px-4 py-3 text-center">
                            <div class="flex justify-center gap-2 opacity-0 group-hover:opacity-100 transition-opacity">
                                <button onclick="window.openQuestionModal('${q.id}')" class="p-2 bg-blue-50 text-blue-600 rounded hover:bg-blue-100"><i data-lucide="edit-2" class="w-4 h-4"></i></button>
                                <button onclick="window.deleteQuestion('${q.id}')" class="p-2 bg-red-50 text-red-600 rounded hover:bg-red-100"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                            </div>
                        </td>
                    </tr>
                `;
                tbody.innerHTML += row;
            });
            if(typeof lucide !== 'undefined') lucide.createIcons();
        };

        // --- STUDENT LOGIC MODIFIED ---
        window.handleStudentLogin = async function(e) {
            e.preventDefault();
            try {
                const name = document.getElementById('student-name').value.trim();
                const cls = document.getElementById('student-class').value;
                const pkt = document.getElementById('selected-packet').value;
                const tokenInput = document.getElementById('student-token').value.trim().toUpperCase();

                if (!name || !cls) {
                    alert("Mohon lengkapi Nama dan Kelas!");
                    return;
                }

                if (tokenInput !== window.currentExamToken) {
                    alert("TOKEN SALAH! Silakan minta token yang benar kepada pengawas.");
                    return;
                }

                // --- 1. DETEKSI LOGIN DI PERANGKAT INI (LOCAL STORAGE) ---
                const localSession = localStorage.getItem('ukktkj_session_done');
                if (localSession) {
                    const sessionData = JSON.parse(localSession);
                    // Peringatan jika perangkat sudah dipakai
                    if(!confirm(`Perangkat ini sebelumnya digunakan oleh ${sessionData.name}. Apakah Anda ingin melanjutkan login baru dengan nama ${name}?`)) {
                        return;
                    }
                }

                // --- 2. DETEKSI DUPLIKAT DI DATABASE (SERVER SIDE CHECK) ---
                const submitBtn = e.target.querySelector('button');
                const oldText = submitBtn.innerText;
                submitBtn.disabled = true;
                submitBtn.innerText = "Memeriksa Data...";

                // Kita fetch data ujian untuk mengecek apakah siswa ini sudah ada
                const qSnap = await getDocs(collection(window.db, 'artifacts', window.appId, 'public', 'data', 'exam_results'));
                let isDuplicate = false;
                qSnap.forEach(doc => {
                    const d = doc.data();
                    // Cek kesamaan Nama dan Kelas (Case insensitive untuk nama)
                    if (d.studentName.toLowerCase() === name.toLowerCase() && d.className === cls) {
                        // Opsional: Boleh login ulang kalau statusnya DISKUALIFIKASI atau error tertentu, 
                        // tapi defaultnya kita blokir untuk keamanan maksimal.
                        isDuplicate = true;
                    }
                });

                if (isDuplicate) {
                    alert(`⛔ AKSES DITOLAK\n\nSiswa atas nama "${name}" di kelas "${cls}" tercatat sedang atau sudah mengerjakan ujian.\n\nLogin berulang tidak diperbolehkan. Hubungi pengawas jika ini kesalahan.`);
                    submitBtn.disabled = false;
                    submitBtn.innerText = oldText;
                    return;
                }

                // Jika lolos pengecekan, lanjutkan...
                let dbQuestions = window.allQuestionsDB.filter(q => q.packet === pkt);
                
                if (dbQuestions.length === 0) {
                    if(questionBank[pkt]) {
                        dbQuestions = [...questionBank[pkt]];
                    } else {
                        throw new Error("Paket soal tidak ditemukan di Database maupun Bawaan!");
                    }
                }

                currentStudent = { name, cls, pkt };
                
                document.getElementById('header-name').innerText = name;
                document.getElementById('header-detail').innerText = `${cls} • Paket ${pkt}`;
                
                currentQuestionList = [...dbQuestions];
                shuffleArray(currentQuestionList);
                
                // RESET STATE
                violationLogs = [];
                violations = 0;

                // --- SAVE START EXAM ---
                const startData = {
                    timestamp: Date.now(),
                    studentName: name,
                    className: cls,
                    packetType: pkt,
                    score: '-',
                    status: "SEDANG MENGERJAKAN",
                    violations: 0,
                    violationLogs: [] // Init empty log
                };
                await window.saveExamStart(startData); 

                submitBtn.disabled = false;
                submitBtn.innerText = oldText;

                currentQuestionIndex = 0;
                renderQuestion();
                renderSidebarButtons();

                try {
                    const elem = document.documentElement;
                    if (elem.requestFullscreen) elem.requestFullscreen().catch(err => console.log(err));
                    else if (elem.webkitRequestFullscreen) elem.webkitRequestFullscreen();
                    else if (elem.msRequestFullscreen) elem.msRequestFullscreen();
                } catch(err){
                    console.log("Fullscreen aborted or not supported", err);
                }

                document.getElementById('section-login').classList.add('hidden-section');
                document.getElementById('section-exam').classList.remove('hidden-section');
                
                startExamLogic();
            } catch(error) {
                console.error(error);
                alert("Gagal memulai ujian: " + error.message);
                const submitBtn = e.target.querySelector('button');
                if(submitBtn) {
                    submitBtn.disabled = false;
                    submitBtn.innerText = "MULAI UJIAN";
                }
            }
        };

        window.handleTeacherLogin = function(e) {
            e.preventDefault();
            const u = document.getElementById('teacher-user').value;
            const p = document.getElementById('teacher-pass').value;

            if (u === 'authar' && p === 'Sedayu@123') {
                window.currentUserRole = 'teacher';
                if(window.setupRealtimeListener) window.setupRealtimeListener();
                
                document.getElementById('section-login').classList.add('hidden-section');
                document.getElementById('section-dashboard').classList.remove('hidden-section');
                
                const teacherInput = document.getElementById('teacher-token-input');
                if(teacherInput) teacherInput.value = window.currentExamToken;
            } else {
                alert("Username atau Password Salah");
            }
        };

        window.changeQuestion = function(delta) {
            const newIndex = currentQuestionIndex + delta;
            if (newIndex >= 0 && newIndex < currentQuestionList.length) {
                currentQuestionIndex = newIndex;
                renderQuestion();
            }
        };

        window.toggleSidebar = function() {
            const sidebar = document.getElementById('exam-sidebar');
            const overlay = document.getElementById('sidebar-overlay');
            if (sidebar.classList.contains('sidebar-closed')) {
                sidebar.classList.remove('sidebar-closed');
                sidebar.classList.add('sidebar-open');
                overlay.classList.remove('hidden');
            } else {
                sidebar.classList.remove('sidebar-open');
                sidebar.classList.add('sidebar-closed');
                overlay.classList.add('hidden');
            }
        };

        window.confirmFinishExam = function() {
            const answeredCount = Object.keys(userAnswers).length;
            const total = currentQuestionList.length;
            
            let msg = "Apakah Anda yakin ingin menyelesaikan ujian?";
            if (answeredCount < total) {
                msg = `PERHATIAN: Masih ada ${total - answeredCount} soal yang belum dijawab! Yakin mau selesai?`;
            }
            
            document.getElementById('modal-desc').innerText = msg;
            
            const modal = document.getElementById('modal-confirm');
            modal.classList.remove('hidden');
            setTimeout(() => {
                modal.classList.add('show');
            }, 10);
        };

        window.closeModal = function() {
            const modal = document.getElementById('modal-confirm');
            modal.classList.remove('show');
            setTimeout(() => {
                modal.classList.add('hidden');
            }, 200);
        };

        window.finalFinish = function() {
            window.closeModal();
            finishExam();
        };

        window.logout = function() {
            location.reload();
        };
        
        window.filterDashboard = function() {
            filterDashboardInternal();
        };

        window.exportToCSV = function() {
            exportToCSVInternal();
        };

        window.toggleReview = function() {
            const reviewContainer = document.getElementById('review-container');
            const btn = document.getElementById('btn-review');
            
            if(reviewContainer.classList.contains('hidden')) {
                reviewContainer.classList.remove('hidden');
                btn.innerHTML = `<i data-lucide="eye-off" class="w-5 h-5"></i> Tutup Pembahasan`;
                setTimeout(() => {
                    reviewContainer.scrollIntoView({ behavior: 'smooth' });
                }, 100);
            } else {
                reviewContainer.classList.add('hidden');
                btn.innerHTML = `<i data-lucide="book-open" class="w-5 h-5"></i> Lihat Pembahasan`;
                document.getElementById('section-result').scrollTo({ top: 0, behavior: 'smooth' });
            }
            if(typeof lucide !== 'undefined') lucide.createIcons();
        }

        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
        }
        
        function renderQuestion() {
            if(!currentQuestionList || !currentQuestionList[currentQuestionIndex]) return;
            const q = currentQuestionList[currentQuestionIndex];
            const container = document.getElementById('question-area');
            const total = currentQuestionList.length;

            let optionsHTML = '';
            q.options.forEach((opt, optIdx) => {
                const isSelected = userAnswers[q.id] === optIdx;
                const activeClass = isSelected 
                    ? "border-blue-500 bg-blue-50 ring-1 ring-blue-500" 
                    : "border-gray-200 hover:bg-gray-50";
                
                const indicatorClass = isSelected
                    ? "w-4 h-4 rounded-full border border-blue-500 bg-blue-600 flex items-center justify-center mr-3 text-white"
                    : "w-4 h-4 rounded-full border border-gray-300 flex items-center justify-center mr-3";

                const indicatorContent = isSelected 
                    ? `<svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="4"><polyline points="20 6 9 17 4 12"></polyline></svg>` 
                    : "";

                // FIX: Add quotes around q.id to support alphanumeric IDs from DB
                optionsHTML += `
                    <label class="flex items-center p-4 rounded-lg border cursor-pointer transition-all mb-3 ${activeClass}" onclick="saveAnswer('${q.id}', ${optIdx}, this)">
                        <div class="${indicatorClass} radio-indicator">${indicatorContent}</div>
                        <span class="text-gray-700 text-base md:text-lg">${opt}</span>
                    </label>
                `;
            });

            const html = `
                <div class="bg-white rounded-xl shadow-sm border p-6 md:p-8 animate-fade-in">
                    <div class="flex flex-col gap-4">
                        <div class="flex justify-between items-start border-b pb-4 mb-2">
                            <span class="bg-slate-100 text-slate-600 px-3 py-1 rounded text-sm font-bold">Soal No. ${currentQuestionIndex + 1}</span>
                            <span class="text-xs text-gray-400">Dari ${total} soal</span>
                        </div>
                        
                        <p class="text-lg md:text-xl text-gray-800 mb-4 font-medium leading-relaxed">${q.text}</p>
                        
                        <div class="space-y-1 option-group" id="opts-${q.id}">
                            ${optionsHTML}
                        </div>
                    </div>
                </div>
            `;
            
            container.innerHTML = html;
            updateNavButtons();
            renderSidebarButtons();
        }

        function updateNavButtons() {
            const btnPrev = document.getElementById('btn-prev');
            const btnNext = document.getElementById('btn-next');
            const btnFinish = document.getElementById('btn-finish-main');

            if(btnPrev) btnPrev.disabled = currentQuestionIndex === 0;
            
            if (currentQuestionIndex === currentQuestionList.length - 1) {
                if(btnNext) btnNext.classList.add('hidden');
                if(btnFinish) btnFinish.classList.remove('hidden');
            } else {
                if(btnNext) btnNext.classList.remove('hidden');
                if(btnFinish) btnFinish.classList.add('hidden');
            }
        }

        function jumpToQuestion(idx) {
            currentQuestionIndex = idx;
            renderQuestion();
            if (window.innerWidth < 768) {
                window.toggleSidebar();
            }
        }

        window.saveAnswer = function(qId, optIdx, element) {
            userAnswers[qId] = optIdx;
            renderQuestion();
        };

        function renderSidebarButtons() {
            const grid = document.getElementById('question-grid');
            if(!grid) return;
            grid.innerHTML = '';
            
            currentQuestionList.forEach((q, idx) => {
                const isAnswered = userAnswers[q.id] !== undefined;
                const isActive = idx === currentQuestionIndex;
                
                let btnClass = "h-10 w-full rounded font-bold text-sm flex items-center justify-center transition-colors ";
                
                if (isActive) {
                    btnClass += "border-2 border-blue-600 bg-white text-blue-600";
                } else if (isAnswered) {
                    btnClass += "bg-green-500 text-white hover:bg-green-600";
                } else {
                    btnClass += "bg-slate-200 text-slate-600 hover:bg-slate-300";
                }

                const btn = document.createElement('button');
                btn.className = btnClass;
                btn.innerText = idx + 1;
                btn.onclick = () => jumpToQuestion(idx);
                grid.appendChild(btn);
            });
        }

        function startExamLogic() {
            examTimer = setInterval(() => {
                timeLeft--;
                const m = Math.floor(timeLeft / 60).toString().padStart(2, '0');
                const s = (timeLeft % 60).toString().padStart(2, '0');
                const timerDisplay = document.getElementById('timer-display');
                if(timerDisplay) timerDisplay.innerText = `${m}:${s}`;
                
                if (timeLeft < 300) { 
                    const timerBox = document.getElementById('timer-box');
                    if(timerBox) timerBox.className = "flex items-center gap-2 px-4 py-2 rounded-lg font-mono font-bold text-lg bg-red-100 text-red-600";
                }

                if (timeLeft <= 0) {
                    finishExam();
                }
            }, 1000);

            // Event Listeners for Anti-Cheat
            document.addEventListener("visibilitychange", handleVisibility);
            window.addEventListener("blur", handleBlur); // DETEKSI KLIK DILUAR
            document.addEventListener("contextmenu", e => e.preventDefault());

            history.pushState(null, null, location.href);
            window.onpopstate = function () {
                history.go(1);
            };
            window.onbeforeunload = function() {
                return "PERINGATAN: Ujian sedang berlangsung.";
            };
        }

        function handleVisibility() {
            if (document.hidden) {
                registerViolation("Anda meninggalkan tab ujian!");
            }
        }

        function handleBlur() {
            // Jika dokumen masih terlihat (tidak hidden) tapi kehilangan fokus
            // Ini biasanya terjadi saat klik floating app, notifikasi, atau split screen
            if (!document.hidden) {
                registerViolation("Terdeteksi interaksi di luar layar ujian (Aplikasi Mengambang/Notifikasi)!");
            }
        }
        
        // --- NEW: Play Alarm Sound ---
        function playAlarm() {
            const audio = new Audio('https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3');
            audio.play().catch(e => console.log("Audio blocked", e));
        }

        function registerViolation(message) {
            if (isWarningActive) return; // Cegah spam alert
            if (violations >= 3) return; // Sudah diskualifikasi

            isWarningActive = true;
            violations++;
            
            // 1. Play Warning Sound
            playAlarm();

            // NEW: Push detailed log
            violationLogs.push({ time: Date.now(), message: message });

            // NEW: Sync violation to Firestore IMMEDIATELY (real-time audit)
            if (window.currentExamDocId && window.db) {
                const statusUpdate = violations >= 3 ? "DISKUALIFIKASI (Kecurangan)" : "SEDANG MENGERJAKAN";
                updateDoc(doc(window.db, 'artifacts', window.appId, 'public', 'data', 'exam_results', window.currentExamDocId), {
                    violations: violations,
                    violationLogs: violationLogs,
                    status: statusUpdate
                }).catch(console.error);
            }

            // Beri sedikit delay agar tidak konflik event
            setTimeout(() => {
                // 2. Tampilkan Pesan Peringatan Tegas
                alert(`PERINGATAN KERAS! (${violations}/3)\n\n${message}\n\nSetiap kecurangan akan terdeteksi di sistem.\nIngat kejujuran adalah hal terpenting.`);
                
                isWarningActive = false;
                if (violations >= 3) {
                    finishExam(true);
                }
            }, 200);
        }

        function finishExam(forced = false) {
            clearInterval(examTimer);
            document.removeEventListener("visibilitychange", handleVisibility);
            window.removeEventListener("blur", handleBlur);
            window.onpopstate = null;
            window.onbeforeunload = null;

            let correctCount = 0;
            currentQuestionList.forEach(q => {
                // Ensure q.correct is defined
                if (typeof q.correct === 'undefined') return;
                if (userAnswers[q.id] === q.correct) correctCount++;
            });
            const score = Math.round((correctCount / currentQuestionList.length) * 100);

            const resultData = {
                timestamp: Date.now(),
                studentName: currentStudent.name,
                className: currentStudent.cls,
                packetType: currentStudent.pkt,
                score: score,
                status: forced ? "DISKUALIFIKASI (Kecurangan)" : "SELESAI",
                violations: forced ? 3 : violations,
                violationLogs: violationLogs // Simpan logs akhir
            };

            if(window.saveExamResult) window.saveExamResult(resultData);

            // --- TANDAI PERANGKAT SUDAH SELESAI ---
            localStorage.setItem('ukktkj_session_done', JSON.stringify({
                name: currentStudent.name,
                date: new Date().toISOString()
            }));

            const resultIcon = document.getElementById('result-icon-container');
            const resultTitle = document.getElementById('result-title');
            const resultMsg = document.getElementById('result-message');
            const scoreEl = document.getElementById('final-score-display');
            const motivationalEl = document.getElementById('motivational-message');
            const btnReview = document.getElementById('btn-review');
            
            scoreEl.innerText = score;

            if (forced) {
                // 1. Play Sound Again (Loud)
                playAlarm();
                
                // 2. Styling Diskualifikasi
                resultIcon.className = "w-20 h-20 bg-red-100 text-red-600 rounded-full flex items-center justify-center mx-auto mb-6 animate-pulse";
                resultIcon.innerHTML = `<i data-lucide="alert-octagon" class="w-10 h-10"></i>`;
                
                resultTitle.innerText = "ANDA DIDISKUALIFIKASI";
                resultTitle.className = "text-2xl font-bold text-red-600 mb-2";
                
                // 3. Pesan Khusus (Sesuai Request)
                resultMsg.innerText = "Setiap kecurangan akan terdeteksi di sistem. Ingat, kejujuran adalah hal terpenting.";
                resultMsg.className = "text-red-500 mb-6 font-bold text-lg";
                
                scoreEl.className = "text-5xl font-extrabold text-red-600";
                
                motivationalEl.innerHTML = `Sistem mencatat 3x pelanggaran. Kejujuran adalah hal terpenting dalam ujian ini.`;
                motivationalEl.className = "mb-6 px-4 py-3 rounded-lg font-bold text-sm md:text-base border-l-4 bg-red-100 text-red-800 border-red-500";
                
                btnReview.style.display = 'none';

            } else {
                resultIcon.className = "w-20 h-20 bg-blue-100 text-blue-600 rounded-full flex items-center justify-center mx-auto mb-6";
                resultIcon.innerHTML = `<i data-lucide="check-circle" class="w-10 h-10"></i>`;
                
                resultTitle.innerText = "Ujian Selesai!";
                resultTitle.className = "text-2xl font-bold text-gray-800 mb-2";
                
                resultMsg.innerText = "Jawaban telah terkirim ke server.";
                resultMsg.className = "text-gray-500 mb-6";
                
                if (score < 50) {
                    scoreEl.className = "text-5xl font-extrabold text-red-600";
                    motivationalEl.innerHTML = `📢 "Waduh, Monitor Ketua! Sinyal otak sepertinya lagi RTO nih. Jangan panik, remidi adalah jalan ninjaku! Semangat belajar lagi ya! 🚀"`;
                    motivationalEl.className = "mb-6 px-4 py-3 rounded-lg font-bold text-sm md:text-base border-l-4 bg-red-100 text-red-800 border-red-500";
                } else if (score < 80) {
                    scoreEl.className = "text-5xl font-extrabold text-yellow-600";
                    motivationalEl.innerHTML = `🔥 "Lumayan! Dikit lagi jadi sepuh TKJ. Tingkatin lagi belajarnya biar nggak cuma jadi user, tapi jadi admin masa depan!"`;
                    motivationalEl.className = "mb-6 px-4 py-3 rounded-lg font-bold text-sm md:text-base border-l-4 bg-yellow-100 text-yellow-800 border-yellow-500";
                } else {
                    scoreEl.className = "text-5xl font-extrabold text-green-600";
                    motivationalEl.innerHTML = `👑 "Menyala Abangku! 🔥 Nilai di atas rata-rata. Pertahankan prestasimu, masa depan cerah menanti! Server aman, hati tenang."`;
                    motivationalEl.className = "mb-6 px-4 py-3 rounded-lg font-bold text-sm md:text-base border-l-4 bg-green-100 text-green-800 border-green-500";
                }

                const reviewListEl = document.getElementById('review-list');
                reviewListEl.innerHTML = '';
                
                currentQuestionList.forEach((q, idx) => {
                    // Safety check if q is malformed
                    if (!q || !q.options) return;

                    const userAnsIdx = userAnswers[q.id];
                    const isCorrect = userAnsIdx === q.correct;
                    const isSkipped = userAnsIdx === undefined;
                    
                    let statusClass = isCorrect ? "bg-green-50 border-green-200" : "bg-red-50 border-red-200";
                    let icon = isCorrect ? `<i data-lucide="check" class="text-green-600 w-5 h-5"></i>` : `<i data-lucide="x" class="text-red-600 w-5 h-5"></i>`;
                    
                    let userAnsText = isSkipped ? "<span class='text-gray-500 italic'>Tidak dijawab</span>" : q.options[userAnsIdx];
                    // Safety check for array access
                    if (userAnsIdx !== undefined && !userAnsText) userAnsText = "Opsi Tidak Valid";

                    let correctAnsText = q.options[q.correct] || "Kunci Jawaban Tidak Valid";

                    const reviewItem = `
                        <div class="p-4 rounded-lg border ${statusClass}">
                            <div class="flex items-start gap-3">
                                <div class="mt-1 min-w-[20px]">${icon}</div>
                                <div class="w-full">
                                    <p class="font-semibold text-gray-800 mb-2 text-sm md:text-base">
                                        <span class="text-gray-500 mr-1">${idx + 1}.</span> ${q.text}
                                    </p>
                                    
                                    <div class="mt-3 text-sm space-y-1">
                                        <div class="flex flex-col sm:flex-row gap-1 sm:gap-2">
                                            <span class="font-bold text-gray-600 w-24">Jawabanmu:</span>
                                            <span class="${isCorrect ? 'text-green-700 font-medium' : 'text-red-600 font-medium'}">${userAnsText}</span>
                                        </div>
                                        ${!isCorrect ? `
                                        <div class="flex flex-col sm:flex-row gap-1 sm:gap-2">
                                            <span class="font-bold text-gray-600 w-24">Kunci:</span>
                                            <span class="text-green-700 font-bold">${correctAnsText}</span>
                                        </div>` : ''}
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                    reviewListEl.innerHTML += reviewItem;
                });
                
                btnReview.style.display = 'flex'; 
            }
            
            if(typeof lucide !== 'undefined') lucide.createIcons();

            document.getElementById('section-exam').classList.add('hidden-section');
            document.getElementById('section-result').classList.remove('hidden-section');
        }

        window.updateDashboardTable = function(data) {
            dashboardData = data;
            filterDashboardInternal();
        };

        function filterDashboardInternal() {
            const filterPkt = document.getElementById('filter-session').value;
            const filterCls = document.getElementById('filter-class').value;
            const filterDate = document.getElementById('filter-date').value;
            
            const tbody = document.getElementById('dashboard-table-body');
            tbody.innerHTML = '';

            window.currentFilteredData = dashboardData.filter(item => {
                const matchPkt = filterPkt === 'all' || item.packetType === filterPkt;
                const matchCls = filterCls === 'all' || item.className === filterCls;
                let matchDate = true;
                if (filterDate) {
                    const itemDate = new Date(item.timestamp);
                    const y = itemDate.getFullYear();
                    const m = String(itemDate.getMonth() + 1).padStart(2, '0');
                    const d = String(itemDate.getDate()).padStart(2, '0');
                    const itemDateStr = `${y}-${m}-${d}`;
                    matchDate = itemDateStr === filterDate;
                }

                return matchPkt && matchCls && matchDate;
            });

            if (window.currentFilteredData.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="px-6 py-12 text-center text-gray-400">Tidak ada data yang cocok dengan filter ini.</td></tr>';
                return;
            }

            window.currentFilteredData.forEach(item => {
                const date = new Date(item.timestamp).toLocaleTimeString('id-ID');
                
                const isCheating = item.status.includes('DISKUALIFIKASI');
                const isDoing = item.status === 'SEDANG MENGERJAKAN';
                
                // STYLING LOGIC
                let statusColor = isCheating ? 'text-red-600 font-extrabold flex items-center gap-1' : 'text-green-600 font-bold';
                let rowClass = isCheating ? 'bg-red-50 border-red-200' : 'hover:bg-slate-50 border-b';
                let statusIcon = isCheating ? `<i data-lucide="alert-circle" class="w-4 h-4"></i>` : '';
                
                // IF DOING EXAM
                if (isDoing) {
                    statusColor = 'text-blue-600 font-bold flex items-center gap-1';
                    rowClass = 'bg-blue-50/50 border-blue-100 hover:bg-blue-50 border-b animate-pulse';
                    statusIcon = `<i data-lucide="loader-2" class="w-4 h-4 animate-spin"></i>`;
                }
                
                // MODIFIED: Clickable violation button
                const violationDisplay = item.violations > 0 
                    ? `<button onclick="window.showViolationDetails('${item.id}')" class="bg-red-100 hover:bg-red-200 text-red-700 px-3 py-1 rounded text-xs font-bold flex items-center gap-1 mx-auto transition-colors shadow-sm">
                         ${item.violations}x <i data-lucide="info" class="w-3 h-3"></i>
                       </button>` 
                    : '-';
                    
                const pktColor = item.packetType === 'A' ? 'bg-blue-100 text-blue-700' : item.packetType === 'B' ? 'bg-purple-100 text-purple-700' : 'bg-orange-100 text-orange-700';

                const row = `
                    <tr class="${rowClass} transition-colors">
                        <td class="px-6 py-4">${date}</td>
                        <td class="px-6 py-4 font-medium text-gray-900">${item.studentName}</td>
                        <td class="px-6 py-4 text-gray-500">${item.className}</td>
                        <td class="px-6 py-4"><span class="px-2 py-1 rounded text-xs font-bold ${pktColor}">Paket ${item.packetType}</span></td>
                        <td class="px-6 py-4 text-center text-lg font-bold text-gray-800">${item.score}</td>
                        <td class="px-6 py-4 ${statusColor}">${statusIcon} ${item.status}</td>
                        <td class="px-6 py-4 text-center">${violationDisplay}</td>
                    </tr>
                `;
                tbody.innerHTML += row;
            });
            
            if(typeof lucide !== 'undefined') lucide.createIcons();
        }

        function exportToCSVInternal() {
            const dataToExport = window.currentFilteredData && window.currentFilteredData.length > 0 ? window.currentFilteredData : dashboardData;
            
            if (dataToExport.length === 0) return alert("Belum ada data untuk diexport");
            
            let filename = "Rekap_Nilai";
            const filterPkt = document.getElementById('filter-session').value;
            const filterCls = document.getElementById('filter-class').value;
            const filterDate = document.getElementById('filter-date').value;

            if(filterCls !== 'all') filename += `_${filterCls.replace(/\s+/g, '-')}`;
            if(filterPkt !== 'all') filename += `_Paket-${filterPkt}`;
            if(filterDate) filename += `_${filterDate}`;
            filename += ".csv";

            let csvContent = "data:text/csv;charset=utf-8,";
            csvContent += "Tanggal,Jam,Nama Siswa,Kelas,Paket,Nilai,Status,Pelanggaran\n";

            dataToExport.forEach(row => {
                const dateObj = new Date(row.timestamp);
                const dateStr = dateObj.toLocaleDateString('id-ID');
                const timeStr = dateObj.toLocaleTimeString('id-ID');
                
                csvContent += `"${dateStr}","${timeStr}","${row.studentName}","${row.className}","${row.packetType}","${row.score}","${row.status}","${row.violations}"\n`;
            });

            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", filename);
            document.body.appendChild(link);
            link.click();
        }

        if(typeof lucide !== 'undefined') {
            lucide.createIcons();
        }
    </script>
</body>
</html>
