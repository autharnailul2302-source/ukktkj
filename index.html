<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Nusantara Arsa: Rise of Student</title>
    
    <!-- PWA / Mobile Web App Meta Tags (Agar Full Screen saat Add to Home Screen) -->
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#0f172a">

    <!-- OPTIMASI CACHE: Preload Aset Berat agar tersimpan di memori browser lebih awal -->
    <link rel="preload" as="image" href="images/bg.png">
    <link rel="preload" as="image" href="images/landinggame.png">
    <link rel="preload" as="image" href="images/lobby.png">
    <link rel="preload" as="image" href="images/boy.png">
    <link rel="preload" as="image" href="images/girl.png">
    <!-- NEW: PRELOAD KURCACI -->
    <link rel="preload" as="image" href="images/kurcacitani.png">
    <!-- NEW: PRELOAD PERI PANEN -->
    <link rel="preload" as="image" href="images/peripanen.png">
    <!-- NEW: PRELOAD ORANG SAWAH -->
    <link rel="preload" as="image" href="images/orangsawah.png">
    <!-- NEW: PRELOAD LAHAN LIAR -->
    <link rel="preload" as="image" href="images/lahan-liar.png">

    <!-- Firebase SDK (Compat Version for HTML) -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-analytics-compat.js"></script>

    <style>
        /* FONTS: Cinzel for Royal/Epic feel, Exo 2 for Modern/Sci-fi UI */
        @import url('https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700;900&family=Exo+2:ital,wght@0,400;0,700;1,400&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=Dancing+Script:wght@700&display=swap'); /* Font Sertifikat */

        :root {
            /* MLBB x Nusantara Palette */
            --primary: #1e3a8a; /* Deep Royal Blue */
            --secondary: #fbbf24; /* Glowing Gold */
            --accent: #06b6d4; /* Magic Cyan */
            --danger: #ef4444;
            --bg-ui: rgba(15, 23, 42, 0.85); /* Slate Dark Glass */
            --text: #f8fafc;
            
            /* Stat Colors */
            --col-str: #ef4444; /* Merah */
            --col-int: #3b82f6; /* Biru */
            --col-rep: #d946ef; /* Ungu/Pink */
            --col-biz: #10b981; /* Hijau */
            
            /* Dashboard Colors */
            --dash-bg: #f1f5f9;
            --dash-sidebar: #0f172a;
            --dash-text: #334155;
            
            --glass-border: 1px solid rgba(251, 191, 36, 0.3);
            --box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37);
        }

        body {
            margin: 0;
            padding: 0;
            background-color: #000;
            color: var(--text);
            font-family: 'Exo 2', sans-serif; /* Modern base font */
            overflow: hidden;
            touch-action: none;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh; /* Fallback */
            height: 100dvh; /* Dynamic Viewport Height (Mobile Friendly) */
            width: 100vw;
            /* UPDATE: MENGHAPUS BACKGROUND IMAGE PADA BODY AGAR SISI LAYAR HITAM POLOS (BERSIH) */
            /* background: linear-gradient(rgba(15, 23, 42, 0.3), rgba(0, 0, 0, 0.5)), url('images/bg.png'); */
            /* background-size: cover; */
            /* background-position: center; */
        }

        /* Landscape Enforcement */
        /* Paksa sembunyi selamanya */
		#rotate-warning { display: none !important; }
	
		@media screen and (orientation: portrait) {
    /* Tetap sembunyi walaupun portrait */
    #rotate-warning { display: none !important; }
}
        
            /* FIX: JANGAN SEMBUNYIKAN GAME CONTAINER AGAR TETAP RENDER */
            /* #game-container { display: none; } <--- HAPUS INI */
        }

        #game-container {
            position: relative;
            
            /* --- UPDATE: FULL SCREEN IMMERSIVE --- */
            /* Memaksa kontainer mengisi seluruh layar viewport */
            width: 100vw;
            height: 100vh; /* Fallback */
            height: 100dvh; /* Dynamic Height untuk Mobile Browser */
            
            margin: 0;
            padding: 0;
            
            background: #000;
            overflow: hidden;
            
            /* Border dihapus agar benar-benar full screen */
            border: none; 
            box-shadow: none;
        }
		
		/* --- 1. LAYAR HITAM JEDA (RESUME OVERLAY) --- */
        /* Ini adalah layar yang muncul saat balik dari tab lain */
        #resume-overlay {
            position: fixed; /* Menempel di layar kaca HP */
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.95); /* Hitam pekat transparan dikit */
            z-index: 9999; /* Pastikan paling atas */
            display: none; /* Sembunyi dulu awalnya */
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            backdrop-filter: blur(5px); /* Efek buram keren */
        }

        .resume-title {
            font-family: 'Cinzel', serif;
            color: #fbbf24; /* Emas */
            font-size: 24px;
            margin-bottom: 10px;
        }

        .resume-text {
            color: #cbd5e1;
            font-size: 14px;
            max-width: 80%;
            margin-bottom: 30px;
        }

        /* Tombol Lanjut yang Besar agar mudah ditekan */
        .resume-btn {
            background: linear-gradient(135deg, #1e3a8a, #06b6d4);
            color: white;
            border: 2px solid white;
            padding: 15px 40px;
            border-radius: 50px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 0 0 20px rgba(6, 182, 212, 0.5);
            animation: pulse 1.5s infinite; /* Animasi denyut */
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        canvas {
            display: block;
            width: 100%;
            height: 100%;
            /* KUNCI KETAJAMAN: UBAH KE SMOOTH (AUTO) AGAR TIDAK PECAH */
            image-rendering: auto; 
            image-rendering: smooth;
        }

        /* --- UI OVERLAYS (MODERN STYLE) --- */
        #ui-layer {
            /* UPDATE: Menggunakan FIXED agar UI menempel ke layar fisik HP, bukan kotak game */
            position: fixed; 
            top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            z-index: 50; /* Pastikan z-index tinggi agar di atas canvas */
        }
		
		/* NEW: STYLE KHUSUS MODAL PESAN GURU (PENGGANTI PROMPT) */
        #custom-prompt-modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.85); z-index: 3000;
            display: none; justify-content: center; align-items: center;
            flex-direction: column; backdrop-filter: blur(5px);
            pointer-events: auto; /* Agar bisa diklik */
        }
        .prompt-box {
            background: #1e293b; border: 2px solid var(--secondary);
            padding: 20px; border-radius: 12px; width: 90%; max-width: 400px;
            text-align: center; box-shadow: 0 0 30px rgba(0,0,0,0.5);
            display: flex; flex-direction: column;
        }

        /* HUD TOP REDESIGN */
        .hud-top {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            padding: 10px 15px;
            padding-top: max(15px, env(safe-area-inset-top)); 
            background: linear-gradient(to bottom, rgba(2, 6, 23, 0.9), transparent);
            pointer-events: none; /* FIX: Ubah ke none agar area kosong bisa disentuh untuk gerak */
            width: 100%;
            box-sizing: border-box;
        }

        /* 1. SECTION PROFIL (Kiri) */
        .hud-profile-section {
            display: flex;
            gap: 10px;
            align-items: center;
            pointer-events: auto; /* FIX: Kembalikan interaksi khusus untuk elemen ini */
        }

        .hud-avatar-wrapper {
            position: relative;
            width: 55px; height: 55px;
        }

        .hud-avatar-circle {
            width: 55px; height: 55px;
            border-radius: 50%;
            border: 2px solid var(--secondary);
            overflow: hidden;
            background: #1e293b;
            box-shadow: 0 0 10px rgba(0,0,0,0.5);
        }
        .hud-avatar-circle img { width: 100%; height: 100%; object-fit: cover; object-position: top; }

        .hud-role-icon {
            position: absolute;
            bottom: -5px; right: -5px;
            width: 24px; height: 24px;
            background: var(--primary);
            border: 1px solid var(--accent);
            border-radius: 50%;
            display: flex; justify-content: center; align-items: center;
            font-size: 14px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.5);
            z-index: 2;
        }

        .hud-info-bars {
            display: flex;
            flex-direction: column;
            gap: 4px;
            width: 120px;
        }

        .hud-level-text {
            font-size: 12px; font-weight: bold; color: var(--secondary);
            font-family: 'Cinzel', serif;
            text-shadow: 1px 1px 0 #000;
        }

        /* Generic Bar Style */
        .bar-container {
            width: 100%; height: 8px;
            background: #334155;
            border-radius: 4px;
            overflow: hidden;
            position: relative;
            border: 1px solid rgba(255,255,255,0.2);
        }
        .bar-fill { height: 100%; width: 50%; transition: width 0.3s; }
        .bar-text {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            font-size: 6px; display: flex; align-items: center; justify-content: center;
            color: white; font-weight: bold; text-shadow: 0 0 2px black;
        }

        /* Colors for bars */
        .exp-fill { background: linear-gradient(90deg, #6366f1, #a855f7); }
        .energy-fill { background: linear-gradient(90deg, #eab308, #fbbf24); }
        .hp-fill { background: linear-gradient(90deg, #ef4444, #b91c1c); }

        /* 2. SECTION STATS (Tengah) */
        .hud-stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 5px 15px;
            background: rgba(15, 23, 42, 0.6);
            padding: 8px 15px;
            border-radius: 8px;
            border: 1px solid rgba(255,255,255,0.1);
            backdrop-filter: blur(2px);
            pointer-events: auto; /* FIX: Kembalikan interaksi khusus untuk elemen ini */
        }

        .stat-pill {
            display: flex; align-items: center; gap: 5px;
            font-size: 11px; font-weight: bold; color: #cbd5e1;
        }
        .stat-val { color: white; }
        
        .ic-str { color: var(--col-str); }
        .ic-int { color: var(--col-int); }
        .ic-rep { color: var(--col-rep); }
        .ic-biz { color: var(--col-biz); }

        /* 3. SECTION META (Kanan) */
        .hud-meta-section {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 5px;
            pointer-events: auto; /* FIX: Kembalikan interaksi khusus untuk elemen ini */
        }

        .money-badge {
            background: linear-gradient(90deg, rgba(15,23,42,0.8), rgba(30,58,138,0.8));
            padding: 5px 15px;
            border-radius: 20px;
            border: 1px solid var(--secondary);
            color: var(--secondary);
            font-weight: bold;
            font-size: 14px;
            text-shadow: 0 0 5px rgba(251, 191, 36, 0.5);
        }

        .time-badge {
            font-size: 12px; color: #e2e8f0;
            text-align: right;
            text-shadow: 1px 1px 2px black;
        }
        .time-clock { font-size: 16px; font-weight: bold; font-family: 'Exo 2'; color: white; }
		
		  /* --- STYLING KHUSUS UNTUK DUEL MINIGAME (BARU) --- */
        #duel-minigame {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.85); /* Gelap transparan */
            z-index: 2200; /* Di atas segalanya */
            display: none; /* Hidden default */
            flex-direction: column; justify-content: center; align-items: center;
            backdrop-filter: blur(5px);
            pointer-events: auto;
        }
        
        .duel-arena {
            background: linear-gradient(135deg, rgba(30, 41, 59, 0.95), rgba(15, 23, 42, 0.95));
            border: 2px solid #ef4444;
            border-radius: 16px;
            padding: 25px;
            width: 90%; max-width: 450px;
            text-align: center;
            box-shadow: 0 0 50px rgba(239, 68, 68, 0.4);
            animation: bounceIn 0.3s;
            position: relative;
        }

        .duel-header {
            font-family: 'Cinzel', serif;
            font-size: 24px; color: #ef4444;
            text-shadow: 0 0 10px #7f1d1d;
            margin-bottom: 20px;
            border-bottom: 1px solid #ef4444;
            padding-bottom: 10px;
        }

        .duel-characters {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 25px;
        }

        .duel-char {
            display: flex; flex-direction: column; align-items: center; width: 100px;
        }

        .duel-avatar {
            width: 70px; height: 70px;
            border-radius: 50%;
            border: 3px solid #fff;
            background: #334155;
            object-fit: cover;
            margin-bottom: 5px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.5);
        }

        .duel-hp-container {
            width: 80px; height: 10px;
            background: #333; border-radius: 5px;
            border: 1px solid #555;
            overflow: hidden;
        }
        .duel-hp-bar {
            height: 100%; width: 100%;
            background: linear-gradient(90deg, #22c55e, #16a34a);
            transition: width 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .duel-vs-text {
            font-family: 'Cinzel'; font-size: 32px; font-weight: 900;
            color: #ef4444; font-style: italic;
        }

        .duel-status-text {
            min-height: 50px;
            font-family: 'Exo 2'; font-size: 14px;
            color: #e2e8f0; margin-bottom: 20px;
            padding: 10px; background: rgba(255,255,255,0.05);
            border-radius: 8px; display: flex; align-items: center; justify-content: center;
        }

        .duel-controls {
            display: flex; gap: 15px; justify-content: center;
        }

        .duel-btn {
            width: 70px; height: 70px;
            border-radius: 12px;
            background: linear-gradient(to bottom, #334155, #1e293b);
            border: 1px solid #64748b;
            font-size: 32px; cursor: pointer;
            transition: all 0.1s;
            box-shadow: 0 4px 0 #0f172a;
        }
        .duel-btn:active { transform: translateY(4px); box-shadow: none; }
        .duel-btn:hover { background: #475569; border-color: var(--secondary); }

        /* --- END DUEL STYLES --- */
		
		
        /* 4. COMBAT HUD (Floating HP Bar - Hidden by Default) */
        /* UPDATE: DIHAPUS KARENA SUDAH PINDAH KE HUD UTAMA */
        #combat-hud {
            display: none !important; 
        }

        /* INDIKATOR TUTUP/BUKA PADA BANGUNAN */
        .building-status {
            position: absolute;
            font-size: 10px;
            padding: 2px 6px;
            border-radius: 4px;
            font-weight: bold;
            text-align: center;
            width: max-content;
            transform: translateX(-50%);
            left: 50%;
            top: -15px;
            z-index: 10;
        }
        .status-open { background: rgba(16, 185, 129, 0.9); color: white; }
        .status-closed { background: rgba(239, 68, 68, 0.9); color: white; }

        /* NEW: TIME INFO BOX STYLE */
        .time-info-box {
            position: absolute;
            top: 70px;
            right: 20px;
            background: rgba(15, 23, 42, 0.95);
            border: 1px solid var(--secondary);
            padding: 10px;
            border-radius: 8px;
            font-size: 10px;
            color: #cbd5e1;
            width: 200px;
            display: none; /* Hidden by default, hover to show */
            pointer-events: none;
            z-index: 50;
            box-shadow: 0 4px 15px rgba(0,0,0,0.5);
        }

        .stat-item.time-container:hover .time-info-box {
            display: block;
        }
        
        /* TOMBOL FULLSCREEN DI HUD DIHAPUS (Hidden) AGAR LEBIH BERSIH */
        #fullscreen-hud-btn {
            display: none !important; 
        }

        /* --- NEW: COLLAPSIBLE HUD STYLES --- */
        #hud-toggle-btn {
            position: absolute;
            top: 85px; /* Default di bawah Stats Grid */
            left: 50%;
            transform: translateX(-50%);
            width: 40px; height: 20px;
            background: rgba(15, 23, 42, 0.9);
            border: 1px solid var(--secondary);
            border-top: none;
            border-radius: 0 0 10px 10px;
            color: var(--secondary);
            display: flex; justify-content: center; align-items: center;
            cursor: pointer;
            z-index: 60; /* Di atas elemen UI lain */
            font-size: 12px;
            transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            box-shadow: 0 4px 10px rgba(0,0,0,0.5);
            pointer-events: auto;
        }

        #hud-toggle-btn:hover {
            background: var(--primary);
            height: 25px;
            box-shadow: 0 0 15px var(--accent);
        }

        /* Styles saat Mode Compact (Minimized) */
        .hud-top.compact-mode .hud-stats-grid {
            opacity: 0;
            transform: translateY(-20px) scale(0.9);
            pointer-events: none;
            position: absolute; /* Hilangkan dari flow layout */
            visibility: hidden;
        }

        .hud-top.compact-mode .hud-info-bars {
            opacity: 0;
            width: 0;
            margin: 0;
            overflow: hidden;
            transition: all 0.3s;
        }
        
        /* Geser Avatar sedikit ke atas saat compact */
        .hud-top.compact-mode .hud-avatar-wrapper {
            transform: scale(0.9);
        }

        /* Geser Tombol ke atas saat compact */
        .hud-top.compact-mode ~ #hud-toggle-btn {
            top: 0;
            border: 1px solid var(--secondary);
            border-top: none;
            background: rgba(15, 23, 42, 0.6);
            height: 25px;
            width: 30px;
        }

        /* Dialogue System Container (Wrapper) */
        #dialogue-wrapper {
            /* UPDATE: Menggunakan FIXED agar dialog menempel ke layar fisik dan tidak terpotong */
            position: fixed; 
            
            /* UPDATE: Menambahkan jarak aman (safe-area) agar tidak tertutup tombol home bar di HP */
            bottom: calc(20px + env(safe-area-inset-bottom));
            
            left: 50%;
            transform: translateX(-50%);
            
            /* UPDATE: Lebar disesuaikan agar lebih optimal di HP (90%) namun tidak raksasa di Desktop (max 600px) */
            width: min(90%, 600px);
            
            display: none; /* Controlled by JS */
            
            /* UPDATE: Z-Index dinaikkan ke 100 agar di atas tombol kontrol (z-50) */
            z-index: 100; 
            
            pointer-events: auto;
        }

        /* Portrait Image (Half Body / Bust Shot) */
        #dialogue-portrait {
            position: absolute;
            bottom: 0; /* Align bottom with container */
            left: -30px; /* UPDATE: Geser ke kiri agar center di area kosong */
            height: 240px; /* UPDATE: Lebih tinggi untuk Zoom */
            width: 200px;  /* UPDATE: Lebar ditambah untuk memicu zoom proporsional */
            
            /* LOGIKA ZOOM & CROP (Bust Shot) */
            object-fit: cover; /* Memaksa gambar mengisi frame (Zoom In) */
            object-position: top center; /* Fokus ke kepala/bahu, potong kaki */
            
            z-index: 22; /* Di atas box */
            filter: drop-shadow(5px 5px 15px rgba(0,0,0,0.8));
            animation: slideUp 0.3s ease-out;
            display: block; /* Default block inside wrapper */
            image-rendering: pixelated; /* UPDATE: Agar gambar pixel art tetap tajam saat diperbesar */
        }

        /* The Styled Box */
        #dialogue-box {
            position: relative; /* Relative to wrapper */
            background: rgba(15, 23, 42, 0.95);
            border: 1px solid var(--secondary);
            border-top: 4px solid var(--secondary);
            /* UPDATE: Padding kiri diperbesar (150px -> 170px) menyesuaikan gambar yang membesar */
            padding: 20px 20px 20px 170px; 
            box-shadow: 0 0 20px rgba(0,0,0,0.8);
            font-family: 'Exo 2', sans-serif;
            clip-path: polygon(20px 0, 100% 0, 100% 100%, 0 100%, 0 20px);
            min-height: 100px;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        @keyframes slideUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        #dialogue-title {
            color: var(--secondary);
            font-family: 'Cinzel', serif;
            font-size: 16px;
            font-weight: bold;
            margin-bottom: 5px;
            text-transform: uppercase;
            letter-spacing: 1px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            padding-bottom: 5px;
        }

        #dialogue-text {
            margin-bottom: 15px;
            line-height: 1.5;
            font-size: 14px;
            color: #e2e8f0;
            /* TAMBAHAN: Agar format baris baru (\n) terbaca dengan baik di dialog */
            white-space: pre-wrap; 
        }

        .btn-group {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            flex-wrap: wrap;
        }

        button {
            background: linear-gradient(135deg, var(--primary), #0f172a);
            color: white;
            border: 1px solid var(--accent);
            padding: 8px 20px;
            cursor: pointer;
            font-family: 'Exo 2', sans-serif;
            font-weight: bold;
            font-size: 12px;
            text-transform: uppercase;
            border-radius: 4px;
            transition: all 0.2s;
            box-shadow: 0 0 10px rgba(6, 182, 212, 0.2);
        }

        button:hover {
            background: var(--accent);
            color: #000;
            box-shadow: 0 0 15px var(--accent);
        }

        button:active {
            transform: scale(0.95);
        }

        /* Controls Modern */
        #controls {
            position: absolute;
            /* UPDATE: Bottom disesuaikan dan ditambah safe-area untuk HP tanpa bezel (iPhone/Android baru) */
            bottom: 20px; 
            width: 100%;
            height: 160px;
            pointer-events: none;
            display: flex;
            justify-content: space-between;
            padding: 0 40px;
            /* Tambahan agar tidak tertutup garis navigasi/home bar HP */
            padding-bottom: env(safe-area-inset-bottom);
            box-sizing: border-box;
        }

        /* FIX: JOYSTICK DIHILANGKAN SESUAI REQUEST */
        .d-pad {
            display: none !important;
        }

        /* Action Buttons tetap ada di kanan */
        .action-btns {
            display: flex;
            gap: 15px; 
            align-items: center; 
            /* FIX: Gunakan absolute positioning agar tetap di kanan bawah meski joystick hilang */
            position: absolute;
            right: 40px;
            bottom: 20px;
            
            pointer-events: auto;
            transform: rotate(-10deg); 
        }

        .round-btn {
            width: 65px;
            height: 65px;
            border-radius: 50%;
            background: radial-gradient(circle at 30% 30%, #475569, #0f172a);
            border: 2px solid #94a3b8;
            color: white;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 24px;
            user-select: none;
            box-shadow: 0 5px 15px rgba(0,0,0,0.5);
            transition: transform 0.1s;
        }
        .round-btn:active { transform: scale(0.9); }
        
        /* MODERN BUBBLE ACTION BUTTON */
        #btn-action {
            width: 85px; 
            height: 85px;
            border-radius: 50%;
            
            /* Glassmorphism Outer Shell */
            background: rgba(255, 255, 255, 0.1); /* Transparan */
            backdrop-filter: blur(4px);
            -webkit-backdrop-filter: blur(4px);
            border: 2px solid rgba(255, 255, 255, 0.4); /* Pinggiran kaca */
            
            /* Lighting & Shadow */
            box-shadow: 
                0 10px 20px rgba(0, 0, 0, 0.2), /* Drop shadow */
                inset 0 0 15px rgba(255, 255, 255, 0.3); /* Inner shine kaca */
            
            color: white;
            font-size: 36px; /* Ikon lebih besar */
            display: flex;
            justify-content: center;
            align-items: center;
            position: relative;
            z-index: 50;
            text-shadow: 0 2px 10px rgba(0,0,0,0.5);
            transition: transform 0.1s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            
            /* Agar tidak bergeser aneh saat di flex */
            flex-shrink: 0; 
        }

        /* Floating Core (Bola Merah di Tengah) */
        #btn-action::before {
            content: '';
            position: absolute;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            width: 60%; height: 60%;
            
            /* Gradient Merah Menyala */
            background: radial-gradient(circle at 30% 30%, #ff5252, #b91c1c);
            border-radius: 50%;
            
            /* Glow effect dari dalam */
            box-shadow: 0 0 20px rgba(239, 68, 68, 0.8);
            z-index: -1; /* Di belakang ikon */
            transition: all 0.2s ease;
        }

        /* Pulse Ring Animation (Gelombang Keluar) */
        #btn-action::after {
            content: '';
            position: absolute;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            width: 100%; height: 100%;
            border-radius: 50%;
            border: 2px solid rgba(255, 255, 255, 0.5);
            opacity: 0;
            z-index: -2;
            animation: bubblePulse 2s infinite;
            pointer-events: none;
        }

        @keyframes bubblePulse {
            0% { width: 90%; height: 90%; opacity: 0.8; border-width: 3px; }
            100% { width: 160%; height: 160%; opacity: 0; border-width: 0px; }
        }

        /* Efek saat ditekan */
        #btn-action:active {
            transform: scale(0.95);
        }
        #btn-action:active::before {
            transform: translate(-50%, -50%) scale(1.2); /* Bola dalam membesar */
            filter: brightness(1.3); /* Lebih terang */
        }
        
        /* Skill Button REMOVED CSS HERE */
        
        .journal-btn { 
            background: radial-gradient(circle at 30% 30%, #16a34a, #14532d);
            border-color: #86efac;
            width: 50px; height: 50px; font-size: 18px; 
        }

        /* --- NEW: SPRINT BUTTON STYLE --- */
        #btn-sprint {
            position: relative;
            width: 65px; height: 65px;
            border-radius: 50%;
            background: rgba(234, 179, 8, 0.2); /* Yellow transparent */
            border: 2px solid #facc15; /* Bright Yellow */
            color: #fef08a;
            display: flex; justify-content: center; align-items: center;
            font-size: 28px;
            box-shadow: 
                0 5px 15px rgba(0,0,0,0.3),
                inset 0 0 10px rgba(234, 179, 8, 0.2);
            cursor: pointer;
            z-index: 60;
            transition: all 0.1s;
            pointer-events: auto;
            flex-shrink: 0;
            /* Animasi denyut halus */
            animation: pulseYellow 2s infinite;
        }

        /* --- NEW: SKILL BUTTON STYLE (ULTIMATE) --- */
        #btn-skill {
            position: relative;
            width: 70px; height: 70px;
            border-radius: 50%;
            background: radial-gradient(circle, #ef4444, #7f1d1d); /* Red Fiery */
            border: 2px solid #fca5a5;
            color: white;
            display: none; /* Hidden by default */
            justify-content: center; align-items: center;
            font-size: 32px;
            box-shadow: 0 0 15px rgba(239, 68, 68, 0.6);
            cursor: pointer;
            z-index: 60;
            transition: transform 0.1s;
            pointer-events: auto;
            flex-shrink: 0;
            /* Animation for readiness */
            animation: pulseRed 2s infinite;
            text-shadow: 0 2px 4px rgba(0,0,0,0.8);
        }
        
        #btn-skill:active { transform: scale(0.9); filter: brightness(1.2); }
        #btn-skill.cooldown { filter: grayscale(1); cursor: not-allowed; animation: none; border-color: #555; background: #333; box-shadow: none; color: #999; }

        @keyframes pulseYellow {
            0% { box-shadow: 0 0 0 0 rgba(250, 204, 21, 0.4); }
            70% { box-shadow: 0 0 0 10px rgba(250, 204, 21, 0); }
            100% { box-shadow: 0 0 0 0 rgba(250, 204, 21, 0); }
        }

        @keyframes pulseRed {
            0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); }
            70% { box-shadow: 0 0 0 15px rgba(239, 68, 68, 0); }
            100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); }
        }

        #btn-sprint:active {
            background: rgba(234, 179, 8, 0.6);
            transform: scale(0.95);
            box-shadow: 0 0 20px rgba(250, 204, 21, 0.8);
            border-color: #fff;
            color: #fff;
        }

        /* --- NEW: INVENTORY BAG STYLES (PREMIUM GLASS) --- */
        #bag-btn {
            /* UPDATE: POSISI RELATIVE AGAR MENGIKUTI FLEXBOX */
            position: relative; 
            /* bottom & right DIHAPUS agar tidak bentrok */
            
            width: 65px; /* Sedikit dikecilkan agar proporsional */
            height: 65px;
            flex-shrink: 0;
            
            /* PASTIKAN TOMBOL BISA DIKLIK */
            pointer-events: auto;
            
            /* Glassmorphism & Bubble Effect */
            background-color: rgba(15, 23, 42, 0.5); /* Base dark tint transparan */
            background-size: 55%; /* Icon size inside bubble */
            background-repeat: no-repeat;
            background-position: center;
            
            border-radius: 50%;
            border: 2px solid rgba(255, 255, 255, 0.2); /* Ring tipis */
            backdrop-filter: blur(6px);
            -webkit-backdrop-filter: blur(6px);
            
            cursor: pointer;
            z-index: 60;
            
            /* Shadows for 3D Depth */
            box-shadow: 
                0 8px 20px rgba(0,0,0,0.5), /* Drop shadow */
                inset 0 3px 10px rgba(255,255,255,0.2), /* Top highlight */
                inset 0 -3px 10px rgba(0,0,0,0.4); /* Bottom shade */
                
            transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1); /* Bouncy transition */
            animation: uiFloat 4s ease-in-out infinite; /* Animasi Melayang */
        }

        /* NEW: QUEST BUTTON STYLE (Next to Bag) */
        #quest-btn {
            /* UPDATE: POSISI RELATIVE AGAR MENGIKUTI FLEXBOX */
            position: relative;
            /* bottom & right DIHAPUS agar tidak bentrok */
            
            width: 65px; 
            height: 65px;
            flex-shrink: 0;
            pointer-events: auto;
            
            /* Style sama dengan Bag */
            background-color: rgba(15, 23, 42, 0.5);
            background-image: url('images/quest-scroll.png'); /* Placeholder name */
            background-size: 50%;
            background-repeat: no-repeat;
            background-position: center;
            
            border-radius: 50%;
            border: 2px solid rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(6px);
            -webkit-backdrop-filter: blur(6px);
            
            cursor: pointer;
            z-index: 60;
            
            box-shadow: 
                0 8px 20px rgba(0,0,0,0.5), 
                inset 0 3px 10px rgba(255,255,255,0.2), 
                inset 0 -3px 10px rgba(0,0,0,0.4);
                
            transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
            animation: uiFloat 4s ease-in-out infinite;
            animation-delay: 0.5s; /* Offset float animation */
            
            /* Fallback Icon if Image fails */
            display: flex; justify-content: center; align-items: center;
            font-size: 28px;
        }

        #quest-btn:hover {
            transform: scale(1.15) rotate(5deg);
            background-color: rgba(251, 191, 36, 0.2);
            border-color: var(--secondary);
            box-shadow: 0 0 25px rgba(251, 191, 36, 0.5);
        }
        #quest-btn:active { transform: scale(0.95); filter: brightness(0.8); }

        /* Efek Kilauan Kaca (Reflection) */
        #bag-btn::before, #quest-btn::before {
            content: '';
            position: absolute;
            top: 10%; left: 20%;
            width: 25%; height: 15%;
            border-radius: 50%;
            background: linear-gradient(180deg, rgba(255,255,255,0.6), rgba(255,255,255,0.1));
            filter: blur(2px);
            pointer-events: none;
        }

        /* Hover State - Glowing & Scaling */
        #bag-btn:hover {
            transform: scale(1.15) rotate(-5deg);
            background-color: rgba(251, 191, 36, 0.2); /* Gold tint on hover */
            border-color: var(--secondary);
            box-shadow: 
                0 0 25px rgba(251, 191, 36, 0.5), /* Glow Emas */
                inset 0 0 15px rgba(251, 191, 36, 0.2);
        }

        /* Active/Click State */
        #bag-btn:active { 
            transform: scale(0.95);
            filter: brightness(0.8);
        }

        /* Animasi Melayang */
        @keyframes uiFloat {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-8px); }
        }

        #inventory-screen {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(15, 23, 42, 0.95);
            z-index: 1500;
            display: none;
            flex-direction: column;
            align-items: center;
            padding: 20px;
            box-sizing: border-box;
            animation: fadeIn 0.2s;
        }

        .inv-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
            gap: 15px;
            width: 100%;
            max-width: 600px;
            margin-top: 20px;
            overflow-y: auto;
            max-height: 70vh;
        }

        .inv-item {
            background: #1e293b;
            border: 2px solid #334155;
            border-radius: 8px;
            padding: 10px;
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            color: white;
            position: relative;
        }
        .inv-item img { width: 32px; height: 32px; margin-bottom: 5px; }
        .inv-item span { font-size: 10px; font-family: 'Exo 2'; }
        .inv-qty {
            position: absolute; top: 2px; right: 5px;
            font-size: 10px; font-weight: bold; color: var(--secondary);
        }
        .inv-empty-msg {
            color: #64748b; font-family: 'Exo 2'; margin-top: 50px; font-style: italic;
        }

        /* --- NEW: WORKER MINIGAME STYLES --- */
        #work-minigame {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(15, 23, 42, 0.95);
            z-index: 2100;
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            animation: fadeIn 0.2s;
        }
        
        .work-card {
            background: #1e293b;
            border: 2px solid var(--secondary);
            border-radius: 12px;
            padding: 20px;
            width: 300px;
            text-align: center;
            box-shadow: 0 0 50px rgba(0,0,0,0.5);
        }

        .work-item-display {
            font-size: 80px;
            margin: 20px 0;
            animation: bounceIn 0.3s;
        }

        .work-bins {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 10px;
            margin-top: 20px;
        }

        .bin-btn {
            background: #334155;
            border: 1px solid #475569;
            color: white;
            padding: 15px 5px;
            border-radius: 8px;
            font-size: 12px;
            font-weight: bold;
            cursor: pointer;
            transition: 0.1s;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
        }
        
        .bin-btn:active { transform: scale(0.95); }
        
        .bin-food { border-bottom: 4px solid #10b981; }
        .bin-tool { border-bottom: 4px solid #3b82f6; }
        .bin-luxury { border-bottom: 4px solid #f59e0b; }

        @keyframes bounceIn {
            0% { transform: scale(0); opacity: 0; }
            60% { transform: scale(1.2); }
            100% { transform: scale(1); opacity: 1; }
        }
        
        .work-score {
            font-family: 'Cinzel';
            font-size: 24px;
            color: var(--secondary);
            margin-bottom: 5px;
        }
        
        .work-timer {
            height: 6px;
            background: #334155;
            border-radius: 3px;
            width: 100%;
            margin-bottom: 15px;
            overflow: hidden;
        }
        .work-timer-fill {
            height: 100%;
            background: #ef4444;
            width: 100%;
            transition: width 1s linear;
        }

        /* --- SCREENS STYLES --- */

        /* Splash Screen */
        #splash-screen {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background: #000;
            z-index: 300;
            display: none; /* UPDATE: Default Hidden, muncul setelah Audio Choice */
            flex-direction: column;
            justify-content: center;
            align-items: center;
            color: white;
            /* UPDATE: Hapus animasi CSS otomatis, kita kontrol via JS setelah loading selesai */
            /* animation: fadeOut 0.5s ease-out 0.5s forwards; */
            transition: opacity 0.5s ease-out;
        }
        
        /* NEW: ANIMASI JUDUL SPLASH */
        @keyframes splashTitleAnim {
            0% { transform: scale(1); text-shadow: 0 0 20px var(--secondary); opacity: 0.8; }
            50% { transform: scale(1.05); text-shadow: 0 0 40px var(--secondary), 0 0 10px var(--accent); opacity: 1; }
            100% { transform: scale(1); text-shadow: 0 0 20px var(--secondary); opacity: 0.8; }
        }
        
        @keyframes pulse {
            0% { transform: scale(1); opacity: 0.8; }
            50% { transform: scale(1.05); opacity: 1; }
            100% { transform: scale(1); opacity: 0.8; }
        }
		
		
		 /* FIX: STYLE UNTUK ENDING SCREEN (AGAR TIDAK MUNCUL DI AWAL) */
        #ending-screen {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(to bottom, #000, #1e3a8a);
            z-index: 2000;
            display: none; /* Default Hidden */
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            padding: 40px;
            box-sizing: border-box;
            color: white;
        }
        #ending-narration { font-family: 'Cinzel'; font-size: 24px; font-style: italic; color: #fbbf24; animation: fadeIn 2s; }
        .certificate-box { border: 4px double #fbbf24; padding: 30px; background: rgba(255, 255, 255, 0.9); color: #000; width: 90%; max-width: 500px; text-align: center; position: relative; font-family: 'Dancing Script', cursive; box-shadow: 0 0 50px rgba(251, 191, 36, 0.5); }

        /* NEW: LOADING BAR STYLES */
        #loading-container {
            width: 60%;
            max-width: 300px;
            height: 4px;
            background: #334155;
            border-radius: 2px;
            margin-top: 20px;
            overflow: hidden;
            position: relative;
        }
        
        #loading-bar {
            width: 0%;
            height: 100%;
            background: linear-gradient(90deg, var(--accent), var(--secondary));
            transition: width 0.2s;
            box-shadow: 0 0 10px var(--accent);
        }
        
        #loading-text {
            font-family: 'Exo 2', sans-serif;
            font-size: 10px;
            color: #94a3b8;
            margin-top: 8px;
            letter-spacing: 1px;
        }

        /* NEW: SPLASH LOGOS STYLES */
        .splash-logos {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 25px; /* Jarak antar logo */
            margin-bottom: 10px;
            /* UPDATE: Menghapus animasi fadeIn agar muncul barengan dengan teks Gemini */
            /* animation: fadeIn 1.5s ease-out; */ 
        }

        .logo-main {
            width: 100px; /* Logo Tengah Lebih Besar */
            height: auto;
            filter: drop-shadow(0 0 20px rgba(251, 191, 36, 0.6)); /* Glow Emas */
            transition: transform 0.3s;
        }
        
        .logo-side {
            width: 70px; /* Logo Samping Lebih Kecil */
            height: auto;
            opacity: 0.9;
            filter: drop-shadow(0 0 10px rgba(6, 182, 212, 0.4)); /* Glow Cyan */
        }

        @keyframes fadeOut {
            to { opacity: 0; visibility: hidden; }
        }

        /* AUDIO PROMPT SCREEN */
        #audio-prompt {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background: #020617;
            z-index: 310; /* UPDATE: Z-Index tertinggi agar muncul paling awal di atas Splash */
            display: flex; /* UPDATE: Default Visible */
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            /* UPDATE: Tambahan padding agar tidak tertutup notch/pinggiran HP */
            padding: 20px;
            padding-left: max(20px, env(safe-area-inset-left));
            padding-right: max(20px, env(safe-area-inset-right));
            box-sizing: border-box; 
        }
        
        /* ... existing Prologue, Gender, Title, etc styles ... */

        /* Prologue Screen */
        #prologue-screen {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background: #000; /* Fallback color */
            z-index: 999;
            display: none;
            /* Layout diubah agar support absolute positioning elemen anak */
            flex-direction: column;
            justify-content: flex-end; /* Konten di bawah */
            align-items: center;
            padding: 0; /* Reset padding container */
            box-sizing: border-box;
            
            /* UPDATE: Background Transition */
            background-size: cover;
            background-position: center;
            transition: background-image 1s ease-in-out;
        }

        #prologue-text {
            font-family: 'Cinzel', serif;
            font-size: 20px; /* Ukuran font nyaman dibaca */
            line-height: 1.6;
            color: var(--secondary); /* Warna Emas */
            font-style: italic;
            
            /* UPDATE: POSISI DI BAWAH (CINEMATIC SUBTITLE STYLE) */
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            
            /* Gradient background agar teks terbaca di atas gambar apapun */
            background: linear-gradient(to top, rgba(0,0,0,1) 0%, rgba(0,0,0,0.8) 50%, transparent 100%);
            
            padding: 60px 40px 50px 40px; /* Padding atas luas untuk fade, bawah untuk jarak aman */
            text-align: center;
            text-shadow: 0 2px 4px #000;
            
            opacity: 0;
            transition: opacity 0.5s ease-in-out;
            z-index: 1000;
        }

        /* Gender Selection Screen */
        #gender-screen {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(rgba(0,0,0,0.5), rgba(0,0,0,0.5)), url('images/bg.png');
            background-size: cover;
            z-index: 210;
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            /* UPDATE: Pastikan bisa diklik, menimpa pointer-events container jika ada */
            pointer-events: auto; 
        }

        .gender-options {
            display: flex;
            gap: 40px;
            margin-top: 30px;
        }

        .gender-card {
            background: rgba(15, 23, 42, 0.8);
            border: 2px solid var(--secondary);
            border-radius: 15px;
            padding: 30px;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
            box-shadow: 0 0 20px rgba(251, 191, 36, 0.1);
        }

        .gender-card:hover {
            transform: translateY(-10px) scale(1.05);
            background: rgba(30, 58, 138, 0.9);
            box-shadow: 0 0 30px var(--accent);
            border-color: var(--accent);
        }

        .gender-card img {
            width: 100px;
            height: 100px;
            object-fit: contain;
            margin-bottom: 15px;
            filter: drop-shadow(0 0 10px rgba(255,255,255,0.2));
        }

        .gender-title {
            font-family: 'Cinzel', serif;
            font-size: 14px;
            font-weight: bold;
            color: var(--secondary);
            letter-spacing: 2px;
        }

        /* NEW: LOGIN TITLE STYLE (ANIMATED & READABLE) */
        .login-title {
            font-family: 'Cinzel', serif;
            font-size: 36px; /* Lebih Besar */
            font-weight: 900;
            text-align: center;
            margin-bottom: 25px;
            letter-spacing: 2px;
            text-transform: uppercase;
            
            /* Gradient Emas Mewah */
            background: linear-gradient(to bottom, #fffbeb, #fbbf24, #d97706);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            
            /* Stroke Hitam Tebal agar terbaca di background apapun */
            -webkit-text-stroke: 1.5px #451a03; 
            
            /* Glow Effect & Shadow */
            filter: drop-shadow(0 5px 0 #000) drop-shadow(0 0 15px rgba(251, 191, 36, 0.8));
            
            /* Animasi */
            animation: loginFloat 3s ease-in-out infinite;
            position: relative;
            z-index: 10;
        }

        @keyframes loginFloat {
            0%, 100% { 
                transform: translateY(0); 
                filter: drop-shadow(0 5px 0 #000) drop-shadow(0 0 15px rgba(251, 191, 36, 0.6));
            }
            50% { 
                transform: translateY(-8px); 
                filter: drop-shadow(0 15px 5px rgba(0,0,0,0.5)) drop-shadow(0 0 30px rgba(251, 191, 36, 1)); 
            }
        }

        /* Title Screen */
        #title-screen {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            /* UPDATE: Background dipergelap (opacity 0.7 dan 0.5) agar teks lebih pop-up */
            background: linear-gradient(135deg, rgba(2, 6, 23, 0.85) 0%, rgba(30, 58, 138, 0.6) 100%), url('images/bg.png');
            background-size: cover;
            background-position: center;
            z-index: 250;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            overflow: hidden; /* Agar burung tidak scrollbar */
        }

        /* ANIMASI TITLE */
        @keyframes titleShine {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        @keyframes titleFloat {
            0%, 100% { transform: translateY(0) scale(1); }
            50% { transform: translateY(-10px) scale(1.02); }
        }

        #title-screen h1 {
            font-family: 'Cinzel', serif;
            font-size: 56px; /* Lebih besar */
            font-weight: 900;
            
            /* Gradient Emas Mengkilap */
            background: linear-gradient(to right, #b45309, #fbbf24, #fff, #fbbf24, #b45309);
            background-size: 200% auto;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            
            /* Shadow Tebal & Stroke agar terbaca di background apapun */
            filter: drop-shadow(0 4px 0px rgba(0,0,0,1)) drop-shadow(0 0 30px rgba(251, 191, 36, 0.8));
            -webkit-text-stroke: 1px #451a03; 
            
            margin-bottom: 5px;
            letter-spacing: 4px;
            animation: titleShine 3s linear infinite, titleFloat 4s ease-in-out infinite;
            position: relative;
            z-index: 10;
        }

        #title-screen h2 {
            font-family: 'Exo 2', sans-serif;
            font-size: 18px;
            color: #22d3ee; /* Cyan lebih terang */
            text-transform: uppercase;
            letter-spacing: 8px;
            margin-bottom: 60px;
            text-shadow: 0 0 10px rgba(6, 182, 212, 0.8), 2px 2px 0px #000;
            position: relative;
            z-index: 10;
            animation: fadeIn 2s ease-in;
        }

        /* ANIMASI BURUNG (CSS ONLY) */
        .bird-container {
            position: absolute;
            top: 20%;
            left: -10%;
            transform: scale(0) translateX(-10vw);
            will-change: transform;
            animation-name: fly-right-one;
            animation-timing-function: linear;
            animation-iteration-count: infinite;
            z-index: 5; /* Di belakang teks */
        }
        
        .bird-img {
            background-image: url('https://s3-us-west-2.amazonaws.com/s.cdpn.io/174479/bird-cells-new.svg');
            background-size: auto 100%;
            width: 88px;
            height: 125px;
            will-change: background-position;
            animation-name: fly-cycle;
            animation-timing-function: steps(10);
            animation-iteration-count: infinite;
        }

        .bird-container--one {
            animation-duration: 15s;
            animation-delay: 0;
        }
        .bird-container--two {
            animation-duration: 16s;
            animation-delay: 1s;
            top: 15%;
            transform: scale(0.8);
        }
        .bird-container--three {
            animation-duration: 14.6s;
            animation-delay: 9.5s;
            top: 25%;
            transform: scale(0.6);
        }
        .bird-container--four {
            animation-duration: 16s;
            animation-delay: 10.25s;
            top: 10%;
            transform: scale(0.5);
        }

        @keyframes fly-cycle {
            100% { background-position: -900px 0; }
        }
        @keyframes fly-right-one {
            0% { left: -10%; transform: scale(0.6) translateY(0vh); }
            100% { left: 110%; transform: scale(0.6) translateY(5vh); }
        }

        #title-screen h1 {
            font-family: 'Cinzel', serif;
            font-size: 48px;
            font-weight: 900;
            background: linear-gradient(to bottom, #fbbf24, #b45309);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            filter: drop-shadow(0 0 20px rgba(251, 191, 36, 0.5));
            margin-bottom: 5px;
            letter-spacing: 3px;
        }

        #title-screen h2 {
            font-family: 'Exo 2', sans-serif;
            font-size: 16px;
            color: var(--accent);
            text-transform: uppercase;
            letter-spacing: 6px;
            margin-bottom: 50px;
        }

        .main-menu-btn {
            background: transparent;
            border: 2px solid var(--secondary);
            color: var(--secondary);
            padding: 15px 50px;
            margin: 10px;
            font-size: 16px;
            font-family: 'Cinzel', serif;
            font-weight: bold;
            cursor: pointer;
            min-width: 280px; /* Diubah min-width agar tombol flexible */
            transition: 0.3s;
            position: relative;
            overflow: hidden;
            clip-path: polygon(15px 0, 100% 0, 100% calc(100% - 15px), calc(100% - 15px) 100%, 0 100%, 0 15px);
        }
        
        .main-menu-btn::before {
            content: '';
            position: absolute; top: 0; left: 0; width: 0%; height: 100%;
            background: var(--secondary);
            z-index: -1;
            transition: 0.3s;
        }

        .main-menu-btn:hover {
            color: #0f172a;
            box-shadow: 0 0 20px var(--secondary);
        }
        .main-menu-btn:hover::before { width: 100%; }

        /* Login Screen */
        #login-screen {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(rgba(15, 23, 42, 0.5), rgba(15, 23, 42, 0.6)), url('images/lobby.png');
            background-size: cover;
            background-position: center;
            z-index: 200;
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            pointer-events: auto;
        }
        
        .login-card {
            background: rgba(30, 41, 59, 0.8);
            backdrop-filter: blur(10px);
            padding: 30px;
            border: 1px solid rgba(255,255,255,0.1);
            border-top: 2px solid var(--accent);
            box-shadow: 0 20px 50px rgba(0,0,0,0.5);
            
            /* UPDATE: OPTIMASI LEBAR UNTUK HP (RESPONSIF) */
            width: 90%; /* Menggunakan persentase */
            max-width: 380px; /* Batas maksimal */
            
            /* FIX: Agar form bisa di-scroll di Mobile saat keyboard muncul */
            max-height: 85vh; /* Kurangi sedikit agar pas */
            overflow-y: auto; /* Aktifkan scrollbar vertikal */
            touch-action: pan-y; /* Izinkan browser menangani geseran vertikal (scroll) */
            -webkit-overflow-scrolling: touch; /* Smooth scroll untuk iOS */
            overscroll-behavior: contain; /* Cegah scroll parent body */

            border-radius: 8px;
        }

        .login-tabs {
            display: flex;
            margin-bottom: 20px;
            background: #0f172a;
            border-radius: 4px;
            padding: 4px;
        }

        .tab-btn {
            flex: 1;
            background: none;
            border: none;
            color: #94a3b8;
            padding: 10px;
            cursor: pointer;
            font-weight: bold;
            font-family: 'Exo 2', sans-serif;
            transition: 0.2s;
            border-radius: 4px;
        }

        .tab-btn.active {
            color: #fff;
            background: var(--primary);
            box-shadow: 0 0 10px rgba(30, 58, 138, 0.5);
        }

        .auth-switch {
            font-size: 12px;
            color: var(--accent);
            margin-bottom: 20px;
            cursor: pointer;
            text-align: right;
        }
        .auth-switch:hover { text-decoration: underline; }

        .form-input-group {
            position: relative;
            width: 100%;
        }

        .form-input {
            width: 100%;
            padding: 12px;
            margin: 8px 0;
            border-radius: 4px;
            border: 1px solid #475569;
            background: #1e293b;
            color: white;
            font-family: 'Exo 2', sans-serif;
            box-sizing: border-box;
            transition: 0.2s;
        }
        
        .form-input:focus {
            border-color: var(--accent);
            outline: none;
            box-shadow: 0 0 0 2px rgba(6, 182, 212, 0.2);
        }

        .password-toggle {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            cursor: pointer;
            color: #94a3b8;
            z-index: 5;
            user-select: none;
        }

        .auth-btn {
            width: 100%;
            margin-top: 15px;
            background: linear-gradient(90deg, var(--primary), var(--accent));
            border: none;
            padding: 12px;
            font-size: 14px;
        }
        
        /* NEW: Skip Button for Prologue */
        #skip-prologue-btn {
            position: absolute;
            /* UPDATE: Posisi tombol skip agar tidak menutupi teks */
            top: 30px; 
            right: 30px;
            
            background: rgba(0, 0, 0, 0.5); /* Semi transparan */
            border: 1px solid var(--secondary);
            color: var(--secondary);
            padding: 8px 16px;
            font-family: 'Exo 2', sans-serif;
            font-weight: bold;
            font-size: 12px;
            cursor: pointer;
            z-index: 1001; /* Di atas teks */
            display: none; /* Shown by JS */
            backdrop-filter: blur(4px);
            border-radius: 4px;
        }
        #skip-prologue-btn:hover {
            background: var(--secondary);
            color: #000;
        }

        /* Start Screen (Intro after login) */
        #start-screen {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(rgba(15, 23, 42, 0.7), rgba(15, 23, 42, 0.9)), url('images/landinggame.png');
            background-size: cover;
            background-position: center;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 100;
            text-align: center;
            pointer-events: auto;
        }

        #start-screen h1 {
            font-family: 'Cinzel', serif;
            color: var(--secondary);
            font-size: 32px;
            text-shadow: 0 0 20px var(--secondary);
            margin-bottom: 10px;
        }
        
        #start-screen button {
            margin-top: 20px;
            padding: 15px 40px;
            font-size: 16px;
            border: 1px solid var(--secondary);
        }

        .hidden { display: none !important; }

        #toast {
            position: absolute;
            top: 80px;
            left: 50%;
            transform: translateX(-50%);
            background: linear-gradient(90deg, transparent, rgba(6, 182, 212, 0.8), transparent);
            color: #fff;
            padding: 10px 40px;
            font-family: 'Cinzel', serif;
            font-weight: bold;
            font-size: 14px;
            opacity: 0;
            transition: opacity 0.3s;
            pointer-events: none;
            /* UPDATE: Z-Index dinaikkan drastis agar muncul di atas Inventory/Modal */
            z-index: 3000; 
            text-shadow: 0 0 5px rgba(0,0,0,0.8);
        }

        /* --- NEW: GAME OVER SCREEN --- */
        #game-over-screen {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(to bottom, #0f172a, #000);
            z-index: 2000;
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            padding: 40px;
            box-sizing: border-box;
            color: white;
            animation: fadeIn 2s ease-in;
        }

        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        #game-over-screen h1 {
            font-family: 'Cinzel', serif;
            font-size: 40px;
            color: var(--danger);
            text-shadow: 0 0 20px var(--danger);
            margin-bottom: 10px;
        }

        #reflection-text {
            font-family: 'Exo 2', sans-serif;
            font-size: 18px;
            color: #cbd5e1;
            max-width: 600px;
            margin-bottom: 20px;
            line-height: 1.6;
            background: rgba(30, 41, 59, 0.5);
            padding: 20px;
            border-radius: 10px;
            border: 1px solid var(--secondary);
        }

        #motivation-text {
            font-family: 'Cinzel', serif;
            font-size: 22px;
            color: var(--secondary);
            font-style: italic;
            margin-bottom: 40px;
            max-width: 700px;
        }

        /* --- DASHBOARD GURU STYLES --- */
        #teacher-dashboard {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: var(--dash-bg); z-index: 500; display: none;
            font-family: 'Exo 2', sans-serif; color: var(--dash-text);
            overflow: hidden; pointer-events: auto;
        }
        
        .dash-container { display: flex; height: 100%; width: 100%; }
        
        .dash-sidebar { 
            width: 240px; 
            background: var(--dash-sidebar); 
            color: #ecf0f1; 
            display: flex; 
            flex-direction: column; 
            padding-top: 20px; 
            
            /* FIX: Agar menu bisa discroll di layar pendek (HP Landscape) */
            overflow-y: auto; 
            height: 100%;
            flex-shrink: 0;
            
            /* Scrollbar styling agar terlihat */
            scrollbar-width: thin;
            scrollbar-color: var(--accent) var(--dash-sidebar);

            /* FIX: Mengizinkan scroll vertikal pada layar sentuh */
            touch-action: pan-y;
            -webkit-overflow-scrolling: touch;
        }

        /* FIX: Optimasi Tampilan Mobile Landscape (Layar Pendek) */
        @media (max-height: 600px) {
            .dash-sidebar {
                width: 180px; /* Perkecil lebar sidebar */
                padding-top: 10px;
            }
            .dash-title {
                font-size: 14px !important;
                margin-bottom: 10px !important;
                padding-bottom: 10px !important;
            }
            .dash-nav li {
                padding: 10px 15px !important; /* Perkecil jarak antar menu */
                font-size: 12px !important;
            }
            .dash-content {
                padding: 15px !important; /* Perkecil padding konten utama */
            }
        }

        .dash-title { 
            text-align: center; font-weight: 900; margin-bottom: 40px; 
            font-size: 18px; letter-spacing: 2px; color: var(--secondary); 
            font-family: 'Cinzel'; line-height: 1.5; 
            border-bottom: 1px solid rgba(255,255,255,0.1); 
            padding-bottom: 20px; flex-shrink: 0; 
        }
        
        .dash-nav { list-style: none; padding: 0; margin: 0; flex: 1; display: flex; flex-direction: column; }
        
        .dash-nav li { 
            padding: 18px 25px; cursor: pointer; border-left: 4px solid transparent; 
            transition: 0.2s; font-size: 14px; display: flex; align-items: center; gap: 10px; 
            color: #94a3b8; flex-shrink: 0; 
        }
        
        .dash-nav li:hover, .dash-nav li.active { background: rgba(255,255,255,0.05); border-left-color: var(--accent); color: #fff; }
        .dash-content { 
            flex: 1; padding: 30px; overflow-y: auto; background: #f8fafc;
            /* FIX: Mengizinkan scroll vertikal pada layar sentuh */
            touch-action: pan-y;
            -webkit-overflow-scrolling: touch;
        }
        
        .dash-card { 
            background: white; padding: 25px; border-radius: 12px; 
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); margin-bottom: 25px; 
            border: 1px solid #e2e8f0; 
            
            /* UPDATE: OPTIMASI TABEL ADMIN UNTUK HP */
            overflow-x: auto; /* Scroll samping jika tabel terlalu lebar */
            -webkit-overflow-scrolling: touch;
        }
        .dash-table { 
            width: 100%; border-collapse: collapse; font-size: 14px; margin-top: 15px; 
            /* Pastikan tabel tidak terlalu gepeng di HP */
            min-width: 600px; 
        }
        .dash-table th { text-align: left; padding: 15px; background: #f1f5f9; border-bottom: 2px solid #e2e8f0; color: #475569; font-weight: 700; text-transform: uppercase; font-size: 12px; }
        .dash-table td { padding: 15px; border-bottom: 1px solid #e2e8f0; }
        
        .status-badge { padding: 6px 12px; border-radius: 20px; font-size: 11px; font-weight: bold; text-transform: uppercase; }
        .online { background: #dcfce7; color: #15803d; }
        .offline { background: #fee2e2; color: #b91c1c; }
        
        /* Modal Journal Siswa */
        #journal-modal {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8); z-index: 500; display: none;
            justify-content: center; align-items: center; pointer-events: auto;
            backdrop-filter: blur(5px);
        }
        
        /* FIX: Tambahkan Class Overlay yang Hilang agar Popup Terlihat */
        .minigame-overlay {
            position: absolute; 
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.85); 
            z-index: 2000; 
            display: none; 
            justify-content: center; 
            align-items: center; 
            flex-direction: column; 
            backdrop-filter: blur(5px);
            pointer-events: auto;
        }

        .journal-box { 
            background: #1e293b; color: #fff; padding: 30px; 
            border-radius: 12px; width: 80%; max-width: 500px; 
            border: 1px solid var(--secondary);
            box-shadow: 0 0 30px rgba(0,0,0,0.5);
            /* NEW: Agar popup tidak terlalu tinggi di layar HP */
            max-height: 90vh;
            display: flex;
            flex-direction: column;
            
            /* FIX: Tambahkan Scroll Vertikal untuk Layar Kecil/Landscape */
            overflow-y: auto;
            -webkit-overflow-scrolling: touch; /* Smooth scroll iOS */
            scrollbar-width: thin; /* Firefox: Scrollbar tipis */
        }
        
        /* FIX: Pastikan scrollbar tidak menutupi konten terlalu banyak */
        .journal-box::-webkit-scrollbar {
            width: 6px;
        }
        .journal-box::-webkit-scrollbar-thumb {
            background: var(--secondary);
            border-radius: 3px;
        }
        .journal-box::-webkit-scrollbar-track {
            background: rgba(0,0,0,0.2);
        }

        textarea { width: 100%; height: 120px; padding: 15px; margin: 15px 0; border: 1px solid #475569; border-radius: 6px; font-family: 'Exo 2', sans-serif; background: #0f172a; color: white; box-sizing: border-box;}
        textarea:focus { outline: 1px solid var(--accent); }

        /* NEW: STYLES FOR QUEST TABS */
        .quest-tabs {
            display: flex;
            gap: 5px;
            margin-bottom: 10px;
            border-bottom: 1px solid #475569;
            padding-bottom: 5px;
        }
        .quest-tab-btn {
            flex: 1;
            background: transparent;
            border: none;
            color: #94a3b8;
            padding: 8px 2px;
            font-family: 'Exo 2', sans-serif;
            font-weight: bold;
            font-size: 10px;
            cursor: pointer;
            text-transform: uppercase;
            border-bottom: 2px solid transparent;
            transition: all 0.2s;
        }
        .quest-tab-btn:hover { color: #fff; background: rgba(255,255,255,0.05); }
        .quest-tab-btn.active {
            color: var(--secondary);
            border-bottom: 2px solid var(--secondary);
            background: linear-gradient(to top, rgba(251, 191, 36, 0.1), transparent);
        }

        /* --- NEW: CALENDAR UI STYLES (Harvest Moon Style) --- */
        .cal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; border-bottom: 2px solid #334155; padding-bottom: 10px; }
        .cal-title-text { font-family: 'Cinzel'; color: var(--secondary); font-size: 18px; font-weight: bold; text-shadow: 0 0 10px rgba(251, 191, 36, 0.3); }
        .cal-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 4px; }
        .cal-day-header { text-align: center; font-size: 10px; color: #94a3b8; font-weight: bold; padding-bottom: 5px; }
        
        .cal-cell { 
            aspect-ratio: 1; 
            background: rgba(30, 41, 59, 0.5); 
            border: 1px solid #334155; 
            border-radius: 6px; 
            display: flex; flex-direction: column; align-items: center; justify-content: flex-start;
            padding-top: 4px;
            cursor: pointer; 
            transition: all 0.2s;
            position: relative;
        }
        .cal-cell:hover { background: rgba(255,255,255,0.1); border-color: var(--accent); transform: scale(1.05); z-index: 10; }
        
        .cal-num { font-family: 'Exo 2'; font-size: 12px; font-weight: bold; color: #e2e8f0; }
        .cal-icon { font-size: 14px; margin-top: 2px; }
        
        /* Marker Hari Ini */
        .cal-cell.today { 
            border: 2px solid #fbbf24; 
            background: rgba(251, 191, 36, 0.15); 
            box-shadow: 0 0 15px rgba(251, 191, 36, 0.3); 
        }
        .cal-cell.today .cal-num { color: #fbbf24; text-decoration: underline; }

        /* Marker Festival */
        .cal-cell.festival { border-color: #f472b6; background: rgba(244, 114, 182, 0.1); }
        .cal-cell.birthday { border-color: #60a5fa; background: rgba(96, 165, 250, 0.1); }
        
        /* Marker Dot Kecil */
        .cal-dot { width: 6px; height: 6px; border-radius: 50%; position: absolute; top: 4px; right: 4px; }

/* --- REMOVED OLD HUD STYLES TO REPLACE WITH NEW REDESIGN --- */

button, .round-btn, .d-btn, .auth-btn { 
    cursor: pointer !important; 
}

/* --- NEW: MINIMAP STYLES --- */
#minimap-container {
    position: absolute;
    top: 90px; /* Di bawah HUD baru */
    left: 20px;
    width: 120px;
    height: 90px; /* Aspect Ratio mendekati map */
    /* UPDATE: Background dibuat lebih transparan (0.85 -> 0.65) agar tidak terlalu gelap */
    background: rgba(15, 23, 42, 0.65);
    border: 2px solid var(--secondary);
    border-radius: 8px;
    overflow: hidden;
    box-shadow: 0 4px 15px rgba(0,0,0,0.6);
    pointer-events: none; /* Agar tidak mengganggu sentuhan layar */
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 40;
    /* UPDATE: Tambahkan backdrop-filter blur agar tetap terbaca meski transparan */
    backdrop-filter: blur(2px);
}

#minimapCanvas {
    width: 100%;
    height: 100%;
    object-fit: contain;
}

 /* --- NEW: STYLING GAME BALAP --- */
        .race-btn {
            width: 60px; height: 60px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.15);
            border: 2px solid #fff;
            color: #fff;
            font-size: 24px;
            display: flex; justify-content: center; align-items: center;
            cursor: pointer;
            backdrop-filter: blur(4px);
            transition: 0.1s;
        }
        .race-btn:active { background: rgba(255,255,255,0.4); transform: scale(0.95); }

#minimap-label {
    position: absolute;
    bottom: 2px;
    right: 4px;
    font-size: 8px;
    color: var(--secondary);
    font-family: 'Exo 2', sans-serif;
    font-weight: bold;
    text-shadow: 0 0 20px black;
    pointer-events: none;
}

        #job-app-result-area {
            min-height: 50px; width: 80%; border-bottom: 2px dashed #94a3b8; 
            margin-bottom: 20px; font-size: 18px; text-align: center; color: var(--secondary);
        }

        /* --- NEW: LEADERBOARD STYLES (Title Screen) --- */
        #leaderboard-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85); z-index: 2000;
            display: none; justify-content: center; align-items: center;
            flex-direction: column; backdrop-filter: blur(5px);
            /* FIX: Pastikan overlay menerima input sentuhan */
            pointer-events: auto;
        }
        .lb-card {
            /* UPDATE: MENAMBAHKAN BACKGROUND IMAGE PADA LEADERBOARD */
            background: linear-gradient(to bottom, rgba(30, 41, 59, 0.9), rgba(15, 23, 42, 0.95)), url('images/leaderboard.png');
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;

            border: 2px solid #fbbf24; padding: 25px;
            border-radius: 12px; width: 90%; max-width: 400px; max-height: 85vh; overflow-y: auto;
            text-align: center; color: white; box-shadow: 0 0 30px rgba(251, 191, 36, 0.3);
            position: relative;
            /* FIX: Pastikan scroll lancar di HP dan bisa diklik */
            -webkit-overflow-scrolling: touch;
            pointer-events: auto;
        }
        .lb-item {
            display: flex; justify-content: space-between; align-items: center; padding: 12px;
            border-bottom: 1px solid #334155; font-family: 'Exo 2'; font-size: 14px;
            transition: 0.2s;
        }
        .lb-item:hover { background: rgba(255,255,255,0.05); }
        .lb-rank { font-weight: 900; color: #94a3b8; width: 30px; text-align: left; }
        .lb-rank.top-1 { color: #fbbf24; font-size: 18px; } /* Emas */
        .lb-rank.top-2 { color: #e2e8f0; font-size: 16px; } /* Perak */
        .lb-rank.top-3 { color: #b45309; font-size: 16px; } /* Perunggu */
        
        .lb-info { flex: 1; text-align: left; display: flex; flex-direction: column; }
        .lb-name { font-weight: bold; color: white; }
        .lb-detail { font-size: 10px; color: #94a3b8; }
        
        .lb-score { font-weight: bold; color: #38bdf8; font-family: 'Cinzel'; }

        /* --- NEW: DASHBOARD PODIUM STYLES --- */
        .podium-container {
            display: flex; justify-content: center; align-items: flex-end; gap: 15px;
            margin-bottom: 40px; min-height: 220px; padding-top: 20px;
        }
        .podium-item {
            display: flex; flex-direction: column; align-items: center; justify-content: flex-end;
            background: white; border-radius: 8px 8px 0 0; padding: 15px 10px;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); width: 130px;
            position: relative; text-align: center;
            border: 1px solid #e2e8f0; border-bottom: none;
        }
        
        /* Juara 1 */
        .rank-1 { height: 200px; background: linear-gradient(to top, #fffbeb, #fff); border-top: 6px solid #fbbf24; order: 2; z-index: 2; transform: scale(1.05); }
        .rank-1 .podium-badge { color: #fbbf24; text-shadow: 0 2px 0 #b45309; font-size: 40px; top: -25px; }
        
        /* Juara 2 */
        .rank-2 { height: 160px; background: linear-gradient(to top, #f8fafc, #fff); border-top: 6px solid #94a3b8; order: 1; }
        .rank-2 .podium-badge { color: #94a3b8; text-shadow: 0 2px 0 #475569; font-size: 32px; top: -20px; }
        
        /* Juara 3 */
        .rank-3 { height: 130px; background: linear-gradient(to top, #fff7ed, #fff); border-top: 6px solid #d97706; order: 3; }
        .rank-3 .podium-badge { color: #d97706; text-shadow: 0 2px 0 #78350f; font-size: 32px; top: -20px; }

        .podium-avatar { 
            width: 50px; height: 50px; border-radius: 50%; border: 3px solid white; 
            box-shadow: 0 4px 6px rgba(0,0,0,0.1); margin-bottom: 10px; 
            background: #cbd5e1; object-fit: cover; 
        }
        .podium-name { font-weight: 800; font-size: 13px; color: #0f172a; line-height: 1.2; margin-bottom: 2px; }
        .podium-class { font-size: 10px; color: #64748b; margin-bottom: 8px; }
        .podium-score { font-weight: 900; font-size: 18px; color: var(--primary); font-family: 'Cinzel'; }
        .podium-badge { position: absolute; font-family: 'Cinzel'; }

        /* --- NEW: TUTORIAL POINTER & HIGHLIGHT --- */
        #tutorial-pointer {
            position: fixed;
            z-index: 9999;
            pointer-events: none;
            display: none;
            /* UPDATE: Hapus filter drop-shadow di parent, pindah ke icon agar glow lebih bagus */
            /* filter: drop-shadow(0 4px 4px rgba(0,0,0,0.5)); */
            transition: opacity 0.3s, transform 0.2s;
            transform-origin: center top;
            
            /* NEW: Flexbox untuk menyusun Teks dan Tangan secara vertikal */
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
        }
        
        /* NEW: STYLE UNTUK LABEL TEKS TUTORIAL */
        .pointer-label {
            background: linear-gradient(90deg, #f59e0b, #d97706); /* Orange Emas */
            color: white;
            padding: 6px 12px;
            border-radius: 20px;
            font-family: 'Exo 2', sans-serif;
            font-weight: 800;
            font-size: 14px;
            text-transform: uppercase;
            text-shadow: 0 1px 2px rgba(0,0,0,0.8);
            border: 2px solid white;
            box-shadow: 0 4px 10px rgba(0,0,0,0.5);
            margin-bottom: 5px; /* Jarak ke tangan */
            white-space: nowrap;
            animation: pulseLabel 0.8s infinite alternate; /* Animasi Denyut */
        }

        .hand-icon {
            font-size: 50px;
            /* UPDATE: Animasi lebih cepat dan heboh */
            animation: bounceFinger 0.6s infinite ease-in-out alternate;
            filter: drop-shadow(0 5px 5px rgba(0,0,0,0.5));
        }

        @keyframes bounceFinger {
            0% { 
                transform: translateY(0) scale(1); 
                filter: drop-shadow(0 0 0 rgba(251, 191, 36, 0)); 
            }
            100% { 
                transform: translateY(-15px) scale(1.2); /* Membesar & Naik */
                filter: drop-shadow(0 0 20px rgba(251, 191, 36, 1)); /* Glow Emas */
            }
        }

        @keyframes pulseLabel {
            0% { transform: scale(1); opacity: 0.9; }
            100% { transform: scale(1.1); opacity: 1; }
        }

        /* Kelas Highlight untuk menyorot elemen UI saat tutorial */
        .tutorial-highlight {
            box-shadow: 0 0 0 4px #fbbf24, 0 0 30px #fbbf24 !important;
            z-index: 2000 !important;
            position: relative;
            animation: pulseGlow 1s infinite alternate;
            background-color: rgba(251, 191, 36, 0.2) !important; /* Gold tint */
        }

        @keyframes pulseGlow {
            from { transform: scale(1); box-shadow: 0 0 0 4px #fbbf24, 0 0 20px #fbbf24; }
            to { transform: scale(1.05); box-shadow: 0 0 0 6px #f59e0b, 0 0 40px #f59e0b; }
        }

        /* --- NEW: VIRTUAL JOYSTICK VISUAL --- */
        #virtual-joystick-base {
            position: absolute;
            width: 120px;
            height: 120px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.1); /* Transparan Putih */
            border: 2px solid rgba(255, 255, 255, 0.3);
            display: none; /* Hidden by default */
            pointer-events: none; /* Pass through agar tidak blokir event */
            z-index: 40; /* Di bawah tombol UI (z-60) */
            transform: translate(-50%, -50%); /* Center anchor */
            backdrop-filter: blur(2px);
            box-shadow: 0 0 15px rgba(0,0,0,0.2);
        }

        #virtual-joystick-stick {
            position: absolute;
            top: 50%; left: 50%;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            /* Gradient Emas sesuai tema */
            background: radial-gradient(circle at 30% 30%, var(--secondary), #d97706); 
            border: 2px solid #fffbeb;
            transform: translate(-50%, -50%);
            box-shadow: 0 0 10px rgba(251, 191, 36, 0.5);
        }

        /* --- NEW: DAMAGE FEEDBACK EFFECTS --- */
        #damage-overlay {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background: radial-gradient(circle, transparent 60%, rgba(239, 68, 68, 0.6) 100%);
            opacity: 0;
            pointer-events: none;
            z-index: 100;
            transition: opacity 0.1s;
            mix-blend-mode: overlay;
        }

        .damage-active {
            animation: damageFlash 0.3s ease-out;
        }

        @keyframes damageFlash {
            0% { opacity: 1; transform: scale(1.05); }
            100% { opacity: 0; transform: scale(1); }
        }

        /* Kelas Getar Layar */
        .shake-screen {
            animation: shake 0.4s cubic-bezier(.36,.07,.19,.97) both;
        }

        @keyframes shake {
            10%, 90% { transform: translate3d(-4px, 0, 0); }
            20%, 80% { transform: translate3d(6px, 0, 0); }
            30%, 50%, 70% { transform: translate3d(-8px, 0, 0); }
            40%, 60% { transform: translate3d(8px, 0, 0); }
        }
		
		 /* --- NEW: ABOUT AVATAR ANIMATION (BREATHING) --- */
        @keyframes avatarBreathe {
            0% { transform: scale(1); box-shadow: 0 0 15px rgba(251, 191, 36, 0.3); }
            50% { transform: scale(1.05); box-shadow: 0 0 25px rgba(251, 191, 36, 0.6); }
            100% { transform: scale(1); box-shadow: 0 0 15px rgba(251, 191, 36, 0.3); }
        }

        .about-avatar {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            border: 3px solid var(--secondary);
            object-fit: cover;
            margin-bottom: 15px;
            animation: avatarBreathe 3s infinite ease-in-out; /* Efek Bernapas */
        }
        
        /* --- NEW: RACING MINIGAME ANIMATIONS --- */
        @keyframes roadScroll {
            from { background-position-y: 0; }
            to { background-position-y: 100px; }
        }
        .road-moving {
            animation: roadScroll 0.2s linear infinite;
        }

        /* Efek Ledakan */
        @keyframes boom {
            0% { transform: scale(1); opacity: 1; filter: hue-rotate(0deg); }
            50% { transform: scale(1.5); opacity: 0.8; filter: hue-rotate(90deg); }
            100% { transform: scale(2); opacity: 0; }
        }
        .explosion {
            animation: boom 0.5s forwards;
            font-size: 60px !important;
            text-shadow: 0 0 20px red;
        }

    </style>
</head>
<body>
	<!-- 2. HTML UNTUK LAYAR JEDA -->
    <!-- Kode ini yang akan tampil menutupi game saat fullscreen lepas -->
    <div id="resume-overlay">
        <div class="resume-title">PERMAINAN DIJEDA</div>
        <p class="resume-text">
            Browser membatalkan Full Screen karena Anda beralih aplikasi.<br>
            Ketuk tombol di bawah untuk kembali fokus.
        </p>
        <!-- Saat diklik, panggil fungsi resumeFullscreen() -->
        <button class="resume-btn" onclick="resumeFullscreen()"> LANJUT MAIN</button>
    </div>
 <!-- CUSTOM PROMPT MODAL (Pesan Guru) -->
    <div id="custom-prompt-modal">
        <div class="prompt-box">
            <h3 style="color:var(--secondary); font-family:'Cinzel'; margin-top:0;">KIRIM PESAN GURU</h3>
            <p style="color:#cbd5e1; font-size:12px; margin-bottom:10px;">Tulis pesan motivasi atau teguran untuk siswa:</p>
            <textarea id="custom-prompt-input" style="width:100%; height:80px; margin-bottom:15px; background:#0f172a; color:white; border:1px solid #475569; padding:10px; border-radius:6px; font-family:'Exo 2';" placeholder="Contoh: Semangat belajarnya ya, jangan lupa istirahat!"></textarea>
            <div style="display:flex; gap:10px; justify-content:center;">
                <button class="auth-btn" style="width:auto; background:#475569; border-color:#64748b;" onclick="closeCustomPrompt()">BATAL</button>
                <button id="send-msg-btn" class="auth-btn" style="width:auto;" onclick="submitTeacherMessage()">KIRIM PESAN</button>
            </div>
        </div>
    </div>

    <!-- NEW: WARNET MINIGAME MODAL (Freelance) -->
    <div id="warnet-modal" class="minigame-overlay">
        <div class="journal-box" style="width: 90%; max-width: 500px; text-align: center;">
            <h3 style="color: var(--accent); font-family: 'Cinzel'; margin-bottom: 10px;"> FREELANCE PROJECT</h3>
            <div id="warnet-task-desc" style="color: #cbd5e1; font-size: 14px; margin-bottom: 15px;">
                Tulis kode program berikut untuk menyelesaikan proyek!
            </div>
            
            <div id="warnet-code-display" style="
                background: #0f172a; 
                padding: 15px; 
                border: 1px dashed #38bdf8; 
                color: #38bdf8; 
                font-family: monospace; 
                font-size: 18px; 
                margin-bottom: 20px;
                border-radius: 6px;
            ">LOADING...</div>

            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                <button id="btn-code-a" class="auth-btn" onclick="checkWarnetAnswer(0)">Opsi A</button>
                <button id="btn-code-b" class="auth-btn" onclick="checkWarnetAnswer(1)">Opsi B</button>
            </div>
            
            <button onclick="closeWarnetGame()" style="margin-top: 15px; background: transparent; color: #ef4444; border: none;">BATAL KERJA</button>
        </div>
    </div>
    <!-- NEW: RACING MINIGAME OVERLAY (RETRO STYLE) -->
    <div id="racing-minigame" class="minigame-overlay" style="background: radial-gradient(circle, #2d3748, #000);">
        <h2 style="color: #fbbf24; font-family: 'Cinzel'; margin: 10px 0; text-shadow: 0 0 10px black;">BALAP LIAR RETRO</h2>
        
        <!-- TRACK JALANAN (BERGERAK) -->
        <div id="race-track" style="position:relative; width: 300px; height: 400px; background: #333; border: 4px solid #000; border-radius: 4px; overflow: hidden; box-shadow: 0 0 20px rgba(0,0,0,0.5);">
            
            <!-- GARIS JALAN (Asphalt Texture) -->
            <div id="road-lines" class="road-moving" style="position:absolute; top:0; left:0; width:100%; height:100%; 
                background-image: 
                    linear-gradient(90deg, transparent 49%, #fff 49%, #fff 51%, transparent 51%), 
                    linear-gradient(90deg, #10b981 10%, #333 10%, #333 90%, #10b981 90%);
                background-size: 100% 40px, 100% 100%;">
            </div>
            
            <!-- DEKORASI PINGGIR (PANORAMA BERGERAK) -->
            <div id="scenery-left" style="position:absolute; top:0; left:0; width:30px; height:100%; overflow:hidden;"></div>
            <div id="scenery-right" style="position:absolute; top:0; right:0; width:30px; height:100%; overflow:hidden;"></div>

            <!-- ZONA SENTUH KIRI & KANAN (LANGSUNG DI LAYAR) -->
            <!-- Zona Kiri (50% Lebar) -->
            <div style="position:absolute; top:0; left:0; width:50%; height:100%; z-index:20; cursor:pointer;" 
                 ontouchstart="event.preventDefault(); event.stopPropagation(); if(raceState.active) moveCar(-1); else initRace();" 
                 onmousedown="event.stopPropagation(); if(raceState.active) moveCar(-1); else initRace();">
            </div>

            <!-- Zona Kanan (50% Lebar) -->
            <div style="position:absolute; top:0; right:0; width:50%; height:100%; z-index:20; cursor:pointer;" 
                 ontouchstart="event.preventDefault(); event.stopPropagation(); if(raceState.active) moveCar(1); else initRace();" 
                 onmousedown="event.stopPropagation(); if(raceState.active) moveCar(1); else initRace();">
            </div>

            <!-- UPDATE: Ukuran Mobil Player Disamakan dengan NPC (40x40) -->
            <div id="player-car" style="position:absolute; bottom: 20px; left: 130px; transition: left 0.1s; pointer-events: none; z-index: 5; width: 40px; height: 40px; display: flex; justify-content: center; align-items: center;">
                <!-- FIX: Menyimpan parentElement ke variabel 'p' sebelum memanipulasi DOM agar tidak error null reference -->
                <img src="images/player-race.png" style="width: 100%; height: 100%; object-fit: contain;" onerror="var p=this.parentElement; this.style.display='none'; p.innerText=''; p.style.fontSize='30px'; p.style.transform='rotate(-90deg)'">
            </div>
            <div id="score-race" style="position:absolute; top: 10px; right: 10px; color: #fbbf24; font-weight: 900; font-family: monospace; font-size: 20px; text-shadow: 2px 2px 0 #000; pointer-events: none; z-index: 5;">SKOR: 0</div>
            
            <!-- PERBAIKAN POSISI TEKS: Menggunakan left:0 dan width:100% agar pasti di tengah -->
            <div id="start-msg-race" style="position:absolute; top:50%; left:0; width:100%; transform:translateY(-50%); text-align:center; color:#fbbf24; font-weight:900; font-size:18px; font-family:'Exo 2'; text-shadow: 2px 2px 4px #000; animation: pulse 1s infinite; pointer-events: none; z-index: 25;">
                TAP LAYAR / TOMBOL <br>UNTUK MULAI BALAPAN!
            </div>
        </div>
        
        <div style="display:flex; gap:40px; margin-top:15px;">
            <button class="race-btn" ontouchstart="event.stopPropagation(); moveCar(-1)" onmousedown="event.stopPropagation(); moveCar(-1)"></button>
            <button class="race-btn" ontouchstart="event.stopPropagation(); moveCar(1)" onmousedown="event.stopPropagation(); moveCar(1)"></button>
        </div>
        
        <button onclick="quitRacing()" style="margin-top:10px; background:transparent; border:1px solid #ef4444; color:#ef4444; padding: 5px 15px; border-radius: 4px; font-size: 12px; cursor: pointer; position: relative; z-index: 30;">BATAL MAIN</button>
    </div>

   <!-- DUEL MINIGAME OVERLAY (BARU) -->
    <div id="duel-minigame">
        <div class="duel-arena">
            <div class="duel-header"> ARENA DUEL </div>
            
            <div class="duel-characters">
                <!-- Sisi Player -->
                <div class="duel-char">
                    <img id="duel-p-img" src="images/boy.png" class="duel-avatar">
                    <div class="duel-hp-container">
                        <div id="duel-p-hp" class="duel-hp-bar"></div>
                    </div>
                    <span style="font-size:12px; margin-top:5px; font-weight:bold; color:#4ade80;">KAMU</span>
                </div>
                
                <div class="duel-vs">VS</div>
                
                <!-- Sisi Rival -->
                <div class="duel-char">
                    <img id="duel-r-img" src="images/rival_boy.png" class="duel-avatar">
                    <div class="duel-hp-container">
                        <div id="duel-r-hp" class="duel-hp-bar"></div>
                    </div>
                    <span id="duel-r-name" style="font-size:12px; margin-top:5px; font-weight:bold; color:#ef4444;">RIVAL</span>
                </div>
            </div>

            <div id="duel-status" class="duel-status-text">
                Siapkan strategimu!<br>Pilih: Batu, Gunting, atau Kertas.
            </div>

            <div class="duel-controls">
                <button class="duel-btn" onclick="handleDuelMove('batu')" title="Batu"></button>
                <button class="duel-btn" onclick="handleDuelMove('kertas')" title="Kertas"></button>
                <button class="duel-btn" onclick="handleDuelMove('gunting')" title="Gunting"></button>
            </div>
            
            <button class="main-menu-btn" onclick="quitDuel()" style="margin-top:20px; font-size:12px; border-color:#64748b; color:#94a3b8; background:transparent;"> MENYERAH</button>
        </div>
    </div>
	
  
    <div id="game-container">
    <canvas id="gameCanvas"></canvas>
    
    <!-- NEW: DAMAGE OVERLAY ELEMENT -->
    <div id="damage-overlay"></div>

    <!-- 1. SPLASH SCREEN -->
    <div id="splash-screen">
        <!-- NEW: LOGO INSTANSI HEADER -->
        <div class="splash-logos">
            <!-- Logo Kiri (TKJ) - Dengan Fallback Placeholder -->
            <img src="images/loganailul.png" alt="Nailul Authar" class="logo-side" 
                 onerror="this.onerror=null; this.src='data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI3MCIgaGVpZ2h0PSI3MCIgdmlld0JveD0iMCAwIDcwIDcwIj48Y2lyY2xlIGN4PSIzNSIgY3k9IjM1IiByPSIzMCIgZmlsbD0iIzA2YjZkNCIgb3BhY2l0eT0iMC4yIiBzdHJva2U9IiMwNmI2ZDQiIHN0cm9rZS13aWR0aD0iMiIvPjx0ZXh0IHg9IjM1IiB5PSI0MCIgZm9udC1mYW1pbHk9InNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTQiIHRleHQtYW5jaG9yPSJtaWRkbGUiIGZpbGw9IiMwNmI2ZDQiPlRLSjwvdGV4dD48L3N2Zz4='">
            
            <!-- Logo Tengah (Nailul) - Dengan Fallback Placeholder -->
            <img src="images/logosmk.png" alt="SMK Negeri 1 Brondong" class="logo-main" 
                 onerror="this.onerror=null; this.src='data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxMDAiIGhlaWdodD0iMTAwIiB2aWV3Qm94PSIwIDAgMTAwIDEwMCI+PGNpcmNsZSBjeD0iNTAiIGN5PSI1MCIgcj0iNDUiIGZpbGw9IiNmYmJmMjQiIG9wYWNpdHk9IjAuMiIgc3Ryb2tlPSIjZmJiZjI0IiBzdHJva2Utd2lkdGg9IjMiLz48dGV4dCB4PSI1MCIgeT0iNTUiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjE2IiB0ZXh0LWFuY2hvcj0ibWlkZGxlIiBmaWxsPSIjZmJiZjI0Ij5OQUlMVUw8L3RleHQ+PC9zdmc+'">
            
            <!-- Logo Kanan (TKJ) - Dengan Fallback Placeholder -->
            <img src="images/logotkj.png" alt="Jurusan Teknik komputer dan Jaringan" class="logo-side" 
                 onerror="this.onerror=null; this.src='data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI3MCIgaGVpZ2h0PSI3MCIgdmlld0JveD0iMCAwIDcwIDcwIj48Y2lyY2xlIGN4PSIzNSIgY3k9IjM1IiByPSIzMCIgZmlsbD0iIzA2YjZkNCIgb3BhY2l0eT0iMC4yIiBzdHJva2U9IiMwNmI2ZDQiIHN0cm9rZS13aWR0aD0iMiIvPjx0ZXh0IHg9IjM1IiB5PSI0MCIgZm9udC1mYW1pbHk9InNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTQiIHRleHQtYW5jaG9yPSJtaWRkbGUiIGZpbGw9IiMwNmI2ZDQiPlRLSjwvdGV4dD48L3N2Zz4='">
        </div>

        <!-- UPDATE: JUDUL GAME DI SPLASH SCREEN (MENGGANTIKAN POWERED BY GEMINI) -->
        <!-- FIX: TAMBAHKAN ANIMASI PADA KELAS H1 -->
        <h1 style="font-size: 38px; text-align: center; line-height: 1.2; font-family: 'Cinzel'; margin-top:0; color: var(--secondary); text-shadow: 0 0 20px var(--secondary); letter-spacing: 2px; animation: splashTitleAnim 3s infinite ease-in-out;">
            NUSANTARA ARSA<br>
            <span style="font-size: 14px; color: #cbd5e1; letter-spacing: 5px; text-shadow: none; font-weight: normal;">RISE OF STUDENT</span>
        </h1>
        
        <!-- NEW: LOADING BAR HTML -->
        <div id="loading-container">
            <div id="loading-bar"></div>
        </div>
        <!-- UPDATE: Teks lebih informatif agar pemain tahu ini bukan download ulang -->
        <div id="loading-text">MENYIAPKAN DATA... 0%</div>
        
        <!-- NEW: TOMBOL MULAI (MUNCUL SETELAH LOADING) -->
        <!-- FIX: Tambahkan pointer-events:auto dan z-index tinggi agar bisa diklik di mobile -->
        <div id="splash-start-btn" style="display:none; margin-top:20px; cursor:pointer; font-family:'Cinzel'; font-size:16px; color:var(--accent); border: 2px solid var(--accent); padding: 10px 30px; border-radius: 30px; animation: pulse 1s infinite; background: rgba(0,0,0,0.5); backdrop-filter: blur(4px); pointer-events: auto; z-index: 305;">
             KETUK UNTUK MEMULAI
        </div>

        <!-- NEW: COPYRIGHT FOOTER -->
        <div style="font-size: 10px; color: #64748b; margin-top: 20px; font-family: 'Exo 2'; opacity: 0.7; letter-spacing: 1px;">
            &copy; 2026 . NAILUL AUTHAR - TKJ SMK NEGERI 1 BRONDONG
        </div>
    </div>

    <!-- NEW: LEADERBOARD OVERLAY (PUBLIC) -->
    <div id="leaderboard-overlay">
        <div class="lb-card">
            <!-- FIX: Perbesar area sentuh tombol X dengan padding 15px dan z-index tinggi -->
            <div style="position:absolute; top:0; right:0; cursor:pointer; font-size:24px; padding:15px; color:#ef4444; z-index:50;" onclick="closeLeaderboard()"></div>
            
            <h2 style="font-family:'Cinzel'; color:var(--secondary); margin-bottom:5px; text-shadow:0 0 10px var(--secondary); margin-top:10px;">HALL OF FAME</h2>
            <p style="font-size:10px; color:#94a3b8; margin-bottom:20px;">Top Petualang Nusantara Arsa</p>
            
            <div id="lb-list">
                <!-- Diisi JS -->
                <div style="padding:20px;">Memuat Data...</div>
            </div>

            <!-- FIX: Tambahkan Tombol Tutup Besar di Bawah untuk kemudahan akses di HP -->
            <button class="main-menu-btn" onclick="closeLeaderboard()" style="width:100%; min-width:unset; margin-top:20px; padding:12px; font-size:14px; border-color:#ef4444; color:#ef4444;">TUTUP LEADERBOARD</button>
        </div>
    </div>
	
	<!-- NEW: ABOUT SCREEN OVERLAY -->
    <div id="about-screen" class="minigame-overlay" style="display:none; z-index: 2500;">
        <div class="journal-box" style="text-align:center; max-width: 400px; max-height: 90vh; overflow-y: auto;">
            <h2 style="font-family:'Cinzel'; color:var(--secondary); margin-bottom:15px; text-shadow:0 0 10px var(--secondary); font-size: 22px;">TENTANG PENGEMBANG</h2>
            
            <!-- AVATAR BERNAPAS -->
            <div style="display: flex; justify-content: center;">
                <img src="images/nailul.png" class="about-avatar" alt="Avatar Nailul" onerror="this.src='data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxMDAiIGhlaWdodD0iMTAwIiB2aWV3Qm94PSIwIDAgMTAwIDEwMCI+PGNpcmNsZSBjeD0iNTAiIGN5PSI1MCIgcj0iNDUiIGZpbGw9IiMxZTNhOGEiIHN0cm9rZT0iI2ZiYmYyNCIgc3Ryb2tlLXdpZHRoPSIzIi8+PHBhdGggZD0iTTMwIDgwIFE1MCA1MCA3MCA4MCIgZmlsbD0iI2ZmZiIvPjxjaXJjbGUgY3g9IjM1IiBjeT0iNDUiIHI9IjUiIGZpbGw9IiNmZmYiLz48Y2lyY2xlIGN4PSI2NSIgY3k9IjQ1IiByPSI1IiBmaWxsPSIjZmZmIi8+PC9zdmc+'">
            </div>

            <p style="font-size:13px; color:#e2e8f0; line-height:1.6; margin-bottom: 20px; text-align: justify; padding: 0 10px;">
                <strong>Game Nusantara Arsa</strong> adalah simulasi kehidupan anak yang dirancang untuk mempersiapkan masa depanmu.
                <br><br>
                Pilihlah satu dari **4 Role Kehidupan** (Pekerja, Mahasiswa, Wirausaha, atau Menikah) dan hadapi tantangan dunia nyata dalam format permainan RPG yang seru. Belajar mengambil keputusan, mengelola aset, dan bersosialisasi sebelum terjun ke masyarakat yang sesungguhnya.
            </p>
            
            <div style="margin: 15px 0; border-top: 1px dashed #475569; padding-top: 15px; font-size: 12px; color: #94a3b8; background: rgba(0,0,0,0.2); padding: 10px; border-radius: 6px;">
                <strong>Dikembangkan Oleh:</strong><br>
                <span style="color: var(--secondary); font-size: 14px; font-weight: bold;">NAILUL AUTHAR, S.Kom.</span><br>
                Guru TKJ - SMK Negeri 1 Brondong<br><br>
                 <span style="color: var(--accent);">nailulauthar2302@gmail.com</span>
            </div>
            
            <button class="main-menu-btn" onclick="document.getElementById('about-screen').style.display='none'" style="width:100%; font-size:14px; padding:10px; min-width: unset;">TUTUP</button>
        </div>
    </div>

    <!-- NEW: AUDIO PROMPT -->
    <div id="audio-prompt">
        <h1 style="color: var(--secondary); margin-bottom: 20px; text-shadow: 0 0 10px var(--secondary); font-size: 24px;"> AUDIO SETTING</h1>
        <p style="color: #94a3b8; max-width: 400px; margin-bottom: 30px; line-height: 1.5; font-size: 14px;">Nyalakan musik latar dan efek suara untuk pengalaman bermain yang lebih baik?</p>
        
        <!-- UPDATE: Flex wrap ditambahkan agar tombol turun ke bawah jika layar sempit -->
        <!-- UPDATE: Min-width tombol diperkecil dari 280px ke 120px agar muat bersebelahan -->
        <div style="display: flex; gap: 15px; flex-wrap: wrap; justify-content: center; width: 100%;">
            <button class="main-menu-btn" onclick="handleAudioChoice(true)" style="width: auto; min-width: 120px; padding: 12px 25px; font-size: 14px;">YA (ON)</button>
            <button class="main-menu-btn" onclick="handleAudioChoice(false)" style="width: auto; min-width: 120px; padding: 12px 25px; border-color: #64748b; color: #64748b; font-size: 14px;">TIDAK (OFF)</button>
        </div>
    </div>

    <!-- 2. TITLE SCREEN -->
    <div id="title-screen" class="hidden">
        
        <!-- NEW: ANIMATED BIRDS -->
        <div class="bird-container bird-container--one">
            <div class="bird-img" style="animation-duration: 1s;"></div>
        </div>
        <div class="bird-container bird-container--two">
            <div class="bird-img" style="animation-duration: 0.9s;"></div>
        </div>
        <div class="bird-container bird-container--three">
            <div class="bird-img" style="animation-duration: 1.25s;"></div>
        </div>
        <div class="bird-container bird-container--four">
            <div class="bird-img" style="animation-duration: 1.1s;"></div>
        </div>

        <h1>NUSANTARA ARSA</h1>
        <h2>- Menjadi Manusia -</h2>
        <div style="z-index: 10; display:flex; flex-direction:column; align-items:center;">
            <button class="main-menu-btn" onclick="goToLogin()">MULAI BERTUALANG</button>
            <button class="main-menu-btn" onclick="showLeaderboard()">RANKING</button>
             <!-- UPDATE: GANTI TOMBOL FULLSCREEN MENJADI ABOUT -->
            <button class="main-menu-btn" onclick="document.getElementById('about-screen').style.display='flex'">TENTANG GIM</button>
        </div>
        <p style="position: absolute; bottom: 20px; font-size: 12px; color: #94a3b8; font-family: 'Exo 2'; z-index: 10;">Ver 4.4 - Fullscreen Mobile Support</p>
    </div>
    
    <!-- 3. LOGIN SCREEN -->
    <div id="login-screen">
        <!-- UPDATE: JUDUL BARU DENGAN ANIMASI & STYLE -->
        <h1 class="login-title">GERBANG NUSANTARA ARSA</h1>
        
        <div class="login-card">
            <div class="login-tabs">
                <button class="tab-btn active" id="tab-siswa" onclick="switchRole('siswa')">SISWA</button>
                <button class="tab-btn" id="tab-guru" onclick="switchRole('guru')">GURU</button>
                <!-- NEW: TAB ADMIN -->
                <button class="tab-btn" id="tab-admin" onclick="switchRole('admin')">ADMIN</button>
            </div>
            
            <div id="auth-header" style="margin-bottom:15px; font-weight:bold; color:#fff; font-size: 16px; letter-spacing: 1px;">LOGIN ACCOUNT</div>
            <!-- UPDATE: AREA PESAN ERROR/SUKSES (MENGGANTIKAN ALERT) -->
            <div id="login-msg" style="color: #ef4444; font-size: 12px; margin-bottom: 10px; text-align: center; min-height: 15px;"></div>

            <!-- FORM SISWA -->
            <form id="form-siswa" onsubmit="event.preventDefault(); handleAuth('siswa', this.querySelector('.auth-btn'))">
                <div id="register-fields-siswa" style="display:none;">
                    <input type="text" id="siswa-nama" class="form-input" placeholder="Nama Lengkap" autocomplete="name" name="nama">
                    <input type="text" id="siswa-kelas" class="form-input" placeholder="Kelas (Contoh: XII TKJ 1)" name="kelas">
                    <select id="siswa-guru" class="form-input" name="guru">
                        <option value="">Pilih Guru Pendamping...</option>
                    </select>
                </div>
                <input type="email" id="siswa-email" class="form-input" placeholder="Email Siswa" autocomplete="username" name="email">
                <div class="form-input-group">
                    <input type="password" id="siswa-pass" class="form-input" placeholder="Password" autocomplete="current-password" name="password">
                    <span class="password-toggle" id="toggle-siswa" onclick="togglePassword('siswa-pass', 'toggle-siswa')"></span>
                </div>
                <button type="submit" class="auth-btn">MENDARAT DI PULAU ARSA</button>
            </form>

            <!-- FORM GURU -->
            <form id="form-guru" style="display:none;" onsubmit="event.preventDefault(); handleAuth('guru', this.querySelector('.auth-btn'))">
                 <div id="register-fields-guru" style="display:none;">
                    <input type="text" id="guru-nama" class="form-input" placeholder="Nama Guru" autocomplete="name" name="nama">
                    <input type="text" id="guru-nip" class="form-input" placeholder="NIP" name="nip">
                    <input type="text" id="guru-sekolah" class="form-input" placeholder="Asal Sekolah" name="sekolah">
                </div>
                <input type="email" id="guru-email" class="form-input" placeholder="Email Guru" autocomplete="username" name="email">
                <div class="form-input-group">
                    <input type="password" id="guru-pass" class="form-input" placeholder="Password" autocomplete="current-password" name="password">
                    <span class="password-toggle" id="toggle-guru" onclick="togglePassword('guru-pass', 'toggle-guru')"></span>
                </div>
                <button type="submit" class="auth-btn">ACCESS DASHBOARD</button>
            </form>

            <!-- NEW: FORM ADMIN -->
            <form id="form-admin" style="display:none;" onsubmit="event.preventDefault(); handleAuth('admin', this.querySelector('.auth-btn'))">
                <div style="background:rgba(220, 38, 38, 0.1); border:1px solid #dc2626; padding:10px; margin-bottom:10px; font-size:11px; color:#fca5a5; border-radius:4px;">
                     Area Terbatas. Hanya untuk Administrator Sistem.
                </div>
                <input type="text" id="admin-user" class="form-input" placeholder="Username Admin">
                <div class="form-input-group">
                    <input type="password" id="admin-pass" class="form-input" placeholder="Password Admin">
                    <span class="password-toggle" id="toggle-admin" onclick="togglePassword('admin-pass', 'toggle-admin')"></span>
                </div>
                <button type="submit" class="auth-btn" style="background: linear-gradient(90deg, #dc2626, #b91c1c); box-shadow: 0 0 15px rgba(220, 38, 38, 0.4);">LOGIN SYSTEM</button>
            </form>

            <div class="auth-switch" onclick="toggleAuthMode()">Buat Akun Baru</div>
            
            <div style="margin-top: 20px; text-align: center;">
                <button style="background: transparent; border: none; font-size: 12px; color: #64748b; cursor: pointer;" onclick="goToTitle()"> BACK TO MENU</button>
            </div>
        </div>
    </div>

    <!-- 4. DASHBOARD GURU -->
    <div id="teacher-dashboard">
        <div class="dash-container">
            <div class="dash-sidebar">
                <div class="dash-title">
                    <span id="dash-main-title">PUSAT DATA</span>
                    <!-- NEW: Indikator Status Koneksi -->
                    <div id="dash-connection-status" style="font-size: 9px; margin-top: 5px; padding: 4px; border: 1px solid #334155; border-radius: 4px; color: #94a3b8; font-family: 'Exo 2'; cursor: pointer;" onclick="toggleDashboardSource()">
                        Periksa Koneksi...
                    </div>
                </div>
                <ul class="dash-nav">
                    <li onclick="showDashPage('monitoring')" class="active"> Live Monitoring</li>
                    <li onclick="showDashPage('accounts')"> Database Akun</li>
                    <li onclick="showDashPage('ranking')"> Class Ranking</li>
                    <li onclick="showDashPage('grading')"> Grading System</li>
                    <li onclick="showDashPage('reflections')"> Student Journals</li>
                    <li onclick="showDashPage('validation')"> Competency</li>
                    <li onclick="showDashPage('reset')" style="color: #f87171;"> Reset Data</li>
                    
                    <!-- NEW: TOMBOL FORCE SYNC -->
                    <li onclick="refreshDashboardData()" id="dash-refresh-btn" style="color: #38bdf8; border-top: 1px solid rgba(255,255,255,0.1); margin-top: 10px;">
                         Force Sync / Refresh
                    </li>
                    
                    <li onclick="logout()" style="color: #ef4444; margin-top: auto;"> Logout System</li>
                </ul>
            </div>
            <div class="dash-content">
                <!-- MONITORING -->
                <div id="page-monitoring" class="dash-page">
                    <h2 style="color:#0f172a; margin-top:0;"> Real-time Player Tracking</h2>
                    <div class="dash-card">
                        <p style="font-size:12px; color:#64748b;">Pantau aktivitas dan lokasi siswa secara langsung.</p>
                        <table class="dash-table">
                            <thead>
                                <tr>
                                    <th>Siswa & Email</th> <!-- UPDATED -->
                                    <th>Last Save</th> <!-- NEW COLUMN -->
                                    <th>Status & Role</th> <!-- MERGED -->
                                    <th>Lokasi (Map)</th>
                                    <th>HP/Energy</th>
                                    <th>Aksi</th>
                                </tr>
                            </thead>
                            <tbody id="monitoring-body"></tbody>
                        </table>
                    </div>
                </div>

                <!-- NEW: DATABASE AKUN PAGE -->
                <div id="page-accounts" class="dash-page hidden">
                    <h2 style="color:#0f172a; margin-top:0;"> Database Akun Terdaftar</h2>
                    <div class="dash-card">
                        <p style="font-size:12px; color:#64748b; margin-bottom:15px;">
                            Daftar lengkap seluruh siswa yang telah melakukan registrasi akun (Login).
                        </p>
                        <table class="dash-table">
                            <thead>
                                <tr>
                                    <th style="width: 40px;">No</th>
                                    <th>Nama Lengkap</th>
                                    <th>Email (ID Login)</th>
                                    <th>Kelas / Detail</th>
                                    <th>Mentor</th>
                                    <th>Status Data</th>
                                </tr>
                            </thead>
                            <tbody id="accounts-body"></tbody>
                        </table>
                    </div>
                </div>

                <!-- GRADING -->
                <div id="page-grading" class="dash-page hidden">
                    <h2 style="color:#0f172a; margin-top:0;"> Automated Grading</h2>
                    <button class="auth-btn" style="width:auto; padding:8px 20px; margin-bottom: 20px;" onclick="exportToCSV()"> Export CSV Data</button>
                    <div class="dash-card">
                        <table class="dash-table">
                            <thead>
                                <tr>
                                    <th>Nama</th>
                                    <th>Path (Role)</th>
                                    <th>Jurnal</th>
                                    <th>Gold</th>
                                    <th>Score</th>
                                    <th>Rank</th>
                                </tr>
                            </thead>
                            <tbody id="grading-body"></tbody>
                        </table>
                    </div>
                </div>

                <!-- NEW: RANKING PAGE (PODIUM) -->
                <div id="page-ranking" class="dash-page hidden">
                    <h2 style="color:#0f172a; margin-top:0;"> Student Leaderboard</h2>
                    
                    <!-- Podium Section -->
                    <div id="ranking-podium" class="podium-container">
                        <!-- Diisi JS -->
                    </div>

                    <!-- Full List Table -->
                    <div class="dash-card">
                        <h4 style="margin:0 0 15px 0; color:#64748b;">Full Standing</h4>
                        <table class="dash-table">
                            <thead>
                                <tr>
                                    <th style="width:50px;">Rank</th>
                                    <th>Siswa</th>
                                    <th>Role</th>
                                    <th>Level</th>
                                    <th style="text-align:right;">Total Score</th>
                                </tr>
                            </thead>
                            <tbody id="ranking-body"></tbody>
                        </table>
                    </div>
                </div>

                <!-- REFLECTIONS -->
                <div id="page-reflections" class="dash-page hidden">
                    <h2 style="color:#0f172a; margin-top:0;"> Reflection Logs</h2>
                    <div id="reflections-container"></div>
                </div>

                <!-- VALIDATION -->
                <div id="page-validation" class="dash-page hidden">
                    <h2 style="color:#0f172a; margin-top:0;"> Competency Analytics</h2>
                    
                    <!-- KD Reference Card -->
                    <div class="dash-card" style="margin-bottom: 20px; border-left: 4px solid var(--accent); background: #f8fafc;">
                        <h4 style="margin:0 0 10px 0; color:var(--primary);">Indikator Penilaian Kompetensi (KD)</h4>
                        <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap:15px; font-size:12px; color:#475569;">
                            <div>
                                <strong style="color:#0f172a;">1. Decision Making</strong><br>
                                Kemampuan mengambil keputusan peran hidup dan konsistensi menjalankannya.
                            </div>
                            <div>
                                <strong style="color:#0f172a;">2. Financial Literacy</strong><br>
                                Kemampuan mengelola aset (Gold), menabung, dan mengembangkan modal.
                            </div>
                            <div>
                                <strong style="color:#0f172a;">3. Professional Skill</strong><br>
                                Pengembangan atribut spesifik (STR/INT/BIZ/REP) sesuai jalur karir.
                            </div>
                        </div>
                    </div>

                    <!-- Student Competency Table -->
                    <div class="dash-card">
                        <table class="dash-table">
                            <thead>
                                <tr>
                                    <th>Siswa</th>
                                    <th>Decision (Role)</th>
                                    <th>Finansial (Asset)</th>
                                    <th>Skill Development</th>
                                    <th>Total Skor</th>
                                </tr>
                            </thead>
                            <tbody id="validation-body">
                                <!-- Diisi oleh JavaScript -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- NEW: HALAMAN RESET DATA SISWA -->
                <div id="page-reset" class="dash-page hidden">
                    <h2 style="color:#ef4444; margin-top:0;"> Admin Zone: Reset Data</h2>
                    <div class="dash-card" style="border-left: 4px solid #ef4444;">
                        <p style="font-size:12px; color:#64748b;">
                            <strong>PERINGATAN:</strong> Tindakan ini akan menghapus seluruh progress permainan (Level, Uang, Role) siswa dan mengembalikannya ke awal (Prologue). 
                            <br>Gunakan fitur ini hanya jika siswa mengalami stuck/bug atau perlu mengulang skenario.
                        </p>
                        <table class="dash-table">
                            <thead>
                                <tr>
                                    <th>Nama Siswa</th>
                                    <th>Kelas</th>
                                    <th>Role Saat Ini</th>
                                    <th>Progress</th>
                                    <th>Aksi Berbahaya</th>
                                </tr>
                            </thead>
                            <tbody id="reset-body"></tbody>
                        </table>
                    </div>
                </div>

            </div>
        </div>
    </div>

    <!-- 5. PROLOGUE SCREEN -->
    <div id="prologue-screen">
        <div id="prologue-text"></div>
        <button id="skip-prologue-btn" onclick="skipPrologue()">SKIP >></button>
    </div>

    <!-- 6. GENDER SELECTION SCREEN -->
    <div id="gender-screen">
        <h2 style="font-family: 'Cinzel'; font-size: 28px; margin-bottom: 30px; color: var(--secondary); text-shadow: 0 0 10px var(--secondary);">CHOOSE YOUR AVATAR</h2>
        <div class="gender-options">
            <div class="gender-card" onclick="selectGender('boy')">
                <img src="images/boy.png" alt="Laki-laki" onerror="this.src='data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI1MCIgaGVpZ2h0PSI1MCI+PGNpcmNsZSBjeD0iMjUiIGN5PSIyNSIgcj0iMjAiIGZpbGw9IiMzYjgyZjYiLz48L3N2Zz4='">
                <div class="gender-title">MALE STUDENT</div>
            </div>
            <div class="gender-card" onclick="selectGender('girl')">
                <img src="images/girl.png" alt="Perempuan" onerror="this.src='data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI1MCIgaGVpZ2h0PSI1MCI+PGNpcmNsZSBjeD0iMjUiIGN5PSIyNSIgcj0iMjAiIGZpbGw9IiNlYzlhOWEiLz48L3N2Zz4='">
                <div class="gender-title">FEMALE STUDENT</div>
            </div>
        </div>
    </div>

    <!-- 7. START SCREEN (TUTORIAL) -->
    <div id="start-screen" class="hidden">
        <h1>NUSANTARA ARSA</h1>
        <p>Selamat datang, <span id="welcome-name" style="color:var(--secondary); font-weight:bold;">Siswa</span>!</p>
        <p>Kelas: <span id="welcome-class" style="color:#94a3b8">Umum</span></p>
        <p style="font-size: 12px; color: var(--accent); margin-top:5px;" id="welcome-mentor"></p>
        <button onclick="initGame()">ENTER THE WORLD</button>
        <button onclick="logout()" style="margin-top:15px; background:transparent; border-color: #ef4444; color: #ef4444;">LOGOUT</button>
    </div>

    <!-- GAME OVER / REFLECTION SCREEN -->
    <div id="game-over-screen">
        <h1>MASA TRIAL BERAKHIR</h1>
        <p style="color:#94a3b8; font-size:12px; margin-top:-10px;">Perjalananmu telah mencapai batas waktu.</p>
        
        <div id="reflection-text">
            <!-- Teks akan diisi oleh JS sesuai Role -->
            Memuat refleksi karir...
        </div>

        <div id="motivation-text">
            <!-- Teks mutiara acak -->
            "Hidup adalah tentang belajar dari kesalahan."
        </div>

        <div style="display:flex; gap:20px; justify-content:center; flex-wrap:wrap;">
            <button class="main-menu-btn" onclick="restartGame()" style="width:auto; padding:15px 30px; font-size:14px;"> MULAI DARI AWAL</button>
            <button class="main-menu-btn" onclick="returnToTitle()" style="width:auto; padding:15px 30px; border-color:#94a3b8; color:#94a3b8; font-size:14px;"> JEDA UNTUK BERPIKIR</button>
        </div>
        <p style="font-size:10px; color:#ef4444; margin-top:20px;">*Perhatian: Save data akan di-reset untuk memulai lembaran baru.</p>
    </div>

    <!-- NEW: CUTSCENE OVERLAY (FIX STUCK SETELAH NIKAH) -->
    <div id="cutscene-layer" style="display:none; opacity:0; position:absolute; top:0; left:0; width:100%; height:100%; background:#000; z-index:2000; flex-direction:column; justify-content:center; align-items:center; text-align:center; transition: opacity 2s; pointer-events:none;">
        <h1 id="cutscene-text" style="font-family:'Cinzel'; color:#fbbf24; font-size:32px; margin-bottom:20px; text-shadow:0 0 20px #b45309;">JUDUL CUTSCENE</h1>
        <p id="cutscene-sub" style="font-family:'Exo 2'; color:#cbd5e1; font-size:16px; max-width:600px; line-height:1.6; padding:0 20px;">Deskripsi cutscene...</p>
    </div>

    <!-- NEW: ENDING SUCCESS SCREEN -->
    <div id="ending-screen">
        <div id="ending-narration">
            Engkau telah belajar berharap di Pulau Arsa. Kini, saatnya hidup sesungguhnya dimulai.
        </div>

        <div class="certificate-box" id="cert-box" style="display:none;">
            <div class="cert-title">SERTIFIKAT KELULUSAN</div>
            <div style="font-size:12px; margin-top:5px;">DIBERIKAN KEPADA</div>
            <div class="cert-name" id="cert-name">Nama Pemain</div>
            <div class="cert-body">
                Telah berhasil menyelesaikan Simulasi Kehidupan Nusantara Arsa selama 5 Tahun.<br>
                Dengan predikat: <strong id="cert-rank" style="color:#b45309">MANUSIA SEUTUHNYA</strong><br><br>
                <div style="display:flex; justify-content:space-around; font-weight:bold;">
                    <div>Jalur: <span id="cert-role" style="color:var(--primary)">-</span></div>
                    <div>Reputasi: <span id="cert-rep">-</span></div>
                    <div>Aset: <span id="cert-asset">-</span></div>
                </div>
            </div>
            <div class="cert-seal">LULUS<br>TRIAL</div>
        </div>

        <div id="ending-options" style="display:none; gap:20px;">
            <button class="main-menu-btn" onclick="continueFreeRoam()" style="width:auto;"> FREE ROAM (HIDUP DI PULAU ARSA)</button>
            <button class="main-menu-btn" onclick="finishGame()" style="border-color:#10b981; color:#10b981; width:auto;"> MENUJU PULAU JIVANA (SELESAI)</button>
        </div>
    </div>

    <!-- MINIGAME OVERLAYS -->
    <div id="job-app-game" class="minigame-overlay">
        <h2 style="color:var(--secondary); font-family:'Cinzel'"> TES LAMARAN KERJA</h2>
        <p style="color:#cbd5e1; max-width:500px; text-align:center;">Susun kata-kata berikut menjadi kalimat lamaran yang sopan dan profesional!</p>
        <div id="job-app-result-area"></div>
        <div id="job-app-words" class="word-container"></div>
        <button class="main-menu-btn" onclick="checkJobApp()">KIRIM LAMARAN</button>
        <button onclick="closeMinigame()" style="margin-top:10px; background:transparent; border:none; color:#ef4444;">BATAL</button>
    </div>

    <!-- NEW: INSPECT DATA POPUP -->
    <div id="inspect-modal" class="minigame-overlay">
        <div class="journal-box" style="width: 90%; max-width: 600px; max-height: 80vh; background: #0f172a; border: 1px solid var(--accent);">
            <h3 style="color: var(--accent); margin-top:0;"> INSPECT RAW DATA</h3>
            <div id="inspect-content" style="flex:1; overflow-y:auto; background:rgba(0,0,0,0.3); padding:10px; font-family:monospace; font-size:10px; color:#cbd5e1; white-space:pre-wrap;"></div>
            <button class="main-menu-btn" onclick="document.getElementById('inspect-modal').style.display='none'" style="margin-top:15px; width:100%;">TUTUP</button>
        </div>
    </div>

    <!-- NEW: TUTORIAL POINTER ELEMENT -->
    <div id="tutorial-pointer">
        <!-- NEW: Label Teks Dinamis -->
        <div id="pointer-label" class="pointer-label">Jalan Kesini</div>
        <div class="hand-icon"></div>
    </div>
    <!-- NEW: INVENTORY SCREEN OVERLAY -->
    <div id="inventory-screen" style="display: none;">
        <h2 style="font-family:'Cinzel'; color:var(--secondary); margin-bottom:10px; text-shadow:0 0 10px var(--secondary);"> TAS PENYIMPANAN</h2>
        
        <!-- NEW: STATUS BAR DI DALAM INVENTORY (Agar pemain tahu efek makan) -->
        <div id="inv-status-bar" style="display:flex; justify-content:center; gap:15px; margin-bottom:15px; width:100%;">
            <!-- UPDATE: Padding diperbesar (8px 16px) & Flex align center agar rapi -->
            <div style="background:#1e293b; padding:8px 16px; border-radius:20px; color:#f87171; font-size:12px; border:1px solid #ef4444; font-family:'Exo 2'; font-weight:bold; display:flex; align-items:center; gap:5px;">
                <span></span> <span>HP: <span id="inv-hp-val">100</span></span>
            </div>
            <div style="background:#1e293b; padding:8px 16px; border-radius:20px; color:#facc15; font-size:12px; border:1px solid #eab308; font-family:'Exo 2'; font-weight:bold; display:flex; align-items:center; gap:5px;">
                <span></span> <span>Energi: <span id="inv-energy-val">100</span></span>
            </div>
        </div>

        <div id="inventory-grid" class="inv-grid">
            <!-- Item akan dirender di sini oleh JS -->
        </div>
        <div style="margin-top:20px; text-align:center;">
            <p style="color:#94a3b8; font-size:10px; margin-bottom:10px;">Klik item yang memiliki label (Pakai) untuk menggunakannya.</p>
            <button onclick="toggleInventory()" class="main-menu-btn" style="width:auto; padding:10px 30px;">TUTUP TAS</button>
        </div>
    </div>
	
    <!-- NEW: WORKER MINIGAME OVERLAY (SORTING) -->
    <div id="work-minigame">
        <div class="work-card">
            <h2 style="color:white; margin:0; font-size:16px;">SORTIR BARANG!</h2>
            <p style="color:#94a3b8; font-size:10px; margin-bottom:10px;">Masukkan barang ke rak yang benar.</p>
            
            <div class="work-score">Skor: <span id="work-score-val">0</span></div>
            <div class="work-timer"><div id="work-timer-bar" class="work-timer-fill"></div></div>

            <div id="work-target-icon" class="work-item-display"></div>
            <div id="work-target-name" style="font-weight:bold; color:white; margin-bottom:10px;">Item</div>

            <div class="work-bins">
                <button class="bin-btn bin-food" onclick="handleWorkSort('food')">
                    <span></span>MAKANAN
                </button>
                <button class="bin-btn bin-tool" onclick="handleWorkSort('tool')">
                    <span></span>PERKAKAS
                </button>
                <button class="bin-btn bin-luxury" onclick="handleWorkSort('luxury')">
                    <span></span>MEWAH
                </button>
            </div>
            
            <button onclick="quitWorkMinigame()" style="margin-top:15px; background:transparent; border:none; color:#ef4444; font-size:10px;">BATAL KERJA</button>
        </div>
    </div>

    <!-- NEW: MESSAGE ARCHIVE MODAL (ARSIP PESAN) -->
    <div id="message-archive-modal" class="minigame-overlay">
        <div class="journal-box" style="width: 90%; max-width: 500px; max-height: 80vh;">
            <h2 style="color:var(--secondary); font-family:'Cinzel'; text-align:center; margin-bottom:10px; border-bottom:1px solid rgba(255,255,255,0.1); padding-bottom:10px;"> ARSIP PESAN GURU</h2>
            <div id="message-list" style="flex:1; overflow-y:auto; background:rgba(15, 23, 42, 0.6); padding:10px; border-radius:4px; margin-bottom:10px; border:1px solid #334155;">
                <!-- List pesan akan dimuat di sini -->
            </div>
            <button class="main-menu-btn" onclick="closeMessageArchive()" style="width:100%; padding:10px; font-size:14px;">TUTUP ARSIP</button>
        </div>
    </div>

    <!-- NEW: DAILY QUEST POPUP (WITH TABS) -->
    <div id="daily-quest-popup" class="minigame-overlay">
        <div class="journal-box" style="text-align:center; border-color:var(--secondary); width: 380px; padding: 15px; max-height: 85vh;">
            <h2 id="quest-day-title" style="font-family:'Cinzel'; color:var(--secondary); margin-bottom:2px; text-shadow:0 0 10px var(--secondary); font-size: 20px;">JURNAL QUEST</h2>
            <div style="font-size:11px; color:#94a3b8; margin-bottom:10px;" id="quest-season-subtitle">Musim Semi - Tahun 1</div>
            
            <!-- TAB NAVIGATION -->
            <div class="quest-tabs">
                <button class="quest-tab-btn active" onclick="switchQuestTab('daily')" id="tab-daily">HARIAN</button>
                <button class="quest-tab-btn" onclick="switchQuestTab('weekly')" id="tab-weekly">MINGGU</button>
                <button class="quest-tab-btn" onclick="switchQuestTab('monthly')" id="tab-monthly">BULAN</button>
                <button class="quest-tab-btn" onclick="switchQuestTab('life')" id="tab-life">TARGET</button>
            </div>

            <!-- CONTENT AREA -->
            <div id="quest-list-content" style="background:rgba(15, 23, 42, 0.5); padding:10px; border-radius:8px; border:1px dashed #475569; margin-bottom:15px; text-align:left; flex:1; overflow-y: auto; scrollbar-width: thin; font-size:12px; line-height:1.6; color:#e2e8f0;">
                <!-- Konten akan diisi JS -->
            </div>

            <!-- BUTTON CLOSE (FIXED) -->
            <button class="main-menu-btn" onclick="closeDailyQuest()" style="width:100%; font-size:14px; padding:12px; cursor:pointer; position:relative; z-index:100;">TUTUP JURNAL</button>
        </div>
    </div>

    <!-- NEW: CALENDAR MODAL (GRID STYLE) -->
    <div id="calendar-modal" class="minigame-overlay">
        <div class="journal-box" style="width: 420px; max-width: 95%; padding: 20px; max-height: 90vh;">
            <!-- Header Navigasi -->
            <div class="cal-header">
                <button class="quest-tab-btn" style="width:40px; font-size:18px;" onclick="changeCalendarMonth(-1)"></button>
                <div style="text-align:center;">
                    <div class="cal-title-text" id="cal-season-text">SPRING</div>
                    <div style="font-size:12px; color:#94a3b8;" id="cal-year-text">Tahun ke-1</div>
                </div>
                <button class="quest-tab-btn" style="width:40px; font-size:18px;" onclick="changeCalendarMonth(1)"></button>
            </div>

            <!-- Grid Hari -->
            <div class="cal-grid" id="cal-grid-container">
                <!-- Header Hari -->
                <div class="cal-day-header">SEN</div>
                <div class="cal-day-header">SEL</div>
                <div class="cal-day-header">RAB</div>
                <div class="cal-day-header">KAM</div>
                <div class="cal-day-header">JUM</div>
                <div class="cal-day-header">SAB</div>
                <div class="cal-day-header" style="color:#ef4444">MIN</div>
                
                <!-- Cells generated by JS -->
            </div>

            <!-- Info Detail Event -->
            <div id="cal-event-detail" style="margin-top:15px; min-height:50px; background:rgba(0,0,0,0.3); border-radius:6px; padding:10px; border-left: 3px solid var(--secondary); display:flex; align-items:center; gap:10px;">
                <div style="font-size:24px;"></div>
                <div>
                    <div style="font-weight:bold; color:white; font-size:12px;" id="cal-detail-date">Pilih Tanggal</div>
                    <div style="font-size:11px; color:#cbd5e1;" id="cal-detail-desc">Klik tanggal untuk melihat info festival atau ulang tahun.</div>
                </div>
            </div>

            <button class="main-menu-btn" onclick="closeCalendar()" style="width:100%; margin-top:15px; padding:10px;">TUTUP KALENDER</button>
        </div>
    </div>

    <!-- UI LAYER (GAME) -->
    <div id="ui-layer" class="hidden">
        
        <!-- NEW: VIRTUAL JOYSTICK (FLOATING) -->
        <div id="virtual-joystick-base">
            <div id="virtual-joystick-stick"></div>
        </div>

        <!-- REDESIGNED HUD (3 COLUMNS) -->
        <div class="hud-top" id="main-hud"> <!-- Added ID -->
            <!-- 1. LEFT: PROFILE & BARS -->
            <!-- UPDATE: Menambahkan ID 'hud-profile-box' untuk tutorial -->
            <div class="hud-profile-section" id="hud-profile-box">
                <div class="hud-avatar-wrapper">
                    <div class="hud-avatar-circle">
                        <img id="hud-avatar-img" src="images/boy.png" alt="Avatar" onerror="this.src='data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI1MCIgaGVpZ2h0PSI1MCI+PGNpcmNsZSBjeD0iMjUiIGN5PSIyNSIgcj0iMjAiIGZpbGw9IiMzYjgyZjYiLz48L3N2Zz4='">
                    </div>
                    <!-- Role Icon Indicator -->
                    <div class="hud-role-icon" id="hud-role-icon" title="Role Aktif">?</div>
                </div>
                <div class="hud-info-bars">
                    <div class="hud-level-text">LV <span id="level-display">1</span> - <span id="hud-name">Player</span></div>
                    
                    <!-- NEW: HP Bar di HUD Utama -->
                    <div class="bar-container" title="Health Point">
                        <div class="bar-fill hp-fill" id="hud-hp-bar" style="width: 100%;"></div>
                        <div class="bar-text"> <span id="hud-hp-text">100</span></div>
                    </div>

                    <!-- EXP Bar -->
                    <div class="bar-container" title="Experience Point">
                        <div class="bar-fill exp-fill" id="exp-bar" style="width: 0%;"></div>
                        <div class="bar-text">EXP</div>
                    </div>
                    
                    <!-- Energy Bar (Always Visible - Stamina Logic) -->
                    <div class="bar-container" title="Energy / Stamina">
                        <div class="bar-fill energy-fill" id="energy-bar" style="width: 100%;"></div>
                        <div class="bar-text"> <span id="energy-text">100</span></div>
                    </div>
                </div>
            </div>

            <!-- 2. CENTER: CORE STATS MATRIX -->
            <!-- UPDATE: Tambahkan ID 'hud-stats-box' untuk tutorial -->
            <div class="hud-stats-grid" id="hud-stats-box">
                <div class="stat-pill ic-str" title="Strength (Jalur Pekerja)">
                    <span> STR</span> <span class="stat-val" id="stat-str">5</span>
                </div>
                <div class="stat-pill ic-int" title="Intelligence (Jalur Mahasiswa)">
                    <span> INT</span> <span class="stat-val" id="stat-int">5</span>
                </div>
                <div class="stat-pill ic-rep" title="Reputation (Jalur Keluarga)">
                    <span> REP</span> <span class="stat-val" id="stat-rep">0</span>
                </div>
                <div class="stat-pill ic-biz" title="Business Skill (Jalur Wirausaha)">
                    <span> BIZ</span> <span class="stat-val" id="stat-biz">0</span>
                </div>
            </div>

            <!-- 3. RIGHT: META INFO (Time/Money) -->
            <div class="hud-meta-section">
                <div class="money-badge"> <span id="money-display">50.000</span></div>
                
                <!-- UPDATE: Menambahkan ID 'hud-time-container' untuk target tutorial -->
                <div id="hud-time-container" class="stat-item time-container" onclick="this.querySelector('.time-info-box').style.display = (this.querySelector('.time-info-box').style.display == 'block' ? 'none' : 'block')" style="border:none; background:rgba(15, 23, 42, 0.6); display:flex; flex-direction:column; align-items:flex-end; font-size:10px; cursor: help; padding: 5px 10px; border-radius: 8px;">
                    <div class="time-clock"> <span id="clock-display">06:00</span></div>
                    <div style="color:#cbd5e1;"> <span id="full-date-display">Spring Y1</span></div>
                    <div id="weather-display" style="color:#94a3b8; font-size:9px;">Cerah</div>
                    <!-- FIX: Ubah teks default dari '30 Hari' menjadi 'Loading...' atau angka yang benar -->
                    <div style="font-size: 9px; color: var(--danger); margin-top: 2px;"> Trial: <span id="trial-display">3 Tahun</span></div>
                    
                    <!-- HOVER INFO BOX -->
                    <div class="time-info-box">
                        <strong style="color:var(--secondary)"> INFO WAKTU</strong><br>
                        1 Jam = 60 Detik<br>
                        <hr style="border-color:rgba(255,255,255,0.1)">
                         <strong style="color:#ef4444">PERINGATAN STAMINA</strong><br>
                        - Energi 0 = Pingsan (Denda)<br>
                        - Energi < 20% saat tidur = Bangun Kesiangan
                    </div>
                </div>

                <!-- NEW: TOMBOL MANUAL SYNC (Agar status Online di dashboard terupdate) -->
                <div id="sync-btn" onclick="forceSync()" style="margin-top:5px; cursor:pointer; font-size:9px; color:#94a3b8; background:rgba(15, 23, 42, 0.8); padding:4px 8px; border-radius:12px; border:1px solid #334155; display:flex; align-items:center; gap:4px; transition:0.2s; box-shadow: 0 2px 5px rgba(0,0,0,0.3);">
                    <span id="sync-icon"></span> <span id="sync-text">Sync Data</span>
                </div>
            </div>
        </div>

        <!-- NEW: HUD TOGGLE BUTTON -->
        <div id="hud-toggle-btn" onclick="toggleHUD()" title="Sembunyikan Stats"></div>

        <!-- 4. FLOATING COMBAT HUD (HP BAR ONLY IN DUNGEON) -->
        <!-- UPDATE: ELEMENT INI DIHAPUS KARENA SUDAH ADA DI HUD ATAS -->
        <!-- <div id="combat-hud"> ... </div> -->

        <div id="toast">Notifikasi</div>

        <!-- Notification Area for Teacher Messages (DIHAPUS/DISEMBUNYIKAN) -->
        <div id="msg-alert" style="display:none;"></div>

        <!-- NEW: MINIMAP OVERLAY -->
        <div id="minimap-container">
            <canvas id="minimapCanvas" width="120" height="90"></canvas>
            <div id="minimap-label">MAP</div>
        </div>

        <div id="controls">
            <!-- JOYSTICK DIHAPUS DARI DOM (CSS display:none sudah handle, tapi biar bersih di HTML juga) -->
            <div class="d-pad" id="joystick" style="display:none;"></div> 
            
            <div class="action-btns">
                <!-- NEW: TOMBOL SKILL (ULTIMATE) -->
                <div id="btn-skill" title="Ultimate Skill (10 Stamina)"></div>

                <!-- NEW: TOMBOL SPRINT (LARI) -->
                <div id="btn-sprint" title="Tahan untuk Lari"></div>

                <!-- NEW: TOMBOL QUEST -->
                <div id="quest-btn" onclick="toggleDailyQuest()" title="Lihat Quest Harian"></div>

                <!-- NEW: TOMBOL TAS INVENTORI -->
                <div id="bag-btn" onclick="toggleInventory()" style="background-image: url('images/tas-kosong.png');" title="Buka Tas Inventori"></div>
                
                <!-- Action Button: Hidden by default, shown via JS when interactive -->
                <div class="round-btn" id="btn-action" style="display: none;"></div>
            </div>
        </div>
    </div>

    <!-- Journal Modal (Student) -->
    <div id="journal-modal">
        <div class="journal-box">
            <h3 style="font-family: 'Cinzel'; font-size: 18px; color: var(--secondary); margin-top:0;">JURNAL REFLEKSI</h3>
            <!-- UPDATE: Menambahkan ID pada paragraf pertanyaan agar bisa diubah secara dinamis -->
            <p id="journal-question" style="font-size: 14px; color: #94a3b8; font-style: italic; margin-bottom: 15px; line-height: 1.4;">
                Bagaimana harimu di dunia Nusantara Arsa?
            </p>
            <textarea id="journal-input" placeholder="Tulis refleksimu disini..."></textarea>
            <div style="text-align: right; display: flex; justify-content: flex-end; gap: 10px;">
                <button onclick="closeJournal()" style="background: transparent; border: 1px solid #475569; width: auto;">BATAL</button>
                <button onclick="saveJournal()" style="background: var(--primary); width: auto;">SIMPAN</button>
            </div>
        </div>
    </div>

    <!-- RESTRUCTURED DIALOGUE HTML -->
    <div id="dialogue-wrapper">
        <img id="dialogue-portrait" src="" alt="NPC Avatar">
        <div id="dialogue-box">
            <div id="dialogue-title">Nama NPC</div>
            <div id="dialogue-text">Teks dialog disini...</div>
            <div class="btn-group" id="dialogue-options"></div>
        </div>
    </div>
</div>

    <script>
/** * FIREBASE CONFIGURATION */
const firebaseConfig = {
  apiKey: "AIzaSyAdqApOvuUXrZUO19NfiqZCLSyUYR74w5M",
  authDomain: "waliq-ded98.firebaseapp.com",
  projectId: "waliq-ded98",
  storageBucket: "waliq-ded98.firebasestorage.app",
  messagingSenderId: "915222555864",
  appId: "1:915222555864:web:25320841c97661172e3bad",
  measurementId: "G-K51RW0YQ0M"
};

let db;
let analytics;

/** * APP FLOW LOGIC */
const SESSION_KEY = 'sc_session_email';

// --- GLOBAL LOOP CONTROLLERS (FIX: Mencegah Loop Ganda via Window Object) ---
// UPDATE: Menggunakan window.variable agar persist saat script reload
if (window.gameLoopId === undefined) window.gameLoopId = null;
if (window.saveIntervalId === undefined) window.saveIntervalId = null;

// --- ASSET LOADER (UPDATED FOR NEW BG & TREES) ---
// REMOVED: tileset.png loader (deprecated)

const treeAssets = {
    // shadow: new Image(), // SHADOW DIHAPUS (Tidak diload)
    trunk: new Image(),
    canopy: new Image(),
    sakuraTrunk: new Image(),
    sakuraCanopy: new Image()
};

// Fallback Base64 (Jika file gambar tidak ditemukan)
const treeFallbacks = {
    trunk: 'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIzMiIgaGVpZ2h0PSIzMiI+PHJlY3QgeD0iMTIiIHk9IjQiIHdpZHRoPSI4IiBoZWlnaHQ9IjI4IiBmaWxsPSIjNWQ0MDM3Ii8+PC9zdmc+',
    canopy: 'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI2NCIgaGVpZ2h0PSI2NCI+PGNpcmNsZSBjeD0iMzIiIGN5PSIzMiIgcj0iMjgiIGZpbGw9IiMxNmEzNGEiIHN0cm9rZT0iIzE0NTMyZCIgc3Ryb2tlLXdpZHRoPSIyIi8+PC9zdmc+',
    sakuraTrunk: 'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIzMiIgaGVpZ2h0PSIzMiI+PHJlY3QgeD0iMTIiIHk9IjQiIHdpZHRoPSI4IiBoZWlnaHQ9IjI4IiBmaWxsPSIjNWQ0MDM3Ii8+PC9zdmc+', 
    sakuraCanopy: 'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI2NCIgaGVpZ2h0PSI2NCI+PGNpcmNsZSBjeD0iMzIiIGN5PSIzMiIgcj0iMjgiIGZpbGw9IiZmNDcyYjYiIHN0cm9rZT0iI2RiMjc3NyIgc3Ryb2tlLXdpZHRoPSIyIi8+PC9zdmc+' 
};

// NEW: ASSET TAS (Load gambar tas)
const bagAssets = {
    empty: new Image(),
    full: new Image()
};
// Set src
bagAssets.empty.src = 'images/tas-kosong.png';
bagAssets.full.src = 'images/tas-isi.png';
// Fallback visual tas jika gambar tidak ada
const bagFallback = 'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI2NCIgaGVpZ2h0PSI2NCI+PHBhdGggZD0iTTIwIDIwIEw0NCAyMCBMNTQgNTAgTDEwIDUwIFoiIGZpbGw9IiM3ODM1MGYiIHN0cm9rZT0iI2ZmZiIgc3Ryb2tlLXdpZHRoPSIyIi8+PHBhdGggZD0iTTI2IDIwIEwyNiAxMCBZMzggMTAgTDM4IDIwIiBzdHJva2U9IiNmZmYiIGZpbGw9Im5vbmUiIHN0cm9rZS13aWR0aD0iMyIvPjwvc3ZnPg==';

bagAssets.empty.onerror = function() { this.src = bagFallback; };
bagAssets.full.onerror = function() { this.src = bagFallback; }; // Bisa dibedakan warnanya nanti jika mau

// Load Images (Trunk & Canopy Only)
['trunk', 'canopy', 'sakuraTrunk', 'sakuraCanopy'].forEach(key => {
    treeAssets[key].onerror = function() {
        this.onerror = null; // Anti-loop fix
        console.warn(`Gagal memuat aset pohon ${key}, menggunakan fallback.`);
        this.src = treeFallbacks[key];
    };
    
    // Set src asli
    if(key === 'trunk') treeAssets[key].src = 'images/pohon-trunk.png';
    if(key === 'canopy') treeAssets[key].src = 'images/pohon-kanopi.png';
    if(key === 'sakuraTrunk') treeAssets[key].src = 'images/batang-sakura.png';
    if(key === 'sakuraCanopy') treeAssets[key].src = 'images/pohon-sakura.png';
});

// --- NEW: GRASS & PLANT ASSETS ---
const grassAssets = {
    grass1: new Image(),
    grass2: new Image(),
    flower: new Image()
};

// Fallback untuk rumput/bunga (Hijau dan Merah Muda)
const grassFallbacks = {
    grass1: 'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIzMiIgaGVpZ2h0PSIzMiI+PHJlY3Qgd2lkdGg9IjMyIiBoZWlnaHQ9IjMyIiBmaWxsPSIjMWU0MDVmIi8+PHBhdGggZD0iTTEwIDIwIEwxNSAxMCBMMjAgMjAiIGZpbGw9IiMxNTgwM2QiLz48L3N2Zz4=', 
    grass2: 'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIzMiIgaGVpZ2h0PSIzMiI+PHJlY3Qgd2lkdGg9IjMyIiBoZWlnaHQ9IjMyIiBmaWxsPSIjMWU0MDVmIi8+PHBhdGggZD0iTTUgMjUgTDEwIDE1IEwxNSAyNSBNMjAgMjUgTDI1IDE1IEwzMCAyNSIgZmlsbD0iIzE1ODAzZCIvPjwvc3ZnPg==',
    flower: 'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIzMiIgaGVpZ2h0PSIzMiI+PGNpcmNsZSBjeD0iMTYiIGN5PSIzMCIgcj0iMiIgZmlsbD0iIzE1ODAzZCIvPjxjaXJjbGUgY3g9IjE2IiBjeT0iMjQiIHI9IjQiIGZpbGw9IiNmNDcyYjYiLz48Y2lyY2xlIGN4PSIxNiIgY3k9IjI0IiByPSIyIiBmaWxsPSIjZmZjMTA3Ii8+PC9zdmc+'
};

['grass1', 'grass2', 'flower'].forEach(key => {
    // ANTI-LOOP FIX
    grassAssets[key].onerror = function() {
        this.onerror = null; // CRITICAL FIX: Hentikan loop error
        this.src = grassFallbacks[key];
    };
    if(key === 'grass1') grassAssets[key].src = 'images/rumput.png';
    if(key === 'grass2') grassAssets[key].src = 'images/rumput2.png';
    if(key === 'flower') grassAssets[key].src = 'images/bunga.png';
});

// --- NEW: MISC ASSETS (SALJU) ---
const miscAssets = {
    snowman: new Image()
};
miscAssets.snowman.src = 'images/snowman.png';

// Fallback SVG (Gambar Boneka Salju Sederhana)
miscAssets.snowman.onerror = function() {
    this.onerror = null;
    // Gambar SVG: Dua bola putih + Hidung Oren + Mata Hitam
    this.src = 'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIzMiIgaGVpZ2h0PSI2NCI+PGNpcmNsZSBjeD0iMTYiIGN5PSI0OCIgcj0iMTQiIGZpbGw9IiNmMmYyZjIiIHN0cm9rZT0iI2RiZTYWZSIgc3Ryb2tlLXdpZHRoPSIyIi8+PGNpcmNsZSBjeD0iMTYiIGN5PSIyNCIgcj0iMTAiIGZpbGw9IiNmZmYiIHN0cm9rZT0iI2RiZTYWZSIgc3Ryb2tlLXdpZHRoPSIyIi8+PGNpcmNsZSBjeD0iMTMiIGN5PSIyMiIgcj0iMSIgZmlsbD0iIzAwMCIvPjxjaXJjbGUgY3g9IjE5IiBjeT0iMjIiIHI9IjEiIGZpbGw9IiMwMDAiLz48cGF0aCBkPSJNMTY 2NCBMMyA3NiBMNiA2NCIgZmlsbD0iI2Y5NzMwNiIvPjxjaXJjbGUgY3g9IjE2IiBjeT0iMzYiIHI9IjIiIGZpbGw9IiMzMzMiLz48Y2lyY2xlIGN4PSIxNiIgY3k9IjQ0IiByPSIyIiBmaWxsPSIjMzMzIi8+PC9zdmc+';
};

// --- NEW: FARM ASSETS (LAHAN PERTANIAN) ---
const farmAssets = {
    lahanLiar: new Image()
};
farmAssets.lahanLiar.src = 'images/lahan-liar.png';
// Fallback visual tanah kotor (SVG Pattern) jika gambar gagal load
farmAssets.lahanLiar.onerror = function() {
    this.onerror = null;
    this.src = 'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIzMiIgaGVpZ2h0PSIzMiI+PHJlY3Qgd2lkdGg9IjMyIiBoZWlnaHQ9IjMyIiBmaWxsPSIjOGI0NTEzIi8+PHBhdGggZD0iTTUgNSBMMjUgMjUgTTEwIDI1IEwyMCA1IiBzdHJva2U9IiM1ZDQwMzciIHN0cm9rZS13aWR0aD0iMiIgb3BhY2l0eT0iMC41Ii8+PC9zdmc+';
};

// --- NEW: CANDI ASSETS (LANTAI KHUSUS) ---
const candiAssets = {
    floor: new Image(),
    redFloor: new Image() // NEW: Lantai Merah Candi
};
candiAssets.floor.src = 'images/lantaicandi.png';
candiAssets.redFloor.src = 'images/lantaimerahcandi.png';

// Fallback visual jika gambar gagal load (Warna Batu Tua)
candiAssets.floor.onerror = function() {
    this.onerror = null;
    this.src = 'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIzMiIgaGVpZ2h0PSIzMiI+PHJlY3Qgd2lkdGg9IjMyIiBoZWlnaHQ9IjMyIiBmaWxsPSIjNDQ0MDNjIi8+PHJlY3QgeD0iMiIgeT0iMiIgd2lkdGg9IjI4IiBoZWlnaHQ9IjI4IiBmaWxsPSJub25lIiBzdHJva2U9IiM1NzUzNGUiIHN0cm9rZS13aWR0aD0iMiIvPjwvc3ZnPg==';
};
// NEW: Fallback visual lantai merah
candiAssets.redFloor.onerror = function() {
    this.onerror = null;
    this.src = 'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIzMiIgaGVpZ2h0PSIzMiI+PHJlY3Qgd2lkdGg9IjMyIiBoZWlnaHQ9IjMyIiBmaWxsPSIjOTkxYjFiIi8+PHBhdGggZD0iTTAgMCBMMzIgMzIgTTE2IDAgTDMyIDE2IE0wIDEwIEwyMiAzMiIgc3Ryb2tlPSIjN2YxZDFkIiBzdHJva2Utd2lkdGg9IjIiIG9wYWNpdHk9IjAuNSIvPjwvc3ZnPg==';
};

// --- NEW: RUINS ASSETS (LANTAI & TEMBOK RERUNTUHAN) ---
const ruinsAssets = {
    floor: new Image(),
    wall: new Image() // NEW: Aset Tembok
};
ruinsAssets.floor.src = 'images/lantai-reruntuhan.png';
ruinsAssets.wall.src = 'images/tembok-reruntuhan.png'; // NEW: Set Source Tembok

// Fallback visual batu pecah/kuno jika gambar gagal load
ruinsAssets.floor.onerror = function() {
    this.onerror = null;
    this.src = 'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIzMiIgaGVpZ2h0PSIzMiI+PHJlY3Qgd2lkdGg9IjMyIiBoZWlnaHQ9IjMyIiBmaWxsPSIjN2M3YzdmIi8+PHBhdGggZD0iTTAgMCBMMzIgMzIgTTE2IDAgTDMyIDE2IE0wIDEwIEwyMiAzMiIgc3Ryb2tlPSIjNTA1MDU1IiBzdHJva2Utd2lkdGg9IjIiIG9wYWNpdHk9IjAuNSIvPjwvc3ZnPg==';
};
// NEW: Fallback visual tembok reruntuhan
ruinsAssets.wall.onerror = function() {
    this.onerror = null;
    this.src = 'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIzMiIgaGVpZ2h0PSIzMiI+PHJlY3Qgd2lkdGg9IjMyIiBoZWlnaHQ9IjMyIiBmaWxsPSIjNDQ0MDNjIi8+PHJlY3QgeD0iNCIgeT0iNCIgd2lkdGg9IjEwIiBoZWlnaHQ9IjEwIiBmaWxsPSIjN2M3YzdmIi8+PHJlY3QgeD0iMTgiIHk9IjE4IiB3aWR0aD0iMTAiIGhlaWdodD0iMTAiIGZpbGw9IiM3YzdjN2YiLz48cGF0aCBkPSJNMCAzMiBMMzIgMCIgc3Ryb2tlPSIjMDAwIiBzdHJva2Utd2lkdGg9IjIiIG9wYWNpdHk9IjAuMyIvPjwvc3ZnPg==';
};

// NEW: LOAD SEASONAL BACKGROUNDS
const bgSeasons = {
    spring: new Image(),
    summer: new Image(),
    autumn: new Image(),
    winter: new Image()
};

// Set Sources
bgSeasons.spring.src = 'images/bg-pulau.png';
bgSeasons.summer.src = 'images/bg-pulau-panas.png';
bgSeasons.autumn.src = 'images/bg-pulau-gugur.png';
bgSeasons.winter.src = 'images/bg-pulau-salju.png';

// NEW: LOAD HOUSE INTERIORS (LEVEL 1-5)
const houseBgAssets = {
    level1: new Image(),
    level2: new Image(),
    level3: new Image(),
    level4: new Image(),
    level5: new Image()
};
houseBgAssets.level1.src = 'images/rumahindoor_level1.png';
houseBgAssets.level2.src = 'images/rumahindoor_level2.png';
houseBgAssets.level3.src = 'images/rumahindoor_level3.png';
houseBgAssets.level4.src = 'images/rumahindoor_level4.png';
houseBgAssets.level5.src = 'images/rumahindoor_level5.png';

// NEW: DUNGEON & MONSTER ASSETS (PREPARATION)
const dungeonAssets = {
    wall: new Image(),
    floor: new Image(),
    rock: new Image(),
    // UPDATE: Asset Monster Berjenjang
    enemy1: new Image(),
    enemy2: new Image(),
    enemy3: new Image(),
    enemy4: new Image(),
    enemy5: new Image(), // NEW: Monster Level 5
    thief: new Image(),  // NEW: Monster Pencuri Skripsi
    boss: new Image()
};
dungeonAssets.wall.src = 'images/dungeon_wall.png';   // Ukuran 30x30
dungeonAssets.floor.src = 'images/dungeon_floor.png'; // Ukuran 30x30
dungeonAssets.rock.src = 'images/batudidungeon.png';  // Set gambar batu khusus

// Load Monster Images
dungeonAssets.enemy1.src = 'images/monster.png';
dungeonAssets.enemy2.src = 'images/monster-lvl2.png';
dungeonAssets.enemy3.src = 'images/monster-lvl3.png';
dungeonAssets.enemy4.src = 'images/monster-lvl4.png';
dungeonAssets.enemy5.src = 'images/monster-lvl5.png'; 
dungeonAssets.thief.src = 'images/monster-thief.png'; // Monster Skripsi
dungeonAssets.boss.src = 'images/monster-boss.png';

// NEW: WALL ASSETS (Custom Walls)
const wallAssets = {
    school: new Image(),
    schoolFloor: new Image(), // NEW: Aset Lantai Kampus
    libraryFloor: new Image(), // NEW: Aset Lantai Perpus
    libraryWall: new Image(),   // NEW: Aset Tembok Perpus
    guildFloor: new Image(),    // NEW: Aset Lantai Guild
    guildWall: new Image(),      // NEW: Aset Tembok Guild
    houseWall: new Image(),       // NEW: Aset Tembok Rumah Player
    houseWallBottom: new Image(),  // NEW: Aset Tembok Bawah Rumah Player
    blacksmithWall: new Image()   // NEW: Aset Tembok Blacksmith
};
wallAssets.school.src = 'images/tiletembokkampus.png';
wallAssets.schoolFloor.src = 'images/tilelantaikampus.png';
wallAssets.libraryFloor.src = 'images/tilelantaiperpus.png';
wallAssets.libraryWall.src = 'images/tiletembokperpus.png';
wallAssets.guildFloor.src = 'images/tilelantaiguild.png';
wallAssets.guildWall.src = 'images/tiletembokguild.png';
wallAssets.houseWall.src = 'images/tiletembokrumahplayer.png';
wallAssets.houseWallBottom.src = 'images/titletembokbawahplayer.png'; 
wallAssets.blacksmithWall.src = 'images/tiletembokblacksmith.png'; // Set Source Baru

// --- NEW: CLINIC ASSETS (LANTAI KLINIK) ---
const clinicAssets = {
    floor: new Image()
};
clinicAssets.floor.src = 'images/lantaiklinik.png';
// Fallback visual lantai putih bersih jika gambar gagal load
clinicAssets.floor.onerror = function() {
    this.onerror = null;
    this.src = 'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIzMiIgaGVpZ2h0PSIzMiI+PHJlY3Qgd2lkdGg9IjMyIiBoZWlnaHQ9IjMyIiBmaWxsPSIjZjFmNWY5Ii8+PHJlY3QgeD0iMCIgeT0iMCIgd2lkdGg9IjMyIiBoZWlnaHQ9IjMyIiBmaWxsPSJub25lIiBzdHJva2U9IiNlMmU4ZjAiIHN0cm9rZS13aWR0aD0iMSIvPjwvc3ZnPg=='; 
};

// --- NEW: MENTOR ASSETS (LANTAI RUMAH MENTOR) ---
const mentorAssets = {
    floor: new Image()
};
mentorAssets.floor.src = 'images/lantaimentor.png';
// Fallback visual lantai kayu klasik/elegan jika gambar gagal load
mentorAssets.floor.onerror = function() {
    this.onerror = null;
    this.src = 'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIzMiIgaGVpZ2h0PSIzMiI+PHJlY3Qgd2lkdGg9IjMyIiBoZWlnaHQ9IjMyIiBmaWxsPSIjNmM0YTNmIi8+PHJlY3QgeD0iMCIgeT0iMCIgd2lkdGg9IjMyIiBoZWlnaHQ9IjMyIiBmaWxsPSJub25lIiBzdHJva2U9IiM1ZDQwMzciIHN0cm9rZS13aWR0aD0iMSIvPjwvc3ZnPg==';
};

let bgLoadedCount = 0;
const onBgLoad = () => {
    bgLoadedCount++;
    console.log(`Background loaded: ${bgLoadedCount}/4`);
};

// Attach listeners
Object.values(bgSeasons).forEach(img => {
    img.onload = onBgLoad;
    img.onerror = () => console.error("Gagal memuat background musiman");
});

// --- AUDIO SYSTEM (UPDATED: SEASONAL MUSIC) ---
const AudioService = {
    enabled: false,
    tracks: {
        opening: new Audio('audio/opening.mp3'),
        village: new Audio('audio/audiopulau.mp3'), // Musik Default
        sea: new Audio('audio/laut.mp3'), 
        rain: new Audio('audio/hujan.mp3'),
        bird: new Audio('audio/burung.mp3'),
        night: new Audio('audio/malam.mp3'),
        
        // --- NEW: MUSIK MUSIMAN ---
        spring: new Audio('audio/spring.mp3'),   // Musim Semi
        summer: new Audio('audio/summer.mp3'),   // Musim Panas
        autumn: new Audio('audio/fall.mp3'),     // Musim Gugur (Fall)
        winter: new Audio('audio/winter.mp3'),   // Musim Dingin

        // Audio Hewan & SFX
        kambing: new Audio('audio/kambing.mp3'),
        sapi: new Audio('audio/sapi.mp3'),
        ayam: new Audio('audio/ayam.mp3'),
        kuda: new Audio('audio/kuda.mp3'),
        door: new Audio('audio/door.mp3'),
        hit: new Audio('audio/pukul.mp3'),
        item: new Audio('audio/item.mp3'),
        bg: new Audio('audio/bg.mp3'),
        chat: new Audio('audio/chat.mp3'),
        inside: new Audio('audio/inside.mp3'),
        dungeon: new Audio('audio/dungeon.mp3'),
        boss: new Audio('audio/boss.mp3'),
        knock: new Audio('audio/knock.mp3'),
        wedding: new Audio('audio/wedding.mp3')
    },
    currentTrack: null,
	currentAmbience: null, // NEW: Track Ambience (Suara Latar)

    init: function() {
        try {
            // Set Looping untuk Musik Latar
            if(this.tracks.opening) this.tracks.opening.loop = true;
            if(this.tracks.village) this.tracks.village.loop = true;
            if(this.tracks.night) this.tracks.night.loop = true;
            if(this.tracks.sea) this.tracks.sea.loop = true;
            if(this.tracks.rain) this.tracks.rain.loop = true;
            if(this.tracks.inside) this.tracks.inside.loop = true; 
            if(this.tracks.dungeon) this.tracks.dungeon.loop = true; 
            if(this.tracks.boss) this.tracks.boss.loop = true;
            if(this.tracks.wedding) this.tracks.wedding.loop = true;

            // --- NEW: SETTING MUSIK MUSIM ---
            if(this.tracks.spring) this.tracks.spring.loop = true;
            if(this.tracks.summer) this.tracks.summer.loop = true;
            if(this.tracks.autumn) this.tracks.autumn.loop = true;
            if(this.tracks.winter) this.tracks.winter.loop = true;
            
            // Set Volume Default
            if(this.tracks.opening) this.tracks.opening.volume = 0.5;
            if(this.tracks.village) this.tracks.village.volume = 0.5;
            // Ambience Volume (Agak kecil agar tidak menutupi musik)
            if(this.tracks.night) this.tracks.night.volume = 0.6; 
            if(this.tracks.sea) this.tracks.sea.volume = 0.0; 
            if(this.tracks.rain) this.tracks.rain.volume = 0.4;
            if(this.tracks.bird) this.tracks.bird.volume = 0.3;

            // --- NEW: VOLUME MUSIK MUSIM ---
            if(this.tracks.spring) this.tracks.spring.volume = 0.5;
            if(this.tracks.summer) this.tracks.summer.volume = 0.5;
            if(this.tracks.autumn) this.tracks.autumn.volume = 0.5;
            if(this.tracks.winter) this.tracks.winter.volume = 0.5;
            
            // Volume SFX
            if(this.tracks.kambing) this.tracks.kambing.volume = 0.6;
            if(this.tracks.sapi) this.tracks.sapi.volume = 0.6;
            if(this.tracks.ayam) this.tracks.ayam.volume = 0.4;
            if(this.tracks.kuda) this.tracks.kuda.volume = 0.6;
            if(this.tracks.door) this.tracks.door.volume = 0.8;
            if(this.tracks.hit) this.tracks.hit.volume = 0.7;
            if(this.tracks.item) this.tracks.item.volume = 0.8;
            if(this.tracks.bg) this.tracks.bg.volume = 0.8;
            if(this.tracks.chat) this.tracks.chat.volume = 0.8;
            if(this.tracks.inside) this.tracks.inside.volume = 0.5;
            if(this.tracks.dungeon) this.tracks.dungeon.volume = 0.6;
            if(this.tracks.boss) this.tracks.boss.volume = 0.8;
            if(this.tracks.knock) this.tracks.knock.volume = 1.0;
            if(this.tracks.wedding) this.tracks.wedding.volume = 0.8;
        } catch(e) {
            console.warn("Audio Init Error (Non-Fatal):", e);
        }
    },

    playBGM: function(trackName) {
        if (!this.enabled) return;
        if (this.currentTrack === trackName) return;

        // Stop track sebelumnya
        if (this.currentTrack && this.tracks[this.currentTrack]) {
            this.tracks[this.currentTrack].pause();
            this.tracks[this.currentTrack].currentTime = 0;
        }

        // Mainkan track baru
        this.currentTrack = trackName;
        if(this.tracks[trackName]) {
            const playPromise = this.tracks[trackName].play();
            if (playPromise !== undefined) {
                playPromise.catch(error => {
                    // console.log("Audio play prevented/interrupted:", error);
                });
            }
        }
    },
	
	
	// --- NEW: FUNGSI AMBIENCE (SUARA LATAR) ---
    playAmbience: function(trackName) {
        if (!this.enabled) return;
        if (this.currentAmbience === trackName) return;

        // Stop ambience sebelumnya
        this.stopAmbience();

        this.currentAmbience = trackName;
        if(this.tracks[trackName]) {
            this.tracks[trackName].play().catch(()=>{});
        }
    },
	
	stopAmbience: function() {
        if (this.currentAmbience && this.tracks[this.currentAmbience]) {
            this.tracks[this.currentAmbience].pause();
            this.tracks[this.currentAmbience].currentTime = 0;
        }
        this.currentAmbience = null;
    },

	
	

    playSFX: function(trackName) {
        if (!this.enabled) return;
        const track = this.tracks[trackName];
        if (track) {
            track.currentTime = 0;
            track.loop = false;
            const playPromise = track.play();
            if (playPromise !== undefined) {
                playPromise.catch(() => {});
            }
        }
    },

    stopBGM: function() {
        if (this.currentTrack && this.tracks[this.currentTrack]) {
            this.tracks[this.currentTrack].pause();
            this.tracks[this.currentTrack].currentTime = 0;
            this.currentTrack = null;
        }
    },

    update: function() {
        if (!this.enabled) return;

        // 1. UPDATE BGM UTAMA
        if (STATE.screen === 'title' || STATE.screen === 'login' || STATE.screen === 'prologue') {
            this.playBGM('opening');
        } else if (STATE.screen === 'play') {
            // Logika Musik Berdasarkan Lokasi
            if (STATE.location === 'village') {
                
                // --- FIX: MUSIK MUSIM DIPUTAR 24 JAM (TIDAK PEDULI SIANG/MALAM) ---
                if (STATE.season === 'spring') {
                    this.playBGM('spring');
                } else if (STATE.season === 'summer') {
                    this.playBGM('summer');
                } else if (STATE.season === 'autumn') {
                    this.playBGM('autumn'); // file: audio/fall.mp3
                } else if (STATE.season === 'winter') {
                    this.playBGM('winter');
                } else {
                    this.playBGM('village'); // Fallback
                }

                // --- FIX: SUARA MALAM HANYA SEBAGAI BACKGROUND (AMBIENCE) ---
                // Jika Jam 18:00 s/d 05:00 pagi, nyalakan layer suara jangkrik
                if (STATE.time >= 1800 || STATE.time < 500) {
                    this.playAmbience('night');
                } else {
                    this.stopAmbience(); // Matikan suara malam saat siang
                }
                
            } else if (STATE.location === 'dungeon') {
                this.stopAmbience(); // Matikan suara malam di dungeon
                if (STATE.bossSpawned) {
                    this.playBGM('boss');
                } else {
                    this.playBGM('dungeon');
                }
            } else {
				 this.stopAmbience(); // Matikan suara malam di dalam rumah
                // Interior
                if (STATE.location === 'wedding_interior') {
                    this.playBGM('wedding');
                } else {
                    this.playBGM('inside');
                }
            }
        }

        // 2. UPDATE SFX HUJAN
        if ((STATE.weather === 'rain' || STATE.weather === 'snow') && STATE.location === 'village') {
            if (this.tracks.rain && this.tracks.rain.paused) this.tracks.rain.play().catch(()=>{});
        } else {
            if (this.tracks.rain && !this.tracks.rain.paused) this.tracks.rain.pause();
        }

        // 3. UPDATE SFX LAUT (Hanya jika di desa)
        if (STATE.location === 'village' && this.tracks.sea) {
            const margin = 15 * TILE_SIZE; 
            const mapW = ISLAND_W * TILE_SIZE;
            const mapH = ISLAND_H * TILE_SIZE;
            
            const distLeft = STATE.player.x;
            const distRight = mapW - STATE.player.x;
            const distTop = STATE.player.y;
            const distBottom = mapH - STATE.player.y;
            
            const minDist = Math.min(distLeft, distRight, distTop, distBottom);
            
            if (minDist < margin) {
                if (this.tracks.sea.paused) {
                    const p = this.tracks.sea.play();
                    if(p !== undefined) p.catch(()=>{});
                }
                const vol = Math.max(0, 1 - (minDist / margin)) * 0.8;
                this.tracks.sea.volume = vol;
            } else {
                if (!this.tracks.sea.paused) {
                    this.tracks.sea.pause();
                    this.tracks.sea.currentTime = 0;
                }
            }

            // 4. UPDATE SFX BURUNG
            if (STATE.time > 400 && STATE.time < 1800 && STATE.weather === 'clear') {
                if (Math.random() < 0.005) { 
                    if (this.tracks.bird && this.tracks.bird.paused) {
                        this.tracks.bird.currentTime = 0;
                        this.tracks.bird.play().catch(()=>{});
                    }
                }
            }

        } else {
            if(this.tracks.sea) this.tracks.sea.pause();
            if(this.tracks.bird) this.tracks.bird.pause(); 
        }
    }
};

// KONFIGURASI UKURAN TILE
const SRC_TILE_SIZE = 32; 

// TILESET MAPPING (ATLAS)
const TILE_ATLAS = {
    0: {x: 2, y: 0}, // Water
    1: {x: 0, y: 0}, // Grass
    5: {x: 1, y: 0}, // Earth
    6: {x: 3, y: 0}, // Magic Floor
    4: {x: 4, y: 0}, // Dungeon Floor
    10: {x: 5, y: 0} // Wood Floor
};
// --- END ASSET LOADER ---

// --- NEW FUNCTION: SHOW DAILY QUEST ---
let currentQuestTab = 'daily'; // Track active tab

function showDailyQuestPopup() {
    // Jangan munculkan di Prologue atau Cutscene
    if(STATE.isPrologue || STATE.screen === 'cutscene') return;

    // UPDATE: Ganti 'bg' ke 'item' agar suara lebih terdengar jelas (klik)
    if(typeof AudioService !== 'undefined') AudioService.playSFX('item');

    const popup = document.getElementById('daily-quest-popup');
    const title = document.getElementById('quest-day-title');
    const sub = document.getElementById('quest-season-subtitle');

    // Update Text Header
    title.innerText = `HARI KE-${STATE.day}`;
    // 1 Tahun = 120 Hari (4 Musim x 30 Hari)
    const year = Math.floor((STATE.day-1)/120)+1;
    sub.innerText = `${STATE.season.toUpperCase()} - TAHUN KE-${year}`; 

    // Render Content Default (Last Active Tab)
    switchQuestTab(currentQuestTab);

    // Show
    popup.style.display = 'flex';
    STATE.screen = 'modal'; // Pause game input
}

// Helper untuk Toggle via Tombol
function toggleDailyQuest() {
    const popup = document.getElementById('daily-quest-popup');
    if(popup.style.display === 'flex') {
        closeDailyQuest();
    } else {
        showDailyQuestPopup();
    }
}

// FIX: Menambahkan fungsi closeDailyQuest yang sebelumnya hilang
function closeDailyQuest() {
    // NEW: Tambahkan SFX saat menutup jurnal agar ada feedback
    if(typeof AudioService !== 'undefined') AudioService.playSFX('item');

    const popup = document.getElementById('daily-quest-popup');
    if(popup) popup.style.display = 'none';
    STATE.screen = 'play'; // Resume game
}

function switchQuestTab(tabName) {
    currentQuestTab = tabName;
    
    // Update UI Tabs
    document.querySelectorAll('.quest-tab-btn').forEach(btn => btn.classList.remove('active'));
    const activeBtn = document.getElementById('tab-' + tabName);
    if(activeBtn) activeBtn.classList.add('active');

    // Update Content
    const content = document.getElementById('quest-list-content');
    content.innerHTML = getQuestContent(tabName);
}

// --- NEW FUNCTION: CHECK DAILY COMPLETION (Cek Syarat Reward) ---
function checkDailyCompletion() {
    const p = STATE.player;
    const role = p.role;
    
    // Syarat Umum (Harus beraktivitas/Energi berkurang)
    const conditionGeneral = p.energy < 100;

    // UPDATE: Syarat Wajib Jurnal (Harus sudah menulis jurnal hari ini)
    // Cek apakah ada entry jurnal dengan day == STATE.day
    const hasJournal = p.reflections && p.reflections.some(r => r.day === STATE.day);

    // NEW: Syarat Mancing Harian (Minimal 1x)
    const hasFishing = (p.dailyFishingCount || 0) >= 1;

    // NEW: Syarat Kalahkan Monster Harian (Minimal 2x)
    const hasMonsterKills = (p.dailyMonsterKills || 0) >= 2;

    // NEW: Syarat Sosialisasi Harian (Bicara min 1 NPC)
    const hasTalked = (p.dailyTalkCount || 0) >= 1;

    // Jika belum pilih role, belum bisa klaim
    if(role === 'none') return false;

    // Cek syarat spesifik per Role (Logika disesuaikan dengan Quest UI)
    let conditionRole = false;

    if(role === 'worker') {
        // UPDATE: CEK HARI LIBUR (AHAD/MINGGU)
        const dayIndex = (STATE.day - 1) % 7; // 0=Senin ... 6=Minggu
        const isSunday = (dayIndex === 6);

        if (isSunday) {
            // Jika hari Ahad, syarat kerja dianggap selesai (Bonus Libur)
            // Tapi tetap harus ada aktivitas fisik (Energi < 50) sebagai gantinya
            conditionRole = p.energy < 70; 
        } else {
            // Hari Biasa: Sedang kerja ATAU sudah kerja keras seharian
            conditionRole = (p.shiftStarted && p.energy < 80) || p.energy < 50;
        }
    } 
    else if(role === 'student') {
        // Syarat: Di Kampus ATAU Belajar (Energi < 70) ATAU di Perpus
        // FIX: Menggunakan p.lastAttendanceDay agar status hadir tersimpan seharian (tidak hilang saat keluar)
        const isAtSchool = p.lastAttendanceDay === STATE.day;
        const isStudying = p.energy < 70;
        const isLibrary = STATE.location === 'library_interior';
        
        conditionRole = isAtSchool || isStudying || isLibrary;
    } 
    else if(role === 'entrepreneur') {
        // UPDATE: SYARAT HARIAN WIRAUSAHA (JURNAL)
        // 1. Harus berada di Pasar (Merchant) untuk cek harga
        const atMarket = STATE.location === 'merchant_interior';
        // 2. Harus punya stok barang dagangan (Inventory > 0)
        const hasStock = Object.values(p.inventory).some(v => v > 0);
        // 3. Target Skill Bisnis (Sesuai Level)
        const targetBiz = p.level * 2;
        const hasSkill = p.biz >= targetBiz;
        
        conditionRole = atMarket && (hasStock || hasSkill);
    } 
    else if(role === 'family') {
        // Syarat: Bantu orang (Energi < 80)
        conditionRole = p.energy < 80;
    }

    // UPDATE: Menambahkan hasTalked ke syarat total
    return conditionGeneral && conditionRole && hasJournal && hasFishing && hasMonsterKills && hasTalked;
}

// --- NEW HELPER: CHECK WEEKLY COMPLETION ---
function checkWeeklyCompletion() {
    const p = STATE.player;
    const week = Math.ceil(STATE.day / 7);
    const role = p.role;

    if (role === 'none') return false;

    // 1. Syarat Umum
    const weekLvlTarget = week * 2;
    const condLevel = p.level >= weekLvlTarget;
    const condItem = (p.inventory['ikan_segar'] || 0) >= 1;

    // 2. Syarat Role
    let condRole = false;
    if (role === 'worker') {
        const targetStr = p.level * 2 + 10;
        condRole = p.str >= targetStr;
    } else if (role === 'student') {
        const targetInt = p.level * 2 + 10;
        const hasSnack = (p.inventory['coklat'] || 0) >= 1;
        condRole = p.int >= targetInt && hasSnack;
    } else if (role === 'entrepreneur') {
        const targetBiz = p.level + 5;
        condRole = p.biz >= targetBiz;
    } else if (role === 'family') {
        const friendTarget = Math.min(5, Math.ceil(week / 2));
        const currentFriends = Object.keys(p.relationships).length;
        condRole = currentFriends >= friendTarget;
    }

    return condLevel && condItem && condRole;
}

// --- NEW HELPER: CHECK MONTHLY COMPLETION ---
function checkMonthlyCompletion() {
    const p = STATE.player;
    const month = Math.ceil(STATE.day / 30);
    const role = p.role;

    if (role === 'none') return false;

    // 1. Syarat Tabungan
    const monthlyMoneyTarget = month * 10000;
    const condMoney = p.money >= monthlyMoneyTarget;

    // 2. Syarat Role
    let condRole = false;
    if (role === 'worker') condRole = p.bossReputation >= 70;
    else if (role === 'student') condRole = Object.keys(p.inventory).some(k => k.includes('buku'));
    else if (role === 'entrepreneur') condRole = p.money >= monthlyMoneyTarget * 1.5;
    else if (role === 'family') condRole = p.reputation >= month * 10;

    // 3. Syarat Musim (Opsional, tapi kita masukkan agar menantang)
    // Sederhana: Harus punya item khas musim atau progress tertentu
    let condSeason = false;
    if (STATE.season === 'spring') condSeason = (p.inventory['bunga'] || 0) > 0;
    else if (STATE.season === 'summer') condSeason = (p.inventory['ikan_segar'] || 0) >= 5;
    else if (STATE.season === 'autumn') condSeason = p.money >= 50000;
    else if (STATE.season === 'winter') condSeason = STATE.dungeonLevel >= 2;

    return condMoney && condRole && condSeason;
}

// --- NEW HELPER: CHECK LIFE TARGET (TRIAL 3 TAHUN) ---
function checkLifeTrialCompletion() {
    const p = STATE.player;
    const role = p.role;
    if (role === 'none') return false;

    if (role === 'worker') return p.str >= 50 && p.money >= 100000;
    // UPDATE: Syarat Student disesuaikan (Evaluasi Studi Tahun ke-3)
    // Tidak butuh tesis, tapi butuh buku referensi & INT cukup
    if (role === 'student') {
        const hasBook = Object.keys(p.inventory).some(k => k.includes('buku') && !k.includes('tesis'));
        return p.int >= 50 && p.level >= 15 && hasBook;
    }
    if (role === 'entrepreneur') return p.biz >= 50 && p.houseLevel >= 2;
    if (role === 'family') return p.reputation >= 50 && Object.keys(p.relationships).length >= 5;
    
    return false;
}

// --- NEW FUNCTION: CLAIM REWARDS (GENERIC) ---
function claimReward(type) {
    const p = STATE.player;
    
    // --- WEEKLY ---
    if (type === 'weekly') {
        const currentWeek = Math.ceil(STATE.day / 7);
        if (p.lastWeeklyClaim === currentWeek) {
            showToast("Reward Minggu ini sudah diambil!");
            return;
        }
        if (!checkWeeklyCompletion()) {
            showToast("Syarat Mingguan belum terpenuhi!");
            return;
        }

        // Hadiah Mingguan
        p.lastWeeklyClaim = currentWeek;
        p.money += 5000;
        gainExp(200);
        addItem('tonic_stamina', 1); // Bonus Item
        
        showToast(" WEEKLY REWARD: 5000G + 200EXP + Tonic!");
        if(typeof AudioService !== 'undefined') AudioService.playSFX('item');
        createParticle(p.x, p.y, '#a855f7');
    }

    // --- MONTHLY ---
    else if (type === 'monthly') {
        const currentMonth = Math.ceil(STATE.day / 30);
        if (p.lastMonthlyClaim === currentMonth) {
            showToast("Reward Bulan ini sudah diambil!");
            return;
        }
        if (!checkMonthlyCompletion()) {
            showToast("Syarat Bulanan belum terpenuhi!");
            return;
        }

        // Hadiah Bulanan (Besar)
        p.lastMonthlyClaim = currentMonth;
        p.money += 20000;
        gainExp(1000);
        addItem('permata', 2); // Bonus Item Mahal
        
        showToast(" MONTHLY REWARD: 20.000G + 1000EXP + 2 Berlian!");
        if(typeof AudioService !== 'undefined') AudioService.playSFX('item');
        createParticle(p.x, p.y, '#22d3ee');
    }

    // --- LIFE (TRIAL TARGET) ---
    else if (type === 'life_trial') {
        if (p.claimedLifeTrial) {
            showToast("Hadiah Target Jangka Panjang sudah diambil!");
            return;
        }
        if (!checkLifeTrialCompletion()) {
            showToast("Target Trial 3 Tahun belum tercapai!");
            return;
        }

        // Hadiah Pencapaian Hidup
        p.claimedLifeTrial = true;
        p.money += 100000;
        gainExp(5000);
        addItem('tonic_kebal', 3); // Item Langka
        
        showToast(" LIFE ACHIEVEMENT: 100.000G + 5000EXP + 3 Tonic Kebal!");
        if(typeof AudioService !== 'undefined') AudioService.playSFX('item'); // Reuse sound or new fanfare
        createParticle(p.x, p.y, '#e11d48');
    }

    // Refresh UI
    showDailyQuestPopup();
}

// --- MODIFIED: CLAIM DAILY REWARD ---
function claimDailyReward() {
    // 1. Cek apakah sudah klaim hari ini
    if(STATE.player.lastDailyClaim === STATE.day) {
        showToast("Sudah diklaim hari ini!");
        return;
    }

    // 2. Validasi Kelengkapan Quest
    if(!checkDailyCompletion()) {
        showToast("Selesaikan misi harian dulu!");
        return;
    }

    // 3. BERI HADIAH
    const goldReward = 1000 + (STATE.player.level * 100); // 1000 + Bonus Level
    const expReward = 50;
    
    STATE.player.money += goldReward;
    gainExp(expReward);
    
    // 4. Tandai sudah klaim
    STATE.player.lastDailyClaim = STATE.day;

    // 5. Efek Visual & Audio
    if(typeof AudioService !== 'undefined') AudioService.playSFX('item');
    createParticle(STATE.player.x, STATE.player.y, '#fbbf24');
    
    showToast(` Reward: ${goldReward}G & ${expReward}XP!`);
    
    // 6. Refresh UI Popup agar tombol berubah jadi "Klaim"
    showDailyQuestPopup();
}

function getQuestContent(tabType) {
    const p = STATE.player;
    const day = STATE.day;
    const season = STATE.season;
    const role = p.role;
    
    // Helpers Visual
    const check = (cond) => cond ? '<span style="color:#4ade80"></span>' : '<span style="color:#94a3b8"></span>';
    const prog = (cur, target, unit='') => `<span style="font-size:10px; color:#fbbf24; margin-left:4px;">(${cur}/${target}${unit})</span>`;
    
    // Helper Header Section
    const section = (title, color='#38bdf8') => `<div style="
        background: linear-gradient(90deg, rgba(30, 41, 59, 0.8), transparent);
        color: ${color};
        padding: 4px 8px;
        font-weight: bold;
        font-size: 11px;
        margin: 5px 0 4px 0;
        border-left: 3px solid ${color};
        text-transform: uppercase;
        letter-spacing: 1px;
    ">${title}</div>`;

    // Helper Button Generator
    const createClaimBtn = (label, action, isComplete, isClaimed, rewardText) => {
        let btnStyle = "width:100%; margin-top:10px; padding:8px; font-weight:bold; border-radius:6px; cursor:pointer; font-size:11px;";
        let btnText = "";
        let btnAttr = "";

        if (isClaimed) {
            btnStyle += "background:#334155; color:#94a3b8; border:1px solid #475569; cursor:not-allowed;";
            btnText = " SUDAH DIKLAIM";
        } else if (isComplete) {
            btnStyle += "background:linear-gradient(90deg, #f59e0b, #d97706); color:white; border:1px solid #fbbf24; box-shadow:0 0 10px rgba(251,191,36,0.5); animation: pulse 1s infinite;";
            btnText = ` KLAIM ${label}`;
            btnAttr = `onclick="${action}"`;
        } else {
            btnStyle += "background:#1e293b; color:#64748b; border:1px dashed #475569; cursor:not-allowed;";
            btnText = " SELESAIKAN MISI DULU";
        }

        let html = `<button style="${btnStyle}" ${btnAttr} ${isClaimed || !isComplete ? 'disabled' : ''}>${btnText}</button>`;
        if(!isClaimed) html += `<div style="text-align:center; font-size:9px; color:#fbbf24; margin-top:2px;">${rewardText}</div>`;
        return html;
    };

    // Data Waktu
    const week = Math.ceil(day / 7);
    const month = Math.ceil(day / 30);

    let html = "";

    // --- 0. STATUS AWAL (Jika Belum Pilih Role) ---
    if(role === 'none') {
        return `
            ${section(' Misi Utama: Tentukan Takdir', '#ef4444')}
            ${check(false)} Temui Mentor Budi di Desa<br>
            ${check(false)} Tidur & Pilih Jalan Hidupmu (Role)<br>
            <i style="font-size:10px; color:#fbbf24; margin-top:5px; display:block;">Tips: Jelajahi desa dulu sebelum memutuskan.</i>
        `;
    }

    // --- TAB 1: HARIAN (DAILY) ---
    if (tabType === 'daily') {
        html += section(' Quest Harian (Reset 24:00)', '#fbbf24');
        
        // --- NEW: MISI ONBOARDING (LANGKAH PERTAMA SETELAH TUTORIAL) ---
        // Menampilkan panduan spesifik jika pemain baru saja memilih role
        let onboardingMsg = "";
        
        if (role === 'student' && !p.major) {
            onboardingMsg = `
                <div style="background:rgba(59, 130, 246, 0.2); padding:5px; border-radius:4px; margin-bottom:5px; border-left:2px solid #3b82f6;">
                    <strong> MISI UTAMA: PENDAFTARAN</strong><br>
                    ${check(false)} Pergi ke <strong>Gedung Kampus</strong> (Timur)<br>
                    ${check(false)} Bicara dengan Dosen & Pilih Jurusan
                </div>`;
        } else if (role === 'worker' && p.jobStatus === 'unemployed') {
            onboardingMsg = `
                <div style="background:rgba(239, 68, 68, 0.2); padding:5px; border-radius:4px; margin-bottom:5px; border-left:2px solid #ef4444;">
                    <strong> MISI UTAMA: MENCARI KERJA</strong><br>
                    ${check(false)} Pergi ke <strong>Toko Merchant</strong> (Selatan)<br>
                    ${check(false)} Bicara dengan Bos & Lamar Kerja
                </div>`;
        } 
        // UPDATE: TAMBAHAN QUEST JURNAL UNTUK FAMILY
        else if (role === 'family' && p.activeQuest === 'meet_modin') {
            onboardingMsg = `
                <div style="background:rgba(217, 70, 239, 0.2); padding:5px; border-radius:4px; margin-bottom:5px; border-left:2px solid #d946ef;">
                    <strong> MISI UTAMA: RESTU MODIN</strong><br>
                    ${check(false)} Pergi ke <strong>Balai Pernikahan</strong> (Selatan)<br>
                    ${check(false)} Temui Bapak Penghulu (Modin)
                </div>`;
        }

        if (onboardingMsg) html += onboardingMsg;

        // Umum
        html += `<strong>[Umum]</strong><br>`;
        html += `${check(p.energy < 100)} Gunakan Energi (Aktivitas)<br>`;
        
        // UPDATE: Tampilkan Status Jurnal di UI Quest Harian
        const hasJournal = p.reflections && p.reflections.some(r => r.day === day);
        html += `${check(hasJournal)} Tulis Jurnal Refleksi (Di Rumah)<br>`;

        // NEW: Tampilkan Quest Mancing di Menu
        const hasFishing = (p.dailyFishingCount || 0) >= 1;
        html += `${check(hasFishing)} Mancing Ikan (1x) <br>`;

        // NEW: Tampilkan Quest Sosialisasi (Bicara NPC)
        const talkCount = p.dailyTalkCount || 0;
        html += `${check(talkCount >= 1)} Sosialisasi (Bicara NPC) ${prog(talkCount, 1)} <br>`;

        // NEW: Tampilkan Quest Monster di Menu
        const monsterKills = p.dailyMonsterKills || 0;
        const targetKills = 2;
        html += `${check(monsterKills >= targetKills)} Kalahkan Monster (Dungeon) ${prog(monsterKills, targetKills)} <br>`;
        
        // Role Spesifik
        html += `<strong>[Role: ${role.toUpperCase()}]</strong><br>`;
        if(role === 'worker') {
            // UPDATE: TAMPILAN LIBUR HARI AHAD
            const dayIndex = (day - 1) % 7;
            const isSunday = (dayIndex === 6);

            if (isSunday) {
                html += ` <span style="color:#64748b; text-decoration:line-through;">Masuk Shift</span> <span style="color:#fbbf24; font-size:10px;">(Libur Hari Ahad)</span><br>`;
            } else {
                html += `${check(p.shiftStarted)} Masuk Shift (08:00-16:00)<br>`;
            }
            html += `${check(p.energy < 50)} Latihan Fisik/Kerja ${prog(p.energy > 50 ? 'Belum' : 'Selesai', 'Lelah')}<br>`;
        } else if(role === 'student') {
            // UPDATE: CEK HARI LIBUR (SABTU & MINGGU)
            const dayIndex = (STATE.day - 1) % 7; // 0=Senin ... 5=Sabtu, 6=Minggu
            const isWeekend = (dayIndex === 5 || dayIndex === 6);

            if (isWeekend) {
                // Tampilan saat Libur
                html += ` <span style="color:#64748b; text-decoration:line-through;">Hadir Kuliah</span> <span style="color:#fbbf24; font-size:10px;">(Libur Akhir Pekan)</span><br>`;
            } else {
                // Tampilan Hari Biasa
                // FIX: Menggunakan p.lastAttendanceDay agar checklist permanen hari itu
                html += `${check(p.lastAttendanceDay === STATE.day)} Hadir Kuliah (08:00 - 14:00)<br>`;
            }
            
            html += `${check(p.energy < 70)} Belajar Mandiri (Buku)<br>`;
            // ADDED: QUEST KHUSUS MAHASISWA (Riset di Perpustakaan)
            html += `${check(STATE.location === 'library_interior')} Riset di Perpustakaan<br>`;
        } else if(role === 'entrepreneur') {
            // UPDATE: TAMPILAN JURNAL WIRAUSAHA
            html += `${check(STATE.location === 'merchant_interior')} Pantau Harga Pasar (Merchant)<br>`;
            html += `${check(Object.values(p.inventory).some(v=>v>0))} Manajemen Stok Barang<br>`;
            const targetBiz = p.level * 2;
            html += `${check(p.biz >= targetBiz)} Asah Skill Bisnis (BIZ ${targetBiz}+)<br>`;
        } else if(role === 'family') {
            html += `${check(p.energy < 80)} Bantu Tetangga (Interact)<br>`;
            html += `${check(false)} Sapa 2 Orang Berbeda<br>`;
        }

        // --- REWARD BUTTON DAILY ---
        const isComplete = checkDailyCompletion();
        const isClaimed = (p.lastDailyClaim === STATE.day);
        html += createClaimBtn("HARIAN", "claimDailyReward()", isComplete, isClaimed, `Reward: ${1000 + (p.level*100)}G + 50 XP`);
    }

    // --- TAB 2: MINGGUAN (WEEKLY) ---
    else if (tabType === 'weekly') {
        html += section(` Quest Mingguan (Minggu ke-${week})`, '#a855f7');
        
        // Umum
        const weekLvlTarget = week * 2;
        html += `${check(p.level >= weekLvlTarget)} Capai Level ${weekLvlTarget} ${prog(p.level, weekLvlTarget)}<br>`;
        html += `${check(p.inventory['ikan_segar'] >= 1)} Stok Makanan (Ikan) ${prog(p.inventory['ikan_segar']||0, 1)}<br>`;

        // Role Spesifik
        if(role === 'worker') {
            const targetStr = p.level * 2 + 10;
            html += `${check(p.str >= targetStr)} Latihan Intensif (STR) ${prog(p.str, targetStr)}<br>`;
        } else if(role === 'student') {
            const targetInt = p.level * 2 + 10;
            html += `${check(p.int >= targetInt)} Riset Pustaka (INT) ${prog(p.int, targetInt)}<br>`;
            // ADDED: QUEST LOGISTIK MAHASISWA
            html += `${check(p.inventory['coklat'] >= 1)} Beli Snack Belajar (Coklat)<br>`;
        } else if(role === 'entrepreneur') {
            const targetBiz = p.level + 5;
            html += `${check(p.biz >= targetBiz)} Analisa Pasar (BIZ) ${prog(p.biz, targetBiz)}<br>`;
        } else if(role === 'family') {
            const friendTarget = Math.min(5, Math.ceil(week/2));
            const currentFriends = Object.keys(p.relationships).length;
            html += `${check(currentFriends >= friendTarget)} Cari ${friendTarget} Teman ${prog(currentFriends, friendTarget)}<br>`;
        }

        // --- REWARD BUTTON WEEKLY ---
        const isComplete = checkWeeklyCompletion();
        const isClaimed = (p.lastWeeklyClaim === week);
        html += createClaimBtn("MINGGUAN", "claimReward('weekly')", isComplete, isClaimed, "Reward: 5000G + 200 XP + Tonic");
    }

    // --- TAB 3: BULANAN (MONTHLY & SEASONAL) ---
    else if (tabType === 'monthly') {
        // Bulanan
        html += section(` Quest Bulanan (Bulan ke-${month})`, '#22d3ee');
        const monthlyMoneyTarget = month * 10000;
        html += `${check(p.money >= monthlyMoneyTarget)} Tabungan ${monthlyMoneyTarget/1000}k Gold ${prog((p.money/1000).toFixed(1)+'k', (monthlyMoneyTarget/1000)+'k')}<br>`;
        
        if(role === 'worker') html += `${check(p.bossReputation >= 70)} Jadi Pegawai Teladan (Rep Boss 70+)<br>`;
        if(role === 'student') html += `${check(Object.keys(p.inventory).some(k=>k.includes('buku')))} Koleksi Buku Baru<br>`;
        if(role === 'entrepreneur') html += `${check(p.money >= monthlyMoneyTarget * 1.5)} Omset Dagang Tinggi<br>`;
        if(role === 'family') html += `${check(p.reputation >= month * 10)} Reputasi Warga Baik ${prog(p.reputation, month*10)}<br>`;

        // Musiman (Digabung ke tab Bulanan biar hemat tempat)
        let seasonColor = '#4ade80'; 
        let seasonQuest = "Nikmati keindahan bunga sakura.";
        let seasonTarget = "";

        if(season === 'spring') {
            seasonColor = '#f472b6'; 
            seasonQuest = "Waktunya Mencari Bunga & Cinta";
            seasonTarget = `${check(p.inventory['bunga'] > 0)} Cari Bunga Liar`;
        } else if(season === 'summer') {
            seasonColor = '#facc15';
            seasonQuest = "Waktunya Memancing & Eksplorasi";
            seasonTarget = `${check(p.inventory['ikan_segar'] >= 5)} Tangkap 5 Ikan`;
        } else if(season === 'autumn') {
            seasonColor = '#fb923c';
            seasonQuest = "Waktunya Panen & Berdagang";
            seasonTarget = `${check(p.money >= 50000)} Kumpulkan Modal Besar`;
        } else if(season === 'winter') {
            seasonColor = '#60a5fa';
            seasonQuest = "Waktunya Bertahan Hidup (Dungeon)";
            seasonTarget = `${check(STATE.dungeonLevel >= 2)} Jelajahi Dungeon Lt.2`;
        }

        html += section(` Misi Musim ${season.toUpperCase()}`, seasonColor);
        html += `<i>"${seasonQuest}"</i><br>`;
        html += `${seasonTarget}<br>`;

        // --- REWARD BUTTON MONTHLY ---
        const isComplete = checkMonthlyCompletion();
        const isClaimed = (p.lastMonthlyClaim === month);
        html += createClaimBtn("BULANAN", "claimReward('monthly')", isComplete, isClaimed, "Reward: 20k G + 1000 XP + 2 Berlian");
    }

    // --- TAB 4: JANGKA PANJANG (LIFE TARGETS) ---
    else if (tabType === 'life') {
        html += section(' Target Jangka Panjang', '#e11d48');
        
        // Trial 3 Tahun
        html += `<strong>[Trial 3 Tahun - Masa Percobaan]</strong><br>`;
        if(role === 'worker') {
            html += `${check(p.str >= 50)} STR 50+ ${prog(p.str, 50)}<br>`;
            html += `${check(p.money >= 100000)} Uang 100k<br>`;
        } else if(role === 'student') {
            // UPDATE: Deskripsi agar jelas ini adalah Evaluasi Tahun ke-3 (Bukan Lulus)
            html += `<span style="font-size:10px; color:#94a3b8;">(Syarat Lanjut ke Tahun 4)</span><br>`;
            html += `${check(p.int >= 50)} INT 50+ (IPK Aman) ${prog(p.int, 50)}<br>`;
            html += `${check(p.level >= 15)} Level 15 (Soft Skill)<br>`;
            html += `${check(Object.keys(p.inventory).some(k=>k.includes('buku') && !k.includes('tesis')))} Punya Buku Referensi<br>`;
        } else if(role === 'entrepreneur') {
            html += `${check(p.biz >= 50)} BIZ 50+ ${prog(p.biz, 50)}<br>`;
            html += `${check(p.houseLevel >= 2)} Upgrade Rumah Lv 2<br>`;
        } else if(role === 'family') {
            html += `${check(p.reputation >= 50)} REP 50+ ${prog(p.reputation, 50)}<br>`;
            html += `${check(Object.keys(p.relationships).length >= 5)} 5 Sahabat<br>`;
        }

        // --- REWARD BUTTON LIFE TRIAL ---
        const isComplete = checkLifeTrialCompletion();
        const isClaimed = p.claimedLifeTrial;
        html += createClaimBtn("ACHIEVEMENT", "claimReward('life_trial')", isComplete, isClaimed, "Reward: 100k G + 5000 XP + 3 Tonic Kebal");

        // Kelulusan 5 Tahun
        html += `<br><strong>[Kelulusan 5 Tahun - Akhir Game]</strong><br>`;
        html += `${check(p.money >= 1000000)} Aset 1 Juta Gold<br>`;
        if(role === 'worker') html += `${check(p.bossReputation >= 100)} Jadi Manajer Toko<br>`;
        if(role === 'student') html += `${check(p.inventory['buku_tesis'])} Selesaikan Tesis<br>`;
        if(role === 'entrepreneur') html += `${check(p.houseLevel >= 5)} Rumah Mewah Lv 5<br>`;
        if(role === 'family') html += `${check(p.married)} Menikah Bahagia<br>`;
        
        html += `<div style="text-align:center; font-size:9px; color:#ef4444; margin-top:5px;">(Otomatis Tamat jika Tercapai)</div>`;
    }

    return html;
}

// --- NEW: SYSTEM PRELOADER ASSET (FIX GAMBAR LAMA MUNCUL DI MOBILE) ---
async function preloadAllGameAssets() {
    const imagesToLoad = [];
    
    // 1. Kumpulkan URL dari Aset Global (Variable Global)
    // Helper untuk mengambil src dari objek aset
    const collectGlobal = (collection) => {
        Object.values(collection).forEach(img => {
            if (img && img.src) imagesToLoad.push({ src: img.src }); // Hanya butuh src untuk cache browser
        });
    };

    collectGlobal(treeAssets);
    collectGlobal(bagAssets);
    collectGlobal(bgSeasons);
    collectGlobal(houseBgAssets);
    collectGlobal(dungeonAssets);
    collectGlobal(wallAssets);
    collectGlobal(grassAssets);
    collectGlobal(farmAssets); // Add Farm Assets to Preloader
    collectGlobal(ruinsAssets); // NEW: Add Ruins Assets
    collectGlobal(candiAssets); // NEW: Add Candi Assets
    collectGlobal(clinicAssets); // NEW: Add Clinic Assets
    collectGlobal(mentorAssets); // NEW: Add Mentor Assets

    // 2. Kumpulkan semua gambar dari Peta (Bangunan, NPC, Objek)
    // FIX: Bungkus dalam Try-Catch dan Cek 'maps' agar tidak error jika map belum siap
    try {
        if (typeof maps !== 'undefined') {
            for (const [mapName, mapData] of Object.entries(maps)) {
                // Buildings
                if (mapData.buildings) {
                    mapData.buildings.forEach(b => {
                        if (b.img) imagesToLoad.push({ src: b.img, element: b });
                    });
                }
                // NPCs
                if (mapData.npcs) {
                    mapData.npcs.forEach(n => {
                        if (n.imgSrc) imagesToLoad.push({ src: n.imgSrc, element: n });
                    });
                }
                // Objects
                if (mapData.objects) {
                    mapData.objects.forEach(o => {
                        if (o.img) imagesToLoad.push({ src: o.img, element: o });
                    });
                }
            }
        }
    } catch (e) {
        console.warn("Aset Peta dilewati (Maps belum siap):", e);
    }

    // 3. Tambahkan Aset Player (Gender & Kostum) & UI Penting SECARA MANUAL
    // Agar tidak blank saat ganti baju atau pertama login
    const manualAssets = [
        // UI & Backgrounds
        'images/bg.png', 'images/landinggame.png', 'images/lobby.png', 'images/leaderboard.png',
        'images/tas-isi.png', 'images/tas-kosong.png', 'images/quest-scroll.png',
        'images/logosmk.png', 'images/loganailul.png', 'images/logotkj.png',
        
        // Player Boy
        'images/boy.png', 'images/boy-idle.png', 'images/boy-walk.png', 
        'images/boy-atas.png', 'images/boy-bawah.png', 'images/boy-pukul.png',
        'images/boy-idle-weding.png', 'images/boy-walk-weding.png',
        
        // Player Girl
        'images/girl.png', 'images/girl-idle.png', 'images/girl-walk.png', 
        'images/girl-atas.png', 'images/girl-bawah.png', 'images/girl-pukul.png',
        'images/girl-idle-weding.png', 'images/girl-walk-weding.png',
        
        // Item Icons (Penting)
        'images/ikankecil.png', 'images/ikansedang.png', 'images/ikanbesar.png', 'images/ikanlegendary.png',
        'images/buku.png', 'images/buku-tesis-teknologi.png', 'images/buku-tesis-sejarah.png',
        'images/draftskripsi-teknologi.png', 'images/draftskripsi-sejarah.png',
        'images/sertifikat-manajer.png', 'images/ijazah-teknologi.png', 'images/ijazah-sejarah.png',
        // NEW: ASSET KURCACI TANI & PERI PANEN
        'images/kurcacitani.png', 'images/peripanen.png',
        // NEW: ASSET ORANG SAWAH
        'images/orangsawah.png',
        // NEW: ASSET RAFFLESIA ARNOLDI
        'images/rafflesia.png',
        // NEW: ASSET RERUNTUHAN (FIX AGAR TIDAK KOSONG)
        'images/tembok-reruntuhan.png', 
        'images/lantai-reruntuhan.png',
        // NEW: ASSET LANTAI CANDI
        'images/lantaicandi.png',
        'images/lantaimerahcandi.png', // NEW
        // NEW: ASSET ARCA & GUCI CANDI
        'images/arcacandi.png',
        'images/gucicandi.png',
        // NEW: ASSET LILIN ABADI
        'images/lilinabadi.png',
        // NEW: ASSET PRASASTI CANDI
        'images/prasasticandi.png',
        // NEW: ASSET MEJA ALTAR CANDI
        'images/mejaaltar.png',
        // NEW: ASSET JARING IKAN
        'images/jaringikan.png',
        // NEW: ASSET RAK PANCING
        'images/rakpancing.png',
        // NEW: ASSET EMBER IKAN
        'images/emberikan.png',
        // NEW: ASSET BOXES (BOX ES)
        'images/boxes.png',
        // NEW: ASSET KASUR NELAYAN
        'images/kasurnelayan.png',
        // NEW: ASSET RAK PIALA IKAN
        'images/rakpialaikan.png',
        // NEW: ASSET MEJA MAKAN IKAN
        'images/mejamakanikan.png',
        // NEW: ASSET KLINIK BARU
        'images/mejadokter.png',
        'images/lemariobat.png',
        'images/arsiprekammedis.png',
        // NEW: ASSET KEBUN AYU
        'images/kebunayu.png',
        // NEW: ASSET KASUR AYU
        'images/kasurayaayu.png',
        // NEW: ASSET LEMARI AYU
        'images/lemariayaayu.png',
        // NEW: ASSET MEJA AYU
        'images/mejaayaayu.png',
        // NEW: ASSET DAPUR AYU
        'images/dapurayaayu.png',
        // NEW: ASSET KAIA & ANAK KECIL (TAMBAHAN MANUAL AGAR TIDAK HILANG)
        'images/kaia.png',
        'images/anakkecil1.png',
        'images/anakkecil2.png',
        // NEW: ASSET TUMPUKAN KERTAS
        'images/tumpukankertas.png',
        // NEW: ASSET FOTO MENTOR
        'images/fotomentor.png',
        // NEW: ASSET ALTAR PERNIKAHAN
        'images/altar.png',
        // NEW: ASSET TUNGKU
        'images/tungku.png',
        // NEW: ASSET PARON
        'images/paron.png',
        // NEW: ASSET RAK SENJATA
        'images/raksenajata.png',
        // NEW: ASSET MEJA JAHIT
        'images/mejajahit.png',
        // NEW: ASSET BIJIH BESI
        'images/bijihbesi.png',
        // NEW: ASSET KAYU BAKAR
        'images/kayubakar.png', // <--- TAMBAHAN KOMA DI SINI
		// NEW: ASSET BONEKA SALJU
		'images/snowman.png',

        // --- [FIX] TAMBAHAN ASET RUMAH AGAR TIDAK BLANK SAAT LOGIN ---
        'images/warnet.png', // <--- TAMBAHAN BARU: WARNET
		'images/penjagawarnet.png', // <--- BARU: PENJAGA
        'images/maidwarnet.png',    // <--- BARU: MAID
        'images/houselevel1.png',
        'images/houselevel2.png',
        'images/houselevel3.png',
        'images/houselevel4.png',
        'images/houselevel5.png',
        'images/tokoplayer.png',
        'images/player-race.png', // <--- NEW: ASSET MOBIL BALAP
        // --- NEW: ASSET MUSUH BALAP ---
        'images/taxi-race.png',
        'images/bike-race.png',
        'images/truck-race.png',
        'images/suv-race.png'
    ];
    
    manualAssets.forEach(src => imagesToLoad.push({ src: src }));
    
    // Hilangkan duplikat agar loading lebih efisien
    const uniqueImages = [];
    const seenSrc = new Set();
    imagesToLoad.forEach(item => {
        // Normalisasi src (kadang browser nambahin base url)
        // Kita pakai raw src string untuk cek duplikasi
        if (item.src && !seenSrc.has(item.src)) {
            seenSrc.add(item.src);
            uniqueImages.push(item);
        } else if (item.element) {
            // Jika duplikat tapi ada referensi elemen map, tetap perlu di-handle referensinya
             uniqueImages.push(item);
        }
    });

    const total = uniqueImages.length;
    let loaded = 0;
    const loadingBar = document.getElementById('loading-bar');
    const loadingText = document.getElementById('loading-text');

    // Jika tidak ada aset (aneh), langsung selesai
    if (total === 0) return;

    console.log(`Memulai Preload untuk ${total} Aset Gambar...`);

    // Fungsi Load Satu Gambar
    const loadImage = (item) => {
        return new Promise((resolve, reject) => {
            const img = new Image();
            
            // FIX: PASANG LISTENER DULU SEBELUM SET SRC
            img.onload = () => {
                loaded++;
                const pct = Math.floor((loaded / total) * 100);
                if(loadingBar) loadingBar.style.width = pct + "%";
                if(loadingText) loadingText.innerText = `MEMUAT ASET (${loaded}/${total})... ${pct}%`;
                
                // Jika ini elemen map, simpan referensi gambar yang SUDAH DILOAD
                if (item.element) {
                    item.element.loadedImg = img;
                }
                resolve();
            };
            
            img.onerror = () => {
                console.warn("Gagal memuat:", item.src);
                loaded++; 
                const pct = Math.floor((loaded / total) * 100);
                if(loadingBar) loadingBar.style.width = pct + "%";
                if(loadingText) loadingText.innerText = `MEMUAT ASET (${loaded}/${total})... ${pct}%`;
                
                // Jangan reject agar game tetap jalan (gunakan fallback nanti)
                resolve(); 
            };

            // SET SRC TERAKHIR
            img.src = item.src;
        });
    };

    // Jalankan semua (Parallel Loading)
    // Kita pakai Promise.all agar browser mengunduh bersamaan
    await Promise.all(uniqueImages.map(item => loadImage(item)));
}

// UPDATE: FUNGSI INIT PERTAMA KALI
function startGameSequence() {
    try {
        // Cek sesi login terakhir untuk prefill
        try {
            let lastUser = localStorage.getItem(SESSION_KEY);
            if(lastUser) {
                // FIX: Jika data berupa JSON (Sesi Admin Lama), HAPUS dan jangan tampilkan agar tidak error
                if (lastUser.trim().startsWith('{')) {
                    localStorage.removeItem(SESSION_KEY); // Bersihkan sesi rusak
                    lastUser = null; 
                }

                if(lastUser) {
                    const elSiswa = document.getElementById('siswa-email');
                    const elGuru = document.getElementById('guru-email');
                    if(elSiswa) elSiswa.value = lastUser;
                    if(elGuru) elGuru.value = lastUser;
                }
            }
        } catch(e) { console.warn("Local storage/DOM Access Error:", e); }

        // Pastikan Audio Prompt muncul duluan, Splash sembunyi
        const audioPrompt = document.getElementById('audio-prompt');
        const splash = document.getElementById('splash-screen');
        
        if (audioPrompt) audioPrompt.style.display = 'flex';
        if (splash) splash.style.display = 'none';

    } catch(err) {
        console.error("CRITICAL INIT ERROR:", err);
    }
};

// Jalankan saat HTML sudah siap (Lebih cepat dari window.onload)
if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', startGameSequence);
} else {
    startGameSequence();
}

// UPDATE: HANDLE PILIHAN AUDIO -> LANJUT KE LOADING ASET
function handleAudioChoice(enable) {
    // Browser butuh interaksi user untuk fullscreen, jadi ini tempat terbaik.
    toggleFullScreen();

    AudioService.enabled = enable;
    
    // 1. Sembunyikan Audio Prompt
    document.getElementById('audio-prompt').style.display = 'none';
    
    // 2. Tampilkan Splash Screen (Loading)
    const splash = document.getElementById('splash-screen');
    if (splash) {
        splash.style.display = 'flex';
        splash.style.opacity = 1;
    }

    // 3. Init Audio Context (Karena sudah ada interaksi user, audio bisa jalan)
    if(typeof AudioService !== 'undefined') {
        AudioService.init();
        if (enable) {
            AudioService.playBGM('opening');
        }
    }
    
    // 4. Mulai Loading Aset
    startAssetLoading();
}

// NEW: FUNGSI LOADING ASET (WAJIB 100%)
function startAssetLoading() {
    console.log("Memulai Asset Loading...");
    const loadingText = document.getElementById('loading-text');
    const loadingBar = document.getElementById('loading-bar');
    const loadingContainer = document.getElementById('loading-container');
    const startBtn = document.getElementById('splash-start-btn');
    
    // UPDATE: HAPUS "Promise.race" dan "setTimeout".
    // Sekarang kita murni menunggu preloadAllGameAssets selesai sepenuhnya.
    
    preloadAllGameAssets().then(() => {
        // Kode di dalam sini HANYA akan jalan setelah semua aset selesai (Resolusi 100%)
        console.log("Assets Ready: 100%");
        
        // Pastikan visual bar penuh
        if(loadingBar) loadingBar.style.width = '100%';
        if(loadingText) loadingText.innerText = 'ASET SIAP! 100%';
        
        // Beri jeda sedikit (500ms) agar pemain sempat melihat tulisan "100%"
        setTimeout(() => {
            // Sembunyikan Loading Bar & Teks
            if(loadingContainer) loadingContainer.style.display = 'none';
            if(loadingText) loadingText.style.display = 'none';
            
            // Tampilkan Tombol Mulai
            if(startBtn) {
                startBtn.style.display = 'block';
                // Tambahkan efek animasi masuk
                startBtn.style.animation = "pulse 1s infinite"; 
                
                startBtn.onclick = () => {
                    // Sembunyikan tombol biar gak diklik 2x
                    startBtn.style.display = 'none';
                    
                    // Efek Suara (Jika ada)
                    if(typeof AudioService !== 'undefined' && AudioService.enabled) {
                        AudioService.playSFX('item');
                    }
                    
                    enterMainMenu();
                };
            }
        }, 500);

    }).catch(err => {
        console.error("Preload Error:", err);
        // Fallback jika terjadi error fatal pada sistem loading (jarang terjadi)
        if(loadingText) loadingText.innerText = "TERJADI KESALAHAN MEMUAT.";
        
        if(startBtn) {
            startBtn.innerText = " REFRESH HALAMAN";
            startBtn.style.display = 'block';
            startBtn.onclick = () => location.reload();
        }
    });
}

// Helper untuk Masuk Menu Utama
function enterMainMenu() {
    const splash = document.getElementById('splash-screen');
    if(typeof resize === 'function') resize();

    // Fade Out Splash -> Masuk Title Screen / Cek Session
    requestAnimationFrame(() => {
        setTimeout(() => {
            if(splash) {
                splash.style.opacity = 0; // Trigger CSS transition fadeOut
                setTimeout(() => {
                    splash.style.display = 'none';
                    
                    // Cek Session setelah loading selesai
                    const title = document.getElementById('title-screen');
                    checkSession(title);
                    
                }, 500); // Hapus elemen setelah animasi CSS selesai
            } else {
                const title = document.getElementById('title-screen');
                checkSession(title);
            }
        }, 200); 
    });
}

function togglePassword(fieldId, iconId) {
    const input = document.getElementById(fieldId);
    const icon = document.getElementById(iconId);
    if (input.type === "password") {
        input.type = "text";
        icon.innerText = ""; 
    } else {
        input.type = "password";
        icon.innerText = ""; 
    }
}

function checkSession(titleEl) {
    try {
        const sessionData = localStorage.getItem(SESSION_KEY);
        if(sessionData) {
            // FIX: Legacy Support - Jika masih ada user yang menyimpan JSON, handle gracefuly
            // Tapi idealnya kita sudah bersihkan di startGameSequence
            if (sessionData.trim().startsWith('{')) {
                try {
                    const adminUser = JSON.parse(sessionData);
                    // Migrasi otomatis ke format baru (String Email)
                    localStorage.setItem(SESSION_KEY, adminUser.email || "admin@system.local");
                    DataService.user = adminUser;
                    initTeacherDashboard();
                    return;
                } catch(e) { 
                    localStorage.removeItem(SESSION_KEY); // Corrupt, hapus
                    return;
                }
            }

            // --- LOGIKA STANDAR (Admin/Guru/Siswa sekarang diperlakukan sama) ---
            const dbLocal = DataService.getDB();
            const user = dbLocal[sessionData];
            
            if(user) {
                DataService.user = { email: sessionData, ...user };
                
                // Cek Role untuk Redirect
                if (user.role === 'admin') {
                    // Sembunyikan layar lain
                    document.getElementById('login-screen').style.display = 'none';
                    document.getElementById('title-screen').classList.add('hidden');
                    initTeacherDashboard();
                } 
                else if(user.role === 'guru') {
                    initTeacherDashboard();
                } 
                else {
                    // Logic Siswa
                    document.getElementById('welcome-name').innerText = user.name || "Siswa";
                    document.getElementById('welcome-class').innerText = user.details || "Umum";
                    if(user.mentor) document.getElementById('welcome-mentor').innerText = "Mentor Active"; 
                    document.getElementById('login-screen').style.display = 'none';
                    
                    if(!user.saveData) {
                        startPrologue();
                    } else {
                        document.getElementById('start-screen').classList.remove('hidden');
                    }
                }
                return;
            }
        }
    } catch (e) {
        console.error("Session Check Error:", e);
        localStorage.removeItem(SESSION_KEY);
    }
    
    if(titleEl) titleEl.classList.remove('hidden');
    STATE.screen = 'title'; 
}

// NEW: FUNCTION TOGGLE FULLSCREEN & FORCE LANDSCAPE
function toggleFullScreen() {
    const elem = document.documentElement;

    // --- UPDATE: FUNGSI MEMAKSA ORIENTASI LANDSCAPE (ANDROID/CHROME) ---
    // Ini memungkinkan game berputar otomatis meskipun "Auto-Rotate" di HP dimatikan
    const forceLandscape = () => {
        if (screen.orientation && screen.orientation.lock) {
            screen.orientation.lock('landscape')
                .then(() => console.log("Orientation locked to Landscape"))
                .catch((err) => {
                    // Beberapa browser/OS (terutama iOS Safari) mungkin menolak ini
                    console.warn("Orientation lock failed/not supported:", err);
                });
        }
    };

    // Cek apakah browser sudah dalam mode fullscreen?
    const isFullscreen = document.fullscreenElement || 
                         document.webkitFullscreenElement || 
                         document.mozFullScreenElement || 
                         document.msFullscreenElement;

    if (!isFullscreen) {  
        // KONDISI 1: BELUM FULLSCREEN -> Request Fullscreen dulu, baru Lock Landscape
        if (elem.requestFullscreen) {
            elem.requestFullscreen().then(forceLandscape).catch(err => console.log(err)); 
        } else if (elem.webkitRequestFullscreen) { /* Safari */
            elem.webkitRequestFullscreen();
            setTimeout(forceLandscape, 500); // Coba lock setelah delay di Safari
        } else if (elem.msRequestFullscreen) { /* IE11 */
            elem.msRequestFullscreen();
            setTimeout(forceLandscape, 500);
        }
    } else {
        // KONDISI 2: SUDAH FULLSCREEN -> Langsung Paksa Lock Landscape
        // (Berguna jika pemain tidak sengaja memutar HP kembali ke potrait)
        forceLandscape();
    }
}

function logout() {
    // FIX: STOP ENGINE SAAT LOGOUT AGAR TIDAK JALAN DI BACKGROUND
    // UPDATE: Menggunakan window object
    if(window.gameLoopId) { 
        cancelAnimationFrame(window.gameLoopId); 
        window.gameLoopId = null; 
    }
    if(window.saveIntervalId) { 
        clearInterval(window.saveIntervalId); 
        window.saveIntervalId = null; 
    }

    localStorage.removeItem(SESSION_KEY);
    // location.reload(); <-- HAPUS BARIS INI (Penyebab refresh ke splash screen)

    // --- LOGIKA BARU: SOFT LOGOUT ---
    DataService.user = null; // Hapus data user di memori
    
    // 1. Reset Form Input
    if(document.getElementById('form-siswa')) document.getElementById('form-siswa').reset();
    if(document.getElementById('form-guru')) document.getElementById('form-guru').reset();

    // 2. Sembunyikan Semua Layar Game/Dashboard
    document.getElementById('teacher-dashboard').style.display = 'none';
    document.getElementById('start-screen').classList.add('hidden');
    document.getElementById('ui-layer').classList.add('hidden'); // Sembunyikan HUD
    document.getElementById('game-over-screen').style.display = 'none';
    document.getElementById('ending-screen').style.display = 'none';
    document.getElementById('login-screen').style.display = 'none'; 
    document.getElementById('prologue-screen').style.display = 'none';
    document.getElementById('gender-screen').style.display = 'none';

    // 3. Tampilkan Title Screen
    document.getElementById('title-screen').classList.remove('hidden');
    STATE.screen = 'title';

    // 4. Reset Audio ke Musik Opening
    if(typeof AudioService !== 'undefined' && AudioService.enabled) {
        AudioService.playBGM('opening');
    }

    showToast("Logged Out");
}

function goToLogin() {
    // FITUR OTOMATIS FULLSCREEN: Trigger saat klik tombol Start
    toggleFullScreen();
    
    document.getElementById('title-screen').classList.add('hidden');
    document.getElementById('login-screen').style.display = 'flex';
    STATE.screen = 'login';
}

function goToTitle() {
    document.getElementById('login-screen').style.display = 'none';
    document.getElementById('title-screen').classList.remove('hidden');
    STATE.screen = 'title';
}

// --- NEW: PUBLIC LEADERBOARD LOGIC ---
async function showLeaderboard() {
    // 1. Tampilkan Overlay Loading
    const overlay = document.getElementById('leaderboard-overlay');
    const list = document.getElementById('lb-list');
    overlay.style.display = 'flex';
    list.innerHTML = '<div style="padding:20px; color:#94a3b8;"> Sinkronisasi Data...</div>';

    try {
        // FIX: Paksa Init Koneksi Cloud dulu agar data terbaru diambil
        await DataService.init(true);

        // 2. Ambil Data Global dari Server
        let students = await DataService.getAllStudents();

        // 3. OPTIMISTIC UPDATE (Gabungkan Data Lokal Pemain jika Lebih Baru)
        // Ini memastikan skor pemain sendiri terlihat update meski server delay
        const currentUserEmail = localStorage.getItem(SESSION_KEY);
        if (currentUserEmail) {
            const dbLocal = DataService.getDB();
            const localUserData = dbLocal[currentUserEmail];

            // Cek apakah user punya data lokal yang valid
            if (localUserData && localUserData.saveData) {
                // Cari data user ini di list server
                const serverIndex = students.findIndex(s => s.email === currentUserEmail);

                if (serverIndex !== -1) {
                    // Jika ketemu, bandingkan timestamp (lastActive)
                    const serverSave = students[serverIndex].saveData || {};
                    const localSave = localUserData.saveData;
                    
                    // Jika lokal lebih baru dari server, TIMPA data server di memori tampilan
                    if ((localSave.lastActive || 0) > (serverSave.lastActive || 0)) {
                        students[serverIndex] = { ...students[serverIndex], ...localUserData };
                        console.log("Leaderboard: Menggunakan data lokal (lebih baru) untuk user ini.");
                    }
                } else {
                    // Jika user belum ada di server (baru main offline), masukkan ke list manual
                    if (localUserData.role === 'siswa') {
                        students.push({ email: currentUserEmail, ...localUserData });
                    }
                }
            }
        }

        // 4. Filter & Sort
        // Hanya siswa yang punya saveData valid
        let validStudents = students.filter(s => s.saveData && s.saveData.day);
        
        // Sort berdasarkan Score Tertinggi
        validStudents.sort((a, b) => {
            const scoreA = calculateGrade(a.saveData);
            const scoreB = calculateGrade(b.saveData);
            return scoreB - scoreA;
        });

        // Ambil Top 10
        const top10 = validStudents.slice(0, 10);

        // 5. Render
        list.innerHTML = '';
        
        if(top10.length === 0) {
            list.innerHTML = '<div style="padding:20px; color:#cbd5e1;">Belum ada data petualang. <br>Jadilah yang pertama!</div>';
            return;
        }

        top10.forEach((s, index) => {
            const rank = index + 1;
            const score = calculateGrade(s.saveData);
            const role = s.saveData.role !== 'none' ? s.saveData.role.toUpperCase() : 'NOVICE';
            const lvl = s.saveData.level || 1;
            
            // Style khusus 3 besar
            let rankClass = '';
            let icon = `#${rank}`;
            let bgStyle = '';

            if(rank === 1) { rankClass = 'top-1'; icon = ''; bgStyle='background:rgba(251, 191, 36, 0.1); border-left: 3px solid #fbbf24;'; }
            else if(rank === 2) { rankClass = 'top-2'; icon = ''; }
            else if(rank === 3) { rankClass = 'top-3'; icon = ''; }

            // Highlight User Sendiri
            if (s.email === currentUserEmail) {
                bgStyle = 'background:rgba(59, 130, 246, 0.2); border: 1px solid #3b82f6;';
                s.name += " (Kamu)";
            }

            list.innerHTML += `
                <div class="lb-item" style="${bgStyle}">
                    <div class="lb-rank ${rankClass}">${icon}</div>
                    <div class="lb-info">
                        <div class="lb-name">${s.name}</div>
                        <div class="lb-detail" style="color:#94a3b8;">${role} | Lv ${lvl}</div>
                    </div>
                    <div class="lb-score">${score}</div>
                </div>
            `;
        });

    } catch (err) {
        console.error("Leaderboard Error:", err);
        list.innerHTML = `<div style="padding:20px; color:#ef4444;">Gagal memuat data server.<br><small>${err.message}</small></div>`;
    }
}

function closeLeaderboard() {
    document.getElementById('leaderboard-overlay').style.display = 'none';
}

// PROLOGUE LOGIC
const prologueTexts = [
    "Di usia delapan belas tahun, setiap manusia berdiri di gerbang kehidupannya sendiri.",
    "Tidak ada peta yang benar. Tidak ada jalan yang pasti.",
    "Di Nusantara Arsa, kamu dikirim ke pulau ini bukan untuk dihukum, melainkan untuk ditempa.",
    "Di sini, kamu akan menghadapi realita. Kamu bukan lagi anak-anak, kamu adalah arsitek masa depan.",
    "Pilihanmu adalah kekuatanmu. Bekerja, Belajar, Membangun Usaha, atau Mencintai...",
    "Bahkan gagal dan bangkit kembali. Tidak ada jalan yang salah, hanya konsekuensi.",
    "Tidak semua akan berhasil. Dunia ini kejam bagi yang malas, tapi emas bagi yang berusaha.",
    "Namun mereka yang mampu bertahan, akan membawa pulang hal paling berharga: Pemahaman Hidup.",
    "Selamat datang di Nusantara Arsa.",
    "Hidupmu. Pilihanmu. Bangkitlah!"
];

let prologueTimeout; // Variable to hold the timer
let prologueIndex = 0; // Track index globally for skipping

function startPrologue() {
    document.getElementById('login-screen').style.display = 'none';
    const screen = document.getElementById('prologue-screen');
    const textEl = document.getElementById('prologue-text');
    const skipBtn = document.getElementById('skip-prologue-btn');
    
    screen.style.display = 'flex';
    skipBtn.style.display = 'block'; // Show skip button
    STATE.screen = 'prologue';
    
    prologueIndex = 0;
    
    function showNextLine() {
        if(prologueIndex >= prologueTexts.length) {
            skipPrologue(); // Done naturally
            return;
        }

        // Fade Out Text
        textEl.style.opacity = 0;
        
        // Hentikan timer sebelumnya jika ada (Safety)
        if(prologueTimeout) clearTimeout(prologueTimeout);
        
        // Tunggu fade out selesai (500ms)
        prologueTimeout = setTimeout(() => {
            // FIX: SYNC GAMBAR & TEKS
            // Preload gambar dulu, baru tampilkan teks setelah gambar siap
            const imgNum = prologueIndex + 1;
            const imgSrc = `images/scene-${imgNum}.png`;
            const img = new Image();
            
            let isRendered = false; // Flag agar tidak jalan 2x

            // Fungsi untuk menampilkan scene (Gambar + Teks)
            const renderScene = () => {
                if(isRendered) return;
                isRendered = true;

                // Cek jika user keburu skip saat loading
                if(STATE.screen !== 'prologue') return;

                // 1. Update Text
                textEl.innerText = prologueTexts[prologueIndex];
                
                // 2. Update Background (Gambar sudah ter-cache browser karena preload)
                screen.style.backgroundImage = `linear-gradient(rgba(0,0,0,0.5), rgba(0,0,0,0.5)), url('${imgSrc}')`;
                
                // 3. Fade In Text
                textEl.style.opacity = 1;
                
                prologueIndex++;
                
                // 4. Jadwalkan baris berikutnya (5 Detik)
                prologueTimeout = setTimeout(showNextLine, 5000); 
            };

            // Event Listeners
            img.onload = renderScene;
            img.onerror = () => {
                console.warn(`Scene image missing/error: ${imgSrc}`);
                renderScene(); // Tetap jalan walau gambar error (Fallback)
            };
            
            // Mulai Download Gambar
            img.src = imgSrc;

            // SAFETY TIMEOUT: Jika gambar loading > 3 detik (koneksi lambat), paksa jalan
            setTimeout(() => {
                if(!isRendered) {
                    console.log("Image load timeout (Slow Connection), forcing text display.");
                    renderScene();
                }
            }, 3000);

        }, 500); // Waktu transisi fade out text
    }
    
    // Mulai sequence
    showNextLine();
}

function skipPrologue() {
    clearTimeout(prologueTimeout); // Stop animation
    
    // Reset style background prologue agar tidak mengganggu screen lain (just in case)
    document.getElementById('prologue-screen').style.backgroundImage = 'none';
    
    document.getElementById('prologue-screen').style.display = 'none';
    document.getElementById('gender-screen').style.display = 'flex';
}

function selectGender(gender, fromSave = false) {
    STATE.player.gender = gender;
	 
    const avatarImg = document.getElementById('hud-avatar-img');
    if(gender === 'boy') {
        avatarImg.src = 'images/boy.png'; 
        avatarImg.onerror = function() { 
            this.src = 'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI1MCIgaGVpZ2h0PSI1MCI+PGNpcmNsZSBjeD0iMjUiIGN5PSIyNSIgcj0iMjAiIGZpbGw9IiMzYjgyZjYiLz48L3N2Zz4='; 
        };
        document.getElementById('hud-avatar-img').src = 'images/boy.png';
    } else {
        avatarImg.src = 'images/girl.png';
        avatarImg.onerror = function() {
            this.src = 'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI1MCIgaGVpZ2h0PSI1MCI+PGNpcmNsZSBjeD0iMjUiIGN5PSIyNSIgcj0iMjAiIGZpbGw9IiNlYzlhOWEiLz48L3N2Zz4=';
        };
        document.getElementById('hud-avatar-img').src = 'images/girl.png';
    }
    
	
    if(gender === 'boy') {
        STATE.player.spriteIdle = new Image(); STATE.player.spriteIdle.src = 'images/boy-idle.png';
        STATE.player.spriteWalk = new Image(); STATE.player.spriteWalk.src = 'images/boy-walk.png';
        // NEW: Load Up Sprite for Boy
        STATE.player.spriteWalkUp = new Image(); STATE.player.spriteWalkUp.src = 'images/boy-atas.png';
        // NEW: Load Down Sprite for Boy
        STATE.player.spriteWalkDown = new Image(); STATE.player.spriteWalkDown.src = 'images/boy-bawah.png';
        // NEW: Load Attack Sprite for Boy
        STATE.player.spriteAttack = new Image(); STATE.player.spriteAttack.src = 'images/boy-pukul.png';
    } else {
        STATE.player.spriteIdle = new Image(); STATE.player.spriteIdle.src = 'images/girl-idle.png';
        STATE.player.spriteWalk = new Image(); STATE.player.spriteWalk.src = 'images/girl-walk.png';
        // NEW: Load Up Sprite for Girl
        STATE.player.spriteWalkUp = new Image(); STATE.player.spriteWalkUp.src = 'images/girl-atas.png';
        // NEW: Load Down Sprite for Girl
        STATE.player.spriteWalkDown = new Image(); STATE.player.spriteWalkDown.src = 'images/girl-bawah.png';
        // NEW: Load Attack Sprite for Girl
        STATE.player.spriteAttack = new Image(); STATE.player.spriteAttack.src = 'images/girl-pukul.png';
    }
    
    if (!fromSave) {
        document.getElementById('gender-screen').style.display = 'none';
        document.getElementById('start-screen').classList.remove('hidden');
    }
}

/** * DATA SERVICE (UPDATED FOR DASHBOARD SUPPORT) */
const DataService = {
    mode: 'local', 
    user: null,
    dbKey: 'na_users_db', 
    unsubscribeMsg: null, // Listener reference
    
    // NEW: Dashboard Source Control
    dashboardSource: 'auto', // 'auto', 'cloud', 'local'

    init: async function(useFirebase) {
        // FAST CHECK: Jika navigator offline, langsung set local
        if (!navigator.onLine) {
            this.mode = 'local';
            console.log("Mode Offline Terdeteksi via Navigator");
            return false;
        }

        // FIX: Default ke local dulu, baru switch ke firebase jika sukses load
        this.mode = 'local'; 
        try {
            if (typeof firebase !== 'undefined' && firebase.apps && !firebase.apps.length) {
                firebase.initializeApp(firebaseConfig);
                if(!db) db = firebase.firestore();
                if(!analytics) analytics = firebase.analytics();
                
                // Jika sampai sini tanpa error, berarti Firebase siap
                this.mode = 'firebase';
            } else if (typeof firebase !== 'undefined' && firebase.apps && firebase.apps.length) {
                // Sudah init sebelumnya
                if(!db) db = firebase.firestore();
                this.mode = 'firebase';
            }
            return true;
        } catch (e) {
            console.error("Firebase Init Error:", e);
            this.mode = 'local';
            return false;
        }
    },

    // NEW: Function to toggle source
    toggleDashboardSource: function() {
        if (this.dashboardSource === 'auto') this.dashboardSource = 'cloud';
        else if (this.dashboardSource === 'cloud') this.dashboardSource = 'local';
        else this.dashboardSource = 'auto';
        
        return this.dashboardSource;
    },

    getDB: function() {
        try {
            const raw = localStorage.getItem(this.dbKey);
            return raw ? JSON.parse(raw) : {};
        } catch (e) {
            console.error("Database Corrupt! Resetting...", e);
            localStorage.removeItem(this.dbKey); 
            return {};
        }
    },
    
    saveDB: function(db) {
        localStorage.setItem(this.dbKey, JSON.stringify(db));
    },
    
    // --- FIX: RESET DATA SEKARANG MEMBERSIHKAN CLOUD DAN LOCAL STORAGE ---
    resetSaveData: async function() {
        if(!this.user) return;
        
        // 1. Reset Cloud (Jika Mode Firebase/Online)
        if(this.mode === 'firebase' && db) {
            try {
                // UPDATE: Kirim "Tiket Reset" dengan timestamp TERBARU.
                // Ini memaksa semua device lain (yang punya data lama) untuk sadar bahwa data ini sudah di-wipe.
                await db.collection('users').doc(this.user.email).set({ 
                    saveData: { isReset: true, lastActive: Date.now() } 
                }, { merge: true });
            } catch (e) {
                console.error("Gagal reset data cloud:", e);
            }
        }
        
        // 2. Reset Local Storage (WAJIB DILAKUKAN AGAR CHECK SESSION SAAT RELOAD BERSIH)
        const dbLocal = this.getDB();
        if(dbLocal[this.user.email]) {
            dbLocal[this.user.email].saveData = null; 
            this.saveDB(dbLocal);
        }
        
        // 3. Reset Memory
        if(this.user) this.user.saveData = null;
    },

    /* FIX: PERBAIKAN FUNGSI RESET DATA SISWA (ADMIN) AGAR LEBIH ROBUST */
    adminResetStudent: async function(studentEmail) {
        // 1. Coba paksa koneksi Cloud dulu agar yakin tidak offline
        await this.init(true);

        if(this.mode === 'firebase' && db) {
            try {
                // UPDATE: Jangan delete field, tapi timpa dengan OBJECT RESET + TIMESTAMP BARU.
                // Tujuannya agar 'lastActive' di cloud menjadi LEBIH BARU dari data lokal siswa.
                // Saat siswa login, sistem sync akan melihat Cloud lebih baru -> mengambil object reset -> menghapus data lokal.
                await db.collection('users').doc(studentEmail).update({
                    saveData: { isReset: true, lastActive: Date.now() }
                });
                return { success: true, type: 'cloud' };
            } catch (e) {
                console.error("Gagal reset data cloud:", e);

                // --- DETEKSI ERROR PERMISSION (RULES EXPIRED) ---
                if (e.code === 'permission-denied') {
                    return { 
                        success: false, 
                        msg: " AKSES DITOLAK FIREBASE!\n\nKemungkinan 'Test Mode' database Anda sudah kadaluwarsa (Expired 30 Hari).\n\nSOLUSI: Buka Firebase Console -> Firestore Database -> Tab 'Rules', lalu ubah menjadi:\n\nallow read, write: if true;" 
                    };
                }
                
                // Fallback: Jika dokumen tidak ada atau update gagal, coba set merge null
                try {
                     await db.collection('users').doc(studentEmail).set({ saveData: null }, { merge: true });
                     return { success: true, type: 'cloud_fallback' };
                } catch (e2) {
                     return { success: false, msg: "Koneksi Cloud Gagal: " + e.message };
                }
            }
        } 
        else {
            // Fallback ke Local jika mode offline
            const dbLocal = this.getDB();
            if(dbLocal[studentEmail]) {
                dbLocal[studentEmail].saveData = null; 
                this.saveDB(dbLocal);
                return { success: true, type: 'local' };
            }
            return { success: false, msg: "User tidak ditemukan di Local Storage & Cloud tidak terhubung." };
        }
    },

    /* NEW: FUNGSI HAPUS AKUN SISWA (ADMIN - PERMANEN) */
    adminDeleteStudent: async function(studentEmail) {
        await this.init(true);

        if(this.mode === 'firebase' && db) {
            try {
                // Hapus dokumen user sepenuhnya dari koleksi 'users'
                await db.collection('users').doc(studentEmail).delete();
                return { success: true, type: 'cloud' };
            } catch (e) {
                console.error("Gagal hapus akun cloud:", e);
                return { success: false, msg: "Gagal menghapus dari Cloud: " + e.message };
            }
        } 
        else {
            // Hapus dari Local Storage
            const dbLocal = this.getDB();
            if(dbLocal[studentEmail]) {
                delete dbLocal[studentEmail]; // Hapus key email sepenuhnya
                this.saveDB(dbLocal);
                return { success: true, type: 'local' };
            }
            return { success: false, msg: "User tidak ditemukan di Local Storage." };
        }
    },

    getAllStudents: async function() {
        // UPDATE: Logika pengambilan data berdasarkan Role User yang Login
        // Jika Admin: Ambil SEMUA user (Guru & Siswa)
        // Jika Guru: Ambil HANYA Siswa
        const isAdmin = this.user && this.user.role === 'admin';

        if(this.mode === 'local') {
            const dbLocal = this.getDB();
            if (isAdmin) {
                return Object.values(dbLocal); // Semua data lokal
            } else {
                return Object.values(dbLocal).filter(u => u.role === 'siswa');
            }
        } else {
            try {
                let query = db.collection('users');
                
                // Jika bukan admin (berarti guru), filter hanya siswa
                if (!isAdmin) {
                    query = query.where('role', '==', 'siswa');
                }

                const snapshot = await query.get();
                return snapshot.docs.map(doc => {
                    return { email: doc.id, ...doc.data() };
                });
            } catch (e) {
                console.error("Gagal mengambil data users:", e);
                const dbLocal = this.getDB();
                if (isAdmin) return Object.values(dbLocal);
                return Object.values(dbLocal).filter(u => u.role === 'siswa');
            }
        }
    },

    // --- FIX: SEND MESSAGE (HYBRID SUPPORT) ---
    sendMessage: async function(studentEmail, msg) {
        const msgObj = {
            text: msg, read: false, time: Date.now()
        };

        if (this.mode === 'local' || !navigator.onLine) {
            const dbLocal = this.getDB();
            if(dbLocal[studentEmail]) {
                if(!dbLocal[studentEmail].inbox) dbLocal[studentEmail].inbox = [];
                dbLocal[studentEmail].inbox.push(msgObj);
                this.saveDB(dbLocal);
                return true;
            }
            return false;
        } else {
            try {
                // Gunakan arrayUnion untuk atomicity di Firebase
                await db.collection('users').doc(studentEmail).update({
                    inbox: firebase.firestore.FieldValue.arrayUnion(msgObj)
                });
                return true;
            } catch(e) {
                console.warn("Gagal kirim pesan cloud, fallback local", e);
                return false;
            }
        }
    },

    // --- NEW: LISTENER PESAN UNTUK SISWA (UPDATED: SUPPORT LOCAL POLLING & REMOTE RESET) ---
    startMessageListener: function() {
        if(!this.user || this.user.role !== 'siswa') return;
        
        // Hentikan listener lama jika ada
        if(this.unsubscribeMsg) {
            if (typeof this.unsubscribeMsg === 'function') this.unsubscribeMsg();
            else clearInterval(this.unsubscribeMsg);
            this.unsubscribeMsg = null;
        }

        console.log(`Memulai Listener Pesan & Sync (${this.mode})...`);
        
        if (this.mode === 'firebase' && db) {
            // --- MODE CLOUD: REALTIME SNAPSHOT ---
            this.unsubscribeMsg = db.collection('users').doc(this.user.email).onSnapshot((doc) => {
                const data = doc.data();
                
                // --- NEW: DETEKSI REMOTE RESET (FITUR PENTING) ---
                // Jika Guru menghapus saveData di server (data.saveData === undefined/null)
                // TAPI siswa sedang berada di dalam game (STATE.screen === 'play' / bukan prologue)
                // MAKA: Paksa Reset Client Siswa.
                if (data && !data.saveData && typeof STATE !== 'undefined' && STATE.screen !== 'splash' && STATE.screen !== 'title' && !STATE.isPrologue) {
                    console.warn(" REMOTE RESET DETECTED! GURU MENGHAPUS DATA.");
                    
                    // 1. Hentikan Auto Save agar tidak menimpa penghapusan guru
                    if(window.saveIntervalId) clearInterval(window.saveIntervalId);
                    
                    // 2. Hapus sesi lokal agar bersih total
                    localStorage.removeItem(SESSION_KEY);
                    DataService.user = null;
                    
                    // 3. Tampilkan Pesan & Reload
                    alert(" PERINGATAN SISTEM \n\nData permainan Anda telah di-reset oleh Guru/Admin.\nGame akan dimuat ulang ke awal.");
                    location.reload();
                    return;
                }

                this.processInbox(data); 
            });
        } else {
            // --- MODE LOCAL: POLLING INTERVAL ---
            this.unsubscribeMsg = setInterval(() => {
                const dbLocal = this.getDB();
                const myData = dbLocal[this.user.email];
                
                // Cek Reset Lokal juga (jika dihapus via inspect element/tab lain)
                if (myData && !myData.saveData && typeof STATE !== 'undefined' && STATE.screen === 'play' && !STATE.isPrologue) {
                     if(window.saveIntervalId) clearInterval(window.saveIntervalId);
                     alert(" Data lokal hilang/reset. Game akan dimuat ulang.");
                     location.reload();
                     return;
                }
                
                this.processInbox(myData);
            }, 3000);
        }
    },

    // --- NEW: LISTENER MULTIPLAYER (HANTU) ---
    startGhostListener: function() {
        // --- DATA BOT HANTU (BAYANGAN) - POPULASI DESA ---
        // Akan selalu muncul untuk meramaikan suasana
        const BOT_GHOSTS = [
            // --- HANTU LAMA ---
            { email: 'bot_radian', name: 'Radian', gender: 'boy', outfit: 'default', x: 15*30, y: 20*30, location: 'village', isBot: true, vx: 0, vy: 0 },
            { email: 'bot_edy', name: 'Edy', gender: 'boy', outfit: 'armor', x: 35*30, y: 15*30, location: 'village', isBot: true, vx: 0, vy: 0 },
            { email: 'bot_rizka', name: 'Rizka', gender: 'girl', outfit: 'default', x: 25*30, y: 30*30, location: 'village', isBot: true, vx: 0, vy: 0 },
            { email: 'bot_manohara', name: 'Manohara', gender: 'girl', outfit: 'wedding', x: 45*30, y: 10*30, location: 'village', isBot: true, vx: 0, vy: 0 },
            
            // --- HANTU BARU (BOYS) ---
            { email: 'bot_authar', name: 'Authar', gender: 'boy', outfit: 'special', x: 12*30, y: 12*30, location: 'village', isBot: true, vx: 0, vy: 0 }, // Dekat Papan Misi
            { email: 'bot_fani', name: 'Fani', gender: 'boy', outfit: 'default', x: 42*30, y: 25*30, location: 'village', isBot: true, vx: 0, vy: 0 },   // Dekat Guild
            { email: 'bot_budi_s', name: 'Budi', gender: 'boy', outfit: 'default', x: 38*30, y: 18*30, location: 'village', isBot: true, vx: 0, vy: 0 }, // Dekat Perpus
            { email: 'bot_andy', name: 'Andy', gender: 'boy', outfit: 'armor', x: 48*30, y: 20*30, location: 'village', isBot: true, vx: 0, vy: 0 },     // Dekat Dungeon

            // --- HANTU BARU (GIRLS) ---
            { email: 'bot_citra', name: 'Citra', gender: 'girl', outfit: 'special', x: 26*30, y: 24*30, location: 'village', isBot: true, vx: 0, vy: 0 }, // Dekat Merchant
            { email: 'bot_milea', name: 'Milea', gender: 'girl', outfit: 'default', x: 20*30, y: 28*30, location: 'village', isBot: true, vx: 0, vy: 0 }, // Dekat Patung
            { email: 'bot_ancika', name: 'Ancika', gender: 'girl', outfit: 'default', x: 43*30, y: 35*30, location: 'village', isBot: true, vx: 0, vy: 0 }, // Dekat Dermaga
            { email: 'bot_luna', name: 'Luna', gender: 'girl', outfit: 'wedding', x: 20*30, y: 15*30, location: 'village', isBot: true, vx: 0, vy: 0 }    // Dekat Klinik
        ];

        console.log(" Mengaktifkan Radar Multiplayer & Bot Crowd...");

        // Fungsi Helper untuk Update State
        const updateGhostsState = (realPlayers = []) => {
            if (typeof STATE !== 'undefined') {
                // Gabungkan Pemain Asli + Semua Bot
                STATE.ghosts = [...realPlayers, ...BOT_GHOSTS];
                // console.log(`Ghosts Updated: ${realPlayers.length} Real + ${BOT_GHOSTS.length} Bots`);
            }
        };

        if (this.mode !== 'firebase' || !db) {
            // JIKA OFFLINE: Tetap tampilkan Bot agar tidak sepi
            updateGhostsState([]);
            return;
        }
        
        // JIKA ONLINE: Dengarkan DB
        try {
            this.unsubscribeGhosts = db.collection('users')
                .where('role', '==', 'siswa')
                .onSnapshot((snapshot) => {
                    const now = Date.now();
                    const onlineGhosts = [];
                    
                    snapshot.forEach(doc => {
                        // Jangan masukkan diri sendiri
                        if (this.user && doc.id === this.user.email) return;

                        const data = doc.data();
                        if (!data.saveData) return;

                        const lastActive = data.lastActive || (data.saveData ? data.saveData.lastActive : 0);
                        
                        // Cek Online: Aktif dalam 2 menit terakhir (Dilonggarkan biar awet)
                        if (now - lastActive < 120000) { 
                             onlineGhosts.push({
                                 email: doc.id,
                                 name: data.name || "Siswa",
                                 x: data.saveData.x || 0,
                                 y: data.saveData.y || 0,
                                 location: data.saveData.location || 'village',
                                 gender: data.saveData.gender || 'boy',
                                 outfit: data.saveData.outfit || 'default',
                                 role: data.saveData.role || 'none',
                                 isBot: false
                             });
                        }
                    });
                    
                    updateGhostsState(onlineGhosts);
                });
        } catch (e) {
            console.warn("Gagal init multiplayer, fallback ke bot only:", e);
            updateGhostsState([]);
        }
    },
	
	
	
	// Helper untuk memproses pesan masuk (Digunakan oleh Cloud & Local)
    processInbox: function(data) {
        // Cek apakah ada pesan baru di 'inbox'
        if(data && data.inbox && data.inbox.length > 0) {
            const newMsgs = data.inbox;
            console.log("Pesan diterima:", newMsgs);

            // Masukkan ke State Game
            if(typeof STATE !== 'undefined' && STATE.player) {
                if(!STATE.player.messages) STATE.player.messages = [];
                
                // Gabungkan pesan
                STATE.player.messages.push(...newMsgs);
                
                // Notifikasi UI
                showToast(` ${newMsgs.length} PESAN BARU DARI GURU!`);
                if(typeof AudioService !== 'undefined') AudioService.playSFX('item');
                
                // Update Badge Kotak Surat jika terlihat
                // (Logic drawObject akan menangani visualnya di frame berikutnya)

                // BERSIHKAN INBOX DI SUMBER DATA (Agar tidak didownload ulang)
                if (this.mode === 'firebase' && db) {
                    db.collection('users').doc(this.user.email).update({
                        inbox: firebase.firestore.FieldValue.delete()
                    }).catch(err => console.log("Gagal clear cloud inbox", err));
                } else {
                    // Bersihkan Local Storage Inbox
                    const dbLocal = this.getDB();
                    if(dbLocal[this.user.email]) {
                        dbLocal[this.user.email].inbox = []; 
                        this.saveDB(dbLocal);
                    }
                }
                
                // Trigger Auto Save Game untuk menyimpan pesan permanen di saveData pemain
                if (typeof manualSave === 'function') manualSave();
            }
        }
    },

    getTeachers: async function() {
        // Cek mode terlebih dahulu atau timeout cepat
        if (this.mode === 'local' || !navigator.onLine) {
            const dbLocal = this.getDB();
            return Object.values(dbLocal)
                .filter(u => u.role === 'guru')
                .map(u => ({
                    email: Object.keys(dbLocal).find(key => dbLocal[key] === u),
                    name: u.name,
                    school: u.school || 'Unknown School'
                }));
        } else {
            try {
                // Timeout dipercepat untuk list guru (2 detik)
                const timeout = new Promise((_, reject) => setTimeout(() => reject(new Error("Timeout")), 2000));
                const snapshot = await Promise.race([
                    db.collection('users').where('role', '==', 'guru').get(),
                    timeout
                ]);
                
                return snapshot.docs.map(doc => {
                    const d = doc.data();
                    return { email: doc.id, name: d.name, school: d.school || 'Unknown School' };
                });
            } catch(e) {
                console.warn("Gagal fetch guru cloud, fallback local");
                const dbLocal = this.getDB();
                return Object.values(dbLocal).filter(u => u.role === 'guru').map(u => ({
                    email: Object.keys(dbLocal).find(key => dbLocal[key] === u), 
                    name: u.name, 
                    school: u.school || 'Unknown'
                }));
            }
        }
    },

    register: async function(role, data) {
        const userData = {
            role: role,
            password: data.password, 
            name: data.name,
            details: data.details, 
            school: data.school || null, 
            mentor: data.mentor || null, 
            saveData: null 
        };

        if (this.mode === 'local' || !navigator.onLine) {
            const dbLocal = this.getDB();
            if(dbLocal[data.email]) return { success: false, msg: "Email already registered (Local)!" };
            dbLocal[data.email] = userData;
            this.saveDB(dbLocal);
            return { success: true, msg: "Registrasi Lokal Berhasil!" };
        } else {
            try {
                const docRef = db.collection('users').doc(data.email);
                
                // TIMEOUT DIPERCEPAT: 3 Detik
                const timeout = new Promise((_, reject) => 
                    setTimeout(() => reject(new Error("Koneksi Timeout (Terlalu Lama)")), 3000)
                );

                const doc = await Promise.race([docRef.get(), timeout]);
                
                if (doc.exists) return { success: false, msg: "Email already registered in Cloud!" };
                await docRef.set(userData);
                return { success: true, msg: "Cloud Registration Success!" };
            } catch (e) {
                console.warn("Cloud Register Failed, Fallback Local", e);
                const dbLocal = this.getDB();
                if(dbLocal[data.email]) return { success: false, msg: "Email already registered (Local)!" };
                dbLocal[data.email] = userData;
                this.saveDB(dbLocal);
                this.mode = 'local'; 
                return { success: true, msg: "Server Sibuk. Akun dibuat secara LOKAL (Offline)." };
            }
        }
    },

    login: async function(email, password) {
        // 1. Cek Koneksi Fisik Browser
        if (!navigator.onLine) this.mode = 'local';

        // Ambil data lokal untuk perbandingan nanti
        const dbLocal = this.getDB();
        const localUser = dbLocal[email];

        // FIX: Pastikan DB ada jika mode firebase. Jika tidak, paksa local.
        if (this.mode === 'firebase' && !db) {
            console.warn("Mode Firebase aktif tapi DB tidak terhubung. Fallback ke Local.");
            this.mode = 'local';
        }

        if (this.mode === 'local') {
            const user = localUser;
            if(!user) return { success: false, msg: "User tidak ditemukan di data lokal (Offline)!" };
            if(user.password !== password) return { success: false, msg: "Password salah!" };
            this.user = { email: email, ...user };
            return { success: true, user: this.user };
        } else {
            try {
                // PERBAIKAN: Timeout dikurangi drastis jadi 2.5 Detik agar 'fail-fast'
                const docRef = db.collection('users').doc(email);
                
                const timeout = new Promise((_, reject) => 
                    setTimeout(() => reject(new Error("Server Timeout")), 2500)
                );

                // Balapan antara ambil data vs timeout
                const doc = await Promise.race([docRef.get(), timeout]);
                
                if (!doc.exists) return { success: false, msg: "Akun tidak ditemukan di Server!" };
                
                let cloudUser = doc.data();
                if (cloudUser.password !== password) return { success: false, msg: "Password salah!" };

                // --- NEW: SMART SYNC (CLOUD vs LOCAL CONFLICT RESOLUTION) ---
                // Cek data mana yang lebih baru berdasarkan 'lastActive' timestamp
                let finalUser = cloudUser;
                let useLocal = false;

                if (localUser && localUser.saveData) {
                    const localTime = localUser.saveData.lastActive || 0;
                    const cloudTime = (cloudUser.saveData && cloudUser.saveData.lastActive) || 0;

                    // FIX: CEK APAKAH CLOUD ADALAH DATA RESET?
                    // Jika Cloud punya flag 'isReset', maka Cloud SELALU MENANG (karena itu perintah wipe).
                    const isCloudReset = cloudUser.saveData && cloudUser.saveData.isReset;

                    if (!isCloudReset && localTime > cloudTime) {
                        console.log(" Konflik Data: Menggunakan Data LOKAL (Lebih Baru)");
                        finalUser = localUser;
                        useLocal = true;
                        
                        // Auto-Sync balik ke Cloud secara background
                        docRef.set({
                            ...localUser,
                            lastActive: Date.now() 
                        }, { merge: true }).catch(e => console.warn("Background sync failed:", e));
                        
                    } else {
                        console.log(" Data Cloud Sinkron/Lebih Baru/Reset. Update Lokal.");
                        
                        // FIX: JIKA DATA CLOUD ADALAH 'RESET TICKET', BERSIHKAN LOCAL JUGA
                        if (isCloudReset) {
                            console.log(" MENDETEKSI PERINTAH RESET DARI CLOUD!");
                            cloudUser.saveData = null; // Hapus flag reset dari memori user aktif
                        }

                        // Update Local Storage agar sinkron dengan Cloud terbaru
                        dbLocal[email] = cloudUser;
                        this.saveDB(dbLocal);
                        finalUser = cloudUser; // Pastikan pakai cloud (yang sudah null/bersih)
                    }
                } else {
                    // Tidak ada data lokal, simpan data cloud ke lokal
                    // Cek juga reset flag disini
                    if (cloudUser.saveData && cloudUser.saveData.isReset) {
                        cloudUser.saveData = null;
                    }
                    
                    console.log(" Mengunduh Save Data dari Cloud...");
                    dbLocal[email] = cloudUser;
                    this.saveDB(dbLocal);
                    finalUser = cloudUser;
                }

                this.user = { email: email, ...finalUser };
                return { success: true, user: this.user };

            } catch (e) {
                console.warn("Login Error / Offline, trying local fallback...", e);
                
                // FITUR ANTI-STUCK: Cek Local Storage jika Server Error/Offline
                if(localUser && localUser.password === password) {
                    this.mode = 'local'; // Paksa pindah ke Local Mode
                    this.user = { email: email, ...localUser };
                    return { success: true, user: this.user, msg: " Masuk dalam Mode Offline (Server tidak terjangkau)" };
                }

                // Jika di local juga tidak ada, berarti memang belum register
                return { success: false, msg: "Gagal Login: Koneksi bermasalah atau Akun belum terdaftar." };
            }
        }
    },

    saveGame: async function(gameState) {
        if(!this.user) return;
        
        // Pastikan timestamp selalu terupdate saat save
        gameState.lastActive = Date.now();

        const dbLocal = this.getDB();
        if(!dbLocal[this.user.email]) {
             dbLocal[this.user.email] = { ...this.user, saveData: gameState };
        } else {
             const existing = dbLocal[this.user.email].saveData || {};
             dbLocal[this.user.email].saveData = { ...existing, ...gameState, lastActive: Date.now() };
        }
        this.saveDB(dbLocal);

        if (navigator.onLine) {
            try {
                const syncData = {
                    saveData: gameState,
                    role: this.user.role,
                    name: this.user.name,
                    details: this.user.details,
                    email: this.user.email,
                    password: this.user.password, 
                    lastActive: Date.now()
                };

                if(this.user.mentor) syncData.mentor = this.user.mentor;
                if(this.user.school) syncData.school = this.user.school;

                await db.collection('users').doc(this.user.email).set(syncData, { merge: true });
                
                if(this.mode === 'local') {
                    console.log("Koneksi Kembali: Auto-Sync ke Cloud Berhasil!");
                    this.mode = 'firebase';
                    // Restart listener jika koneksi kembali
                    if(this.user.role === 'siswa') this.startMessageListener();
                }
            } catch (e) {
                this.mode = 'local';
            }
        } else {
            this.mode = 'local'; 
        }
    },

    loadGame: function() {
        if(!this.user || !this.user.saveData) return null;
        return this.user.saveData;
    },

    // --- NEW: REAL-TIME MONITORING LISTENER ---
    subscribeToStudents: function(onUpdate) {
        let useCloud = false;

        // NEW: Logic Source Selection
        if (this.dashboardSource === 'cloud') {
            useCloud = true;
        } else if (this.dashboardSource === 'local') {
            useCloud = false;
        } else {
            // AUTO: Gunakan Cloud jika tersedia
            useCloud = (navigator.onLine && typeof firebase !== 'undefined' && db);
        }

        // Update UI Status Koneksi di Dashboard
        const statusEl = document.getElementById('dash-connection-status');
        if(statusEl) {
            if(useCloud) {
                statusEl.innerHTML = ' CLOUD ONLINE<br><span style="font-weight:normal; opacity:0.8;">Data Server</span>';
                statusEl.style.color = '#4ade80'; // Hijau
                statusEl.style.border = '1px solid #22c55e';
            } else {
                statusEl.innerHTML = ' LOCAL VIEW<br><span style="font-weight:normal; opacity:0.8;">Data Lokal</span>';
                statusEl.style.color = '#fbbf24'; // Kuning/Orange
                statusEl.style.border = '1px solid #f59e0b';
            }
        }

        const isAdmin = this.user && this.user.role === 'admin';

        if (!useCloud) {
            // Fallback untuk mode offline/lokal: Gunakan Polling Interval
            const interval = setInterval(() => {
                const dbLocal = this.getDB();
                let users = Object.values(dbLocal);
                
                // Filter jika bukan admin
                if (!isAdmin) {
                    users = users.filter(u => u.role === 'siswa');
                }

                // Tambahkan flag source untuk UI
                users.forEach(s => s._source = 'local');
                onUpdate(users);
            }, 2000); // Update tiap 2 detik
            return () => clearInterval(interval); // Return fungsi unsubscribe
        } else {
            // Firebase Real-time Listener (onSnapshot)
            try {
                let query = db.collection('users');
                
                // Filter query jika bukan admin
                if (!isAdmin) {
                    query = query.where('role', '==', 'siswa');
                }

                return query.onSnapshot((snapshot) => {
                        const users = snapshot.docs.map(doc => ({ email: doc.id, ...doc.data(), _source: 'cloud' }));
                        onUpdate(users);
                    }, (error) => {
                        console.error("Monitoring Error:", error);
                        // Jika error permission/koneksi, fallback ke lokal
                        if(statusEl) {
                            statusEl.innerHTML = ' KONEKSI TERPUTUS';
                            statusEl.style.color = '#ef4444';
                        }
                    });
            } catch(e) {
                console.warn("Snapshot failed, fallback to local polling", e);
                return () => {};
            }
        }
    }
};

/** UI LOGIC FOR LOGIN */
// --- FIX: MENAMBAHKAN VARIABEL DAN FUNGSI SWITCH ROLE YANG HILANG ---
let authMode = 'login';
let currentRole = 'siswa';
let teacherMonitorUnsub = null; // Variabel global untuk menyimpan unsubscribe listener monitoring
let latestStudentData = []; // NEW: Cache Data Siswa Live untuk Dashboard

function switchRole(role) {
    currentRole = role;
    
    // 1. Update Tampilan Tab (Warna Active)
    document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
    document.getElementById('tab-' + role).classList.add('active');
    
    // 2. Ganti Form yang Tampil (Siswa vs Guru vs Admin)
    document.getElementById('form-siswa').style.display = 'none';
    document.getElementById('form-guru').style.display = 'none';
    document.getElementById('form-admin').style.display = 'none';
    
    document.getElementById('form-' + role).style.display = 'block';
    
    // 3. Atur Visibilitas Tombol Register (Admin tidak bisa register via UI)
    const authSwitch = document.querySelector('.auth-switch');
    if (role === 'admin') {
        authSwitch.style.display = 'none';
    } else {
        authSwitch.style.display = 'block';
        // Pastikan Field Register Tampil/Sembunyi Sesuai Mode Saat Ini
        const display = authMode === 'register' ? 'block' : 'none';
        
        // Hide all register fields first
        document.getElementById('register-fields-siswa').style.display = 'none';
        document.getElementById('register-fields-guru').style.display = 'none';
        
        // Show relevant one
        if(role !== 'admin') {
            document.getElementById('register-fields-' + role).style.display = display;
        }
    }
    
    // 4. Jika sedang mode Register Siswa, muat data Guru Pendamping
    if(role === 'siswa' && authMode === 'register') {
        populateTeacherSelect();
    }
}

function logout() {
    if(window.gameLoopId) { 
        cancelAnimationFrame(window.gameLoopId); 
        window.gameLoopId = null; 
    }
    if(window.saveIntervalId) { 
        clearInterval(window.saveIntervalId); 
        window.saveIntervalId = null; 
    }
    
    // Stop Message Listener (Siswa)
    if(DataService.unsubscribeMsg) {
        DataService.unsubscribeMsg();
        DataService.unsubscribeMsg = null;
    }

    // Stop Monitoring Listener (Guru)
    if(teacherMonitorUnsub) {
        teacherMonitorUnsub();
        teacherMonitorUnsub = null;
    }

    localStorage.removeItem(SESSION_KEY);
    DataService.user = null; 
    
    if(document.getElementById('form-siswa')) document.getElementById('form-siswa').reset();
    if(document.getElementById('form-guru')) document.getElementById('form-guru').reset();

    document.getElementById('teacher-dashboard').style.display = 'none';
    document.getElementById('start-screen').classList.add('hidden');
    document.getElementById('ui-layer').classList.add('hidden'); 
    document.getElementById('game-over-screen').style.display = 'none';
    document.getElementById('ending-screen').style.display = 'none';
    document.getElementById('login-screen').style.display = 'none'; 
    document.getElementById('prologue-screen').style.display = 'none';
    document.getElementById('gender-screen').style.display = 'none';

    document.getElementById('title-screen').classList.remove('hidden');
    STATE.screen = 'title';

    if(typeof AudioService !== 'undefined' && AudioService.enabled) {
        AudioService.playBGM('opening');
    }

    showToast("Logged Out");
}

async function toggleAuthMode() {
    authMode = authMode === 'login' ? 'register' : 'login';
    const header = document.getElementById('auth-header');
    const switcher = document.querySelector('.auth-switch');
    const btns = document.querySelectorAll('.auth-btn');
    const disp = authMode === 'register' ? 'block' : 'none';
    document.getElementById('register-fields-siswa').style.display = disp;
    document.getElementById('register-fields-guru').style.display = disp;

    if(authMode === 'register') {
        header.innerText = "BUAT AKUN BARU";
        switcher.innerText = "Sudah punya akun? Login di sini";
        btns.forEach(b => b.innerText = "DAFTAR");
        if(currentRole === 'siswa') await populateTeacherSelect();
    } else {
        header.innerText = "LOGIN AKUN";
        switcher.innerText = "Buat Akun Baru";
        btns.forEach(b => b.innerText = "LOGIN");
    }
}

async function populateTeacherSelect() {
    const select = document.getElementById('siswa-guru');
    select.innerHTML = '<option value="">Loading Mentors...</option>';
    await DataService.init(true);
    const teachers = await DataService.getTeachers();
    select.innerHTML = '<option value="">Select Mentor</option>';
    if (teachers.length === 0) select.innerHTML += '<option value="" disabled>No mentors available</option>';
    teachers.forEach(t => {
        const option = document.createElement('option');
        option.value = t.email; 
        option.innerText = `${t.name} (${t.school})`;
        select.appendChild(option);
    });
}

async function handleAuth(role, btnElement) {
    let originalText = "";
    const msgEl = document.getElementById('login-msg'); // Ambil elemen pesan
    
    // Reset pesan sebelumnya
    msgEl.innerText = "";
    msgEl.style.color = "#ef4444"; // Default merah

    try {
        // 1. FITUR OTOMATIS FULLSCREEN: Trigger saat tombol ditekan
        toggleFullScreen();

        await DataService.init(true);

        // --- HANDLE ADMIN LOGIN ---
        if (role === 'admin') {
            const u = document.getElementById('admin-user').value;
            const p = document.getElementById('admin-pass').value;
            
            if(btnElement) {
                originalText = btnElement.innerText;
                btnElement.disabled = true;
                btnElement.innerText = " Sinkronisasi...";
            }

            await new Promise(r => setTimeout(r, 800));

            if (u === 'Admin1988' && p === 'Sedayu@123') {
                const adminEmail = "admin@system.local";
                // ... (Logika admin sama, disederhanakan untuk diff) ...
                // Hapus logika detail admin di sini agar fokus pada perubahan alert
                
                // GANTI LOGIKA LOGIN SUKSES DISINI:
                const dbLocal = DataService.getDB();
                let finalAdminData = { 
                    name: "Super Administrator", role: "admin", email: adminEmail, 
                    password: p, saveData: null, lastActive: Date.now()
                };
                
                // Coba ambil dari cloud, kalau gagal pakai lokal (sama seperti kode lama)
                // ... (Kode sinkronisasi admin tetap sama) ...
                
                dbLocal[adminEmail] = finalAdminData;
                DataService.saveDB(dbLocal);
                localStorage.setItem(SESSION_KEY, adminEmail);
                DataService.user = finalAdminData;
                
                // GANTI ALERT DENGAN INI:
                msgEl.style.color = "#4ade80";
                msgEl.innerText = " LOGIN ADMIN BERHASIL! Mengalihkan...";
                
                setTimeout(() => {
                    document.getElementById('login-screen').style.display = 'none';
                    initTeacherDashboard();
                }, 1000);
            } else {
                // GANTI ALERT DENGAN INI:
                msgEl.innerText = " Username atau Password Admin salah!";
            }
            
            if(btnElement && originalText) {
                btnElement.disabled = false;
                btnElement.innerText = originalText;
            }
            return; 
        }

        const email = document.getElementById(role + '-email').value;
        const pass = document.getElementById(role + '-pass').value;
        
        // GANTI ALERT VALIDASI:
        if(!email || !pass) { 
            msgEl.innerText = " Email & Password wajib diisi!"; 
            return; 
        }

        if(btnElement) {
            originalText = btnElement.innerText;
            btnElement.disabled = true;
            btnElement.innerText = " Memproses...";
            btnElement.style.opacity = "0.7";
        }

        if(authMode === 'register') {
            let name, details, school, mentor;
            if(role === 'siswa') {
                name = document.getElementById('siswa-nama').value;
                details = document.getElementById('siswa-kelas').value;
                mentor = document.getElementById('siswa-guru').value;
                if(!name || !details) { 
                    msgEl.innerText = " Lengkapi Nama & Kelas!"; // GANTI ALERT
                    throw new Error("Validation Failed"); 
                }
            } else {
                name = document.getElementById('guru-nama').value;
                details = document.getElementById('guru-nip').value;
                school = document.getElementById('guru-sekolah').value;
                if(!name || !details || !school) { 
                    msgEl.innerText = " Lengkapi Data Guru!"; // GANTI ALERT
                    throw new Error("Validation Failed");
                }
            }

            const res = await DataService.register(role, {email, password: pass, name, details, school, mentor});
            
            // GANTI ALERT HASIL REGISTRASI:
            if (res.success) {
                msgEl.style.color = "#4ade80"; // Hijau
                let extraMsg = "";
                if (res.msg.includes("LOKAL")) extraMsg = " (Mode Offline)";
                msgEl.innerText = " Registrasi Berhasil!" + extraMsg + " Silakan Login.";
                
                // Pindah ke tab login otomatis
                setTimeout(() => toggleAuthMode(), 1500);
            } else {
                msgEl.style.color = "#ef4444"; // Merah
                msgEl.innerText = " " + res.msg;
            }
            
        } else {
            const res = await DataService.login(email, pass);
            if(res.success) {
                localStorage.setItem(SESSION_KEY, email);
                document.getElementById('login-screen').style.display = 'none';
                
                if(role === 'guru') {
                    initTeacherDashboard();
                } else {
                    document.getElementById('welcome-name').innerText = res.user.name;
                    document.getElementById('welcome-class').innerText = res.user.details;
                    if(res.user.mentor) document.getElementById('welcome-mentor').innerText = "Mentor Active"; 
                    
                    if(!res.user.saveData) {
                        // New Game Logic
                        STATE.player.gender = 'boy'; 
                        STATE.day = 1;
                        STATE.isPrologue = true;
                        await manualSave(); 
                        startPrologue();
                    } else {
                        // Load Game Logic
                        manualSave();
                        document.getElementById('start-screen').classList.remove('hidden');
                    }
                }
            } else {
                // GANTI ALERT GAGAL LOGIN:
                msgEl.innerText = " " + res.msg;
            }
        }

    } catch (err) {
        if(err.message !== "Validation Failed") {
            msgEl.innerText = " Error Sistem: " + err.message; // GANTI ALERT
            console.error(err);
        }
    } finally {
        if(btnElement && originalText) {
            btnElement.disabled = false;
            btnElement.innerText = originalText;
            btnElement.style.opacity = "1";
        }
    }
}

// FIX: Ubah menjadi ASYNC dan Tambahkan AWAIT DataService.init(true)
async function initTeacherDashboard() {
    document.getElementById('teacher-dashboard').style.display = 'block';
    
    const user = DataService.user;
    const titleEl = document.getElementById('dash-main-title');
    
    // CUSTOMIZE DASHBOARD TITLE BASED ON ROLE
    if (user && user.role === 'admin') {
        titleEl.innerHTML = "ADMINISTRATOR<br>CONTROL PANEL";
        titleEl.style.color = "#ef4444"; // Merah
        titleEl.style.textShadow = "0 0 10px rgba(239, 68, 68, 0.3)";
    } else {
        titleEl.innerHTML = "TEACHER<br>COMMAND CENTER";
        titleEl.style.color = "#fbbf24"; // Emas
        titleEl.style.textShadow = "none";
    }

    // Tampilkan status connecting agar tidak bingung
    const statusEl = document.getElementById('dash-connection-status');
    if(statusEl) statusEl.innerHTML = 'Connecting to Cloud...';

    // FIX CRITICAL: Pastikan koneksi ke Cloud/Firebase sudah siap SEBELUM subscribe data
    // Masalah sebelumnya: Fungsi ini jalan duluan sebelum DB connect, jadi fallback ke lokal.
    await DataService.init(true);

    updateSourceBtnLabel(); // Update label tombol saat init
    
    // Hentikan listener lama jika ada (mencegah duplikasi)
    if(teacherMonitorUnsub) {
        teacherMonitorUnsub();
        teacherMonitorUnsub = null;
    }

    // Mulai Real-time Listener
    // Fungsi ini akan dipanggil otomatis oleh Firebase setiap ada perubahan data
    teacherMonitorUnsub = DataService.subscribeToStudents((students) => {
        updateDashboardViews(students);
    });
}

// --- NEW: FUNGSI HANDLER TOMBOL SOURCE ---
function toggleDashboardSource() {
    const newSource = DataService.toggleDashboardSource();
    updateSourceBtnLabel();
    
    // Re-init Dashboard untuk menerapkan source baru
    initTeacherDashboard(); 
}

// --- NEW: FUNGSI UPDATE TAMPILAN DASHBOARD (DIPISAH AGAR BISA DIPANGGIL MANUAL) ---
function updateDashboardViews(students) {
    // 1. Simpan data terbaru ke Global Cache
    latestStudentData = students;

    // 2. Render Monitoring (Selalu update background)
    renderMonitoringTable(students);

    // 3. FIX: Refresh Halaman Aktif secara Otomatis
    // Cek halaman mana yang sedang terbuka dan render ulang dengan data baru
    const activePage = document.querySelector('.dash-page:not(.hidden)');
    if(activePage) {
        const pageId = activePage.id;
        // Panggil fungsi render tanpa 'await' karena menggunakan cached data
        if(pageId === 'page-accounts') renderAccountsList(); // NEW
        if(pageId === 'page-grading') renderGrading();
        if(pageId === 'page-reflections') renderReflections(); 
        if(pageId === 'page-validation') renderValidation();
        if(pageId === 'page-ranking') renderRanking();
        if(pageId === 'page-reset') renderResetPage();
    }
}

// --- NEW: FUNGSI MANUAL REFRESH UNTUK GURU ---
async function refreshDashboardData() {
    const btn = document.getElementById('dash-refresh-btn');
    let originalText = " Refresh Data";
    
    // Visual Loading
    if(btn) {
        originalText = btn.innerHTML;
        btn.innerHTML = " Memuat...";
        btn.disabled = true;
        btn.style.opacity = "0.7";
        btn.style.borderColor = "#fbbf24"; // Kuning loading
        btn.style.color = "#fbbf24";
    }

    try {
        // 1. Coba Re-Init Koneksi (memastikan tidak offline)
        await DataService.init(true);
        
        // 2. Tarik Data Secara Paksa
        const students = await DataService.getAllStudents();
        
        // 3. Update Tampilan
        updateDashboardViews(students);
        
        // Visual Sukses
        if(btn) {
            btn.innerHTML = " Updated";
            btn.style.borderColor = "#4ade80"; // Hijau sukses
            btn.style.color = "#4ade80";
        }
        
        // Update Status Label
        const statusEl = document.getElementById('dash-connection-status');
        if(statusEl && DataService.mode === 'firebase') {
             statusEl.innerHTML = ' CLOUD TERHUBUNG<br><span style="font-weight:normal; opacity:0.8;">Data baru saja disinkron</span>';
             statusEl.style.color = '#4ade80';
             statusEl.style.border = '1px solid #22c55e';
        }

    } catch (e) {
        console.error("Refresh Failed:", e);
        if(btn) {
            btn.innerHTML = " Gagal";
            btn.style.borderColor = "#ef4444";
            btn.style.color = "#ef4444";
        }
        alert("Gagal mengambil data terbaru. Periksa koneksi internet Anda.");
    } finally {
        // Reset Tombol setelah 2 detik
        setTimeout(() => {
            if(btn) {
                btn.innerHTML = " Refresh Data";
                btn.disabled = false;
                btn.style.opacity = "1";
                btn.style.borderColor = "rgba(59, 130, 246, 0.4)"; // Kembali Biru
                btn.style.color = "#93c5fd";
            }
        }, 2000);
    }
}

function showDashPage(page) {
    document.querySelectorAll('.dash-page').forEach(el => el.classList.add('hidden'));
    document.getElementById('page-'+page).classList.remove('hidden');
    document.querySelectorAll('.dash-nav li').forEach(el => el.classList.remove('active'));
    
    // Cari elemen li yang diklik, atau default jika dipanggil manual
    const activeLi = Array.from(document.querySelectorAll('.dash-nav li')).find(li => li.innerText.toLowerCase().includes(page)) || event?.currentTarget;
    if(activeLi) activeLi.classList.add('active');
    
    // Render Immediately using Cache
    if(page === 'accounts') renderAccountsList(); // NEW
    if(page === 'grading') renderGrading();
    if(page === 'reflections') renderReflections();
    if(page === 'validation') renderValidation(); 
    if(page === 'reset') renderResetPage();
    if(page === 'ranking') renderRanking(); 
}

// --- NEW: RENDER DAFTAR AKUN (DATABASE) ---
function renderAccountsList() {
    const users = latestStudentData || []; // Gunakan Cache (sekarang berisi semua user jika admin)
    const tbody = document.getElementById('accounts-body');
    if (!tbody) return; 
    
    tbody.innerHTML = '';
    
    // Update Header Tabel khusus Admin
    const thead = document.querySelector('#page-accounts thead tr');
    if (thead) {
        if (DataService.user.role === 'admin') {
            thead.innerHTML = `
                <th style="width: 40px;">No</th>
                <th>Nama Pengguna</th>
                <th>Email / ID</th>
                <th>Role & Status</th>
                <th>Detail Info</th>
                <th>Aksi</th>
            `;
        } else {
            // Header Guru
            thead.innerHTML = `
                <th style="width: 40px;">No</th>
                <th>Nama Lengkap</th>
                <th>Email (ID Login)</th>
                <th>Kelas / Detail</th>
                <th>Mentor</th>
                <th>Status Data</th>
            `;
        }
    }
    
    if (users.length === 0) {
        const sourceMode = DataService.dashboardSource === 'auto' ? (navigator.onLine ? 'CLOUD' : 'LOCAL') : DataService.dashboardSource.toUpperCase();
        tbody.innerHTML = `<tr><td colspan="6" style="text-align:center; padding:20px; color:#94a3b8;">
            Belum ada data ditemukan (Mode: ${sourceMode}).
        </td></tr>`;
        return;
    }

    try {
        const sortedUsers = [...users].sort((a, b) => {
            // Sort by Role first (Admin > Guru > Siswa), then Name
            const roleScore = (r) => r === 'admin' ? 3 : (r === 'guru' ? 2 : 1);
            const scoreA = roleScore(a.role);
            const scoreB = roleScore(b.role);
            
            if (scoreA !== scoreB) return scoreB - scoreA; // Descending (Admin top)
            
            const nameA = (a.name || "").toUpperCase();
            const nameB = (b.name || "").toUpperCase();
            if (nameA < nameB) return -1;
            if (nameA > nameB) return 1;
            return 0;
        });

        sortedUsers.forEach((u, index) => {
            const safeName = u.name || "(Tanpa Nama)";
            const safeEmail = u.email || "-";
            
            let detailsHtml = "-";
            let roleHtml = "";
            let actionHtml = "";

            // Styling berdasarkan Role
            if (u.role === 'admin') {
                roleHtml = `<span style="background:#fee2e2; color:#b91c1c; padding:2px 6px; border-radius:4px; font-weight:bold; font-size:10px; border:1px solid #fca5a5;">ADMIN</span>`;
                detailsHtml = `<span style="color:#94a3b8">System Access</span>`;
            } 
            else if (u.role === 'guru') {
                roleHtml = `<span style="background:#dbeafe; color:#1e40af; padding:2px 6px; border-radius:4px; font-weight:bold; font-size:10px; border:1px solid #93c5fd;">MENTOR</span>`;
                detailsHtml = `NIP: ${u.details || '-'}<br><small>${u.school || ''}</small>`;
                if (DataService.user.role === 'admin') {
                    actionHtml = `<button class="auth-btn" style="width:auto; padding:4px 8px; font-size:9px; background:#475569;" onclick="alert('Fitur Edit Guru Segera Hadir')">EDIT</button>`;
                }
            } 
            else { // Siswa
                // Cek status main
                let statusMain = '<span class="status-badge" style="background:#e2e8f0; color:#64748b;">Belum Main</span>';
                if (u.saveData) {
                    const lvl = u.saveData.level || 1;
                    const roleInGame = (u.saveData.role && u.saveData.role !== 'none') ? u.saveData.role.toUpperCase() : 'NOVICE';
                    statusMain = `<span class="status-badge" style="background:#dcfce7; color:#166534;">Lv ${lvl} ${roleInGame}</span>`;
                }

                roleHtml = `<span style="background:#f0fdf4; color:#15803d; padding:2px 6px; border-radius:4px; font-size:10px; border:1px solid #86efac;">SISWA</span><br>${statusMain}`;
                detailsHtml = `Kelas: ${u.details || '-'}<br><small>Mentor: ${u.mentor || '-'}</small>`;
                
                // Tombol Aksi untuk Admin/Guru
                actionHtml = `<button class="auth-btn" style="width:auto; padding:4px 8px; font-size:9px; margin:0; background:#475569;" onclick="inspectStudentData('${encodeURIComponent(JSON.stringify(u))}')"> DATA</button>`;
            }

            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td>${index + 1}</td>
                <td><strong>${safeName}</strong></td>
                <td style="font-family:monospace; color:#475569; font-size:11px;">${safeEmail}</td>
                <td>${roleHtml}</td>
                <td style="font-size:11px;">${detailsHtml}</td>
                <td>${actionHtml}</td>
            `;
            tbody.appendChild(tr);
        });
    } catch (e) {
        console.error("Render Error:", e);
        tbody.innerHTML = `<tr><td colspan="6" style="text-align:center; color:#ef4444;">Error rendering list.</td></tr>`;
    }
}

// --- NEW: RENDER DASHBOARD RANKING (PODIUM + LIST) ---
function renderRanking() { // Hapus async
    const podiumEl = document.getElementById('ranking-podium');
    const tableEl = document.getElementById('ranking-body');
    
    // podiumEl.innerHTML = '<p>Loading Data...</p>'; // Tidak perlu loading karena data instan
    tableEl.innerHTML = '';

    // 1. Gunakan Cache Data Live
    const students = latestStudentData; 
    
    const ranked = students
        .filter(s => s.saveData)
        .map(s => ({
            ...s,
            score: calculateGrade(s.saveData),
            role: s.saveData.role || 'none',
            level: s.saveData.level || 1
        }))
        .sort((a, b) => b.score - a.score);

    if (ranked.length === 0) {
        podiumEl.innerHTML = '<div style="width:100%; text-align:center; color:#94a3b8; padding:40px;">Belum ada data siswa untuk diperingkat.</div>';
        return;
    }

    // 2. Render Podium (Top 3)
    let podiumHTML = '';
    // Urutan Podium: 2 - 1 - 3 (Kiri - Tengah - Kanan)
    const podiumOrder = [1, 0, 2]; 
    
    podiumOrder.forEach(idx => {
        if (ranked[idx]) {
            const s = ranked[idx];
            const rank = idx + 1;
            const rankClass = `rank-${rank}`;
            
            // Avatar Fallback (Boy/Girl based on gender logic, default boy icon if undefined)
            // Karena data gender ada di dalam saveData, kita coba ambil
            const gender = s.saveData.gender || 'boy';
            const avatarSrc = gender === 'boy' ? 'images/boy.png' : 'images/girl.png';
            
            podiumHTML += `
                <div class="podium-item ${rankClass}">
                    <div class="podium-badge">${rank===1?'':(rank===2?'':'')}</div>
                    <img src="${avatarSrc}" class="podium-avatar" onerror="this.src='data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI1MCIgaGVpZ2h0PSI1MCI+PGNpcmNsZSBjeD0iMjUiIGN5PSIyNSIgcj0iMjAiIGZpbGw9IiMzYjgyZjYiLz48L3N2Zz4='">
                    <div class="podium-name">${s.name.split(' ')[0]}</div>
                    <div class="podium-class">${s.details}</div>
                    <div class="podium-score">${s.score}</div>
                </div>
            `;
        }
    });
    podiumEl.innerHTML = podiumHTML;

    // 3. Render Table List (Remaining)
    // FIX: Render semua data ke tabel list (bukan hanya sisanya, agar lengkap)
    ranked.forEach((s, index) => {
        const rank = index + 1;
        const role = s.role !== 'none' ? s.role.toUpperCase() : 'NOVICE';
        
        // Highlight jika Top 3
        let rowStyle = "";
        if(rank <= 3) rowStyle = "background:rgba(251, 191, 36, 0.1); font-weight:bold;";

        const tr = document.createElement('tr');
        tr.style = rowStyle;
        tr.innerHTML = `
            <td>#${rank}</td>
            <td>${s.name}</td>
            <td>${role}</td>
            <td>${s.level}</td>
            <td style="text-align:right;"><strong>${s.score}</strong></td>
        `;
        tableEl.appendChild(tr);
    });
} // FIX: TUTUP KURUNG KURAWAL YANG HILANG

// UPDATE: ASYNC MONITORING (Updated to Sync Render for Listener)
function renderMonitoringTable(students) {
    const tbody = document.getElementById('monitoring-body');
    if(!tbody) return;
    
    tbody.innerHTML = '';
    
    if(students.length === 0) {
        tbody.innerHTML = `<tr><td colspan="6" style="text-align:center; padding:20px; color:#94a3b8;">Tidak ada data siswa ditemukan di sumber ini (${DataService.dashboardSource}).</td></tr>`;
        return;
    }

    students.forEach(s => {
        // Cek apakah ada save data
        const sd = s.saveData; 
        const hasSave = sd && Object.keys(sd).length > 0;

        // Cek online status (batas toleransi 60 detik)
        const lastActive = (sd && sd.lastActive) ? sd.lastActive : 0;
        const isOnline = (Date.now() - lastActive) < 60000;
        
        // Format Time String
        let timeStr = "-";
        if (lastActive > 0) {
            const d = new Date(lastActive);
            // Format: DD/MM HH:MM
            timeStr = `${d.getDate()}/${d.getMonth()+1} ${d.getHours()}:${d.getMinutes().toString().padStart(2,'0')}`;
        }

        const tr = document.createElement('tr');
        
        // --- 1. LOGIKA TAMPILAN ROLE ---
        let roleHtml = '';
        if (!hasSave) {
            roleHtml = `<span style="font-size:9px; color:#94a3b8; font-style:italic;">(New)</span>`;
        } else if (!sd.role || sd.role === 'none') {
            roleHtml = `<span style="font-size:9px; color:#64748b;">NOVICE</span>`;
        } else {
            let roleText = sd.role.toUpperCase();
            if (sd.role === 'student' && sd.major) roleText += ` (${sd.major.substring(0,3).toUpperCase()})`;
            roleHtml = `<span style="font-size:9px; color:var(--primary); font-weight:bold;">${roleText}</span>`;
        }

        // --- 2. LOGIKA TAMPILAN LOKASI ---
        let locHtml = '<span style="color:#cbd5e1">-</span>';
        let hpStyle = "";
        let statsHtml = '<span style="color:#cbd5e1">-</span>';

        if (hasSave) {
            if (sd.location) {
                let locText = sd.location.toUpperCase();
                if (locText.includes('INTERIOR')) locText = locText.replace('_INTERIOR', ' (DLM)');
                locHtml = ` ${locText}`;
            }
            if ((sd.hp || 0) < 30) hpStyle = "color:#ef4444; font-weight:bold;";
            statsHtml = ` ${Math.floor(sd.hp||0)} <br>  ${Math.floor(sd.energy||0)}`;
        }

        // --- NEW: TOMBOL INSPECT DATA ---
        // Kita simpan data siswa di atribut data agar bisa diinspect
        const sJson = encodeURIComponent(JSON.stringify(s));

        tr.innerHTML = `
            <td>
                <strong>${s.name}</strong><br>
                <span style="font-size:9px; color:#64748b;">${s.email}</span>
            </td>
            <td>
                <div style="font-weight:bold; font-size:11px; ${isOnline ? 'color:#16a34a' : 'color:#64748b'}">${timeStr}</div>
                <span style="font-size:9px;">Day ${sd ? (sd.day||1) : '-'}</span>
            </td>
            <td>
                ${roleHtml}<br>
                <span class="status-badge ${isOnline ? 'online' : 'offline'}" style="font-size:8px; padding:2px 6px;">
                    ${isOnline ? 'ONLINE' : 'OFFLINE'}
                </span>
            </td>
            <td style="font-size:10px;">${locHtml}</td>
            <td style="${hpStyle}">
                ${statsHtml}
            </td>
            <td>
                <div style="display:flex; gap:5px;">
                    <!-- UPDATE: Menambahkan 'this' pada parameter promptTeacherMessage agar tombol terdeteksi akurat -->
                    <button class="auth-btn" style="width:auto; padding:4px 8px; font-size:10px; margin:0;" onclick="promptTeacherMessage('${s.email}', this)"></button>
                    <button class="auth-btn" style="width:auto; padding:4px 8px; font-size:10px; margin:0; background:#475569;" onclick="inspectStudentData('${sJson}')"></button>
                </div>
            </td>
        `;
        tbody.appendChild(tr);
    });
}

// --- NEW: FUNGSI INSPECT DATA ---
function inspectStudentData(encodedJson) {
    const data = JSON.parse(decodeURIComponent(encodedJson));
    const modal = document.getElementById('inspect-modal');
    const content = document.getElementById('inspect-content');
    
    // Format JSON agar cantik
    content.innerText = JSON.stringify(data, null, 2);
    modal.style.display = 'flex';
}

// FIX: Hapus fungsi renderMonitoring lama karena sudah diganti renderMonitoringTable
async function renderMonitoring() {
    // Legacy function, redirect to listener init if needed or do nothing
    // Biarkan kosong atau hapus agar tidak dipanggil setInterval lama
}

// --- NEW: FUNGSI AMBIL NAMA MENTOR (DARI EMAIL) ---
DataService.getMentorName = async function(mentorEmail) {
    if (!mentorEmail) return "Mentor Budi"; // Default

    // 1. Cek Database Lokal dulu
    const dbLocal = this.getDB();
    if (dbLocal[mentorEmail] && dbLocal[mentorEmail].name) {
        return "Mentor " + dbLocal[mentorEmail].name;
    }

    // 2. Cek Cloud (Jika Online)
    if (this.mode === 'firebase' && typeof db !== 'undefined') {
        try {
            const doc = await db.collection('users').doc(mentorEmail).get();
            if (doc.exists && doc.data().name) {
                return "Mentor " + doc.data().name;
            }
        } catch (e) {
            console.warn("Gagal ambil nama mentor dari cloud:", e);
        }
    }
    
    return "Mentor Budi"; // Fallback jika gagal
};


// UPDATE: SYNC GRADING (Menggunakan latestStudentData)
function renderGrading() {
    const students = latestStudentData; // Gunakan Cache
    const tbody = document.getElementById('grading-body');
    tbody.innerHTML = '';
    
    students.forEach(s => {
        const sd = s.saveData || {};
        const score = calculateGrade(sd);
        let rank = 'Warrior';
        if(score > 60) rank = 'Elite';
        if(score > 75) rank = 'Legend';
        if(score > 90) rank = 'Mythic';
        
        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td>${s.name}</td>
            <td>${sd.role === 'none' ? 'Novice' : sd.role}</td>
            <td>${(sd.reflections || []).length} Entries</td>
            <td>${(sd.money || 0).toLocaleString()}</td>
            <td><strong>${score}</strong></td>
            <td><span class="status-badge" style="background:#0f172a; color:#fbbf24; border:1px solid #fbbf24;">${rank}</span></td>
        `;
        tbody.appendChild(tr);
    });
}

function calculateGrade(data) {
    if(!data) return 0;
    const consistency = Math.min(100, (data.day || 1) * 20) * 0.2;
    const quest = Math.min(100, (data.money || 0) / 1000) * 0.2;
    const role = (data.role && data.role !== 'none' ? 100 : 0) * 0.2;
    const refCount = (data.reflections || []).length;
    const reflection = Math.min(100, refCount * 33) * 0.3;
    const ethics = (data.ethics || 100) * 0.1;
    return Math.floor(consistency + quest + role + reflection + ethics);
}

// UPDATE: SYNC REFLECTIONS (TAMPILAN JURNAL YANG LEBIH BAIK & LIVE)
function renderReflections() {
    const students = latestStudentData || []; // Gunakan Cache (Instant Load)
    const container = document.getElementById('reflections-container');
    container.innerHTML = '';
    
    let hasJournalData = false;

    students.forEach(s => {
        // PERBAIKAN: Ambil data reflections dengan fallback yang lebih aman
        // Cek di dalam saveData (Struktur Baru) ATAU di root (Struktur Lama/Legacy)
        const rawRefs = (s.saveData && s.saveData.reflections) ? s.saveData.reflections : (s.reflections || []);
        
        // Pastikan itu Array valid
        const refs = Array.isArray(rawRefs) ? rawRefs : [];

        if(refs.length > 0) {
            hasJournalData = true;
            const card = document.createElement('div');
            card.className = 'dash-card';
            
            // Header Card: Nama Siswa & Jumlah Jurnal
            // Gunakan s.name atau s.saveData.name sebagai fallback nama
            const sName = s.name || (s.saveData ? s.saveData.name : "Tanpa Nama");
            const sDetails = s.details || (s.saveData ? s.saveData.details : "-");

            let html = `<div style="border-bottom:1px solid #e2e8f0; padding-bottom:10px; margin-bottom:15px; display:flex; justify-content:space-between; align-items:center;">
                <div>
                    <h4 style="color:var(--primary); margin:0;">${sName}</h4>
                    <small style="color:#64748b;">${sDetails}</small>
                </div>
                <span class="status-badge" style="background:#eff6ff; color:#1d4ed8;">${refs.length} Catatan</span>
            </div>`;
            
            // Area Scrollable untuk Jurnal
            html += `<div style="max-height:400px; overflow-y:auto; padding-right:5px;">`;
            
            // Tampilkan dari yang terbaru (Reverse)
            [...refs].reverse().forEach(r => {
                // Format Tanggal Real-time (jika ada) atau fallback ke Hari Game
                let timeStr = `Waktu Server`;
                if(r.date) {
                    try {
                        timeStr = new Date(r.date).toLocaleString('id-ID', { dateStyle: 'medium', timeStyle: 'short' });
                    } catch(e) { timeStr = "Invalid Date"; }
                }
                
                html += `<div style="background:#f8fafc; border-left:4px solid var(--secondary); padding:12px; margin-bottom:12px; border-radius:4px; box-shadow:0 1px 2px rgba(0,0,0,0.05);">
                    <div style="display:flex; justify-content:space-between; font-size:11px; color:#64748b; margin-bottom:6px; font-weight:bold;">
                        <span style="color:var(--primary);"> GAME DAY ${r.day || '?'}</span>
                        <span> ${timeStr}</span>
                    </div>
                    <p style="margin:0; font-style:italic; color:#334155; font-family:'Exo 2'; line-height:1.6; white-space:pre-wrap;">"${r.text || ''}"</p>
                </div>`;
            });
            
            html += `</div>`;
            card.innerHTML = html;
            container.appendChild(card);
        }
    });

    // Tampilan jika belum ada data sama sekali
    if(!hasJournalData) {
        container.innerHTML = `<div style="text-align:center; padding:50px; color:#cbd5e1;">
            <div style="font-size:48px; margin-bottom:10px;"></div>
            <p>Belum ada data jurnal siswa yang masuk.</p>
            <p style="font-size:12px;">Total Siswa Terhubung: <strong>${students.length}</strong></p>
            <small>Siswa perlu menulis di menu "Buku Harian" di dalam game dan menekan tombol SIMPAN.</small>
        </div>`;
    }
}

// NEW: FUNCTION RENDER VALIDATION / COMPETENCY
function renderValidation() { // Hapus async
    const students = latestStudentData; // Gunakan Cache
    const tbody = document.getElementById('validation-body');
    tbody.innerHTML = '';
    
    if (students.length === 0) {
        tbody.innerHTML = '<tr><td colspan="5" style="text-align:center; padding:20px;">Belum ada data siswa.</td></tr>';
        return;
    }

    students.forEach(s => {
        const sd = s.saveData || {};
        
        // 1. ANALISIS DECISION MAKING (ROLE)
        let roleScore = 0;
        let roleText = "Belum Memilih";
        let roleColor = "#94a3b8"; // Abu-abu
        
        if(sd.role && sd.role !== 'none') {
            roleScore = 100;
            roleText = sd.role.toUpperCase();
            
            // Warna berdasarkan role
            if(sd.role === 'worker') roleColor = "#ef4444"; // Merah
            else if(sd.role === 'student') roleColor = "#3b82f6"; // Biru
            else if(sd.role === 'entrepreneur') roleColor = "#10b981"; // Hijau
            else if(sd.role === 'family') roleColor = "#d946ef"; // Pink
        }

        // 2. ANALISIS FINANCIAL LITERACY
        // Baseline: 10.000G (Modal Awal)
        // Target: 50.000G (Bagus), 100.000G (Sangat Bagus)
        const money = sd.money || 0;
        let moneyScore = 0;
        if(money >= 100000) moneyScore = 100;
        else if(money >= 50000) moneyScore = 85;
        else if(money >= 20000) moneyScore = 70;
        else if(money >= 10000) moneyScore = 60; // Standar
        else moneyScore = 40; // Defisit (Boros)

        // 3. ANALISIS SKILL DEVELOPMENT
        // Target Trial: Stat Utama mencapai 50
        let skillVal = 0;
        let skillName = "-";
        
        if(sd.role === 'worker') { skillVal = sd.str || 0; skillName = "STR"; }
        else if(sd.role === 'student') { skillVal = sd.int || 0; skillName = "INT"; }
        else if(sd.role === 'entrepreneur') { skillVal = sd.biz || 0; skillName = "BIZ"; }
        else if(sd.role === 'family') { skillVal = sd.reputation || 0; skillName = "REP"; }
        
        // Hitung persentase skill terhadap target (50)
        let skillScore = Math.min(100, Math.floor((skillVal / 50) * 100));
        
        // Rata-rata Skor Kompetensi
        const totalScore = Math.floor((roleScore + moneyScore + skillScore) / 3);
        
        // Tentukan Grade Warna
        let scoreColor = "#ef4444"; // Merah (Kurang)
        if(totalScore >= 80) scoreColor = "#10b981"; // Hijau (Baik)
        else if(totalScore >= 60) scoreColor = "#f59e0b"; // Kuning (Cukup)

        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td>
                <strong>${s.name}</strong><br>
                <span style="font-size:10px; color:#64748b;">${s.details}</span>
            </td>
            <td>
                <span style="font-size:11px; font-weight:bold; color:${roleColor}; border:1px solid ${roleColor}; padding:2px 6px; border-radius:4px;">${roleText}</span>
                <div style="font-size:10px; margin-top:2px;">Konsistensi: ${roleScore}%</div>
            </td>
            <td>
                <div style="font-weight:bold; color:#0f172a;">${money.toLocaleString('id-ID')} G</div>
                <div class="bar-container" style="width:80px; height:4px; margin-top:2px;">
                    <div style="width:${moneyScore}%; height:100%; background:#fbbf24;"></div>
                </div>
                <span style="font-size:9px; color:#64748b;">Literasi: ${moneyScore}/100</span>
            </td>
            <td>
                <div style="font-weight:bold; color:#0f172a;">${skillName}: ${skillVal}</div>
                <div class="bar-container" style="width:80px; height:4px; margin-top:2px;">
                    <div style="width:${skillScore}%; height:100%; background:#3b82f6;"></div>
                </div>
                <span style="font-size:9px; color:#64748b;">Progres: ${skillScore}%</span>
            </td>
            <td>
                <div style="font-size:18px; font-weight:900; color:${scoreColor};">${totalScore}</div>
            </td>
        `;
        tbody.appendChild(tr);
    });
}

// NEW: FUNGSI RENDER HALAMAN RESET (ASYNC UPDATE)
function renderResetPage() { // Hapus async
    const students = latestStudentData; // Gunakan Cache
    const tbody = document.getElementById('reset-body');
    tbody.innerHTML = '';
    
    if (students.length === 0) {
        tbody.innerHTML = '<tr><td colspan="5" style="text-align:center; padding:20px;">Belum ada data siswa. Pastikan siswa sudah Login dan Save setidaknya sekali.</td></tr>';
        return;
    }

    students.forEach(s => {
        const sd = s.saveData || {};
        const role = sd.role && sd.role !== 'none' ? sd.role.toUpperCase() : 'BELUM PILIH';
        const progress = `Day ${sd.day || 1} | Lv ${sd.level || 1}`;
        
        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td><strong>${s.name}</strong></td>
            <td>${s.details}</td>
            <td><span class="status-badge" style="background:#f1f5f9; color:#475569;">${role}</span></td>
            <td>${progress}</td>
            <td>
                <div style="display:flex; gap:5px;">
                    <button class="auth-btn" 
                        style="width:auto; padding:6px 12px; font-size:10px; margin:0; background:linear-gradient(90deg, #f59e0b, #d97706); border:1px solid #b45309;" 
                        onclick="confirmResetStudent('${s.email}', '${s.name}')" title="Hapus Progress (Mulai Ulang)">
                         RESET
                    </button>
                    <button class="auth-btn" 
                        style="width:auto; padding:6px 12px; font-size:10px; margin:0; background:linear-gradient(90deg, #ef4444, #b91c1c); border:1px solid #7f1d1d;" 
                        onclick="confirmDeleteStudent('${s.email}', '${s.name}')" title="Hapus Akun Permanen">
                         HAPUS
                    </button>
                </div>
            </td>
        `;
        tbody.appendChild(tr);
    });
}

// NEW: KONFIRMASI RESET (DATA)
async function confirmResetStudent(email, name) {
    const isConfirmed = confirm(` RESET PROGRESS? \n\nAnda akan menghapus SAVE DATA permainan siswa:\n"${name}"\n\nSiswa akan kembali ke awal permainan (Prologue) tapi AKUN TETAP ADA.\n\nLanjutkan?`);
    
    if(isConfirmed) {
        document.body.style.cursor = 'wait';
        try {
            const result = await DataService.adminResetStudent(email);
            if (result.success) {
                alert(` RESET SUKSES!\nData progress ${name} telah di-reset.`);
                if(typeof refreshDashboardData === 'function') refreshDashboardData(); 
                else renderResetPage();
            } else {
                alert(` GAGAL RESET!\n${result.msg}`);
            }
        } catch(e) {
            alert("Error: " + e.message);
        } finally {
            document.body.style.cursor = 'default';
        }
    }
}

// NEW: KONFIRMASI DELETE (AKUN)
async function confirmDeleteStudent(email, name) {
    const isConfirmed = confirm(` HAPUS AKUN PERMANEN? \n\nAnda akan menghapus SELURUH AKUN siswa:\n\n"${name}" (${email})\n\nSiswa TIDAK BISA LOGIN LAGI dan harus daftar ulang. Semua data hilang selamanya.\n\nLanjutkan Hapus Akun?`);
    
    if(isConfirmed) {
        document.body.style.cursor = 'wait';
        try {
            const result = await DataService.adminDeleteStudent(email);
            if (result.success) {
                alert(` AKUN DIHAPUS!\nAkun ${name} telah dihapus permanen dari database.`);
                // Refresh data dashboard secara paksa
                if(typeof refreshDashboardData === 'function') refreshDashboardData(); 
                else renderResetPage();
            } else {
                alert(` GAGAL HAPUS!\n${result.msg}`);
            }
        } catch(e) {
            alert("Error Sistem: " + e.message);
        } finally {
            document.body.style.cursor = 'default';
        }
    }
}

// UPDATE: ASYNC EXPORT
function exportToCSV() { // Hapus async
    const students = latestStudentData; // Gunakan Cache
    let csv = "Nama,Kelas,Role,Hari,Uang,Nilai Akhir\n";
    students.forEach(s => {
        const sd = s.saveData || {};
        csv += `${s.name},${s.details},${sd.role},${sd.day},${sd.money},${calculateGrade(sd)}\n`;
    });
    
    const blob = new Blob([csv], { type: 'text/csv' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'Nusantara_Arsa_Data.csv';
    a.click();
}

/** ENGINE & CONFIG */
const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');

     /* --- LOGIKA DUEL SUIT (BARU) --- */
    let duelState = {
        active: false,
        playerHP: 3,
        rivalHP: 3,
        rivalName: '',
        rivalId: ''
    };

    function startDuel(npc) {
        toggleFullScreen(); // <--- BARIS BARU: Paksa layar penuh di awal

        // 1. Reset State
        duelState.active = true;
        duelState.playerHP = 3;
        duelState.rivalHP = 3;
        duelState.rivalName = npc.name;
        duelState.rivalId = npc.id;

        // 2. Setup Tampilan
        const modal = document.getElementById('duel-minigame');
        const pImg = document.getElementById('duel-p-img');
        const rImg = document.getElementById('duel-r-img');
        const rName = document.getElementById('duel-r-name');
        
        modal.style.display = 'flex';
        
        // Load Gambar
        const gender = STATE.player.gender || 'boy';
        pImg.src = gender === 'boy' ? 'images/boy.png' : 'images/girl.png';
        rImg.src = npc.imgSrc || 'images/rival_boy.png';
        rName.innerText = npc.name ? npc.name.split(' ')[0].toUpperCase() : 'RIVAL';

        document.getElementById('duel-status').innerHTML = "Ronde 1: Pilih langkahmu!<br><span style='color:#94a3b8; font-size:12px;'>(Batu mengalahkan Gunting, Gunting mengalahkan Kertas, Kertas mengalahkan Batu)</span>";
        updateDuelUI();
        
        if(typeof STATE !== 'undefined') STATE.screen = 'minigame';
    }
	
    function handleDuelMove(pMove) {
        if (!duelState.active) return;
        
        const moves = ['batu', 'gunting', 'kertas'];
        const rMove = moves[Math.floor(Math.random() * moves.length)];
        let result = 'draw';
        let msg = "";

        if (pMove === rMove) {
            result = 'draw';
            msg = "<span style='color:#fbbf24'>Seri! Tidak ada yang terluka.</span>";
        } else if (
            (pMove === 'batu' && rMove === 'gunting') ||
            (pMove === 'gunting' && rMove === 'kertas') ||
            (pMove === 'kertas' && rMove === 'batu')
        ) {
            result = 'win';
            duelState.rivalHP--;
            msg = "<span style='color:#4ade80'>Kamu Menang! Lawan terluka.</span>";
        } else {
            result = 'lose';
            duelState.playerHP--;
            msg = "<span style='color:#ef4444'>Kamu Kalah! Terkena serangan.</span>";
        }

        const icons = { 'batu': '', 'gunting': '', 'kertas': '' };
        document.getElementById('duel-status').innerHTML = `Kamu: ${icons[pMove]} <b style="margin:0 10px;">VS</b> Rival: ${icons[rMove]}<br>${msg}`;
        updateDuelUI();

        if (duelState.playerHP <= 0 || duelState.rivalHP <= 0) {
            setTimeout(() => finishDuel(duelState.playerHP > 0), 1000);
        }
    }

    function updateDuelUI() {
        const pPct = (duelState.playerHP / 3) * 100;
        const rPct = (duelState.rivalHP / 3) * 100;
        document.getElementById('duel-p-hp').style.width = pPct + '%';
        document.getElementById('duel-r-hp').style.width = rPct + '%';
    }

function finishDuel(isWin) {
        // 1. Sembunyikan Arena Duel
        document.getElementById('duel-minigame').style.display = 'none';
        
        // 2. Siapkan Pesan Menang/Kalah
        let title, msg;
        let pImg = STATE.player.gender === 'boy' ? 'images/boy.png' : 'images/girl.png';

        if (isWin) {
            title = "MENANG DUEL! ";
            msg = "Hebat! Kamu berhasil mengalahkan rivalmu.\n\nHadiah:\n+2 Reputasi\n+500 Gold";
        } else {
            title = "KALAH DUEL... ";
            msg = "Sayang sekali, strategimu terbaca.\n\nHukuman:\n-20 Energi (Kelelahan)";
        }

        // 3. Tampilkan Dialog Hasil (PENTING: Tombol di sini yang memicu Fullscreen)
        showDialogue(title, msg, [{
            text: "Lanjut Main (Klik Disini) >>", 
            action: () => {
                // Update State Game
                duelState.active = false;
                STATE.screen = 'play';
                
                // Berikan Hadiah/Hukuman
                if (isWin) {
                    STATE.player.reputation += 2;
                    STATE.player.money += 500;
                    showToast("Hadiah Diterima!");
                } else {
                    STATE.player.energy = Math.max(0, STATE.player.energy - 20);
                }
                
                // Tutup Dialog & PAKSA FULLSCREEN
                closeDialogue();
                toggleFullScreen(); // <--- INI KUNCINYA
            }
        }], pImg);
    }


 function quitDuel() {
        document.getElementById('duel-minigame').style.display = 'none';
        duelState.active = false;
        STATE.screen = 'play';
        toggleFullScreen(); // Paksa fullscreen saat keluar
    }
	

    // --- BAGIAN PENTING 2: PAKSA LANDSCAPE SAAT KLIK ---
    function startGame() {
        const elem = document.documentElement;

        // 1. Minta Fullscreen dulu (Browser butuh ini biar bisa lock orientasi)
        if (elem.requestFullscreen) {
            elem.requestFullscreen().then(forceLandscape).catch(err => {
                console.log("Fullscreen ditolak, tetap lanjut main.");
                forceLandscape(); // Tetap coba putar walau gagal fullscreen
            });
        } else if (elem.webkitRequestFullscreen) { /* Safari */
            elem.webkitRequestFullscreen();
            setTimeout(forceLandscape, 500);
        } else {
            // Jika tidak support fullscreen, langsung coba putar
            forceLandscape();
        }

        // Sembunyikan judul, tampilkan game
        document.getElementById('title-screen').style.display = 'none';
        document.getElementById('ui-layer').style.display = 'block';
        
        // Resize canvas biar pas layar
        resize();
        gameLoop();
    }

    // Fungsi Pengunci Layar (Hanya jalan di HP Android/Chrome Mobile)
    function forceLandscape() {
        if (screen.orientation && screen.orientation.lock) {
            screen.orientation.lock('landscape')
                .then(() => console.log("Sukses: Layar terkunci Landscape"))
                .catch((err) => console.log("Info: Browser ini tidak mendukung kunci layar otomatis (Biasanya iPhone/Safari). Pemain harus putar HP manual."));
        }
    }

/* UPDATE: UBAH KONSTANTA JADI VARIABEL DINAMIS AGAR RESPONSIF */
let GAME_WIDTH = 480; 
let GAME_HEIGHT = 270; 

const TILE_SIZE = 30;
const DEBUG_MAP_BOUNDARIES = false; 

function resize() {
    /* UPDATE: FUNGSI RESIZE DINAMIS (FULL SCREEN ADAPTIVE) */
    
    // Set ukuran canvas sama persis dengan ukuran jendela browser
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;
    
    // Tentukan tingkat Zoom (Scale) berdasarkan lebar layar
    // Mobile butuh zoom lebih kecil (objek terlihat lebih besar)
    // Desktop butuh zoom lebih besar (area pandang lebih luas)
    const isMobile = window.innerWidth < 1000;
    const isTablet = window.innerWidth >= 1000 && window.innerWidth < 1300;
    
    /* UPDATE: ZOOM OUT KAMERA SESUAI REQUEST (AREA PANDANG LEBIH LUAS) */
    // Nilai scale dikecilkan: Semakin kecil nilainya, semakin "Jauh" kameranya (Zoom Out)
    let scale = 2.2; // Desktop (Zoom Out agar lebih luas, sebelumnya 3.0)
    
    if (isMobile) {
        /* REVISI: Scale Mobile diperkecil (1.5 -> 1.15) agar area vertikal terlihat lebih banyak */
        /* Ini mengatasi masalah kasur/lemari terpotong di layar HP yang pendek */
        scale = 1.35; 
    } else if (isTablet) {
        scale = 1.8; // Tablet (Zoom Out, sebelumnya 2.5)
    }
    
    // Hitung dimensi logika game berdasarkan ukuran layar & scale
    // Ini membuat game tidak gepeng, tapi menambah/mengurangi area pandang kamera
    GAME_WIDTH = canvas.width / scale;
    GAME_HEIGHT = canvas.height / scale;
    
    // UPDATE: Mengaktifkan smoothing agar karakter HD terlihat halus (tidak pecah/gerigi)
    // Sebelumnya 'false' (Pixel Art Mode), sekarang 'true' (HD Mode)
    ctx.imageSmoothingEnabled = true; 
}
window.addEventListener('resize', resize);
// FIX: Tambahkan Listener Orientasi untuk HP (Fix Gambar Hilang saat Login)
window.addEventListener('orientationchange', () => {
    setTimeout(resize, 200); // Tunggu rotasi selesai
    setTimeout(resize, 1000); // Cek ulang
});

/** ASSETS GENERATION (MAP) */
const ISLAND_W = 60;
const ISLAND_H = 40;
const villageTiles = new Array(ISLAND_W * ISLAND_H).fill(0); 

function fillMap(arr, w, val, x, y, rw, rh) {
    for(let i=0; i<rh; i++) {
        for(let j=0; j<rw; j++) {
            if (y+i < ISLAND_H && x+j < ISLAND_W) arr[(y+i)*w + (x+j)] = val;
        }
    }
}

// Pulau (Daratan)
fillMap(villageTiles, ISLAND_W, 1, 5, 5, 50, 30); 

// Decorate with paths (3)
fillMap(villageTiles, ISLAND_W, 3, 28, 5, 4, 32); 
fillMap(villageTiles, ISLAND_W, 3, 5, 20, 50, 4); 

// --- UPDATE: TILE RERUNTUHAN DIPINDAH KE DEPAN CANDI (KANAN ATAS) ---
// Hutan (Kiri) - LAMA (DIKOMENTARI/DIHAPUS)
/*
for(let i=0; i<4; i++) {
    fillMap(villageTiles, ISLAND_W, 5, 8, 8 + (i*5), 4, 3);
    villageTiles[(8 + (i*5) + 2) * ISLAND_W + 10] = 6; 
}
*/

// Area Reruntuhan Baru (Antara Candi dan Dungeon)
// Lokasi: Sekitar x:46-54, y:11-17
// UPDATE: Menggunakan ID 7 (Lantai Reruntuhan) bukan 5 (Tanah)
fillMap(villageTiles, ISLAND_W, 7, 46, 11, 9, 7); 

// Tambahkan Puing-puing Magis (Tile Ungu/Kuno) secara acak di area reruntuhan
villageTiles[12 * ISLAND_W + 48] = 6; 
villageTiles[14 * ISLAND_W + 52] = 6; 
villageTiles[13 * ISLAND_W + 47] = 6;
villageTiles[15 * ISLAND_W + 50] = 6;
villageTiles[12 * ISLAND_W + 53] = 6;

// Area Akademi (x:38, y:10)
fillMap(villageTiles, ISLAND_W, 2, 35, 6, 15, 3); 
fillMap(villageTiles, ISLAND_W, 2, 34, 9, 3, 8);
fillMap(villageTiles, ISLAND_W, 2, 45, 9, 3, 8);
fillMap(villageTiles, ISLAND_W, 2, 35, 7, 2, 2); 
fillMap(villageTiles, ISLAND_W, 1, 37, 9, 8, 8); // Bersihkan area akademi

// --- UPDATE: BERSIHKAN AREA BELAKANG KAMPUS UNTUK KAIA (Hapus Pohon) ---
fillMap(villageTiles, ISLAND_W, 1, 38, 7, 6, 2); // Area X:38-43, Y:7-8 jadi Rumput agar Kaia terlihat

fillMap(villageTiles, ISLAND_W, 3, 36, 12, 8, 1); // Jalan setapak

villageTiles[12 * ISLAND_W + 40] = 6; 
fillMap(villageTiles, ISLAND_W, 4, 50, 18, 5, 5); 
villageTiles[20 * ISLAND_W + 52] = 9; 

// Area Guild
fillMap(villageTiles, ISLAND_W, 1, 40, 24, 10, 10); 

// SPAWN HOUSE DOOR
villageTiles[10 * ISLAND_W + 18] = 8; // House Door at 18,10

// --- NEW: LAHAN PERTANIAN DI BELAKANG RUMAH ---
// Rumah Player ada di x:19, y:7. Kita buat lahan di atasnya (y:3 s/d y:6).
// Menggunakan Tile ID 5 (Tanah/Earth)
fillMap(villageTiles, ISLAND_W, 5, 17, 3, 8, 4); // Area Tanah 8x4 petak

// Buat jalan setapak kecil menuju kebun dari samping rumah
fillMap(villageTiles, ISLAND_W, 3, 16, 7, 3, 1); // Jalan sambung

// SAKURA TREES
const sakuraLocations = [
    {x: 36, y: 13}, {x: 45, y: 13}, {x: 13, y: 26}, 
    {x: 16, y: 13}, {x: 40, y: 28}, {x: 23, y: 18},
    {x: 24, y: 9} // NEW: Sebelah Kanan Rumah Player
];

sakuraLocations.forEach(loc => {
    if(loc.x < ISLAND_W && loc.y < ISLAND_H) {
        villageTiles[loc.y * ISLAND_W + loc.x] = 12; // ID 12 = Sakura Tree
    }
});

// ADDED: POHON BESAR MANUAL (Sebelah Kiri Blacksmith)
villageTiles[29 * ISLAND_W + 31] = 2; // ID 2 = Pohon Besar Biasa
// ADDED: POHON BESAR MANUAL (Sebelah Kiri Perpustakaan)
villageTiles[21 * ISLAND_W + 35] = 2; 

const DUNGEON_W = 40;
const DUNGEON_H = 30;
// PERBAIKAN: Dungeon Floor Full Lantai, Tembok hanya di pinggir batas map
const dungeonTiles = Array(DUNGEON_W * DUNGEON_H).fill(4).map((t, i) => {
    const x = i % DUNGEON_W;
    const y = Math.floor(i / DUNGEON_W);
    // Hanya pinggiran map yang jadi tembok pembatas absolut (ID 2)
    if (x===0 || x===DUNGEON_W-1 || y===0 || y===DUNGEON_H-1) return 2;
    return 4; // Sisanya Full Lantai
});
// UPDATE: Menghapus tile ENTER (ID 9) manual di dungeon agar tidak double icon dengan trigger exit
// dungeonTiles[DUNGEON_W + 2] = 9;  <-- DIHAPUS

// GENERATE RANDOM ROCKS AS BUILDINGS (OBJECTS)
// Agar bisa dilewati belakangnya (Z-Index sorting) dan collision di bawah
const dungeonRocks = [];
for(let i=0; i<40; i++) { // Generate 40 batu acak
    let rx = Math.floor(Math.random() * (DUNGEON_W - 4)) + 2;
    let ry = Math.floor(Math.random() * (DUNGEON_H - 4)) + 2;
    
    // UPDATE: Jangan spawn batu di area pintu masuk (kiri atas) yang diperluas
    // Agar spawn point player di (5,5) aman dari batu
    if(rx < 8 && ry < 8) continue;

    dungeonRocks.push({
        id: 'rock_'+i,
        x: rx, 
        y: ry, 
        w: 1, // Lebar 1 Tile
        h: 1, // Tinggi 1 Tile
        type: 'dungeon_rock', // Tipe baru
        name: 'Batu Besar'
    });
}

// HOUSE MAP - DYNAMIC GENERATION HANDLED BY regenerateHouseMap()
// Initial default map, will be overwritten by regenerateHouseMap()
const houseTiles = new Array(12 * 10).fill(10); 

// MERCHANT INTERIOR MAP (15x12)
const MERCH_W = 15;
const MERCH_H = 12;
const merchTiles = new Array(MERCH_W * MERCH_H).fill(10); // 10 = Wood
for(let x=0; x<MERCH_W; x++) { merchTiles[0*MERCH_W+x] = 2; merchTiles[(MERCH_H-1)*MERCH_W+x] = 2; } // Walls
for(let y=0; y<MERCH_H; y++) { merchTiles[y*MERCH_W+0] = 2; merchTiles[y*MERCH_W+(MERCH_W-1)] = 2; }

// NEW: LIBRARY INTERIOR MAP (14x12)
const LIB_W = 14;
const LIB_H = 12;
const libTiles = new Array(LIB_W * LIB_H).fill(10); // 10 = Wood Floor
for(let x=0; x<LIB_W; x++) { libTiles[0*LIB_W+x] = 11; libTiles[(LIB_H-1)*LIB_W+x] = 11; } // Walls (Putih/11)
for(let y=0; y<LIB_H; y++) { libTiles[y*LIB_W+0] = 11; libTiles[y*LIB_W+(LIB_W-1)] = 11; } // Side Walls
libTiles[(LIB_H-1)*LIB_W + 7] = 8; // Door Tile

// NEW: GUILD INTERIOR MAP (16x14)
const GUILD_W = 16;
const GUILD_H = 14;
const guildTiles = new Array(GUILD_W * GUILD_H).fill(10); // 10 = Wood/Stone Floor
// Walls (ID 2 untuk dinding batu agar terlihat kokoh)
for(let x=0; x<GUILD_W; x++) { guildTiles[0*GUILD_W+x] = 2; guildTiles[(GUILD_H-1)*GUILD_W+x] = 2; }
for(let y=0; y<GUILD_H; y++) { guildTiles[y*GUILD_W+0] = 2; guildTiles[y*GUILD_W+(GUILD_W-1)] = 2; }
guildTiles[(GUILD_H-1)*GUILD_W + 8] = 8; // Door Tile

// NEW: SCHOOL INTERIOR MAP (16x14) - RUANG KELAS
const SCHOOL_W = 16;
const SCHOOL_H = 14;
const schoolTiles = new Array(SCHOOL_W * SCHOOL_H).fill(10); // 10 = Wood Floor
// Walls (ID 11 = Putih/Tembok Kampus)
for(let x=0; x<SCHOOL_W; x++) { schoolTiles[0*SCHOOL_W+x] = 11; schoolTiles[(SCHOOL_H-1)*SCHOOL_W+x] = 11; }
for(let y=0; y<SCHOOL_H; y++) { schoolTiles[y*SCHOOL_W+0] = 11; schoolTiles[y*SCHOOL_W+(SCHOOL_W-1)] = 11; }
schoolTiles[(SCHOOL_H-1)*SCHOOL_W + 8] = 8; // Door Tile (Tengah Bawah)

// --- NEW: CLINIC INTERIOR MAP (14x12) ---
const CLINIC_W = 14;
const CLINIC_H = 12;
const clinicTiles = new Array(CLINIC_W * CLINIC_H).fill(10); // 10 = Floor
// Walls (ID 11 = Putih/Bersih)
for(let x=0; x<CLINIC_W; x++) { clinicTiles[0*CLINIC_W+x] = 11; clinicTiles[(CLINIC_H-1)*CLINIC_W+x] = 11; }
for(let y=0; y<CLINIC_H; y++) { clinicTiles[y*CLINIC_W+0] = 11; clinicTiles[y*CLINIC_W+(CLINIC_W-1)] = 11; }
clinicTiles[(CLINIC_H-1)*CLINIC_W + 7] = 8; // Door Tile

// NEW: BLACKSMITH INTERIOR MAP (14x12)
const SMITH_W = 14;
const SMITH_H = 12;
// UPDATE: Ubah lantai dasar dari 4 (Batu) ke 10 (Kayu/Lantai) agar bisa dicustom
const smithTiles = new Array(SMITH_W * SMITH_H).fill(10); 
// Walls (ID 2 = Tembok Batu Gelap)
for(let x=0; x<SMITH_W; x++) { smithTiles[0*SMITH_W+x] = 2; smithTiles[(SMITH_H-1)*SMITH_W+x] = 2; }
for(let y=0; y<SMITH_H; y++) { smithTiles[y*SMITH_W+0] = 2; smithTiles[y*SMITH_W+(SMITH_W-1)] = 2; }
smithTiles[(SMITH_H-1)*SMITH_W + 7] = 8; // Door Tile

// --- NEW: MENTOR INTERIOR MAP (14x12) ---
const MENTOR_W = 14;
const MENTOR_H = 12;
const mentorTiles = new Array(MENTOR_W * MENTOR_H).fill(10); // 10 = Wood Floor
// Walls (UPDATE: ID 13 untuk Atas/Bawah, ID 11 untuk Samping - Samakan dengan Rumah Player)
for(let x=0; x<MENTOR_W; x++) { mentorTiles[0*MENTOR_W+x] = 13; mentorTiles[(MENTOR_H-1)*MENTOR_W+x] = 13; }
for(let y=0; y<MENTOR_H; y++) { mentorTiles[y*MENTOR_W+0] = 11; mentorTiles[y*MENTOR_W+(MENTOR_W-1)] = 11; }
mentorTiles[(MENTOR_H-1)*MENTOR_W + 7] = 8; // Door Tile

// --- NEW: WEDDING INTERIOR MAP (14x14) ---
const WEDDING_W = 14;
const WEDDING_H = 14;
const weddingTiles = new Array(WEDDING_W * WEDDING_H).fill(10); // 10 = Floor
// Walls (ID 11 = Putih/Bersih/Suci)
for(let x=0; x<WEDDING_W; x++) { weddingTiles[0*WEDDING_W+x] = 11; weddingTiles[(WEDDING_H-1)*WEDDING_W+x] = 11; }
for(let y=0; y<WEDDING_H; y++) { weddingTiles[y*WEDDING_W+0] = 11; weddingTiles[y*WEDDING_W+(WEDDING_W-1)] = 11; }
weddingTiles[(WEDDING_H-1)*WEDDING_W + 7] = 8; // Door Tile

// --- NEW: AYU'S HOUSE INTERIOR (14x12) ---
const LOVER1_W = 14;
const LOVER1_H = 12;
const lover1Tiles = new Array(LOVER1_W * LOVER1_H).fill(10); // 10 = Wood Floor
// Walls (ID 11 = Tembok Putih/Bersih)
for(let x=0; x<LOVER1_W; x++) { lover1Tiles[0*LOVER1_W+x] = 11; lover1Tiles[(LOVER1_H-1)*LOVER1_W+x] = 11; }
for(let y=0; y<LOVER1_H; y++) { lover1Tiles[y*LOVER1_W+0] = 11; lover1Tiles[y*LOVER1_W+(LOVER1_W-1)] = 11; }
lover1Tiles[(LOVER1_H-1)*LOVER1_W + 7] = 8; // Door Tile

// --- NEW: PLAYER SHOP INTERIOR (14x12) FOR ENTREPRENEUR ---
const PSHOP_W = 14;
const PSHOP_H = 12;
const pShopTiles = new Array(PSHOP_W * PSHOP_H).fill(10); // 10 = Wood Floor
// Walls (ID 11 = Tembok Putih)
for(let x=0; x<PSHOP_W; x++) { pShopTiles[0*PSHOP_W+x] = 11; pShopTiles[(PSHOP_H-1)*PSHOP_W+x] = 11; }
for(let y=0; y<PSHOP_H; y++) { pShopTiles[y*PSHOP_W+0] = 11; pShopTiles[y*PSHOP_W+(PSHOP_W-1)] = 11; }
pShopTiles[(PSHOP_H-1)*PSHOP_W + 7] = 8; // Door Tile

// --- NEW: FISHERMAN HOUSE INTERIOR (12x10) ---
const FISH_W = 12;
const FISH_H = 10;
const fishTiles = new Array(FISH_W * FISH_H).fill(10); // 10 = Wood Floor
// Walls (ID 11 = Tembok)
for(let x=0; x<FISH_W; x++) { fishTiles[0*FISH_W+x] = 11; fishTiles[(FISH_H-1)*FISH_W+x] = 11; }
for(let y=0; y<FISH_H; y++) { fishTiles[y*FISH_W+0] = 11; fishTiles[y*FISH_W+(FISH_W-1)] = 11; }
fishTiles[(FISH_H-1)*FISH_W + 6] = 8; // Door Tile

// --- NEW: CANDI INTERIOR MAP (16x16) ---
const CANDI_W = 16;
const CANDI_H = 16;
const candiTiles = new Array(CANDI_W * CANDI_H).fill(4); // 4 = Stone Floor (Dungeon style)

// Walls (ID 2 = Stone Wall)
for(let x=0; x<CANDI_W; x++) { candiTiles[0*CANDI_W+x] = 2; candiTiles[(CANDI_H-1)*CANDI_W+x] = 2; }
for(let y=0; y<CANDI_H; y++) { candiTiles[y*CANDI_W+0] = 2; candiTiles[y*CANDI_W+(CANDI_W-1)] = 2; }

// Pathway / Karpet Merah/Ungu (Magic Floor ID 6) leading to Altar
for(let y=3; y<CANDI_H-1; y++) {
    candiTiles[y*CANDI_W + 7] = 6;
    candiTiles[y*CANDI_W + 8] = 6; // UPDATE: Dikembalikan jadi 2 kolom (Lebih Lebar)
}
// Door Tile (Tengah Bawah) - Disesuaikan agar simetris dengan karpet
candiTiles[(CANDI_H-1)*CANDI_W + 7] = 8; 
candiTiles[(CANDI_H-1)*CANDI_W + 8] = 8; 

// --- UPDATE: MAP RERUNTUHAN YANG LEBIH DETAIL ---
const RUINS_W = 22;
const RUINS_H = 16;
// Campuran Tanah (5) dan Lantai Batu Dungeon (4) untuk kesan reruntuhan
// UPDATE: Base tile menggunakan ID 7 (Lantai Reruntuhan)
const ruinsTiles = new Array(RUINS_W * RUINS_H).fill(7); 

// Buat pola reruntuhan (Lantai batu pecah-pecah di tengah)
for(let y=2; y<RUINS_H-2; y++) {
    for(let x=2; x<RUINS_W-2; x++) {
        // 70% kemungkinan jadi lantai batu kuno, sisanya tanah/rumput
        if(Math.random() > 0.3) ruinsTiles[y*RUINS_W+x] = 4; // 4 = Stone
    }
}

// Tambahkan Tembok Pembatas Hutan (ID 2)
for(let x=0; x<RUINS_W; x++) { ruinsTiles[0*RUINS_W+x] = 2; ruinsTiles[(RUINS_H-1)*RUINS_W+x] = 2; }
for(let y=0; y<RUINS_H; y++) { ruinsTiles[y*RUINS_W+0] = 2; ruinsTiles[y*RUINS_W+(RUINS_W-1)] = 2; }

const ruinsObstacles = [];
// Tambahkan Pilar/Batu Reruntuhan Acak sebagai Obstacle
for(let i=0; i<10; i++) {
    ruinsObstacles.push({
        id: `ruin_rock_${i}`,
        x: Math.floor(Math.random() * (RUINS_W-4)) + 2,
        y: Math.floor(Math.random() * (RUINS_H-6)) + 2, // Hindari area bawah (pintu)
        w: 1, h: 1,
        type: 'dungeon_rock', // Menggunakan visual batu
        name: 'Puing Kuno'
    });
}

        const maps = {
    'village': {
        w: ISLAND_W, h: ISLAND_H,
        tiles: villageTiles,
        buildings: [
            /* UPDATE: TITIK ENTRANCE DINAIKKAN (Y-1) AGAR MENEMPEL DI PINTU BANGUNAN (VISUAL LEBIH RAPI) */
            /* Radius deteksi teleport diperbesar agar pemain bisa masuk saat menyentuh tembok */
            
            { id: 'player_house', x: 19, y: 7, w: 4, h: 4, type: 'house_player', entrance: {x: 21, y: 10, map: 'house'}, open24h: true },
            
            /* UPDATE: PAPAN MISI JUGA DINAIKKAN */
            { 
                id: 'papan_misi', 
                x: 12, 
                y: 6, 
                w: 6, 
                h: 5, 
                /* REVERT: Kembalikan ke gambar asli Papan Desa */
                img: 'images/papandesa.png', 
                entrance: {x: 15, y: 10}, 
                name: "Papan Desa",
                open24h: true
            },
            
            /* UPDATE: STATUE */
            { 
                id: 'statue_rank', 
                x: 22, 
                y: 28, 
                w: 6, 
                h: 5, 
                img: 'images/statue.png', 
                entrance: {x: 25, y: 32}, 
                name: "Patung Peringkat",
                open24h: true
            },
            
            /* UPDATE: SEMUA BANGUNAN LAINNYA (Y Pintu dikurangi 1) */
            { id: 'school', x: 38, y: 10, w: 6, h: 5, img: 'images/kampus.png', entrance: {x: 41, y: 14, map: 'school_interior'}, name: "Kampus", roleSpecific: 'student', openTime: 700, closeTime: 1800 },
            { id: 'merchant', x: 26, y: 22, w: 6, h: 5, img: 'images/rumahmerchant.png', entrance: {x: 29, y: 26, map: 'merchant_interior'}, name: "Merchant", openTime: 600, closeTime: 2000 },
            { id: 'mentor', x: 28, y: 15, w: 6, h: 5, img: 'images/rumahmentor.png', entrance: {x: 31, y: 19, map: 'mentor_interior'}, name: "Rumah Mentor", openTime: 800, closeTime: 2200 },
            /* NEW: WARNET (BARAT/KIRI KLINIK) */
            { 
                id: 'warnet', 
                x: 12, 
                y: 16, 
                w: 5, 
                h: 4, 
                img: 'images/warnet.png', 
                entrance: {x: 14, y: 19, map: 'warnet_interior'}, // <--- UPDATE INI 
                name: "Warnet Desa", 
                openTime: 800, 
                closeTime: 2400 
            },
            /* REVISI: HAPUS roleSpecific: 'worker' DARI BLACKSMITH AGAR BUKA UNTUK UMUM */
            /* UPDATE: Jam Tutup diperpanjang sampai 21:00 (Jam 9 Malam) */
            { id: 'blacksmith', x: 34, y: 27, w: 6, h: 5, img: 'images/rumahblacksmith.png', entrance: {x: 37, y: 31, map: 'blacksmith_interior'}, name: "Blacksmith", openTime: 800, closeTime: 2100 },
            
            /* UPDATE: MENGUBAH RUMAH LOVE MENJADI RUMAH AYU */
            { id: 'lover1_home', x: 14, y: 25, w: 6, h: 5, img: 'images/rumahlove.png', entrance: {x: 17, y: 29, map: 'lover1_interior'}, name: "Rumah Ayu", openTime: 700, closeTime: 2100 },
            
            /* MOVED: PERPUSTAKAAN SHIFTED LEFT (Avoiding Dungeon) */
            /* FIX: Jam Buka Diperbaiki menjadi 2000 (8 Malam) */
            { id: 'library', x: 38, y: 18, w: 6, h: 5, img: 'images/perpustakaan.png', entrance: {x: 41, y: 22, map: 'library_interior'}, name: "Perpustakaan", openTime: 800, closeTime: 2000 },
            
            { id: 'dungeon_gate', x: 48, y: 15, w: 6, h: 6, img: 'images/dungeon.png', entrance: {x: 51, y: 20, map: 'dungeon'}, name: "Dungeon Entrance", open24h: true },
            { id: 'guild', x: 42, y: 25, w: 7, h: 6, img: 'images/gedungpetualang.png', entrance: {x: 45, y: 30, map: 'guild_interior'}, name: "Gedung Petualang", open24h: true },
            { id: 'clinic', x: 18, y: 14, w: 5, h: 5, img: 'images/balaipengobatan.png', entrance: {x: 20, y: 18, map: 'clinic_interior'}, name: "Balai Pengobatan", open24h: true },
            
            /* UPDATE: WEDDING HALL */
            /* UPDATE JAM BUKA: DIUBAH JADI 06:00 PAGI */
            { id: 'wedding', x: 20, y: 22, w: 6, h: 5, img: 'images/balaipernikahan.png', entrance: {x: 23, y: 26, map: 'wedding_interior'}, name: "Balai Pernikahan", roleSpecific: 'family', openTime: 600, closeTime: 1600 },
            
            /* UPDATE: PELABUHAN TIDAK DIUBAH KARENA PLAYER BISA JALAN DI ATASNYA */
            { id: 'port', x: 43, y: 34, w: 7, h: 5, img: 'images/pelabuhan.png', entrance: {x: 46, y: 37, map: 'fishing_action'}, name: "Dermaga Mancing", open24h: true },
            
            /* NEW: RUMAH TETANGGA (NELAYAN) - DIAKTIFKAN KEMBALI */
            /* Posisi: Sebelah kanan rumah player (x:26) */
            { id: 'fisherman_home', x: 26, y: 7, w: 4, h: 4, img: 'images/rumahwarga.png', entrance: {x: 28, y: 10, map: 'fisherman_interior'}, name: "Rumah Nelayan", openTime: 600, closeTime: 2100 },

            /* NEW: CANDI KUNO (TAMBAHAN) */
            /* Posisi: Pojok Kanan Atas (Di atas Dungeon) */
            { 
                id: 'candi', 
                x: 48, 
                y: 6, 
                w: 6, 
                h: 5, 
                img: 'images/candi.png', 
                entrance: {x: 51, y: 10, map: 'candi_interior'}, // LINK KE INTERIOR BARU
                name: "Candi Kuno",
                open24h: true
            }
        ],
        npcs: [
            /* UPDATE: MENTOR BUDI DIHAPUS DARI LUAR RUMAH (DEFAULT HIDDEN) */
            /* Kita taruh di koordinat -99 agar tidak terlihat, tapi objeknya ADA untuk dipanggil saat Tutorial */
            {id: 'mentor', x: -99, y: -99, name: 'Mentor Budi', imgSrc: 'images/mentor.png', type: 'static', schedule: 'always', w: 40, h: 60},

            /* UPDATE: DOSEN DIHAPUS DARI LUAR, DIGANTI SARJANA TEKNOLOGI */
            {id: 'sarjana_tekno', x: 43, y: 16, name: 'Senior Teknologi', imgSrc: 'images/sarjanateknologi.png', type: 'service', schedule: 'day', w: 40, h: 60}, 
            
            /* NEW: SARJANA SEJARAH (PINDAH KE AREA CANDI) */
            /* UPDATE: Posisi dipindah ke x:46, y:9 (Sebelah Kiri Candi Kuno) */
            {id: 'sarjana_sejarah', x: 46, y: 9, name: 'Ahli Sejarah', imgSrc: 'images/sarjanasejarah.png', type: 'wander', vx:0, vy:0, schedule: 'day', w: 40, h: 60},

            /* NEW: SATPAM KAMPUS (Penjaga Gerbang) */
            /* UPDATE: POSISI DIGESER KE KIRI (38, 16) AGAR TIDAK MENGHALANGI JALAN */
            /* UPDATE: JADWAL JADI 'ALWAYS' (24 JAM) AGAR BISA NGOBROL MALAM */
            {id: 'satpam', x: 38, y: 16, name: 'Satpam', imgSrc: 'images/satpam.png', type: 'static', schedule: 'always', w: 40, h: 60},

            /* REMOVED: job/mercenary npc */
            /* MOVED: Trader menggantikan posisi job (x:25, y:27) */
            /* UPDATE: DIGESER KE BAWAH DAN KANAN (x:31, y:29) AGAR TIDAK MENGHALANGI PINTU MERCHANT */
            {id: 'trader_outside', x: 31, y: 29, name: 'Pedagang Keliling', imgSrc: 'images/merchant.png', type: 'service', schedule: 'day', w: 40, h: 60},
            
            /* UPDATE: KEPALA BENGKEL PINDAH KE DALAM, DIGANTI ANAKNYA DI LUAR */
            /* UPDATE: Ukuran Lina disamakan dengan Player (w:40, h:60) */
            {id: 'child_blacksmith', x: 35, y: 32, name: 'Lina (Anak Besi)', imgSrc: 'images/anakblacksmith.png', type: 'static', vx:0, vy:0, schedule: 'day', w: 40, h: 60},
            
            {id: 'lover1girl', x: 14, y: 29, name: 'Ayu (Gadis Desa)', imgSrc: 'images/lover1girl.png', type: 'lover', schedule: 'day', w: 40, h: 60},
            /* REMOVED: Satria (Ksatria) dihapus dari luar, dipindah ke dalam Guild */
            /* UPDATE: PUTRI DIUBAH JADI 'STATIC' AGAR TIDAK FLOATING SESUAI REQUEST */
            /* UPDATE TERBARU: POSISI DINAIKKAN KE Y:12 AGAR TIDAK TERTUTUP ATAP RUMAH MENTOR */
            /* REVISI JADWAL PUTRI: SORE (AFTERNOON) DI LUAR, PAGI DI KAMPUS */
            {id: 'lover2girl', x: 32, y: 12, name: 'Putri (Scholar)', imgSrc: 'images/lover2girl.png', type: 'static', schedule: 'afternoon', w: 40, h: 60},
            
            /* MOVED: CINTA MATRE PINDAH KE INTERIOR (GUILD & PERPUS) */

            /* DIKEMBALIKAN: Peer 1 (Siswa Laki-laki) */
            {id: 'peer1', x: 12, y: 12, name: 'Teman Sekelas', imgSrc: 'images/peer1.png', type: 'wander', vx:0, vy:0, schedule: 'day', w: 40, h: 60},

            /* DIHAPUS: Tetangga A (Peer 1) yang tinggal di rumah kiri */
            {id: 'peer2', x: 28, y: 11, name: 'Tetangga B', imgSrc: 'images/peer2.png', type: 'wander', vx:0, vy:0, schedule: 'day', w: 40, h: 60},
            {id: 'peer3', x: 35, y: 30, name: 'Petani', imgSrc: 'images/peer3.png', type: 'wander', vx:0, vy:0, schedule: 'day', w: 40, h: 60},
            
            /* UPDATE: POSISI NPC DI DERMAGA MENGIKUTI PERUBAHAN BANGUNAN */
            {id: 'nelayan', x: 44, y: 36, name: 'Pak Nelayan', imgSrc: 'images/nelayan.png', type: 'wander', vx:0, vy:0, schedule: 'day', w: 40, h: 60},
            
            /* MOVED: Bu Nelayan dipindah ke dalam rumahnya (fisherman_interior) */
            /* {id: 'istrinelayan', x: 43, y: 35, name: 'Bu Nelayan', ... }  <-- DIHAPUS DARI LUAR */
            
            /* NEW: NPC KERUKUNAN (Dipindah ke Area Lapang Kiri & Jadwal DAY) */
            /* UPDATE: Tipe diubah jadi 'static' agar diam di tempat & Posisi didekatkan (x:10 & x:11) */
            /* UPDATE: DIGESER SEDIKIT KE BAWAH (Y:19) KARENA PAPAN TURUN KE Y:7 */
            {id: 'cewek_islam', x: 10, y: 19, name: 'Aisyah', imgSrc: 'images/cewek-islam.png', type: 'static', vx:0, vy:0, schedule: 'day', w: 40, h: 60},
            {id: 'cewek_kristen', x: 11, y: 19, name: 'Maria', imgSrc: 'images/cewek-kristen.png', type: 'static', vx:0, vy:0, schedule: 'day', w: 40, h: 60},

            /* NEW: PEMANCING SORE-MALAM (Update Posisi ke Ujung Dermaga Baru) */
            /* UPDATE: DIGESER KE BAWAH (Y:38) AGAR LEBIH DI PUCUK */
            /* UPDATE: UKURAN DIUBAH SESUAI REQUEST (SAMA DENGAN PLAYER 40x60) */
            /* UPDATE TERBARU: POSISI DIGESER TURUN KE Y:37 SESUAI REQUEST */
            {id: 'pemancing_misterius', x: 47, y: 37, name: 'Pemancing Senja', imgSrc: 'images/pemancing.png', type: 'service', schedule: 'evening', w: 40, h: 60},

            /* NEW: PUTRI DUYUNG (Pinggir Laut - Selatan Kiri Dermaga) */
            /* UPDATE: Posisi dipindah ke sebelah kiri dermaga (x:38) di air (y:36) */
            {id: 'putriduyung', x: 38, y: 36, name: 'Putri Duyung', imgSrc: 'images/putriduyung.png', type: 'service', schedule: 'night', w: 40, h: 60},

            /* UPDATE: SENIMAN (Dipindah ke bawah Papan Misi - Area Santai) */
            {id: 'seniman', x: 12, y: 14, name: 'Seniman', imgSrc: 'images/seniman.png', type: 'static', schedule: 'day', w: 40, h: 60},
            
            /* UPDATE: PENYANYI (Dipindah ke sebelah Seniman di bawah Papan) */
            {id: 'penyanyi', x: 13, y: 14, name: 'Penyanyi', imgSrc: 'images/penyanyi.png', type: 'static', schedule: 'day', w: 40, h: 60},

            /* NEW: PERENANG DI LAUT (Swimmers) */
            {id: 'swimmer_boy', x: 3, y: 20, name: 'Perenang Santai', imgSrc: 'images/pantai-boy.png', type: 'swimmer', vx: 0.5, vy: 0.5, schedule: 'day', w: 40, h: 60},
            {id: 'swimmer_girl', x: 50, y: 36, name: 'Perenang Ceria', imgSrc: 'images/pantai-girl.png', type: 'swimmer', vx: -0.5, vy: 0, schedule: 'day', w: 40, h: 60},

            /* NEW: DEWI ARSA (EVENT RAHASIA BULAN PURNAMA) */
            /* Muncul di samping Patung Peringkat (Statue ada di x:22, w:6 -> Berakhir di x:28) */
            /* Kita taruh di x:29 agar di sebelah kanan patung */
            {id: 'dewi_arsa', x: 29, y: 30, name: 'Dewi Arsa', imgSrc: 'images/dewiarsa.png', type: 'static', schedule: 'custom_fullmoon', w: 40, h: 60},

            /* NEW: KURCACI TANI (EVENT PANEN RAYA - MUSIM PANAS) */
            /* Muncul di hutan belakang sekolah (x:38, y:6) */
            {id: 'kurcaci_tani', x: 38, y: 6, name: 'Kurcaci Tani', imgSrc: 'images/kurcacitani.png', type: 'static', schedule: 'custom_harvest_festival', w: 32, h: 32},

            /* NEW: PERI PANEN (EVENT PESTA ANGGUR - MUSIM GUGUR) */
            /* Muncul di tempat yang sama dengan Kurcaci Tani (x:38, y:6) */
            {id: 'peripanen', x: 38, y: 6, name: 'Peri Panen', imgSrc: 'images/peripanen.png', type: 'static', schedule: 'custom_grape_harvest', w: 32, h: 32},

            /* NEW: NPC ANAK-ANAK (BERMAIN DI DEKAT KAMPUS) */
            /* UPDATE: Bocah Nakal dipindah ke Dermaga (Bawah Laut Pinggir) */
            /* Koordinat Dermaga sekitar x:43-50, y:34-39 */
            {id: 'child_boy_1', x: 46, y: 37, name: 'Bocah Nakal', imgSrc: 'images/anakkecil1.png', type: 'wander', vx:0, vy:0, schedule: 'day', w: 32, h: 48},
            
            /* UPDATE: Gadis Kecil dipindah ke Halaman Rumah Mentor (Area Kosong) */
            /* Koordinat x:30, y:18 (Dekat pintu masuk Rumah Mentor) */
            {id: 'child_girl_1', x: 30, y: 18, name: 'Gadis Kecil', imgSrc: 'images/anakkecil2.png', type: 'wander', vx:0, vy:0, schedule: 'day', w: 32, h: 48},

            /* NEW: KAIA (SENIOR PSIKOLOGI - GUIDE ADAPTASI) */
            /* UPDATE: Dipindah ke PAS BELAKANG KAMPUS (Area Rumput Baru) */
            /* Koordinat x:41, y:8 (Tepat di belakang tengah gedung, tidak ketutup pohon) */
            {id: 'senior_kaia', x: 41, y: 8, name: 'Kaia (Senior)', imgSrc: 'images/kaia.png', type: 'wander', schedule: 'always', w: 40, h: 60},

            /* --- RIVAL CINTA (GENDER SPECIFIC & MOVING) --- */
            
            /* RIVAL COWOK (Muncul jika Player Laki-laki) - Nama: Doni */
            /* UPDATE: RIVAL DIPERBESAR (w:40, h:60) setara Player */
            {id: 'fake_boy', x: 15, y: 30, name: 'Doni (Rival)', imgSrc: 'images/rival_boy.png', type: 'wander', schedule: 'morning', genderReq: 'boy', w: 40, h: 60},
            {id: 'fake_boy', x: 31, y: 15, name: 'Doni (Rival)', imgSrc: 'images/rival_boy.png', type: 'wander', schedule: 'afternoon', genderReq: 'boy', w: 40, h: 60},

            /* RIVAL CEWEK (Muncul jika Player Perempuan) - Nama: Bella */
            /* UPDATE: RIVAL DIPERBESAR (w:40, h:60) setara Player */
            {id: 'fake_girl', x: 19, y: 16, name: 'Bella (Rival)', imgSrc: 'images/rival_girl.png', type: 'wander', schedule: 'morning', genderReq: 'girl', w: 40, h: 60},
            {id: 'fake_girl', x: 40, y: 31, name: 'Bella (Rival)', imgSrc: 'images/rival_girl.png', type: 'wander', schedule: 'afternoon', genderReq: 'girl', w: 40, h: 60},

            /* NEW: MONSTER PENCURI SKRIPSI (Hanya muncul saat Quest Aktif) */
            /* Lokasi: Depan Candi Kuno (Timur Laut Peta) - UPDATE: DIPINDAHKAN DARI HUTAN */
            {id: 'monster_skripsi', x: 50, y: 13, name: 'Pencuri Naskah', imgSrc: 'images/monster-thief.png', type: 'static', schedule: 'always', questReq: 'find_draft', w: 45, h: 45},

            /* MOVED: Penjaga Dungeon dipindah agak ke depan (y:21) agar sejajar entrance */
            {id: 'penjagadungeon', x: 46, y: 21, name: 'Penjaga', imgSrc: 'images/penjagadungeon.png', type: 'service', schedule: 'always', w: 40, h: 60}, 
            
            /* UPDATE: AYAM DIKECILKAN (20x20) */
            {id: 'ayam1', x: 15, y: 15, name: 'Ayam', imgSrc: 'images/ayam.png', type: 'animal', sound: 'ayam', vx:0, vy:0, cooldown: 0, loveTimer: 0, schedule: 'day', w: 20, h: 20},
            {id: 'ayam2', x: 20, y: 18, name: 'Ayam', imgSrc: 'images/ayam.png', type: 'animal', sound: 'ayam', vx:0, vy:0, cooldown: 0, loveTimer: 0, schedule: 'day', w: 20, h: 20},
            
            {id: 'kambing1', x: 8, y: 20, name: 'Kambing', imgSrc: 'images/kambing.png', type: 'animal', sound: 'kambing', vx:0, vy:0, cooldown: 0, loveTimer: 0, schedule: 'day', w: 32, h: 32},
            {id: 'kambing2', x: 10, y: 22, name: 'Kambing', imgSrc: 'images/kambing.png', type: 'animal', sound: 'kambing', vx:0, vy:0, cooldown: 0, loveTimer: 0, schedule: 'day', w: 32, h: 32},
            
            /* UPDATE: SAPI & KUDA DIPERBESAR (50x40) */
            {id: 'sapi1', x: 45, y: 30, name: 'Sapi', imgSrc: 'images/sapi.png', type: 'animal', sound: 'sapi', vx:0, vy:0, cooldown: 0, loveTimer: 0, schedule: 'day', w: 50, h: 40},
            {id: 'kuda1', x: 40, y: 15, name: 'Kuda', imgSrc: 'images/kuda.png', type: 'animal', sound: 'kuda', vx:0, vy:0, cooldown: 0, loveTimer: 0, schedule: 'day', w: 50, h: 40}
        ],
        objects: [
            /* UPDATE: Papan Misi & Statue dipindah ke buildings */
            
            /* NEW: DEKORASI LAHAN PERTANIAN (BELAKANG RUMAH) */
            // UPDATE: Papan Tanda digeser ke kanan dan atas (x:26, y:5) agar tidak tertutup pohon
            // UPDATE: Menggunakan gambar khusus 'papantani.png'
            // UPDATE: Diperbesar jadi 2x2
            {x: 27, y: 5, w: 2, h: 2, type: 'sign', icon: '', text: "Lahan ini terbengkalai. Kamu harus mempekerjakan Kurcaci Tani dan Peri Panen untuk membersihkan lahan ini dan mulai bertani.", img: 'images/papantani.png'},
            // UPDATE: Orang-orangan Sawah dipindah keluar petak (x:15, y:6) agar tidak menutupi tanaman
            {x: 15, y: 6, w: 2, h: 2, type: 'sign', icon: '', text: "Orang-orangan Sawah: Menjaga tanaman dari burung.", img: 'images/orangsawah.png'},
            // Petak air kecil untuk menyiram (Tile ID 0 manual atau objek sumur)
            // UPDATE: Posisi Sumur dipindah ke kiri (x:23, y:6) menggantikan posisi kosong dekat rumah
            // UPDATE: Sumur diperbesar jadi 2x2
            {x: 23, y: 8, w: 2, h: 2, type: 'sign', icon: '', text: "Sumur Tua: Sumber air untuk menyiram tanaman.", img: 'images/sumur.png'},
           // --- FIX: MENGEMBALIKAN KOTAK POS YANG HILANG ---
            // Posisi: Sebelah kanan pintu rumah (x:23, y:10)
            {x: 23, y: 10, w: 1, h: 1, type: 'mailbox', icon: '', img: 'images/pos.png'},



		   // --- [BARU] BONEKA SALJU (HANYA MUNCUL SAAT WINTER) ---
// Posisi: Dekat Rumah Player (x:22, y:9)
{
    x: 22, y: 9, 
    w: 1, h: 2, 
    type: 'snowman', // Tipe baru
    icon: '', 
    name: 'Boneka Salju', 
    img: 'images/snowman.png',
    seasonReq: 'winter' // SYARAT WAJIB: Hanya muncul saat Winter
},
// Posisi: Dekat Patung Tengah (x:20, y:28)
{
    x: 20, y: 28, 
    w: 1, h: 2, 
    type: 'snowman', 
    icon: '', 
    name: 'Boneka Salju', 
    img: 'images/snowman.png',
    seasonReq: 'winter'
},
            // --- NEW: KEBUN BUNGA AYU (DI PINGGIR RUMAH AYU) ---
            // Posisi Rumah Ayu: x:14, y:25. Kebun ditaruh di kirinya.
            // UPDATE: Geser ke bawah sedikit (y:27) agar pas dan belakangnya bisa dilewati
            {x: 10, y: 27, w: 4, h: 3, type: 'sign', icon: '', text: "Kebun Bunga Ayu: Harum semerbak bunga melati dan mawar.", img: 'images/kebunayu.png'},

            // Meja & Kursi Santai (DIPINDAH KE KANAN & KIRI POHON SAKURA di 16,13)
            // UPDATE: Ukuran diperbesar (w:2, h:2) setara setengah bangunan
            {x: 13, y: 13, w: 2, h: 2, type: 'table', icon: '', img: 'images/kursi.png'}, // Kiri Pohon
            {x: 17, y: 13, w: 2, h: 2, type: 'table', icon: '', img: 'images/kursi.png'}, // Kanan Pohon
            
            // --- NEW: BUNGA LIAR (ITEM PICKUP) ---
            // Tersebar di beberapa titik desa
            {x: 8, y: 22, w: 1, h: 1, type: 'wild_flower', icon: '', img: 'images/bunga.png', name: 'Bunga Liar'},
            {x: 15, y: 18, w: 1, h: 1, type: 'wild_flower', icon: '', img: 'images/bunga.png', name: 'Bunga Liar'},
            {x: 45, y: 10, w: 1, h: 1, type: 'wild_flower', icon: '', img: 'images/bunga.png', name: 'Bunga Liar'},
            {x: 35, y: 35, w: 1, h: 1, type: 'wild_flower', icon: '', img: 'images/bunga.png', name: 'Bunga Liar'},
            {x: 5, y: 25, w: 1, h: 1, type: 'wild_flower', icon: '', img: 'images/bunga.png', name: 'Bunga Liar'},
            {x: 52, y: 30, w: 1, h: 1, type: 'wild_flower', icon: '', img: 'images/bunga.png', name: 'Bunga Liar'}
        ]
    },
    /* NEW: MERCHANT INTERIOR MAP ADDED */
    'merchant_interior': {
        w: MERCH_W, h: MERCH_H,
        tiles: merchTiles,
        buildings: [
            { id: 'shop_exit', x: 6, y: 11, w: 3, h: 1, type: 'trigger', entrance: {x: 7, y: 11}, name: "Keluar Toko" }
        ],
        npcs: [
            /* UPDATE: NAMA DIUBAH JADI 'MERCHANT' (SESUAI REQUEST) */
            /* UPDATE: GAMBAR DIGANTI KE job.png UNTUK BOSS TOKO */
            {id: 'boss_merchant', x: 7, y: 3, name: 'Merchant', imgSrc: 'images/job.png', type: 'service', schedule: 'always', w: 40, h: 60},

            /* NEW: ISTRI BOS (PEDAGANG KELILING) PINDAH KE DALAM SAAT MALAM */
            /* Muncul hanya saat 'night' (18:00 ke atas) */
            {id: 'trader_wife_inside', x: 10, y: 4, name: 'Istri Bos', imgSrc: 'images/merchant.png', type: 'static', schedule: 'night', w: 40, h: 60}
        ],
        objects: [
            /* UPDATE: Meja Kasir dengan gambar images/mejakasir.png */
            {x: 7, y: 2, type: 'counter', icon: '', img: 'images/mejakasir.png'},
            
            /* UPDATE: Gambar Rak diubah menjadi Etalase Besar (Ukuran 2x2) sesuai request */
            /* Etalase Kiri (Tipe 1 - Barang Umum) */
            {x: 1, y: 5, w: 2, h: 2, type: 'shelf', icon: '', img: 'images/etalasetoko1.png', text: "Etalase Sembako"}, 
            {x: 1, y: 8, w: 2, h: 2, type: 'shelf', icon: '', img: 'images/etalasetoko1.png', text: "Etalase Perkakas"},
            
            /* Etalase Kanan (Tipe 2 - Barang Mewah) */
            {x: 12, y: 5, w: 2, h: 2, type: 'shelf', icon: '', img: 'images/etalasetoko2.png', text: "Etalase Perhiasan"}, 
            {x: 12, y: 8, w: 2, h: 2, type: 'shelf', icon: '', img: 'images/etalasetoko2.png', text: "Etalase Kain Sutra"},
            
            {x: 7, y: 11, type: 'door_out', icon: ''}
        ]
    },
    /* NEW: LIBRARY INTERIOR MAP ADDED */
    'library_interior': {
        w: LIB_W, h: LIB_H,
        tiles: libTiles,
        buildings: [
            { id: 'library_exit', x: 6, y: 11, w: 3, h: 1, type: 'trigger', entrance: {x: 7, y: 11}, name: "Keluar Perpus" }
        ],
        npcs: [
            /* UPDATE: Pustakawan diposisikan di tengah belakang meja (x:6.5) dan mundur sedikit (y:1.8) */
            /* Menggunakan koordinat desimal agar presisi di tengah meja yang lebarnya 2 tile */
            {id: 'librarian', x: 6.5, y: 1.8, name: 'Pustakawan', imgSrc: 'images/penjagaperpus.png', type: 'service', schedule: 'always', w: 40, h: 60},
            
            /* ADDED: NPC CINTA MATRE (Hanya muncul di Perpus sesuai gender pemain) */
            /* Siska (cewek matre) muncul jika pemain Cowok - DI PERPUSTAKAAN */
            {id: 'lover_matre_girl', x: 11, y: 8, name: 'Siska (Sosialita)', imgSrc: 'images/lover_matre_girl.png', type: 'wander', schedule: 'day', genderReq: 'boy', w: 40, h: 60},
            
            /* NEW: NPC KUTUBUKU (Pemberi Quest Skripsi Tahun ke-3) */
            {id: 'kutubuku', x: 2, y: 8, name: 'Senior Kutubuku', imgSrc: 'images/kutubuku.png', type: 'static', schedule: 'day', w: 40, h: 60}
        ],
        objects: [
            /* UPDATE: MEJA PUSTAKAWAN (Image Baru & Ukuran Diperbesar w:2) */
            /* Digeser ke x:6 agar posisinya pas di tengah depan NPC (x:7) */
            {x: 6, y: 3, w: 2, h: 1, type: 'table', icon: '', img: 'images/mejapustakawan.png'},

            /* UPDATE: Ukuran Rak Buku Diperbesar (w:3, h:3) agar terlihat Raksasa & Megah */
            /* Posisi disesuaikan (x digeser mendekat tembok) agar muat */
            {x: 1, y: 3, w: 3, h: 3, type: 'bookshelf', icon: '', text: "Sejarah Pulau Arsa Vol.1", img: 'images/rakbuku.png'},
            {x: 10, y: 3, w: 3, h: 3, type: 'bookshelf', icon: '', text: "Ensiklopedia Monster", img: 'images/rakbuku.png'},
            {x: 1, y: 7, w: 3, h: 3, type: 'bookshelf', icon: '', text: "Resep Masakan Kuno", img: 'images/rakbuku.png'},
            {x: 10, y: 7, w: 3, h: 3, type: 'bookshelf', icon: '', text: "Legenda Cincin Raja", img: 'images/rakbuku.png'},
            
            /* UPDATE: KURSI BACA DIPERBESAR (w:2, h:2) & POSISI DISESUAIKAN AGAR TIDAK DEMPET */
            {x: 5, y: 5, w: 2, h: 2, type: 'table', icon: '', img: 'images/kursimahasiswa.png'}, 
            {x: 8, y: 5, w: 2, h: 2, type: 'table', icon: '', img: 'images/kursimahasiswa.png'},
            {x: 5, y: 8, w: 2, h: 2, type: 'table', icon: '', img: 'images/kursimahasiswa.png'}, 
            {x: 8, y: 8, w: 2, h: 2, type: 'table', icon: '', img: 'images/kursimahasiswa.png'},

            /* REVISI: POSISI VAS BUNGA DIPINDAH KE BELAKANG PUSTAKAWAN (y:1) */
            /* Ditaruh di x:5 dan x:8 agar mengapit pustakawan, tidak menempel tembok atas (y:0) */
            {x: 5, y: 1, type: 'bookshelf', icon: '', text: "Vas Bunga Putih: Harum bunga melati.", img: 'images/vasputih.png'},
            {x: 8, y: 1, type: 'bookshelf', icon: '', text: "Vas Bunga Putih: Hiasan yang elegan.", img: 'images/vasputih.png'},

            {x: 7, y: 11, type: 'door_out', icon: ''}
        ]
    },
    /* NEW: GUILD INTERIOR MAP ADDED (FIX: Masalah Masuk Guild) */
    'guild_interior': {
        w: GUILD_W, h: GUILD_H,
        tiles: guildTiles,
        buildings: [
            { id: 'guild_exit', x: 7, y: 13, w: 3, h: 1, type: 'trigger', entrance: {x: 8, y: 13}, name: "Keluar Guild" }
        ],
        npcs: [
            /* UPDATE: GAMBAR GUILD MASTER DIUBAH KE masterguild.png */
            /* UPDATE: Posisi disesuaikan ke x:7 (Tengah meja 3 petak yang dimulai dari x:6) */
            /* y: 2.2 agar terlihat berdiri di belakang meja */
            {id: 'guild_master', x: 7, y: 2.2, name: 'Guild Master', imgSrc: 'images/masterguild.png', type: 'service', schedule: 'always', w: 40, h: 60},
            
            /* UPDATE: SATRIA (KSATRIA) DIPINDAH KE DALAM SINI (Menggantikan Petualang Veteran) */
            {id: 'lover2boy', x: 4, y: 8, name: 'Satria (Ksatria)', imgSrc: 'images/lover2boy.png', type: 'lover', schedule: 'always', w: 40, h: 60},
            
            /* ADDED: Rendi (Cowok Matre) muncul jika pemain Cewek - DI GUILD */
            {id: 'lover_matre_boy', x: 12, y: 8, name: 'Rendi (Anak Sultan)', imgSrc: 'images/lover_matre_boy.png', type: 'wander', schedule: 'day', genderReq: 'girl', w: 40, h: 60}
        ],
        objects: [
            /* UPDATE: MEJA MASTER GUILD (DIPERBESAR JADI 3x2) */
            /* Digeser ke x:6 agar posisinya center di ruangan lebar 16 (6,7,8) */
            {x: 6, y: 2, w: 3, h: 2, type: 'table', icon: '', img: 'images/mejamasterguild.png', text: "Meja Guild Master: Tempat strategi dan misi rahasia."},
            
            /* UPDATE: Papan Guild Diperbesar (w:3, h:2) */
            /* UPDATE: Menambahkan ID 'guild_board' agar bisa diinteraksi sebagai Bounty Board */
            {id: 'guild_board', x: 1, y: 5, w: 3, h: 2, type: 'sign', icon: '', text: "Papan Bounty Guild", img: 'images/papanguild.png'},
            
            /* REVERT: MEJA MAKAN GUILD (Dikembalikan ke ukuran w:2, h:2 agar proporsional) */
            /* Posisi di kanan */
            {x: 13, y: 5, w: 2, h: 2, type: 'sign', icon: '', text: "Meja Perjamuan", img: 'images/mejamakanguild.png'},
            
            /* UPDATE: Menambahkan Vas Bunga Putih di Guild (Dekorasi) */
            {x: 1, y: 10, type: 'bookshelf', icon: '', text: "Vas Bunga Putih: Menambah kesan elegan di markas para petarung.", img: 'images/vasputih.png'},

            {x: 8, y: 13, type: 'door_out', icon: ''}
        ]
    },
    'school_interior': {
        w: SCHOOL_W, h: SCHOOL_H,
        tiles: schoolTiles,
        buildings: [
            { id: 'school_exit', x: 7, y: 13, w: 3, h: 1, type: 'trigger', entrance: {x: 8, y: 13}, name: "Keluar Kampus" }
        ],
        npcs: [
            // Dosen di depan kelas
            {id: 'lecture', x: 8, y: 3, name: 'Dosen Pembimbing', imgSrc: 'images/lecture.png', type: 'service', schedule: 'day', w: 40, h: 60},
            
            // Mahasiswa yang sedang belajar
            {id: 'student1', x: 3, y: 7, name: 'Mahasiswa Rajin', imgSrc: 'images/mahasiswakiri.png', type: 'wander', schedule: 'day', w: 40, h: 60},
            
            // UPDATE: MAHASISWA MALAS JADI STATIC & DUDUK (DI BELAKANG MEJA KANAN)
            // Posisi y:5 agar terlihat duduk di balik meja y:6
            {id: 'student2', x: 12, y: 5, name: 'Mahasiswa Santai', imgSrc: 'images/mahasiswakanan.png', type: 'static', schedule: 'day', w: 40, h: 60},
            
            // Teman Love Interest (Putri - Scholar) sering di kampus
            /* REVISI JADWAL PUTRI: PAGI (MORNING) DI KAMPUS, SORE DI LUAR */
            {id: 'lover2girl', x: 11, y: 9, name: 'Putri (Scholar)', imgSrc: 'images/lover2girl.png', type: 'lover', schedule: 'morning', w: 40, h: 60} 
        ],
        objects: [
            // Papan Tulis Besar di Depan - UPDATE: Diperbesar (w:4, h:1.5) dan posisi disesuaikan (x:6, y:0.5)
            {x: 6, y: 0.5, w: 4, h: 1.5, type: 'sign', icon: '', img: 'images/papan.png', text: "Materi Hari Ini: \n1. Sejarah Nusantara Arsa \n2. Dasar-dasar Ekonomi \n3. Etika Berpetualang"},
            
            // Meja Dosen
            {x: 8, y: 2, type: 'table', icon: '', img: 'images/mejadosen.png'},

            // Barisan Meja Mahasiswa (Kiri) - UPDATE: Pakai images/kursimahasiswa.png
            {x: 3, y: 6, type: 'table', icon: '', img: 'images/kursimahasiswa.png'}, {x: 4, y: 6, type: 'table', icon: '', img: 'images/kursimahasiswa.png'},
            {x: 3, y: 9, type: 'table', icon: '', img: 'images/kursimahasiswa.png'}, {x: 4, y: 9, type: 'table', icon: '', img: 'images/kursimahasiswa.png'},

            // Barisan Meja Mahasiswa (Kanan) - UPDATE: Pakai images/kursimahasiswa.png
            {x: 11, y: 6, type: 'table', icon: '', img: 'images/kursimahasiswa.png'}, {x: 12, y: 6, type: 'table', icon: '', img: 'images/kursimahasiswa.png'},
            {x: 11, y: 9, type: 'table', icon: '', img: 'images/kursimahasiswa.png'}, {x: 12, y: 9, type: 'table', icon: '', img: 'images/kursimahasiswa.png'},

            // Rak Buku / Referensi di belakang/samping (UPDATE: Ukuran 2x2)
            {x: 1, y: 3, w: 2, h: 2, type: 'bookshelf', icon: '', text: "Ensiklopedia Dunia", img: 'images/rakbuku.png'},
            /* UPDATE: Posisi rak kanan digeser ke x:13 agar tidak menabrak tembok saat diperlebar */
            {x: 13, y: 3, w: 2, h: 2, type: 'bookshelf', icon: '', text: "Jurnal Ilmiah", img: 'images/rakbuku.png'},
            
            /* UPDATE: Mengubah Pot Tanaman Hias menjadi Vas Bunga Putih */
            {x: 1, y: 10, type: 'bookshelf', icon: '', text: "Vas Bunga Putih", img: 'images/vasputih.png'},

            {x: 8, y: 13, type: 'door_out', icon: ''}
        ]
    },
    /* NEW: BLACKSMITH INTERIOR ADDED */
    'blacksmith_interior': {
        w: SMITH_W, h: SMITH_H,
        tiles: smithTiles,
        buildings: [
            { id: 'smith_exit', x: 6, y: 11, w: 3, h: 1, type: 'trigger', entrance: {x: 7, y: 11}, name: "Keluar Bengkel" }
        ],
        npcs: [
            {id: 'blacksmith', x: 7, y: 4, name: 'Kepala Bengkel', imgSrc: 'images/blacksmith.png', type: 'service', schedule: 'always', w: 40, h: 60},
            /* NEW: MARINE (PENJAHIT/ISTRI BLACKSMITH) */
            /* Posisi di sebelah kiri, dekat material */
            {id: 'marine_tailor', x: 3, y: 5, name: 'Marine (Penjahit)', imgSrc: 'images/marine.png', type: 'service', schedule: 'always', w: 40, h: 60}
        ],
        objects: [
            /* UPDATE: TUNGKU DENGAN GAMBAR (Diperbesar jadi 2x2) */
            {x: 2, y: 3, w: 2, h: 2, type: 'sign', icon: '', text: "Tungku Peleburan (Panas!)", img: 'images/tungku.png'},
            
            /* UPDATE: RAK SENJATA DENGAN GAMBAR (Diperbesar jadi 2x2) */
            {x: 11, y: 3, w: 2, h: 2, type: 'sign', icon: '', text: "Rak Senjata: Pedang, Kapak, dan Zirah.", img: 'images/raksenajata.png'}, 
            
            /* UPDATE: PARON DENGAN GAMBAR */
            {x: 7, y: 6, type: 'sign', icon: '', text: "Paron (Anvil) untuk menempa besi.", img: 'images/paron.png'},
            
            // Dekorasi material
            /* UPDATE: BIJIH BESI DENGAN GAMBAR */
            {x: 2, y: 8, type: 'shelf', icon: '', text: "Tumpukan Bijih Besi", img: 'images/bijihbesi.png'},
            
            /* UPDATE: KAYU BAKAR DENGAN GAMBAR */
            {x: 11, y: 8, type: 'shelf', icon: '', text: "Tumpukan Kayu Bakar", img: 'images/kayubakar.png'},
            
            /* UPDATE: MEJA JAHIT MARINE (Dengan Gambar) */
            {x: 2, y: 5, w: 2, h: 2, type: 'table', icon: '', text: "Meja Jahit: Penuh dengan kain sutra dan benang emas.", img: 'images/mejajahit.png'},

            {x: 7, y: 11, type: 'door_out', icon: ''}
        ]
    },
    /* NEW: MENTOR INTERIOR ADDED */
    'mentor_interior': {
        w: MENTOR_W, h: MENTOR_H,
        tiles: mentorTiles,
        buildings: [
            { id: 'mentor_exit', x: 6, y: 11, w: 3, h: 1, type: 'trigger', entrance: {x: 7, y: 11}, name: "Keluar Rumah" }
        ],
        npcs: [
            // Gunakan ID 'mentor' agar relationship & dialog sama dengan yang di luar
            {id: 'mentor', x: 7, y: 4, name: 'Mentor Budi', imgSrc: 'images/mentor.png', type: 'mentor', schedule: 'always', w: 40, h: 60}
        ],
        objects: [
            /* UPDATE: Rak Buku Mentor Diperbesar jadi 3x3 */
            {x: 1, y: 3, w: 3, h: 3, type: 'bookshelf', icon: '', text: "Ensiklopedia Pendidikan", img: 'images/rakmentor.png'},
            
            /* UPDATE: Piala DIKECILKAN jadi 1x1 (Sebelumnya 2x2) */
            {x: 4, y: 3, w: 1, h: 1, type: 'bookshelf', icon: '', text: "Piala: Guru Terbaik Se-Nusantara", img: 'images/pialamentor.png'},
            
            /* UPDATE: Vas Bunga Mentor DIKECILKAN jadi 1x1 (Sebelumnya 2x2) */
            {x: 11, y: 3, w: 1, h: 1, type: 'shelf', icon: '', text: "Vas Bunga Antik dari Murid", img: 'images/vasmentor.png'},
            
            /* UPDATE: Meja Mentor DIKECILKAN jadi 2x1 (Sebelumnya 2x2) */
            {x: 6, y: 3, w: 2, h: 1, type: 'table', icon: '', img: 'images/mejamentor.png', name: "Meja Mentor"}, 
            
            // Dekorasi Rumah
            /* UPDATE: GANTI IKON MENJADI GAMBAR TUMPUKAN KERTAS */
            {x: 2, y: 8, type: 'shelf', icon: '', text: "Tumpukan Tugas Siswa", img: 'images/tumpukankertas.png'},
            
            /* UPDATE: GANTI IKON MENJADI GAMBAR FOTO MENTOR */
            {x: 11, y: 8, type: 'shelf', icon: '', text: "Foto Angkatan Pertama", img: 'images/fotomentor.png'},

            {x: 7, y: 11, type: 'door_out', icon: ''}
        ]
    },
    /* NEW: CLINIC INTERIOR MAP ADDED */
    'clinic_interior': {
        w: CLINIC_W, h: CLINIC_H,
        tiles: clinicTiles,
        buildings: [
            { id: 'clinic_exit', x: 6, y: 11, w: 3, h: 1, type: 'trigger', entrance: {x: 7, y: 11}, name: "Keluar Klinik" }
        ],
        npcs: [
            /* Dr. Budi (Love Interest) dipindah ke sini */
            {id: 'lover1boy', x: 7, y: 4, name: 'Dr. Budi', imgSrc: 'images/lover1boy.png', type: 'service', schedule: 'always', w: 40, h: 60},
            
            /* UPDATE: Mengubah Perawat menjadi Pasien Perempuan dengan gambar baru */
            {id: 'patient_girl', x: 3, y: 5, name: 'Pasien', imgSrc: 'images/pasien.png', type: 'wander', schedule: 'day', w: 40, h: 60} 
        ],
        objects: [
            /* Meja Dokter - UPDATE: Menggunakan gambar khusus mejadokter.png */
            /* UPDATE: UKURAN DIPERBESAR JADI 2x2 DAN POSISI DIGESER AGAR PAS DI TENGAH */
            {x: 6, y: 3, w: 2, h: 2, type: 'table', icon: '', img: 'images/mejadokter.png'}, 
            
            /* Lemari Obat & Arsip - UPDATE: Menggunakan gambar khusus lemariobat.png & arsiprekammedis.png */
            {x: 1, y: 3, w: 2, h: 2, type: 'shelf', icon: '', text: "Lemari Obat Lengkap", img: 'images/lemariobat.png'},
            {x: 11, y: 3, w: 2, h: 2, type: 'shelf', icon: '', text: "Arsip Rekam Medis", img: 'images/arsiprekammedis.png'},
            
            /* Bed Pasien (UPDATE: Dikecilkan jadi 2x3 agar tidak melayang) */
            /* Sebelumnya w:3, h:4 (terlalu besar sehingga shadow jatuh jauh di bawah gambar) */
            {x: 2, y: 7, w: 2, h: 3, type: 'bed', icon: '', img: 'images/bedklinik.png', name: "Bed Pasien 1"},
            {x: 11, y: 7, w: 2, h: 3, type: 'bed', icon: '', img: 'images/bedklinik.png', name: "Bed Pasien 2"}, // Geser X ke 11 agar simetris

            {x: 7, y: 11, type: 'door_out', icon: ''}
        ]
    },
    /* NEW: WEDDING INTERIOR ADDED */
    'wedding_interior': {
        w: WEDDING_W, h: WEDDING_H,
        tiles: weddingTiles,
        buildings: [
            { id: 'wedding_exit', x: 6, y: 13, w: 3, h: 1, type: 'trigger', entrance: {x: 7, y: 13}, name: "Keluar Balai" }
        ],
        npcs: [
            /* NPC Penghulu di Altar */
            /* UPDATE: Ganti gambar Penghulu menjadi modin.png */
            {id: 'penghulu', x: 6.5, y: 2, name: 'Bapak Penghulu', imgSrc: 'images/modin.png', type: 'service', schedule: 'always', w: 40, h: 60}
        ],
        objects: [
            /* NEW: ALTAR/PELAMINAN (DIBELAKANG MEJA MODIN) */
            /* Posisi y:1 agar berada di belakang meja (y:3) dan penghulu (y:2) */
            {x: 5.5, y: 1, w: 3, h: 2, type: 'sign', icon: '', text: "Altar Suci: Tempat janji setia diucapkan di hadapan Tuhan.", img: 'images/altar.png'},

            /* Altar/Meja Akad di Tengah Depan */
            /* UPDATE: Mengubah gambar meja menjadi mejamodin.png */
            /* REVISI: Ukuran diperbesar jadi 3x2 (Sebelumnya 2x1) dan digeser sedikit agar tetap di tengah */
            {x: 5.5, y: 3, w: 3, h: 2, type: 'table', icon: '', img: 'images/mejamodin.png'}, 
            
            /* Kursi Tamu Kiri (Barisan Rapi) */
            {x: 2, y: 6, type: 'table', icon: '', img: 'images/kursinikah.png'}, {x: 4, y: 6, type: 'table', icon: '', img: 'images/kursinikah.png'},
            {x: 2, y: 8, type: 'table', icon: '', img: 'images/kursinikah.png'}, {x: 4, y: 8, type: 'table', icon: '', img: 'images/kursinikah.png'},
            {x: 2, y: 10, type: 'table', icon: '', img: 'images/kursinikah.png'}, {x: 4, y: 10, type: 'table', icon: '', img: 'images/kursinikah.png'},

            /* Kursi Tamu Kanan (Barisan Rapi) */
            {x: 9, y: 6, type: 'table', icon: '', img: 'images/kursinikah.png'}, {x: 11, y: 6, type: 'table', icon: '', img: 'images/kursinikah.png'},
            {x: 9, y: 8, type: 'table', icon: '', img: 'images/kursinikah.png'}, {x: 11, y: 8, type: 'table', icon: '', img: 'images/kursinikah.png'},
            {x: 9, y: 10, type: 'table', icon: '', img: 'images/kursinikah.png'}, {x: 11, y: 10, type: 'table', icon: '', img: 'images/kursinikah.png'},

            /* Hiasan Bunga Mewah di Depan */
            {x: 1, y: 3, type: 'bookshelf', icon: '', text: "Bunga Pernikahan", img: 'images/vasputih.png'},
            {x: 12, y: 3, type: 'bookshelf', icon: '', text: "Bunga Pernikahan", img: 'images/vasputih.png'},
            
            /* Karpet Merah (Imajiner / Menggunakan tile floor biasa tapi area tengah dikosongkan untuk jalan) */

            {x: 7, y: 13, type: 'door_out', icon: ''}
        ]
    },
    /* NEW: PLAYER SHOP INTERIOR ADDED (RUKO PLAYER) */
    'player_shop_interior': {
        w: PSHOP_W, h: PSHOP_H,
        tiles: pShopTiles,
        buildings: [
            { id: 'pshop_exit', x: 6, y: 11, w: 3, h: 1, type: 'trigger', entrance: {x: 7, y: 11}, name: "Keluar Toko" }
        ],
        npcs: [], // Tidak ada NPC karena ini toko player
        objects: [
            /* --- AREA PRIVAT (LANTAI ATAS/BELAKANG) --- */
            
            /* 1. Kasur Player (Pojok Kiri Atas) - Untuk Tidur & Pulihkan Energi */
            {x: 1, y: 1, w: 3, h: 4, type: 'bed', icon: '', img: 'images/bed.png', name: "Kasur Player"},

            /* 2. Meja Telepon (Tengah Atas) - Untuk Belanja Furnitur/Upgrade */
            {x: 5, y: 1, w: 2, h: 2, type: 'catalog', icon: '', img: 'images/mejatelpon.png', name: "Meja Telepon"},

            /* 3. Meja Jurnal/Pembukuan (Pojok Kanan Atas) - Untuk Save Game & Belajar */
            {x: 11, y: 1, w: 2, h: 2, type: 'diary', icon: '', img: 'images/mejabelajar.png', name: "Pembukuan Toko"},

            /* 4. Kalender (Dinding Atas) - Cek Tanggal & Festival */
            {x: 9, y: 0, type: 'calendar', icon: '', img: 'images/kalender.png'},

            /* UPDATE: MENAMBAHKAN LEMARI PAKAIAN (WARDROBE) */
            /* Posisi di x:7, y:0 (Sebelah Meja Telepon) */
            {x: 7, y: 0, w: 2, h: 3, type: 'shelf', icon: '', text: "Lemari Pakaian Bisnis", img: 'images/lemari.png'},

            /* --- AREA TOKO (LANTAI BAWAH/DEPAN) --- */
            
            /* 5. Meja Kasir (Pemisah Ruangan - Menghadap Pintu) */
            {x: 6, y: 5, w: 2, h: 1, type: 'counter', icon: '', img: 'images/mejakasir.png', name: "Meja Kasir (Kelola)"},
            
            /* 6. Rak Display Barang (Kiri & Kanan) */
            {x: 1, y: 6, w: 2, h: 2, type: 'shelf', icon: '', text: "Rak Barang A", img: 'images/rakbuku.png'}, 
            {x: 1, y: 9, w: 2, h: 2, type: 'shelf', icon: '', text: "Rak Barang B", img: 'images/rakbuku.png'},
            
            {x: 11, y: 6, w: 2, h: 2, type: 'shelf', icon: '', text: "Rak Barang C", img: 'images/rakbuku.png'},
            {x: 11, y: 9, w: 2, h: 2, type: 'shelf', icon: '', text: "Rak Barang D", img: 'images/rakbuku.png'},

            /* Pintu Keluar */
            {x: 7, y: 11, type: 'door_out', icon: ''}
        ]
    },
    /* NEW: AYU'S HOUSE INTERIOR ADDED */
    'lover1_interior': {
        w: LOVER1_W, h: LOVER1_H,
        tiles: lover1Tiles,
        buildings: [
            { id: 'lover1_exit', x: 6, y: 11, w: 3, h: 1, type: 'trigger', entrance: {x: 7, y: 11}, name: "Keluar Rumah" }
        ],
        npcs: [
            /* Ayu (Gadis Desa) di dalam rumahnya - UPDATE: JADWAL JADI MALAM (NIGHT) AGAR TIDAK DOUBLE DENGAN YANG DI LUAR */
            {id: 'lover1girl', x: 7, y: 4, name: 'Ayu (Gadis Desa)', imgSrc: 'images/lover1girl.png', type: 'lover', schedule: 'night', w: 40, h: 60},
            
            /* NEW: AYA (SAUDARA KEMBAR AYU) - Tetap Always karena dia anak rumahan */
            /* Posisi di sebelah kiri ruangan */
            {id: 'aya_twin', x: 4, y: 4, name: 'Aya (Kembaran)', imgSrc: 'images/aya.png', type: 'static', schedule: 'always', w: 40, h: 60}
        ],
        objects: [
            /* Kasur Ayu - UPDATE: Menggunakan gambar khusus kasurayaayu.png */
            {x: 1, y: 2, w: 3, h: 4, type: 'bed', icon: '', img: 'images/kasurayaayu.png', name: "Kasur Ayu"},
            
            /* Dapur Sederhana - UPDATE: Menggunakan gambar khusus dapurayaayu.png */
            /* Digabung menjadi satu objek besar (2x2) */
            {x: 11, y: 2, w: 2, h: 2, type: 'shelf', icon: '', img: 'images/dapurayaayu.png', text: "Dapur: Bau kue labu yang enak."},
            
            /* Meja Makan Kecil - UPDATE: Menggunakan gambar mejaayaayu.png */
            {x: 11, y: 5, w: 2, h: 2, type: 'table', icon: '', img: 'images/mejaayaayu.png'}, 

            /* Banyak Tanaman/Bunga (Ayu suka bunga) */
            {x: 1, y: 8, type: 'bookshelf', icon: '', text: "Bunga Matahari", img: 'images/vasputih.png'},
            {x: 3, y: 8, type: 'bookshelf', icon: '', text: "Mawar Merah", img: 'images/vasputih.png'},
            {x: 10, y: 8, type: 'bookshelf', icon: '', text: "Tulip", img: 'images/vasputih.png'},
            {x: 12, y: 8, type: 'bookshelf', icon: '', text: "Melati", img: 'images/vasputih.png'},
            
            /* Lemari Pakaian - UPDATE: Menggunakan gambar khusus lemariayaayu.png */
            {x: 4, y: 1, w: 2, h: 3, type: 'shelf', icon: '', img: 'images/lemariayaayu.png', text: "Lemari Pakaian Ayu"},

            {x: 7, y: 11, type: 'door_out', icon: ''}
        ]
    },
    /* NEW: FISHERMAN HOUSE INTERIOR ADDED */
    'fisherman_interior': {
        w: FISH_W, h: FISH_H,
        tiles: fishTiles,
        buildings: [
            { id: 'fisherman_exit', x: 5, y: 9, w: 3, h: 1, type: 'trigger', entrance: {x: 6, y: 9}, name: "Keluar Rumah" }
        ],
        npcs: [
            /* Bu Nelayan di dalam rumah (Menjaga rumah saat suami kerja) */
            {id: 'istrinelayan', x: 6, y: 4, name: 'Bu Nelayan', imgSrc: 'images/istrinelayan.png', type: 'wander', schedule: 'always', w: 40, h: 60}
        ],
        objects: [
            /* Dekorasi Khas Nelayan */
            {x: 1, y: 2, w: 3, h: 2, type: 'shelf', icon: '', text: "Jaring Ikan: Sedang dijemur/diperbaiki.", img: 'images/jaringikan.png'},
            {x: 10, y: 2, type: 'shelf', icon: '', text: "Rak Pancing: Koleksi joran bambu tua.", img: 'images/rakpancing.png'},
            
            /* Hasil Tangkapan */
            {x: 10, y: 5, type: 'shelf', icon: '', text: "Ember Ikan: Bau amis tapi segar!", img: 'images/emberikan.png'},
            {x: 11, y: 5, type: 'shelf', icon: '', text: "Box Es: Untuk mengawetkan ikan.", img: 'images/boxes.png'},

            /* Kasur Sederhana */
            {x: 1, y: 6, w: 2, h: 3, type: 'bed', icon: '', img: 'images/kasurnelayan.png', name: "Kasur Nelayan"},
            
            /* Meja Makan - UPDATE: Diperbesar jadi 2x2 */
            {x: 6, y: 4, w: 2, h: 2, type: 'table', icon: '', img: 'images/mejamakanikan.png'},
            
            /* Piala/Penghargaan - UPDATE: Diperbesar jadi 2x2 */
            {x: 5, y: 1, w: 2, h: 2, type: 'shelf', icon: '', text: "Piala: Juara Mancing Ikan Mas 2023", img: 'images/rakpialaikan.png'},

            {x: 6, y: 9, type: 'door_out', icon: ''}
        ]
    },
    /* NEW: CANDI INTERIOR MAP ADDED */
    'candi_interior': {
        w: CANDI_W, h: CANDI_H,
        tiles: candiTiles,
        buildings: [
            { id: 'candi_exit', x: 6, y: 15, w: 3, h: 1, type: 'trigger', entrance: {x: 7, y: 15}, name: "Keluar Candi" }
        ],
        npcs: [
            /* NEW: DEWI RORO (PENJAGA CANDI) */
            /* Posisi disesuaikan (x:7.5, y:6.5) agar berdiri pas di depan Altar yang turun */
            /* UPDATE: SCHEDULE 'night' agar hanya muncul malam sampai pagi (20:00 - 06:00) */
            {id: 'dewi_roro', x: 7.5, y: 6.5, name: 'Dewi Roro', imgSrc: 'images/roro.png', type: 'static', schedule: 'night', w: 40, h: 60}
        ], 
        objects: [
            // ARCA UTAMA (Di Tengah Atas)
            // FIX: Ukuran diubah jadi 4x5 (Lebih Tinggi) agar tidak gepeng
            // Posisi tetap di y:1, tapi karena tingginya 5, dia akan memakan area y:1 s/d y:5
            {x: 6, y: 1, w: 4, h: 5, type: 'sign', icon: '', text: "Arca Utama: Memancarkan aura ketenangan masa lalu.", img: 'images/arcacandi.png'},
            
            // ARTIFAK KUNO (Kiri & Kanan)
            // UPDATE: Guci Abu sekarang menggunakan gambar 'images/gucicandi.png'
            // UPDATE TERBARU: Diperbesar jadi 2x2 dan bisa dilewati belakangnya
            {x: 2, y: 4, w: 2, h: 2, type: 'shelf', icon: '', text: "Guci Abu: Peninggalan dinasti kuno.", img: 'images/gucicandi.png'},
            // UPDATE: Prasasti Batu sekarang menggunakan gambar 'images/prasasticandi.png'
            // UPDATE TERBARU: Diperbesar jadi 2x2 dan bisa dilewati belakangnya
            {x: 13, y: 4, w: 2, h: 2, type: 'shelf', icon: '', text: "Prasasti Batu: Tertulis dalam bahasa Sansekerta.", img: 'images/prasasticandi.png'},
            
            // UPDATE: Lilin Abadi menggunakan gambar 'images/lilinabadi.png'
            {x: 2, y: 8, type: 'shelf', icon: '', text: "Lilin Abadi: Apinya tidak pernah padam.", img: 'images/lilinabadi.png'},
            {x: 13, y: 8, type: 'shelf', icon: '', text: "Lilin Abadi: Menerangi kegelapan candi.", img: 'images/lilinabadi.png'},
            
            // Meja Persembahan (Kuno) - UPDATE: Menggunakan images/mejaaltar.png
            // UPDATE: Posisi diturunkan ke y:7 karena patung memanjang sampai y:6
            // UPDATE TERBARU: Diperbesar jadi 2x2 (h:2) agar bisa dilewati belakangnya
            {x: 7, y: 7, w: 2, h: 2, type: 'table', icon: '', text: "Altar Persembahan", img: 'images/mejaaltar.png'},

            {x: 7, y: 15, type: 'door_out', icon: ''}
        ]
    },


// --- NEW: WARNET INTERIOR MAP (14x12) ---
    'warnet_interior': {
        w: 14, h: 12,
        // Kita pakai lantai kayu (ID 10) dan tembok putih (ID 11) agar terlihat modern
        tiles: (() => {
            const arr = new Array(14 * 12).fill(10); // 10 = Lantai Kayu
            // Buat Tembok Keliling
            for(let x=0; x<14; x++) { arr[0*14+x] = 11; arr[(12-1)*14+x] = 11; }
            for(let y=0; y<12; y++) { arr[y*14+0] = 11; arr[y*14+(14-1)] = 11; }
            arr[(12-1)*14 + 7] = 8; // Pintu Keluar
            return arr;
        })(),
        buildings: [
            /* FIX: KOORDINAT X DIPERBAIKI DARI 14 KE 6 AGAR SESUAI PINTU (x:7) */
            { id: 'warnet_exit', x: 6, y: 11, w: 3, h: 1, type: 'trigger', entrance: {x: 7, y: 11}, name: "Keluar Warnet" }
        ],
        npcs: [
            // OPERATOR (PENJAGA)
            {id: 'op_warnet', x: 7, y: 3, name: 'Operator (OP)', imgSrc: 'images/penjagawarnet.png', type: 'service', schedule: 'always', w: 40, h: 60},
            // MAID (PELAYAN MAKANAN)
            {id: 'maid_warnet', x: 11, y: 5, name: 'Mela (Maid)', imgSrc: 'images/maidwarnet.png', type: 'service', schedule: 'always', w: 40, h: 60}
        ],
        objects: [
            // Meja Operator
            {x: 6, y: 2, w: 2, h: 2, type: 'counter', icon: '', img: 'images/mejakasir.png', name: "Server Pusat"},
            
            // Bilik Komputer Kiri
            {x: 2, y: 5, w: 2, h: 2, type: 'table', icon: '', img: 'images/mejabelajar.png', name: "PC-01 (Gaming)"},
            {x: 2, y: 8, w: 2, h: 2, type: 'table', icon: '', img: 'images/mejabelajar.png', name: "PC-02 (Browsing)"},
            
            // Bilik Komputer Tengah
            {x: 5, y: 5, w: 2, h: 2, type: 'table', icon: '', img: 'images/mejabelajar.png', name: "PC-03 (VIP)"},
            {x: 5, y: 8, w: 2, h: 2, type: 'table', icon: '', img: 'images/mejabelajar.png', name: "PC-04 (Umum)"},
            
            // Rak Snack/Minuman
            {x: 11, y: 2, w: 2, h: 2, type: 'shelf', icon: '', text: "Kulkas Minuman Dingin", img: 'images/lemariobat.png'},

            {x: 7, y: 11, type: 'door_out', icon: ''}
        ]
    },   


   'dungeon': {
        w: DUNGEON_W, h: DUNGEON_H,
        tiles: dungeonTiles,
        npcs: [],
        objects: [], /* Exit Dungeon dipindah ke buildings agar otomatis */
        buildings: [
            ...dungeonRocks, // Batu-batu dungeon
            { id: 'dungeon_exit', x: 2, y: 2, w: 1, h: 1, type: 'trigger', entrance: {x: 2, y: 2}, name: "Keluar Dungeon" }
        ]
    },
    /* UPDATE: BATTLE ARENA (RERUNTUHAN) DENGAN DETAIL BARU */
    'ruins_battle': {
        w: RUINS_W, h: RUINS_H,
        tiles: ruinsTiles,
        npcs: [],
        buildings: [
            ...ruinsObstacles, // Puing-puing penghalang
            { id: 'ruins_exit', x: 10, y: 14, w: 2, h: 1, type: 'trigger', entrance: {x: 11, y: 14}, name: "Kabur (Keluar)" }
        ],
        objects: [] 
    },
    'house': {
        // Init with default, will be regenerated dynamically
        w: 12, h: 10,
        tiles: houseTiles,
        npcs: [],
        buildings: [
            { 
                id: 'house_exit', 
                x: 6 - 1, // doorX - 1 (doorX = 6)
                y: 9, // doorY (h-1)
                w: 3, 
                h: 1, 
                type: 'trigger', 
                entrance: {x: 6, y: 9}, 
                name: "Keluar Rumah" 
            }
        ],
        objects: [
            /* ADDED: KASUR PLAYER (Interactive Sleep) */
            /* UPDATE: Ganti gambar kasur jadi bed.png */
            /* REVISI POSISI: Dinaikkan ke y:0 agar lebih nempel tembok */
            /* REVISI UKURAN: Dikecilkan jadi 2x3 (Single Bed) agar proporsional */
            {x: 1, y: 0, w: 2, h: 3, type: 'bed', icon: '', img: 'images/bed.png', name: "Kasur Empuk"},

            /* UPDATE: MEJA BUKU HARIAN (Menggantikan Buku Melayang) */
            /* Posisi disesuaikan agar tidak menumpuk */
            /* REVISI: Mengganti images/mejabuku.png menjadi images/mejabelajar.png */
            /* UPDATE UKURAN: Diperbesar kembali jadi 2x2 */
            /* UPDATE POSISI: Diturunkan ke y:0 */
            {x: 4, y: 0, w: 2, h: 2, type: 'diary', icon: '', img: 'images/mejabelajar.png', name: "Meja Jurnal"},
            
            /* NEW: LEMARI PAKAIAN (WARDROBE) */
            {x: 7, y: 0, w: 2, h: 3, type: 'shelf', icon: '', text: "Lemari Pakaian: Berisi seragam dan baju santai.", img: 'images/lemari.png'},
            
            /* REVISI POSISI KALENDER: Geser ke x:10 (Pojok Kanan dinding atas) agar tidak mepet */
            {x: 10, y: 0, type: 'calendar', icon: '', img: 'images/kalender.png'},
            
            /* UPDATE: MEJA TELEPON (Menggantikan Telepon Melayang) */
            /* REVISI: Update gambar ke images/mejatelpon.png dan ukuran jadi 2x2 */
            /* UPDATE POSISI: Dinaikkan ke y:6 agar tidak nempel tembok bawah */
            {x: 2, y: 6, w: 2, h: 2, type: 'catalog', icon: '', img: 'images/mejatelpon.png', name: "Meja Telepon"} 
        ]
    }
};

/** GAME STATE */
const STATE = {
    screen: 'splash',
    day: 1,
    time: 0, 
    season: 'spring',
    weather: 'clear', 
    location: 'village',
    camera: { x: 0, y: 0 },
    player: {
        x: 18 * TILE_SIZE, 
        y: 11 * TILE_SIZE, 
        w: 20, h: 20,
        color: '#fbbf24', 
        gender: 'boy',
        spriteIdle: null,
        spriteWalk: null,
        // UPDATE: Speed dinaikkan (5 -> 7) agar gerakan terasa lebih cepat dan responsif
        speed: 7,
        direction: 'down',
        hp: 100, maxHp: 100,
        energy: 100,
        money: 10000,
        
        // NEW: Steps Counter untuk sistem kelelahan berjalan
        stepsTaken: 0,

        // NEW STATS
        level: 1,
        exp: 0,
        maxExp: 100,
        
        str: 5, // Strength (Fighter/Worker)
        int: 5, // Intelligence (Mage/Student)
        reputation: 0, // Reputation (Tanker/Family)
        biz: 0, // Business Skill (Support/Entrepreneur) -- NEW STAT ADDED
        
        married: false,
        spouseId: null, 
        houseLevel: 1,
        furniture: [],
        role: 'none', 
        major: null, // NEW: Jurusan Kuliah
        
        jobStatus: 'unemployed', 
        bossReputation: 50,
        shiftStarted: false,
        lastWorkedDay: 0,
        salaryDays: 0,
        
        // NEW: TRACKING ABSENSI KULIAH
        lastAttendanceDay: 0,

        attackCooldown: 0,
        skillCooldown: 0,
        isAttacking: false,
        
        // NEW: COMBAT COMBO SYSTEM
        comboCount: 0,      // Hitungan combo saat ini (1, 2, 3)
        comboWindow: 0,     // Waktu toleransi untuk lanjut ke combo berikutnya
        
        // NEW: DAMAGE FEEDBACK STATE
        hurtTimer: 0,       // Timer untuk animasi berkedip merah

        // NEW: SPRINT STATE
        isSprinting: false,

        reflections: [], 
        messages: [], 
        learnedSubjects: [], // FIX: Inisialisasi Array Mata Pelajaran
        ethics: 100,
        relationships: {}, 
        inventory: {}
    },
    isPrologue: false, 
    gameOverTriggered: false, 
    gameFinished: false, 
    freeRoamMode: false, 
    isDayChanging: false, // FIX: Flag pengaman agar hari tidak ganti ganda
    
    // QUEST FLAGS
    activeQuest: null, // 'find_draft' etc
    questProgress: {},
    
    // NEW: TUTORIAL FOCUS TARGET (LIVE TRACKING)
    tutorialFocusTarget: null, // { x: tileX, y: tileY }

    enemies: [],
    particles: [],
    weatherParticles: [],
    // NEW: FLOATING TEXT ARRAY (Damage Numbers)
    floatingTexts: [],
    
    critters: [], 
    lightningTimer: 0,
    shakeTimer: 0,     
    lightningX: 0,      
    
    minigame: null, 
    fishing: {
        active: false,
        barX: 0,
        barDir: 1,
        targetStart: 0,
        targetWidth: 0
    },
    // NEW: Cooldown agar tidak langsung teleport balik saat spawn
    teleportCooldown: 0,
    // NEW: Dungeon Level Tracker
    dungeonLevel: 1,
    bossSpawned: false, // NEW: Status apakah Boss sudah muncul
    
    // NEW: Flag Peringatan Energi
    lowEnergyWarned: false,

    // NEW: Flag Status Tutorial Dalam Rumah (Mencegah Keluar Pintu)
    tutorialIndoorComplete: false, 
    ghosts: [], 
    
    // --- [BARU] NAMA MENTOR DINAMIS ---
    mentorName: "Mentor Budi" 
};

const SEASONS = ['Spring', 'Summer', 'Autumn', 'Winter'];
// --- NEW: DEFINISI HARI DALAM SEMINGGU ---
const DAYS_OF_WEEK = ['Senin', 'Selasa', 'Rabu', 'Kamis', 'Jumat', 'Sabtu', 'Minggu'];

// --- FIX: DEFINISI HARI PER MUSIM (Mencegah Error 'DAYS_PER_SEASON is not defined') ---
const DAYS_PER_SEASON = 30; 

// --- NEW: GLOBAL CALENDAR EVENTS DATABASE ---
// Moved from interactObject to Global scope for access by Calendar UI
const CALENDAR_EVENTS = {
    'spring': {
        1: { name: "Tahun Baru", type: "festival", icon: "" },
        4: { name: "Ultah Dr. Budi", type: "birthday", icon: "" },
        14: { name: "Festival Bunga (Valentine)", type: "festival", icon: "" },
        18: { name: "Lomba Pacuan Kuda", type: "festival", icon: "" },
        25: { name: "Lomba Memasak", type: "festival", icon: "" }
    },
    'summer': {
        1: { name: "Buka Giling (Panen Raya)", type: "festival", icon: "" },
        7: { name: "Festival Ayam", type: "festival", icon: "" },
        15: { name: "Ultah Satria", type: "birthday", icon: "" },
        20: { name: "Lomba Berenang", type: "festival", icon: "" },
        23: { name: "Bulan Purnama Merah", type: "special", icon: "" },
        24: { name: "Festival Kembang Api", type: "festival", icon: "" }
    },
    'autumn': {
        2: { name: "Ultah Putri (Scholar)", type: "birthday", icon: "" },
        5: { name: "Festival Musik", type: "festival", icon: "" },
        15: { name: "Pesta Panen Anggur", type: "festival", icon: "" },
        21: { name: "Festival Domba", type: "festival", icon: "" },
        30: { name: "Malam Hantu (Halloween)", type: "festival", icon: "" }
    },
    'winter': {
        6: { name: "Ultah Ayu (Gadis Desa)", type: "birthday", icon: "" },
        10: { name: "Lomba Mancing Es", type: "festival", icon: "" },
        19: { name: "Pesta Sup Hangat", type: "festival", icon: "" },
        24: { name: "Malam Bintang (Natal)", type: "festival", icon: "" },
        30: { name: "Malam Akhir Tahun", type: "festival", icon: "" }
    }
};

// --- CALENDAR UI LOGIC ---
let calViewSeasonIdx = 0;
let calViewYear = 1;

function openCalendar() {
    if(typeof AudioService !== 'undefined') AudioService.playSFX('item'); 

    // Hitung Musim & Tahun Saat Ini sebagai Default View
    const totalDays = STATE.day - 1;
    calViewYear = Math.floor(totalDays / (DAYS_PER_SEASON * 4)) + 1;
    const seasonGlobalIdx = Math.floor((totalDays % (DAYS_PER_SEASON * 4)) / DAYS_PER_SEASON);
    calViewSeasonIdx = seasonGlobalIdx; // 0=Spring, 1=Summer...

    renderCalendar();
    
    document.getElementById('calendar-modal').style.display = 'flex';
    STATE.screen = 'modal';
}

function closeCalendar() {
    document.getElementById('calendar-modal').style.display = 'none';
    STATE.screen = 'play';
}

function changeCalendarMonth(dir) {
    calViewSeasonIdx += dir;
    
    // Handle Year Rollover
    if(calViewSeasonIdx > 3) {
        calViewSeasonIdx = 0;
        calViewYear++;
    } else if (calViewSeasonIdx < 0) {
        calViewSeasonIdx = 3;
        calViewYear--;
        if(calViewYear < 1) { // Batas bawah tahun 1
            calViewYear = 1;
            calViewSeasonIdx = 0;
        }
    }
    
    // SFX Page Flip
    if(typeof AudioService !== 'undefined') AudioService.playSFX('bg');
    
    renderCalendar();
}

function renderCalendar() {
    const seasonName = SEASONS[calViewSeasonIdx].toLowerCase();
    const seasonDisplayName = SEASONS[calViewSeasonIdx].toUpperCase();
    
    // Update Header
    document.getElementById('cal-season-text').innerText = seasonDisplayName;
    // Ganti warna header sesuai musim
    const colors = { 'spring': '#f472b6', 'summer': '#facc15', 'autumn': '#fb923c', 'winter': '#60a5fa' };
    document.getElementById('cal-season-text').style.color = colors[seasonName];
    document.getElementById('cal-year-text').innerText = `TAHUN KE-${calViewYear}`;

    // Reset Info Detail
    document.getElementById('cal-detail-date').innerText = "Pilih Tanggal";
    document.getElementById('cal-detail-desc').innerText = "Klik tanggal untuk melihat info.";

    // Render Grid
    const grid = document.getElementById('cal-grid-container');
    // Hapus cell lama (sisa header)
    const oldCells = grid.querySelectorAll('.cal-cell');
    oldCells.forEach(c => c.remove());

    // Hitung Data Hari Ini (Real-time)
    const currentTotalDays = STATE.day - 1;
    const currentYear = Math.floor(currentTotalDays / (DAYS_PER_SEASON * 4)) + 1;
    const currentSeasonIdx = Math.floor((currentTotalDays % (DAYS_PER_SEASON * 4)) / DAYS_PER_SEASON);
    const currentDayDate = (currentTotalDays % DAYS_PER_SEASON) + 1;
    
    const isCurrentMonthView = (calViewYear === currentYear && calViewSeasonIdx === currentSeasonIdx);

    // Render 30 Hari
    for (let d = 1; d <= 30; d++) {
        const cell = document.createElement('div');
        cell.className = 'cal-cell';
        
        // Nomor Tanggal
        const num = document.createElement('div');
        num.className = 'cal-num';
        num.innerText = d;
        cell.appendChild(num);

        // Cek Event
        const eventData = CALENDAR_EVENTS[seasonName][d];
        if (eventData) {
            const icon = document.createElement('div');
            icon.className = 'cal-icon';
            icon.innerText = eventData.icon;
            cell.appendChild(icon);
            
            // Tambah kelas warna
            if(eventData.type === 'birthday') {
                cell.classList.add('birthday');
                // Dot marker biru
                const dot = document.createElement('div');
                dot.className = 'cal-dot';
                dot.style.background = '#60a5fa';
                cell.appendChild(dot);
            } else {
                cell.classList.add('festival');
                // Dot marker pink
                const dot = document.createElement('div');
                dot.className = 'cal-dot';
                dot.style.background = '#f472b6';
                cell.appendChild(dot);
            }
        }

        // Highlight Hari Ini
        if (isCurrentMonthView && d === currentDayDate) {
            cell.classList.add('today');
            cell.title = "HARI INI";
        }

        // OnClick Handler
        cell.onclick = () => {
            const dayName = DAYS_OF_WEEK[(d - 1) % 7]; // Sederhana: Tgl 1 selalu Senin di game ini? (Asumsi)
            // Sebenarnya hari bergeser tiap bulan (30 % 7 = 2 sisa), tapi untuk simpel kita pakai index statis atau hitung global
            // Kita pakai nama hari statis per tanggal saja untuk UI simpel
            
            const detailDate = document.getElementById('cal-detail-date');
            const detailDesc = document.getElementById('cal-detail-desc');
            
            detailDate.innerText = `Tanggal ${d} ${seasonDisplayName} (Tahun ${calViewYear})`;
            
            if (isCurrentMonthView && d === currentDayDate) {
                detailDate.innerText += " - HARI INI";
                detailDate.style.color = "#fbbf24";
            } else {
                detailDate.style.color = "white";
            }

            if (eventData) {
                detailDesc.innerHTML = `<span style="font-size:14px">${eventData.icon}</span> <strong>${eventData.name}</strong>`;
            } else {
                detailDesc.innerText = "Tidak ada festival khusus pada hari ini.";
            }

            // Visual feedback
            document.querySelectorAll('.cal-cell').forEach(c => c.style.borderColor = '#334155');
            if(!cell.classList.contains('today')) cell.style.borderColor = 'white';
        };

        grid.appendChild(cell);
    }
}

// --- UPDATE: BANK CHAT KARAKTER (Berdasarkan Tingkat Hubungan) ---
const NPC_CHATS = {
    'lover1girl': { // AYU (Ceria/Gadis Desa)
        low: [ // < 20
            "Panen wortelku gagal sebagian... sedih deh.",
            "Kamu murid baru ya? Jangan lupa makan siang lho!",
            "Tadi aku dikejar ayam jago Pak Kades, kaget banget!",
            "Langitnya biru banget ya hari ini, jadi pengen main layangan."
        ],
        mid: [ // 20 - 79
            "Eh kamu! Kebetulan, aku baru bikin kue labu. Mau cicip?",
            "Capek kerja di ladang hilang kalau liat kamu lewat. Hehe!",
            "Nanti sore jalan-jalan ke sungai yuk? Banyak capung bagus.",
            "Aku suka cowok yang rajin bekerja keras sepertimu."
        ],
        high: [ // >= 80 (Cinta/Siap Nikah)
            "Setiap liat kamu, rasanya kayak bunga matahari yang kena sinar pagi.",
            "Aku pengen punya kebun kecil di belakang rumah kita nanti...",
            "Jangan kerja terlalu keras ya sayang, aku khawatir.",
            "Kalau kita nikah, aku janji bakal masakin kamu tiap hari! "
        ]
    },
    'lover2girl': { // PUTRI (Pemalu/Scholar)
        low: [
            "A-anu... permisi... aku mau ke perpustakaan...",
            "Buku ini... ceritanya sedih sekali...",
            "K-kamu suka baca buku apa? A-aku suka puisi...",
            "Di sini agak ramai ya... a-aku kurang nyaman..."
        ],
        mid: [
            "Kamu... pendengar yang baik ya. Aku nyaman ngobrol sama kamu.",
            "Tadi aku nemu kutipan bagus: 'Cinta itu seperti ilmu, tak bertepi'.",
            "Boleh a-aku pinjam catatanmu? Tulisanmu rapi...",
            "Kalau kamu butuh bantuan belajar... bilang saja ya."
        ],
        high: [
            "Jantungku berdebar kencang tiap kamu mendekat... A-apa ini penyakit?",
            "Aku menulis puisi tentangmu... t-tapi malu membacakannya...",
            "Kamu adalah novel favoritku yang tak ingin kuakhiri.",
            "T-tolong jangan tinggalkan aku sendiri lagi ya... "
        ]
    },
    'lover2boy': { // SATRIA (Ksatria/Tegas)
        low: [
            "Fokus. Disiplin. Itu kunci kekuatan.",
            "Pedang ini butuh diasah. Permisi.",
            "Dunia luar itu kejam, persiapkan dirimu.",
            "Jangan buang waktumu untuk hal tidak berguna."
        ],
        mid: [
            "Kudaku sepertinya menyukaimu. Dia punya insting bagus.",
            "Latihanmu ada kemajuan. Pertahankan postur itu.",
            "Saya mulai menghargai tekadmu. Jarang ada orang sepertimu.",
            "Kalau ke Dungeon, kabari saya. Saya akan memantau."
        ],
        high: [
            "Saya ingin mendedikasikan pedang ini untuk melindungimu.",
            "Kamu adalah kelemahanku, sekaligus kekuatan terbesarku.",
            "Berdiri di sampingku. Kita hadapi dunia bersama.",
            "Saya berjanji setia padamu, demi kehormatan ksatria! "
        ]
    },
    'lover1boy': { // DR. BUDI (Dokter/Loveable)
        low: [
            "Jangan lupa minum air putih 2 liter sehari ya!",
            "Wajahmu pucat, kurang tidur atau kurang kasih sayang?",
            "Saya dokter, tapi saya gak bisa nyembuhin sakit hati lho. Haha!",
            "Kesehatan itu investasi masa depan."
        ],
        mid: [
            "Detak jantungmu normal, tapi kok pipimu merah pas ketemu saya?",
            "Saya resepkan 'Senyum 3x Sehari' khusus buat kamu.",
            "Kamu pasien favorit saya, padahal kamu gak sakit. Hehe.",
            "Jaga diri baik-baik ya, saya gak mau liat kamu terluka."
        ],
        high: [
            "Diagnosa saya: Saya terkena virus cinta akut, dan kamu penularnya.",
            "Saya mau jadi dokter pribadi kamu seumur hidup. Gratis!",
            "Obat lelahku cuma satu: Liat senyum kamu.",
            "Kamu manis banget, nanti saya diabetes gimana? "
        ]
    },
    // NEW: CHAT KHUSUS CINTA MATRE (Sombong & Materialis) - REVISED
    'lover_matre_girl': { // SISKA
        low: [ // Fase Awal: Pura-pura Baik (Fake Nice)
            "Hai! Wah, kamu kelihatan pekerja keras ya. Aku suka semangatmu!",
            "Senyum kamu manis juga ya. Boleh kenalan dong?",
            "Udaranya enak ya. Kamu sering jalan-jalan di sini?",
            "Bajumu rapi deh, pasti orangnya telaten."
        ],
        mid: [ // Fase Tengah: Kode Halus (Hinting)
            "Duh, cuaca panas gini enak minum es kopi mahal nih. *Lirik kamu*",
            "Tas temanku bagus banget, harganya 50k. Aku cuma bisa mimpi punya itu...",
            "Jadi orang mandiri itu capek ya. Andai ada yang mau manjaiin aku.",
            "Kamu kalau jalan-jalan biasanya ke tempat mewah nggak?"
        ],
        high: [ // Fase Akhir: Matre Asli (Demanding)
            "Beb, transfer 500k dong buat skincare. Mukaku kusam nih mikirin kita.",
            "Masa pacaran jalan kaki? Beli mobil kek, minimal kuda!",
            "Kalau cinta itu butuh modal. Mana hadiah buatku hari ini?",
            "Jangan cuma janji manis, aku butuhnya Zirah Emas atau Berlian!"
        ]
    },
    'lover_matre_boy': { // RENDI
        low: [ // Fase Awal: Bro-broan Asik
            "Yo bro! Keren juga gaya lo hari ini. Sukses terus ya!",
            "Gue liat potensi gede di diri lo. Semangat!",
            "Asik juga ngobrol sama lo. Kapan-kapan nongkrong yuk.",
            "Wah, rajin amat. Calon orang sukses nih."
        ],
        mid: [ // Fase Tengah: Kode Minjem/Bayarin
            "Bro, dompet gue ketinggalan di Jet Pribadi. Pinjem 50k dulu bisa?",
            "Mobil sport gue lagi di bengkel nih. Nebeng donk, tapi lo yang nyetir ya.",
            "Gue lagi ada proyek besar, tapi butuh suntikan dana dikit...",
            "Lo kan baik, bayarin makan siang gue dong sekali-kali."
        ],
        high: [ // Fase Akhir: Porotin Harta
            "Sayang, beliin aku jam tangan itu dong. Buktikan cintamu dengan harta!",
            "Transferin modal usaha dong. Nanti kalau untung... ya buat aku lah.",
            "Kita cocok deh... selama saldo rekeningmu masih banyak.",
            "Nikah? Nanti dulu ya, aku masih mau menikmati uangmu."
        ]
    }
};

// --- NEW: BANK DIALOG KERUKUNAN ANTAR AGAMA ---
const NPC_RELIGIOUS_CHATS = {
    'cewek_islam': [ // AISYAH
        "Assalamualaikum! Lihat Maria di sana? Dia sahabat terbaikku. Kami berbeda keyakinan, tapi hati kami satu dalam persaudaraan.",
        "Islam mengajarkan kami: 'Lakum dinukum waliyadin'. Bagimu agamamu, dan bagiku agamaku. Kami saling menghormati tanpa mencampuradukkan ibadah.",
        "Indah sekali pagi ini. Perbedaan itu seperti pelangi, justru indah karena warnanya tidak sama, kan?",
        "Kami sering bertukar cerita di sini. Saling menjaga perasaan adalah kunci kedamaian desa ini.",
        // Nasihat Nikah
        "Soal jodoh, kalau boleh saran... Menikah itu ibadah terpanjang seumur hidup. Jauh lebih tenang jika satu iman, agar nakhoda dan penumpang satu tujuan.",
        "Cinta itu anugerah, tapi iman itu fondasi. Menikah seagama akan memudahkanmu mendidik generasi penerus nanti.",
        "Jangan korbankan aqidah demi cinta sesaat. Carilah pasangan yang bisa membawamu ke Surga bersama-sama."
    ],
    'cewek_kristen': [ // MARIA
        "Shalom! Damai sejahtera bagimu. Aku dan Aisyah sudah bersahabat sejak kecil.",
        "Kasih itu sabar, kasih itu murah hati. Tuhan mengajarkan kita untuk mengasihi sesama manusia, apapun latar belakangnya.",
        "Saat Aisyah puasa, aku tidak makan di depannya. Itu bentuk toleransi sederhana yang kami jaga.",
        "Kami percaya, hidup rukun itu mendatangkan berkat. Seperti embun yang turun dari gunung.",
        // Nasihat Nikah
        "Tentang pasangan hidup... Alkitab mengingatkan: 'Janganlah kamu merupakan pasangan yang tidak seimbang'. Menikah seagama itu fondasi yang kuat.",
        "Satu iman berarti satu roh. Pernikahan bukan cuma soal perasaan, tapi persekutuan dengan Tuhan. Lebih baik cari yang seiman ya.",
        "Rumah tangga itu butuh tiang doa yang sama. Carilah seseorang yang bisa bergandengan tangan saat berdoa kepeda-Nya."
    ]
};

// --- NEW: BANK DIALOG SISWA BARU (TEMAN SEKELAS - LAKI-LAKI) ---
const PEER_BOY_CHATS = {
    // FASE 1: ANAK BARU BINGUNG (Relationship < 20)
    low: [
        "Sst, bro... lu ngerti nggak sih kita disuruh ngapain di sini? Gue cuma dikasih tau 'bertahan hidup' doang. Bingung gue.",
        "Eh, lu tau nggak cara dapet duit cepet? Bekal gue dari rumah udah mau abis nih buat beli roti.",
        "Gue kangen masakan nyokap... Di sini makannya ikan bakar mulu, amis bro.",
        "Itu bangunan gede di tengah apa sih? Guild ya? Serem amat isinya orang bawa pedang semua.",
        "Lu udah milih Role? Gue galau nih antara jadi Wirausaha atau Kuliah aja... Takut salah pilih.",
        "Bro, lu tau 'Dungeon' itu dimana? Gue denger ada monster, emang beneran ya? Kok ngeri sih...",
        "Tadi gue nyasar pas nyari Kampus. Peta di sini ribet banget, mana nggak ada ojek online.",
        "Lu udah ketemu Mentor Budi? Katanya dia galak ya kalau kita males?"
    ],
    // FASE 2: MULAI BERADAPTASI (Relationship 20 - 79)
    mid: [
        "Ternyata kerja di Merchant lumayan juga, bro. Capek sih ngangkat barang, tapi dapet duit buat jajan.",
        "Gue abis dari Perpus, gila bukunya tebel-tebel banget. Tapi ternyata seru juga baca sejarah pulau ini.",
        "Lu pernah liat hantu di hutan barat nggak? Katanya ada monster nyolong skripsi, aneh banget ya ekosistem sini.",
        "Gue mulai paham ritme di sini. Pagi kerja, sore mancing, malem tidur. Simpel tapi bikin sehat.",
        "Eh bro, mending uang lu ditabung deh. Gue kemarin boros beli baju, eh sekarang nggak bisa upgrade rumah.",
        "Kalau lu mau hemat, mending mancing sendiri di dermaga. Ikan bakarnya lumayan buat ganjel perut.",
        "Gue denger kalau mau sukses di sini kuncinya cuma satu: Konsisten. Jangan gonta-ganti kerjaan mulu."
    ],
    // FASE 3: SUDAH NYAMAN/SENIOR (Relationship >= 80)
    high: [
        "Wih, gear lu makin keren aja bro. Udah siap lawan Boss Dungeon lantai 5 kayaknya nih!",
        "Inget nggak pas kita baru nyampe dulu? Polos banget ya kita, bingung nyari pintu masuk rumah haha.",
        "Nanti kalau lulus dari pulau ini, gue mau buka bisnis sendiri ah di kota asal. Ilmunya udah dapet di sini.",
        "Bro, kita harus lulus bareng ya! Kita buktiin ke Mentor Budi kalau kita bisa bertahan 5 tahun!",
        "Rasanya gue malah nggak mau pulang. Di sini udaranya seger, orangnya ramah-ramah. Betah gue.",
        "Kalau lu butuh bantuan buat lawan monster, bilang aja. Gue udah latihan fisik dikit-dikit nih!"
    ]
};

// --- UPDATE: BANK GOMBALAN & TIPE ---
const GOMBALAN_BANK = [
    { text: "Bapak kamu maling ya? Soalnya kamu mencuri hatiku! ", type: "cheesy" },
    { text: "Kamu itu kayak Google. Segala yang kucari ada di kamu. ", type: "cheesy" },
    { text: "Kopi ini pahit, tapi kalau liat kamu langsung jadi manis. ", type: "cheesy" },
    { text: "Jalan mundur yuk? Biar kita bisa liat masa lalu kita gak pernah pisah. ", type: "funny" },
    { text: "Cintaku padamu kayak utang. Awalnya kecil, lama-lama gede! ", type: "funny" },
    { text: "Kamu berat gak? Soalnya kamu ada di pikiranku terus. ", type: "funny" },
    { text: "Aku tidak butuh peta, karena tujuanku adalah hatimu. ", type: "romantic" },
    { text: "Jika rindu itu air, aku sudah tenggelam sekarang. ", type: "romantic" },
    { text: "Di matamu, aku melihat masa depan yang indah. ", type: "romantic" },
    { text: "Kamu adalah notifikasi favoritku setiap hari. ", type: "modern" },
    { text: "Wifi di sini kenceng, tapi koneksi hati kita lebih kuat. ", type: "modern" },
    { text: "Ikan hiu makan tomat. I love you so much! ", type: "pantun" }
];

const COMMODITIES = [
    { id: 'gandum', name: 'Gandum', base: 2000, volatility: 0.3 }, 
    { id: 'kain', name: 'Sutra', base: 8000, volatility: 0.5 }, 
    { id: 'permata', name: 'Berlian', base: 25000, volatility: 0.8 } 
];

function getDailyPrice(itemId, basePrice, vol) {
    const seed = (STATE.day * 13) + itemId.split('').reduce((a,c)=>a+c.charCodeAt(0),0);
    const rand = Math.sin(seed); 
    const change = Math.floor(basePrice * vol * rand);
    let finalPrice = basePrice + change;
    return Math.max(Math.floor(basePrice * 0.2), finalPrice);
}

// Input
const keys = {};
window.addEventListener('keydown', e => {
    keys[e.code] = true;
    if(e.code === 'Space' && STATE.fishing.active) {
        checkFishing();
    }
});
window.addEventListener('keyup', e => keys[e.code] = false);

// --- REVISI TOTAL: TOUCH TO MOVE SYSTEM (VISUAL FLOATING JOYSTICK) ---
const inputState = {
    active: false,
    x: 0, // Vektor arah X (-1 s/d 1)
    y: 0  // Vektor arah Y (-1 s/d 1)
};

function initTouchControls() {
    const container = document.getElementById('game-container');
    const joystickBase = document.getElementById('virtual-joystick-base');
    const joystickStick = document.getElementById('virtual-joystick-stick');
    
    // Variabel untuk Floating Joystick
    let startX = 0;
    let startY = 0;
    const maxRadius = 50; // Jarak maksimal stick bisa digeser dari pusat (pixel)

    // Helper untuk reset joystick UI
    const hideJoystick = () => {
        if(joystickBase) joystickBase.style.display = 'none';
        inputState.active = false;
        inputState.x = 0;
        inputState.y = 0;
    };

    // 1. TOUCH EVENTS (HP/Tablet/IFP)
    container.addEventListener('touchstart', (e) => {
        // Cek apakah yang disentuh adalah elemen UI (Tombol)?
        if (e.target.closest('.action-btns') || 
            e.target.closest('.hud-top') || 
            e.target.id === 'hud-toggle-btn' || 
            e.target.closest('.minigame-overlay') ||
            e.target.closest('#dialogue-wrapper') || 
            e.target.closest('#inventory-screen') || 
            e.target.closest('#login-screen') ||
            e.target.closest('#gender-screen') || 
            e.target.closest('#game-over-screen') || 
            e.target.closest('#audio-prompt') || 
            /* FIX: Tambahkan Splash Screen ke pengecualian agar tombol start bisa diklik */
            e.target.closest('#splash-screen') || 
            e.target.closest('#teacher-dashboard') || 
            /* FIX: TAMBAHKAN LEADERBOARD AGAR BISA SCROLL & KLIK DI HP */
            e.target.closest('#leaderboard-overlay') || 
            e.target.tagName === 'INPUT' ||
            e.target.tagName === 'SELECT' ||
            e.target.tagName === 'TEXTAREA' ||
            e.target.closest('.journal-box')) {
            return; 
        }
        
        e.preventDefault(); 
        const touch = e.touches[0];
        
        // --- FLOATING JOYSTICK LOGIC ---
        // 1. Set Pusat Joystick di posisi sentuhan awal
        startX = touch.clientX;
        startY = touch.clientY;
        
        // 2. Tampilkan Visual Joystick di posisi tersebut
        if(joystickBase) {
            joystickBase.style.display = 'block';
            joystickBase.style.left = startX + 'px';
            joystickBase.style.top = startY + 'px';
            // Reset stick ke tengah
            joystickStick.style.transform = `translate(-50%, -50%)`; 
        }
        
        inputState.active = true;
        // Awal sentuh belum ada gerakan (0,0)
        inputState.x = 0;
        inputState.y = 0;

    }, {passive: false});

    container.addEventListener('touchmove', (e) => {
        if (!inputState.active) return; 
        e.preventDefault();
        const touch = e.touches[0];
        
        // 1. Hitung Delta (Jarak dari pusat awal ke posisi jari sekarang)
        const dx = touch.clientX - startX;
        const dy = touch.clientY - startY;
        
        // 2. Hitung Jarak & Sudut
        const distance = Math.hypot(dx, dy);
        const angle = Math.atan2(dy, dx);
        
        // 3. Batasi Gerakan Visual Stick (Clamping)
        const clampDist = Math.min(distance, maxRadius);
        const stickX = Math.cos(angle) * clampDist;
        const stickY = Math.sin(angle) * clampDist;
        
        // Update Visual Stick
        if(joystickStick) {
            joystickStick.style.transform = `translate(calc(-50% + ${stickX}px), calc(-50% + ${stickY}px))`;
        }

        // 4. Update Input State (Normalized Vector)
        // Deadzone kecil (10px) agar karakter tidak gerak sendiri kalau jari goyang dikit
        if (distance > 10) {
            inputState.x = Math.cos(angle);
            inputState.y = Math.sin(angle);
        } else {
            inputState.x = 0;
            inputState.y = 0;
        }

    }, {passive: false});

    const endTouch = (e) => {
        hideJoystick();
    };

    container.addEventListener('touchend', endTouch);
    container.addEventListener('touchcancel', endTouch);

    // 2. MOUSE EVENTS (Untuk Testing di PC / Laptop Touchscreen)
    let isMouseDown = false;

    container.addEventListener('mousedown', (e) => {
        if (e.target.closest('.action-btns') || e.target.closest('.hud-top')) return;
        
        isMouseDown = true;
        startX = e.clientX;
        startY = e.clientY;
        
        if(joystickBase) {
            joystickBase.style.display = 'block';
            joystickBase.style.left = startX + 'px';
            joystickBase.style.top = startY + 'px';
            joystickStick.style.transform = `translate(-50%, -50%)`;
        }
        
        inputState.active = true;
        inputState.x = 0;
        inputState.y = 0;
    });

    window.addEventListener('mousemove', (e) => {
        if (!isMouseDown) return;
        
        const dx = e.clientX - startX;
        const dy = e.clientY - startY;
        const distance = Math.hypot(dx, dy);
        const angle = Math.atan2(dy, dx);
        
        const clampDist = Math.min(distance, maxRadius);
        const stickX = Math.cos(angle) * clampDist;
        const stickY = Math.sin(angle) * clampDist;
        
        if(joystickStick) {
            joystickStick.style.transform = `translate(calc(-50% + ${stickX}px), calc(-50% + ${stickY}px))`;
        }

        if (distance > 5) {
            inputState.x = Math.cos(angle);
            inputState.y = Math.sin(angle);
        }
    });

    window.addEventListener('mouseup', () => {
        isMouseDown = false;
        hideJoystick();
    });
}

// Panggil inisialisasi Kontrol Baru
initTouchControls();

// FIX: Pastikan tombol aksi tidak memicu gerakan
const btnAction = document.getElementById('btn-action');
const btnSprint = document.getElementById('btn-sprint'); // NEW
const uiButtons = document.querySelectorAll('.action-btns div, button');

uiButtons.forEach(btn => {
    // Stop propagation agar sentuhan di tombol tidak tembus ke container game
    btn.addEventListener('touchstart', (e) => e.stopPropagation(), {passive: true});
    btn.addEventListener('mousedown', (e) => e.stopPropagation());
});

// --- NEW: SPRINT BUTTON LISTENERS ---
const startSprint = (e) => {
    e.preventDefault(); 
    e.stopPropagation();
    STATE.player.isSprinting = true;
};
const endSprint = (e) => {
    e.preventDefault(); 
    e.stopPropagation();
    STATE.player.isSprinting = false;
};

// Touch Events
if(btnSprint) {
    btnSprint.addEventListener('touchstart', startSprint, {passive: false});
    btnSprint.addEventListener('touchend', endSprint, {passive: false});
    btnSprint.addEventListener('touchcancel', endSprint, {passive: false});
    // Mouse Events (PC)
    btnSprint.addEventListener('mousedown', (e) => { e.stopPropagation(); STATE.player.isSprinting = true; });
    btnSprint.addEventListener('mouseup', (e) => { e.stopPropagation(); STATE.player.isSprinting = false; });
    btnSprint.addEventListener('mouseleave', () => { STATE.player.isSprinting = false; });
}

// --- NEW: SKILL BUTTON LISTENER (ULTIMATE) ---
const btnSkill = document.getElementById('btn-skill');
if (btnSkill) {
    btnSkill.addEventListener('touchstart', (e) => {
        e.preventDefault(); e.stopPropagation();
        handleSkill();
    }, {passive: false});
    
    btnSkill.addEventListener('click', (e) => {
        e.stopPropagation();
        handleSkill();
    });
}

btnAction.addEventListener('touchstart', (e)=>{
    e.preventDefault(); 
    e.stopPropagation(); // PENTING
    if(STATE.fishing.active) checkFishing();
    else handleAction();
});
btnAction.addEventListener('click', (e) => {
    e.stopPropagation(); // PENTING
    if(STATE.fishing.active) checkFishing();
    else handleAction();
});

function randomizeWeather() {
    STATE.weather = 'clear'; 
    const rand = Math.random();

    if (STATE.season === 'spring') {
        if (rand < 0.3) STATE.weather = 'rain';
        else if (rand < 0.6) STATE.weather = 'sakura';
    } else if (STATE.season === 'summer') {
        if (rand < 0.25) STATE.weather = 'rain';
    } else if (STATE.season === 'autumn') {
        if (rand < 0.35) STATE.weather = 'rain';
        else if (rand < 0.75) STATE.weather = 'fall_leaves';
    } else if (STATE.season === 'winter') {
        if (rand < 0.6) STATE.weather = 'snow';
    }
    console.log(`Weather updated: ${STATE.weather} (Season: ${STATE.season})`);
}

// --- FUNCTION TO REGENERATE HOUSE MAP BASED ON LEVEL ---
function regenerateHouseMap() {
    try {
        const level = STATE.player.houseLevel || 1;
        let w, h;

        // Perhitungan Ukuran sesuai permintaan (Tile Size = 30px)
        switch(level) {
            case 1: w = 12; h = 10; break;
            case 2: w = 15; h = 12; break;
            case 3: w = 18; h = 14; break;
            case 4: w = 22; h = 16; break;
            case 5: w = 26; h = 20; break;
            default: w = 12; h = 10; break;
        }

        // Generate Tiles
        const tiles = new Array(w * h).fill(10); // 10 = Wood Floor
        
        // Create Walls
        for(let x=0; x<w; x++) { 
            /* REVISI: Tile atas diubah jadi 13 agar sama dengan tile bawah */
            tiles[x] = 13; // Top Wall (ID 13 - Tembok Bawah Player)
            tiles[(h-1)*w + x] = 13; // Bottom Wall (ID 13 - Tembok Bawah Player)
        }
        for(let y=0; y<h; y++) { 
            tiles[y*w] = 11; // Left Wall (ID 11)
            tiles[y*w + (w-1)] = 11; // Right Wall (ID 11)
        }

        // Door Position (Always Bottom Center)
        const doorX = Math.floor(w / 2);
        const doorY = h - 1;
        tiles[doorY * w + doorX] = 8; // Door Tile ID (Overwrites wall)

        // Update Global Map Object
        maps['house'] = {
            w: w, 
            h: h,
            tiles: tiles,
            npcs: [], 
            buildings: [
                { 
                    id: 'house_exit', 
                    x: doorX - 1, 
                    y: doorY, 
                    w: 3, 
                    h: 1, 
                    type: 'trigger', 
                    entrance: {x: doorX, y: doorY}, 
                    name: "Keluar Rumah" 
                }
            ],
            objects: [
                /* ADDED: KASUR PLAYER (Interactive Sleep) */
                // FIX: Ubah 'images/kasur.png' menjadi 'images/bed.png' agar konsisten
                /* REVISI POSISI: Dinaikkan ke y:0 agar nempel tembok */
                /* REVISI UKURAN: Dikecilkan jadi 2x3 (Single Bed) agar proporsional */
                {x: 1, y: 0, w: 2, h: 3, type: 'bed', icon: '', img: 'images/bed.png', name: "Kasur Empuk"},

                /* UPDATE: MEJA BUKU HARIAN (Menggantikan Buku Melayang) */
                /* Posisi disesuaikan agar tidak menumpuk */
                /* REVISI: Mengganti images/mejabuku.png menjadi images/mejabelajar.png */
                /* UPDATE UKURAN: Diperbesar kembali jadi 2x2 */
                /* UPDATE POSISI: Diturunkan ke y:0 */
                {x: 4, y: 0, w: 2, h: 2, type: 'diary', icon: '', img: 'images/mejabelajar.png', name: "Meja Jurnal"},
                
                /* NEW: LEMARI PAKAIAN (WARDROBE) */
                /* Posisi di x:7 (sebelah meja belajar) */
                {x: 7, y: 0, w: 2, h: 3, type: 'shelf', icon: '', text: "Lemari Pakaian", img: 'images/lemari.png'},
                
                /* REVISI POSISI KALENDER: Geser ke POJOK KANAN (w-2) agar selalu di ujung kanan sesuai lebar rumah */
                {x: w - 2, y: 0, type: 'calendar', icon: '', img: 'images/kalender.png'},
                
                /* UPDATE: MEJA TELEPON (Menggantikan Telepon Melayang) */
                /* REVISI: Update gambar ke images/mejatelpon.png dan ukuran jadi 2x2 */
                /* UPDATE POSISI: Dinaikkan ke y:6 agar tidak nempel tembok bawah */
                {x: 2, y: 6, w: 2, h: 2, type: 'catalog', icon: '', img: 'images/mejatelpon.png', name: "Meja Telepon"},

                /* NEW: VAS MERAH (DEKORASI) */
                /* Posisi di sebelah kanan Lemari Pakaian (x:9, y:0) */
                {x: 9, y: 0, w: 1, h: 1, type: 'bookshelf', icon: '', text: "Vas Bunga Merah", img: 'images/vasmerah.png'}
            ]
        };
        
        // --- UPDATE: SPAWN PASANGAN DI RUMAH JIKA MENIKAH ---
        if (STATE.player.married && STATE.player.spouseId) {
            const sid = STATE.player.spouseId;
            let sName = "Pasangan";
            let sImg = "images/lover1girl.png"; // Fallback
            
            // Mapping Data Pasangan
            if(sid === 'lover1girl') { sName = "Ayu"; sImg = "images/lover1girl.png"; }
            else if(sid === 'lover2girl') { sName = "Putri"; sImg = "images/lover2girl.png"; }
            else if(sid === 'lover1boy') { sName = "Dr. Budi"; sImg = "images/lover1boy.png"; }
            else if(sid === 'lover2boy') { sName = "Satria"; sImg = "images/lover2boy.png"; }
            
            // Tambahkan ke Array NPC Rumah
            maps['house'].npcs.push({
                id: sid, // Gunakan ID asli agar interaksi "Married" aktif
                x: Math.floor(w/2) + 2, // Posisi agak ke kanan tengah
                y: Math.floor(h/2),
                name: sName,
                imgSrc: sImg,
                type: 'wander', // Jalan-jalan dalam rumah
                schedule: 'always',
                w: 40, h: 60,
                vx: 0, vy: 0
            });
        }

        console.log(`House Map Regenerated: ${w}x${h}`);
    } catch(e) {
        console.error("Error regenerating house map:", e);
    }
}

// UPDATE: INIT GAME MENJADI ASYNC UNTUK MEMASTIKAN KONEKSI
async function initGame() {
    try {
        resize();

        // 1. Coba inisialisasi koneksi Cloud di awal
        // Agar listener pesan bisa langsung aktif dalam mode Firebase jika online
        await DataService.init(true);

        document.getElementById('start-screen').classList.add('hidden');
        document.getElementById('ui-layer').classList.remove('hidden'); 
        
        AudioService.stopBGM();

        if(window.gameLoopId) { 
            cancelAnimationFrame(window.gameLoopId); 
            window.gameLoopId = null; 
        }
        if(window.saveIntervalId) { 
            clearInterval(window.saveIntervalId); 
            window.saveIntervalId = null; 
        }

        const saved = DataService.loadGame();
        if(saved) {
            // --- FIX: MEMULIHKAN LOGIKA LOAD DATA INTI YANG HILANG ---
            STATE.day = parseInt(saved.day) || 1;
            STATE.time = saved.time !== undefined ? saved.time : 600;
            STATE.season = saved.season || 'spring';
            STATE.weather = saved.weather || 'clear';

            // Load Player Stats
            STATE.player.hp = saved.hp !== undefined ? saved.hp : 100;
            STATE.player.maxHp = saved.maxHp || 100;
            STATE.player.energy = saved.energy !== undefined ? saved.energy : 100;
            STATE.player.money = saved.money !== undefined ? saved.money : 10000;
            STATE.player.level = saved.level || 1;
            STATE.player.exp = saved.exp || 0;
            
            // Load Attributes
            STATE.player.str = saved.str || 5;
            STATE.player.int = saved.int || 5;
            STATE.player.biz = saved.biz || 0;
            STATE.player.reputation = saved.reputation || 0;
            STATE.player.ethics = saved.ethics || 100;

            // Load Role & Career
            STATE.player.role = saved.role || 'none'; // Load role dulu untuk pengecekan
            STATE.player.major = saved.major || null;
            STATE.player.scholarship = saved.scholarship || false;
            STATE.player.jobStatus = saved.jobStatus || 'unemployed';
            STATE.player.bossReputation = saved.bossReputation || 50;
            // NEW: LOAD JOB LEVEL (Default 1 jika tidak ada)
            STATE.player.jobLevel = saved.jobLevel || 1;
            
            STATE.player.shiftStarted = saved.shiftStarted || false;
            STATE.player.salaryDays = saved.salaryDays || 0;
            STATE.player.lastAttendanceDay = saved.lastAttendanceDay || 0;

            // --- FIX: LOGIKA PROLOGUE YANG LEBIH KUAT ---
            // Jika Hari 1 DAN Belum Pilih Role, MAKA WAJIB PROLOGUE (Tutorial Tok-Tok)
            // Ini mengatasi bug dimana status saved.isPrologue salah simpan jadi false
            if (STATE.day === 1 && STATE.player.role === 'none') {
                STATE.isPrologue = true;
                STATE.time = 600; // FIX: Pastikan Waktu Tutorial Selalu Jam 06:00 Pagi
            } else {
                // Selain itu, ikuti status save data (atau false jika tidak ada)
                STATE.isPrologue = saved.isPrologue !== undefined ? saved.isPrologue : false;
            }

            // Load Assets & Relations
            STATE.player.inventory = saved.inventory || {};
            STATE.player.furniture = saved.furniture || [];
            STATE.player.houseLevel = saved.houseLevel || 1;
            STATE.player.furniture = saved.furniture || [];
            // NEW: Load Status Kurcaci (Apakah sudah dipekerjakan)
            STATE.player.hiredDwarf = saved.hiredDwarf || false;
			STATE.player.hiredFairy = saved.hiredFairy || false; // <--- TAMBAHKAN INI

            STATE.player.relationships = saved.relationships || {};
            STATE.player.married = saved.married || false;
            STATE.player.spouseId = saved.spouseId || null;

            // Load Quest & Progress
            STATE.player.activeQuest = saved.activeQuest || null;
            STATE.questProgress = saved.questProgress || {};
            STATE.dungeonLevel = saved.dungeonLevel || 1;

            STATE.player.lastDailyClaim = saved.lastDailyClaim || 0;
            STATE.player.lastWeeklyClaim = saved.lastWeeklyClaim || 0;
            STATE.player.lastMonthlyClaim = saved.lastMonthlyClaim || 0;
            STATE.player.claimedLifeTrial = saved.claimedLifeTrial || false;
            
            // FIX: LOAD DATA MATA PELAJARAN YANG SUDAH DIPELAJARI
            STATE.player.learnedSubjects = saved.learnedSubjects || [];

            // NEW: LOAD STATUS TUTORIAL DUNGEON & FISHING
            STATE.player.hasSeenDungeonTutorial = saved.hasSeenDungeonTutorial || false;
            STATE.player.hasSeenFishingTutorial = saved.hasSeenFishingTutorial || false;

            // NEW: LOAD COUNTER MANCING, MONSTER & TALK
            STATE.player.dailyFishingCount = saved.dailyFishingCount || 0;
            STATE.player.dailyMonsterKills = saved.dailyMonsterKills || 0;
            STATE.player.dailyTalkCount = saved.dailyTalkCount || 0; // Load Talk Count
            
            STATE.player.attackCooldown = 0;
            STATE.player.isAttacking = false;
            
            const genderToLoad = saved.gender || 'boy';
            selectGender(genderToLoad, true);
            
			
			// --- TAMBAHAN BARU: LOAD BAJU (RESTORE OUTFIT) ---
            STATE.player.outfit = saved.outfit || 'default'; // Load data baju
            
            if (STATE.player.outfit !== 'default') {
                // Tentukan suffix file gambar berdasarkan jenis baju
                let suffix = "";
                if (STATE.player.outfit === 'wedding') suffix = "-weding";
                else if (STATE.player.outfit === 'armor') suffix = "-armor";
                else if (STATE.player.outfit === 'special') suffix = "-special";
                
                // Terapkan gambar ke sprite player
                const p = STATE.player;
                const g = genderToLoad;
                
                if(p.spriteIdle) p.spriteIdle.src = `images/${g}-idle${suffix}.png`;
                if(p.spriteWalk) p.spriteWalk.src = `images/${g}-walk${suffix}.png`;
                if(p.spriteWalkUp) p.spriteWalkUp.src = `images/${g}-atas${suffix}.png`;
                if(p.spriteWalkDown) p.spriteWalkDown.src = `images/${g}-bawah${suffix}.png`;
                if(p.spriteAttack) p.spriteAttack.src = `images/${g}-pukul${suffix}.png`;
            }
            // -------------------------------------------------
			
            // STATE.season sudah di-load di atas
            if(!saved.weather) randomizeWeather(); // Hanya randomize jika tidak ada data save

            showToast("System: Data Loaded Completely");
        } else {
            // New Game Setup
            if(!STATE.player.spriteIdle) selectGender('boy', true);
            STATE.isPrologue = true;
            STATE.gameOverTriggered = false;
            STATE.gameFinished = false;
            STATE.freeRoamMode = false;
            STATE.day = 1;
            STATE.time = 600; // Pastikan Mulai Jam 06:00 Pagi
            STATE.player.role = 'none';
            STATE.player.money = 10000;
            randomizeWeather();
        }

        // --- NEW: MULAI LISTENER PESAN (REAL-TIME) ---
        // Panggil setelah data diload agar STATE.player.messages siap
        if(DataService.user && DataService.user.role === 'siswa') {
            DataService.startMessageListener();
			// --- TAMBAHAN BARU: AKTIFKAN MULTIPLAYER ---
            DataService.startGhostListener(); 
            // ------------------------------------------

            // --- [BARU] UPDATE NAMA MENTOR SESUAI GURU PENDAMPING ---
            if (DataService.user.mentor) {
                const realMentorName = await DataService.getMentorName(DataService.user.mentor);
                STATE.mentorName = realMentorName;
                console.log("Mentor Updated:", STATE.mentorName);
            }
        }

        regenerateHouseMap();
        updateBagIcon();

        // FIX: Request Fullscreen di Mobile kadang gagal jika tidak dari event click langsung.
        // Kita bungkus dalam try-catch agar tidak stop eksekusi
        try {
            if (document.documentElement.requestFullscreen) {
                document.documentElement.requestFullscreen().catch((e)=>{ console.log("Fullscreen blocked:", e); });
            }
        } catch(e) {}
        
        STATE.screen = 'play';
        STATE.location = 'house';

        const hMap = maps['house'];
        if(hMap) {
            STATE.player.x = Math.floor(hMap.w / 2) * TILE_SIZE; 
            STATE.player.y = (hMap.h - 3) * TILE_SIZE; 
        } else {
            STATE.player.x = 100; STATE.player.y = 100;
        }

        // FIX: PAKSA RESIZE LAGI UNTUK MEMASTIKAN CANVAS MUNCUL DI HP
        // (Terkadang canvas size 0x0 saat transisi halaman di mobile browser)
        setTimeout(resize, 100);
        setTimeout(resize, 500);
        setTimeout(resize, 1500); // Safety check terakhir
        
        gameLoop();
        
        // --- [BARU] UPDATE NAMA NPC MENTOR DI MAP ---
        // Kita update nama NPC di peta 'village' dan 'mentor_interior' agar saat diklik namanya benar
        ['village', 'mentor_interior'].forEach(mapName => {
            const map = maps[mapName];
            if(map && map.npcs) {
                const mentorNPC = map.npcs.find(n => n.id === 'mentor');
                if(mentorNPC) {
                    mentorNPC.name = STATE.mentorName;
                }
            }
        });

        // FIX: UBAH LOGIKA START WAKE UP SEQUENCE (TOK TOK)
        // Jalankan jika statusnya Prologue, TIDAK PEDULI ada save data atau tidak.
        // Ini memastikan setelah reset (yang otomatis save), prolog tetap jalan.
        if(STATE.isPrologue) {
            // Pastikan posisi player reset ke kasur atau tengah ruangan saat prolog
            if(hMap) {
                STATE.player.x = Math.floor(hMap.w / 2) * TILE_SIZE; 
                /* REVISI: Spawn player di tengah-atas (Tile 4) agar kamera menyorot Kasur/Lemari */
                /* Sebelumnya (h-3) membuat player terlalu bawah sehingga atas terpotong */
                STATE.player.y = 4 * TILE_SIZE; 
            }
            // Delay sedikit lebih lama agar map ter-render sempurna sebelum dialog muncul
            setTimeout(() => startWakeUpSequence(), 1500);
        } else {
            setTimeout(() => showDailyQuestPopup(), 1000);
            updateHUDInfo();
        }
        
        window.saveIntervalId = setInterval(() => {
            if(STATE.screen === 'play') {
                // FIX: Gunakan manualSave() agar data konsisten dan lengkap (DRY Principle)
                // Jangan menulis ulang objek save di sini
                manualSave();
            }
        }, 2000); 

    } catch (err) {
        console.error("CRITICAL ERROR IN INITGAME:", err);
        alert("Terjadi kesalahan saat memuat game. Coba refresh halaman.\nError: " + err.message);
    }
}

// --- NEW: TUTORIAL HELPER FUNCTIONS ---
function showTutorialFocus(elementId, labelText = null) {
    // 1. Hapus highlight lama
    document.querySelectorAll('.tutorial-highlight').forEach(el => el.classList.remove('tutorial-highlight'));
    
    // Pastikan tidak ada target in-game yang aktif agar tidak konflik
    STATE.tutorialFocusTarget = null;

    const target = document.getElementById(elementId);
    const pointer = document.getElementById('tutorial-pointer');
    const label = document.getElementById('pointer-label');
    
    if (target && pointer) {
        // 2. Tambah efek highlight ke target
        target.classList.add('tutorial-highlight');
        
        // UPDATE: Set Teks Label (atau sembunyikan jika null)
        if (label) {
            if (labelText) {
                label.innerText = labelText;
                label.style.display = 'block';
            } else {
                label.style.display = 'none';
            }
        }
        
        // 3. Pindahkan Tangan Penunjuk
        const rect = target.getBoundingClientRect();
        // Hitung posisi tengah elemen
        const centerX = rect.left + (rect.width / 2);
        const centerY = rect.top + (rect.height / 2);
        
        // Reset transform scale ke normal (1) untuk elemen UI
        pointer.style.transform = "scale(1)";
        
        // Atur posisi tangan (sedikit di bawah elemen)
        // UPDATE: Offset disesuaikan karena ada teks label di atas tangan
        pointer.style.left = (centerX - 35) + 'px'; // Center horizontal (width ~70px)
        pointer.style.top = (centerY + 30) + 'px';  // Di bawah elemen
        
        pointer.style.display = 'flex'; // Ganti block jadi flex
    }
}

// --- NEW HELPER: FOKUS KE OBJEK DALAM GAME (CANVAS) ---
function showInGameFocus(tileX, tileY, labelText = null) {
    // 1. Hapus highlight UI lama
    document.querySelectorAll('.tutorial-highlight').forEach(el => el.classList.remove('tutorial-highlight'));
    
    const pointer = document.getElementById('tutorial-pointer');
    const label = document.getElementById('pointer-label');
    
    if (pointer) {
        // 2. Set State Target agar di-update terus menerus di Game Loop
        STATE.tutorialFocusTarget = { x: tileX, y: tileY };
        
        // UPDATE: Set Teks Label
        if (label) {
            if (labelText) {
                label.innerText = labelText;
                label.style.display = 'block';
            } else {
                label.style.display = 'none';
            }
        }
        
        pointer.style.display = 'flex'; // Ganti block jadi flex
        
        // 3. Panggil update sekali secara manual agar langsung muncul di posisi awal (mencegah flicker)
        updateTutorialPointerPosition();
    }
}

function clearTutorialFocus() {
    document.querySelectorAll('.tutorial-highlight').forEach(el => el.classList.remove('tutorial-highlight'));
    const pointer = document.getElementById('tutorial-pointer');
    if(pointer) pointer.style.display = 'none';
    
    // Reset Target Live Tracking
    STATE.tutorialFocusTarget = null;
    
    // Kembalikan tombol aksi ke state normal
    const btn = document.getElementById('btn-action');
    if(btn) btn.style.animation = ''; 
}

// --- NEW FUNCTION: UPDATE POSISI POINTER (DIPANGGIL TIAP FRAME) ---
function updateTutorialPointerPosition() {
    if (!STATE.tutorialFocusTarget) return;

    const pointer = document.getElementById('tutorial-pointer');
    if (!pointer) return;

    // 1. Hitung Scale Factor Real-time
    const scaleFactor = canvas.width / GAME_WIDTH;
    
    // 2. Ambil Target Tile dari State
    const tileX = STATE.tutorialFocusTarget.x;
    const tileY = STATE.tutorialFocusTarget.y;
    
    // 3. Hitung Posisi Dunia (Tengah Tile)
    const worldX = (tileX * TILE_SIZE) + (TILE_SIZE / 2);
    const worldY = (tileY * TILE_SIZE) + (TILE_SIZE / 2);
    
    // 4. Proyeksikan ke Layar (Dikurangi Kamera Saat Ini)
    // FIX: Menggunakan STATE.camera yang selalu update
    const screenX = (worldX - STATE.camera.x) * scaleFactor;
    const screenY = (worldY - STATE.camera.y) * scaleFactor;
    
    // 5. Update Posisi DOM Element
    // UPDATE: Penyesuaian Offset dan Scale agar pas dengan Zoom Out
    
    // Offset horizontal (tengah pointer structure)
    // Structure width sekitar 80px (label + padding), jadi offset -40px
    const xOffset = -40; 
    
    // Offset vertikal dinamis (menyesuaikan scale)
    // Semakin kecil scale (zoom out), jarak offset harus disesuaikan agar tidak terlalu jauh
    // Posisi di ATAS tile (karena telunjuk ke bawah/atas) atau DI BAWAH?
    // Icon  menunjuk ke ATAS. Jadi pointer harus ditaruh DI BAWAH target.
    const yOffset = 15 * scaleFactor; 
    
    pointer.style.left = (screenX + xOffset) + 'px'; 
    pointer.style.top = (screenY + yOffset) + 'px';

    // UPDATE: Skala Ukuran Pointer
    // Agar pointer tidak terlihat raksasa saat kamera zoom out jauh
    // Base scale 1.0, dikalikan faktor zoom dengan clamping
    let dynamicScale = scaleFactor * 0.45; 
    // Batasi minimal 0.7 dan maksimal 1.1
    dynamicScale = Math.max(0.7, Math.min(1.1, dynamicScale));
    
    pointer.style.transform = `scale(${dynamicScale})`;
}

function resetInputs() {
    // Reset Keyboard
    Object.keys(keys).forEach(key => keys[key] = false);
    // Reset Touch Joystick
    inputState.active = false;
    inputState.x = 0;
    inputState.y = 0;
}

function startWakeUpSequence() {
    // FIX: Kunci pintu saat tutorial dimulai
    STATE.tutorialIndoorComplete = false; 

    showToast(" *TOK TOK TOK*");
    if(typeof AudioService !== 'undefined') AudioService.playSFX('knock'); // Play SFX Ketukan
    setTimeout(() => {
        // UPDATE: Ganti "???" dengan nama mentor dinamis jika perlu, atau biarkan misterius
        showDialogue("???", "Halo? Nak? Kamu sudah bangun? Hari ini hari pertamamu!", [
            {
                text: "(Bangun dari tempat tidur)", 
                action: () => {
                    closeDialogue();
                    
                    // --- START VISUAL TUTORIAL ---
                    setTimeout(() => {
                        // UPDATE: Tentukan TARGET GERAKAN (Tengah Ruangan)
                        // Koordinat relatif aman di tengah rumah (x:6, y:5)
                        const targetX = 6;
                        const targetY = 5;

                        // UPDATE: Total langkah jadi 10
                        showDialogue("TUTORIAL (1/10)", 
                            "Selamat datang! Mari belajar bergerak:\n\n **HP/Tablet**: Sentuh & Geser jari (Joystick).\n **PC/Laptop**: Gunakan tombol **WASD** atau **Panah**.\n\n**TUGAS:** Berjalanlah ke titik yang ditunjuk tangan!", 
                            [
                            {
                                text: "Saya Siap Bergerak >>", 
                                action: () => {
                                    closeDialogue();
                                    
                                    // 1. Tampilkan Pointer Tangan di Target (Game World)
                                    // Fungsi ini sudah otomatis menghitung posisi layar & kamera
                                    // UPDATE: Tambahkan Teks Label "JALAN KESINI"
                                    showInGameFocus(targetX, targetY, "JALAN KESINI ");
                                    
                                    showToast("BERJALANLAH KE ARAH TANGAN ");
                                    
                                    // 2. Mulai Monitor Posisi Pemain
                                    const checkTargetInterval = setInterval(() => {
                                        // Hitung jarak player (pixel) ke target (tile center)
                                        const pX = STATE.player.x + (STATE.player.w/2);
                                        const pY = STATE.player.y + (STATE.player.h/2);
                                        
                                        const tX = (targetX * TILE_SIZE) + (TILE_SIZE/2);
                                        const tY = (targetY * TILE_SIZE) + (TILE_SIZE/2);
                                        
                                        const dist = Math.hypot(pX - tX, pY - tY);
                                        
                                        // Jika sudah dekat (toleransi 40px / ~1.3 tile)
                                        if(dist < 40) {
                                            clearInterval(checkTargetInterval); // Stop checking
                                            clearTutorialFocus(); // Hapus pointer
                                            
                                            showToast("BAGUS! Gerakan Terdeteksi ");
                                            if(typeof AudioService !== 'undefined') AudioService.playSFX('item');
                                            createParticle(pX, pY, '#4ade80');

                                            // Lanjut ke Step 2 setelah jeda sebentar
                                            setTimeout(() => {
                                                resetInputs(); // Stop player agar tidak jalan terus
                                                continueTutorialStep2();
                                            }, 800);
                                        }
                                        
                                        // Safety: Stop jika keluar dari mode play
                                        if (STATE.screen !== 'play') clearInterval(checkTargetInterval);

                                    }, 200); // Cek setiap 200ms
                                }
                            }
                        ]);
                    }, 500);
                }
            }
        ], null);
    }, 1500);
}

// MEMECAH FUNGSI TUTORIAL AGAR LEBIH RAPI DAN BISA DIJEDA
function continueTutorialStep2() {
    // STEP 2: TOMBOL AKSI
    const btnAction = document.getElementById('btn-action');
    btnAction.style.display = 'flex';
    btnAction.innerText = '';
    
    // UPDATE: Tambahkan teks "TEKAN INI"
    showTutorialFocus('btn-action', "TEKAN INI"); 
    
    // UPDATE: Total langkah jadi 10
    showDialogue("TUTORIAL (2/10)", "Tombol Merah ini adalah **Tombol Interaksi**. Gunakan untuk Bicara dengan NPC, Masuk Rumah, atau Mengambil Item.", [
        {
            text: "Lanjut >>", 
            action: () => {
                // STEP 3: COMBAT MODE
                btnAction.innerText = '';
                
                showDialogue("TUTORIAL (3/10)", 
                    " **MODE TEMPUR**:\nSaat masuk ke Dungeon berbahaya, tombol ini otomatis berubah menjadi **PEDANG**.\n\nTekan cepat untuk menyerang musuh!", 
                    [{
                        text: "Siap Bertarung!",
                        action: () => {
                            continueTutorialStep4();
                        }
                    }]
                );
            }
        }
    ]);
}

function continueTutorialStep4() {
    // STEP 4: MENU TAS
    const btnAction = document.getElementById('btn-action');
    btnAction.style.display = 'none'; 
    
    showTutorialFocus('bag-btn', "BUKA TAS");
    
    // UPDATE: Total langkah jadi 10
    showDialogue("TUTORIAL (4/10)", 
        " **TAS PENYIMPANAN**:\nKlik tombol Tas ini untuk melihat dan menggunakan item yang kamu miliki.", 
        [{text: "Lanjut >>", action: () => {
            
            // STEP 5: MENU JURNAL QUEST
            showTutorialFocus('quest-btn', "CEK MISI");

            showDialogue("TUTORIAL (5/10)",
                " **TOMBOL JURNAL**:\nIni adalah navigasi utamamu!\nCek **Misi Harian** & **Target Hidup** di sini.\n\nSelesaikan misi untuk dapat Hadiah Gold & EXP!",
                [{text: "Mengerti!", action: () => {
                    continueTutorialStep6();
                }}]
            );
        }}]
    );
}

function continueTutorialStep6() {
    // STEP 6: KALENDER (Start Chain)
    tutorialStep_Calendar();
}

// --- REFACTORED TUTORIAL STEPS (CHAINED) ---

function tutorialStep_Calendar() {
    // Posisi Kalender Rumah Level 1: x=10, y=0 (Pojok Kanan Atas)
    showInGameFocus(10, 0, "KALENDER"); 

    // UPDATE: Total langkah jadi 12
    showDialogue("TUTORIAL (6/12)", 
        " **KALENDER**:\nLihat benda di dinding itu? Itu Kalender.\n\nGunakan untuk mengecek **Tanggal**, **Musim**, dan **Jadwal Festival** atau **Ulang Tahun NPC**.", 
        [{text: "Wah, Penting!", action: () => {
            tutorialStep_Stats(); // Lanjut ke Stats
        }}]
    );
}

function tutorialStep_Stats() {
    // STEP 7: HUD STATS
    // Gunakan showTutorialFocus untuk elemen UI
    showTutorialFocus('hud-stats-box', "STATUS");

    showDialogue("TUTORIAL (7/12)", 
        " **STATUS KARAKTER (HUD)**:\nPerhatikan kotak di tengah atas layar ini!\n\n **STR**: Kekuatan Fisik (Pekerja)\n **INT**: Kecerdasan (Mahasiswa)\n **REP**: Reputasi Sosial (Keluarga)\n **BIZ**: Skill Bisnis (Wirausaha)\n\nTingkatkan status ini sesuai **Role** yang kamu pilih nanti!", 
        [{text: "Siap, Paham!", action: () => {
            tutorialStep_ExpEnergy(); // Lanjut ke EXP & Energy (NEW)
        }}]
    );
}

function tutorialStep_ExpEnergy() {
    // STEP 8: EXP & ENERGY (NEW)
    // Sorot area Profil di kiri atas
    showTutorialFocus('hud-profile-box', "STAMINA");

    // UPDATE: Penjelasan lebih detail tentang penyebab energi berkurang
    showDialogue("TUTORIAL (8/12)", 
        " **KONDISI FISIK**:\nLihat bar di pojok kiri atas:\n\n **EXP (Biru)**: Penuh = Level Up (Status Naik)!\n **ENERGI (Kuning)**: Stamina tubuhmu.\n\n **BERKURANG SAAT:**\n Berjalan Jauh (Otomatis)\n Bekerja/Belajar/Mancing\n Menyerang Musuh\n\n **AWAS:** Jika Energi 0 = **PINGSAN** (Denda Uang)!", 
        [{text: "Oke, Hati-hati!", action: () => {
            tutorialStep_Telephone(); // Lanjut ke Telepon
        }}]
    );
}

function tutorialStep_Telephone() {
    // STEP 9: TELEPON
    // Posisi Meja Telepon: x=2, y=6
    showInGameFocus(2, 6, "BELANJA");

    showDialogue("TUTORIAL (9/12)", 
        " **TELEPON RUMAH**:\nGunakan telepon ini untuk membuka **Katalog Belanja**.\n\nKamu bisa membeli **Furnitur** baru atau melakukan **Upgrade Rumah** agar lebih luas dan mewah!", 
        [{text: "Sip, Lanjut!", action: () => {
            tutorialStep_Wardrobe(); // Lanjut ke Lemari
        }}]
    );
}

function tutorialStep_Wardrobe() {
    // STEP 10: LEMARI PAKAIAN
    // Posisi Lemari: x=7, y=0 (Lebar 2, Tinggi 3).
    showInGameFocus(7, 0, "BAJU");

    showDialogue("TUTORIAL (10/12)", 
        " **LEMARI PAKAIAN**:\nDi sinilah koleksi bajumu tersimpan.\n\nGunakan lemari ini untuk **Ganti Kostum** (Seragam, Baju Pesta, atau Zirah Tempur).\n\nPenampilanmu bisa membuka dialog khusus dengan NPC!", 
        [{text: "Keren!", action: () => {
            tutorialStep_Bed(); // Lanjut ke Kasur
        }}]
    );
}

function tutorialStep_Bed() {
    // STEP 11: KASUR
    // Posisi Kasur: x=1, y=0 (Lebar 3). Titik tengah sekitar x=2, y=1
    showInGameFocus(2, 1, "TIDUR");

    showDialogue("TUTORIAL (11/12)", 
        " **KASUR EMPUK**:\nLelah berpetualang? Gunakan kasur ini untuk **Tidur** (Ganti Hari) dan memulihkan **Energi & HP** sepenuhnya.\n\nJangan lupa tulis Jurnal sebelum tidur!", 
        [{text: "Oke, Mengerti!", action: () => {
            tutorialStep_Diary(); // Lanjut ke Buku
        }}]
    );
}

function tutorialStep_Diary() {
    // STEP 12: BUKU (CLOSING)
    // UPDATE: SOROT MEJA BELAJAR (x:4, y:0) AGAR PEMAIN TAHU LOKASI SAVE
    showInGameFocus(4, 0, "SAVE/JURNAL"); 
    
    showDialogue("TUTORIAL (12/12)", 
        "Terakhir, ini meja belajarmu:\n\n **BUKU JURNAL**: Gunakan untuk **SAVE GAME** manual dan **Belajar Mandiri** (Menambah INT).\n\nSekarang, temui **Mentor Budi** di luar rumah!", 
        [{text: "Ayo Keluar!", action: () => {
            clearTutorialFocus();
            closeDialogue();
            
            // FIX: Buka Kunci Pintu setelah tutorial selesai
            STATE.tutorialIndoorComplete = true; 
            showToast("Pintu Rumah Terbuka ");
        }}]
    );
}

function runTutorial() {
    const name = DataService.user ? DataService.user.name : "Siswa";
    
    // FIX: GUNAKAN STATE.mentorName UNTUK NAMA MENTOR
    showDialogue(STATE.mentorName, 
        "Ah, akhirnya bangun juga kamu, " + name + ". Nyenyak tidurnya?",
        [{text: "Siap, Pak!", action: () => {
             showDialogue(STATE.mentorName, 
                "Selamat datang di Nusantara Arsa. Aturan main di sini ketat: Kamu akan menjalani **Masa Trial selama 3 Tahun**.",
                [{text: "Hanya 3 tahun?", action: () => {
                    showDialogue(STATE.mentorName, 
                    "Jika kamu berhasil membuktikan diri, kamu bisa melanjutkannya hingga **5 Tahun**. Namun ingat tujuan akhirnya...", 
                    [{text: "Apa itu?", action: () => {
                        showDialogue(STATE.mentorName, 
                        "Setelah 5 tahun usai, kamu akan dikirim ke **Pulau Javana** untuk menjalani **kehidupan yang sesungguhnya** di dunia nyata. Jadi, belajarlah dengan serius di sini!", 
                        [{text: "Saya Mengerti!", action: () => {
                            showDialogue(STATE.mentorName, "Bagus. Sekarang, tentukan langkah awalmu. Pilihan ini akan mengunci takdirmu dan Status Dasarmu.", [
                                {text: "Jelaskan Status Dulu", action: () => {
                                     showDialogue(STATE.mentorName, 
                                     "Dengar baik-baik, ini bekal hidupmu:\n STR (Strength): Kekuatan fisik untuk Bekerja Kasar & Bertarung.\n INT (Intelligence): Kecerdasan untuk Kuliah & Beasiswa.\n BIZ (Business): Skill dagang untuk Wirausaha.\n REP (Reputation): Pesona sosial untuk Keluarga & Menikah.",
                                     [{text: "Paham, Pilih Jalan Hidup", action: () => openRoleSelection()}], 'images/mentor.png');
                                }},
                                {text: "Langsung Pilih", action: () => openRoleSelection()}
                            ], 'images/mentor.png'); 
                        }}], 'images/mentor.png'); 
                    }}], 'images/mentor.png'); 
                }}], 'images/mentor.png' 
            );
        }}],
        'images/mentor.png'
    );
}

function openRoleSelection() {
    // FIX: Menambahkan gambar mentor di menu pemilihan role juga
    showDialogue("TAKDIR HIDUP", "Tentukan spesialisasi awalmu sekarang:", [
        {text: "Bekerja (Fighter) - STR++", action: () => setRole('worker')},
        {text: "Kuliah (Mage) - INT++", action: () => setRole('student')},
        {text: "Wirausaha (Support) - BIZ++", action: () => setRole('entrepreneur')},
        /* UPDATE: MENAMBAHKAN KONFIRMASI PERINGATAN UNTUK ROLE MENIKAH */
        {text: "Menikah (Family) - REP++", action: () => confirmFamilyRole()}
    ], 'images/mentor.png');
}

// --- NEW: FUNGSI KONFIRMASI ROLE MENIKAH (PERINGATAN MENTOR) ---
function confirmFamilyRole() {
    // UPDATE: Gunakan STATE.mentorName
    showDialogue(STATE.mentorName, 
        " Eitss... Tunggu dulu! Apakah kamu yakin dengan pilihan ini?\n\nMenikah itu **TIDAK MUDAH**, Nak. Kamu masih terlalu muda untuk memikul beban rumah tangga.\n\nDi sana ada tanggung jawab finansial dan emosional yang sangat besar. Ini bukan sekadar cinta monyet atau main rumah-rumahan.\n\nApakah kamu benar-benar siap mental dan fisik?", 
        [
            {
                text: "Saya Siap Lahir Batin! (Yakin)", 
                action: () => setRole('family')
            },
            {
                text: "Hmm... Saya pikir-pikir dulu", 
                action: () => openRoleSelection() // Kembali ke menu pemilihan
            }
        ], 
        'images/mentor.png'
    );
}

// --- NEW FUNCTION: SET ROLE (FIX: Logika Pemilihan Role Dipisah) ---
function setRole(role) {
    STATE.player.role = role;

    /* NEW: Jika memilih Student (UPDATE: Mentor menyuruh ke kampus) */
    if(role === 'student') {
        STATE.player.int += 5; 
        STATE.player.energy += 20; 
        
        // FIX: PAKSA SIMPAN DATA SEGERA AGAR MUNCUL DI DASHBOARD GURU
        manualSave(); 
        
        // Dialog Mentor Budi menggantikan Surat Penerimaan instan
        // UPDATE: TAMBAHKAN INFO JAM BUKA KAMPUS & NAMA DINAMIS
        showDialogue(STATE.mentorName, 
            "Pilihan yang cerdas! Pendidikan adalah fondasi masa depan.\n\nNamun, administrasi harus tertib. **Pergilah ke Kampus** di timur desa untuk mendaftar ulang dan memilih jurusanmu di sana.\n\nCatat ini: Kampus buka pukul **07:00 - 18:00**. Jangan datang terlalu malam!\n\nSemoga berhasil, Nak!", 
            [{
                text: "Siap, Laksanakan!", 
                action: () => {
                    // UPDATE: Panggil Tutorial Waktu sebelum Mentor pergi
                    showToast("Misi Baru: Pergi ke Kampus ");
                    explainTimeHUD();
                }
            }], 
            'images/mentor.png' 
        );
        return; // Berhenti di sini
    }

    // --- FIX: TAMBAHKAN PENGARAHAN KHUSUS UNTUK WORKER ---
    if(role === 'worker') { 
        STATE.player.str += 5; 
        STATE.player.hp += 20; 
        
        // FIX: PAKSA SIMPAN DATA SEGERA AGAR MUNCUL DI DASHBOARD GURU
        manualSave();

        // UPDATE: TAMBAHKAN INFO JAM BUKA TOKO MERCHANT & NAMA DINAMIS
        showDialogue(STATE.mentorName, 
            "Pilihan tangguh! Jalur Fighter (Pekerja) membutuhkan fisik yang kuat.\n\nLangkah pertamamu: **Pergilah ke Toko Merchant** di selatan desa.\n\nBos Toko sedang mencari pegawai gudang yang rajin. Masuklah ke gedung toko, bicara padanya, dan **Lamar Kerja**!\n\nToko buka pukul **06:00 - 20:00**, tapi ingat shift kerja dimulai jam **08:00** pagi.", 
            [{
                text: "Siap Kerja Keras!", 
                action: () => {
                    // UPDATE: Panggil Tutorial Waktu
                    showToast("Misi Baru: Lamar Kerja di Merchant ");
                    explainTimeHUD();
                }
            }], 
            'images/mentor.png' 
        );
        return; // Berhenti
    }

    // --- UPDATE: PENGARAHAN KHUSUS UNTUK WIRAUSAHA (ENTREPRENEUR) ---
    if(role === 'entrepreneur') { 
        STATE.player.biz += 5; // New BIZ stat
        STATE.player.money += 20000; // Modal Awal
        
        // FIX: PAKSA SIMPAN DATA
        manualSave();

        if(typeof AudioService !== 'undefined') AudioService.playSFX('item'); // SFX Uang

        // UPDATE: TAMBAHKAN INFO JAM BUKA SUPPLIER & NAMA DINAMIS
        showDialogue(STATE.mentorName, 
            "Pilihan brilian! Menjadi Wirausaha berarti kamu adalah bos untuk dirimu sendiri.\n\nSebagai modal awal, saya berikan **20.000 Gold**.\n\nDan lihatlah... **Rumahmu kini telah saya renovasi menjadi RUKO (Rumah Toko)** agar kamu bisa mulai berjualan dari rumah!\n\nJika butuh stok dagangan, Toko Merchant (Supplier) buka pukul **06:00 - 20:00**.", 
            [{
                text: "Wah, Terima Kasih Mentor!", 
                action: () => {
                    // UPDATE VISUAL RUMAH SECARA INSTAN
                    const villMap = maps['village'];
                    const houseBuilding = villMap.buildings.find(b => b.id === 'player_house');
                    if (houseBuilding) {
                        houseBuilding.loadedImg = null; // Reset gambar agar reload jadi Toko
                    }
                    createParticle(19*TILE_SIZE, 7*TILE_SIZE, '#fbbf24'); // Partikel di posisi rumah
                    
                    // UPDATE: Panggil Tutorial Waktu
                    showToast("Rumah berubah menjadi Toko! ");
                    explainTimeHUD();
                }
            }], 
            'images/mentor.png' 
        );
        return; // Berhenti di sini
    }

    /* UPDATE: LOGIKA KHUSUS ROLE FAMILY (MENIKAH) */
    else if(role === 'family') { 
        STATE.player.reputation += 20;
        
        // NEW: BERIKAN CINCIN KAYU SEBAGAI MODAL AWAL
        if(!STATE.player.inventory['cincin_kayu']) STATE.player.inventory['cincin_kayu'] = 0;
        STATE.player.inventory['cincin_kayu']++;

        // NEW: BERIKAN PAKAIAN NIKAH JUGA
        if(!STATE.player.inventory['pakaian_nikah']) STATE.player.inventory['pakaian_nikah'] = 0;
        STATE.player.inventory['pakaian_nikah']++;
        
        // UPDATE: SET ACTIVE QUEST AGAR MUNCUL DI JURNAL
        STATE.player.activeQuest = 'meet_modin';
        
        // FIX: PAKSA SIMPAN DATA
        manualSave();

        // UPDATE: TAMBAHKAN INFO QUEST BALAI NIKAH & PAK MODIN & NAMA DINAMIS
        showDialogue(STATE.mentorName, 
            "Jalan yang mulia! Membangun keluarga adalah ibadah terpanjang.\n\nSebagai bekal awal, saya berikan **Cincin Kayu** dan **Baju Pengantin** ini. Gunakan untuk melamar pasanganmu nanti.\n\n**QUEST UTAMA:**\nLangkah pertamamu: **Pergilah ke Balai Pernikahan** di selatan desa (dekat sungai). \n\nTemui **Bapak Penghulu (Modin)** untuk mendapatkan wejangan nikah dan mendaftarkan diri.\n\nIngat, Balai Pernikahan buka pukul **06:00 - 16:00**.", 
            [{
                text: "Siap, Otw Halal!", 
                action: () => {
                    // UPDATE: Notifikasi Quest Baru & Item
                    showToast("QUEST: Temui Pak Modin di Balai Nikah! ");
                    
                    // --- NEW: POPUP ITEM BAJU PENGANTIN (SAAT ROLE DIPILIH) ---
                    setTimeout(() => {
                        showDialogue("ITEM SPESIAL! ", 
                            "Cieee... Kamu mendapatkan **BAJU PENGANTIN**!\n\nBusana suci untuk hari bahagiamu.\n(Cek Lemari Pakaian di rumah untuk mencoba/memakainya)", 
                            [{
                                text: "Terima Kasih Mentor!", 
                                action: () => {
                                    // Lanjut ke Tutorial Waktu setelah tutup popup
                                    explainTimeHUD();
                                }
                            }], 
                            'images/lemari.png'
                        );
                        if(typeof AudioService !== 'undefined') AudioService.playSFX('item');
                    }, 800);
                }
            }], 
            'images/mentor.png' 
        );
        return; // Berhenti di sini
    }
    
    // FIX: PAKSA SIMPAN DATA UNTUK ROLE LAINNYA
    manualSave();

    finalizeRoleSetup();
}

// --- NEW: TUTORIAL WAKTU OLEH MENTOR ---
function explainTimeHUD() {
    // 1. Highlight Elemen Jam di HUD (Menggunakan ID yang baru ditambahkan)
    showTutorialFocus('hud-time-container');

    // 2. Dialog Penjelasan
    showDialogue(STATE.mentorName,
        "Satu hal terakhir yang **SANGAT PENTING**: WAKTU.\n\nLihat jam di pojok kanan atas itu? ()\nDi Pulau Arsa, waktu terus berjalan. **1 Jam Game = 1 Menit Asli**.",
        [{
            text: "Lalu?",
            action: () => {
                showDialogue(STATE.mentorName,
                    "Perhatikan aturan ini:\n\n1.  **Jam Operasional**: Toko, Kampus, & Balai Desa punya jam buka/tutup. Jangan bertamu tengah malam!\n\n2.  **Stamina**: Jika kamu begadang lewat jam 00:00, kamu akan **bangun kesiangan** & **lemas** esok harinya!\n\nManfaatkan waktumu sebaik mungkin.",
                    [{
                        text: "Paham, Lanjut!", // UPDATE: Tombol lanjut ke Kalender
                        action: () => {
                            explainCalendar(); // Panggil fungsi tutorial Kalender
                        }
                    }],
                    'images/mentor.png'
                );
            }
        }],
        'images/mentor.png'
    );
}

// --- NEW: TUTORIAL KALENDER & MUSIM ---
function explainCalendar() {
    // Highlight tetap di area waktu/tanggal
    showTutorialFocus('hud-time-container');

    showDialogue(STATE.mentorName,
        "Selain Jam, perhatikan juga baris di bawahnya: **TANGGAL & MUSIM**.\n\nDi Pulau Arsa, kita memiliki 4 Musim: **Spring** (Semi), **Summer** (Panas), **Autumn** (Gugur), dan **Winter** (Dingin).",
        [{
            text: "Apa bedanya?",
            action: () => {
                showDialogue(STATE.mentorName,
                    "Setiap musim memiliki **Ikan, Tanaman Liar, dan Cuaca** yang unik.\n\nDan yang paling penting: Cek **Kalender di Dinding Rumahmu** setiap pagi!\n\nDi sana tercatat jadwal **Festival Desa** dan **Ulang Tahun** warga. Datanglah ke festival untuk mendapatkan hadiah langka!",
                    [{
                        text: "Siap, Mengerti!",
                        action: () => {
                            // UPDATE: Lanjut ke penjelasan Sosial sebelum selesai
                            explainSocial(); 
                        }
                    }],
                    'images/mentor.png'
                );
            }
        }],
        'images/mentor.png'
    );
}

// --- NEW: TUTORIAL SOSIALISASI & PENUTUP ---
function explainSocial() {
    // Hapus highlight dari HUD agar fokus ke dialog
    clearTutorialFocus();

    showDialogue(STATE.mentorName,
        "Satu hal terakhir yang paling penting: **SOSIALISASI**.\n\nJangan hidup sendiri di sini! Bergaullah dengan penduduk Pulau Arsa. Sapa mereka, beri hadiah, dan dengarkan cerita mereka.",
        [{
            text: "Kenapa harus begitu?",
            action: () => {
                showDialogue(STATE.mentorName,
                    "Karena interaksi sosial akan **mendewasakan dirimu**.\n\nDengan menjaga hubungan baik, kamu akan membuka banyak **Rahasia Pulau** ini yang tidak tertulis di peta.\n\nIngat, kesuksesan sejati bukan hanya soal seberapa banyak Emas yang kamu punya, tapi seberapa banyak Hati yang kamu menangkan.",
                    [{
                        text: "Nasihat yang indah...",
                        action: () => {
                            showDialogue(STATE.mentorName,
                                "Baiklah, bekalmu sudah cukup. Sekarang, giliranmu untuk menulis ceritamu sendiri.\n\nJelajahi, pelajari, dan jadilah legenda.\n\n**SEMOGA BERHASIL!** ",
                                [{
                                    text: "Siap! Terima Kasih Mentor! (Selesai)",
                                    action: () => {
                                        finishPrologueSequence();
                                    }
                                }],
                                'images/mentor.png'
                            );
                        }
                    }],
                    'images/mentor.png'
                );
            }
        }],
        'images/mentor.png'
    );
}

// --- NEW: FUNGSI FINALISASI PROLOG (CLEANUP) ---
function finishPrologueSequence() {
    // 1. Logika Mentor Menghilang
    const villMap = maps['village'];
    const mentor = villMap.npcs.find(n => n.id === 'mentor');
    if (mentor) {
        // Pindahkan ke -99 (Hilang dari map desa)
        mentor.x = -99; 
        mentor.y = -99;
        mentor.vx = 0; 
        mentor.vy = 0;
    }
    
    // 2. Buka Kunci Jurnal (Akhiri Status Prologue)
    STATE.isPrologue = false; 
    
    updateHUDInfo();
    closeDialogue();

    // 3. Simpan Ulang & Tampilkan Quest
    manualSave();
    
    setTimeout(() => {
        showDailyQuestPopup();
        showToast("SEMOGA BERHASIL! ");
    }, 500);
}

// --- NEW: SISTEM UJIAN MASUK KULIAH (EXAM SYSTEM) ---
let currentExam = {
    major: null,
    score: 0,
    qIndex: 0,
    questions: [],
    timer: 0,      // NEW: Timer
    interval: null // NEW: Interval ID
};

// Database Soal (UPDATE: DITAMBAH JADI 10 SOAL LENGKAP PER JURUSAN)
const EXAM_DB = {
    'teknologi': [
        {q: "Otak utama komputer yang memproses semua instruksi adalah?", a: "CPU", opts: ["CPU", "GPU", "Harddisk"]},
        {q: "Apa kepanjangan dari RAM?", a: "Random Access Memory", opts: ["Read Access Memory", "Random Access Memory", "Run All Memory"]},
        {q: "Sistem bilangan yang hanya menggunakan angka 0 dan 1 disebut?", a: "Biner", opts: ["Desimal", "Biner", "Heksadesimal"]},
        {q: "Mana yang termasuk perangkat OUTPUT?", a: "Monitor", opts: ["Keyboard", "Mouse", "Monitor"]},
        {q: "Tombol pintas (shortcut) untuk menyalin data adalah?", a: "Ctrl + C", opts: ["Ctrl + V", "Ctrl + C", "Ctrl + X"]},
        {q: "Sistem operasi (OS) open-source yang populer berlambang pinguin adalah?", a: "Linux", opts: ["Windows", "MacOS", "Linux"]},
        {q: "Jaringan komputer global yang menghubungkan seluruh dunia disebut?", a: "Internet", opts: ["Intranet", "Internet", "Ethernet"]},
        {q: "Komponen yang berfungsi menyuplai daya listrik ke seluruh bagian PC adalah?", a: "Power Supply", opts: ["VGA Card", "Motherboard", "Power Supply"]},
        {q: "Perangkat lunak berbahaya yang bertujuan merusak sistem disebut?", a: "Malware", opts: ["Software", "Hardware", "Malware"]},
        {q: "Proses mematikan dan menghidupkan ulang komputer disebut?", a: "Restart", opts: ["Shutdown", "Sleep", "Restart"]}
    ],
    'sejarah': [
        {q: "Peristiwa penculikan Soekarno-Hatta oleh golongan muda ke luar kota disebut?", a: "Rengasdengklok", opts: ["Bandung Lautan Api", "Rengasdengklok", "G30S"]},
        {q: "Organisasi pergerakan nasional pertama yang berdiri tahun 1908 adalah?", a: "Budi Utomo", opts: ["Sarekat Islam", "Budi Utomo", "Indische Partij"]},
        {q: "Naskah Sumpah Pemuda dibacakan pada tanggal?", a: "28 Oktober 1928", opts: ["17 Agustus 1945", "28 Oktober 1928", "1 Juni 1945"]},
        {q: "Patih Kerajaan Majapahit yang terkenal dengan Sumpah Palapa adalah?", a: "Gajah Mada", opts: ["Hayam Wuruk", "Gajah Mada", "Ken Arok"]},
        {q: "Perusahaan dagang Belanda yang memonopoli perdagangan rempah-rempah adalah?", a: "VOC", opts: ["EIC", "VOC", "NATO"]},
        {q: "Kerajaan Hindu tertua di Indonesia adalah?", a: "Kutai", opts: ["Tarumanegara", "Kutai", "Sriwijaya"]},
        {q: "Perang Diponegoro berlangsung di pulau?", a: "Jawa", opts: ["Sumatera", "Jawa", "Sulawesi"]},
        {q: "Jepang pertama kali mendarat di Indonesia pada tahun?", a: "1942", opts: ["1941", "1942", "1945"]},
        {q: "Ibukota Indonesia pernah dipindahkan ke Yogyakarta pada tahun?", a: "1946", opts: ["1945", "1946", "1949"]},
        {q: "Siapakah penjahit bendera Merah Putih pertama?", a: "Fatmawati", opts: ["Kartini", "Cut Nyak Dien", "Fatmawati"]}
    ]
};

// --- NEW: DATABASE SOAL KUIS TKJ (INTERAKSI BANGKU KAMPUS) ---
const TKJ_QUIZ_DB = [
    {q: "Kepanjangan dari TKJ adalah?", a: "Teknik Komputer dan Jaringan", opts: ["Teknik Komputer dan Jaringan", "Teknologi Kecepatan Jaringan", "Teknik Komunikasi Jaringan"]},
    {q: "Perangkat yang berfungsi menghubungkan dua jaringan yang berbeda segmen adalah?", a: "Router", opts: ["Switch", "Hub", "Router"]},
    {q: "Urutan warna kabel UTP tipe Straight pada pin 1 adalah?", a: "Putih Orange", opts: ["Putih Hijau", "Putih Orange", "Putih Biru"]}, 
    {q: "Port default untuk layanan HTTP web server adalah?", a: "80", opts: ["21", "80", "443"]},
    {q: "Perintah CLI di Windows untuk memeriksa konektivitas jaringan ke tujuan adalah?", a: "Ping", opts: ["Ping", "Ipconfig", "Tracert"]},
    {q: "Layer OSI urutan ke-1 yang berhubungan dengan kabel dan sinyal listrik adalah?", a: "Physical Layer", opts: ["Network Layer", "Data Link Layer", "Physical Layer"]},
    {q: "IP Address 192.168.10.1 termasuk dalam kelas IP?", a: "C", opts: ["A", "B", "C"]},
    {q: "Server yang berfungsi menerjemahkan nama domain (google.com) menjadi IP Address adalah?", a: "DNS Server", opts: ["DHCP Server", "DNS Server", "FTP Server"]},
    {q: "Topologi jaringan dimana setiap node terhubung ke satu perangkat pusat disebut?", a: "Star", opts: ["Bus", "Ring", "Star"]},
    {q: "Protokol standar untuk mengirim email adalah?", a: "SMTP", opts: ["POP3", "IMAP", "SMTP"]},
    {q: "Alat yang digunakan untuk memasang konektor RJ45 ke kabel UTP disebut?", a: "Tang Crimping", opts: ["Tang Potong", "Tang Crimping", "Obeng"]},
    {q: "Jenis kabel yang menggunakan serat kaca untuk mentransmisikan data via cahaya adalah?", a: "Fiber Optic", opts: ["Coaxial", "Fiber Optic", "Twisted Pair"]}
];

// --- NEW FUNCTION: START TKJ QUIZ ---
function startTKJStudy() {
    // Cek Energi
    if(STATE.player.energy < 10) {
        showToast("Terlalu lelah untuk belajar... (Butuh 10 Energi)");
        return;
    }

    // Ambil soal acak
    const quiz = TKJ_QUIZ_DB[Math.floor(Math.random() * TKJ_QUIZ_DB.length)];
    
    // Buat opsi jawaban
    const options = quiz.opts.map(opt => ({
        text: opt,
        action: () => {
            if(opt === quiz.a) {
                // Jawaban Benar
                STATE.player.energy -= 10;
                STATE.player.int += 1; // Naikkan INT
                gainExp(25); // EXP Lumayan
                
                showToast("Benar! INT +1, EXP +25");
                if(typeof AudioService !== 'undefined') AudioService.playSFX('item');
                createParticle(STATE.player.x, STATE.player.y, '#3b82f6'); // Partikel Biru (Teknologi)
                
                showDialogue("JAWABAN TEPAT! ", `Selamat! Jawabanmu benar: **${quiz.a}**.\n\nWawasan TKJ-mu semakin luas.`, [{text:"Mantap", action:closeDialogue}], 'images/kursimahasiswa.png');
            } else {
                // Jawaban Salah
                STATE.player.energy = Math.max(0, STATE.player.energy - 5); // Penalti energi dikit
                showToast("Salah... (Energi -5)");
                if(typeof AudioService !== 'undefined') AudioService.playSFX('hit');
                
                showDialogue("JAWABAN SALAH ", `Sayang sekali, jawaban yang benar adalah: **${quiz.a}**.\n\nJangan menyerah, pelajari lagi materinya!`, [{text:"Tutup", action:closeDialogue}], 'images/kursimahasiswa.png');
            }
        }
    }));
    
    // Acak urutan tombol agar tidak hapalan posisi
    options.sort(() => Math.random() - 0.5);
    options.push({text: "Nanti saja", action: closeDialogue});

    showDialogue("KUIS DADAKAN TKJ ", `**PERTANYAAN:**\n${quiz.q}`, options, 'images/kursimahasiswa.png');
}

// --- FUNGSI BARU: SISTEM SELEKSI JURUSAN & BEASISWA (MISSING FIX) ---
function selectMajor(major) {
    // Tawarkan Jalur Masuk: Reguler vs Beasiswa
    showDialogue("PILIH JALUR MASUK", 
        `Kamu memilih jurusan **${major.toUpperCase()}**.\n\nApakah kamu ingin mencoba Tes Beasiswa?\n(Syarat: Nilai 100/Benar Semua untuk Gratis UKT)`, 
        [
            {text: "Coba Tes Beasiswa (Gratis)", action: () => {
                // UPDATE: CEK COOLDOWN JIKA GAGAL (1 MINGGU / 7 HARI)
                if (STATE.player.lastExamFailDay && (STATE.day - STATE.player.lastExamFailDay < 7)) {
                     const daysLeft = 7 - (STATE.day - STATE.player.lastExamFailDay);
                     showDialogue("AKSES DITOLAK", 
                        `Sistem mencatat kamu baru saja gagal tes.\n\nKebijakan kampus mengharuskan jeda 1 MINGGU sebelum ujian ulang.\nSilakan coba lagi dalam **${daysLeft} HARI** atau masuk jalur Reguler.`, 
                        [{text: "Baiklah", action: closeDialogue}], 
                        'images/lecture.png'
                    );
                    return;
                }
                startEntranceExam(major);
            }},
            {text: "Jalur Reguler (Bayar nanti)", action: () => confirmMajor(major, false)}
        ], 
        'images/lecture.png'
    );
}

function confirmMajor(major, isScholarship) {
    STATE.player.major = major;
    STATE.player.scholarship = isScholarship;
    
    // Beri Bonus Stat Awal Sesuai Jurusan
    if(major === 'teknologi') {
        STATE.player.int += 3;
    } else if(major === 'sejarah') {
        STATE.player.reputation += 5;
    }
    
    // FIX: SIMPAN DATA JURUSAN SEGERA
    manualSave();

    let msg = `Selamat! Kamu resmi menjadi mahasiswa **${major.toUpperCase()}**.\nStatus: ${isScholarship ? 'BEASISWA PENUH ' : 'REGULER '}`;
    if(isScholarship) msg += "\n(Kamu mendapat uang saku bulanan!)";
    else msg += "\n(Jangan lupa siapkan uang untuk UKT tahunan!)";

    showDialogue("PENDAFTARAN BERHASIL", msg, [{text:"Siap Kuliah!", action:closeDialogue}], 'images/lecture.png');
    
    updateHUDInfo();
    
    // Efek Visual
    createParticle(STATE.player.x, STATE.player.y, '#3b82f6');
    if(typeof AudioService !== 'undefined') AudioService.playSFX('item');
}

function startEntranceExam(major) {
    currentExam.major = major;
    currentExam.score = 0;
    currentExam.qIndex = 0;
    
    // UPDATE: Ambil 10 soal acak dari DB untuk ujian beasiswa
    if (!EXAM_DB[major]) {
        console.error("Exam DB missing for", major);
        return;
    }
    currentExam.questions = [...EXAM_DB[major]].sort(() => Math.random() - 0.5).slice(0, 10);
    
    // NEW: Set Timer (90 Detik untuk 10 Soal)
    currentExam.timer = 90; 

    // NEW: Mulai Interval Timer
    if (currentExam.interval) clearInterval(currentExam.interval);
    
    currentExam.interval = setInterval(() => {
        currentExam.timer--;
        
        // Update Judul Dialog secara Real-time agar pemain melihat waktu berjalan
        const titleEl = document.getElementById('dialogue-title');
        if (titleEl && titleEl.innerText.includes("UJIAN BEASISWA")) {
             titleEl.innerText = `UJIAN BEASISWA (${currentExam.qIndex+1}/${currentExam.questions.length}) -  ${currentExam.timer}s`;
             
             // Warnai merah jika waktu < 10 detik
             if (currentExam.timer < 10) titleEl.style.color = '#ef4444';
             else titleEl.style.color = '#fbbf24';
        }

        // Cek Waktu Habis
        if (currentExam.timer <= 0) {
            clearInterval(currentExam.interval);
            finishEntranceExam(true); // true = Timeout Triggered
        }
    }, 1000);

    nextExamQuestion();
}

function nextExamQuestion() {
    // Cek apakah soal sudah habis
    if(currentExam.qIndex >= currentExam.questions.length) {
        finishEntranceExam(); // Normal Finish
        return;
    }
    
    const q = currentExam.questions[currentExam.qIndex];
    const opts = q.opts.map(o => ({
        text: o,
        action: () => answerExam(o === q.a)
    }));
    // Acak urutan jawaban
    opts.sort(() => Math.random() - 0.5);
    
    // Tampilkan Dialog dengan Timer di Judul Awal
    showDialogue(
        `UJIAN BEASISWA (${currentExam.qIndex+1}/${currentExam.questions.length}) -  ${currentExam.timer}s`, 
        q.q, 
        opts, 
        'images/lecture.png'
    );
}

function answerExam(isCorrect) {
    if(isCorrect) currentExam.score++;
    
    // Feedback suara
    if(typeof AudioService !== 'undefined') AudioService.playSFX(isCorrect ? 'item' : 'hit');

    currentExam.qIndex++;
    // Jeda sedikit agar tidak kaget, lalu lanjut
    setTimeout(nextExamQuestion, 500);
}

function finishEntranceExam(isTimeout = false) {
    // Stop Timer
    if (currentExam.interval) clearInterval(currentExam.interval);

    // Syarat Beasiswa: Harus Benar Semua (Score == Jumlah Soal)
    const isPerfect = currentExam.score === currentExam.questions.length;
    
    let title = "";
    let msg = "";
    let options = [];

    // KONDISI 1: WAKTU HABIS
    if (isTimeout) {
        title = "WAKTU HABIS! ";
        msg = `Maaf, waktu 90 detik telah berakhir.\nSkor Akhir: ${currentExam.score}/${currentExam.questions.length}.\n\nAnda dianggap **GAGAL** karena tidak menyelesaikan ujian tepat waktu.`;
        
        // Hukuman Cooldown
        STATE.player.lastExamFailDay = STATE.day;
        manualSave();

        options = [
            {text: "Masuk Reguler", action: () => confirmMajor(currentExam.major, false)},
            {text: "Coba Lagi Minggu Depan", action: closeDialogue}
        ];
    } 
    // KONDISI 2: LULUS SEMPURNA
    else if (isPerfect) {
        title = "HASIL UJIAN: LULUS! ";
        msg = `Luar biasa! Skor: ${currentExam.score}/10.\nSisa Waktu: ${currentExam.timer} detik.\n\nJawabanmu sempurna. Kamu berhak mendapatkan **BEASISWA PENUH**.`;
        
        options = [
            {text: "Ambil Beasiswa", action: () => confirmMajor(currentExam.major, true)}
        ];
    } 
    // KONDISI 3: SELESAI TAPI TIDAK SEMPURNA
    else {
        // NEW: Catat hari kegagalan dan simpan
        STATE.player.lastExamFailDay = STATE.day;
        manualSave();

        title = "HASIL UJIAN: GAGAL ";
        msg = `Skor: ${currentExam.score}/${currentExam.questions.length}.\nMaaf, syarat beasiswa adalah nilai sempurna (10/10).\n\n**Kamu tidak bisa mengambil tes ulang selama 1 MINGGU.**\nSilakan coba lagi minggu depan atau masuk lewat Jalur Reguler.`;
        
        options = [
            {text: "Masuk Reguler", action: () => confirmMajor(currentExam.major, false)},
            {text: "Belajar Lagi (Minggu Depan)", action: closeDialogue}
        ];
    }

    showDialogue(title, msg, options, 'images/lecture.png');
}

// --- NEW: DATABASE SOAL SIDANG SKRIPSI (LEVEL SULIT/ADVANCED) ---
const THESIS_DB = {
    'teknologi': [
        {q: "Apa kompleksitas waktu (Big O) terbaik untuk algoritma Binary Search?", a: "O(log n)", opts: ["O(n)", "O(log n)", "O(n^2)"]},
        {q: "Manakah yang BUKAN merupakan prinsip dasar OOP (Object Oriented Programming)?", a: "Compilation", opts: ["Encapsulation", "Polymorphism", "Compilation"]},
        {q: "Serangan siber yang membanjiri server dengan trafik palsu disebut?", a: "DDoS", opts: ["Phishing", "DDoS", "SQL Injection"]},
        {q: "Dalam jaringan, protokol standar untuk transfer halaman web aman adalah?", a: "HTTPS", opts: ["FTP", "HTTP", "HTTPS"]},
        {q: "Teknologi database yang menyimpan data dalam format Key-Value atau Document (NoSQL) adalah?", a: "MongoDB", opts: ["MySQL", "PostgreSQL", "MongoDB"]}
    ],
    'sejarah': [
        {q: "Naskah asli Proklamasi Kemerdekaan Indonesia diketik oleh?", a: "Sayuti Melik", opts: ["Sukarni", "Sayuti Melik", "Laksamana Maeda"]},
        {q: "Kerajaan Hindu tertua di Indonesia yang terletak di Kalimantan Timur adalah?", a: "Kutai", opts: ["Tarumanegara", "Kutai", "Majapahit"]},
        {q: "Perjanjian yang menandai berakhirnya Perang Diponegoro (1830) adalah penangkapan Pangeran Diponegoro di?", a: "Magelang", opts: ["Yogyakarta", "Magelang", "Semarang"]},
        {q: "Organisasi militer bentukan Jepang untuk membantu pertahanan adalah?", a: "PETA", opts: ["Putera", "PETA", "Seinendan"]},
        {q: "Konferensi Meja Bundar (KMB) yang mengakui kedaulatan Indonesia diadakan di kota?", a: "Den Haag", opts: ["Jakarta", "Den Haag", "Amsterdam"]}
    ]
};

// --- NEW: DATABASE UJIAN KOMPETENSI MANAJER (WORKER ROLE) ---
const MANAGER_EXAM_DB = [
    {q: "Apa prinsip dasar manajemen stok barang agar tidak kadaluarsa?", a: "FIFO (First In First Out)", opts: ["LIFO (Last In First Out)", "FIFO (First In First Out)", "Random Selection"]},
    {q: "Jika pelanggan marah karena barang rusak, apa tindakan profesional pertama?", a: "Meminta maaf & dengarkan", opts: ["Meminta maaf & dengarkan", "Menyalahkan ekspedisi", "Mengusir pelanggan"]},
    {q: "Rumus dasar menghitung Laba (Profit) adalah?", a: "Pendapatan - Beban", opts: ["Aset + Hutang", "Pendapatan - Beban", "Modal x Bunga"]},
    {q: "Apa kunci utama dalam memimpin tim gudang?", a: "Komunikasi & Delegasi", opts: ["Otoriter & Keras", "Komunikasi & Delegasi", "Mengerjakan semua sendiri"]},
    {q: "Jika stok fisik tidak sesuai dengan catatan komputer, apa yang terjadi?", a: "Selisih Stok (Shrinkage)", opts: ["Surplus Anggaran", "Selisih Stok (Shrinkage)", "Keuntungan Ganda"]},
    {q: "Etika kerja: Apa yang harus dilakukan jika melihat rekan kerja mencuri barang?", a: "Lapor ke Atasan", opts: ["Ikut mencuri", "Diam saja", "Lapor ke Atasan"]},
    {q: "Apa tujuan utama dari Stock Opname?", a: "Verifikasi fisik barang", opts: ["Menghabiskan anggaran", "Verifikasi fisik barang", "Liburan karyawan"]}
];

// --- NEW: LOGIKA UJIAN MANAJER ---
let currentManagerTest = {
    score: 0,
    qIndex: 0,
    questions: []
};

function startManagerExam() {
    currentManagerTest.score = 0;
    currentManagerTest.qIndex = 0;
    // Ambil 5 soal acak
    currentManagerTest.questions = [...MANAGER_EXAM_DB].sort(() => Math.random() - 0.5).slice(0, 5);

    showDialogue("UJI KOMPETENSI MANAJER", 
        "Syarat menjadi Manajer bukan hanya otot, tapi juga otak & etika.\n\nSaya akan ajukan **5 Pertanyaan Manajemen**.\nSyarat Lulus: **Benar Minimal 4**.\n\nSiap diuji?", 
        [
            {text: "SIAP BOS! (Mulai)", action: nextManagerQuestion},
            {text: "Belum siap mental", action: closeDialogue}
        ], 
        'images/job.png'
    );
}

function nextManagerQuestion() {
    if (currentManagerTest.qIndex >= currentManagerTest.questions.length) {
        finishManagerExam();
        return;
    }

    const qData = currentManagerTest.questions[currentManagerTest.qIndex];
    const opts = qData.opts.map(opt => ({
        text: opt,
        action: () => answerManagerQuestion(opt === qData.a)
    })).sort(() => Math.random() - 0.5);

    showDialogue(`UJIAN MANAJER (${currentManagerTest.qIndex + 1}/5)`, 
        `PERTANYAAN:\n\n**"${qData.q}"**`, 
        opts, 
        'images/job.png'
    );
}

function answerManagerQuestion(isCorrect) {
    if(isCorrect) {
        currentManagerTest.score++;
        showToast("Jawaban Tepat! ");
    } else {
        showToast("Jawaban Kurang Tepat ");
    }
    
    if(typeof AudioService !== 'undefined') AudioService.playSFX(isCorrect ? 'item' : 'hit');
    
    currentManagerTest.qIndex++;
    setTimeout(() => nextManagerQuestion(), 800);
}

function finishManagerExam() {
    const passed = currentManagerTest.score >= 4;
    
    if (passed) {
        // PROMOTION LOGIC (MANAJER)
        STATE.player.jobLevel++;
        STATE.player.bossReputation += 10; // Bonus Reputasi Besar
        STATE.player.biz += 5; // Bonus Skill Bisnis
        
        // --- NEW: BERIKAN SERTIFIKAT PROFESI ---
        addItem('sertifikat_manajer', 1);
        showToast(" DITEMUKAN: Sertifikat Profesi Manajer!");
        
        if(typeof AudioService !== 'undefined') AudioService.playSFX('item');
        createParticle(STATE.player.x, STATE.player.y, '#fbbf24');
        
        showDialogue("HASIL UJIAN: LULUS!", 
            `Skor: ${currentManagerTest.score}/5.\n\nSelamat! Pengetahuanmu tentang manajemen dan etika sudah mumpuni.\n\nSaya dengan bangga menyerahkan **Sertifikat Profesi** ini dan mengangkatmu menjadi **MANAJER CABANG**!`, 
            [{text: "Terima kasih Bos!", action: () => {
                closeDialogue();
                showToast("NAIK PANGKAT: MANAJER! ");
                manualSave();
            }}], 
            'images/job.png'
        );
    } else {
        STATE.player.energy = Math.max(0, STATE.player.energy - 20); // Penalty kelelahan mental
        showDialogue("HASIL UJIAN: GAGAL", 
            `Skor: ${currentManagerTest.score}/5.\n\nKamu belum siap memimpin. Pelajari lagi tentang bisnis dan etika kerja.\nSeorang Manajer tidak boleh salah ambil keputusan!`, 
            [{text: "Maaf Bos... (Energy -20)", action: closeDialogue}], 
            'images/job.png'
        );
    }
}

// --- NEW: WORKER MINIGAME LOGIC & DATA ---
const WORK_ITEMS = [
    { name: "Apel Merah", type: "food", icon: "" },
    { name: "Ikan Segar", type: "food", icon: "" },
    { name: "Roti Gandum", type: "food", icon: "" },
    { name: "Susu Sapi", type: "food", icon: "" },
    { name: "Palu Besi", type: "tool", icon: "" },
    { name: "Kapak Kayu", type: "tool", icon: "" },
    { name: "Cangkul", type: "tool", icon: "" },
    { name: "Pedang Lama", type: "tool", icon: "" },
    { name: "Cincin Emas", type: "luxury", icon: "" },
    { name: "Kalung Mutiara", type: "luxury", icon: "" },
    { name: "Kain Sutra", type: "luxury", icon: "" },
    { name: "Permata Biru", type: "luxury", icon: "" }
];

let workState = {
    active: false,
    currentItem: null,
    score: 0,
    timer: 0,
    maxTime: 10, // 10 detik per sesi sortir
    interval: null
};

// --- NEW FUNCTION: HANDLE WORKER INTERACTION (Dipanggil dari interactObject) ---
function handleWorkerInteraction(obj) {
    const p = STATE.player;
    
    // Validasi Dasar
    if (p.role !== 'worker') {
        showToast("Hanya Staff Gudang yang boleh menyentuh ini.");
        return;
    }
    
    if (!p.shiftStarted) {
        showDialogue("MERCHANT", "Kamu belum absen masuk shift! Lapor ke saya dulu baru kerja.", [{text:"Siap Bos", action:closeDialogue}], 'images/job.png');
        return;
    }

    // A. Interaksi Rak Gudang (Minigame Sortir)
    if (obj.type === 'shelf') {
        showDialogue("TUGAS GUDANG", "Ada tumpukan barang baru datang. \nBantu sortir ke rak yang benar agar stok rapi.", [
            { text: "Mulai Sortir (Energy -5)", action: () => {
                if (p.energy >= 5) {
                    p.energy -= 5;
                    closeDialogue();
                    startWorkMinigame();
                } else {
                    showToast("Terlalu lelah untuk angkat barang...");
                }
            }},
            { text: "Nanti saja", action: closeDialogue }
        ], 'images/rakbuku.png'); // Pakai gambar rak
    }
    
    // B. Interaksi Kasir (Event Pelanggan)
    else if (obj.type === 'counter') {
        triggerCustomerEvent();
    }
}

// --- LOGIKA MINIGAME SORTIR ---
function startWorkMinigame() {
    workState.active = true;
    workState.score = 0;
    workState.timer = workState.maxTime;
    
    document.getElementById('work-minigame').style.display = 'flex';
    document.getElementById('work-score-val').innerText = "0";
    STATE.screen = 'minigame';
    
    nextWorkItem();
    
    // Timer Loop
    if (workState.interval) clearInterval(workState.interval);
    workState.interval = setInterval(() => {
        workState.timer -= 0.1;
        const pct = (workState.timer / workState.maxTime) * 100;
        document.getElementById('work-timer-bar').style.width = pct + "%";
        
        if (workState.timer <= 0) {
            finishWorkMinigame();
        }
    }, 100);
}

function nextWorkItem() {
    const rand = Math.floor(Math.random() * WORK_ITEMS.length);
    workState.currentItem = WORK_ITEMS[rand];
    
    // Tampilkan Item
    const iconEl = document.getElementById('work-target-icon');
    const nameEl = document.getElementById('work-target-name');
    
    // Reset animasi
    iconEl.style.animation = 'none';
    iconEl.offsetHeight; /* trigger reflow */
    iconEl.style.animation = 'bounceIn 0.3s';
    
    iconEl.innerText = workState.currentItem.icon;
    nameEl.innerText = workState.currentItem.name;
}

function handleWorkSort(type) {
    if (!workState.active) return;
    
    if (workState.currentItem.type === type) {
        // Benar
        workState.score++;
        document.getElementById('work-score-val').innerText = workState.score;
        if(typeof AudioService !== 'undefined') AudioService.playSFX('item');
        nextWorkItem();
    } else {
        // Salah (Penalti Waktu)
        workState.timer -= 2; 
        showToast("Salah Rak! (-2 Detik)");
        if(typeof AudioService !== 'undefined') AudioService.playSFX('hit');
        // Visual shake
        const card = document.querySelector('.work-card');
        card.style.transform = "translateX(5px)";
        setTimeout(() => card.style.transform = "translateX(0)", 100);
    }
}

function finishWorkMinigame() {
    clearInterval(workState.interval);
    workState.active = false;
    document.getElementById('work-minigame').style.display = 'none';
    STATE.screen = 'play';
    
    // Reward Logic
    const bonusMoney = workState.score * 100; // 100G per item
    const bonusExp = workState.score * 10;
    
    STATE.player.money += bonusMoney;
    gainExp(bonusExp);
    STATE.player.str += 1; // Kerja fisik nambah STR
    
    // --- UPDATE: SKIP WAKTU KE 16:00 (PULANG KERJA) ---
    // Efek: Setelah kerja keras di minigame, waktu langsung sore dan shift selesai
    STATE.time = 1600; 
    
    // Boss Reaction
    let reaction = "Kerja bagus. Gudang jadi rapi.";
    if (workState.score > 8) {
        reaction = "Luar biasa! Kamu secepat kilat. Ini bonus untukmu.";
        STATE.player.bossReputation += 2;
    } else if (workState.score < 3) {
        reaction = "Lambat sekali... Kamu melamun ya?";
        STATE.player.bossReputation -= 1;
    }
    
    showDialogue("LAPORAN KERJA", 
        `Skor: ${workState.score} Item\nBonus Minigame: ${bonusMoney} Gold\n\n(Waktu berlalu cepat saat bekerja... Tiba saatnya pulang pukul 16:00)\n\nBos: "${reaction}"`, 
        [{text:"Absen Pulang (Terima Gaji)", action:closeDialogue}], 
        'images/job.png'
    );
}

function quitWorkMinigame() {
    clearInterval(workState.interval);
    workState.active = false;
    document.getElementById('work-minigame').style.display = 'none';
    STATE.screen = 'play';
}

// --- LOGIKA EVENT PELANGGAN (CUSTOMER SERVICE) ---
function triggerCustomerEvent() {
    // Random Scenario
    const scenarios = [
        {
            type: 'angry_price',
            npc: 'Pelanggan Ibu-ibu',
            img: 'images/girl.png', // Placeholder
            text: "Heh! Kenapa harga gandum di sini mahal sekali?! Di toko sebelah cuma 1000G, di sini 2000G! Kamu mau nipu ya?",
            options: [
                { text: "Jelaskan Kualitas (INT)", req: {stat:'int', val:10}, outcome: 'success', msg: "Ibu, gandum kami impor premium. Bebas kutu dan lebih wangi.", reward: {rep:2, tip:0} },
                { text: "Beri Diskon (Rugi 500G)", action: 'discount', outcome: 'neutral', msg: "Ya sudah, khusus Ibu saya potong 500G dari gaji saya.", reward: {rep:1, tip:0} },
                { text: "Kalau gak punya uang jangan belanja bu", outcome: 'fail', msg: "Kurang ajar! Saya laporkan bosmu!", reward: {rep:-5, tip:0} }
            ]
        },
        {
            type: 'scam_check',
            npc: 'Pelanggan Curiga',
            img: 'images/peer3.png',
            text: "Ini Pedang Besi asli bukan? Kok warnanya agak pudar? Jangan-jangan ini barang rongsokan dari Dungeon yang dicat ulang!",
            options: [
                { text: "Tunjukkan Cap Pabrik (BIZ)", req: {stat:'biz', val:10}, outcome: 'success', msg: "Lihat cap ini Pak. Ini buatan Blacksmith Lina asli.", reward: {rep:2, tip:200} },
                { text: "Sumpah Pak, ini asli!", outcome: 'neutral', msg: "Hmm... ya sudah saya percaya. Awas kalau patah.", reward: {rep:0, tip:0} },
                { text: "Marah balik", outcome: 'fail', msg: "Pelayan kok galak! Saya gak jadi beli!", reward: {rep:-3, tip:0} }
            ]
        },
        {
            type: 'happy_customer',
            npc: 'Pelanggan Kaya',
            img: 'images/lover_matre_boy.png',
            text: "Pelayanan di sini cepat ya. Tolong bungkuskan 10 Permata, saya buru-buru mau melamar pacar saya.",
            options: [
                { text: "Bungkus Rapi (STR)", req: {stat:'str', val:15}, outcome: 'success', msg: "Cepat dan rapi! Ini tip buat kamu.", reward: {rep:3, tip:1000} },
                { text: "Siap Pak", outcome: 'neutral', msg: "Terima kasih. Kembaliannya ambil saja.", reward: {rep:1, tip:100} }
            ]
        }
    ];
    
    const scenario = scenarios[Math.floor(Math.random() * scenarios.length)];
    
    // Build Options dynamically
    const dialogOpts = scenario.options.map(opt => {
        let label = opt.text;
        // Cek requirement stat
        if (opt.req) label += ` [${opt.req.stat.toUpperCase()} ${opt.req.val}+]`;
        
        return {
            text: label,
            action: () => {
                let success = true;
                
                // Cek stat requirement
                if (opt.req) {
                    const pStat = STATE.player[opt.req.stat] || 0;
                    if (pStat < opt.req.val) {
                        success = false;
                        showToast(`Gagal! Butuh ${opt.req.stat.toUpperCase()} ${opt.req.val}`);
                    }
                }
                
                // Special Actions
                if (success && opt.action === 'discount') {
                    if (STATE.player.money >= 500) {
                        STATE.player.money -= 500;
                        showToast("Anda menalangi 500G.");
                    } else {
                        success = false;
                        showToast("Uangmu tidak cukup untuk nalangin!");
                    }
                }
                
                // Result
                if (success) {
                    // Apply Rewards
                    STATE.player.bossReputation += opt.reward.rep;
                    if (opt.reward.tip > 0) {
                        STATE.player.money += opt.reward.tip;
                        showToast(`Dapat Tip +${opt.reward.tip}G!`);
                    }
                    
                    // Show outcome dialog
                    showDialogue(scenario.npc, opt.msg, [{text:"Kembali Kerja", action:closeDialogue}], scenario.img);
                } else {
                    // Failed stat check fallback
                    STATE.player.bossReputation -= 2;
                    showDialogue(scenario.npc, "Kamu ngomong apa sih? Gak jelas! (Pelanggan Kecewa)", [{text:"Maaf...", action:closeDialogue}], scenario.img);
                }
            }
        };
    });
    
    dialogOpts.push({text: "Abaikan (Rep -1)", action: () => {
        STATE.player.bossReputation -= 1;
        closeDialogue();
    }});

    showDialogue(scenario.npc, scenario.text, dialogOpts, scenario.img);
}

// --- NEW: DATABASE MATERI KULIAH (EXPANDED TO 48 TOPICS - 2 YEARS FULL) ---
// Logika: 1 Tahun = 120 Hari. Kuliah Spesial tiap 5 hari. Total = 24 Materi/Tahun.
// UPDATE: MATERI LENGKAP & LEBIH MENDALAM (TEORI ASLI)
const COURSE_MATERIALS = {
    'teknologi': [
        // --- TAHUN PERTAMA (BASIC & DEV) ---
        // SEMESTER 1 (Basic Computer Science)
        {
            t: "Algoritma & Pemrograman Dasar", 
            c: "DEFINISI:\nUrutan langkah logis penyelesaian masalah yang disusun secara sistematis.\n\n3 SYARAT ALGORITMA:\n1. Finiteness: Harus berhenti setelah sejumlah langkah.\n2. Definiteness: Setiap langkah harus jelas/tidak ambigu.\n3. Effectiveness: Langkah harus sederhana dan dapat dikerjakan.\n\nNOTASI:\n- Pseudocode (Kode semu)\n- Flowchart (Diagram alir)"
        },
        {
            t: "Struktur Data (Data Structures)", 
            c: "KONSEP:\nCara penyimpanan, penyusunan, dan pengaturan data di dalam media penyimpanan komputer.\n\nTIPE DASAR:\n1. Array: Kumpulan data sejenis dengan indeks statis.\n2. Linked List: Rangkaian node yang saling menunjuk (dinamis).\n3. Stack: Tumpukan (LIFO - Last In First Out).\n4. Queue: Antrean (FIFO - First In First Out)."
        },
        {
            t: "Basis Data (Database SQL)", 
            c: "RDBMS (Relational Database):\nPenyimpanan data dalam bentuk tabel yang saling berelasi.\n\nKUNCI UTAMA:\n- Primary Key (PK): Identitas unik setiap baris data.\n- Foreign Key (FK): Kunci tamu untuk menghubungkan antar tabel.\n\nNORMALISASI:\nProses pengelompokan atribut data untuk menghilangkan redundansi dan anomali data."
        },
        {
            t: "Jaringan Komputer Dasar", 
            c: "MODEL OSI (7 LAYER):\n1. Physical (Kabel/Sinyal)\n2. Data Link (MAC Address)\n3. Network (IP Address/Routing)\n4. Transport (TCP/UDP)\n5. Session\n6. Presentation\n7. Application (HTTP/FTP)\n\nIP ADDRESS:\nAlamat unik perangkat dalam jaringan. IPv4 (32-bit) dan IPv6 (128-bit)."
        },
        {
            t: "Keamanan Siber (Cyber Security)", 
            c: "CIA TRIAD:\n1. Confidentiality (Kerahasiaan): Data hanya boleh diakses yang berhak.\n2. Integrity (Keutuhan): Data tidak boleh diubah oleh pihak tak berwenang.\n3. Availability (Ketersediaan): Data harus bisa diakses saat dibutuhkan.\n\nANCAMAN UMUM:\n- Phishing (Pencurian info via manipulasi)\n- Malware (Virus/Ransomware)\n- DDoS (Serangan membanjiri trafik)"
        },
        {
            t: "Kecerdasan Buatan (AI Basics)", 
            c: "DEFINISI:\nSimulasi kecerdasan manusia dalam mesin yang diprogram untuk berpikir dan meniru tindakannya.\n\nCABANG AI:\n1. Machine Learning: Mesin belajar dari data tanpa diprogram eksplisit.\n2. Neural Networks: Meniru cara kerja neuron otak manusia.\n3. NLP: Pemrosesan bahasa alami (teks/suara).\n4. Computer Vision: Analisis gambar/video."
        },
        
        // SEMESTER 2 (Development Skills)
        {
            t: "Pemrograman Web (Frontend & Backend)", 
            c: "ARSITEKTUR WEB:\n- Client-Side (Frontend): HTML (Struktur), CSS (Gaya), JS (Interaksi).\n- Server-Side (Backend): Node.js, PHP, Python, Database.\n\nHTTP REQUEST METHODS:\n- GET: Mengambil data.\n- POST: Mengirim data baru.\n- PUT: Update data.\n- DELETE: Hapus data."
        },
        {
            t: "Pemrograman Mobile (Android/iOS)", 
            c: "NATIVE VS HYBRID:\n- Native: Java/Kotlin (Android), Swift (iOS). Performa tinggi, akses hardware penuh.\n- Hybrid/Cross-Platform: Flutter, React Native. Satu kode untuk semua platform.\n\nLIFECYCLE AKTIVITAS:\nCreate -> Start -> Resume -> Pause -> Stop -> Destroy."
        },
        {
            t: "Cloud Computing", 
            c: "LAYANAN CLOUD:\n1. IaaS (Infrastructure): Sewa server/storage virtual (AWS EC2).\n2. PaaS (Platform): Lingkungan development siap pakai (Heroku).\n3. SaaS (Software): Aplikasi jadi via internet (Google Docs).\n\nMANFAAT:\nSkalabilitas (bisa diperbesar kapan saja) dan Efisiensi Biaya (Pay-as-you-go)."
        },
        {
            t: "Internet of Things (IoT)", 
            c: "KONSEP:\nJaringan objek fisik yang tertanam dengan sensor, software, dan teknologi lain untuk bertukar data via internet.\n\nKOMPONEN UTAMA:\n1. Sensor/Actuator (Pengambil data/Penggerak).\n2. Connectivity (Wi-Fi, Bluetooth, Zigbee).\n3. Data Processing (Cloud/Edge).\n4. User Interface (Dashboard/App)."
        },
        {
            t: "Teknologi Blockchain", 
            c: "PRINSIP DASAR:\nBuku besar (ledger) digital yang terdesentralisasi, terdistribusi, dan tidak dapat diubah (immutable).\n\nCARA KERJA:\nTransaksi dicatat dalam 'blok', dienkripsi (hash), dan dirangkai ke blok sebelumnya (chain). Jika satu blok diubah, seluruh rantai rusak (terdeteksi palsu)."
        },
        {
            t: "Big Data Analytics", 
            c: "KARAKTERISTIK 3V:\n1. Volume: Jumlah data sangat besar.\n2. Velocity: Kecepatan data masuk sangat tinggi (real-time).\n3. Variety: Jenis data beragam (teks, video, log).\n\nTUJUAN:\nMenemukan pola tersembunyi, korelasi pasar, dan preferensi pelanggan untuk keputusan bisnis."
        },

        // --- TAHUN KEDUA (ADVANCED & SPECIALIZATION) ---
        // SEMESTER 3 (Engineering & Ethics)
        {
            t: "User Interface (UI) & User Experience (UX)", 
            c: "UI (Tampilan):\nFokus pada estetika, warna, tipografi, dan tata letak visual.\n\nUX (Pengalaman):\nFokus pada kemudahan penggunaan, alur pengguna (user flow), dan kepuasan interaksi.\n\nPRINSIP DESAIN:\nKonsistensi, Feedback yang jelas, dan Minimalisir beban kognitif pengguna."
        },
        {
            t: "Software Engineering (RPL)", 
            c: "SDLC (System Development Life Cycle):\n1. Planning (Perencanaan)\n2. Analysis (Analisis Kebutuhan)\n3. Design (Perancangan)\n4. Implementation (Coding)\n5. Testing (Pengujian)\n6. Maintenance (Pemeliharaan)\n\nMODEL:\nWaterfall (Sekuensial) vs Agile (Iteratif/Fleksibel)."
        },
        {
            t: "Sistem Operasi (OS)", 
            c: "FUNGSI UTAMA OS:\n1. Manajemen Proses (Scheduling CPU).\n2. Manajemen Memori (RAM & Virtual Memory).\n3. Manajemen File (File System).\n4. Manajemen I/O (Input Output).\n\nKERNEL:\nInti dari OS yang menghubungkan software aplikasi dengan hardware komputer."
        },
        {
            t: "Arsitektur & Organisasi Komputer", 
            c: "UNIT UTAMA (Von Neumann):\n1. CPU (ALU + Control Unit): Otak pemroses.\n2. Memory: Penyimpanan instruksi/data.\n3. I/O Devices: Perangkat masukan/keluaran.\n\nFETCH-DECODE-EXECUTE:\nSiklus CPU mengambil instruksi dari memori, menerjemahkannya, dan menjalankannya."
        },
        {
            t: "Etika Profesi IT", 
            c: "PRINSIP ETIKA:\n1. Privasi: Menjaga kerahasiaan data pengguna.\n2. Akurasi: Tidak memanipulasi data/fakta.\n3. Properti: Menghargai Hak Kekayaan Intelektual (HAKI).\n4. Akses: Tidak membatasi akses informasi secara diskriminatif.\n\nKASUS:\nPlagiarisme kode, penyebaran malware, penyalahgunaan data user."
        },
        {
            t: "Digital Marketing & SEO", 
            c: "SEO (Search Engine Optimization):\nOptimasi website agar muncul di halaman pertama pencarian organik (Google).\n\nSEM (Search Engine Marketing):\nPemasaran berbayar (Iklan/Ads) di mesin pencari.\n\nMETRIK PENTING:\n- CTR (Click Through Rate)\n- Conversion Rate\n- Bounce Rate"
        },
        
        // SEMESTER 4 (Advanced Tech)
        {
            t: "Pengembangan Game (Game Dev)", 
            c: "GAME LOOP:\nSiklus tak berujung: Input -> Update Logika -> Render Grafis.\n\nKOMPONEN:\n- Sprite/Mesh (Visual)\n- Collider/Rigidbody (Fisika)\n- Script (Logika)\n- Audio (Suara)\n\nGENRE:\nRPG, FPS, Platformer, Simulation, Strategy."
        },
        {
            t: "Virtual Reality (VR) & AR", 
            c: "VR (Virtual Reality):\nPengguna masuk sepenuhnya ke dunia digital (Immersive) menggunakan headset.\n\nAR (Augmented Reality):\nMenambahkan objek digital ke dunia nyata (contoh: Filter kamera, Pokemon GO).\n\nMR (Mixed Reality):\nInteraksi objek digital dan fisik secara real-time."
        },
        {
            t: "E-Commerce Systems", 
            c: "MODEL BISNIS:\n- B2B (Business to Business)\n- B2C (Business to Consumer)\n- C2C (Consumer to Consumer - Marketplace)\n\nKEAMANAN TRANSAKSI:\nEnkripsi SSL/TLS, Payment Gateway, dan Two-Factor Authentication (2FA) untuk mencegah penipuan."
        },
        {
            t: "Manajemen Startup Digital", 
            c: "TAHAPAN STARTUP:\n1. Ideation: Validasi ide masalah & solusi.\n2. MVP (Minimum Viable Product): Produk dasar untuk tes pasar.\n3. Product-Market Fit: Produk disukai dan dibutuhkan pasar.\n4. Scaling: Ekspansi pertumbuhan pengguna.\n\nLEAN STARTUP:\nBuild - Measure - Learn (Buat - Ukur - Pelajari)."
        },
        {
            t: "Manajemen Proyek (Agile/Scrum)", 
            c: "AGILE MANIFESTO:\nLebih menghargai individu & interaksi daripada proses & alat. Merespon perubahan daripada mengikuti rencana kaku.\n\nSCRUM FRAMEWORK:\n- Sprint: Siklus kerja pendek (2-4 minggu).\n- Daily Standup: Rapat harian singkat.\n- Roles: Product Owner, Scrum Master, Dev Team."
        },
        {
            t: "Teknologi Masa Depan (Futurism)", 
            c: "TREN MENDATANG:\n1. Quantum Computing: Komputer super cepat berbasis Qubit.\n2. Biotechnology: Integrasi teknologi dengan biologi (Biohacking).\n3. Autonomous Systems: Robot/Kendaraan mandiri.\n4. Green Tech: Teknologi ramah lingkungan untuk keberlanjutan bumi."
        },

        // --- TAHUN KETIGA (EXPERT & SPECIALIZATION) ---
        // SEMESTER 5 (Cloud & DevOps Architecture)
        {
            t: "Microservices Architecture", 
            c: "KONSEP:\nMemecah aplikasi besar (Monolith) menjadi layanan-layanan kecil yang independen dan saling berkomunikasi via API.\n\nKELEBIHAN:\n- Independensi Deployment\n- Skalabilitas per fitur\n- Bebas memilih teknologi per service\n\nKEKURANGAN:\nKompleksitas manajemen jaringan dan data."
        },
        {
            t: "Docker & Containerization", 
            c: "CONTAINER:\nUnit standar perangkat lunak yang mengemas kode dan dependensinya agar aplikasi berjalan cepat dan andal di lingkungan komputasi yang berbeda.\n\nDOCKER:\nPlatform terbuka untuk mengembangkan, mengirim, dan menjalankan aplikasi dalam kontainer. Memisahkan aplikasi dari infrastruktur."
        },
        {
            t: "Kubernetes (K8s)", 
            c: "ORCHESTRATION:\nSistem open-source untuk mengotomatisasi deployment, scaling, dan manajemen aplikasi terkontainerisasi.\n\nFITUR UTAMA:\n- Self-healing (Restart container mati)\n- Load balancing (Distribusi trafik)\n- Automated rollouts/rollbacks (Update otomatis)"
        },
        {
            t: "CI/CD Pipeline", 
            c: "CI (Continuous Integration):\nPengembang sering menggabungkan kode ke repositori pusat (Shared Repo). Otomatisasi build dan test.\n\nCD (Continuous Delivery/Deployment):\nOtomatisasi rilis aplikasi ke lingkungan produksi. Memastikan software selalu siap dirilis ke user."
        },
        {
            t: "DevOps Culture", 
            c: "DEFINISI:\nGabungan filosofi budaya, praktik, dan alat yang meningkatkan kemampuan organisasi untuk mengirimkan aplikasi dengan kecepatan tinggi.\n\nTUJUAN:\nMenghapus silo (tembok pemisah) antara tim Development (Pengembang) dan Operations (Operasional IT) agar kolaborasi lebih efisien."
        },
        {
            t: "Cloud Security Architecture", 
            c: "SHARED RESPONSIBILITY:\nPenyedia Cloud (AWS/Google) bertanggung jawab atas keamanan 'of the cloud' (infrastruktur fisik).\nPelanggan bertanggung jawab atas keamanan 'in the cloud' (data, akses, konfigurasi).\n\nBEST PRACTICE:\nEnkripsi data at rest & in transit, IAM (Identity Access Management)."
        },
        
        // SEMESTER 6 (AI & Data Science Deep Dive)
        {
            t: "Deep Learning & Neural Networks", 
            c: "NEURAL NETWORK:\nModel komputasi yang terinspirasi dari struktur otak manusia (neuron dan sinapsis).\n\nDEEP LEARNING:\nPembelajaran mesin dengan banyak lapisan (hidden layers) untuk mengekstrak fitur tingkat tinggi dari data mentah. Contoh: Pengenalan wajah, mobil otonom."
        },
        {
            t: "Natural Language Processing (NLP)", 
            c: "FUNGSI:\nMemampukan komputer untuk memahami, menafsirkan, dan memanipulasi bahasa manusia.\n\nAPLIKASI:\n- Chatbot & Virtual Assistant\n- Terjemahan Bahasa (Google Translate)\n- Analisis Sentimen (Cek respon positif/negatif di sosmed)\n- Peringkasan Teks Otomatis."
        },
        {
            t: "Computer Vision", 
            c: "DEFINISI:\nBidang AI yang melatih komputer untuk menafsirkan dan memahami dunia visual (gambar/video).\n\nTEKNOLOGI:\n- Image Classification (Kucing vs Anjing)\n- Object Detection (Deteksi mobil di jalan)\n- Facial Recognition (Kunci HP wajah)\n- Medical Imaging (Deteksi tumor dari X-Ray)."
        },
        {
            t: "Predictive Analytics", 
            c: "METODE:\nMenggunakan data historis, algoritma statistik, dan teknik machine learning untuk mengidentifikasi kemungkinan hasil masa depan.\n\nCONTOH:\n- Prediksi harga saham\n- Prediksi cuaca\n- Rekomendasi produk (Netflix/Spotify)\n- Deteksi potensi kerusakan mesin (Maintenance)."
        },
        {
            t: "Ethical Hacking (Pentesting)", 
            c: "DEFINISI:\nPeretasan yang dilakukan dengan izin untuk menemukan kelemahan keamanan sistem sebelum dieksploitasi oleh peretas jahat.\n\nTAHAPAN:\n1. Reconnaissance (Pengumpulan info)\n2. Scanning (Pemindaian celah)\n3. Gaining Access (Eksploitasi)\n4. Maintaining Access\n5. Clearing Tracks (Hapus jejak)."
        },
        {
            t: "Digital Forensics", 
            c: "TUJUAN:\nMengidentifikasi, memelihara, memulihkan, menganalisis, dan menyajikan fakta tentang bukti digital dalam kasus hukum.\n\nPROSES:\n- Seizure (Penyitaan perangkat)\n- Acquisition (Duplikasi data bit-by-bit)\n- Analysis (Mencari bukti tersembunyi/terhapus)\n- Reporting (Laporan hukum)."
        },

        // SEMESTER 7 (Modern Web & Management)
        {
            t: "Serverless Computing", 
            c: "KONSEP:\nModel eksekusi cloud di mana penyedia cloud mengelola server secara dinamis. Developer hanya fokus menulis kode fungsi (FaaS - Function as a Service).\n\nKEUNTUNGAN:\n- Tidak perlu manajemen server\n- Scaling otomatis dari nol ke ribuan request\n- Bayar hanya saat kode dijalankan."
        },
        {
            t: "Progressive Web Apps (PWA)", 
            c: "FITUR:\nAplikasi web yang menggunakan fitur browser modern untuk memberikan pengalaman seperti aplikasi native (mobile app).\n\nKELEBIHAN:\n- Bisa diinstall di Home Screen\n- Bisa jalan Offline (Service Workers)\n- Push Notifications\n- Ringan dan cepat."
        },
        {
            t: "GraphQL API", 
            c: "DEFINISI:\nBahasa query untuk API dan runtime untuk memenuhi query tersebut dengan data yang ada.\n\nBEDA DENGAN REST:\n- REST: Banyak endpoint, data fixed (over-fetching/under-fetching).\n- GraphQL: Satu endpoint, client minta data spesifik yang dibutuhkan saja (efisien)."
        },
        {
            t: "Tech Leadership (CTO Role)", 
            c: "TANGGUNG JAWAB:\n- Menentukan visi teknologi perusahaan.\n- Memilih stack teknologi yang tepat.\n- Membangun dan memimpin tim engineering.\n- Menjembatani kebutuhan bisnis dengan solusi teknis.\n\nSKILL:\nKomunikasi, Manajemen Krisis, Mentoring."
        },
        {
            t: "Startup Valuation & Funding", 
            c: "VALUASI:\nNilai ekonomis dari sebuah bisnis startup. Dipengaruhi oleh tim, traksi, ukuran pasar, dan teknologi.\n\nTAHAP PENDANAAN:\n- Bootstrapping (Modal sendiri)\n- Angel Investor\n- Seed Funding\n- Series A, B, C (Venture Capital)\n- IPO (Saham Publik)."
        },
        {
            t: "Hukum IT & HAKI", 
            c: "UU ITE (Indonesia):\nMengatur informasi dan transaksi elektronik. Pasal karet, pencemaran nama baik, akses ilegal.\n\nHAKI (Hak Kekayaan Intelektual):\n- Hak Cipta (Copyright): Kode program, desain UI.\n- Paten: Penemuan teknologi baru.\n- Merek Dagang: Logo/Brand startup."
        },

        // SEMESTER 8 (Global Impact & Ethics)
        {
            t: "Green Computing", 
            c: "TUJUAN:\nMengurangi dampak lingkungan dari teknologi komputer. Hemat energi dan kurangi limbah elektronik (e-waste).\n\nSTRATEGI:\n- Virtualisasi server (kurangi hardware fisik)\n- Algoritma efisien (kurangi beban CPU/listrik)\n- Daur ulang perangkat keras\n- Data center bertenaga terbarukan."
        },
        {
            t: "Bioinformatics", 
            c: "GABUNGAN:\nBiologi molekuler + Ilmu Komputer + Statistik.\n\nFUNGSI:\nMengelola dan menganalisis data biologis kompleks, seperti sekuensing DNA/RNA.\n\nMANFAAT:\nPenemuan obat baru, pemetaan gen manusia, personalisasi pengobatan medis."
        },
        {
            t: "Smart Cities Implementation", 
            c: "DEFINISI:\nKota yang menggunakan teknologi IoT dan data untuk meningkatkan kualitas layanan publik dan kesejahteraan warga.\n\nCONTOH:\n- Smart Traffic (Lampu merah adaptif)\n- Smart Waste (Tempat sampah lapor penuh)\n- E-Gov (Layanan administrasi online)\n- Smart Energy (Grid listrik efisien)."
        },
        {
            t: "Space Technology Software", 
            c: "TANTANGAN:\nSoftware di luar angkasa harus sangat andal (zero-failure), tahan radiasi, dan beroperasi real-time dengan latensi tinggi.\n\nCONTOH:\n- Sistem navigasi roket (SpaceX)\n- Kontrol rover Mars (NASA)\n- Komunikasi satelit."
        },
        {
            t: "Quantum Computing Advance", 
            c: "QUBIT:\nUnit dasar informasi kuantum. Berbeda dengan Bit (0 atau 1), Qubit bisa 0 dan 1 sekaligus (Superposisi).\n\nPOTENSI:\nMemecahkan masalah yang butuh ribuan tahun bagi superkomputer klasik dalam hitungan detik (contoh: simulasi molekul, pemecahan enkripsi RSA)."
        },
        {
            t: "Transhumanism & Future Ethics", 
            c: "FILOSOFI:\nGerakan yang mendukung penggunaan teknologi untuk meningkatkan kemampuan fisik dan mental manusia (Human 2.0).\n\nISU ETIKA:\n- Kesenjangan sosial (hanya orang kaya yang 'upgrade').\n- Hilangnya esensi kemanusiaan.\n- Chip implan otak (Neuralink)."
        }
    ],
    'sejarah': [
        // --- TAHUN PERTAMA (NUSANTARA BASIC) ---
        // ZAMAN KUNO
        {
            t: "Zaman Prasejarah Nusantara", 
            c: "MANUSIA PURBA:\n1. Meganthropus (Manusia Raksasa): Paling tua.\n2. Pithecanthropus (Manusia Kera): Erectus (berjalan tegak).\n3. Homo Sapiens (Manusia Cerdas): Leluhur manusia modern.\n\nKEBUDAYAAN:\n- Paleolitikum (Batu Tua): Nomaden, berburu.\n- Neolitikum (Batu Muda): Menetap, bercocok tanam."
        },
        {
            t: "Kerajaan Kutai Martadipura", 
            c: "LOKASI:\nSungai Mahakam, Kalimantan Timur. Kerajaan Hindu tertua di Indonesia (Abad 4 M).\n\nBUKTI SEJARAH:\n7 Prasasti Yupa (Tiang batu pengikat hewan kurban) bertuliskan huruf Pallawa bahasa Sanskerta.\n\nRAJA TERKENAL:\n- Kudungga (Pendiri)\n- Aswawarman (Pembentuk Wangsa)\n- Mulawarman (Masa Kejayaan, kurban 20.000 sapi)."
        },
        {
            t: "Kemaritiman Sriwijaya", 
            c: "LOKASI:\nPalembang, Sumatera Selatan (Abad 7-13 M). Kerajaan Buddha terbesar.\n\nKEJAYAAN:\n- Menguasai Selat Malaka (Jalur perdagangan dunia).\n- Pusat studi agama Buddha (Dikunjungi I-Tsing).\n- Armada laut yang sangat kuat.\n\nPRASASTI:\nKedukan Bukit, Talang Tuo, Kota Kapur."
        },
        {
            t: "Majapahit & Sumpah Palapa", 
            c: "LOKASI:\nTrowulan, Jawa Timur (1293-1500 M). Kerajaan Hindu-Buddha terbesar pemersatu Nusantara.\n\nTOKOH:\n- Raden Wijaya (Pendiri)\n- Hayam Wuruk (Raja Masa Emas)\n- Gajah Mada (Mahapatih).\n\nSUMPAH PALAPA:\nSumpah Gajah Mada untuk tidak menikmati kemewahan duniawi sebelum menyatukan seluruh pulau Nusantara."
        },
        {
            t: "Masuknya Islam ke Nusantara", 
            c: "TEORI MASUKNYA:\n1. Teori Gujarat (India)\n2. Teori Mekkah (Arab)\n3. Teori Persia (Iran)\n\nSALURAN PENYEBARAN:\n- Perdagangan (Pedagang Muslim)\n- Perkawinan\n- Pendidikan (Pesantren)\n- Kesenian (Wayang Sunan Kalijaga)\n- Tasawuf."
        },
        {
            t: "Kesultanan Demak", 
            c: "SEJARAH:\nKerajaan Islam pertama di Jawa (1478 M). Didirikan oleh Raden Patah (putra Majapahit).\n\nPERAN:\n- Pusat penyebaran Islam di Jawa (Wali Songo).\n- Penyerangan ke Portugis di Malaka (oleh Pati Unus / Pangeran Sabrang Lor).\n\nPENINGGALAN:\nMasjid Agung Demak (Soko Tatal)."
        },
        
        // ZAMAN KOLONIAL
        {
            t: "Kolonialisme Portugis & Spanyol", 
            c: "MOTIVASI 3G:\n1. Gold (Kekayaan/Rempah)\n2. Glory (Kejayaan/Wilayah)\n3. Gospel (Penyebaran Agama)\n\nPERISTIWA:\n- 1511: Portugis (Alfonso de Albuquerque) menaklukkan Malaka.\n- 1512: Sampai di Maluku (Pusat Rempah).\n- Perjanjian Saragosa: Pembagian wilayah Spanyol & Portugis."
        },
        {
            t: "VOC (Vereenigde Oostindische Compagnie)", 
            c: "DEFINISI:\nKongsi Dagang Hindia Timur Belanda (1602). Perusahaan multinasional pertama di dunia.\n\nHAK OKTROI (Istimewa):\n- Hak monopoli dagang.\n- Hak mencetak uang.\n- Hak memelihara tentara & perang.\n- Hak memerintah (negara dalam negara).\n\nKEBANGKRUTAN (1799):\nKorupsi pegawai, biaya perang, persaingan dagang."
        },
        {
            t: "Perang Diponegoro (Perang Jawa)", 
            c: "WAKTU:\n1825 - 1830 (5 Tahun).\n\nPENYEBAB:\n- Belanda mematok tanah makam leluhur Pangeran Diponegoro.\n- Penderitaan rakyat akibat pajak.\n\nAKHIR PERANG:\nDiponegoro ditipu saat perundingan di Magelang, ditangkap, dan diasingkan ke Makassar. Perang ini membuat kas Belanda kosong."
        },
        {
            t: "Politik Etis (Balas Budi)", 
            c: "LATAR BELAKANG:\nKritik Van Deventer atas eksploitasi Belanda terhadap pribumi (Tanam Paksa).\n\nTRILOGI VAN DEVENTER:\n1. Irigasi (Pengairan sawah)\n2. Emigrasi (Pemerataan penduduk)\n3. Edukasi (Pendidikan) -> Paling berdampak, melahirkan golongan terpelajar Indonesia."
        },
        {
            t: "Kebangkitan Nasional (1908)", 
            c: "BUDI UTOMO:\nOrganisasi modern pertama (20 Mei 1908) oleh Dr. Sutomo & Wahidin Sudirohusodo.\n\nMAKNA:\nPerubahan pola perjuangan dari:\n- Fisik (Senjata) -> Diplomasi/Intelektual\n- Kedaerahan -> Nasional\n- Tergantung pemimpin -> Terorganisir."
        },
        {
            t: "Sumpah Pemuda (1928)", 
            c: "KONGRES PEMUDA II:\n27-28 Oktober 1928 di Jakarta.\n\nISI SUMPAH:\n1. Bertumpah darah satu: Tanah Indonesia.\n2. Berbangsa satu: Bangsa Indonesia.\n3. Menjunjung bahasa persatuan: Bahasa Indonesia.\n\nLAGU KEBANGSAAN:\nIndonesia Raya pertama kali diperdengarkan oleh W.R. Supratman (biola)."
        },

        // ZAMAN KEMERDEKAAN
        {
            t: "Pendudukan Jepang (1942-1945)", 
            c: "PROPAGANDA 3A:\nJepang Cahaya, Pelindung, Pemimpin Asia.\n\nDAMPAK NEGATIF:\n- Romusha (Kerja Paksa)\n- Kelaparan & Perampasan hasil bumi\n\nDAMPAK POSITIF:\n- Pelatihan Militer (PETA, Heiho)\n- Penggunaan Bahasa Indonesia\n- Pembentukan BPUPKI & PPKI."
        },
        {
            t: "Perumusan Dasar Negara (BPUPKI)", 
            c: "SIDANG BPUPKI:\nMerumuskan dasar negara Indonesia Merdeka.\n\nLAHIRNYA PANCASILA (1 Juni 1945):\nPidato Ir. Soekarno mengusulkan 5 sila dasar.\n\nPIAGAM JAKARTA (22 Juni):\nRumusan awal Pancasila oleh Panitia Sembilan. Sila 1 kemudian diubah demi persatuan bangsa."
        },
        {
            t: "Proklamasi Kemerdekaan", 
            c: "PERISTIWA RENGASDENGKLOK:\nGolongan Muda menculik Soekarno-Hatta agar segera memproklamasikan kemerdekaan, lepas dari pengaruh Jepang.\n\nDETIK-DETIK PROKLAMASI:\n- Tanggal: 17 Agustus 1945, pukul 10.00 WIB.\n- Lokasi: Jl. Pegangsaan Timur 56, Jakarta.\n- Bendera: Dijahit Fatmawati.\n- Teks: Diketik Sayuti Melik."
        },
        {
            t: "Pertempuran 10 November", 
            c: "LOKASI:\nSurabaya. Perang terbuka terbesar pasca kemerdekaan melawan Sekutu (Inggris).\n\nPENYEBAB:\nTewasnya Jenderal Mallaby dan ultimatum Inggris agar rakyat menyerahkan senjata.\n\nTOKOH:\nBung Tomo (Membakar semangat lewat radio). Diperingati sebagai Hari Pahlawan."
        },
        {
            t: "Diplomasi Mempertahankan Kemerdekaan", 
            c: "PERJUANGAN MEJA PERUNDINGAN:\n1. Linggarjati: Pengakuan de facto Jawa, Sumatera, Madura.\n2. Renville: Wilayah RI makin sempit.\n3. Roem-Roijen: Gencatan senjata.\n4. KMB (Konferensi Meja Bundar): Belanda mengakui kedaulatan Indonesia (RIS)."
        },
        {
            t: "Republik Indonesia Serikat (RIS)", 
            c: "KONSEP:\nIndonesia berubah menjadi negara serikat/federal hasil KMB (1949). Terdiri dari negara-negara bagian buatan Belanda (Boneka).\n\nKEMBALI KE NKRI (1950):\nRakyat menolak RIS dan menuntut kembali ke Negara Kesatuan Republik Indonesia melalui Mosi Integral Natsir."
        },

        // --- TAHUN KEDUA ---
        // SEMESTER 3 (Zaman Modern & Isu Global)
        {
            t: "Demokrasi Liberal (1950-1959)", 
            c: "CIRI KHAS:\n- Sistem Parlementer (PM memimpin pemerintahan, Presiden simbol negara).\n- Banyak Partai Politik.\n- Kabinet Jatuh Bangun (7 Kabinet dalam 9 tahun).\n\nDAMPAK:\nKetidakstabilan politik dan pembangunan terhambat, tapi kebebasan pers tinggi."
        },
        {
            t: "Dekrit Presiden 5 Juli 1959", 
            c: "LATAR BELAKANG:\nKegagalan Konstituante menyusun UUD baru dan ketidakstabilan politik.\n\nISI DEKRIT:\n1. Pembubaran Konstituante.\n2. Kembali ke UUD 1945 (UUDS 1950 tidak berlaku).\n3. Pembentukan MPRS dan DPAS.\n\nMenandai dimulainya Demokrasi Terpimpin."
        },
        {
            t: "Peristiwa G30S/PKI (1965)", 
            c: "TRAGEDI NASIONAL:\nPenculikan dan pembunuhan 6 Jenderal dan 1 Perwira TNI AD pada malam 30 September 1965.\n\nDAMPAK:\n- Krisis politik dan ekonomi.\n- Pembubaran PKI.\n- Lahirnya Supersemar (Surat Perintah 11 Maret).\n- Peralihan kekuasaan dari Orde Lama ke Orde Baru."
        },
        {
            t: "Masa Orde Baru (1966-1998)", 
            c: "KEPEMIMPINAN SOEHARTO:\nFokus pada Stabilitas Politik dan Pertumbuhan Ekonomi (Trilogi Pembangunan).\n\nKEBIJAKAN:\n- Repelita (Rencana Pembangunan Lima Tahun).\n- Swasembada Beras.\n- Keluarga Berencana (KB).\n- Dwifungsi ABRI.\n\nAKHIR:\nKrisis Moneter 1997 dan Reformasi 1998."
        },
        {
            t: "Reformasi 1998", 
            c: "PENYEBAB:\n- Krisis Ekonomi (Rupiah anjlok).\n- KKN (Korupsi, Kolusi, Nepotisme).\n- Tuntutan Demokrasi Mahasiswa.\n\nAGENDA REFORMASI:\n1. Adili Soeharto & kroninya.\n2. Amandemen UUD 1945.\n3. Otonomi Daerah.\n4. Penghapusan Dwifungsi ABRI.\n5. Kebebasan Pers."
        },
        {
            t: "Sejarah Kontemporer & Globalisasi", 
            c: "TANTANGAN MASA KINI:\n- Revolusi Industri 4.0.\n- Menjaga identitas bangsa di era digital.\n- Toleransi dan Radikalisme.\n- Peran Indonesia di G20 dan kancah global.\n\nSejarah terus berjalan, dan kitalah penulis bab selanjutnya."
        },
        
        // SEMESTER 4 (Sejarah Tematik)
        {
            t: "Sejarah Jalur Rempah", 
            c: "JALUR SUTRA MARITIM:\nJaringan rute perdagangan laut kuno yang menghubungkan Timur (Nusantara/China) dan Barat (Eropa/Timur Tengah).\n\nKOMODITAS:\nCengkeh (Ternate), Pala (Ambon), Lada. Dulu harganya lebih mahal dari emas di Eropa.\n\nDAMPAK:\nNusantara menjadi incaran kolonialisme bangsa Eropa."
        },
        {
            t: "Revolusi Industri Dunia", 
            c: "TAHAPAN:\n1.0: Mesin Uap (Abad 18) - Mekanisasi.\n2.0: Listrik & Assembly Line (Abad 19) - Produksi Massal.\n3.0: Komputer & Otomasi (Abad 20) - IT.\n4.0: Cyber-Physical (Sekarang) - IoT, AI, Big Data.\n\nDAMPAK SOSIAL:\nUrbanisasi, perubahan struktur kerja, dan kesenjangan ekonomi."
        },
        {
            t: "Perang Dunia I (1914-1918)", 
            c: "PENYEBAB:\nPembunuhan Pangeran Franz Ferdinand (Austria) dan sistem aliansi negara Eropa.\n\nPIHAK TERLIBAT:\n- Blok Sekutu (Inggris, Perancis, Rusia, AS).\n- Blok Sentral (Jerman, Austria-Hungaria, Ottoman).\n\nAKIBAT:\nRuntuhnya 4 kekaisaran besar dan lahirnya LBB (Liga Bangsa-Bangsa)."
        },
        {
            t: "Perang Dunia II (1939-1945)", 
            c: "PEMICU:\nInvasi Jerman ke Polandia.\n\nPIHAK:\n- Poros (Jerman, Jepang, Italia).\n- Sekutu (AS, Inggris, Uni Soviet, China).\n\nPERISTIWA KUNCI:\n- Holocaust (Genosida Yahudi).\n- Bom Atom Hiroshima & Nagasaki.\n- Lahirnya PBB (Perserikatan Bangsa-Bangsa)."
        },
        {
            t: "Perang Dingin (Cold War)", 
            c: "DEFINISI:\nKetegangan geopolitik antara Blok Barat (AS - Kapitalis) dan Blok Timur (Uni Soviet - Komunis) tanpa perang fisik langsung (1947-1991).\n\nBENTUK PERSAINGAN:\n- Perlombaan Senjata Nuklir.\n- Perlombaan Luar Angkasa (Space Race).\n- Proxy War (Perang Korea, Vietnam).\n- Spionase (CIA vs KGB)."
        },
        {
            t: "Konferensi Asia Afrika (KAA 1955)", 
            c: "LOKASI:\nGedung Merdeka, Bandung.\n\nTUJUAN:\nMempererat solidaritas negara-negara Asia-Afrika melawan kolonialisme dan neokolonialisme.\n\nHASIL:\nDasasila Bandung. Menjadi cikal bakal Gerakan Non-Blok (GNB).\n\nPERAN INDONESIA:\nTuan rumah dan pelopor (PM Ali Sastroamidjojo)."
        },
        
        // SEMESTER 5 (Sejarah Diplomasi & Regional)
        {
            t: "Gerakan Non-Blok (GNB)", 
            c: "PRINSIP:\nTidak memihak Blok Barat maupun Blok Timur dalam Perang Dingin.\n\nPENDIRI:\nSoekarno (Indonesia), Tito (Yugoslavia), Nasser (Mesir), Nehru (Mesir), Nkrumah (Ghana).\n\nTUJUAN:\nMeredakan ketegangan dunia dan memperjuangkan kemerdekaan negara terjajah."
        },
        {
            t: "Sejarah ASEAN", 
            c: "PENDIRIAN:\n8 Agustus 1967 di Bangkok. Oleh 5 Menlu (Adam Malik - Indonesia).\n\nTUJUAN:\nMempercepat pertumbuhan ekonomi, kemajuan sosial, dan perdamaian regional Asia Tenggara.\n\nPRINSIP:\nNon-intervensi (tidak ikut campur urusan dalam negeri anggota)."
        },
        {
            t: "Sejarah Perserikatan Bangsa-Bangsa (PBB)", 
            c: "PENDIRIAN:\n24 Oktober 1945 pasca PD II, menggantikan LBB.\n\nORGAN UTAMA:\n- Majelis Umum\n- Dewan Keamanan (5 Anggota Tetap punya Hak Veto)\n- Mahkamah Internasional\n- Sekretariat.\n\nINDONESIA DI PBB:\nPernah keluar (1965) saat konfrontasi Malaysia, lalu masuk kembali (1966)."
        },
        {
            t: "Integrasi Timor Timur", 
            c: "SEJARAH:\n- 1975: Operasi Seroja, integrasi ke Indonesia (Provinsi ke-27) pasca ditinggal Portugal.\n- 1999: Referendum/Jajak Pendapat di masa Presiden Habibie.\n- Hasil: Mayoritas memilih merdeka -> Lepas menjadi negara Timor Leste."
        },
        {
            t: "Konflik Laut China Selatan", 
            c: "ISU UTAMA:\nKlaim tumpang tindih wilayah perairan dan kepulauan (Spratly & Paracel) oleh China, Vietnam, Filipina, Malaysia, Brunei.\n\nPOSISI INDONESIA:\nBukan negara pengklaim (non-claimant), namun menjaga kedaulatan ZEE di Natuna Utara berdasarkan UNCLOS 1982."
        },
        {
            t: "Sejarah Palestina & Israel", 
            c: "AKAR KONFLIK:\nPerebutan wilayah tanah suci pasca runtuhnya Ottoman dan Mandat Inggris (1948). Deklarasi negara Israel memicu perang Arab-Israel.\n\nISU KUNCI:\nStatus Yerusalem, perbatasan, pengungsi, dan permukiman ilegal.\n\nSIKAP RI:\nMendukung kemerdekaan Palestina (Solusi Dua Negara)."
        },

        // SEMESTER 6 (Sejarah Kebudayaan & Sosial)
        {
            t: "Sistem Subak Bali (Warisan Dunia)", 
            c: "DEFINISI:\nSistem pengairan sawah (irigasi) tradisional Bali yang berbasis masyarakat dan filosofi Tri Hita Karana (Tuhan, Manusia, Alam).\n\nNILAI:\nDemokratis, adil, dan egaliter. Petani di hilir tetap mendapat air meski di hulu bisa memonopoli. Diakui UNESCO 2012."
        },
        {
            t: "Sejarah Batik Indonesia", 
            c: "MAKNA:\nSeni melukis kain dengan lilin (malam). Setiap motif memiliki filosofi (contoh: Parang = kekuasaan/raja).\n\nPENGAKUAN:\nUNESCO menetapkan Batik sebagai Warisan Kemanusiaan untuk Budaya Lisan dan Nonbendawi pada 2 Oktober 2009 (Hari Batik Nasional)."
        },
        {
            t: "Sejarah Bahasa Indonesia", 
            c: "ASAL USUL:\nBerasal dari Bahasa Melayu Riau (Lingua Franca perdagangan Nusantara).\n\nSUMPAH PEMUDA:\nDiangkat menjadi bahasa persatuan, bukan bahasa Jawa (mayoritas) demi kesetaraan.\n\nPERKEMBANGAN:\nEjaan Van Ophuijsen -> Soewandi -> EYD -> PUEBI."
        },
        {
            t: "Gerakan Emansipasi Wanita", 
            c: "TOKOH:\n- R.A. Kartini (Jepara): Habis Gelap Terbitlah Terang. Pendidikan wanita.\n- Dewi Sartika (Bandung): Sekolah Istri.\n- Cut Nyak Dien (Aceh): Perjuangan fisik perang.\n- Rasuna Said (Padang): Politik dan Pers.\n\nTUJUAN:\nKesetaraan hak pendidikan dan sosial bagi perempuan."
        },
        {
            t: "Sejarah Pendidikan Nasional", 
            c: "ERA KOLONIAL:\nSekolah hanya untuk bangsawan/Eropa (ELS, HIS, STOVIA).\n\nTAMAN SISWA (1922):\nKi Hajar Dewantara mendirikan sekolah untuk rakyat jelata. Semboyan: Ing Ngarso Sung Tulodo, Ing Madyo Mangun Karso, Tut Wuri Handayani.\n\nERA MERDEKA:\nPendidikan untuk semua (Wajib Belajar)."
        },
        {
            t: "Pelestarian Cagar Budaya", 
            c: "DEFINISI:\nWarisan budaya bersifat kebendaan (Benda, Bangunan, Struktur, Situs, Kawasan) yang perlu dilestarikan.\n\nCONTOH:\nCandi Borobudur, Situs Sangiran, Kota Tua Jakarta.\n\nTANTANGAN:\nPencurian artefak, vandalisme, bencana alam, dan pembangunan modern yang merusak situs."
        }
    ]
};

// ... existing selectMajor, startEntranceExam functions ...

// --- NEW: LOGIKA SIDANG SKRIPSI (THESIS DEFENSE) ---
let currentDefense = {
    major: null,
    score: 0,
    qIndex: 0,
    questions: []
};

function startThesisDefense(major) {
    currentDefense.major = major;
    currentDefense.score = 0;
    currentDefense.qIndex = 0;
    currentDefense.questions = [...THESIS_DB[major]];
    
    // Acak urutan soal sidang agar tidak hapalan mati
    currentDefense.questions.sort(() => Math.random() - 0.5);

    showDialogue("DOSEN PENGUJI UTAMA", 
        "Selamat datang di Sidang Akhir Skripsi. \n\nSaya akan mengajukan **5 Pertanyaan Kunci** terkait bidang studimu. \n\nSyarat Kelulusan: **Benar Minimal 4 Soal**. \nJika gagal, kamu harus merevisi draft-mu (mengulang sidang nanti).\n\nApakah kamu siap mempertanggungjawabkan karyamu?", 
        [
            {text: "SAYA SIAP! (Mulai Sidang)", action: nextDefenseQuestion},
            {text: "Saya baca buku dulu...", action: closeDialogue}
        ], 
        'images/lecture.png'
    );
}

function nextDefenseQuestion() {
    if (currentDefense.qIndex >= currentDefense.questions.length) {
        finishDefense();
        return;
    }

    const qData = currentDefense.questions[currentDefense.qIndex];
    
    const opts = qData.opts.map(opt => {
        return {
            text: opt,
            action: () => answerDefense(opt === qData.a)
        };
    });
    
    // Acak posisi jawaban
    opts.sort(() => Math.random() - 0.5);

    // Tampilkan Soal
    showDialogue(
        `SIDANG SKRIPSI (${currentDefense.qIndex + 1}/5)`, 
        `PERTANYAAN PENGUJI:\n\n**"${qData.q}"**`, 
        opts, 
        'images/lecture.png'
    );
}

function answerDefense(isCorrect) {
    if(isCorrect) {
        currentDefense.score++;
        showToast("Penguji Mengangguk... (Benar) ");
    } else {
        showToast("Penguji Mengerutkan Dahi... (Salah) ");
        // Hukuman mental (Energy turun dikit)
        STATE.player.energy = Math.max(0, STATE.player.energy - 5);
    }
    
    if(typeof AudioService !== 'undefined') AudioService.playSFX('item');
    
    currentDefense.qIndex++;
    setTimeout(() => nextDefenseQuestion(), 800);
}

function finishDefense() {
    const passed = currentDefense.score >= 4; // Syarat: Benar 4 dari 5
    
    if (passed) {
        let reaction = `Nilai Sidang: **${currentDefense.score * 20}** (A).\n\nSelamat! Kamu berhasil mempertahankan skripsimu dengan sangat baik. \n\nSaya dengan bangga menyatakan kamu **LULUS SIDANG SKRIPSI**!`;
        if (currentDefense.score === 5) reaction += "\n(Nilai Sempurna! Dosen terkesan!)";

        showDialogue("DOSEN PEMBIMBING", reaction, [{
            text: "Alhamdulillah! (Terima Ijazah & Gelar)", 
            action: () => {
                // CONSUME DRAFT
                if(STATE.player.inventory['draft_proposal'] > 0) {
                    STATE.player.inventory['draft_proposal']--;
                    if(STATE.player.inventory['draft_proposal'] <= 0) delete STATE.player.inventory['draft_proposal'];
                }

                // BERI HADIAH KELULUSAN
                addItem('buku_tesis', 1); // Simpan Tesis sebagai kenang-kenangan
                
                // NEW: BERIKAN IJAZAH SESUAI JURUSAN
                if (currentDefense.major === 'teknologi') {
                    addItem('ijazah_teknologi', 1);
                    showToast(" DITEMUKAN: Ijazah Sarjana Komputer (S.Kom)!");
                } else {
                    addItem('ijazah_sejarah', 1);
                    showToast(" DITEMUKAN: Ijazah Sarjana Humaniora (S.Hum)!");
                }

                STATE.player.reputation += 50; // Reputasi naik drastis
                STATE.player.money += 5000; // Hadiah kelulusan dari kampus/ortu
                gainExp(5000); // Big Exp
                
                // Achievement Sound
                if(typeof AudioService !== 'undefined') AudioService.playSFX('item');
                
                createParticle(STATE.player.x, STATE.player.y, '#fbbf24');
                closeDialogue();
            }
        }], 'images/lecture.png');
    } else {
        showDialogue("DOSEN PENGUJI", 
            `Skor: ${currentDefense.score}/5. (Tidak Lulus)\n\nMaaf, penguasaan materimu masih kurang. Jawabanmu banyak yang meleset dari teori.\n\n**STATUS: REVISI MAJOR**\nSilakan pelajari lagi materinya dan ajukan sidang ulang nanti.`, 
            [{text: "Siap Pak, saya akan belajar lagi. (Energy -30)", action: () => {
                STATE.player.energy = Math.max(0, STATE.player.energy - 30);
                closeDialogue();
            }}], 
            'images/lecture.png'
        );
    }
}

function finalizeRoleSetup() {
    updateHUDInfo();
    
    // UPDATE: Karena penjelasan fitur sudah di awal (startWakeUpSequence), 
    // Mentor Budi sekarang hanya memberikan motivasi penutup agar tidak repetitif.
    showDialogue(STATE.mentorName, 
        "Persiapan selesai! Status dasarmu telah ditetapkan.\n\nIngat pesan saya: Rajinlah menulis **Jurnal Refleksi** setiap hari di rumah agar Gurumu bisa menilai perkembanganmu.", 
        [{
            text: "Siap, Terima Kasih Mentor!", 
            action: () => {
                // FIX: KEMBALIKAN MENTOR KE POSISI ASAL (HILANG DARI DEPAN RUMAH)
                // Agar tidak menghalangi jalan atau terlihat aneh setelah tutorial selesai
                const villMap = maps['village'];
                const mentor = villMap.npcs.find(n => n.id === 'mentor');
                if (mentor) {
                    // UPDATE: Pindahkan ke -99 (Hilang dari map desa)
                    mentor.x = -99; 
                    mentor.y = -99;
                    // Reset kecepatan gerak jika perlu
                    mentor.vx = 0; 
                    mentor.vy = 0;
                }
                
                // FIX: BUKA KUNCI JURNAL (Akhiri Status Prologue)
                STATE.isPrologue = false;
                
                closeDialogue();

                // FIX: SIMPAN ULANG SETELAH DIALOG DITUTUP (DATA FINAL)
                manualSave();
                
                // Optional: Buka jurnal untuk Worker/Other roles agar sadar misi
                setTimeout(() => showDailyQuestPopup(), 500);
            }
        }], 
        'images/mentor.png'
    );
}

function updateHUDInfo() {
    const p = STATE.player;
    const name = DataService.user ? DataService.user.name : "Player";
    
    // Update Name & Level
    let roleDisplay = "?";
    if(p.role !== 'none') {
        roleDisplay = p.role.toUpperCase();
        // Tampilkan jurusan jika ada
        if(p.role === 'student' && p.major) {
            roleDisplay += ` (${p.major.substring(0,3).toUpperCase()})`;
        }
    }
    
    // Tampilkan di area nama atau tooltip (opsional, saat ini pakai nama saja di UI)
    document.getElementById('hud-name').innerText = name.length > 8 ? name.substring(0,6)+".." : name;
    document.getElementById('level-display').innerText = p.level;

    // FIX: UPDATE MONEY DISPLAY AGAR SINKRON
    // Menggunakan locale 'id-ID' agar format ribuan menggunakan titik (contoh: 36.000)
    document.getElementById('money-display').innerText = p.money.toLocaleString('id-ID');

    // Role Icon & Color Logic
    const roleIcon = document.getElementById('hud-role-icon');
    let icon = "?";
    let color = "#cbd5e1"; // Default Gray

    if(p.role === 'worker') { icon = ""; color = "#ef4444"; } // Red
    else if(p.role === 'student') { icon = ""; color = "#3b82f6"; } // Blue
    else if(p.role === 'entrepreneur') { icon = ""; color = "#10b981"; } // Green
    else if(p.role === 'family') { icon = ""; color = "#d946ef"; } // Pink
    
    roleIcon.innerText = icon;
    roleIcon.style.backgroundColor = color;

    // Update Stats Matrix
    document.getElementById('stat-str').innerText = p.str;
    document.getElementById('stat-int').innerText = p.int;
    document.getElementById('stat-rep').innerText = p.reputation;
    document.getElementById('stat-biz').innerText = p.biz;

    // Update Bars Width
    const hpPct = Math.max(0, Math.min(100, (p.hp / p.maxHp) * 100));
    const enPct = Math.max(0, Math.min(100, (p.energy / 100) * 100)); // Energy max is static 100 usually
    const expPct = Math.max(0, Math.min(100, (p.exp / p.maxExp) * 100));

    // UPDATE: TARGET ELEMENT HUD BARU
    const hudHpBar = document.getElementById('hud-hp-bar');
    if(hudHpBar) hudHpBar.style.width = hpPct + "%";
    
    document.getElementById('energy-bar').style.width = enPct + "%";
    document.getElementById('exp-bar').style.width = expPct + "%";

    // Text inside bars
    const hudHpText = document.getElementById('hud-hp-text');
    if(hudHpText) hudHpText.innerText = Math.floor(p.hp);
    
    document.getElementById('energy-text').innerText = Math.floor(p.energy);
    
    // UPDATE: HAPUS LOGIKA COMBAT HUD LAMA
    /*
    const combatHud = document.getElementById('combat-hud');
    if(STATE.location === 'dungeon') {
        combatHud.style.display = 'flex';
    } else {
        combatHud.style.display = 'none';
    }
    */
    
    // ALWAYS UPDATE BAG ICON
    updateBagIcon();
}

// --- NEW FUNCTION: UPDATE BAG ICON ---
function updateBagIcon() {
    const inv = STATE.player.inventory || {};
    // Hitung total item yang jumlahnya > 0
    let totalItems = 0;
    for (let key in inv) {
        if (inv[key] > 0) totalItems += inv[key];
    }
    
    const bagBtn = document.getElementById('bag-btn');
    if (totalItems > 0) {
        bagBtn.style.backgroundImage = "url('images/tas-isi.png')";
    } else {
        bagBtn.style.backgroundImage = "url('images/tas-kosong.png')";
    }
}

// --- NEW FUNCTION: TOGGLE HUD (COLLAPSIBLE) ---
function toggleHUD() {
    const hud = document.getElementById('main-hud');
    const btn = document.getElementById('hud-toggle-btn');
    
    // Toggle Class
    hud.classList.toggle('compact-mode');
    
    // SFX
    if(typeof AudioService !== 'undefined') AudioService.playSFX('bg');

    // Update Button Icon & Position Logic
    if (hud.classList.contains('compact-mode')) {
        btn.innerText = ""; // Panah Bawah (Show)
        btn.title = "Tampilkan Detail";
        // Posisi tombol diatur via CSS (.compact-mode ~ #hud-toggle-btn)
    } else {
        btn.innerText = ""; // Panah Atas (Hide)
        btn.title = "Sembunyikan Stats";
    }
}

// --- NEW FUNCTION: TOGGLE INVENTORY SCREEN ---
function toggleInventory() {
    // UPDATE: Ganti 'bg' menjadi 'item' agar suara lebih terdengar (seperti suara koin/barang)
    if(typeof AudioService !== 'undefined') AudioService.playSFX('item'); 

    const screen = document.getElementById('inventory-screen');
    const isHidden = screen.style.display === 'none' || screen.style.display === '';
    
    if (isHidden) {
        screen.style.display = 'flex';
		updateInventoryStats(); // NEW: Update status saat buka
        renderInventory();
        STATE.screen = 'modal'; // Pause game input
    } else {
        screen.style.display = 'none';
        STATE.screen = 'play'; // Resume game
    }
}

// --- NEW FUNCTION: UPDATE STATUS DI INVENTORY ---
function updateInventoryStats() {
    const p = STATE.player;
    const hpEl = document.getElementById('inv-hp-val');
    const enEl = document.getElementById('inv-energy-val');
    if(hpEl) hpEl.innerText = Math.floor(p.hp) + "/" + p.maxHp;
    if(enEl) enEl.innerText = Math.floor(p.energy) + "%";
}

// --- NEW FUNCTION: FORCE SYNC (MANUAL BUTTON) ---
async function forceSync() {
    const icon = document.getElementById('sync-icon');
    const text = document.getElementById('sync-text');
    const btn = document.getElementById('sync-btn');
    
    // 1. Visual Feedback: Loading
    icon.innerText = "";
    text.innerText = "Mengirim...";
    text.style.color = "#fbbf24"; // Kuning
    btn.style.borderColor = "#fbbf24";

    try {
        // 2. Lakukan Penyimpanan Manual (Trigger update ke Firebase)
        await manualSave();
        
        // 3. Visual Feedback: Sukses
        icon.innerText = "";
        text.innerText = "Tersimpan!";
        text.style.color = "#4ade80"; // Hijau
        btn.style.borderColor = "#4ade80";
        
        // Play SFX
        if(typeof AudioService !== 'undefined') AudioService.playSFX('item');

    } catch (e) {
        // 4. Visual Feedback: Gagal
        icon.innerText = "";
        text.innerText = "Gagal (Offline)";
        text.style.color = "#ef4444"; // Merah
        btn.style.borderColor = "#ef4444";
        console.error("Sync failed:", e);
    }

    // 5. Reset Tampilan setelah 2 detik
    setTimeout(() => {
        icon.innerText = "";
        text.innerText = "Sync Data";
        text.style.color = "#94a3b8"; // Kembali Abu-abu
        btn.style.borderColor = "#334155";
    }, 2000);
}


function triggerGameOver() {
    if(STATE.gameOverTriggered) return;
    STATE.gameOverTriggered = true;
    STATE.screen = 'gameover'; 
    
    const role = STATE.player.role;
    let reflection = "";
    
    if(role === 'worker') {
        reflection = "Sebagai seorang Fighter (Pekerja), kamu telah mengerahkan tenaga dan keringatmu. Mungkin hasilnya belum maksimal, tapi kerja kerasmu membentuk karakter yang kuat. Dunia industri memang keras, tapi kamu lebih keras.";
    } else if(role === 'student') {
        reflection = "Jalur Mage (Akademisi) yang kamu pilih penuh dengan ilmu. Mungkin nilaimu belum sempurna, atau teorimu belum teruji di lapangan. Namun, wawasan adalah investasi jangka panjang yang tak akan rugi.";
    } else if(role === 'entrepreneur') {
        reflection = "Menjadi Support (Pebisnis) itu berisiko. Mungkin profitmu belum setinggi langit, atau usahamu mengalami pasang surut. Ingat, kegagalan bisnis adalah biaya kuliah untuk kesuksesan di masa depan.";
    } else {
        reflection = "Kamu menjalani hari-harimu tanpa arah yang spesifik. Eksplorasi itu baik, tapi fokus adalah kunci keberhasilan. Di kehidupan selanjutnya, cobalah tentukan tujuan lebih awal.";
    }
    
    document.getElementById('reflection-text').innerText = reflection;

    const quotes = [
        "\"Kegagalan hanyalah kesempatan untuk memulai lagi dengan lebih cerdas.\" - Henry Ford",
        "\"Bukan seberapa sering kamu jatuh, tapi seberapa cepat kamu bangkit.\" - Unknown",
        "\"Masa depan dimiliki oleh mereka yang percaya pada keindahan mimpi mereka.\" - Eleanor Roosevelt",
        "\"Jangan takut gagal. Takutlah berada di tempat yang sama tahun depan.\" - Unknown",
        "\"Setiap ahli dulunya adalah seorang pemula.\" - Helen Hayes"
    ];
    document.getElementById('motivation-text').innerText = quotes[Math.floor(Math.random() * quotes.length)];

    document.getElementById('ui-layer').classList.add('hidden');
    document.getElementById('game-over-screen').style.display = 'flex';

    DataService.resetSaveData();
}

function triggerGameWin() {
    if(STATE.gameFinished) return;
    STATE.gameFinished = true;
    STATE.screen = 'modal'; 
    
    const screen = document.getElementById('ending-screen');
    const narration = document.getElementById('ending-narration');
    const certBox = document.getElementById('cert-box');
    const options = document.getElementById('ending-options');
    
    screen.style.display = 'flex';
    document.getElementById('ui-layer').classList.add('hidden');

    narration.style.display = 'block';
    narration.style.opacity = 0;
    setTimeout(() => narration.style.opacity = 1, 500);

    setTimeout(() => {
        narration.style.display = 'none';
        certBox.style.display = 'block';
        
        document.getElementById('cert-name').innerText = DataService.user ? DataService.user.name : "Player";
        document.getElementById('cert-role').innerText = STATE.player.role.toUpperCase();
        document.getElementById('cert-rep').innerText = STATE.player.reputation;
        document.getElementById('cert-asset').innerText = STATE.player.money.toLocaleString();

        setTimeout(() => {
            options.style.display = 'flex';
        }, 2000);
    }, 4000);
}

function continueFreeRoam() {
    STATE.freeRoamMode = true;
    STATE.screen = 'play';
    document.getElementById('ending-screen').style.display = 'none';
    document.getElementById('ui-layer').classList.remove('hidden');
    showToast(" MODE FREE ROAM AKTIF");
}

function finishGame() {
    alert("Terima kasih telah bermain! Data kelulusan telah dikirim ke guru.");
    logout();
}

// --- FIX: RESTART GAME SEKARANG MENGGUNAKAN RELOAD UNTUK PEMBERSIHAN TOTAL ---
async function restartGame() {
    // 1. Visual Feedback
    const btn = document.querySelector('#game-over-screen button');
    if(btn) {
        btn.innerHTML = " Wiping Data...";
        btn.disabled = true;
    }
    document.body.style.cursor = 'wait';

    // 2. Hentikan Loop Game & Auto Save (Penting!)
    if(window.gameLoopId) cancelAnimationFrame(window.gameLoopId);
    if(window.saveIntervalId) clearInterval(window.saveIntervalId);

    try {
        // 3. Hapus Data Permanen (Cloud & Local Cache)
        await DataService.resetSaveData();
        
        // 4. Force Reload Halaman
        // Ini adalah cara paling aman. checkSession() akan berjalan saat reload.
        // Karena Local Storage sudah dibersihkan di langkah 3, checkSession akan
        // mendeteksi 'saveData = null' dan OTOMATIS memanggil startPrologue().
        location.reload();

    } catch (e) {
        console.error("Restart Error:", e);
        alert("Gagal mereset data. Halaman akan dimuat ulang paksa.");
        location.reload();
    }
}

function returnToTitle() {
    location.reload(); 
}

let lastCollisionTime = 0; 

// --- NEW FUNCTION: HANDLE SKILL (ULTIMATE) ---
function handleSkill() {
    const p = STATE.player;
    
    // Cek Cooldown
    if (p.skillCooldown > 0) {
        showToast("Skill sedang Cooldown!");
        return;
    }
    
    // Cek Energi
    if (p.energy < 10) {
        showToast("Energi tidak cukup! (Butuh 10)");
        return;
    }

    // Activate Skill
    p.energy -= 10;
    p.skillCooldown = 180; // 3 Detik Cooldown (60 FPS)
    
    // Logic: AoE Damage
    const range = 120; // Radius ledakan
    const damage = p.str * 4 + 20; // Damage Besar (Base + STR)

    // Visual Effect: Shockwave Ring
    for (let i = 0; i < 36; i++) {
        const angle = (i * 10) * (Math.PI / 180);
        STATE.particles.push({
            x: p.x + 10, 
            y: p.y + 10,
            vx: Math.cos(angle) * 8, // Menyebar cepat
            vy: Math.sin(angle) * 8,
            life: 30,
            color: '#ef4444', // Merah Api
            size: 5 + Math.random() * 5,
            type: 'dust' // Reuse dust logic for circle particles
        });
    }
    
    // Screen Shake Effect
    STATE.shakeTimer = 20;
    
    // SFX
    if(typeof AudioService !== 'undefined') AudioService.playSFX('hit');

    // Damage Calculation
    let hitCount = 0;
    STATE.enemies.forEach(en => {
        const dist = Math.hypot(p.x - en.x, p.y - en.y);
        if (dist < range) {
            hitCount++;
            en.hp -= damage;
            
            // Massive Knockback (Terlempar jauh)
            en.knockback = { 
                x: (en.x - p.x) * 2, 
                y: (en.y - p.y) * 2 
            };
            
            spawnFloatingText(en.x, en.y - 30, " " + damage, "#ef4444", 20);
            createParticle(en.x, en.y, '#fbbf24'); // Sparks
        }
    });

    if (hitCount > 0) {
        showToast(`ULTIMATE! Hit ${hitCount} Musuh!`);
        spawnFloatingText(p.x, p.y - 40, "BOOM!", "#fbbf24", 24);
    } else {
        showToast("Skill meleset... (Tidak ada target)");
    }
}

// --- FIX: DEFINISI FUNGSI GAMELOOP (WAJIB ADA) ---
function gameLoop() {
    // 1. Update Logika Game
    update();
    
    // 2. Render Grafis ke Canvas
    draw();
    
    // 3. Update Audio System (BGM/SFX)
    if(typeof AudioService !== 'undefined') AudioService.update();

    // 4. Loop Frame berikutnya (60 FPS)
    // Cek agar tidak loop saat di Title/Splash/Login untuk menghemat memori
    if (STATE.screen !== 'title' && STATE.screen !== 'login' && STATE.screen !== 'splash') {
        window.gameLoopId = requestAnimationFrame(gameLoop);
    }
}

function update() {
    // --- FIX: UPDATE POINTER TUTORIAL SELALU (BAHKAN SAAT DIALOG/PAUSE) ---
    // Pindahkan logika ini ke ATAS pengecekan screen !== 'play'
    // Ini memastikan tangan penunjuk tetap muncul dan posisinya benar saat dialog tutorial aktif
    if (STATE.tutorialFocusTarget) {
        updateTutorialPointerPosition();
    }

    if (STATE.screen !== 'play') return;
	
    // Removed btnSkill display logic block here

    // --- NEW: UPDATE LIVE TUTORIAL POINTER ---
    // Pastikan pointer selalu menempel pada objek meskipun kamera bergerak
    if (STATE.tutorialFocusTarget) {
        updateTutorialPointerPosition();
    }

    // --- NEW: LOGIKA SEMBUNYIKAN TOMBOL SPRINT DI DUNGEON ---
    const btnSprint = document.getElementById('btn-sprint');
    const btnSkill = document.getElementById('btn-skill'); // Reference skill button

    if (btnSprint) {
        // Cek apakah lokasi adalah Dungeon atau Arena Battle
        const isCombatZone = (STATE.location === 'dungeon' || STATE.location === 'ruins_battle');
        
        if (isCombatZone) {
            // Jika di zona tempur: Sembunyikan Sprint, Tampilkan Skill
            if (btnSprint.style.display !== 'none') {
                btnSprint.style.display = 'none';
                STATE.player.isSprinting = false; // Paksa berhenti lari
            }
            
            // Tampilkan Skill Button
            if (btnSkill) {
                btnSkill.style.display = 'flex';
                // Update Visual Cooldown
                if (STATE.player.skillCooldown > 0) {
                    btnSkill.classList.add('cooldown');
                    // Tampilkan sisa detik
                    const cdSec = Math.ceil(STATE.player.skillCooldown / 60);
                    btnSkill.innerText = cdSec; 
                    btnSkill.title = `Cooldown: ${cdSec}s`; // UPDATE: Dynamic Tooltip
                } else {
                    btnSkill.classList.remove('cooldown');
                    btnSkill.innerText = '';
                    btnSkill.title = "Ultimate Skill (10 Stamina)"; // UPDATE: Tooltip Ready
                }
            }

        } else {
            // Jika di zona aman: Tampilkan Sprint, Sembunyikan Skill
            if (btnSprint.style.display === 'none') {
                btnSprint.style.display = 'flex';
            }
            if (btnSkill) btnSkill.style.display = 'none';
        }
    }

    // --- NEW: DECREMENT SKILL COOLDOWN ---
    if (STATE.player.skillCooldown > 0) {
        STATE.player.skillCooldown--;
    }

    // --- NEW: GLOBAL LOW ENERGY WARNING CHECK ---
    // Cek jika energi kritis (<= 20) dan belum diperingatkan
    if (STATE.player.energy <= 20 && !STATE.lowEnergyWarned) {
        showToast(" PERINGATAN: Stamina Kritis! Segera Makan/Istirahat.");
        if(typeof AudioService !== 'undefined') AudioService.playSFX('hit'); // Bunyi alert
        STATE.lowEnergyWarned = true; // Set flag agar tidak spam
    } 
    // Reset flag jika energi sudah diisi kembali (> 20)
    else if (STATE.player.energy > 20) {
        STATE.lowEnergyWarned = false;
    }

    // UPDATE: Waktu diperlambat (1 Jam Game = 60 Detik Real Time)
    // Rumus: 100 unit (1 jam) / 60 detik / 60 fps  0.028
    STATE.time += 0.028; 
    
    if(STATE.player.shiftStarted) {
        if(STATE.time >= 1600) { 
            STATE.player.shiftStarted = false;
            STATE.player.salaryDays++;
            
            // --- UPDATE: SISTEM GAJI BERJENJANG (CAREER PATH) ---
            const currentLvl = STATE.player.jobLevel || 1;
            let dailyWage = 5000; // Lv 1 Magang

            if (currentLvl === 2) dailyWage = 7500;  // Staff Senior
            else if (currentLvl === 3) dailyWage = 12000; // Kepala Gudang
            else if (currentLvl === 4) dailyWage = 25000; // Manajer Cabang

            // --- NEW: BONUS CINCIN RAJA (PASIF GOLD++) ---
            let bonusMsg = "";
            if ((STATE.player.inventory['cincin_legend'] || 0) > 0) {
                dailyWage = Math.floor(dailyWage * 1.5); // +50% Gaji
                bonusMsg = " "; // Indikator Bonus
            }

            STATE.player.money += dailyWage;
            STATE.player.energy -= 30; 
            
            if(typeof AudioService !== 'undefined') AudioService.playSFX('item'); // SFX Gaji

            if(STATE.time > 1630) {
                showToast(`Shift Selesai. Gaji: ${dailyWage.toLocaleString()} G${bonusMsg}`);
            } else {
                STATE.player.bossReputation += 1;
                showToast(`Kerja Bagus! (+${dailyWage.toLocaleString()} G${bonusMsg}, Rep +1)`);
            }
        }
    }

    const totalDays = STATE.day - 1; 
    const seasonIndex = Math.floor((totalDays % (DAYS_PER_SEASON * 4)) / DAYS_PER_SEASON);
    STATE.season = SEASONS[seasonIndex].toLowerCase();
    
    const year = Math.floor(totalDays / (DAYS_PER_SEASON * 4)) + 1;
    const dayInSeason = (totalDays % DAYS_PER_SEASON) + 1;
    
    // --- NEW: HITUNG NAMA HARI (SENIN-MINGGU) ---
    // (Day 1 = Senin, Day 7 = Minggu, Day 8 = Senin dst)
    const dayName = DAYS_OF_WEEK[(STATE.day - 1) % 7];

    if (!STATE.freeRoamMode) {
        // FIX: Ubah logika notifikasi Trial Selesai ke Tahun ke-4 (Setelah 3 tahun habis)
        if (year === 4 && dayInSeason === 1 && STATE.time < 10) {
            showToast(" MASA TRIAL SELESAI! Semua Akses Terbuka.");
        }

        if (year > 5 && !STATE.gameFinished) {
            triggerGameWin();
            return;
        }

        const daysInYear = DAYS_PER_SEASON * 4; 
        
        // FIX: Ubah durasi Trial menjadi 3 Tahun (3 * 120 = 360 Hari)
        // Sebelumnya: 2 * daysInYear (240 Hari)
        const trialLimit = 3 * daysInYear; 
        
        const graduationLimit = 5 * daysInYear; 
        
        let labelText = "";
        
        if (STATE.day <= trialLimit) {
             const left = trialLimit - STATE.day;
             labelText = ` Trial: ${left} Hari`;
             document.getElementById('trial-display').style.color = '#ef4444'; 
        } else {
             const left = graduationLimit - STATE.day;
             labelText = ` Lulus: ${left} Hari`;
             document.getElementById('trial-display').style.color = '#fbbf24'; 
        }
        
        document.getElementById('trial-display').innerText = labelText;
    } else {
        document.getElementById('trial-display').innerText = " Free Roam";
    }

    if(STATE.time >= 2400) {
        STATE.time = 0;
        STATE.day++;

		
		// --- [KODE PERTANIAN: LOGIKA TUMBUH & SIRAM OTOMATIS (KURCACI)] ---
        if (STATE.player.farming) {
            for (const [key, crop] of Object.entries(STATE.player.farming)) {
                if (crop && crop.type) {
                    // Logika Kurcaci: Auto Siram sebelum tumbuh
                    if (STATE.player.hiredDwarf) {
                        crop.watered = true; 
                    }

                    // Logika Tumbuh
                    if (crop.watered) {
                        if (crop.stage < 3) crop.stage++;
                    }
                    crop.watered = false; // Reset air
                }
            }
        }
		
		// --- [BARU: LOGIKA AUTO PANEN (PERI PANEN)] ---
        // Jika Peri sudah dihire, cek tanaman yang matang (Stage 3)
        if (STATE.player.hiredFairy && STATE.player.farming) {
            let harvestedCount = 0;
            for (const [key, crop] of Object.entries(STATE.player.farming)) {
                // Jika ada tanaman DAN sudah matang (Stage 3)
                if (crop && crop.type && crop.stage >= 3) {
                    // Tentukan hasil panen
                    let item = 'gandum'; // Default
                    let qty = 1;
                    
                    if (crop.type === 'padi') { item = 'gandum'; qty = 2; }
                    else if (crop.type === 'jagung') { item = 'gandum'; qty = 3; } // Mapping sederhana
                    else if (crop.type === 'tomat') { item = 'gandum'; qty = 2; }
                    else if (crop.type === 'rafflesia') { item = 'bunga_rafflesia'; qty = 1; }

                    // Tambah ke Inventory
                    addItem(item, qty);
                    harvestedCount++;

                    // Hapus Tanaman (Panen) - Sisakan tanah gembur
                    delete crop.type;
                    delete crop.stage;
                    delete crop.watered;
                }
            }
            if (harvestedCount > 0) {
                showToast(`Peri Panen: ${harvestedCount} tanaman dipanen otomatis! `);
            }
        }
        // ----------------------------------------------------
		
        // NEW: RESET COUNTER HARIAN (MANCING, MONSTER, TALK)
        STATE.player.dailyFishingCount = 0;
        STATE.player.dailyMonsterKills = 0;
        STATE.player.dailyTalkCount = 0;
        
        if(STATE.player.shiftStarted) {
            STATE.player.shiftStarted = false;
            STATE.player.bossReputation -= 5; 
            showToast("Boss Marah: Kamu tidak absen pulang!");
        }
        
        if(STATE.player.salaryDays >= 30) {
            STATE.player.salaryDays = 0;
            const bonus = STATE.player.bossReputation * 100;
            STATE.player.money += bonus;
            if(typeof AudioService !== 'undefined') AudioService.playSFX('item'); // SFX Bonus
            showToast(`BONUS BULANAN DITERIMA: ${bonus} Gold!`);
        }

        // --- NEW: BEASISWA BULANAN (KHUSUS MAHASISWA BERPRESTASI) ---
        // Trigger setiap awal bulan (Hari 31, 61, 91, dst) -> 1 Bulan = 30 Hari
        if (STATE.player.role === 'student' && STATE.player.scholarship && (STATE.day - 1) % 30 === 0 && STATE.day > 1) {
            const scholarshipAmount = 15000;
            STATE.player.money += scholarshipAmount;
            
            // Tampilkan Notifikasi Uang Saku
            setTimeout(() => {
                showDialogue("KAMPUS - BAGIAN KEUANGAN", 
                    ` **TRANSFER BEASISWA MASUK**\n\nHalo Mahasiswa Berprestasi,\nUang saku beasiswa bulanan sebesar **Rp ${scholarshipAmount.toLocaleString()}** telah ditransfer ke rekening Anda.\n\nGunakan untuk biaya hidup dan beli buku pelajaran ya!`, 
                    [{text: "Terima Kasih! (Cair)", action: closeDialogue}], 
                    'images/lecture.png'
                );
                if(typeof AudioService !== 'undefined') AudioService.playSFX('item');
            }, 2500); // Delay sedikit agar muncul setelah notifikasi ganti hari
        }

        // --- NEW: SISTEM BAYAR UKT TAHUNAN (UPDATE LOGIKA BEASISWA VS REGULER) ---
        // Trigger setiap awal tahun baru (Hari 121, 241, dst) -> 1 Tahun = 120 Hari
        if(STATE.player.role === 'student' && (STATE.day - 1) % 120 === 0 && STATE.day > 1) {
            const currentYear = Math.ceil(STATE.day / 120);
            
            // CEK 1: APAKAH MAHASISWA BEASISWA?
            if (STATE.player.scholarship) {
                // JIKA BEASISWA: GRATIS
                setTimeout(() => {
                    showDialogue("BAGIAN KEUANGAN KAMPUS", 
                        ` **PEMBERITAHUAN TAHUN AJARAN BARU**\n\nMemasuki Tahun ke-${currentYear}.\n\nStatus Anda: **PENERIMA BEASISWA**\nBiaya UKT: **GRATIS (Rp 0)**.\n\nPertahankan prestasimu!`, 
                        [{text: "Alhamdulillah (Lanjut Kuliah)", action: closeDialogue}], 
                        'images/lecture.png'
                    );
                    if(typeof AudioService !== 'undefined') AudioService.playSFX('item');
                }, 1500);
            } 
            // CEK 2: JIKA BUKAN BEASISWA (REGULER)
            else {
                const uktAmount = 600000;
                
                // Tarik Uang (Bisa Minus/Hutang)
                STATE.player.money -= uktAmount;
                
                // Tampilkan Notifikasi Tagihan
                setTimeout(() => {
                    let statusMsg = "";
                    let titleMsg = "TAGIHAN UKT OTOMATIS";
                    let iconMsg = " Lunas";
                    
                    if(STATE.player.money < 0) {
                        statusMsg = `\n\n **PERINGATAN KRITIS**:\nSaldo Anda MINUS (${STATE.player.money.toLocaleString()} G). \nSegera lunasi hutang ini atau Ijazah Anda akan ditahan!`;
                        titleMsg = "TUNGGAKAN UKT";
                        iconMsg = " Berhutang";
                    }
                    
                    showDialogue("BAGIAN KEUANGAN KAMPUS", 
                        ` **PEMBERITAHUAN TAHUN AJARAN BARU**\n\nMemasuki Tahun ke-${currentYear}.\nBiaya UKT (Jalur Reguler) sebesar **Rp ${uktAmount.toLocaleString()}** telah dibebankan ke rekening Anda.\n\nStatus: ${iconMsg}${statusMsg}`, 
                        [{text: "Mengerti (Lanjut Kuliah)", action: closeDialogue}], 
                        'images/lecture.png'
                    );
                    
                    if(typeof AudioService !== 'undefined') AudioService.playSFX('item');
                }, 1500); 
            }
        }

        randomizeWeather();
        
        // --- NEW: RESPAWN BUNGA LIAR SETIAP HARI ---
        spawnWildFlowers();

        // --- NEW: POPUP QUEST HARIAN SAAT GANTI HARI ---
        showDailyQuestPopup();
        
        // showToast(`Day ${STATE.day} (${STATE.season.toUpperCase()})`); // Toast diganti popup biar lebih jelas
    }

    // --- NEW: FAINTING MECHANIC (PINGSAN KARENA LELAH) ---
    if(STATE.player.energy <= 0) {
        handleFaint();
        return; // Hentikan update frame ini
    }

    const btnAction = document.getElementById('btn-action');
    const entranceNear = checkEntranceProximity();
    
    // LOGIC BARU: Cek Interaksi untuk Visibility Tombol
    let showActionButton = false;
    let actionIcon = '';

    // 1. Cek Dungeon (Selalu Muncul untuk Serang)
    if (STATE.location === 'dungeon') {
        showActionButton = true;
        actionIcon = '';
    } 
    // 2. Cek Fishing (Selalu Muncul)
    else if (STATE.fishing.active) {
        showActionButton = true;
        actionIcon = '';
    }
    // 3. Cek Interaksi (Bangunan/Pintu)
    else if (entranceNear) {
        showActionButton = true;
        // FIX: Custom Icon berdasarkan Tipe Bangunan
        if (entranceNear.id === 'port') {
            actionIcon = '';
        } 
        // UPDATE: Ganti Ikon Pintu jadi Scroll untuk Papan Misi
        else if (entranceNear.id === 'papan_misi') {
            actionIcon = ''; 
        }
        // UPDATE: Ganti Ikon Pintu jadi Piala untuk Statue
        else if (entranceNear.id === 'statue_rank') {
            actionIcon = ''; 
        }
        else {
            actionIcon = '';
        }
    }
    // 4. Cek Interaksi (NPC & Object)
    else {
        // Cek NPC
        const map = maps[STATE.location];
        
        // --- UPDATE: Logic Deteksi NPC (Menggunakan Jarak Radial) ---
        // Cari NPC terdekat dalam radius interaksi
        let closestNPC = null;
        let minNPCDist = 50; // Radius deteksi NPC (pixel)

        for (let npc of map.npcs) {
            if (!isNPCActive(npc)) continue;
            // Hitung jarak dari tengah player ke tengah NPC
            const pCX = STATE.player.x + (STATE.player.w/2);
            const pCY = STATE.player.y + (STATE.player.h/2);
            const nCX = (npc.x * TILE_SIZE) + ((npc.w||40)/2);
            const nCY = (npc.y * TILE_SIZE) + ((npc.h||60)/2);
            
            const dist = Math.hypot(pCX - nCX, pCY - nCY);
            if (dist < minNPCDist) {
                closestNPC = npc;
                break; // Prioritaskan NPC
            }
        }

        if (closestNPC) {
            showActionButton = true;
            // UPDATE: Jika NPC adalah Pasangan Nikah, ganti ikon tombol jadi Hati
            if (STATE.player.married && STATE.player.spouseId === closestNPC.id) {
                actionIcon = '';
            } else {
                actionIcon = '';
            }
        }

        // Scan Object Nearby (Jika belum ketemu NPC)
        if (!showActionButton) {
            // --- FIX: DEFINISI VARIABEL BOUNDING BOX PLAYER ---
            const buffer = 10;
            const pLeft = STATE.player.x - buffer;
            const pRight = STATE.player.x + STATE.player.w + buffer;
            const pTop = STATE.player.y - buffer;
            const pBottom = STATE.player.y + STATE.player.h + buffer;

            for(let obj of map.objects) {
                // --- FIX: DEFINISI VARIABEL BOUNDING BOX OBJECT ---
                const oLeft = obj.x * TILE_SIZE;
                const oRight = (obj.x + (obj.w || 1)) * TILE_SIZE;
                const oTop = obj.y * TILE_SIZE;
                const oBottom = (obj.y + (obj.h || 1)) * TILE_SIZE;

                // --- UPDATE: LOGIKA DETEKSI OBJEK "SENTUH" (BERSENTUHAN) ---
                // ... existing object detection logic ...
                const isTouching = (pLeft < oRight && pRight > oLeft && 
                                    pTop < oBottom && pBottom > oTop);

                if (isTouching) {
                    showActionButton = true;
                    // Icon khusus berdasarkan tipe objek
                    if(obj.type === 'mailbox') actionIcon = '';
                    else if(obj.type === 'fishing_spot') actionIcon = '';
                    else if(obj.type === 'sign') actionIcon = '';
                    else if(obj.type === 'bookshelf') actionIcon = ''; 
                    else if(obj.type === 'bed') actionIcon = ''; 
                    else actionIcon = ''; 
                    break;
                }
            }
        }

        // --- NEW: CEK TILE LAHAN PERTANIAN (JIKA TIDAK ADA OBJEK/NPC) ---
        if (!showActionButton && STATE.location === 'village') {
            const pTx = Math.floor((STATE.player.x + 10) / TILE_SIZE);
            const pTy = Math.floor((STATE.player.y + 15) / TILE_SIZE);
            const tIdx = pTy * ISLAND_W + pTx;
            
            // Tile ID 5 adalah Tanah Lahan
            if (map.tiles[tIdx] === 5) {
                showActionButton = true;
                
                // CEK SYARAT: HARUS SUDAH DAPAT KURCACI TANI
                if (STATE.player.hiredDwarf) {
                    // Jika sudah punya kurcaci, cek kondisi tanah spesifik
                    const farmKey = `${pTx}_${pTy}`;
                    
                    // Pastikan object farming ada
                    if (!STATE.player.farming) STATE.player.farming = {};
                    const crop = STATE.player.farming[farmKey];
                    
                    if (crop && crop.type) {
                        // Ada tanaman
                        if (crop.stage >= 3) {
                            actionIcon = ''; // Siap Panen
                            btnAction.title = "Panen Tanaman";
                        } else if (!crop.watered) {
                            actionIcon = ''; // Perlu Disiram
                            btnAction.title = "Siram Tanaman";
                        } else {
                            actionIcon = ''; // Sudah disiram/tumbuh
                            btnAction.title = "Lihat Tanaman";
                        }
                    } else if (crop && crop.tilled) {
                        // Tanah sudah dicangkul, siap tanam
                        actionIcon = ''; 
                        btnAction.title = "Tanam Bibit";
                    } else {
                        // Tanah biasa, perlu dicangkul
                        actionIcon = ''; 
                        btnAction.title = "Cangkul Lahan";
                    }
                } else {
                    // BELUM PUNYA KURCACI -> DISILANG
                    actionIcon = '';
                    btnAction.title = "Lahan Belum Bisa Digunakan";
                }
            }
        }
    }

    // UPDATE DOM BUTTON
    if (showActionButton) {
        btnAction.style.display = 'flex';
        btnAction.innerText = actionIcon;
        
        // --- NEW: DYNAMIC ACTION TOOLTIP (PENJELASAN FUNGSI TOMBOL) ---
        if (actionIcon === '') btnAction.title = "Serang Musuh (Attack)";
        else if (actionIcon === '') btnAction.title = "Cangkul Lahan"; // NEW
        else if (actionIcon === '') btnAction.title = "Lahan Terkunci"; // NEW
        else if (actionIcon === '') btnAction.title = "Tarik Pancingan";
        else if (actionIcon === '') btnAction.title = "Masuk/Keluar";
        else if (actionIcon === '') btnAction.title = "Baca Papan Info";
        else if (actionIcon === '') btnAction.title = "Lihat Peringkat";
        else if (actionIcon === '') btnAction.title = "Bicara dengan NPC";
        else if (actionIcon === '') btnAction.title = "Interaksi Pasangan";
        else if (actionIcon === '') btnAction.title = "Cek Kotak Surat";
        else if (actionIcon === '') btnAction.title = "Baca Tanda";
        else if (actionIcon === '') btnAction.title = "Baca Buku/Arsip";
        else if (actionIcon === '') btnAction.title = "Tidur/Istirahat";
        else if (actionIcon === '') btnAction.title = "Ambil/Sortir Barang";
        else if (actionIcon === '') btnAction.title = "Manajemen Kasir";
        else if (actionIcon === '') btnAction.title = "Belanja Katalog";
        else if (actionIcon === '') btnAction.title = "Ganti Pakaian";
        else if (actionIcon === '') btnAction.title = "Cek Kalender";
        else if (actionIcon === '') btnAction.title = "Save/Jurnal";
        else if (actionIcon === '') btnAction.title = "Ambil Obat";
        else if (actionIcon === '') btnAction.title = "Cek Arsip";
        else if (actionIcon === '') btnAction.title = "Lihat Koleksi";
        else if (actionIcon === '') btnAction.title = "Lihat Equipment";
        else if (actionIcon === '') btnAction.title = "Lihat Makanan";
        else if (actionIcon === '') btnAction.title = "Masak";
        else if (actionIcon === '') btnAction.title = "Masak Sup";
        else if (actionIcon === '') btnAction.title = "Cek Jaring";
        else if (actionIcon === '') btnAction.title = "Cek Ikan";
        else if (actionIcon === '') btnAction.title = "Berdoa";
        else if (actionIcon === '') btnAction.title = "Persembahan";
        else if (actionIcon === '') btnAction.title = "Periksa Lilin";
        else btnAction.title = "Interaksi";
        
        // Animasi pop-in kecil jika baru muncul
        if (btnAction.dataset.visible !== "true") {
            btnAction.style.animation = "popIn 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275)";
            btnAction.dataset.visible = "true";
        }
    } else {
        btnAction.style.display = 'none';
        btnAction.dataset.visible = "false";
    }

    let hours = Math.floor(STATE.time / 100);
    let minutes = Math.floor((STATE.time % 100) * 0.6); 
    let timeString = `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}`;
    
    document.getElementById('clock-display').innerText = timeString;

    let timeLabel = "Malam";
    if(hours >= 4 && hours < 10) timeLabel = "Pagi";
    else if(hours >= 10 && hours < 15) timeLabel = "Siang";
    else if(hours >= 15 && hours < 18) timeLabel = "Sore";
    else if(hours >= 18 || hours < 4) timeLabel = "Malam";
    
    const weatherInd = {
        'clear': 'Cerah', 'rain': 'Hujan', 'snow': 'Salju', 
        'sakura': 'Bunga Gugur', 'fall_leaves': 'Daun Gugur'
    };
    document.getElementById('weather-display').innerText = `${timeLabel}, ${weatherInd[STATE.weather] || 'Cerah'}`;
    
    // --- UPDATE: TAMPILKAN HARI DI UI ---
    document.getElementById('full-date-display').innerText = `${dayName}, D${dayInSeason} ${STATE.season.charAt(0).toUpperCase() + STATE.season.slice(1)} Y${year}`;

    if(STATE.location === 'village' && STATE.time < 1800) {
        
        // UPDATE: Burung sekarang muncul di Spring, Summer, dan Autumn (Kecuali Winter)
        if(STATE.season !== 'winter') {
            if(Math.random() < 0.01) {
                STATE.critters.push({
                    type: 'bird',
                    x: -50, 
                    y: Math.random() * (ISLAND_H * TILE_SIZE) / 2, 
                    vx: 2 + Math.random() * 2, 
                    vy: (Math.random() - 0.5) * 0.5,
                    life: 1000,
                    flap: 0
                });
            }
        }

        // --- NEW: SPAWN SILUET IKAN DI LAUT ---
        // Muncul di semua musim, siang hari
        if (Math.random() < 0.05) { // 5% chance per frame
            // Posisi acak di seluruh map
            const fx = Math.random() * (ISLAND_W * TILE_SIZE);
            const fy = Math.random() * (ISLAND_H * TILE_SIZE);
            
            // Cek apakah posisi tersebut adalah AIR (Tile ID 0)
            const tx = Math.floor(fx / TILE_SIZE);
            const ty = Math.floor(fy / TILE_SIZE);
            const tIdx = ty * ISLAND_W + tx;
            
            // Akses array villageTiles global
            if (villageTiles[tIdx] === 0) { 
                STATE.critters.push({
                    type: 'fish_silhouette',
                    x: fx, 
                    y: fy,
                    vx: (Math.random() - 0.5) * 0.8, // Gerakan pelan & tenang
                    vy: (Math.random() - 0.5) * 0.8,
                    life: 600 + Math.random() * 300, // Hidup lama
                    size: 0.8 + Math.random() * 0.6  // Variasi ukuran
                });
            }
        }

        if(STATE.season === 'autumn') {
            if(Math.random() < 0.02) {
                const cx = STATE.camera.x + Math.random() * GAME_WIDTH;
                const cy = STATE.camera.y + Math.random() * GAME_HEIGHT;
                STATE.critters.push({
                    type: 'butterfly',
                    x: cx,
                    y: cy,
                    vx: 0,
                    vy: 0,
                    life: 400,
                    color: ['#fbbf24', '#f87171', '#60a5fa'][Math.floor(Math.random()*3)] 
                });
            }
        }
    } else {
        if(STATE.time >= 1800) STATE.critters = [];
    }
    
    STATE.critters.forEach((c, i) => {
        c.life--;
        if(c.life <= 0) {
            STATE.critters.splice(i, 1);
            return;
        }

        if(c.type === 'bird') {
            c.x += c.vx;
            c.y += c.vy;
            c.flap += 0.2; 
            if(c.x > (ISLAND_W * TILE_SIZE) + 100) c.life = 0;
        } 
        // --- NEW: UPDATE GERAKAN IKAN ---
        else if (c.type === 'fish_silhouette') {
            c.x += c.vx;
            c.y += c.vy;
            
            // Cek Tile Depan (Agar tidak nabrak daratan)
            const nextTx = Math.floor((c.x + c.vx * 20) / TILE_SIZE);
            const nextTy = Math.floor((c.y + c.vy * 20) / TILE_SIZE);
            const tIdx = nextTy * ISLAND_W + nextTx;
            
            // Jika menabrak daratan (bukan air), putar balik perlahan
            if (villageTiles[tIdx] !== 0) {
                c.vx *= -1;
                c.vy *= -1;
            }
            
            // Ubah arah sedikit secara acak agar natural
            if (Math.random() < 0.01) {
                c.vx += (Math.random() - 0.5) * 0.2;
                c.vy += (Math.random() - 0.5) * 0.2;
            }
        }
        else if(c.type === 'butterfly') {
            c.x += (Math.random() - 0.5) * 2;
            c.y += (Math.random() - 0.5) * 2;
        }
    });

    if (STATE.weather !== 'clear' && STATE.location === 'village') {
        const maxParticles = (STATE.weather === 'rain' || STATE.weather === 'snow') ? 200 : 80;
        
        if(STATE.weatherParticles.length < maxParticles) {
            let pType = STATE.weather;
            let pVx = 0, pVy = 0;
            
            if(pType === 'rain') { pVx = -0.5; pVy = 8 + Math.random()*2; }
            else if(pType === 'snow') { pVx = -0.2 + Math.random()*0.4; pVy = 1 + Math.random(); }
            else if(pType === 'sakura' || pType === 'fall_leaves') { 
                pVx = Math.random() - 0.5; 
                pVy = 0.5 + Math.random(); 
            }

            STATE.weatherParticles.push({
                x: Math.random() * canvas.width, 
                y: -10,
                vx: pVx,
                vy: pVy,
                type: pType,
                swayOffset: Math.random() * 10, 
                life: 300
            });
        }
    }
    
    if(STATE.location !== 'village') STATE.weatherParticles = [];

    STATE.weatherParticles.forEach((p, i) => {
        if (p.type === 'sakura' || p.type === 'fall_leaves') {
            p.x += Math.sin(p.y * 0.02 + p.swayOffset) * 0.5 + (Math.random() - 0.5)*0.2;
            p.y += p.vy;
        } else {
            p.x += p.vx; 
            p.y += p.vy;
        }

        if(p.y > canvas.height) { 
            p.y = -10; 
            p.x = Math.random() * canvas.width; 
        }
    });

    let dx = 0, dy = 0;
    
    // --- UPDATE: MOVEMENT LOGIC (KEYBOARD + TOUCH HYBRID) ---
    if (!STATE.fishing.active && !STATE.minigame) {
        
        // 1. Cek Keyboard (WASD / Arrows)
        if (keys['ArrowUp'] || keys['KeyW']) dy = -1;
        if (keys['ArrowDown'] || keys['KeyS']) dy = 1;
        if (keys['ArrowLeft'] || keys['KeyA']) dx = -1;
        if (keys['ArrowRight'] || keys['KeyD']) dx = 1;

        // 2. Cek Touchscreen (Jika Keyboard tidak ditekan, atau mau digabung)
        if (dx === 0 && dy === 0 && inputState.active) {
            dx = inputState.x;
            dy = inputState.y;
            
            // Threshold kecil agar karakter benar-benar berhenti (Deadzone)
            if (Math.abs(dx) < 0.1) dx = 0;
            if (Math.abs(dy) < 0.1) dy = 0;
        }
    }

    // Normalisasi vektor hanya jika input dari keyboard (karena touch input sudah cos/sin)
    // Jika dx/dy adalah 1/-1 (keyboard), normalisasi. Jika desimal (touch), biarkan (agar kecepatan analog)
    if ((Math.abs(dx) === 1 || Math.abs(dy) === 1) && !inputState.active) { 
        if (dx!==0 && dy!==0) { dx*=0.707; dy*=0.707; }
    }
    
    // --- NEW: LOGIKA SPRINT (KECEPATAN) ---
    let currentSpeed = STATE.player.speed;
    
    if (STATE.player.isSprinting) {
        currentSpeed *= 1.8; // Kecepatan meningkat 1.8x
        
        // Efek visual: Partikel debu saat lari (hanya jika bergerak)
        if ((dx !== 0 || dy !== 0)) {
            // Chance spawn lebih sering (30%) untuk efek jejak yang mulus
            if (Math.random() < 0.3) {
                STATE.particles.push({
                    x: STATE.player.x + 10 + (Math.random() * 14 - 7), // Random di sekitar kaki
                    y: STATE.player.y + 20, // Tepat di bawah kaki
                    vx: (Math.random() - 0.5) * 1, // Menyebar kiri-kanan pelan
                    vy: (Math.random() * -0.5) - 0.2, // Naik sedikit (menguap)
                    life: 20 + Math.random() * 10, // Umur variatif
                    color: '#e5e7eb', // Abu-abu muda (Debu/Asap)
                    type: 'dust', // Tipe khusus
                    size: 3 + Math.random() * 3 // Ukuran acak
                });
            }
        }
    }

    // --- NEW: SISTEM KELELAHAN BERJALAN (Walking Fatigue) ---
    // Jika pemain bergerak
    if (dx !== 0 || dy !== 0) {
        // Tambahkan counter langkah
        // UPDATE: Jika Sprint, langkah dihitung lebih cepat (lebih cepat lelah sedikit)
        const stepCost = STATE.player.isSprinting ? 2 : 1;
        STATE.player.stepsTaken = (STATE.player.stepsTaken || 0) + stepCost;
        
        // Setiap 300 frame gerakan (sekitar 5 detik jalan terus menerus), kurangi 1 Energi
        if (STATE.player.stepsTaken > 300) {
            if (STATE.player.energy > 0) {
                STATE.player.energy = Math.max(0, STATE.player.energy - 1);
                
                // Visual Feedback kecil agar pemain sadar
                spawnFloatingText(STATE.player.x, STATE.player.y - 20, "-1 ", "#facc15", 10);
                
                // Peringatan jika energi kritis karena jalan
                if (STATE.player.energy === 20) {
                    showToast(" Capek banget... butuh makan/istirahat!");
                }
            }
            STATE.player.stepsTaken = 0; // Reset counter
        }
    }

    const nextX = STATE.player.x + dx * currentSpeed; // UPDATE: Gunakan currentSpeed
    const nextY = STATE.player.y + dy * currentSpeed; // UPDATE: Gunakan currentSpeed

    // --- CHECK ALL COLLISIONS ---
    const wallX = checkWall(nextX, STATE.player.y);
    const wallY = checkWall(STATE.player.x, nextY);
    
    // --- UPDATE: Collision Logic diperbaiki di dalam fungsi checkNPCCollision ---
    const npcX = checkNPCCollision(nextX, STATE.player.y);
    const npcY = checkNPCCollision(STATE.player.x, nextY);

    const objX = checkObjectCollision(nextX, STATE.player.y);
    const objY = checkObjectCollision(STATE.player.x, nextY);
    
    const bldX = checkBuildingCollision(nextX, STATE.player.y);
    const bldY = checkBuildingCollision(STATE.player.x, nextY);

    // --- NEW: MONSTER WALL COLLISION CHECK ---
    const monX = checkEnemyWall(nextX, STATE.player.y);
    const monY = checkEnemyWall(STATE.player.x, nextY);

    if (!wallX && !npcX && !objX && !bldX && !monX) STATE.player.x = nextX;
    if (!wallY && !npcY && !objY && !bldY && !monY) STATE.player.y = nextY;

    // PERBAIKAN: Update Direction untuk 4 Arah (Atas/Bawah/Kiri/Kanan)
    // Sebelumnya hanya Kiri/Kanan, sehingga interaksi Atas/Bawah sering gagal
    if (dx !== 0 || dy !== 0) {
        if (Math.abs(dx) >= Math.abs(dy)) {
            STATE.player.direction = dx > 0 ? 'right' : 'left';
        } else {
            STATE.player.direction = dy > 0 ? 'down' : 'up';
        }
    }

    const hitObj = objX || objY;
    if (hitObj && Date.now() - lastCollisionTime > 1500) {
        lastCollisionTime = Date.now();
        if (hitObj.type === 'sign') {
             showToast(" " + hitObj.text);
        } else if (hitObj.type === 'fishing_spot') {
             showToast(" Area Memancing (Tekan Tombol Aksi)");
        } else if (hitObj.type === 'counter') {
             showToast("Meja Kasir. Bicara pada Bos untuk kerja.");
        }
    }

    STATE.camera.x = STATE.player.x - GAME_WIDTH/2 + STATE.player.w/2;
    STATE.camera.y = STATE.player.y - GAME_HEIGHT/2 + STATE.player.h/2;
    
    const curMap = maps[STATE.location];
    STATE.camera.x = Math.max(0, Math.min(STATE.camera.x, curMap.w*TILE_SIZE - GAME_WIDTH));
    STATE.camera.y = Math.max(0, Math.min(STATE.camera.y, curMap.h*TILE_SIZE - GAME_HEIGHT));

    curMap.npcs.forEach(npc => {
        const distToPlayer = Math.hypot(STATE.player.x - npc.x*TILE_SIZE, STATE.player.y - npc.y*TILE_SIZE);
        
        // --- NEW: EFEK NYANYIAN (BUBBLE NADA) UNTUK DUYUNG, SENIMAN & PENYANYI ---
        // UPDATE: Ditambahkan 'penyanyi'
        if((npc.id === 'putriduyung' || npc.id === 'seniman' || npc.id === 'penyanyi') && isNPCActive(npc)) {
            // Peluang spawn nada setiap frame (biar tidak terlalu spam)
            if(Math.random() < 0.05) { 
                let pColor = '#38bdf8'; // Default Biru (Duyung)
                if (npc.id === 'seniman') pColor = '#fbbf24'; // Emas (Gitar)
                else if (npc.id === 'penyanyi') pColor = '#e879f9'; // Pink/Ungu (Penyanyi)

                STATE.particles.push({
                    x: (npc.x * TILE_SIZE) + 15 + (Math.random() * 20 - 10), // Random offset X
                    y: (npc.y * TILE_SIZE) - 10,
                    vx: (Math.random() - 0.5) * 0.5, // Goyang kiri kanan pelan
                    vy: -0.5 - Math.random(), // Naik ke atas
                    life: 80, // Durasi hidup
                    color: pColor,
                    type: 'note', // Tipe khusus untuk render ikon
                    icon: ['', '', '', ''][Math.floor(Math.random()*4)],
                    size: 10 + Math.random() * 5
                });
            }
        }

        // --- FIX: KEMBALIKAN EFEK NGOBROL AISYAH & MARIA (BERGANTIAN) ---
        // Logika: Mereka akan spawning bubble "..." bergantian setiap 3 detik
        if((npc.id === 'cewek_islam' || npc.id === 'cewek_kristen') && isNPCActive(npc)) {
            const turnDuration = 3000; // 3 detik per giliran
            const now = Date.now();
            const isAisyahTurn = (Math.floor(now / turnDuration) % 2 === 0);
            
            // Cek giliran siapa sekarang
            const myTurn = (npc.id === 'cewek_islam' && isAisyahTurn) || (npc.id === 'cewek_kristen' && !isAisyahTurn);

            // Spawn bubble jika giliran saya (Peluang 3% per frame agar tidak terlalu rapat)
            if(myTurn && Math.random() < 0.03) { 
                STATE.particles.push({
                    x: (npc.x * TILE_SIZE) + 20, // Posisi tengah atas kepala
                    y: (npc.y * TILE_SIZE) - 10,
                    vx: 0,
                    vy: -0.2, // Naik pelan
                    life: 70, // Durasi tampil (sekitar 1.2 detik)
                    type: 'chat_bubble', 
                    icon: '...' 
                });
            }
        }

        if(npc.type === 'wander' || npc.type === 'animal' || npc.type === 'swimmer') {
            if (distToPlayer < 60 && npc.type !== 'swimmer') { // Swimmer cuek, gak berhenti kalau didekati (kecuali diajak ngobrol)
                if(npc.type === 'animal') {
                    if(npc.cooldown <= 0 && distToPlayer < 40) {
                        npc.cooldown = 120;
                        npc.loveTimer = 60; 
                        
                        if(AudioService.enabled && AudioService.tracks[npc.sound]) {
                            AudioService.tracks[npc.sound].currentTime = 0;
                            AudioService.tracks[npc.sound].play().catch(()=>{});
                        }
                        
                        createParticle(npc.x*TILE_SIZE, npc.y*TILE_SIZE, '#ff69b4');
                    }
                }

            } else {
                if(Math.random() < 0.02) { 
                    npc.vx = (Math.random() - 0.5) * 2;
                    npc.vy = (Math.random() - 0.5) * 2;
                }
                
                // Khusus Swimmer gerakannya lebih konsisten (berenang)
                if (npc.type === 'swimmer') {
                    // Random turn sesekali
                    if(Math.random() < 0.01) {
                        npc.vx = (Math.random() - 0.5) * 1.5;
                        npc.vy = (Math.random() - 0.5) * 1.5;
                    }

                    // NEW: EFEK CIPRATAN AIR SAAT BERGERAK
                    if (Math.abs(npc.vx) > 0.1 || Math.abs(npc.vy) > 0.1) {
                        // 30% Chance spawn partikel per frame
                        if(Math.random() < 0.3) {
                            STATE.particles.push({
                                x: (npc.x * TILE_SIZE) + 15 + (Math.random() * 14 - 7), // Sekitar badan
                                y: (npc.y * TILE_SIZE) + 40, // Di permukaan air (kaki)
                                vx: (Math.random() - 0.5) * 2, // Menyebar ke samping
                                vy: -1.5 - Math.random(), // Melompat ke atas
                                life: 25, // Durasi
                                color: '#e0f2fe', // Putih kebiruan (buih air)
                                type: 'splash',
                                size: 2 + Math.random() * 3
                            });
                        }
                    }
                }

                let nx = (npc.x * TILE_SIZE) + (npc.vx || 0);
                let ny = (npc.y * TILE_SIZE) + (npc.vy || 0);
                
                // --- FIX: Logic Pengecekan Batas Map & Collision NPC ---
                
                if (npc.type === 'swimmer') {
                    // LOGIKA PERENANG: Hanya boleh di Tile 0 (Air)
                    // Cek titik tengah kaki
                    const tX = Math.floor((nx + 15) / TILE_SIZE);
                    const tY = Math.floor((ny + 30) / TILE_SIZE); 
                    
                    let canSwim = false;
                    
                    // Pastikan di dalam map
                    if(tX >= 0 && tX < curMap.w && tY >= 0 && tY < curMap.h) {
                        const tIdx = tY * curMap.w + tX;
                        const tile = curMap.tiles[tIdx];
                        
                        // Hanya boleh di air (0)
                        if (tile === 0) canSwim = true;
                    }

                    if (canSwim) {
                        npc.x = nx / TILE_SIZE;
                        npc.y = ny / TILE_SIZE;
                    } else {
                        // Nabrak darat/batas map, putar balik
                        npc.vx *= -1;
                        npc.vy *= -1;
                    }
                } else {
                    // LOGIKA NPC DARAT (Wander & ANIMAL): JANGAN LEWAT LAUT
                    // FIX: Gunakan ukuran dinamis NPC (w/h) untuk akurasi hitbox
                    const pW = npc.w || 32;
                    const pH = npc.h || 48;
                    const centerX = nx + (pW / 2);
                    const bottomY = ny + pH - 5; // Cek tepat di kaki

                    const tX = Math.floor(centerX / TILE_SIZE); 
                    const tY = Math.floor(bottomY / TILE_SIZE);
                    const tIdx = tY * curMap.w + tX;
                    
                    let isWalkable = true;

                    // 1. Cek Batas Map (Penting agar tidak keluar dunia ke area hitam)
                    if (nx < 0 || ny < 0 || nx > (curMap.w * TILE_SIZE) - pW || ny > (curMap.h * TILE_SIZE) - pH) {
                        isWalkable = false;
                    }
                    // 2. Cek Tile
                    else if (tIdx >= 0 && tIdx < curMap.tiles.length) {
                        const tile = curMap.tiles[tIdx];
                        
                        // Cek Laut (Tile 0) -> BLOKIR HEWAN & MANUSIA DARAT
                        if (tile === 0) {
                            isWalkable = false;
                            // FIX SAPI EROR: Izinkan Hewan Masuk Area Dermaga juga
                            // Hapus syarat '&& npc.type !== 'animal'' agar sapi tidak stuck di perbatasan laut dermaga
                            if (STATE.location === 'village') {
                                if (tX >= 43 && tX < 50 && tY >= 34 && tY < 39) {
                                    isWalkable = true;
                                }
                            }
                        }
                        
                        // Cek Tembok/Pohon (Tile 2, 11, 12)
                        if (tile === 2 || tile === 11 || tile === 12) {
                            isWalkable = false;
                        }
                    } else {
                        // Index di luar array tiles
                        isWalkable = false;
                    }

                    if (isWalkable) {
                        npc.x = nx / TILE_SIZE;
                        npc.y = ny / TILE_SIZE;
                    } else {
                        // Nabrak Laut/Tembok -> Putar Balik
                        npc.vx *= -1;
                        npc.vy *= -1;
                        
                        // FIX: SOLUSI ANTI-STUCK SMART (DORONG KE TENGAH)
                        // Jika NPC menabrak batas laut/tembok, paksa jalan ke arah tengah desa
                        // Ini mencegah mereka terjebak di pinggiran pantai/dermaga selamanya
                        if(Math.random() < 0.6) { // Peluang 60% untuk lari ke tengah saat stuck
                             const centerX = 30 * TILE_SIZE; // Tengah Peta X
                             const centerY = 20 * TILE_SIZE; // Tengah Peta Y
                             
                             // Hitung arah ke tengah
                             const dx = centerX - (npc.x * TILE_SIZE);
                             const dy = centerY - (npc.y * TILE_SIZE);
                             const mag = Math.hypot(dx, dy) || 1;
                             
                             // Beri kecepatan sedikit acak agar natural
                             const speed = 1 + Math.random(); 
                             
                             npc.vx = (dx / mag) * speed;
                             npc.vy = (dy / mag) * speed;
                        } else {
                             // Sisa 40%: Random arah biasa (biar gak semua NPC lari ke tengah barengan)
                             npc.vx = (Math.random() - 0.5) * 2;
                             npc.vy = (Math.random() - 0.5) * 2;
                        }
                    }
                }
            }
            
            if(npc.cooldown > 0) npc.cooldown--;
            if(npc.loveTimer > 0) npc.loveTimer--;
        }
    });

    // --- NEW: AUTO TELEPORT CHECK (Agar tidak perlu klik tombol) ---
    checkAutoTeleport();
    
    // --- NEW: CEK JAM OPERASIONAL BANGUNAN (KICK OUT SYSTEM) ---
    checkBuildingHours();

    const tx = Math.floor(STATE.player.x / TILE_SIZE);
    const ty = Math.floor(STATE.player.y / TILE_SIZE);
    const tIdx = ty * curMap.w + tx;
    
    const tile = curMap.tiles[tIdx];
    
    if(tile === 8 && STATE.location === 'merchant_interior') {
    }
    else if(tile === 8 && STATE.location === 'house') {
    }

    if(STATE.location === 'dungeon') {
        updateEnemies();
    }
    
    if(STATE.fishing.active) {
        STATE.fishing.barX += 2 * STATE.fishing.barDir; 
        // FIX: Clamping nilai agar tidak stuck (bergetar) di ujung bar
        if(STATE.fishing.barX >= 100) {
            STATE.fishing.barX = 100;
            STATE.fishing.barDir = -1;
        } else if(STATE.fishing.barX <= 0) {
            STATE.fishing.barX = 0;
            STATE.fishing.barDir = 1;
        }
    }

    if (STATE.player.attackCooldown > 0) STATE.player.attackCooldown--;
    // Removed STATE.player.skillCooldown decrement logic
    
    // NEW: UPDATE COMBO TIMER
    if (STATE.player.comboWindow > 0) {
        STATE.player.comboWindow--;
        if (STATE.player.comboWindow <= 0) {
            STATE.player.comboCount = 0; // Reset combo jika telat tekan tombol
        }
    }

    // NEW: UPDATE FLOATING TEXTS
    STATE.floatingTexts.forEach((ft, i) => {
        ft.y -= 0.5; // Naik ke atas
        ft.life--;
        if(ft.life <= 0) STATE.floatingTexts.splice(i, 1);
    });
    
    // UPDATE HUD VIA FUNCTION NOW
    updateHUDInfo();

    STATE.particles.forEach((p,i) => {
        p.x += p.vx; p.y += p.vy; p.life--;
        if(p.life<=0) STATE.particles.splice(i,1);
    });

    if(STATE.weather === 'rain' && STATE.location === 'village') {
        if(Math.random() < 0.005) {
            STATE.lightningTimer = 15; 
            STATE.shakeTimer = 20;     
            STATE.lightningX = Math.random() * GAME_WIDTH; 
        }
    }
    
    if(STATE.lightningTimer > 0) STATE.lightningTimer--;
    if(STATE.shakeTimer > 0) STATE.shakeTimer--;
    
    // NEW: Kurangi cooldown teleport setiap frame
    if(STATE.teleportCooldown > 0) STATE.teleportCooldown--;

    // --- NEW: UPDATE PERGERAKAN BOT HANTU (AGAR TERLIHAT HIDUP) ---
    if (STATE.ghosts) {
        STATE.ghosts.forEach(g => {
            // Hanya gerakkan jika dia adalah Bot dan berada di map yang sama
            if (g.isBot && g.location === STATE.location) {
                // Randomly change direction (Wander Behavior)
                if (Math.random() < 0.02) { // 2% chance per frame
                    g.vx = (Math.random() - 0.5) * 2; // Kecepatan random
                    g.vy = (Math.random() - 0.5) * 2;
                }
                
                // Update Posisi
                g.x = (g.x || 0) + (g.vx || 0);
                g.y = (g.y || 0) + (g.vy || 0);
                
                // Batas Map Sederhana (Agar tidak lari ke laut/luar layar)
                // Asumsi batas aman desa (Area tengah)
                const minX = 5 * TILE_SIZE;
                const maxX = 55 * TILE_SIZE;
                const minY = 5 * TILE_SIZE;
                const maxY = 35 * TILE_SIZE;

                if (g.x < minX || g.x > maxX) g.vx *= -1; // Pantul tembok
                if (g.y < minY || g.y > maxY) g.vy *= -1;
            }
        });
    }
}

// --- NEW FUNCTION: CHECK AUTO TELEPORT ---
function checkAutoTeleport() {
    // Jika sedang cooldown, jangan cek teleport (Mencegah loop masuk-keluar)
    if (STATE.teleportCooldown > 0) return;

    const map = maps[STATE.location];
    if (!map.buildings) return;

    // Titik tengah pemain
    const pCenterX = STATE.player.x + (STATE.player.w / 2);
    const pCenterY = STATE.player.y + (STATE.player.h / 2);

    for (let b of map.buildings) {
        if(b.entrance) {
            // Titik tengah entrance (Pintu)
            const eCenterX = (b.entrance.x * TILE_SIZE) + (TILE_SIZE / 2);
            const eCenterY = (b.entrance.y * TILE_SIZE) + (TILE_SIZE / 2);
            
            // Jarak pemain ke titik tengah pintu
            const dist = Math.hypot(pCenterX - eCenterX, pCenterY - eCenterY);
            
            // --- PERBAIKAN: Radius Diperbesar agar Auto-Exit konsisten ---
            // Sebelumnya 25 (terlalu sempit, sulit dipicu). Diubah ke 50 (hampir 2 tile).
            if(dist < 50) {
                
                // --- PERUBAHAN 2: Daftar Otomatis Hanya untuk KELUAR ---
                // Saya telah MENGHAPUS bangunan masuk (seperti 'player_house', 'merchant', dll) dari sini.
                // Jadi saat mau MASUK, fungsi ini tidak akan jalan (tombol aksi akan muncul gantinya).
                const autoTeleporters = [
                    // HANYA DAFTAR PINTU KELUAR (EXIT)
                    'house_exit', 'pshop_exit',
                    'dungeon_exit', 'dungeon_next', // Next level dungeon tetap auto biar smooth
                    'shop_exit', 
                    'library_exit', 
                    'guild_exit', 
                    'school_exit',
                    'smith_exit',
                    'mentor_exit',
                    'clinic_exit',
                    'wedding_exit',
                    'lover1_exit', 
                    'fisherman_exit',
                    'candi_exit',
                    'ruins_exit',
					'warnet_exit' // <--- TAMBAHKAN INI
                ];
                
                if (autoTeleporters.includes(b.id)) {
                    processTeleport(b);
                    return; // Stop checking agar tidak double trigger
                }
            }
        }
    }
}

// --- NEW FUNCTION: CHECK BUILDING HOURS (PENGUSIRAN OTOMATIS) ---
function checkBuildingHours() {
    // 1. Filter: Hanya jalankan jika Player berada di Indoor (Bukan Village, House, atau Dungeon)
    // List lokasi aman (tidak ada jam tutup):
    if (STATE.location === 'village' || STATE.location === 'house' || STATE.location === 'dungeon' || STATE.location === 'ruins_battle') return;

    const villageMap = maps['village'];
    if(!villageMap) return;

    // 2. Cari data bangunan berdasarkan lokasi map saat ini
    // Contoh: Jika di 'library_interior', cari bangunan yang punya entrance.map == 'library_interior'
    const building = villageMap.buildings.find(b => b.entrance && b.entrance.map === STATE.location);

    if (building) {
        // Cek apakah bangunan memiliki jam tutup dan tidak buka 24 jam
        if (!building.open24h && building.openTime && building.closeTime) {
            
            // 3. Logika Waktu: Jika Sekarang >= Jam Tutup ATAU Sekarang < Jam Buka (Kasus begadang)
            if (STATE.time >= building.closeTime || STATE.time < building.openTime) {
                // ... (Logic pengusiran) ...
                
                // Play SFX Pintu/Alert
                if(typeof AudioService !== 'undefined') AudioService.playSFX('door');
                
                // Format Jam untuk Info (Misal: 800 -> "08:00")
                const openStr = Math.floor(building.openTime/100).toString().padStart(2,'0') + ":00";
                const closeStr = Math.floor(building.closeTime/100).toString().padStart(2,'0') + ":00";

                // Tampilkan Notifikasi dengan Jam Operasional
                showToast(` ${building.name.toUpperCase()} TUTUP! (Buka ${openStr} - ${closeStr}). Kamu diminta keluar.`);

                // 4. Teleport Paksa ke Luar (Village)
                STATE.location = 'village';
                
                // Koordinat tujuan: Tepat di depan pintu masuk bangunan (Entrance Y + 1)
                // Agar pemain muncul di depan pintu, bukan di dalamnya
                STATE.player.x = building.entrance.x * TILE_SIZE;
                STATE.player.y = (building.entrance.y + 1) * TILE_SIZE;
                
                // Pastikan area spawn bersih dari NPC yang menghalangi
                clearSpawnZone('village', building.entrance.x, building.entrance.y + 1);
                
                // Set cooldown teleport agar tidak glitch masuk lagi
                STATE.teleportCooldown = 60;

                // --- NEW: EFEK VISUAL KEBINGUNGAN SAAT DIUSIR ---
                spawnFloatingText(STATE.player.x + 5, STATE.player.y - 40, "", "#fbbf24", 16); 
                spawnFloatingText(STATE.player.x + 20, STATE.player.y - 25, "", "#fff", 18);   
            }
        }
    }
}

// --- NEW FUNCTION: PROCESS TELEPORT (Centralized Logic) ---
function processTeleport(b) {
    // SET COOLDOWN SETELAH TELEPORT SUKSES
    STATE.teleportCooldown = 60;

    // --- NEW: PLAY DOOR SFX ---
    if(typeof AudioService !== 'undefined') AudioService.playSFX('door');

    // 3. Eksekusi Teleportasi (LOGIKA LENGKAP DIKEMBALIKAN)
    
    // --- RUMAH PLAYER / TOKO PLAYER ---
    if(b.id === 'player_house') {
        // Cek Role: Jika Entrepreneur, masuk ke Toko Player
        if (STATE.player.role === 'entrepreneur') {
            STATE.location = 'player_shop_interior';
            STATE.player.x = 7 * TILE_SIZE;
            /* FIX: Geser Y lebih dalam (ke 9) agar jauh dari pintu (11) */
            STATE.player.y = 9 * TILE_SIZE; 
            showToast("Masuk Toko Sendiri ");
        } else {
            // Role lain masuk rumah biasa
            STATE.location = 'house';
            const hMap = maps['house'];
            const doorX = Math.floor(hMap.w / 2);
            /* FIX: Geser Y lebih dalam (h-3) agar tidak langsung keluar */
            const doorY = hMap.h - 3; 
            STATE.player.x = doorX * TILE_SIZE;
            STATE.player.y = doorY * TILE_SIZE;
            showToast("Masuk Rumah ");
        }
    } 
    else if(b.id === 'house_exit' || b.id === 'pshop_exit') {
        // ... (Logika keluar rumah tetap sama) ...
        if (STATE.isPrologue && !STATE.tutorialIndoorComplete) {
            if(typeof AudioService !== 'undefined') AudioService.playSFX('hit');
            showDialogue("TUTORIAL BELUM SELESAI", 
                " Eitss... Jangan keluar dulu!\n\nSelesaikan langkah-langkah tutorial di dalam rumah agar kamu paham cara bermain.\n\nIkuti petunjuk tangan .", 
                [{text:"Baiklah", action:closeDialogue}], 
                'images/mentor.png'
            );
            return;
        }

        STATE.location = 'village';
        STATE.player.x = 21 * TILE_SIZE; 
        STATE.player.y = 12 * TILE_SIZE; 
        clearSpawnZone('village', 21, 12);
        showToast("Keluar");
        
        // Event Mentor Hari 1
        if (STATE.day === 1 && STATE.player.role === 'none') {
            const villMap = maps['village'];
            const mentor = villMap.npcs.find(n => n.id === 'mentor');
            if (mentor) {
                mentor.x = 21; mentor.y = 14; mentor.vx = 0; mentor.vy = 0;
                setTimeout(() => { STATE.player.direction = 'down'; runTutorial(); }, 600);
            }
        }
    }

    // --- MERCHANT ---
    else if(b.id === 'merchant') {
        STATE.location = 'merchant_interior';
        STATE.player.x = 7 * TILE_SIZE; 
        /* FIX: Geser Y ke 9 */
        STATE.player.y = 9 * TILE_SIZE; 
        showToast("Masuk Merchant ");
    }
    else if(b.id === 'shop_exit') {
        STATE.location = 'village';
        STATE.player.x = 29 * TILE_SIZE; 
        STATE.player.y = 28 * TILE_SIZE; 
        clearSpawnZone('village', 29, 28);
        showToast("Keluar Merchant");
    }

    // --- KLINIK ---
    else if(b.id === 'clinic') {
        STATE.location = 'clinic_interior';
        STATE.player.x = 7 * TILE_SIZE; 
        /* FIX: Geser Y ke 9 */
        STATE.player.y = 9 * TILE_SIZE; 
        showToast("Masuk Klinik ");
    }
    else if(b.id === 'clinic_exit') {
        STATE.location = 'village';
        STATE.player.x = 20 * TILE_SIZE; 
        STATE.player.y = 19 * TILE_SIZE; 
        clearSpawnZone('village', 20, 19);
        showToast("Keluar Klinik");
    }

    // --- BLACKSMITH ---
    else if(b.id === 'blacksmith') {
        STATE.location = 'blacksmith_interior';
        STATE.player.x = 7 * TILE_SIZE; 
        /* FIX: Geser Y ke 9 */
        STATE.player.y = 9 * TILE_SIZE; 
        showToast("Masuk Bengkel ");
    }
    else if(b.id === 'smith_exit') {
        STATE.location = 'village';
        STATE.player.x = 37 * TILE_SIZE; 
        STATE.player.y = 32 * TILE_SIZE; 
        clearSpawnZone('village', 37, 32);
        showToast("Keluar Bengkel");
    }

    // --- RUMAH MENTOR ---
    else if(b.id === 'mentor') {
        STATE.location = 'mentor_interior';
        STATE.player.x = 7 * TILE_SIZE; 
        /* FIX: Geser Y ke 9 */
        STATE.player.y = 9 * TILE_SIZE;
        showToast("Bertamu ke Rumah Mentor ");
    }
    else if(b.id === 'mentor_exit') {
        STATE.location = 'village';
        STATE.player.x = 31 * TILE_SIZE; 
        STATE.player.y = 21 * TILE_SIZE;
        clearSpawnZone('village', 31, 21);
        showToast("Keluar Rumah Mentor");
    }

    // --- PERPUSTAKAAN ---
    else if(b.id === 'library') {
        STATE.location = 'library_interior';
        STATE.player.x = 7 * TILE_SIZE; 
        /* FIX: Geser Y ke 9 */
        STATE.player.y = 9 * TILE_SIZE;
        showToast("Masuk Perpustakaan ");
    }
    else if(b.id === 'library_exit') {
        STATE.location = 'village';
        STATE.player.x = 41 * TILE_SIZE; 
        STATE.player.y = 24 * TILE_SIZE; 
        clearSpawnZone('village', 41, 24);
        showToast("Keluar Perpustakaan");
    }

    // --- GUILD PETUALANG ---
    else if(b.id === 'guild') {
        STATE.location = 'guild_interior';
        STATE.player.x = 8 * TILE_SIZE; 
        /* FIX: Geser Y ke 11 (Pintu di 13) */
        STATE.player.y = 11 * TILE_SIZE;
        showToast("Masuk Guild Petualang ");
    }
    else if(b.id === 'guild_exit') {
        STATE.location = 'village';
        STATE.player.x = 45 * TILE_SIZE; 
        STATE.player.y = 32 * TILE_SIZE; 
        clearSpawnZone('village', 45, 32);
        showToast("Keluar Guild");
    }

    // --- KAMPUS ---
    else if(b.id === 'school') {
        const dayIndex = (STATE.day - 1) % 7; 
        if (dayIndex === 5 || dayIndex === 6) {
            showDialogue("SATPAM KAMPUS", " KAMPUS LIBUR! \nHari Sabtu dan Minggu tidak ada perkuliahan.", [{text: "Baik Pak", action: closeDialogue}]);
            return; 
        }
        if (STATE.time > 830 && STATE.time < 1400) {
            showDialogue("SATPAM KAMPUS", " STOP! Kamu terlambat! \nKuliah sudah dimulai. Pintu dikunci.", [{text: "Pulang dengan Malu", action: closeDialogue}]);
            return; 
        }

        STATE.location = 'school_interior';
        STATE.player.x = 8 * TILE_SIZE; 
        /* FIX: Geser Y ke 11 (Pintu di 13) */
        STATE.player.y = 11 * TILE_SIZE;
        
        if(STATE.time >= 1400) showToast("Kampus Sore (Bebas)");
        else showToast("Masuk Kampus ");
    }
    else if(b.id === 'school_exit') {
        STATE.location = 'village';
        STATE.player.x = 41 * TILE_SIZE; 
        STATE.player.y = 16 * TILE_SIZE; 
        clearSpawnZone('village', 41, 16);
        showToast("Keluar Kampus");
    }

    // --- RUMAH AYU ---
    else if(b.id === 'lover1_home') {
        STATE.location = 'lover1_interior';
        STATE.player.x = 7 * TILE_SIZE; 
        /* FIX: Geser Y ke 9 */
        STATE.player.y = 9 * TILE_SIZE;
        showToast("Bertamu ke Rumah Ayu ");
    }
    else if(b.id === 'lover1_exit') {
        STATE.location = 'village';
        STATE.player.x = 17 * TILE_SIZE; 
        STATE.player.y = 30 * TILE_SIZE; 
        clearSpawnZone('village', 17, 30);
        showToast("Keluar Rumah Ayu");
    }
    
    // --- RUMAH NELAYAN ---
    else if(b.id === 'fisherman_home') {
        STATE.location = 'fisherman_interior';
        STATE.player.x = 6 * TILE_SIZE; 
        /* FIX: Geser Y ke 7 (Pintu di 9) */
        STATE.player.y = 7 * TILE_SIZE;
        showToast("Bertamu ke Tetangga (Nelayan) ");
    }
    else if(b.id === 'fisherman_exit') {
        STATE.location = 'village';
        STATE.player.x = 28 * TILE_SIZE; 
        STATE.player.y = 11 * TILE_SIZE; 
        clearSpawnZone('village', 28, 11);
        showToast("Keluar Rumah Nelayan");
    }

    // --- CANDI KUNO ---
    else if(b.id === 'candi') {
        STATE.location = 'candi_interior';
        STATE.player.x = 7 * TILE_SIZE; 
        /* FIX: Geser Y ke 13 (Pintu di 15) */
        STATE.player.y = 13 * TILE_SIZE;
        showToast("Masuk Candi Kuno ");
    }
    else if(b.id === 'candi_exit') {
        STATE.location = 'village';
        STATE.player.x = 51 * TILE_SIZE; 
        STATE.player.y = 11 * TILE_SIZE;
        clearSpawnZone('village', 51, 11);
        showToast("Keluar Candi");
    }

    // --- BALAI PERNIKAHAN ---
    else if(b.id === 'wedding') {
        STATE.location = 'wedding_interior';
        STATE.player.x = 7 * TILE_SIZE; 
        /* FIX: Geser Y ke 11 (Pintu di 13) */
        STATE.player.y = 11 * TILE_SIZE;
        showToast("Masuk Balai Pernikahan ");
    }
    else if(b.id === 'wedding_exit') {
        STATE.location = 'village';
        STATE.player.x = 23 * TILE_SIZE; 
        STATE.player.y = 27 * TILE_SIZE; 
        clearSpawnZone('village', 23, 27);
        showToast("Keluar Balai");
    }
	
	// --- WARNET (FIX MASALAH UTAMA) ---
    else if(b.id === 'warnet') {
        STATE.location = 'warnet_interior';
        STATE.player.x = 7 * TILE_SIZE; 
        /* FIX: Geser Y ke 9 (Pintu di 11) - Maju 2 Langkah agar tidak langsung keluar */
        STATE.player.y = 9 * TILE_SIZE;
        showToast("Masuk Warnet ");
    }
    else if(b.id === 'warnet_exit') {
        STATE.location = 'village';
        STATE.player.x = 10 * TILE_SIZE; 
        STATE.player.y = 20 * TILE_SIZE;
        clearSpawnZone('village', 10, 20);
        showToast("Keluar Warnet");
    }

    // --- DUNGEON ---
    else if(b.id === 'dungeon_gate') {
        STATE.dungeonLevel = 1; 
        STATE.location = 'dungeon';
        STATE.player.x = TILE_SIZE * 5; 
        STATE.player.y = TILE_SIZE * 5;
        
        showToast(` WARPING TO LEVEL ${STATE.dungeonLevel}...`);
        createParticle(STATE.player.x, STATE.player.y, '#06b6d4');
        spawnEnemies(); 

        if (!STATE.player.hasSeenDungeonTutorial) {
            STATE.player.hasSeenDungeonTutorial = true;
            setTimeout(() => {
                showTutorialFocus('btn-action'); 
                showDialogue("TUTORIAL COMBAT (1/2)", 
                    " **ZONA BERBAHAYA!**\nTombol aksi berubah jadi **PEDANG** .\n\nTekan cepat 3x untuk **COMBO SERANGAN**!", 
                    [{
                        text: "Lanjut ke Skill >>", 
                        action: () => { 
                            showTutorialFocus('btn-skill'); 
                            showDialogue("TUTORIAL SKILL (2/2)", 
                                " **ULTIMATE SKILL**:\nTombol Api ini untuk **LEDAKAN AREA**!\n\nEfek: Damage Besar + Musuh Terlempar.\nSyarat: **10 Energi**.\nCooldown: 3 Detik.\n\nGunakan saat dikepung banyak musuh!", 
                                [{
                                    text: "Siap Bertarung!", 
                                    action: () => { 
                                        clearTutorialFocus(); 
                                        closeDialogue(); 
                                        manualSave(); 
                                    }
                                }], 
                                'images/penjagadungeon.png'
                            );
                        }
                    }], 
                    'images/penjagadungeon.png'
                );
            }, 1000);
        }
    }
    else if(b.id === 'dungeon_exit') {
        STATE.location = 'village';
        STATE.player.x = 48 * TILE_SIZE; 
        STATE.player.y = 22 * TILE_SIZE; 
        clearSpawnZone('village', 48, 22);
        showToast("Keluar Dungeon");
    }
    else if(b.id === 'dungeon_next') {
        STATE.dungeonLevel++;
        STATE.location = 'dungeon';
        STATE.player.x = TILE_SIZE * 5; 
        STATE.player.y = TILE_SIZE * 5; 
        manualSave();
        showToast(` WARPING TO LEVEL ${STATE.dungeonLevel}...`);
        spawnEnemies(); 
    }
}

// --- NEW FUNCTION: ANTI-STUCK SPAWN ---
function clearSpawnZone(mapId, spawnTileX, spawnTileY) {
    const map = maps[mapId];
    if(!map || !map.npcs) return;

    // Radius aman (dalam satuan tile)
    const safeRadius = 3; 

    map.npcs.forEach(npc => {
        // FIX: Jangan pindahkan NPC Static (Diam) atau Service karena posisinya fixed/diatur designer
        if (npc.type === 'static' || npc.type === 'service') return;

        // Hitung jarak NPC ke titik spawn pemain
        const dist = Math.hypot(npc.x - spawnTileX, npc.y - spawnTileY);
        
        // Jika NPC berada terlalu dekat dengan titik spawn (< 3 tile)
        if (dist < safeRadius) {
            // Pindahkan NPC menjauh secara paksa
            // Cari arah menjauh
            const dirX = npc.x < spawnTileX ? -1 : 1;
            const dirY = npc.y < spawnTileY ? -1 : 1;
            
            // Pindahkan 3-4 tile menjauh
            let newX = npc.x + (dirX * 4);
            let newY = npc.y + (dirY * 4);

            // Pastikan tidak melempar NPC ke luar batas map (sederhana)
            if (newX < 1) newX = 1;
            if (newX >= map.w - 1) newX = map.w - 2;
            if (newY < 1) newY = 1;
            if (newY >= map.h - 1) newY = map.h - 2;

            // Terapkan posisi baru
            npc.x = newX;
            npc.y = newY;
            
            // Hentikan pergerakan sesaat agar tidak langsung balik
            npc.vx = 0; 
            npc.vy = 0;
            
            // Log debug (opsional)
            // console.log(`Menyingkirkan ${npc.name} dari jalur spawn.`);
        }
    });
}

// REMOVED DUPLICATE updateEnemies FUNCTION HERE (Deleted lines to clean up)

// --- NEW FUNCTION: SPAWN FINAL BOSS (PHASE 2) ---
function spawnFinalBoss() {
    STATE.bossSpawned = true;
    
    // Efek Dramatis
    showToast(" THE BOSS HAS AWAKENED!");
    createParticle(20 * TILE_SIZE, 15 * TILE_SIZE, '#7f1d1d');
    createParticle(20 * TILE_SIZE, 15 * TILE_SIZE, '#000');

    // Spawn Boss Besar
    STATE.enemies.push({
        x: 20 * TILE_SIZE,
        y: 15 * TILE_SIZE,
        w: 140, h: 140, // UPDATE: Ukuran Hitbox Lebih Besar (100 -> 140)
        hp: 5000, 
        maxHp: 5000,
        speed: 2.0, // Sangat Cepat
        knockback: {x:0, y:0},
        color: '#7f1d1d', // Merah darah
        animOffset: 0,
        angle: 0,
        isBoss: true,
        imgKey: 'boss'
    });
}

function checkWall(x, y) {
    const map = maps[STATE.location];
    if(x<0 || x>map.w*TILE_SIZE || y<0 || y>map.h*TILE_SIZE) return true;
    
    const tx = Math.floor((x+10)/TILE_SIZE);
    const ty = Math.floor((y+10)/TILE_SIZE);
    
    if (ty >= map.h || tx >= map.w) return true;

    const t = map.tiles[ty * map.w + tx];
    
    // UPDATE: Izinkan jalan di air (Tile 0) jika di area Dermaga
    if (STATE.location === 'village' && t === 0) {
        // Area Dermaga didefinisikan di map (x:43, y:34, w:7, h:5)
        // Kita izinkan player berjalan di koordinat tile tersebut
        // UPDATE: Koordinat Y disesuaikan (34 s/d 38)
        if (tx >= 43 && tx < 50 && ty >= 34 && ty < 39) {
            return false; // Walkable (Dermaga Kayu)
        }
        return true; // Blocked (Laut Lepas)
    }
    
    // UPDATE: Tambahkan ID 13 (Tembok Bawah) sebagai collision
    return (t === 2 || t === 12 || t === 11 || t === 13);
}

function checkObjectCollision(x, y) {
    const map = maps[STATE.location];
    for(let obj of map.objects) {
        // --- [BARU] CEK MUSIM OBJEK ---
        // Jika objek punya syarat musim (misal: 'winter') dan sekarang bukan musim itu, LEWATI (jangan dianggap ada)
        if (obj.seasonReq && obj.seasonReq !== STATE.season) continue;
        // -----------------------------
		
		const ox = obj.x * TILE_SIZE;
        const oy = obj.y * TILE_SIZE;
        
        // UPDATE: Support Custom Width/Height untuk Objek
        const ow = (obj.w || 1) * TILE_SIZE; 
        const originalH = (obj.h || 1) * TILE_SIZE;
        
        let oh = originalH;
        let yOffset = 0;

        // CUSTOM COLLISION: MEJA, KURSI, & KASUR (Agar bisa jalan di belakangnya)
        // Hitbox hanya aktif di setengah bagian bawah (kaki kursi/meja/kasur)
        // Bagian atas (sandaran) bisa dilewati (walkable)
        // UPDATE: Menambahkan 'papanguild' DAN 'mejamakanguild' agar hitbox-nya juga hanya setengah bawah
        // FIX: Tambahkan 'bed' agar area kepala kasur bisa dilewati
        /* REVISI: Tambahkan 'catalog' (Meja Telepon) agar bisa jalan di belakangnya */
        /* UPDATE: Tambahkan 'sumur' dan 'papantani' agar bisa jalan di belakangnya */
        /* UPDATE: Tambahkan 'orangsawah' agar bisa jalan di belakangnya */
        /* UPDATE TERBARU: Menambahkan 'arcacandi' agar belakang patung bisa dilewati */
        /* UPDATE TERBARU: Menambahkan 'prasasticandi' agar belakang prasasti bisa dilewati */
        /* UPDATE TERBARU: Menambahkan 'gucicandi' agar belakang guci bisa dilewati */
        // UPDATE TERBARU: Menambahkan 'kebunayu' agar belakang kebun bisa dilewati
        // UPDATE TERBARU: Menambahkan 'lemariobat' dan 'arsiprekammedis' agar belakang rak klinik bisa dilewati
        // UPDATE TERBARU: Menambahkan 'jaringikan' dan 'mejamakanikan' agar belakangnya bisa dilewati
        // UPDATE TERBARU: Menambahkan 'rakmentor', 'pialamentor', 'vasmentor' agar belakangnya bisa dilewati
        // UPDATE TERBARU: Menambahkan 'mejamasterguild' agar belakangnya bisa dilewati
        // UPDATE TERBARU: Menambahkan aset rumah Ayu (dapur, lemari, kasur, meja) agar belakangnya bisa dilewati
        if ((obj.type === 'table' || obj.type === 'bed' || obj.type === 'catalog' || (obj.img && (obj.img.includes('papanguild') || obj.img.includes('mejamakanguild') || obj.img.includes('mejatelpon') || obj.img.includes('sumur') || obj.img.includes('papantani') || obj.img.includes('orangsawah') || obj.img.includes('arcacandi') || obj.img.includes('mejaaltar') || obj.img.includes('prasasticandi') || obj.img.includes('gucicandi') || obj.img.includes('kebunayu') || obj.img.includes('lemariobat') || obj.img.includes('arsiprekammedis') || obj.img.includes('jaringikan') || obj.img.includes('mejamakanikan') || obj.img.includes('rakmentor') || obj.img.includes('pialamentor') || obj.img.includes('vasmentor') || obj.img.includes('mejamasterguild') || obj.img.includes('dapurayaayu') || obj.img.includes('lemariayaayu') || obj.img.includes('kasurayaayu') || obj.img.includes('mejaayaayu')))) && (obj.h || 1) > 0) {
            yOffset = originalH * 0.4; // Turunkan hitbox 40% dari atas
            oh = originalH * 0.6;      // Sisa tinggi hitbox 60%
        }
        
        const pw = 20; const ph = 20;
        
        // Cek tabrakan dengan hitbox yang sudah disesuaikan
        if (x < ox + ow && x + pw > ox && 
            y < oy + yOffset + oh && y + ph > oy + yOffset) {
            return obj; 
        }
    }
    return null;
}

function checkBuildingCollision(x, y) {
    const map = maps[STATE.location];
    if (!map.buildings) return false;

    for (let b of map.buildings) {
        // FIX: Trigger (Portal) tidak boleh punya collision fisik agar bisa diinjak
        // UPDATE: 'port' (Dermaga) juga dibuat walkable agar bisa jalan di atasnya
        if (b.type === 'trigger' || b.id === 'port') continue; 

        const bx = b.x * TILE_SIZE;
        const bw = b.w * TILE_SIZE;
        
        // CUSTOM COLLISION FOR ROCKS & BUILDINGS
        
        let collisionHeight, yOffset;

        if (b.type === 'dungeon_rock') {
            // Batu hitboxnya cuma setengah bawah (15px)
            collisionHeight = 15; 
            yOffset = (b.h * TILE_SIZE) - collisionHeight;
        } else {
            // REVISI: AGAR BISA JALAN DI BELAKANG BANGUNAN (TAPI TIDAK TEMBUS)
            // Hitbox hanya aktif di bagian bawah bangunan (Dinding/Kaki).
            // Bagian atas (Atap) tidak memiliki hitbox fisik (Walkable).
            
            // Logika: 
            // Jika bangunan tinggi (> 2 tile), hitbox hanya 1.8 tile terbawah (~54px).
            // Sisanya adalah atap yang bisa dilewati di belakangnya.
            // Jika pemain berjalan dari belakang ke depan, dia akan menabrak 'dinding belakang' hitbox ini.
            
            const isTall = b.h > 2;
            const solidTiles = isTall ? 1.8 : b.h; // 1.8 tile (54px) cukup untuk memblokir, sisanya atap
            
            collisionHeight = solidTiles * TILE_SIZE;
            yOffset = (b.h * TILE_SIZE) - collisionHeight;
        }
        
        // Koordinat hitbox absolut
        const hitboxY = (b.y * TILE_SIZE) + yOffset;
        
        const pw = 20; 
        const ph = 20;

        // Cek tabrakan: Pemain (x,y) vs Hitbox Bangunan
        // Logika AABB standard
        if (x < bx + bw && x + pw > bx && 
            y < hitboxY + collisionHeight && y + ph > hitboxY) {
            return true;
        }
    }
    return false;
}

function checkNPCCollision(x, y) {
    const map = maps[STATE.location];
    for (let npc of map.npcs) {
        if (!isNPCActive(npc)) continue;

        // --- FIX: HITBOX DINAMIS MENGIKUTI TINGGI NPC (KAKI SOLID) ---
        // Masalah sebelumnya: Hitbox fix di tengah, sehingga kaki NPC tinggi bisa ditembus.
        // Solusi: Hitbox dikunci ke area KAKI (Visual Height - Offset).
        
        const npcW = npc.w || 40;
        const npcH = npc.h || 60; // Default height standar NPC

        // Pusat X Hitbox = Pusat Sprite secara Horizontal
        // (npc.x * TILE_SIZE) adalah pojok kiri grid
        const npcCenterX = (npc.x * TILE_SIZE) + (npcW / 2); // Sesuaikan dengan lebar visual
        
        // Pusat Y Hitbox = KAKI Sprite (Y + H) dikurangi sedikit (sekitar 10-15px dari bawah)
        // Ini memastikan area kepala (atas) kosong bisa dilewati, tapi kaki (bawah) padat.
        const npcCenterY = (npc.y * TILE_SIZE) + npcH - 10; 

        // Player Center (Estimasi titik tengah kaki pemain)
        const playerCenterX = x + 10; // Player W = 20, setengahnya 10
        const playerCenterY = y + 15; // Player H = 20, kaki di y+20, pusat kaki ~y+15

        const distX = Math.abs(playerCenterX - npcCenterX);
        const distY = Math.abs(playerCenterY - npcCenterY);
        
        // RADIUS COLLISION:
        // X: Setengah lebar NPC dikurangi sedikit toleransi (biar tidak terlalu lebar/gemuk)
        const hitRadX = (npcW / 2) - 5; 
        
        // Y: Radius vertikal kecil (12px)
        // Agar tabrakan hanya terjadi jika kaki pemain sejajar dengan kaki NPC
        const hitRadY = 12; 

        if (distX < hitRadX && distY < hitRadY) {
            return npc;
        }
    }
    return null;
}

// --- NEW FUNCTION: CHECK ENEMY WALL COLLISION (DIRECTIONAL) ---
function checkEnemyWall(x, y) {
    if (STATE.location !== 'dungeon') return false;
    
    // Perkiraan tengah pemain
    const px = x + 10;
    const py = y + 10;

    for (let en of STATE.enemies) {
        const ex = en.x + en.w/2;
        const ey = en.y + en.h/2;
        const dist = Math.hypot(px - ex, py - ey);

        // Jika sangat dekat (radius tabrakan 25px)
        if (dist < 25) {
            // Hitung sudut dari Musuh ke Pemain
            const angleToPlayer = Math.atan2(py - ey, px - ex);
            
            // Hitung selisih sudut hadap Musuh vs Arah ke Pemain
            // en.angle adalah arah gerak musuh (mengejar pemain)
            let angleDiff = Math.abs(en.angle - angleToPlayer);
            
            // Normalisasi sudut agar range 0-PI
            if (angleDiff > Math.PI) angleDiff = (2 * Math.PI) - angleDiff;

            // Logika: Jika pemain berada di DEPAN arah gerak musuh (< 90 derajat / PI/2)
            // Maka dianggap menabrak "Tembok Slime"
            // Tapi jika pemain ada di BELAKANG (> 90 derajat), bisa lewat/tembus.
            
            // Karena musuh selalu mengejar pemain, 'depan' adalah arah pemain.
            // Agar pemain BISA lewat belakang, kita harus memberikan sedikit celah
            // atau mengasumsikan musuh punya inertia putar. 
            // Namun, untuk game top-down simple, logika "hanya solid dari depan"
            // berarti jika angleDiff kecil = solid.
            
            // KITA BALIK LOGIKANYA untuk gameplay:
            // Musuh selalu menghadap kita. Jadi kita selalu di depan.
            // Kecuali kita bergerak lebih cepat memutari dia.
            
            // Agar terasa efeknya, kita anggap "Depan" adalah cone 120 derajat.
            // Sisa 240 derajat (samping/belakang) adalah "Lunak".
            
            if (angleDiff < (Math.PI / 3)) { // Cone 60 derajat kiri-kanan (total 120)
                return true; // SOLID (Tidak bisa lewat)
            }
        }
    }
    return false;
}

function isNPCActive(npc) {
    // --- UPDATE: LOGIKA PASANGAN MENIKAH (HILANG DARI TEMPAT LAIN) ---
    // Jika sudah menikah, pasangan hanya muncul di Rumah Player (house atau player_shop_interior)
    // Di tempat lain (Village, Kampus, Klinik, dll), mereka akan disembunyikan.
    if (STATE.player.married && STATE.player.spouseId === npc.id) {
        if (STATE.location !== 'house' && STATE.location !== 'player_shop_interior') {
            return false;
        }
    }

    // NEW: Cek Syarat Gender (Untuk Fake Interest/Rival)
    if (npc.genderReq && npc.genderReq !== STATE.player.gender) return false;

    // NEW: Cek Syarat Quest (Untuk Monster Skripsi)
    if (npc.questReq) {
        if (STATE.player.activeQuest !== npc.questReq) return false;
    }

    // --- NEW: JADWAL KHUSUS DEWI ARSA (SUMMER 23, JAM 00:00-01:00) ---
    if (npc.schedule === 'custom_fullmoon') {
        // Hitung Data Waktu Saat Ini
        const totalDays = STATE.day - 1; 
        const seasonIndex = Math.floor((totalDays % (DAYS_PER_SEASON * 4)) / DAYS_PER_SEASON);
        const currentSeason = SEASONS[seasonIndex].toLowerCase();
        const dayInSeason = (totalDays % DAYS_PER_SEASON) + 1;

        // Syarat 1: Tanggal 23 Musim Panas (Summer)
        const isDate = (currentSeason === 'summer' && dayInSeason === 23);
        
        // Syarat 2: Jam 12 Malam s/d 1 Pagi (00:00 - 01:00)
        // Di sistem game, jam reset ke 0 saat mencapai 2400. Jadi rentangnya 0 s/d 100.
        const isTime = (STATE.time >= 0 && STATE.time < 100);

        return isDate && isTime;
    }

    // --- NEW: JADWAL KHUSUS KURCACI TANI (SUMMER 1, 08:00 - 18:00) ---
    if (npc.schedule === 'custom_harvest_festival') {
        const totalDays = STATE.day - 1; 
        const seasonIndex = Math.floor((totalDays % (DAYS_PER_SEASON * 4)) / DAYS_PER_SEASON);
        const currentSeason = SEASONS[seasonIndex].toLowerCase();
        const dayInSeason = (totalDays % DAYS_PER_SEASON) + 1;

        // Syarat 1: Tanggal 1 Musim Panas (Summer)
        const isDate = (currentSeason === 'summer' && dayInSeason === 1);
        
        // Syarat 2: Jam 08:00 s/d 18:00
        const isTime = (STATE.time >= 800 && STATE.time < 1800);

        return isDate && isTime;
    }

    // --- NEW: JADWAL KHUSUS PERI PANEN (AUTUMN 15, 08:00 - 18:00) ---
    if (npc.schedule === 'custom_grape_harvest') {
        const totalDays = STATE.day - 1; 
        const seasonIndex = Math.floor((totalDays % (DAYS_PER_SEASON * 4)) / DAYS_PER_SEASON);
        const currentSeason = SEASONS[seasonIndex].toLowerCase();
        const dayInSeason = (totalDays % DAYS_PER_SEASON) + 1;

        // Syarat 1: Tanggal 15 Musim Gugur (Autumn)
        const isDate = (currentSeason === 'autumn' && dayInSeason === 15);
        
        // Syarat 2: Jam 08:00 s/d 18:00
        const isTime = (STATE.time >= 800 && STATE.time < 1800);

        return isDate && isTime;
    }

    if (!npc.schedule || npc.schedule === 'always') return true;

    const isDayTime = STATE.time >= 600 && STATE.time < 2000;

    if (npc.schedule === 'day') return isDayTime;
    if (npc.schedule === 'night') return !isDayTime;
    
    // NEW: JADWAL SORE-MALAM (15:00 - 04:00)
    if (npc.schedule === 'evening') {
        return STATE.time >= 1500 || STATE.time < 400;
    }

    // NEW: JADWAL SPESIFIK RIVAL
    // Morning: 06:00 - 15:00 (Pagi ke Siang)
    if (npc.schedule === 'morning') {
        return STATE.time >= 600 && STATE.time < 1500;
    }
    // Afternoon: 15:00 - 22:00 (Siang ke Malam)
    if (npc.schedule === 'afternoon') {
        return STATE.time >= 1500 && STATE.time < 2200;
    }
    
    return true;
}

function checkEntranceProximity() {
    const map = maps[STATE.location];
    if (!map.buildings) return null;
    
    const pCenterX = STATE.player.x + (STATE.player.w / 2);
    const pCenterY = STATE.player.y + (STATE.player.h / 2);

    for (let b of map.buildings) {
        if(b.entrance) {
            const eCenterX = (b.entrance.x * TILE_SIZE) + (TILE_SIZE / 2);
            const eCenterY = (b.entrance.y * TILE_SIZE) + (TILE_SIZE / 2);
            
            const dist = Math.hypot(pCenterX - eCenterX, pCenterY - eCenterY);
            
            // UPDATE: Jarak interaksi tombol aksi juga diperbesar jadi 60px
            if(dist < 60) return b;
        }
    }
    return null;
}

function handleAction() {
    const entranceBuilding = checkEntranceProximity();
    
    // --- CEK APAKAH TOMBOL ADALAH TOMBOL BLOKIR FARMING () ---
    const btnAction = document.getElementById('btn-action');
    if (btnAction.innerText === '') {
        showDialogue("LAHAN TERBENGKALAI", 
            "Tanah ini keras dan dipenuhi akar liar.\nKamu tidak bisa mengolahnya sendirian.\n\n**SYARAT MEMBUKA LAHAN:**\nKamu harus mendapatkan bantuan dari ahli pertanian legendaris: **KURCACI TANI**.\n\n(Cari dia saat Festival Panen Raya di Musim Panas)", 
            [{text: "Saya akan mencarinya!", action: closeDialogue}], 
            'images/lahan-liar.png'
        );
        return;
    }

    // --- CEK INTERAKSI FARMING LANGSUNG VIA TOMBOL AKSI ---
    if (STATE.location === 'village' && (btnAction.innerText === '' || btnAction.innerText === '' || btnAction.innerText === '' || btnAction.innerText === '' || btnAction.innerText === '')) {
        const pTx = Math.floor((STATE.player.x + 10) / TILE_SIZE);
        const pTy = Math.floor((STATE.player.y + 15) / TILE_SIZE);
        
        // Panggil fungsi farming handler manual
        // Kita gunakan logika inventory item use_hoe atau plant seed secara otomatis untuk UX yang lebih cepat
        
        const farmKey = `${pTx}_${pTy}`;
        const crop = STATE.player.farming[farmKey];

        // 1. CANGKUL ()
        if (btnAction.innerText === '') {
            useInventoryItem('cangkul', 'use_hoe'); // Auto trigger cangkul
            return;
        }
        
        // 2. TANAM () -> Buka Menu Bibit
        if (btnAction.innerText === '') {
            handleFarmingInteraction(pTx, pTy); // Buka dialog pilih bibit
            return;
        }

        // 3. PANEN / SIRAM / LIHAT ( /  / )
        if (crop) {
            handleFarmingInteraction(pTx, pTy);
            return;
        }
    }

    if(entranceBuilding) {
        
        // --- LOGIC REFACTORED TO USE processTeleport ---
        // Cek apakah bangunan ini termasuk tipe auto-teleport
        // UPDATE: MENAMBAHKAN SCHOOL, GUILD, BLACKSMITH KE DAFTAR AGAR LOGIKA LATE/TUTUP JALAN
        const teleporters = [
            'player_house', 'house_exit', 
            'pshop_exit', // FIX: TAMBAHKAN KELUAR TOKO PLAYER KE SINI JUGA (MANUAL BUTTON)
            'dungeon_gate', 'dungeon_exit', 'dungeon_next',
            'merchant', 'shop_exit', 
            'library', 'library_exit',
            'school', 'school_exit',
            'guild', 'guild_exit',
            'blacksmith', 'smith_exit',
            'mentor', 'mentor_exit',
            'clinic', 'clinic_exit',
            'wedding', 'wedding_exit', // NEW: Wedding Teleport
            'lover1_home', 'lover1_exit', // NEW: Ayu's House Teleport
            'fisherman_home', 'fisherman_exit', // NEW: Fisherman House Teleport
            'candi', 'candi_exit', // FIX: MENAMBAHKAN CANDI YANG HILANG
			'warnet', 'warnet_exit' // <--- TAMBAHAN INI
        ];
        
        if(teleporters.includes(entranceBuilding.id)) {
            processTeleport(entranceBuilding);
            return;
        }
        
        // --- LOGIKA BANGUNAN LAIN (YANG BUKA MENU/DIALOG) TETAP DISINI ---
		
        // UPDATE: Interaksi Papan Misi (sekarang sebagai Building)
        if(entranceBuilding.id === 'papan_misi') {
             const dynamicText = getMissionBoardText();
             showDialogue("PAPAN PENGUMUMAN", dynamicText, [{text:"Tutup", action:closeDialogue}], 'images/papandesa.png');
             return;
        }

        // UPDATE: Interaksi Statue Rank (Building) - SINKRONISASI REAL DATA
        if(entranceBuilding.id === 'statue_rank') {
              // 1. CEK APAKAH HARI INI ADA FESTIVAL?
             const dayInSeason = ((STATE.day - 1) % DAYS_PER_SEASON) + 1; // 1-30
             const eventToday = CALENDAR_EVENTS[STATE.season][dayInSeason];

             // Jika ada Festival (Bukan cuma ultah), tawarkan opsi
             if (eventToday && eventToday.type === 'festival') {
                 showDialogue(` ${eventToday.name.toUpperCase()}`, 
                    `Hari ini desa sedang merayakan **${eventToday.name}**!\n\nWarga berkumpul di alun-alun. Apakah kamu ingin berpartisipasi?`, 
                    [
                        {
                            text: " IKUTI FESTIVAL! (Event)", 
                            action: () => {
                                closeDialogue();
                                startFestivalEvent(eventToday);
                            }
                        },
                        {
                            text: " Lihat Peringkat Server", 
                            action: () => showLeaderboardFromStatue()
                        },
                        {text: "Tutup", action: closeDialogue}
                    ], 
                    'images/statue.png'
                 );
                 return;
             }
			  // Jika tidak ada festival, langsung buka leaderboard
             showLeaderboardFromStatue();
             return;
        }

        // --- FIX: BAGIAN INI RUSAK DI KODE ANDA, INI PERBAIKANNYA ---
        if (!entranceBuilding.open24h && entranceBuilding.openTime && entranceBuilding.closeTime) {
            const t = STATE.time;
            const open = entranceBuilding.openTime;
            const close = entranceBuilding.closeTime;
            
            if (t < open || t >= close) {
                const openStr = Math.floor(open/100).toString().padStart(2,'0') + ":00";
                const closeStr = Math.floor(close/100).toString().padStart(2,'0') + ":00";
                
                showToast(` TUTUP! Buka jam ${openStr} - ${closeStr}`);
                return; 
            }
        }

        const totalDays = STATE.day - 1;
        const year = Math.floor(totalDays / (DAYS_PER_SEASON * 4)) + 1;
        
        if(entranceBuilding.roleSpecific) {
            if(entranceBuilding.roleSpecific !== STATE.player.role && year < 3 && !STATE.freeRoamMode) {
                showToast(" Terkunci! Bangunan ini hanya untuk Role " + entranceBuilding.roleSpecific.toUpperCase() + " (Terbuka Thn 3)");
                return;
            }
        }
        
        if(entranceBuilding.id === 'port') {
            showDialogue("DERMAGA MANCING", "Airnya terlihat tenang. Ingin memancing?", [
                {text: "Mancing (10 Energy)", action: () => {
                    closeDialogue(); 
                    setTimeout(startFishingMinigame, 100); 
                }},
                {text: "Nanti saja", action: closeDialogue}
            ], 'images/pelabuhan.png');
            return;
        } 
        else if(entranceBuilding.id === 'ruins_exit') {
            STATE.location = 'village';
            STATE.player.x = 50 * TILE_SIZE; 
            STATE.player.y = 15 * TILE_SIZE;
            STATE.enemies = [];
            showToast("Kabur dari pertarungan!");
            return;
        }
        else {
             showToast("Masuk ke " + entranceBuilding.name + " (Interior Segera Hadir)");
        }
        return; 
    }

    const map = maps[STATE.location];
    
    // --- UPDATE: LOGIKA INTERAKSI PRIORITASKAN JARAK TERDEKAT (BUKAN ARAH HADAP SAJA) ---
    
    // 1. CARI NPC TERDEKAT (Radius diperbesar)
    let closestNPC = null;
    let minNPCDist = 60; // Pixel

    for (let npc of map.npcs) {
        if (!isNPCActive(npc)) continue;
        
        const pCX = STATE.player.x + 10;
        const pCY = STATE.player.y + 10;
        const nCX = (npc.x * TILE_SIZE) + 15;
        const nCY = (npc.y * TILE_SIZE) + 30; // Kaki NPC

        const dist = Math.hypot(pCX - nCX, pCY - nCY);
        
        if (dist < minNPCDist) {
            closestNPC = npc;
            minNPCDist = dist; // Cari yang paling dekat
        }
    }

    if (closestNPC) {
        interactNPC(closestNPC);
        return;
    }

    // 2. CARI OBJEK TERDEKAT (YANG BERSENTUHAN)
    // Menggunakan logika yang sama dengan visibility check (Bounding Box Overlap)
    let hitObject = null;
    
    // Buffer interaksi sedikit lebih besar dari visibility agar klik pasti kena
    const buffer = 10; 
    
    const pLeft = STATE.player.x - buffer;
    const pRight = STATE.player.x + STATE.player.w + buffer;
    const pTop = STATE.player.y - buffer;
    const pBottom = STATE.player.y + STATE.player.h + buffer;

    for(let obj of map.objects) {
		
		// --- [BARU] CEK MUSIM SAAT INTERAKSI ---
        if (obj.seasonReq && obj.seasonReq !== STATE.season) continue;
        // ---------------------------------------
        const oLeft = obj.x * TILE_SIZE;
        const oRight = (obj.x + (obj.w || 1)) * TILE_SIZE;
        const oTop = obj.y * TILE_SIZE;
        const oBottom = (obj.y + (obj.h || 1)) * TILE_SIZE;

        // Cek Overlap
        if (pLeft < oRight && pRight > oLeft && 
            pTop < oBottom && pBottom > oTop) {
            hitObject = obj;
            break; // Ambil objek pertama yang disentuh
        }
    }

    if(hitObject) {
        interactObject(hitObject);
        return;
    }

    if(STATE.location === 'dungeon') {
        if(STATE.player.attackCooldown <= 0) {
            // UPDATE: Integrasi Stamina untuk Bertarung
            const attackCost = 2; // Biaya stamina per pukulan
            
            if(STATE.player.energy >= attackCost) {
                STATE.player.energy -= attackCost; // Kurangi stamina
                
                // --- NEW: LOGIKA COMBO SYSTEM ---
                if (STATE.player.comboWindow > 0) {
                    STATE.player.comboCount++;
                    if(STATE.player.comboCount > 3) STATE.player.comboCount = 1;
                } else {
                    STATE.player.comboCount = 1;
                }

                // Set Status Attack
                STATE.player.isAttacking = true;
                
                // Cooldown & Window berbeda tiap tahap combo
                // Combo 1 & 2 cepat, Combo 3 (Finisher) agak lama recovery-nya
                let animDuration = 15; // Frame
                let recoveryTime = 15; // Cooldown
                let windowTime = 40;   // Waktu untuk input next combo

                if (STATE.player.comboCount === 3) {
                    recoveryTime = 30; // Finisher butuh istirahat sebentar
                }

                STATE.player.attackCooldown = recoveryTime; 
                STATE.player.comboWindow = windowTime; 
                
                setTimeout(() => STATE.player.isAttacking = false, animDuration * 10); // Sync animasi kasar
                
                // Sound Effect Variatif
                if(typeof AudioService !== 'undefined') {
                    // Reset dulu biar bisa spam
                    if(AudioService.tracks.hit) {
                        AudioService.tracks.hit.pause();
                        AudioService.tracks.hit.currentTime = 0;
                    }
                    
                    if(STATE.player.comboCount === 3) {
                        // Suara lebih berat/panjang untuk finisher (jika ada, pakai 'hit' dgn volume keras)
                        AudioService.tracks.hit.volume = 1.0;
                        AudioService.playSFX('hit');
                    } else {
                        AudioService.tracks.hit.volume = 0.6;
                        AudioService.playSFX('hit');
                    }
                }

                // Damage Calculation
                let damageMult = 1.0;
                let rangeMult = 1.0;
                let knockbackForce = 0.8;

                if (STATE.player.comboCount === 2) {
                    damageMult = 1.2; // Hit 2: +20% Damage
                } 
                else if (STATE.player.comboCount === 3) {
                    damageMult = 2.5; // Hit 3: +150% Damage (CRITICAL FINISHER)
                    rangeMult = 1.5;  // Jangkauan lebih luas
                    knockbackForce = 4.0; // Mental jauh
                }

                // Hit Detection
                let hitCount = 0;
                STATE.enemies.forEach(en => {
                    const dist = Math.hypot(STATE.player.x - en.x, STATE.player.y - en.y);
                    // Base Range 60
                    if(dist < 60 * rangeMult) {
                        hitCount++;
                        
                        // Kalkulasi Final Damage
                        // Base STR + Weapon (Zirah/Cincin logic di handleEnemyDrop, disini attack power)
                        let baseDmg = STATE.player.str;
                        let finalDmg = Math.floor(baseDmg * damageMult);
                        
                        // Random Variation (+- 10%)
                        finalDmg = Math.floor(finalDmg * (0.9 + Math.random() * 0.2));

                        en.hp -= finalDmg;
                        en.knockback = { x: (en.x - STATE.player.x)*knockbackForce, y: (en.y - STATE.player.y)*knockbackForce };
                        createParticle(en.x, en.y, '#fff'); 
                        
                        // NEW: Spawn Floating Text
                        let color = '#fff';
                        let size = 10;
                        if(STATE.player.comboCount === 3) { color = '#facc15'; size = 16; } // Gold & Big for Crit
                        
                        spawnFloatingText(en.x, en.y - 10, finalDmg, color, size);
                    }
                });
                
                // Jika combo 3 kena tanah (miss), kasih efek getar dikit
                if (STATE.player.comboCount === 3 && hitCount === 0) {
                    STATE.shakeTimer = 5;
                }

            } else {
                showToast("Terlalu lelah untuk menyerang! (Stamina Habis)");
            }
        }
    } else {
    }
}

// --- NEW FUNCTION: SPAWN FLOATING TEXT ---
function spawnFloatingText(x, y, text, color, size) {
    STATE.floatingTexts.push({
        x: x, 
        y: y, 
        text: text, 
        color: color || '#fff', 
        size: size || 10,
        life: 40 // Durasi text melayang
    });
}

// --- NEW FUNCTION: SPAWN BUNGA LIAR SECARA ACAK ---
function spawnWildFlowers() {
    const map = maps['village'];
    if (!map || !map.objects) return;

    // Hitung jumlah bunga saat ini
    const currentFlowers = map.objects.filter(o => o.type === 'wild_flower').length;
    const maxFlowers = 15; // Maksimal bunga di map
    
    // Hanya spawn jika kurang dari batas
    if (currentFlowers < maxFlowers) {
        // Spawn 2-4 bunga baru setiap hari
        const spawnCount = Math.floor(Math.random() * 3) + 2; 
        
        for(let i=0; i < spawnCount; i++) {
            // Random posisi (hindari pinggir map)
            const rx = Math.floor(Math.random() * (map.w - 10)) + 5;
            const ry = Math.floor(Math.random() * (map.h - 10)) + 5;
            
            const idx = ry * map.w + rx;
            
            // Cek Tile: Hanya tumbuh di Rumput (1) dan tidak ada bangunan/objek lain
            // Sederhananya cek tile ID dulu
            if (map.tiles[idx] === 1) { 
                 // Cek collision sederhana dengan objek lain (agar tidak numpuk)
                 const isOccupied = map.objects.some(o => Math.abs(o.x - rx) < 2 && Math.abs(o.y - ry) < 2);
                 const isBuilding = map.buildings.some(b => 
                    rx >= b.x && rx < b.x + b.w && 
                    ry >= b.y && ry < b.y + b.h
                 );

                 if (!isOccupied && !isBuilding) {
                     map.objects.push({
                        x: rx, 
                        y: ry, 
                        w: 1, 
                        h: 1, 
                        type: 'wild_flower', 
                        icon: '', 
                        img: 'images/bunga.png', 
                        name: 'Bunga Liar'
                    });
                 }
            }
        }
        // console.log(`Spawned wild flowers. Total: ${map.objects.filter(o => o.type === 'wild_flower').length}`);
    }
}

// Removed handleSkill() function entirely

// --- NEW FUNCTION: START GOMBAL MINIGAME ---
function startGombalGame(npc) {
    // 1. Ambil 3 Gombalan Acak
    const options = [];
    const usedIndices = new Set();
    
    while(options.length < 3) {
        const idx = Math.floor(Math.random() * GOMBALAN_BANK.length);
        if(!usedIndices.has(idx)) {
            usedIndices.add(idx);
            options.push(GOMBALAN_BANK[idx]);
        }
    }

    // 2. Siapkan Opsi Dialog
    const dialogueOpts = options.map(g => {
        return {
            text: g.text, // Tampilkan teks gombalan
            action: () => processGombalChoice(npc, g.type)
        };
    });

    dialogueOpts.push({text: "Batal (Malu ah..)", action: () => interactNPC(npc)});

    showDialogue(`RAYU ${npc.name.toUpperCase()}`, "Pilih kata-kata manis yang tepat untuknya:", dialogueOpts, npc.imgSrc);
}

// --- NEW FUNCTION: PROCESS GOMBAL RESULT ---
function processGombalChoice(npc, type) {
    // PREFERENSI TIPE GOMBALAN TIAP NPC
    const preferences = {
        'lover1girl': { likes: ['cheesy', 'funny', 'pantun'], hates: ['romantic'] }, 
        'lover2girl': { likes: ['romantic', 'modern'], hates: ['funny', 'cheesy'] }, 
        'lover2boy': { likes: ['romantic'], hates: ['cheesy', 'funny', 'pantun'] }, 
        'lover1boy': { likes: ['cheesy', 'funny', 'modern'], hates: ['romantic'] },
        // NEW: PREFERENSI CINTA MATRE (Hanya suka Modern/Mewah, Benci Pantun/Receh)
        'lover_matre_girl': { likes: ['modern'], hates: ['pantun', 'cheesy', 'funny'] },
        'lover_matre_boy': { likes: ['modern', 'romantic'], hates: ['pantun', 'cheesy'] }
    };

    const pref = preferences[npc.id];
    let result = 'neutral';
    
    if (pref) {
        if (pref.likes.includes(type)) result = 'success';
        else if (pref.hates.includes(type)) result = 'fail';
    }

    // UPDATE STAT & REAKSI
    if (result === 'success') {
        updateRelationship(npc, 2, "Cinta"); // +2
        
        let happyText = "Hahaha! Kamu bisa aja! Pipi aku merah nih! ";
        if(npc.id === 'lover2girl') happyText = "I-itu... indah sekali... T-terima kasih... >///<";
        if(npc.id === 'lover2boy') happyText = "Kata-katamu menyentuh hati saya. Terima kasih.";
        if(npc.id === 'lover1boy') happyText = "Aduh, saya kena serangan jantung mendadak nih saking manisnya! ";
        
        showDialogue(npc.name, happyText, [{text:"Senang kamu suka", action:closeDialogue}], npc.imgSrc);
    } 
    else if (result === 'fail') {
        updateRelationship(npc, -2, "Trust"); // -2 (Turun Trust)
        
        let sadText = "Ih, garing banget sih... Gak lucu tau. ";
        if(npc.id === 'lover2girl') sadText = "K-kamu... mempermainkan aku ya? Jahat... T_T";
        if(npc.id === 'lover2boy') sadText = "Tolong jangan bercanda di saat serius. Itu tidak sopan.";
        if(npc.id === 'lover1boy') sadText = "Waduh, rayuannya kuno banget. Coba cari referensi lain deh.";
        
        showDialogue(npc.name, sadText, [{text:"Maaf...", action:closeDialogue}], npc.imgSrc);
    } 
    else { // Neutral
        // Tidak naik tidak turun, atau naik dikit
        showDialogue(npc.name, "Hmm... oke juga. Makasih ya.", [{text:"Sama-sama", action:closeDialogue}], npc.imgSrc);
    }
}

// --- NEW HELPER: GET RANDOM CHAT ---
function getRandomChat(npcId, loveLevel) {
    const chatData = NPC_CHATS[npcId];
    if(!chatData) return "Halo! Senang bertemu denganmu."; // Fallback

    let pool = [];
    if (loveLevel < 20) pool = chatData.low;
    else if (loveLevel < 80) pool = chatData.mid;
    else pool = chatData.high;

    if(!pool || pool.length === 0) return "Cuaca hari ini cerah ya.";
    return pool[Math.floor(Math.random() * pool.length)];
}

// --- NEW: FUNGSI DRAMA PERCERAIAN (GONG) ---
function handleDivorceSequence(npc) {
    if(typeof AudioService !== 'undefined') AudioService.playSFX('hit'); // Suara sedih/kaget

    // Dialog Pembuka yang Dramatis
    showDialogue(`${npc.name} (Sangat Kecewa)`, 
        "CUKUP! Aku sudah tidak tahan lagi dengan semua ini! \n\nHubungan kita sudah hancur. Kamu tidak pernah menghargaiku, tidak pernah ada waktu, dan ekonomi kita berantakan.\n\nAku rasa... kita sudah tidak bisa diperbaiki lagi.\n\n**AKU MINTA CERAI!**", 
        [
            {
                text: "JANGAN! Beri aku kesempatan terakhir! ", 
                action: () => {
                    // Kesempatan Kecil (30%) untuk rujuk jika hoki
                    if (Math.random() < 0.3) {
                         updateRelationship(npc, 15, "Kesempatan Kedua"); // Balik ke 15
                         showDialogue(npc.name, "Hhh... (Menghela napas panjang)\n\nBaiklah... demi kenangan manis kita dulu.\nIni **KESEMPATAN TERAKHIR**. Jika kamu mengecewakanku lagi, aku benar-benar pergi!", [{text:"Terima kasih sayang! Aku janji!", action:closeDialogue}], npc.imgSrc);
                    } else {
                         showDialogue(npc.name, "Tidak. Hatiku sudah mati untukmu.\nJanji-janjimu sudah basi. Aku tetap ingin pergi.", 
                         [{text: "...", action: () => finalizeDivorce(npc)}], npc.imgSrc);
                    }
                }
            },
            {
                text: "Ya sudah, PERGI SANA! (Cerai) ", 
                action: () => finalizeDivorce(npc)
            }
        ], 
        npc.imgSrc
    );
}

function finalizeDivorce(npc) {
    const p = STATE.player;
    
    // 1. Reset Status Nikah
    p.married = false;
    const exSpouseId = p.spouseId;
    p.spouseId = null;

    // 2. Hukuman Berat (Gono Gini & Reputasi)
    const alimony = Math.floor(p.money * 0.5); // Bayar 50% harta
    p.money -= alimony;
    p.reputation = 0; // Hancur reputasi di desa
    
    // Set hubungan jadi musuh (-50 tapi di sistem min 0, jadi kita set 0 dan blokir interaksi nanti)
    if(p.relationships[exSpouseId]) p.relationships[exSpouseId] = 0;

    // 3. Hapus NPC Pasangan dari Rumah
    const houseMap = maps['house'];
    if(houseMap) {
        houseMap.npcs = houseMap.npcs.filter(n => n.id !== exSpouseId);
    }
    const shopMap = maps['player_shop_interior'];
    if(shopMap) {
        shopMap.npcs = shopMap.npcs.filter(n => n.id !== exSpouseId);
    }

    // 4. Efek Visual & Audio
    createParticle(p.x, p.y, '#000000'); // Partikel Hitam (Kelam)
    if(typeof AudioService !== 'undefined') AudioService.playSFX('hit');

    // 5. Dialog Perpisahan
    showDialogue(npc.name, 
        `Selamat tinggal. Aku akan kembali ke rumah orang tuaku.\n\n(Harta dibagi dua: -${alimony.toLocaleString()} G)\n(Reputasi Hancur: Warga bergosip tentangmu)`, 
        [{
            text: "(Dia pergi membawa koper...) ", 
            action: () => {
                closeDialogue();
                regenerateHouseMap(); // Refresh map
                showToast(" STATUS: DUDA/JANDA");
                manualSave();
            }
        }], 
        npc.imgSrc
    );
}

// --- NEW: FUNGSI UPDATE RELATIONSHIP YANG HILANG ---
function updateRelationship(npc, amount, label) {
    if(!STATE.player.relationships[npc.id]) STATE.player.relationships[npc.id] = 0;
    
    // Tambah nilai
    STATE.player.relationships[npc.id] += amount;
    
    // Batasi (Cap) nilai 0 - 100
    if(STATE.player.relationships[npc.id] > 100) STATE.player.relationships[npc.id] = 100;
    if(STATE.player.relationships[npc.id] < 0) STATE.player.relationships[npc.id] = 0;
    
    // Tampilkan Notifikasi dengan Ikon Hati yang sesuai level
    const val = STATE.player.relationships[npc.id];
    let icon = ''; // Asing/Musuh
    if(val >= 20) icon = ''; // Teman
    if(val >= 50) icon = ''; // Dekat
    if(val >= 80) icon = ''; // Cinta
    
    // Tentukan pesan toast
    let msg = label ? `${label} (${amount > 0 ? '+' : ''}${amount})` : `Hubungan (${amount > 0 ? '+' : ''}${amount})`;
    
    showToast(`${msg} - Total: ${val} ${icon}`);
    
    // Efek partikel hati
    if(amount > 0) createParticle(npc.x * TILE_SIZE, npc.y * TILE_SIZE, '#ec4899');
}

function interactNPC(npc) {
    // --- UPDATE: Ganti 'chat' ke 'item' agar bunyi (karena file chat mungkin error) ---
    if(typeof AudioService !== 'undefined') AudioService.playSFX('item');

    // NEW: INCREMENT DAILY TALK COUNTER (Hanya tambah 1 per hari per interaksi unik sebenarnya lebih baik, tapi sederhananya setiap bicara dihitung)
    STATE.player.dailyTalkCount = (STATE.player.dailyTalkCount || 0) + 1;

    const p = STATE.player;
    if(!p.relationships[npc.id]) p.relationships[npc.id] = 0;
    const love = p.relationships[npc.id];
    
    if(npc.id === 'boss_merchant') {
        // --- NEW: RESTRIKSI JOB UNTUK NON-WORKER (TRIAL < TAHUN 4) ---
        // Hitung tahun saat ini (1 Tahun = 120 Hari)
        const currentYear = Math.ceil(STATE.day / 120);
        
        // Cek apakah pemain BUKAN Worker, Masih dalam Masa Trial (< Thn 4), dan Belum Bekerja
        if (p.role !== 'worker' && currentYear < 4 && !STATE.freeRoamMode && p.jobStatus !== 'employed') {
            showDialogue("MERCHANT", 
                "Selamat datang! Silakan lihat-lihat barang dagangan kami.\n\n(Catatan: Bos Merchant hanya membuka lowongan kerja untuk Role **Fighter/Pekerja** selama masa Trial 3 Tahun ini. Kamu bisa melamar setelah lulus Trial.)", 
                [
                    {text: "Lihat Pasar Komoditas (Jual/Beli)", action: () => openTradingMenu(npc)},
                    {text: "Ngobrol Bisnis", action: () => {
                        showDialogue("MERCHANT", "Harga barang di sini berfluktuasi setiap hari tergantung supply dan demand. Kalau kamu pintar, kamu bisa untung besar dari selisih harga.", [{text:"Ilmu yang bermanfaat", action:closeDialogue}], npc.imgSrc);
                    }},
                    {text: "Tutup", action: closeDialogue}
                ], 
                npc.imgSrc
            );
            return; // STOP di sini, jangan lanjut ke logika lamaran kerja
        }

        // ... (Logic Bos Merchant tetap sama untuk Worker) ...
        const jobStatus = p.jobStatus || 'unemployed';
        
        // --- NEW: DEFINISI JENJANG KARIR ---
        const JOB_TIERS = {
            1: { title: "Magang", salary: 5000 },
            2: { title: "Staff Senior", salary: 7500 },
            3: { title: "Kepala Gudang", salary: 12000 },
            4: { title: "Manajer Cabang", salary: 25000 }
        };
        const currentLvl = p.jobLevel || 1;
        const currentTitle = JOB_TIERS[currentLvl] ? JOB_TIERS[currentLvl].title : "Magang";

        if(jobStatus === 'fired') {
            showDialogue("MERCHANT", "Kamu sudah saya pecat! Kinerjamu buruk sekali.", [
                {text: "Saya mohon maaf, beri saya kesempatan! (Energy 50)", action: () => {
                    if(p.energy >= 50) {
                        p.energy -= 50;
                        p.bossReputation = 30; 
                        p.jobStatus = 'unemployed'; 
                        // Reset Job Level jika dipecat
                        p.jobLevel = 1; 
                        showToast("Bos luluh sedikit... Kamu bisa melamar lagi (Mulai dari Nol).");
                        closeDialogue();
                    } else showToast("Kurang energi untuk memohon.");
                }},
                {text: "Pergi", action: closeDialogue}
            ], npc.imgSrc);
            return;
        }

        if(jobStatus === 'unemployed') {
            showDialogue("MERCHANT", "Kami mencari pekerja disiplin. Shift 08:00 - 16:00. (Senin - Sabtu)", [
                {text: "Saya mau melamar! (Tulis Surat Lamaran)", action: () => {
                    openJobMinigame();
                }},
                {text: "Saya lihat-lihat dulu", action: closeDialogue}
            ], npc.imgSrc);
        } else if(jobStatus === 'employed') {
            // --- NEW: CEK HARI LIBUR KERJA (MINGGU) ---
            const dayIndex = (STATE.day - 1) % 7; // 0=Senin ... 6=Minggu
            if (dayIndex === 6) {
                 showDialogue("MERCHANT", `Halo ${currentTitle}. Hari ini **MINGGU**, gudang libur operasional. \nIstirahatlah, kumpulkan tenaga untuk besok Senin!`, [{text:"Siap Bos, Happy Sunday!", action:closeDialogue}], npc.imgSrc);
                 return;
            }

            // --- MENU UTAMA PEKERJA (MODIFIED) ---
            let bossText = `Halo, **${currentTitle}**. Siap bekerja hari ini?`;
            let menuOptions = [];

            // 1. OPSI MULAI SHIFT (Jika belum mulai & jam kerja)
            if(!p.shiftStarted) {
                if(STATE.time >= 800 && STATE.time <= 1000) {
                    menuOptions.push({
                        text: " Mulai Shift (Tepat Waktu)", 
                        action:()=>{
                            p.shiftStarted = true;
                            p.bossReputation += 1;
                            showToast("Shift Dimulai ");
                            closeDialogue();
                        }
                    });
                } else if (STATE.time > 1000 && STATE.time < 1600) {
                    bossText = "Kamu terlambat!! Cepat masuk kerja atau gaji dipotong!";
                    menuOptions.push({
                        text: " Mulai Shift (Terlambat)", 
                        action:()=>{
                            p.shiftStarted = true;
                            p.bossReputation -= 5;
                            showToast("Shift Dimulai (Terlambat) ");
                            closeDialogue();
                        }
                    });
                } else {
                    bossText = "Shift kerja belum dimulai (08:00) atau gudang sudah tutup (16:00).";
                }
            } else {
                bossText = "Kenapa malah ngobrol? Kembali ke posisimu!";
                menuOptions.push({text: "Siap Bos", action: closeDialogue});
            }

            // 2. OPSI PROMOSI & INFO KARIR (Selalu Muncul jika tidak sedang kerja)
            if (!p.shiftStarted) {
                menuOptions.push({
                    text: " Info Karir & Promosi",
                    action: () => {
                        const lvl = p.jobLevel || 1;
                        let promotionMsg = "";
                        let canPromote = false;
                        let nextTitle = "";
                        let reqStr = 0;
                        let reqRep = 0;

                        if (lvl === 1) {
                            nextTitle = "Staff Senior"; reqStr = 20; reqRep = 60;
                        } else if (lvl === 2) {
                            nextTitle = "Kepala Gudang"; reqStr = 40; reqRep = 80;
                        } else if (lvl === 3) {
                            nextTitle = "Manajer Cabang"; reqStr = 60; reqRep = 100;
                        } else {
                            promotionMsg = "Kamu sudah mencapai posisi puncak! **Manajer Cabang**. Tidak ada promosi lebih tinggi lagi saat ini.";
                        }

                        if (lvl < 4) {
                            promotionMsg = `**POSISI SAAT INI: ${JOB_TIERS[lvl].title}** (Gaji: ${JOB_TIERS[lvl].salary})\n\n`;
                            promotionMsg += `**SYARAT PROMOSI KE ${nextTitle.toUpperCase()}**:\n`;
                            promotionMsg += `1. Strength (STR): **${p.str}/${reqStr}** ${p.str >= reqStr ? '' : ''}\n`;
                            promotionMsg += `2. Reputasi Bos: **${p.bossReputation}/${reqRep}** ${p.bossReputation >= reqRep ? '' : ''}\n`;
                            promotionMsg += `\n(Gaji Baru: ${JOB_TIERS[lvl+1].salary} G)`;

                            if (p.str >= reqStr && p.bossReputation >= reqRep) canPromote = true;
                        }

                        let promoOpts = [];
                        if (canPromote) {
                            // UPDATE: CEK LEVEL UNTUK JENIS PROMOSI
                            if (lvl === 3) {
                                // Promosi ke Manajer (Level 3 -> 4) Butuh Ujian Kompetensi
                                promoOpts.push({
                                    text: " UJIAN KOMPETENSI MANAJER",
                                    action: () => {
                                        closeDialogue();
                                        startManagerExam();
                                    }
                                });
                            } else {
                                // Promosi Biasa (Lv 1->2, 2->3) Langsung
                                promoOpts.push({
                                    text: " AJUKAN PROMOSI SEKARANG!",
                                    action: () => {
                                        p.jobLevel++;
                                        if(typeof AudioService !== 'undefined') AudioService.playSFX('item');
                                        createParticle(npc.x*TILE_SIZE, npc.y*TILE_SIZE, '#fbbf24');
                                        showToast("NAIK PANGKAT! Gaji Meningkat ");
                                        
                                        showDialogue("MERCHANT", `Selamat! Saya melihat dedikasimu.\nMulai hari ini, kamu resmi diangkat menjadi **${nextTitle}**.\n\nJangan kecewakan saya!`, [{text:"Terima kasih Bos!", action:closeDialogue}], npc.imgSrc);
                                        
                                        // Simpan progress
                                        manualSave();
                                    }
                                });
                            }
                        }
                        
                        promoOpts.push({text: "Kembali", action: () => interactNPC(npc)});

                        showDialogue("JENJANG KARIR", promotionMsg, promoOpts, 'images/job.png');
                    }
                });
            }

            if(menuOptions.length === 0) {
                 menuOptions.push({text: "Tutup", action: closeDialogue});
            }

            // Tampilkan Dialog Utama Bos
            showDialogue("MERCHANT", bossText, menuOptions, npc.imgSrc);
        }
        return;
    }

    if (npc.id.includes('lover')) {
        let isRomanceTarget = false;
        if(p.gender === 'boy' && npc.id.includes('girl')) isRomanceTarget = true;
        if(p.gender === 'girl' && npc.id.includes('boy')) isRomanceTarget = true;
        
        // Helper untuk Judul Dialog dengan Indikator Hati
        const getLoveTitle = (name, val) => {
            let icon = '';
            if(val >= 80) icon = '';
            else if(val >= 50) icon = '';
            else if(val >= 20) icon = '';
            return `${name} [${icon} ${val}]`;
        };

        if(isRomanceTarget) {
            // Cek jika sudah menikah
            if(p.married && p.spouseId === npc.id) {
                
                // --- NEW: CEK AMBANG BATAS CERAI (GONG) ---
                const spouseLove = p.relationships[npc.id];
                if (spouseLove <= 0) {
                    handleDivorceSequence(npc);
                    return; // Stop interaksi normal
                }
                // ------------------------------------------

                // --- UPDATE: INTERAKSI RUMAH TANGGA ---
                let mood = "Bahagia";
                let moodEmoji = "";
                
                // Tentukan mood berdasarkan level cinta terkini
                if (spouseLove < 20) { mood = "Sangat Kecewa"; moodEmoji = ""; }
                else if (spouseLove < 50) { mood = "Sedih"; moodEmoji = ""; }
                else if (spouseLove < 80) { mood = "Biasa"; moodEmoji = ""; }
                
                // Sapaan acak
                const greetings = [
                    "Halo sayang, ada apa?",
                    "Senang melihatmu di rumah.",
                    "Hari ini capek ya? Semangat!",
                    "Aku bersyukur kita bersama."
                ];
                const randGreet = greetings[Math.floor(Math.random() * greetings.length)];

                showDialogue(`${npc.name} (${mood} ${moodEmoji})`, randGreet, [
                    {
                        text: " Ungkapkan Cinta (Makin Sayang)", 
                        action: () => {
                            // Tambah Cinta
                            updateRelationship(npc, 5, "Romantis");
                            createParticle(npc.x*TILE_SIZE, npc.y*TILE_SIZE, '#ec4899'); // Partikel Pink
                            if(typeof AudioService !== 'undefined') AudioService.playSFX('item');
                            
                            const responses = [
                                "Aww! Aku makin cinta sama kamu! ",
                                "Kamu manis banget sih... jadi malu.",
                                "Makasih sayang, aku juga cinta kamu selamanya!"
                            ];
                            showDialogue(npc.name, responses[Math.floor(Math.random()*responses.length)], [{text:"Hehe", action:closeDialogue}], npc.imgSrc);
                        }
                    },
                    {
                        text: " Beri Uang Belanja Tambahan (1000G)", 
                        action: () => {
                            if(p.money >= 1000) {
                                p.money -= 1000;
                                updateRelationship(npc, 10, "Nafkah Ekstra"); // Tambah banyak
                                showToast("Istri/Suami Senang Sekali! ");
                                showDialogue(npc.name, "Wahhh! Makasih banyak sayang! Nanti aku masak makanan kesukaanmu deh! ", [{text:"Sama-sama", action:closeDialogue}], npc.imgSrc);
                            } else {
                                showToast("Uangmu tidak cukup!");
                            }
                        }
                    },
                    {
                        text: " Marahi / Cuek (Cinta Berkurang)", 
                        action: () => {
                            // Kurangi Cinta
                            updateRelationship(npc, -5, "Pertengkaran");
                            
                            const sadResponses = [
                                "Kok kamu tega ngomong gitu? Jahat! ",
                                "Aku capek kalau kamu begini terus...",
                                "Tega... aku mau nangis di pojokan aja."
                            ];
                            
                            showDialogue(npc.name, sadResponses[Math.floor(Math.random()*sadResponses.length)], [{text:"Biarin (Tutup)", action:closeDialogue}], npc.imgSrc);
                        }
                    },
                    {text: "Istirahatlah (Tutup)", action: closeDialogue}
                ], npc.imgSrc);
            } else {
                // --- UPDATE: MAIN MENU INTERAKSI (BELUM NIKAH) ---
                
                const randomGreeting = getRandomChat(npc.id, love);
                
                // Cek Clue Cincin Raja (Hanya muncul sekali-sekali saat High Level)
                let mainText = randomGreeting;
                if(love >= 80 && Math.random() < 0.3) {
                    // NEW: Clue Palsu dari Matre
                    if(npc.id.includes('matre')) {
                        mainText = "Eh, aku dengar kalau nikah itu butuh Cincin Raja yang harganya mahal banget. Cuma, aku gak yakin mau nikah sama kamu sih. Tapi kalau cincinnya buat aku, boleh aja!";
                    }
                    else if(npc.id === 'lover1girl') mainText = "Konon katanya, ada 'Cincin Raja' yang indah banget di Dungeon dalam. Kalau ada cowok yang ngasih itu ke aku... wah, aku pasti langsung bilang IYES! Hehe! ";
                    // ... existing clues ...
                }

                const dialogueOpts = [
                    {text: "Beri Hadiah ", action: () => openGiftMenu(npc)},
                    
                    // UPDATE: Opsi Ngobrol Santai (DENGAN LOGIKA MATRE BERTINGKAT)
                    {text: "Ngobrol Santai", action: () => {
                         // NEW: LOGIKA MATRE BERTINGKAT
                         // Jika Matre DAN Love Level >= 20 (Sudah Kenal/Mid), baru minta bayaran
                         if(npc.id.includes('matre') && love >= 20) {
                             let cost = 100;
                             if(love >= 80) cost = 500; // Kalau sudah level cinta, mintanya lebih gila (500G)

                             if(p.money < cost) {
                                 showDialogue(npc.name, "Duh, kamu lagi bokek ya? Males ah ngobrol kalau gak ada traktiran.", [{text:"Matre banget...", action:closeDialogue}], npc.imgSrc);
                                 return;
                             }
                             // Bayar Biaya Lifestyle
                             STATE.player.money -= cost;
                             showToast(`-${cost} Gold (Biaya Gaya Hidup)`);
                         }

                         // FIX: Mengubah '>' menjadi '>=' agar sisa energi terakhir bisa digunakan (Lalu pingsan jika habis)
                         if(STATE.player.energy >= 2) {
                             STATE.player.energy -= 2;
                             let chatContent = getRandomChat(npc.id, love);
                             
                             // Pastikan chat tidak mengulang mainText jika sama
                             if(chatContent === mainText) chatContent = getRandomChat(npc.id, love);
                             
                             // UPDATE RELATIONSHIP BENAR-BENAR DIPANGGIL
                             updateRelationship(npc, 1); 
                             
                             showDialogue(npc.name, chatContent, [{text: "Dengarkan", action: closeDialogue}], npc.imgSrc);
                         } else showToast("Terlalu lelah... (Butuh 2 Energi)");
                    }},

                    // UPDATE: Tombol Minigame Gombal (DENGAN PROTEKSI PERNIKAHAN & LOGIKA PELAKOR MATRE)
                    {text: "Nge-gombal", action: () => {
                         // --- NEW: CEK STATUS PERNIKAHAN (ANTI-SELINGKUH) ---
                         if (STATE.player.married) {
                             // 1. LOGIKA KHUSUS MATRE (PELAKOR MODE)
                             if (npc.id.includes('matre')) {
                                 // Tidak mengurangi hubungan, justru menggoda
                                 // Suara Chat/Giggle
                                 if(typeof AudioService !== 'undefined') AudioService.playSFX('item'); 

                                 let pelakorMsg = "";
                                 if (npc.id === 'lover_matre_girl') { // Siska
                                     pelakorMsg = "Wah, cincin di jarimu bagus juga... Istrimu pasti bahagia ya punya suami mapan.\n\nSayang sekali kita telat ketemu. Tapi... kalau kamu bosan di rumah, aku selalu siap kok nemenin kamu belanja atau makan enak. \n\nAsal kamu yang bayar, rahasia aman! Kita jadi 'teman spesial' aja gimana? Hihihi. ";
                                 } else { // Rendi
                                     pelakorMsg = "Wih, ternyata sudah sold out. Padahal aku kira kita ada chemistry.\n\nTapi santai aja, aku orangnya asik kok. Kalau suamimu sibuk kerja dan kamu butuh hiburan, telepon aja aku. Kita bisa jalan-jalan berkelas bareng... tentunya pakai budget kamu dong. Deal? ";
                                 }

                                 showDialogue(npc.name + " (Menggoda)", pelakorMsg, [{text: "Duh, bahaya nih...", action: closeDialogue}], npc.imgSrc);
                                 return;
                             }

                             // 2. LOGIKA UMUM (NPC BAIK AKAN MARAH)
                             // Ambil nama pasangan untuk dialog
                             let spouseName = "Pasanganmu";
                             const sid = STATE.player.spouseId;
                             if(sid === 'lover1girl') spouseName = "Ayu";
                             else if(sid === 'lover2girl') spouseName = "Putri";
                             else if(sid === 'lover1boy') spouseName = "Dr. Budi";
                             else if(sid === 'lover2boy') spouseName = "Satria";

                             // Hukuman: Kurangi Relasi dengan NPC ini
                             updateRelationship(npc, -5, "Ditolak Keras"); 
                             
                             // Efek Suara Marah/Pukul
                             if(typeof AudioService !== 'undefined') AudioService.playSFX('hit');

                             showDialogue(npc.name + " (Marah)", 
                                `HEH! Apa-apaan kamu?! \n\nLihat cincin di jarimu itu! Kamu kan sudah menikah dengan **${spouseName}**.\n\nJangan ganjen ya! Pulang sana, ingat orang di rumah yang setia nungguin kamu!\n\n(Dia menolak rayuanmu mentah-mentah)`, 
                                [{text: "Maaf, aku khilaf...", action: closeDialogue}], 
                                npc.imgSrc
                             );
                             return;
                         }

                         // Jika Belum Menikah, Lanjut Normal
                         if(STATE.player.energy >= 3) {
                             STATE.player.energy -= 3;
                             startGombalGame(npc); 
                         } else showToast("Kurang energi buat mikir gombalan. (Butuh 3)");
                    }}
                ];

                /* --- NEW: OPSI BEROBAT KHUSUS DR. BUDI --- */
                if (npc.id === 'lover1boy') {
                    // Masukkan opsi Berobat ke urutan paling atas (unshift)
                    dialogueOpts.unshift({ 
                        text: " Berobat (Full Heal - 500G)", 
                        action: () => {
                            if(STATE.player.money >= 500) {
                                STATE.player.money -= 500;
                                STATE.player.hp = STATE.player.maxHp;
                                STATE.player.energy = 100;
                                showToast("Sehat Walafiat! ");
                                if(typeof AudioService !== 'undefined') AudioService.playSFX('item');
                                closeDialogue();
                            } else showToast("Uang tidak cukup!");
                        }
                    });
                    
                    // Tambahan Konsultasi
                    dialogueOpts.splice(1, 0, {
                        text: " Konsultasi Kesehatan", 
                        action: () => {
                             showDialogue(npc.name, "Jaga pola makan dan tidur. Jangan terlalu sering begadang di Dungeon ya.", [{text:"Baik Dok", action:closeDialogue}], npc.imgSrc);
                        }
                    });
                }

                /* --- NEW: OPSI PANDUAN HEWAN KHUSUS SATRIA (KSATRIA) --- */
                if (npc.id === 'lover2boy') {
                    dialogueOpts.unshift({
                        text: " Panduan Hewan & Ternak",
                        action: () => {
                            showDialogue(npc.name, "Seorang Ksatria harus memahami alam. Hewan adalah sekutu yang setia jika kau mengerti bahasa mereka. Apa yang ingin kau pelajari?", [
                                {text: "Cara Menjinakkan/Merawat", action: () => {
                                    showDialogue(npc.name, "Hewan di desa ini jinak namun butuh perhatian.\n\n1. **Dekati perlahan** (jangan lari).\n2. Tekan **Tombol Interaksi** saat berada di dekatnya.\n3. Jika muncul tanda  (Hati), berarti mereka bahagia dan mungkin memberikan hasil ternak.", [{text:"Siap laksanakan", action:closeDialogue}], npc.imgSrc);
                                }},
                                {text: "Jenis Hewan Nusantara", action: () => {
                                    showDialogue(npc.name, "Kenali kekayaan fauna di tanah ini:\n\n **Ayam Kampung**: Lincah dan mandiri, penghasil telur protein tinggi.\n **Kambing Etawa**: Tangguh menaki bukit, susunya sangat bergizi.\n **Sapi Bali**: Hewan pekerja keras, lambang kemakmuran.\n **Kuda Sumba (Sandalwood)**: Kuda pacu legendaris yang gesit dan setia.", [{text:"Wah, wawasan baru!", action:closeDialogue}], npc.imgSrc);
                                }},
                                {text: "Kembali", action: () => interactNPC(npc)}
                            ], npc.imgSrc);
                        }
                    });
                }

                // --- NEW: LOGIKA TOMBOL LAMAR DENGAN CINCIN RAJA ---
                const hasRing = (STATE.player.inventory['cincin_legend'] || 0) > 0;
                
                if (love >= 80) {
                    if (hasRing) {
                        // JIKA PUNYA CINCIN: Muncul Tombol Lamar Aktif
                        dialogueOpts.push({
                            text: " LAMAR (Berikan Cincin Raja)", 
                            action: () => {
                                // NEW: CEK APAKAH SUDAH MENIKAH (Mencegah Poligami)
                                if (STATE.player.married) {
                                    showToast("Kamu sudah menikah! Setia dong! ");
                                    return;
                                }

                                // NEW: CEK APAKAH INI CINTA MATRE?
                                if(npc.id.includes('matre')) {
                                    // REJECTION SCENE (Matre tetap menolak nikah walau Single)
                                    let rejectText = "Hah? Nikah? Sama kamu? \nAduh maaf ya, kita kan cuma teman senang-senang aja. Lagian hartamu belum cukup buat gaya hidupku. \nCincinnya bagus sih, tapi... NO THANKS! Bye! ";
                                    if(npc.id === 'lover_matre_boy') rejectText = "Waduh, kamu baper ya? Maaf cantik, aku belum siap berkomitmen dengan ekonomi pas-pasan. Kita TTM-an aja ya. Cincinnya simpan aja buat beli beras.";
                                    
                                    // Kurangi Hati Drastis (Patah Hati)
                                    updateRelationship(npc, -20, "Patah Hati");
                                    STATE.player.energy = 0; // Lemas seketika
                                    
                                    showDialogue(npc.name, rejectText, [{text:"Sakitnya Tuh Disini... (Pingsan)", action:() => {
                                        closeDialogue();
                                        handleFaint(); // Pingsan karena shock
                                    }}], npc.imgSrc);
                                    return;
                                }

                                // ... Logic Lamar Normal (Sukses) ...
                                // Kurangi Cincin
                                STATE.player.inventory['cincin_legend']--;
                                if(STATE.player.inventory['cincin_legend'] <= 0) delete STATE.player.inventory['cincin_legend'];
                                
                                // Set Status Menikah
                                p.married = true;
                                p.spouseId = npc.id;
                                p.reputation += 100;
                                p.money += 10000; 
                                
                                showFloatingText(npc.x*TILE_SIZE, npc.y*TILE_SIZE - 50, "SHE SAID YES! ", '#ec4899');
                                createParticle(npc.x*TILE_SIZE, npc.y*TILE_SIZE, '#e74c3c');
                                if(typeof AudioService !== 'undefined') AudioService.playSFX('item'); 

                                showDialogue(getLoveTitle(npc.name, love), "AKU BERSEDIA! \n(Kamu menyerahkan Cincin Raja yang berkilauan. Hubungan kalian kini abadi.)", [{text:"Bahagia Selamanya", action:closeDialogue}], npc.imgSrc);
                            }
                        });
                    } else {
                        // JIKA TIDAK PUNYA CINCIN
                        dialogueOpts.push({
                            text: " Lamar (Butuh Item: Cincin Raja)", 
                            action: () => showToast("Cari 'Cincin Raja' (Legendary Drop) dari Boss Dungeon!")
                        });
                    }
                }

                dialogueOpts.push({text: "Dah", action: closeDialogue});
                
                showDialogue(getLoveTitle(npc.name, love), mainText, dialogueOpts, npc.imgSrc);
            }
        } else {
            // --- NEW: INTERAKSI DOKTER BUDI UNTUK SESAMA COWOK (PASIEN) ---
            if (npc.id === 'lover1boy') {
                 // Bank Data Tips Kesehatan
                 const HEALTH_TIPS_BANK = [
                    "Jangan lupa minum air putih minimal 2 liter sehari ya, bro. Ginjal itu aset mahal!",
                    "Kalau habis dari Dungeon, pastikan luka lu dibersihkan biar gak infeksi. Tetanus itu gak lucu.",
                    "Tidur itu penting buat regenerasi sel. Jangan mentang-mentang masih muda lu hajar begadang terus.",
                    "Makan 4 sehat 5 sempurna itu bukan mitos SD. Itu bahan bakar buat lu kerja keras.",
                    "Stres bisa bikin imun turun drastis. Sekali-kali mancing atau jalan-jalan lah biar rileks.",
                    "Kurangi gula, bro. Diabetes gak pandang umur. Mending manis di senyum daripada di darah.",
                    "Otot butuh protein. Kalau lu mau kuat bawa pedang berat, banyakin makan ikan atau telur."
                 ];
                 
                 showDialogue(npc.name, "Halo bro! Kelihatan pucat nih. Ada yang bisa saya bantu? Mau berobat atau sekadar konsultasi?", [
                    { 
                        text: " Berobat (Full Heal - 500G)", 
                        action: () => {
                            if(STATE.player.money >= 500) {
                                STATE.player.money -= 500;
                                STATE.player.hp = STATE.player.maxHp;
                                STATE.player.energy = 100;
                                showToast("Tubuh Segar Bugar! ");
                                if(typeof AudioService !== 'undefined') AudioService.playSFX('item');
                                closeDialogue();
                            } else {
                                showToast("Waduh, uang lu kurang bro. Sehat itu mahal.");
                            }
                        }
                    },
                    { 
                        text: " Minta Tips Kesehatan", 
                        action: () => {
                             const randomTip = HEALTH_TIPS_BANK[Math.floor(Math.random() * HEALTH_TIPS_BANK.length)];
                             showDialogue(npc.name, ` **TIPS DOKTER:**\n\n"${randomTip}"`, [{text:"Siap Dok, makasih!", action:closeDialogue}], npc.imgSrc);
                        }
                    },
                    {text: "Cuma lewat", action: closeDialogue}
                ], npc.imgSrc);
                return;
            }

            /* --- NEW: INTERAKSI SATRIA UNTUK SESAMA COWOK (MENTOR/BRO) --- */
            if (npc.id === 'lover2boy') {
                 showDialogue(npc.name, "Salam hormat! Posturmu tegap hari ini. Tertarik mempelajari ilmu alam dan kepemimpinan?", [
                    { 
                        text: " Panduan Hewan (Pet Info)", 
                        action: () => {
                             showDialogue(npc.name, "Mengurus hewan melatih kesabaran seorang prajurit. Apa yang ingin kau ketahui?", [
                                {text: "Cara Berinteraksi", action: () => {
                                    showDialogue(npc.name, "Kuncinya adalah **Ketenangan**. \nDekati hewan tanpa gerakan mendadak, lalu elus mereka (Tombol Aksi). \nHewan yang bahagia akan memberikan berkah (Resource).", [{text:"Paham", action:closeDialogue}], npc.imgSrc);
                                }},
                                {text: "Ensiklopedia Hewan Nusantara", action: () => {
                                    showDialogue(npc.name, "Ini catatan pengamatanku:\n\n **Ayam Bekisar**: Suaranya merdu, ikon kebanggaan timur Jawa.\n **Kambing Kacang**: Kecil tapi lincah dan tahan banting.\n **Sapi Madura**: Memiliki punuk khas, sangat kuat untuk membajak.\n **Kuda Sumbawa**: Kuda petarung yang pemberani di medan laga.", [{text:"Mantap infonya bro!", action:closeDialogue}], npc.imgSrc);
                                }},
                                {text: "Kembali", action: () => interactNPC(npc)}
                            ], npc.imgSrc);
                        }
                    },
                    { text: "Minta Motivasi ", action: () => {
                         const quotes = [
                             "Pedang menumpul jika tidak diasah, manusia melemah jika tidak diuji.",
                             "Jangan takut berjalan lambat, takutlah jika hanya berdiri diam.",
                             "Seorang Ksatria sejati bukan yang tak pernah jatuh, tapi yang selalu bangkit!",
                             "Keberanian bukan ketiadaan rasa takut, tapi kemampuan untuk melangkah meski gemetar."
                         ];
                         showDialogue(npc.name, `"${quotes[Math.floor(Math.random()*quotes.length)]}"`, [{text:"Terbakar semangat!", action:closeDialogue}], npc.imgSrc);
                    }},
                    {text: "Cuma lewat", action: closeDialogue}
                ], npc.imgSrc);
                return;
            }

            showDialogue(npc.name, "Halo kawan! Sukses ujiannya ya.", [{text:"Sip", action:closeDialogue}], npc.imgSrc);
        }
        return;
    }

    else if(npc.id === 'mentor') {
        const role = STATE.player.role;
        
        // FIX: Jika Role belum dipilih (New Game / Reset), paksa jalankan Tutorial
        if (role === 'none') {
            runTutorial();
            return;
        }

        const name = DataService.user ? DataService.user.name : "Siswa";

        // GUNAKAN npc.name (yang sudah diupdate di initGame)
        showDialogue(npc.name, `Halo, ${name}. Saya di sini untuk membimbingmu agar tidak tersesat di Pulau Arsa. Apa yang ingin kamu ketahui?`, [
            {text: "Apa tugasku sekarang? (Role)", action: () => {
                let advice = "";
                let specificBuilding = "";
                
                if(role === 'worker') {
                    advice = "Kamu memilih jalur Fighter (Pekerja). Fokus utamamu adalah FISIK & KETERAMPILAN. \n1. Tingkatkan STR dengan bekerja kasar atau berlatih.\n2. Lamar kerja di Merchant (Masuk Gedung).\n3. Jaga hubungan dengan Bos agar tidak dipecat.";
                    specificBuilding = "Merchant (Interior)";
                } else if(role === 'student') {
                    advice = "Kamu memilih jalur Mage (Akademisi). Senjatamu adalah OTAK. \n1. Wajib ke Kampus setiap pagi untuk kuliah.\n2. Tingkatkan INT untuk membuka akses beasiswa.\n3. Jangan terlalu sering main fisik, jaga Energimu untuk belajar.";
                    specificBuilding = "Kampus";
                } else if(role === 'entrepreneur') {
                    advice = "Kamu memilih jalur Support (Wirausaha). Tugasmu memutar UANG. \n1. Beli barang murah di Merchant, jual saat harga naik.\n2. Jangan konsumtif! Setiap Gold adalah modal.\n3. Bangun relasi bisnis dengan NPC kaya.";
                    specificBuilding = "Merchant/Pasar";
                } else if(role === 'family') {
                    advice = "Kamu memilih jalur Tanker (Keluarga). Kekuatanmu adalah SOSIAL. \n1. Sapa semua tetangga setiap hari.\n2. Naikkan Reputasi dengan membantu orang.\n3. Fokus menabung untuk biaya pernikahan yang sangat mahal.";
                    specificBuilding = "Balai Pernikahan";
                } else {
                    // Fallback jika lolos pengecekan awal (seharusnya tidak terpanggil karena fix di atas)
                    runTutorial();
                    return;
                }
                
                showDialogue(npc.name, advice, [
                    {text: `Dimana ${specificBuilding}?`, action: () => showToast(`Cek Peta! ${specificBuilding} ada ikon khususnya.`)},
                    {text: "Siap Laksanakan", action: () => interactNPC(npc)}
                ], npc.imgSrc);
            }},

            // --- NEW: OPSI DIALOG INFO BEASISWA ---
            {text: "Info Beasiswa & Biaya", action: () => {
                showDialogue(npc.name, 
                    "Pendidikan itu investasi, tapi biayanya berbeda tergantung otakmu!\n\n **JALUR REGULER**:\n- Syarat: Lulus Ujian (Nilai Minimal).\n- Biaya: Bayar Uang Pangkal & **UKT 600.000 / Tahun**.\n\n **JALUR BEASISWA**:\n- Syarat: **Nilai Ujian Sempurna (100)**.\n- Benefit: **GRATIS UKT** & dapat **Uang Saku 15.000 / Bulan**!\n\nJadi, belajar yang rajin sebelum ujian masuk!", 
                    [{text: "Wah, menggiurkan!", action: () => interactNPC(npc)}], 
                    npc.imgSrc
                );
            }},

            {text: "Jelaskan Fungsi Bangunan", action: () => {
                 showDialogue(npc.name, "Setiap bangunan punya fungsi unik:\n Merchant: Beli/Jual Barang.\n Kampus: Belajar (INT).\n Klinik: Pulihkan Kesehatan.\n Blacksmith: Info Karir & Upgrade.\n Guild: Misi Petualang.\n Perpustakaan: Info Lore & Resep.", [{text:"Terima kasih", action:()=>interactNPC(npc)}], npc.imgSrc);
            }},
            
            {text: "Nasihat Hidup", action: () => {
                 showDialogue(npc.name, "Ingat, Nak. Waktu adalah mata uang paling mahal di sini. Jangan habiskan harimu hanya untuk berjalan-jalan tanpa tujuan. Tentukan target harianmu.", [{text:"Siap Mentor", action:closeDialogue}], npc.imgSrc);
            }},

            {text: "Tutup", action: closeDialogue}
        ], npc.imgSrc);
    } 
    
    // UPDATE: Interaksi Anak Blacksmith (Di Luar)
    else if(npc.id === 'child_blacksmith') {
        showDialogue(npc.name, "Halo Kak! Ayah sedang sibuk menempa di dalam bengkel. Kalau mau upgrade senjata, masuk saja ya!", [
            {text: "Wah rajin ya", action: closeDialogue},
            {text: "Kamu sedang apa?", action: () => {
                showDialogue(npc.name, "Aku sedang belajar membedakan bijih besi dan batu biasa. Susah juga ya...", [{text:"Semangat!", action:closeDialogue}], npc.imgSrc);
            }}
        ], npc.imgSrc);
    }
	
	// --- NEW: INTERAKSI OPERATOR WARNET (MENU KERJA/MAIN) ---
    else if(npc.id === 'op_warnet') {
        // Panggil fungsi menu warnet yang sudah ada, tapi ganti gambarnya jadi penjaga
        // Kita modifikasi sedikit fungsi openWarnetMenu nanti atau override disini
        showDialogue("OPERATOR (OP)", "Selamat datang di Warnet Desa. \nKoneksi lancar, AC dingin, Mie Instan ready. Mau sewa billing?", [
            {text: " Sewa PC (Kerja/Main)", action: () => {
                closeDialogue();
                openWarnetMenu(); // Panggil menu lama
            }},
            {text: "Tanya Paket Malam", action: () => {
                showDialogue(npc.name, "Paket Malam (Begadang) tersedia dari jam 22:00 - 04:00. Diskon 50% tapi awas masuk angin.", [{text:"Oke", action:closeDialogue}], npc.imgSrc);
            }},
            {text: "Batal", action: closeDialogue}
        ], npc.imgSrc);
    }

    // --- NEW: INTERAKSI MAID CAFE (JUAL MAKANAN) ---
    else if(npc.id === 'maid_warnet') {
        showDialogue(npc.name, "Selamat datang, Master!  \nMau pesan cemilan atau minuman penyegar untuk menemani main game?", [
            {text: " Beli Kopi/Tonic (Pulihkan Energi)", action: () => {
                showDialogue("MENU CAFE", "Pilih menu penyegar:", [
                    {text: "Kopi Hitam (200 G) - Energi +20", action: () => {
                        if(STATE.player.money >= 200) {
                            STATE.player.money -= 200;
                            STATE.player.energy = Math.min(100, STATE.player.energy + 20);
                            showToast("Segar! Energi +20");
                            closeDialogue();
                        } else showToast("Uang kurang");
                    }},
                    {text: "Tonic Stamina (1000 G) - Full", action: () => buyItem('tonic_stamina', 1000)},
                    {text: "Batal", action: () => interactNPC(npc)}
                ], npc.imgSrc);
            }},
            {text: " Beli Cemilan", action: () => {
                 showDialogue("SNACK MENU", "Cemilan ringan:", [
                    {text: "Roti Bakar (150 G)", action: () => buyItem('gandum', 150)}, // Anggap gandum = roti
                    {text: "Coklat (300 G)", action: () => buyItem('coklat', 300)},
                    {text: "Kembali", action: () => interactNPC(npc)}
                 ], npc.imgSrc);
            }},
            {text: "Kamu Lucu (Gombal)", action: () => {
                showDialogue(npc.name, "Hihihi... Master bisa aja. \n(Dia tersenyum malu-malu)", [{text:"Hehe", action:closeDialogue}], npc.imgSrc);
            }},
            {text: "Dah", action: closeDialogue}
        ], npc.imgSrc);
    }

    // --- NEW: INTERAKSI GUILD MASTER (FILOSOFI & LORE) ---
    else if(npc.id === 'guild_master') {
        const pName = DataService.user ? DataService.user.name : "Petualang";
        
        showDialogue("GUILD MASTER", `Selamat datang di sarang para pemberani, ${pName}. Pedang yang tak pernah ditempa takkan tajam. Apa yang kau cari di sini?`, [
            {text: "Tentang Pulau Arsa", action: () => {
                showDialogue("GUILD MASTER", "Pulau Arsa adalah kawah candradimuka. Tempat ini bukan surga, tapi neraka pelatihan. \nBanyak yang datang dengan mimpi besar, tapi pulang tanpa nama karena takut pada Dungeon. Hanya mereka yang berani berdarah yang akan diukir sejarahnya.", 
                [{text: "Aku siap membuktikan!", action: () => interactNPC(npc)}], npc.imgSrc);
            }},
            {text: "Nasihat Kehidupan (Zona Nyaman)", action: () => {
                showDialogue("GUILD MASTER", "Dengar, Nak. Kapal itu paling aman saat di pelabuhan, tapi bukan untuk itu kapal dibuat.\n\nKenyamanan adalah pembunuh impian pelan-pelan. Jika kau takut gagal, takut lelah, atau takut ditolak, kau sudah mati sebelum berperang. \nKeluar dari zona nyamanmu! Ambil risiko, lamar pekerjaan sulit, atau pelajari ilmu baru. Luka hari ini adalah medali untuk esok hari.", 
                [{text: "Sangat mendalam...", action: () => interactNPC(npc)}], npc.imgSrc);
            }},
            {text: "Mitos Kota Kuno", action: () => {
                showDialogue("GUILD MASTER", "Kau pernah mendengar legenda 'Aethelgard'? Konon, di bawah danau dekat hutan barat, terdapat reruntuhan kota kuno.\n\nMitosnya, di malam bulan darah, kau bisa melihat bayangan menara kota itu di permukaan air. Katanya, itu adalah kota para cendekiawan yang dihukum dewa karena kesombongan mereka. Hati-hati, jangan terlalu lama menatap air di malam hari.", 
                [{text: "Menyeramkan...", action: () => interactNPC(npc)}], npc.imgSrc);
            }},
            {text: "Dunia Luar (Pulau Lain)", action: () => {
                showDialogue("GUILD MASTER", "Dunia ini luas, Nak! Di seberang lautan ada 'Javanna', metropolis raksasa penuh teknologi canggih.\n\nDi utara ada 'Borneola', hutan purba tempat para Druid menjaga keseimbangan alam. Di timur ada 'Celebesia', kepulauan para pelaut tangguh.\nPulau Arsa hanyalah langkah awalmu. Jadilah yang terbaik di sini, dan tiket menuju Javanna akan menjadi milikmu.", 
                [{text: "Tujuanku Javanna!", action: () => interactNPC(npc)}], npc.imgSrc);
            }},
            {text: "Tutup", action: closeDialogue}
        ], npc.imgSrc);
    }

    /* --- NEW: INTERAKSI BAPAK PENGHULU (MODIN) UNTUK ROLE FAMILY --- */
    else if(npc.id === 'penghulu') {
        // Cek Role Family
        if (STATE.player.role === 'family') {
            
            // UPDATE: CLEAR QUEST JIKA SEDANG AKTIF
            if(STATE.player.activeQuest === 'meet_modin') {
                STATE.player.activeQuest = null; // Quest Selesai
                // Efek visual kecil
                createParticle(npc.x * TILE_SIZE, npc.y * TILE_SIZE, '#d946ef');
                showToast("Quest Selesai: Bertemu Pak Modin ");
            }

            // Jika sudah menikah
            if (STATE.player.married) {
                showDialogue(npc.name, "Alhamdulillah, kamu sudah menyempurnakan separuh agama. \nJaga pasanganmu baik-baik, sakinah mawaddah warahmah ya!", [{text:"Aamiin", action:closeDialogue}], npc.imgSrc);
                return;
            }

            // Dialog Pertanyaan Komitmen
            showDialogue(npc.name, "Assalamualaikum, anak muda. Mentor Budi memberitahu bahwa kamu memilih jalan Keluarga.\n\nApakah kamu **BENAR-BENAR YAKIN** ingin menikah? \n\nMenikah itu bukan main-main. Konsekuensinya besar: Kamu wajib menafkahi, setia, dan menjaga perasaan pasanganmu seumur hidup. Siap?", 
                [
                    {
                        text: "InsyaAllah Saya Siap & Yakin!", 
                        action: () => {
                            // Dialog Pemilihan Pasangan
                            const gender = STATE.player.gender;
                            let opts = [];

                            // Helper function untuk set tunangan
                            const setFiance = (targetId, targetName) => {
                                // Set Relationship ke level Tunangan (misal 60) agar mudah dinikahi nanti
                                if(!STATE.player.relationships[targetId]) STATE.player.relationships[targetId] = 0;
                                STATE.player.relationships[targetId] = Math.max(STATE.player.relationships[targetId], 60);
                                
                                // Beri item Cincin Kayu (Starter Ring)
                                if(!STATE.player.inventory['cincin_kayu']) STATE.player.inventory['cincin_kayu'] = 0;
                                STATE.player.inventory['cincin_kayu']++;

                                // --- NEW: UBAH SPRITE PLAYER JADI PENGANTIN ---
                                const pGender = STATE.player.gender;
                                // Ganti source gambar sprite player saat ini ke versi wedding
                                // Format: images/boy-idle-weding.png, images/girl-walk-weding.png, dst.
                                if (STATE.player.spriteIdle) STATE.player.spriteIdle.src = `images/${pGender}-idle-weding.png`;
                                if (STATE.player.spriteWalk) STATE.player.spriteWalk.src = `images/${pGender}-walk-weding.png`;
                                if (STATE.player.spriteWalkUp) STATE.player.spriteWalkUp.src = `images/${pGender}-atas-weding.png`;
                                if (STATE.player.spriteWalkDown) STATE.player.spriteWalkDown.src = `images/${pGender}-bawah-weding.png`;
                                
                                // Fallback: Jika gambar wedding tidak ditemukan, kembalikan ke default agar tidak hilang
                                if (STATE.player.spriteIdle) {
                                    STATE.player.spriteIdle.onerror = function() { 
                                        this.src = `images/${pGender}-idle.png`; 
                                        console.warn("Gambar wedding player tidak ditemukan, kembali ke default.");
                                    };
                                }

                                // --- NEW: SPAWN PASANGAN DI WEDDING HALL (VISUAL LANGSUNG) ---
                                const weddingImages = {
                                    'lover1girl': 'images/lover1girl-weding.png',
                                    'lover2girl': 'images/lover2girl-weding.png',
                                    'lover1boy': 'images/lover1boy-weding.png',
                                    'lover2boy': 'images/lover2boy-weding.png'
                                };
                                const weddingImg = weddingImages[targetId] || 'images/lover1girlweding.png'; // Fallback

                                const wMap = maps['wedding_interior'];
                                if (wMap) {
                                    // Bersihkan NPC lover lain jika ada (agar tidak tumpuk)
                                    wMap.npcs = wMap.npcs.filter(n => !n.id.startsWith('lover'));
                                    
                                    // Munculkan Calon Pasangan di sebelah kanan altar
                                    wMap.npcs.push({
                                        id: targetId,
                                        x: 8.5, y: 3, // Posisi di sebelah kanan altar/penghulu
                                        name: targetName + " (Calon)",
                                        imgSrc: weddingImg, // Menggunakan baju pengantin
                                        type: 'static',
                                        schedule: 'always',
                                        w: 40, h: 60
                                    });

                                    // EFEK VISUAL: Partikel Hati saat pasangan muncul
                                    createParticle(8.5 * TILE_SIZE, 3 * TILE_SIZE, '#ec4899');
                                    createParticle(8.5 * TILE_SIZE, 3 * TILE_SIZE, '#ffffff');
                                }
                                // -------------------------------------------------------------

                                showToast(`Target Terkunci: ${targetName} `);
                                createParticle(STATE.player.x, STATE.player.y, '#ec4899');
                                
                                // UPDATE: Modin langsung menawarkan pernikahan
                                showDialogue(npc.name, `MasyaAllah, calon pasanganmu **${targetName}** sudah hadir di sampingmu.\n\nLihatlah, dia tampak serasi dengan pakaian pengantin itu.\n\nApakah kamu sudah siap untuk melangsungkan akad nikah sekarang?`, 
                                    [
                                        {
                                            text: "Bismillah, Saya Siap! (Akad)", 
                                            action: () => {
                                                // 1. LOGIKA PERNIKAHAN (DATA)
                                                STATE.player.married = true;
                                                STATE.player.spouseId = targetId;
                                                STATE.player.reputation += 100;
                                                STATE.player.money += 5000;
                                                
                                                // 2. MAINKAN MUSIK & PARTIKEL
                                                if(typeof AudioService !== 'undefined') {
                                                    AudioService.playBGM('wedding'); 
                                                    AudioService.playSFX('item');    
                                                }
                                                
                                                // Efek Ledakan Partikel (Confetti)
                                                const confettiColors = ['#ef4444', '#f97316', '#facc15', '#4ade80', '#3b82f6', '#a855f7', '#ec4899', '#ffffff'];
                                                for(let i=0; i < 100; i++) {
                                                    const color = confettiColors[Math.floor(Math.random() * confettiColors.length)];
                                                    const speed = 2 + Math.random() * 6;
                                                    const angle = Math.random() * Math.PI * 2;
                                                    STATE.particles.push({
                                                        x: STATE.player.x + 10, y: STATE.player.y + 10,
                                                        vx: Math.cos(angle) * speed, vy: Math.sin(angle) * speed,
                                                        life: 60 + Math.random() * 40, color: color
                                                    });
                                                }
                                                
                                                // Efek Teks "SAH"
                                                spawnFloatingText(STATE.player.x, STATE.player.y - 60, "SAH!!!", "#fbbf24", 30);
                                                spawnFloatingText(STATE.player.x - 40, STATE.player.y - 40, "SAH!", "#ffffff", 15);
                                                spawnFloatingText(STATE.player.x + 40, STATE.player.y - 40, "SAH!", "#ffffff", 15);
                                                
                                                // --- START CUTSCENE CINEMATIC ---
                                                
                                                // A. Tutup Dialog & Kunci Game
                                                closeDialogue();
                                                STATE.screen = 'cutscene'; 
                                                STATE.cutsceneOverride = true; // Ambil alih kamera
                                                
                                                // B. Gerakkan Kamera ke Atas (Pan Up)
                                                let panCount = 0;
                                                const panInterval = setInterval(() => {
                                                    STATE.camera.y -= 1; // Geser kamera ke atas pelan-pelan
                                                    panCount++;
                                                    if(panCount > 200) clearInterval(panInterval); // Stop setelah beberapa saat
                                                }, 20);

                                                // C. Layar Gelap & Teks Muncul (Setelah 1 Detik)
                                                setTimeout(() => {
                                                    const layer = document.getElementById('cutscene-layer');
                                                    const txt = document.getElementById('cutscene-text');
                                                    const sub = document.getElementById('cutscene-sub');
                                                    
                                                    txt.innerText = "MENIKAH DENGAN BAHAGIA";
                                                    sub.innerText = `Selamat menempuh hidup baru bersama ${targetName}.\nSemoga cinta kalian abadi selamanya.`;
                                                    
                                                    layer.style.display = 'flex';
                                                    // Trigger animasi fade in CSS
                                                    requestAnimationFrame(() => layer.style.opacity = 1);
                                                }, 1000); 

                                                // D. Selesai Cutscene (Ganti Hari & Pindah ke Rumah)
                                                setTimeout(() => {
                                                    const layer = document.getElementById('cutscene-layer');
                                                    layer.style.opacity = 0; // Fade out hitam
                                                    
                                                    setTimeout(() => {
                                                        layer.style.display = 'none';
                                                        STATE.cutsceneOverride = false; // Kembalikan kamera ke player
                                                        
                                                        // --- LOGIKA BARU: BANGUN DI RUMAH BERSAMA PASANGAN ---
                                                        
                                                        // 1. Ganti Hari & Reset Status
                                                        STATE.day++;
                                                        STATE.time = 600; // 06:00 Pagi
                                                        STATE.player.energy = 100;
                                                        STATE.player.hp = STATE.player.maxHp;
                                                        
                                                        // 2. Pindah Lokasi ke Rumah
                                                        // FIX: Cek Role Wirausaha agar pulang ke Ruko, bukan Rumah Biasa
                                                        if (STATE.player.role === 'entrepreneur') {
                                                            STATE.location = 'player_shop_interior';
                                                            STATE.player.x = 5 * TILE_SIZE; // Posisi aman di Ruko (Dekat Telepon)
                                                            STATE.player.y = 3 * TILE_SIZE;
                                                        } else {
                                                            STATE.location = 'house';
                                                            STATE.player.x = 3 * TILE_SIZE; // FIX: Geser ke Tile 3 (Kanan Kasur) agar tidak STUCK di dalam kasur (Tile 1-2)
                                                            STATE.player.y = 2 * TILE_SIZE;
                                                        }
                                                        
                                                        STATE.player.direction = 'right';
                                                        
                                                        // 3. Regen Map Rumah (Agar Pasangan Muncul)
                                                        regenerateHouseMap();
                                                        
                                                        // 4. Resume Game
                                                        STATE.screen = 'play';
                                                        manualSave();
                                                        
                                                        // 5. Notifikasi & Dialog Pagi
                                                        showToast("Keesokan paginya... ");
                                                        
                                                        // Dialog sapaan dari pasangan (Delay dikit biar map load dulu)
                                                        setTimeout(() => {
                                                            const spouse = maps['house'].npcs.find(n => n.id === targetId);
                                                            if(spouse) {
                                                                // EFEK VISUAL CINTA PAGI HARI
                                                                createParticle(spouse.x * TILE_SIZE, spouse.y * TILE_SIZE, '#ec4899'); // Partikel Hati di Pasangan
                                                                createParticle(STATE.player.x, STATE.player.y, '#ec4899'); // Partikel Hati di Player
                                                                
                                                                // Mainkan suara manis
                                                                if(typeof AudioService !== 'undefined') AudioService.playSFX('item');

                                                                showDialogue(spouse.name, 
                                                                    "Selamat pagi sayang!  \n\nRasanya seperti mimpi kita sudah tinggal serumah.\nAku sangat bahagia bisa melihat wajahmu saat bangun tidur.\n\nSemoga hari ini menyenangkan ya!", 
                                                                    [{
                                                                        text: "Pagi juga cintaku! (Cium Kening)", 
                                                                        action: () => {
                                                                            createParticle(STATE.player.x, STATE.player.y, '#fbbf24'); // Efek senang
                                                                            closeDialogue();
                                                                        }
                                                                    }], 
                                                                    spouse.imgSrc
                                                                );
                                                            }
                                                        }, 1500);

                                                    }, 2000); // Tunggu fade out selesai
                                                }, 7000); // Durasi total cutscene
                                            }
                                        },
                                        {
                                            text: "Sebentar Pak, saya grogi...", 
                                            action: closeDialogue
                                        }
                                    ], 
                                    npc.imgSrc
                                );
                            };

                            if (gender === 'boy') {
                                opts = [
                                    {text: "Ayu (Gadis Desa yg Ceria)", action: () => setFiance('lover1girl', 'Ayu')},
                                    {text: "Putri (Mahasiswi Pintar)", action: () => setFiance('lover2girl', 'Putri')}
                                ];
                            } else {
                                opts = [
                                    {text: "Dr. Budi (Dokter Ramah)", action: () => setFiance('lover1boy', 'Dr. Budi')},
                                    {text: "Satria (Ksatria Tegas)", action: () => setFiance('lover2boy', 'Satria')}
                                ];
                            }
                            
                            opts.push({text: "Saya pikir-pikir dulu...", action: closeDialogue});

                            showDialogue(npc.name, "Alhamdulillah niatnya sudah lurus.\n\nLalu, **dengan siapa** kamu ingin menikah? Tentukan pilihan hatimu sekarang.", opts, npc.imgSrc);
                        }
                    },
                    {
                        text: "Waduh, saya jadi ragu...", 
                        action: () => {
                            showDialogue(npc.name, "Keraguan adalah tanda belum siap. Pulanglah, tenangkan hatimu dulu.", [{text:"Baik Pak", action:closeDialogue}], npc.imgSrc);
                        }
                    }
                ], 
                npc.imgSrc
            );
        } else {
            // Dialog untuk Non-Family Role
            showDialogue(npc.name, "Selamat datang di Balai Pernikahan.\nTempat ini suci bagi mereka yang ingin mengikat janji setia.\n\n(Kamu belum memilih Role Menikah/Family)", [{text:"Permisi Pak", action:closeDialogue}], npc.imgSrc);
        }
    }

    else if(npc.id === 'blacksmith') {
        showDialogue("KEPALA BENGKEL", "Dunia kerja butuh bukti, bukan janji. Mau konsultasi karir atau beli perlengkapan?", [
            /* UPDATE: Hapus Beli Baju Pengantin dari sini (Pindah ke Istri) */
            {text: " Beli Cincin (Shop)", action: () => {
                showDialogue("TOKO BENGKEL", "Saya menempa logam menjadi perhiasan kuat. Mau beli apa?", [
                    /* UPDATE: Harga Cincin Kayu jadi 50.000 */
                    {text: "Cincin Kayu (50.000 G) ", action: () => buyItem('cincin_kayu', 50000)},
                    {text: "Kembali", action: () => interactNPC(npc)}
                ], npc.imgSrc);
            }},
            {text: "Tentang CV", action: () => showDialogue("KEPALA BENGKEL", "Buat CV yang jujur dan menarik. Cantumkan skill nyata dan pengalaman organisasi/magang.", [{text:"Oke", action:closeDialogue}], npc.imgSrc)},
            {text: "Etika Kerja", action: () => showDialogue("KEPALA BENGKEL", "Datang tepat waktu. Hormati atasan dan rekan. Inisiatif tinggi. Itu kunci bertahan di industri.", [{text:"Siap Bos", action:closeDialogue}], npc.imgSrc)},
            {text: "Tutup", action: closeDialogue}
        ], npc.imgSrc);
    }

    /* NEW: INTERAKSI MARINE (PENJAHIT) */
    else if(npc.id === 'marine_tailor') {
        showDialogue(npc.name, "Halo! Selamat datang di bengkel kami. \nSuami saya mengurus besi yang keras, saya yang melembutkannya dengan kain. Butuh sesuatu?", [
            /* UPDATE: Harga Baju Pengantin jadi 150.000 */
            {text: " Beli Baju Pengantin (150.000 G)", action: () => {
                // Konfirmasi Pembelian
                showDialogue("BUTIK MARINE", "Baju pengantin buatan saya menggunakan sutra terbaik. Sangat anggun untuk hari bahagiamu.", [
                    {text: "Beli (150.000 G)", action: () => buyItem('pakaian_nikah', 150000)},
                    {text: "Lihat-lihat dulu", action: () => interactNPC(npc)}
                ], npc.imgSrc);
            }},
            {text: "Tentang Suami (Blacksmith)", action: () => {
                showDialogue(npc.name, "Suami saya terlihat garang, tapi sebenarnya hatinya lembut kok. \nDia suka sekali kalau dibawakan **Bijih Besi** untuk bekerja atau **Tonic Stamina** saat lelah.", [{text:"Terima kasih infonya Bu", action:closeDialogue}], npc.imgSrc);
            }},
            {text: "Sedang menjahit apa?", action: () => {
                showDialogue(npc.name, "Saya sedang mengerjakan pesanan jubah untuk Guild Petualang. Kainnya harus anti-gores tapi tetap ringan.", [{text:"Keren...", action:closeDialogue}], npc.imgSrc);
            }},
            {text: "Dah Bu", action: closeDialogue}
        ], npc.imgSrc);
    }

    // --- NEW: INTERAKSI SENIOR TEKNOLOGI (PENGGANTI DOSEN DI LUAR) ---
    else if(npc.id === 'sarjana_tekno') {
        showDialogue(npc.name, "Yo! Mahasiswa baru ya? \nKalau mau masuk jurusan Teknologi, siap-siap begadang coding ya! Hahaha.", [
            {text: "Ada tips kuliah?", action: () => {
                showDialogue(npc.name, "Dosen di dalam itu **Killer** banget soal waktu. Kuliah mulai jam 08:00, kalau lewat 08:30 pintu dikunci. \nJangan telat kalau gak mau diusir!", [{text:"Makasih infonya kak!", action:closeDialogue}], npc.imgSrc);
            }},
            {text: "Tentang Jurusan", action: () => {
                showDialogue(npc.name, "Jurusan Teknologi fokus ke **INT (Intelligence)**. Rajin-rajin baca buku di Perpus biar nilaimu bagus.", [{text:"Siap", action:closeDialogue}], npc.imgSrc);
            }},
            {text: "Dah Kak", action: closeDialogue}
        ], npc.imgSrc);
    }

    // --- NEW: INTERAKSI KAIA (SENIOR PSIKOLOGI - ADAPTASI SOSIAL) ---
    else if(npc.id === 'senior_kaia') {
        const p = STATE.player;
        const rel = p.relationships[npc.id] || 0;
        
        // FASE 1: ANAK BARU (Relationship 0-20) - Pengenalan & Culture Shock
        if (rel < 20) {
            showDialogue(npc.name, "Hai, kamu siswi baru itu kan? Kelihatan banget dari cara jalanmu yang masih bingung. \nSini duduk, jangan tegang gitu. Adaptasi di Pulau Arsa itu emang *tricky*.", [
                {text: "Warga sini kok dingin ya?", action: () => {
                    showDialogue(npc.name, "Nah, itu dia! Warga sini punya **'Trust Issue'**. \nSecara psikologis, mereka gak benci kamu, mereka cuma *defensive*. \n\nTips pertama: **Jangan Baper**. Tetap sapa mereka walau dicuekin. Itu namanya *Exposure Effect*. Makin sering mereka liat mukamu, makin luluh tembok mereka.", 
                    [{text: "Ooh gitu... makasih Kak!", action: () => {
                        updateRelationship(npc, 5, "Mentor");
                        closeDialogue();
                    }}], npc.imgSrc);
                }},
                {text: "Cara biar cepat akrab?", action: () => {
                    showDialogue(npc.name, "Rumus sosial di sini simpel: **Sapa + Bantu + Hadiah**. \nJangan cuma lewat doang. Interaksi itu mata uang sosial. \n\nCoba deh mulai dari hal kecil kayak ngasih Bunga liar ke Gadis Desa. Itu *gesture* kecil tapi *impact*-nya gede.", 
                    [{text: "Siap dicoba!", action: closeDialogue}], npc.imgSrc);
                }},
                {text: "Dah Kak", action: closeDialogue}
            ], npc.imgSrc);
        }
        
        // FASE 2: MULAI BERGAUL (Relationship 20-60) - Tips Spesifik & Love Language
        else if (rel < 60) {
            showDialogue(npc.name, "Hei! Kulihat kamu mulai luwes ya keliling desa. Gimana progresnya?", [
                {text: "Ada yang suka, ada yang enggak...", action: () => {
                    showDialogue(npc.name, "Wajar! Tiap orang punya **'Bahasa Cinta'** beda-beda. \n\nContoh: Si Matre itu tipe *Receiving Gifts* (harus barang mahal). Tapi kalau Pak Nelayan atau Satria, mereka tipe *Acts of Service* (suka kalau kamu rajin kerja/kuat). \n\nKenali pola mereka, jangan pukul rata semua dikasih Bunga.", 
                    [{text: "Wah, analisis mantap!", action: () => {
                        updateRelationship(npc, 2, "Mentor");
                        closeDialogue();
                    }}], npc.imgSrc);
                }},
                {text: "Aku capek basa-basi...", action: () => {
                    showDialogue(npc.name, "Itu namanya *Social Fatigue*. Istirahat dulu gih di kasur. \nIngat, energi sosial kamu (Energy Bar) itu terbatas. \nJangan paksain *People Pleasing* ke semua orang dalam satu hari. Fokus ke 1-2 orang dulu aja.", 
                    [{text: "Bener juga...", action: closeDialogue}], npc.imgSrc);
                }}
            ], npc.imgSrc);
        }
        
        // FASE 3: DITERIMA MASYARAKAT (Relationship > 60) - Analisis Perubahan & Validasi
        else {
            showDialogue(npc.name, `Wah, aura kamu beda banget sekarang! Lebih percaya diri. \nKamu sadar gak sih perubahan sikap warga ke kamu?`, [
                {text: "Mereka jadi lebih ramah...", action: () => {
                    showDialogue(npc.name, "Itu fase **'Social Acceptance'**. \nDulu mereka liat kamu sebagai *Outsider* (Orang Asing), sekarang kamu udah jadi *Insider* (Keluarga). \n\nLiat deh, mata mereka kalau ngomong sekarang natap kamu, bukan buang muka. Senyum mereka tulus, bukan sopan santun doang. \nSelamat ya, kamu berhasil menaklukkan hati Pulau Arsa! ", 
                    [{text: "Berkat tips Kakak juga!", action: () => {
                        updateRelationship(npc, 2, "Bestie");
                        createParticle(npc.x*TILE_SIZE, npc.y*TILE_SIZE, '#fbbf24');
                        closeDialogue();
                    }}], npc.imgSrc);
                }},
                {text: "Tips terakhir dong Kak", action: () => {
                    showDialogue(npc.name, "Sekarang, tinggal maintain aja. Hubungan itu kayak tanaman, harus disiram terus. \n\nOiya, hati-hati sama **Toxic Relationship**. Kalau ada NPC yang cuma manfaatin duit kamu (ehem... si Matre), mending *Cut Off* aja. Kesehatan mentalmu lebih penting!", 
                    [{text: "Siap laksanakan!", action: closeDialogue}], npc.imgSrc);
                }}
            ], npc.imgSrc);
        }
    }

    // --- NEW: INTERAKSI SARJANA SEJARAH (DI RERUNTUHAN) ---
    else if(npc.id === 'sarjana_sejarah') {
        showDialogue(npc.name, "Hati-hati melangkah. Puing-puing di hutan ini bukan batu biasa, ini adalah sisa peradaban **Aethelgard**.", [
            {text: "Ceritakan Sejarahnya", action: () => {
                showDialogue(npc.name, "Dulu, pulau ini dihuni oleh kaum penyihir bijak. Mereka musnah karena mencoba menyerap energi Dungeon secara berlebihan. \nSaya di sini mencoba menerjemahkan prasasti yang tersisa.", [{text:"Menarik...", action:closeDialogue}], npc.imgSrc);
            }},
            {text: "Tentang Jurusan Sejarah", action: () => {
                showDialogue(npc.name, "Jika kamu masuk jurusan Sejarah, **REP (Reputation)** mu akan meningkat lebih cepat. Orang lebih menghargai mereka yang tahu asal-usulnya.", [{text:"Terima kasih infonya", action:closeDialogue}], npc.imgSrc);
            }},
            {text: "Permisi", action: closeDialogue}
        ], npc.imgSrc);
    }

    // --- NEW: INTERAKSI SATPAM KAMPUS ---
    else if(npc.id === 'satpam') {
        // ... existing satpam logic ...
        // Cek waktu: Malam (18:00 - 06:00) vs Siang
        const isNight = STATE.time >= 1800 || STATE.time < 600;

        if (isNight) {
            // --- DIALOG MALAM (AKRAB & INSPIRATIF) ---
            showDialogue(npc.name, "Malam-malam begini masih keluyuran, Nak? \nAngin malam di sini jahat, tapi tidak sejahat putus cinta. Hahaha.\n\n(Satpam terlihat santai sambil menyeruput kopi panas)", [
                {text: "Bapak belum tidur?", action: () => {
                    showDialogue(npc.name, "Mata ini sudah terlatih terjaga, Nak. \nDulu waktu Bapak seusiamu, Bapak kerja serabutan pagi-siang-malam demi biayai adik-adik sekolah. \n\nLelah? Pasti. Tapi saat melihat mereka jadi sarjana, hilang semua capeknya. Perjuangan itu manis di akhir.", [{text:"Bapak hebat sekali...", action:closeDialogue}], npc.imgSrc);
                }},
                {text: "Sedang apa Pak?", action: () => {
                    showDialogue(npc.name, "Biasalah, ngopi sambil dengerin suara jangkrik. Kadang sepi itu menenangkan. \n\nKamu kalau pusing tugas kuliah, istirahatlah sebentar di sini. Dunia gak akan kiamat kok kalau kamu tarik napas sejenak.", [{text:"Terima kasih Pak", action:closeDialogue}], npc.imgSrc);
                }},
                {text: "Saya cuma lewat", action: closeDialogue}
            ], npc.imgSrc);
        } else {
            // --- DIALOG SIANG (TEGAS & DISIPLIN) ---
            showDialogue(npc.name, "STOP! Tunjukkan kartu mahasiswa. \nTugas saya menjaga keamanan kampus dari mahasiswa abadi dan monster liar.", [
                {text: "Siap Pak (Hormat)", action: () => {
                    showToast("Satpam mengangguk tegas.");
                    closeDialogue();
                }},
                {text: "Tanya Aturan Masuk", action: () => {
                    showDialogue(npc.name, "Dengar baik-baik! \n1. Kuliah mulai jam 08:00. \n2. Telat lewat 08:30, gerbang saya kunci! \n3. Dilarang bawa senjata tajam ke dalam kelas, kecuali jurusan Fighter.", [{text:"Siap Pak", action:closeDialogue}], npc.imgSrc);
                }},
                {text: "Saya cuma lewat", action: closeDialogue}
            ], npc.imgSrc);
        }
    }

    // --- NEW: INTERAKSI PUSTAKAWAN (LIBRARIAN) ---
    else if(npc.id === 'librarian') {
        // BANK DATA TIPS BELAJAR & LITERASI
        const STUDY_TIPS = [
            " **Teknik Pomodoro**: Belajar fokus selama 25 menit, lalu istirahat 5 menit. Otak butuh jeda untuk menyerap informasi.",
            " **Literasi**: Membaca bukan sekadar mengeja huruf, tapi memahami makna dan konteks. Jangan telan informasi mentah-mentah!",
            " **Mencatat**: Tulislah poin penting dengan tangan. Koneksi saraf tangan ke otak memperkuat memori jangka panjang.",
            " **Feynman Technique**: Cara terbaik menguji pemahamanmu adalah dengan mencoba menjelaskannya kepada orang lain dengan bahasa sederhana.",
            " **Kutipan**: 'Buku adalah jendela dunia, dan kuncinya adalah membaca.' - Jangan malas buka buku ya!",
            " **Tidur**: Jangan begadang SKS (Sistem Kebut Semalam). Tidur yang cukup justru membantu konsolidasi memori hafalanmu.",
            " **Validasi**: Di era informasi ini, saringlah berita (hoaks) dengan membaca dari berbagai sumber terpercaya."
        ];

        // BANK DATA LORE PULAU ARSA
        const ARSA_LORE = [
            "Pulau Arsa ini dulunya bagian dari kerajaan kuno bernama **Aethelgard**. Konon, mereka peradaban yang sangat maju dalam sihir dan teknologi.",
            "Nama 'Arsa' diambil dari bahasa Sanskerta kuno yang berarti 'Kegembiraan' atau 'Harapan'. Pulau ini adalah harapan terakhir bagi mereka yang ingin memperbaiki hidup.",
            "Hutan di sebelah barat desa itu... di sana banyak reruntuhan tua. Katanya di bawah tanahnya tersimpan perpustakaan raksasa yang terkubur.",
            "Dungeon di timur pulau sebenarnya adalah 'Penjara Dimensi'. Monster di sana adalah manifestasi dari emosi negatif manusia masa lalu.",
            "Ada legenda tentang **Cincin Raja**. Katanya, siapa pun yang memakainya akan memiliki karisma yang tak tertandingi."
        ];

        // BANK DATA CLUE DEWI ARSA
        const DEWI_CLUES = [
            "Sstt... pernah dengar legenda **Dewi Arsa**? Katanya dia roh pelindung pulau ini yang sangat cantik.",
            "Dewi Arsa sangat pemalu. Dia tidak muncul sembarangan. Dia hanya menampakkan diri saat energi bulan sedang di puncaknya.",
            "Catatan kuno menyebutkan: 'Sang Dewi akan turun di dekat **Patung Peringkat** saat malam **Bulan Purnama**'.",
            "Coba cek Kalendermu. Bulan Purnama biasanya terjadi di **Musim Panas (Summer)**, sekitar tanggal **23**. Datanglah tepat tengah malam (00:00).",
            "Hanya hati yang bersih yang bisa melihatnya. Dan mungkin... dia membawa berkah bagi mereka yang menemukannya."
        ];

        showDialogue("PUSTAKAWAN", "Sstt... Harap tenang di dalam perpustakaan. \nBuku adalah teman yang paling setia. Ada yang bisa saya bantu?", [
            {
                text: " Minta Tips Belajar", 
                action: () => {
                    const tip = STUDY_TIPS[Math.floor(Math.random() * STUDY_TIPS.length)];
                    // Reward kecil INT karena belajar
                    if(Math.random() < 0.3) {
                        STATE.player.int += 1;
                        showToast("INT +1 (Wawasan Bertambah)");
                    }
                    showDialogue("CATATAN PUSTAKAWAN", tip, [{text:"Terima kasih ilmunya!", action:()=>interactNPC(npc)}], npc.imgSrc);
                }
            },
            {
                text: " Tentang Pulau Arsa (Lore)", 
                action: () => {
                    const lore = ARSA_LORE[Math.floor(Math.random() * ARSA_LORE.length)];
                    showDialogue("ARSIP KUNO", `"${lore}"`, [{text:"Menarik...", action:()=>interactNPC(npc)}], npc.imgSrc);
                }
            },
            {
                text: " Rumor Dewi Arsa", 
                action: () => {
                    const clue = DEWI_CLUES[Math.floor(Math.random() * DEWI_CLUES.length)];
                    showDialogue("BISIKAN PUSTAKAWAN", clue, [{text:"Aku akan mengingatnya", action:()=>interactNPC(npc)}], npc.imgSrc);
                }
            },
            {text: "Hanya baca buku", action: closeDialogue}
        ], npc.imgSrc);
    }

    // --- NEW: INTERAKSI DOSEN / SCHOLAR (KHUSUS MAHASISWA & ATURAN TELAT) ---
    else if(npc.id === 'lecture') {
        const currentYear = Math.ceil(STATE.day / 120);
        // Cek Eligibility: Role Student ATAU Sudah Tahun ke-4 (Lulus Trial) ATAU Free Roam
        const isEligible = STATE.player.role === 'student' || currentYear >= 4 || STATE.freeRoamMode;

        // --- NEW: RESTRIKSI ROLE UNTUK NON-STUDENT (TRIAL < TAHUN 4) ---
        if (!isEligible) {
            showDialogue("DOSEN PEMBIMBING", 
                "Maaf, pendaftaran akademik saat ini **KHUSUS** untuk Role **Mage/Mahasiswa**.\n\nKamu harus fokus pada kewajiban Role-mu sendiri selama masa Trial 3 Tahun ini. Jangan memecah fokusmu.", 
                [
                    {text: "Lihat Info Umum Kampus", action: () => {
                        showDialogue("DOSEN PEMBIMBING", "Kampus ini tempat menempa ilmu (INT). Jika kamu tertarik, mungkin kamu bisa mengambil kelas ekstensi setelah masa Trial selesai (Tahun ke-4).", [{text:"Baik Pak", action:closeDialogue}], npc.imgSrc);
                    }},
                    {text: "Permisi", action: closeDialogue}
                ], 
                npc.imgSrc
            );
            return;
        }
        
        // --- NEW: LOGIKA PENGUSIRAN JIKA SUDAH DI DALAM TAPI TELAT ---
        // Jika pemain ada di dalam kelas (school_interior) dan waktu sudah lewat 08:30
        if (STATE.location === 'school_interior' && STATE.time > 830 && STATE.time < 1400) {
             // Mainkan efek marah/gebrak meja (jika ada SFX hit)
             if(typeof AudioService !== 'undefined') AudioService.playSFX('hit');

             showDialogue("DOSEN KILLER", "KAMU!! Jam berapa ini?!  \nSaya tidak mentolerir keterlambatan. Mahasiswa tidak disiplin tidak punya tempat di kelas saya. \n\nKELUAR SEKARANG!", [
                 {text: "Maaf Pak... (Diusir Paksa)", action: () => {
                     // Teleport Paksa ke Luar Kampus
                     STATE.location = 'village';
                     STATE.player.x = 41 * TILE_SIZE; 
                     STATE.player.y = 16 * TILE_SIZE; // Depan pintu kampus
                     
                     // Kurangi Reputasi/Nilai sedikit sebagai hukuman
                     STATE.player.int = Math.max(0, STATE.player.int - 1);
                     
                     closeDialogue();
                     showToast(" Diusir dari Kelas! (INT -1)");
                 }}
             ], npc.imgSrc);
             return; // Stop interaksi normal
        }

        // --- NEW: LOGIKA PENDAFTARAN JURUSAN DI KAMPUS ---
        // Jika belum punya jurusan (Entah Maba atau Old Player yang baru mau kuliah di Thn 4)
        if (!STATE.player.major) {
            showDialogue("DOSEN", "Ah, calon mahasiswa baru? Mentor Budi sudah mengabari saya.\nSilakan pilih fakultas yang ingin kamu ambil untuk masa studimu:", [
                {text: "1. Teknologi (INT +3, Logika)", action: () => selectMajor('teknologi')},
                {text: "2. Sejarah (REP +5, Sosial)", action: () => selectMajor('sejarah')}
            ], npc.imgSrc);
            return;
        }

        // MENU UTAMA MAHASISWA
        let text = "Ah, mahasiswaku. Ada yang bisa saya bantu hari ini?";
        let actions = [
            // --- NEW FEATURE: ISI DAFTAR HADIR + MATERI KULIAH ---
            {text: " Isi Daftar Hadir & Kuliah", action: () => {
                // Cek Waktu Kuliah (08:00 - 14:00)
                if (STATE.time >= 800 && STATE.time <= 1400) {
                    
                    // HELPER: Show Lecture Content (Fungsi Pembantu untuk menampilkan materi)
                    const showLectureMaterial = (isReview = false) => {
                        try {
                            const major = STATE.player.major || 'teknologi';
                            let materials = [];
                            if (typeof COURSE_MATERIALS !== 'undefined' && COURSE_MATERIALS[major]) {
                                materials = COURSE_MATERIALS[major];
                            }
                            
                            // Fallback jika array kosong
                            // UPDATE: Gunakan progress akademik (jumlah materi yg sudah dipelajari), BUKAN hari kalender (STATE.day).
                            // Ini agar jika mendaftar telat (misal hari 100), tetap mulai dari materi pertama.
                            let progressCount = (STATE.player.learnedSubjects || []).length;
                            
                            // Jika Mode Review (sudah absen hari ini), berarti materi baru saja ditambahkan ke array.
                            // Kita harus mundur 1 index untuk menampilkan materi yang barusan dipelajari.
                            if (isReview && progressCount > 0) progressCount--;

                            const matIndex = progressCount % (materials.length || 1);
                            const content = materials[matIndex] || {t: "Review Materi Dasar", c: "Membaca ulang catatan untuk memperkuat pemahaman dasar."};
                            
                            const oldTime = Math.floor(STATE.time / 100);
                            // Tampilkan info waktu berbeda jika review
                            const timeInfo = isReview ? "(Mode Review: Kamu sudah mengikuti kelas ini)" : `(Kamu mengikuti kelas dari jam ${oldTime}:00 hingga 14:00)`;
                            
                            showDialogue(`MATERI KULIAH (PERTEMUAN KE-${progressCount + 1})`, 
                                `**MATA KULIAH: ${content.t}**\n\n"${content.c}"\n\n${timeInfo}`, 
                                [{text: isReview ? "Tutup" : "Catat & Pulang (INT +2, EXP +100)", action: () => {
                                    if(!isReview) {
                                        // Hanya dapat reward jika bukan review
                                        STATE.player.int += 2; 
                                        gainExp(100);
                                        
                                        // --- FIX: SIMPAN MATERI KE MEMORI PEMAIN (UNTUK BELAJAR MANDIRI) ---
                                        if (!STATE.player.learnedSubjects) STATE.player.learnedSubjects = [];
                                        
                                        // Cek duplikasi agar tidak menyimpan materi yang sama berkali-kali
                                        const alreadyLearned = STATE.player.learnedSubjects.some(s => s.t === content.t);
                                        if (!alreadyLearned) {
                                            STATE.player.learnedSubjects.push(content);
                                        }

                                        showToast(" Kuliah Selesai. Catatan Disimpan!");
                                    }
                                    closeDialogue();
                                }}], 
                                npc.imgSrc
                            );
                        } catch(e) {
                            console.error("Lecture Error:", e);
                            showDialogue("DOSEN", "Sistem materi sedang gangguan. Silakan lapor Developer.", [{text:"Tutup", action:closeDialogue}], npc.imgSrc);
                        }
                    };

                    // Cek apakah sudah absen hari ini
                    if (STATE.player.lastAttendanceDay === STATE.day) {
                        // FIX: Jika sudah absen, tawarkan Review agar materi tetap bisa dibaca
                        showDialogue("DOSEN", "Kamu sudah tercatat hadir hari ini. Apakah kamu ingin membaca ulang materi tadi?", [
                            {text: "Ya, Review Materi", action: () => showLectureMaterial(true)},
                            {text: "Tidak, Terima kasih", action: closeDialogue}
                        ], npc.imgSrc);
                    } else {
                        // FIX: Tutup dialog lama dulu agar tidak tumpang tindih
                        closeDialogue();
                        showToast(" Mengikuti Kuliah...");

                        // PROSES ABSEN BERHASIL
                        STATE.player.lastAttendanceDay = STATE.day;
                        
                        // UPDATE: SKIP WAKTU KE 14:00 & KURANGI ENERGI
                        const oldTime = Math.floor(STATE.time / 100);
                        STATE.time = 1400; // Set langsung ke jam 14:00
                        STATE.player.energy = Math.max(0, STATE.player.energy - 20); // Lelah belajar (-20 Energy)
                        
                        if(typeof AudioService !== 'undefined') AudioService.playSFX('item');
                        
                        // --- UPDATE: LOGIKA MATERI KULIAH (MUNCUL SETIAP HARI) ---
                        setTimeout(() => {
                            showLectureMaterial(false); // false = bukan review (dapat reward)
                        }, 1000); // Jeda 1 detik agar terasa transisinya
                    }
                } else {
                    // Di luar jam kuliah (Sore Hari / Terlalu Pagi)
                    let msg = "Daftar hadir hanya bisa diisi saat jam kuliah berlangsung (08:00 - 14:00).";
                    
                    // Respon Khusus Sesi Sore
                    if (STATE.time >= 1400 && STATE.time < 1800) {
                        msg = "Kuliah reguler hari ini sudah selesai. Sekarang adalah jam kegiatan mandiri atau UKM. \nSilakan gunakan fasilitas kampus untuk belajar atau bimbingan, tapi absen tidak dihitung.";
                    }
                    
                    showDialogue("DOSEN", msg, [{text:"Baik Pak", action:closeDialogue}], npc.imgSrc);
                }
            }},
            
            {text: "Bimbingan Skripsi (Energy -10, INT+1)", action: () => {
                if(STATE.player.energy >= 10) {
                    STATE.player.energy -= 10;
                    STATE.player.int += 1;
                    showToast("INT +1 (Bimbingan)");
                    // Update quest tracking jika perlu
                    showDialogue("DOSEN", "Teorimu menarik. Lanjutkan risetnya, jangan lupa referensi dari Perpustakaan.", [{text:"Terima kasih Pak", action:closeDialogue}], npc.imgSrc);
                } else showToast("Terlalu lelah untuk mikir...");
            }},
            {text: "Tanya Jadwal Kuliah", action: () => {
                showDialogue("DOSEN", "Kuliah dimulai jam 08:00 pagi sampai 14:00 siang di Gedung Kampus. Jangan telambat!", [{text:"Siap", action:closeDialogue}], npc.imgSrc);
            }},
            
            // --- UPDATE: FITUR SKRIPSI (DIBATASI TAHUN KE-4) ---
            {text: " Info & Sidang Skripsi", action: () => {
                // Hitung Tahun Saat Ini (1 Tahun = 120 Hari)
                const currentYear = Math.ceil(STATE.day / 120);

                // KONDISI 1: BELUM TAHUN KE-4 (Hanya Motivasi)
                if (currentYear < 4) {
                    showDialogue("DOSEN PEMBIMBING", 
                        `Wah, semangatmu bagus! Tapi kamu masih di **Tahun ke-${currentYear}**.\nPengajuan Proposal Skripsi baru dibuka untuk mahasiswa tingkat akhir (**Tahun ke-4**).\n\nIngat nasihat saya: "Gedung yang tinggi membutuhkan fondasi yang dalam."\n\nJangan terburu-buru lulus. Nikmati proses belajarmu, perbanyak baca buku, dan bangun koneksi. Kesuksesan menanti mereka yang matang secara ilmu, bukan yang sekadar cepat.`, 
                        [{text: "Terima kasih motivasinya, Pak! (Semangat)", action: closeDialogue}], 
                        npc.imgSrc
                    );
                    return;
                }

                // KONDISI 2: SUDAH TAHUN 4 (Cek Syarat Akademik)
                // Syarat: Level 15 (Soft Skill) & INT 50 (Hard Skill)
                if (STATE.player.level < 15 || STATE.player.int < 50) {
                    showDialogue("DOSEN", "Kamu sudah masuk tingkat akhir, tapi bekal ilmumu masih kurang.\n\nSyarat Pengajuan:\n- Level Karakter Min. 15\n- Intelligence (INT) Min. 50\n\nKembalilah belajar di perpustakaan atau ikuti kuliah lebih rajin.", [{text:"Baik Pak, saya akan berusaha", action:closeDialogue}], npc.imgSrc);
                    return;
                }

                // --- PERBAIKAN INTEGRASI QUEST: CEK ITEM DRAFT PROPOSAL ---
                // KONDISI 3: CEK FISIK DOKUMEN (Hard Gate)
                // Pemain WAJIB menyelesaikan Quest "Hilangnya Skripsi Senior" dulu
                const hasDraft = (STATE.player.inventory['draft_proposal'] || 0) > 0;
                
                if (!hasDraft) {
                    showDialogue("DOSEN KILLER", 
                        "Kamu mau mengajukan sidang dengan tangan kosong? \n\nSaya dengar **Senior Kutubuku** di Perpustakaan sedang mencari orang untuk membantu risetnya. \n\nTemui dia dulu. Kalau kamu bisa membantunya, mungkin dia akan memberikan salinan **Draft Proposal** yang layak sebagai referensi untukmu.\n\nJangan kembali ke sini sebelum membawa dokumen fisik!", 
                        [{text: "Baik Pak, saya ke Perpus dulu! (Mulai Quest)", action: closeDialogue}], 
                        npc.imgSrc
                    );
                    return;
                }

                // 4. PROSES PENGAJUAN & REVIEW (ACC / REVISI)
                const major = STATE.player.major || 'teknologi'; // Default Teknologi
                
                // UPDATE: Icon Draft Skripsi disesuaikan dengan permintaan
                let draftImg = 'images/draftskripsi-teknologi.png'; 
                let draftTitle = "RANCANG BANGUN AI PEMANTAU DUNGEON";
                
                if (major === 'sejarah') {
                    draftImg = 'images/draftskripsi-sejarah.png';
                    draftTitle = "ANALISIS RUNTUHNYA KERAJAAN AETHELGARD";
                }

                // Tampilkan Dialog Penyerahan dengan Animasi Review
                showDialogue("PENGAJUAN PROPOSAL", 
                    `Kamu menyerahkan dokumen **${draftTitle}** ke meja Dosen.\n\nDosen sedang membaca dengan teliti... (Jantung berdebar...)`, 
                    [{
                        text: "Tunggu Hasil Review...", 
                        action: () => {
                            // --- LOGIKA ACC DOSEN ---
                            // Peluang ACC dipengaruhi oleh INT pemain.
                            // Base Chance: 40% + (INT - 50)%. 
                            // Jika INT 50 -> 40% Chance. Jika INT 100 -> 90% Chance.
                            let chance = 40 + (STATE.player.int - 50);
                            if (chance > 90) chance = 90; // Cap max 90% biar ada deg-degan dikit
                            
                            const roll = Math.random() * 100;
                            
                            if (roll < chance) {
                                // --- SKENARIO ACC (DITERIMA) ---
                                if(typeof AudioService !== 'undefined') AudioService.playSFX('item'); // Sound Happy
                                
                                showDialogue("STATUS: DI-ACC! ", 
                                    `DOSEN: "Hmm... Menarik.\nLatar belakang kuat, metodologi rapi, dan referensi valid.\n\nOke, saya **ACC** proposal ini. Kamu boleh lanjut ke tahap Sidang Skripsi sekarang."\n\n(Selamat! Proposalmu disetujui)`, 
                                    [{
                                        text: "Alhamdulillah! SIAP SIDANG!", 
                                        action: () => {
                                            closeDialogue();
                                            startThesisDefense(major);
                                        }
                                    }, {
                                        text: "Nanti dulu pak, mau belajar lagi", 
                                        action: closeDialogue
                                    }], 
                                    draftImg
                                );
                            } else {
                                // --- SKENARIO REVISI (DITOLAK) ---
                                if(typeof AudioService !== 'undefined') AudioService.playSFX('hit'); // Sound Sad/Hit
                                
                                // Kurangi Energy sebagai penalti stress
                                STATE.player.energy = Math.max(0, STATE.player.energy - 15);
                                
                                showDialogue("STATUS: REVISI (DITOLAK) ", 
                                    `DOSEN: "Apa ini?! \nRumusan masalahmu kabur! Datanya tidak sinkron! Typo dimana-mana!\n\nSaya tidak mau tanda tangan kalau masih begini. **REVISI ULANG SEKARANG!**"\n\n(Dosen melempar naskahmu. Kamu merasa stress. Energi -15)`, 
                                    [{
                                        text: "Maaf Pak, saya perbaiki... (Coba Lagi)", 
                                        action: () => {
                                            if (STATE.player.energy < 15) {
                                                showToast("Terlalu lelah & stress untuk revisi...");
                                                closeDialogue();
                                            } else {
                                                showToast("Sedang merevisi naskah... ");
                                                // Loop balik ke interaksi awal seolah memperbaiki
                                                interactNPC(npc);
                                            }
                                        }
                                    }, {
                                        text: "Pulang dulu (Menangis di pojokan)", 
                                        action: closeDialogue
                                    }], 
                                    npc.imgSrc
                                );
                            }
                        }
                    }], 
                    draftImg
                );
            }},

            {text: "Tutup", action: closeDialogue}
        ];
        
        showDialogue("DOSEN PEMBIMBING", text, actions, npc.imgSrc);
    }

    // --- NEW: INTERAKSI KHUSUS HEWAN (ELUS-ELUS) ---
    else if(npc.type === 'animal') {
        let animalSound = "...";
        if(npc.id.includes('ayam')) animalSound = "Petok petok! ";
        else if(npc.id.includes('kambing')) animalSound = "Mbekkk! ";
        else if(npc.id.includes('sapi')) animalSound = "Mooo! ";
        else if(npc.id.includes('kuda')) animalSound = "Hiihaaa! ";

        showDialogue(npc.name, `"${animalSound}" \n(Hewan ini menatapmu dengan lucu)`, [
            {text: " Elus-elus (Pet)", action: () => {
                // Trigger efek hati visual
                npc.loveTimer = 60; 
                
                // --- UPDATE: UBAH GAMBAR SAPI SAAT DIELUS ---
                if(npc.id.includes('sapi')) {
                    npc.imgSrc = 'images/sapi-elus.png';
                    npc.loadedImg = null; // Paksa render ulang gambar baru
                    
                    // Kembalikan ke gambar semula setelah 3 detik
                    setTimeout(() => {
                        npc.imgSrc = 'images/sapi.png';
                        npc.loadedImg = null;
                    }, 3000);
                }
                // --- UPDATE: UBAH GAMBAR KAMBING SAAT DIELUS ---
                else if(npc.id.includes('kambing')) {
                    npc.imgSrc = 'images/kambing-elus.png';
                    npc.loadedImg = null; 
                    
                    // Kembalikan ke gambar semula setelah 3 detik
                    setTimeout(() => {
                        npc.imgSrc = 'images/kambing.png';
                        npc.loadedImg = null;
                    }, 3000);
                }
                // --- UPDATE: UBAH GAMBAR KUDA SAAT DIELUS ---
                else if(npc.id.includes('kuda')) {
                    npc.imgSrc = 'images/kuda-elus.png';
                    npc.loadedImg = null; 
                    
                    // Kembalikan ke gambar semula setelah 3 detik
                    setTimeout(() => {
                        npc.imgSrc = 'images/kuda.png';
                        npc.loadedImg = null;
                    }, 3000);
                }
                // --- UPDATE: UBAH GAMBAR AYAM SAAT DIELUS ---
                else if(npc.id.includes('ayam')) {
                    npc.imgSrc = 'images/ayam-elus.png';
                    npc.loadedImg = null; 
                    
                    // Kembalikan ke gambar semula setelah 3 detik
                    setTimeout(() => {
                        npc.imgSrc = 'images/ayam.png';
                        npc.loadedImg = null;
                    }, 3000);
                }
                
                // Mainkan suara jika audio aktif
                if(AudioService.enabled && AudioService.tracks[npc.sound]) {
                    AudioService.tracks[npc.sound].currentTime = 0;
                    AudioService.tracks[npc.sound].play().catch(()=>{});
                }

                createParticle(npc.x*TILE_SIZE, npc.y*TILE_SIZE, '#ff69b4');
                
                // --- NEW: SPAWN LOVE BUBBLE SAAT DIELUS ---
                STATE.particles.push({
                    x: (npc.x * TILE_SIZE) + (npc.w ? npc.w/2 : 20), // Tengah di atas kepala
                    y: (npc.y * TILE_SIZE) - 15,
                    vx: 0,
                    vy: -0.5, // Melayang naik pelan
                    life: 60, // Durasi 1 detik
                    type: 'love_bubble'
                });

                showToast(`Kamu mengelus ${npc.name}. Dia terlihat senang! `);
                closeDialogue();
            }},
            {text: "Tinggalkan", action: closeDialogue}
        ], npc.imgSrc);
    }

    // NEW: Interaksi khusus untuk Fake Interest/Rival
    else if(npc.id === 'fake_boy' || npc.id === 'fake_girl') {
        const rivalName = npc.name.split('(')[1].replace(')', ''); // Ambil nama panggilan

        // --- NEW: LOGIKA JIKA PLAYER SUDAH MENIKAH (JADI SAHABAT) ---
        if (STATE.player.married) {
            // Cek siapa pasangan player untuk konteks dialog (opsional, tapi bagus untuk detail)
            // Tapi intinya Rival senang karena player sudah "Sold Out"
            
            let friendlyText = "";
            let friendlyOpts = [];

            if (npc.id === 'fake_boy') { // DONI (Rival Cowok)
                friendlyText = "Yo Bro! Gimana kehidupan nikah? Enak kan ada yang ngurusin? Hahaha.\n\nJujur gue lega lu udah nikah. Sekarang gue bisa fokus ngejar cinta gue sendiri tanpa takut bersaing sama lu.\n\nSelamat ya! Gue doain lu langgeng sampai kakek-nenek.";
                friendlyOpts = [
                    {text: "Thanks Bro! Kapan nyusul?", action: () => {
                        showDialogue(npc.name, "Hahaha, santai lah. Gue masih mau menikmati masa muda dan ngumpulin modal dulu. \nNanti kalau gue nikah, lu orang pertama yang gue undang!", [{text:"Siap!", action:closeDialogue}], npc.imgSrc);
                    }},
                    {text: "Minta Tips Rumah Tangga?", action: () => {
                        showDialogue(npc.name, "Waduh, salah orang lu bro. Gue kan masih jomblo! \nTapi kuncinya sih satu: Sering-sering aja ajak jalan istri lu. Cewek itu butuh perhatian.", [{text:"Bener juga", action:closeDialogue}], npc.imgSrc);
                    }},
                    {text: "Dah Bro", action: closeDialogue}
                ];
            } else { // BELLA (Rival Cewek)
                friendlyText = "Haiii! Ciee pengantin baru, auranya beda banget deh, makin glowing! \n\nSelamat ya atas pernikahanmu. Dulu aku sempet sebel sama kamu karena takut cowok idamanku diambil, tapi sekarang aku sadar kamu temen yang baik.\n\nLanggeng terus ya sama pasanganmu!";
                friendlyOpts = [
                    {text: "Makasih Bella! Kamu juga semangat ya", action: () => {
                        showDialogue(npc.name, "Pasti dong! Sekarang sainganku berkurang satu, peluangku dapet cowok idaman makin besar hihihi. \nKapan-kapan kita belanja bareng yuk!", [{text:"Boleh tuh", action:closeDialogue}], npc.imgSrc);
                    }},
                    {text: "Tukar Gosip", action: () => {
                        showDialogue(npc.name, "Tau nggak? Si Pedagang Keliling itu ternyata naksir anak Blacksmith lho! \nDesa ini kecil tapi dramanya banyak ya. Seru banget!", [{text:"Walah...", action:closeDialogue}], npc.imgSrc);
                    }},
                    {text: "Dah Bella", action: closeDialogue}
                ];
            }

            showDialogue(`${npc.name} (Sahabat)`, friendlyText, friendlyOpts, npc.imgSrc);
            return;
        }

        // --- LOGIKA LAMA: JIKA BELUM MENIKAH (MASIH RIVAL) ---
        
        // Dialog beda tergantung lokasi/waktu
        let taunt = "Apa lu liat-liat? Minggir!";
        
        // Rival Boy Dialogues
        if(npc.id === 'fake_boy') {
            if(STATE.time < 1500) taunt = "Eh ada lu. Asal tau aja ya, Ayu tuh lebih suka cowok keren kayak gue. Lu mending balik ke ladang.";
            else taunt = "Putri itu seleranya tinggi, bro. Otak pas-pasan kayak lu gak bakal nyambung ngomong sama dia.";
        }
        // Rival Girl Dialogues
        else {
            if(STATE.time < 1500) taunt = "Duh, ngapain sih kamu di sini? Dokter Budi itu sibuk, jangan ganggu dia deh. Aku aja yang nemenin dia.";
            else taunt = "Satria itu butuh pendamping yang tangguh, bukan yang lembek kayak kamu. Jauh-jauh sana!";
        }

        showDialogue(npc.name, taunt, [
            // Tombol ini sekarang memanggil fungsi startDuel(npc) yang ada di bawah
			{text: " Tantang Duel!", action: () => {
			 closeDialogue(); // 1. Tutup dialog percakapan
		     startDuel(npc);  // 2. Panggil layar duel
			 }},
            {text: "Kita bersaing secara sehat!", action: () => {
                showDialogue(npc.name, "Hah? Bersaing? Mimpi lu ketinggian! Tapi oke, kita liat siapa yang menang.", [{text:"Liat saja nanti", action:closeDialogue}], npc.imgSrc);
            }},
            {text: "Abaikan", action: closeDialogue}
        ], npc.imgSrc);
    }

    // --- NEW: INTERAKSI SENIOR KUTUBUKU (QUEST DRAFT SKRIPSI) ---
    else if(npc.id === 'kutubuku') {
        const year = Math.ceil(STATE.day / 120);
        const hasDraft = (STATE.player.inventory['draft_proposal'] || 0) > 0;
        
        // Kondisi 1: Tahun 1 & 2 (Belum Waktunya)
        if (year < 3) {
            showDialogue(npc.name, "Sstt... Jangan berisik. Aku sedang menyusun Bab 2 skripsiku. \nKembalilah saat kamu sudah **Tahun ke-3** nanti.", [{text:"Maaf kak", action:closeDialogue}], npc.imgSrc);
        }
        // Kondisi 2: Tahun 3+, Belum Punya Draft, Belum Ambil Quest
        else if (year >= 3 && !hasDraft && STATE.player.activeQuest !== 'find_draft') {
            showDialogue(npc.name, "HUWAAAA! Gawat! Gawat sekali!  \nDraft Skripsi-ku yang sudah 90% jadi HILANG!", [
                {text: "Kenapa bisa hilang kak?", action: () => {
                    showDialogue(npc.name, "Tadi aku sedang riset di **Area Candi Kuno** (Timur Laut). Tiba-tiba ada monster mencuri tasku! \n\nKalau kamu berani ke sana dan mengambilkannya kembali, aku akan berikan salinan Draft-nya untukmu. Itu bisa jadi bahan proposalmu nanti!", 
                    [
                        {text: "Aku akan ambilkan! (Terima Quest)", action: () => {
                            STATE.player.activeQuest = 'find_draft';
                            showToast("QUEST DITERIMA: Cari Monster di Depan Candi!");
                            closeDialogue();
                        }},
                        {text: "Takut monster...", action: closeDialogue}
                    ], npc.imgSrc);
                }}
            ], npc.imgSrc);
        }
        // Kondisi 3: Quest Aktif, Belum Dapat
        else if (STATE.player.activeQuest === 'find_draft' && !hasDraft) {
            showDialogue(npc.name, "Tolong cepat! Monster itu lari ke **Depan Candi Kuno**. \nCari monster yang membawa tas buku!", [{text:"Segera ke sana!", action:closeDialogue}], npc.imgSrc);
        }
        // Kondisi 4: Sudah Punya Draft (Selesai)
        else if (hasDraft) {
            showDialogue(npc.name, "Terima kasih banyak pahlawan! Kamu menyelamatkan masa depanku. \nSesuai janji, salinan Draft itu buat kamu. Gunakan untuk mengajukan proposal ke Dosen di Tahun ke-4 nanti ya!", [{text:"Sama-sama kak!", action:closeDialogue}], npc.imgSrc);
        }
    }

    // --- NEW: INTERAKSI MONSTER SKRIPSI (DI DESA/HUTAN) ---
    else if(npc.id === 'monster_skripsi') {
        showDialogue("MONSTER PENCURI", "GRRRR!! (Monster ini memeluk tas berisi buku dengan erat)", [
            {text: " LAWAN & REBUT KEMBALI!", action: () => {
                closeDialogue();
                startRuinsBattle(); // Mulai Battle Scene
            }},
            {text: "Mundur dulu...", action: closeDialogue}
        ], npc.imgSrc);
    }

    // --- NEW: INTERAKSI TEMAN SEKELAS (PEER1 - SISWA LAKI-LAKI) ---
    else if(npc.id === 'peer1') {
        const p = STATE.player;
        if(!p.relationships[npc.id]) p.relationships[npc.id] = 0;
        const rel = p.relationships[npc.id];
        
        // Pilih Pool Chat berdasarkan Kedekatan (Relationship)
        let chatPool = PEER_BOY_CHATS.low;
        let mood = "Bingung";
        
        if (rel >= 80) { 
            chatPool = PEER_BOY_CHATS.high; 
            mood = "Semangat";
        } else if (rel >= 20) { 
            chatPool = PEER_BOY_CHATS.mid; 
            mood = "Santai";
        }

        // Ambil kalimat acak
        const randomChat = chatPool[Math.floor(Math.random() * chatPool.length)];

        showDialogue(`${npc.name} (${mood})`, `"${randomChat}"`, [
            {
                text: "Ngobrol (Energi -2)", 
                action: () => {
                    if(STATE.player.energy >= 2) {
                        STATE.player.energy -= 2;
                        updateRelationship(npc, 2, "Akrab"); // Tambah kedekatan biar dialognya berkembang
                        
                        // Respon balik sederhana
                        const responses = ["Semangat bro!", "Sama, gue juga gitu.", "Haha bener juga.", "Sabar ya."];
                        const randResp = responses[Math.floor(Math.random() * responses.length)];
                        
                        showDialogue(npc.name, `"${randResp} Thanks udah dengerin curhatan gue bro."`, [{text:"Sip", action:closeDialogue}], npc.imgSrc);
                    } else {
                        showToast("Terlalu lelah untuk ngobrol panjang...");
                    }
                }
            },
            {text: "Duluan ya bro", action: closeDialogue}
        ], npc.imgSrc);
    }

    // UPDATE: Interaksi NPC Agama (Aisyah & Maria) dengan Dialog Random
    else if(npc.id === 'cewek_islam' || npc.id === 'cewek_kristen') {
        // Ambil Bank Dialog
        const chatBank = NPC_RELIGIOUS_CHATS[npc.id];
        
        // Pilih Random
        // Agar terasa 'berbeda tiap hari', kita bisa gunakan seed hari atau random murni.
        // Random murni lebih variatif saat diklik berkali-kali.
        const randomChat = chatBank[Math.floor(Math.random() * chatBank.length)];
        
        // Salam pembuka (Statis) lalu isi (Dinamis)
        let salam = npc.id === 'cewek_islam' ? "Assalamualaikum." : "Shalom.";
        
        showDialogue(npc.name, `${salam} \n"${randomChat}"`, [
            {text: "MasyaAllah/Puji Tuhan (Setuju)", action: () => {
                showToast("Hati menjadi adem... ");
                // Tambah sedikit Ethics/Reputation
                STATE.player.ethics += 1;
                closeDialogue();
            }},
            {text: "Terima kasih nasihatnya", action: closeDialogue}
        ], npc.imgSrc);
    }

    // NEW: Interaksi Putri Duyung
    else if(npc.id === 'putriduyung') {
        showDialogue(npc.name, "Glub... glub... Hai manusia darat! Jarang sekali ada yang menyapaku di sini.", [
            {text: "Siapa kamu?", action: () => {
                showDialogue(npc.name, "Aku penjaga perairan di sekitar Pulau Arsa. Lautan memberiku banyak harta karun, tapi aku lebih suka melihat bunga daratan.", [{text:"Wah, unik sekali", action:closeDialogue}], npc.imgSrc);
            }},
            {text: "Tukar Mutiara (Butuh 5 Ikan)", action: () => {
                const fishCount = STATE.player.inventory['ikan_segar'] || 0;
                if(fishCount >= 5) {
                    STATE.player.inventory['ikan_segar'] -= 5;
                    // Hadiah Permata (Berlian)
                    if(!STATE.player.inventory['permata']) STATE.player.inventory['permata'] = 0;
                    STATE.player.inventory['permata']++;
                    showToast("Tukar Berhasil! Dapat Berlian ");
                    showDialogue(npc.name, "Terima kasih ikannya! Ini hadiah cantik dari dasar laut untukmu.", [{text:"Terima kasih!", action:closeDialogue}], npc.imgSrc);
                } else {
                    showDialogue(npc.name, "Kamu belum punya cukup ikan. Bawakan aku 5 Ikan Segar, nanti kutukar dengan Mutiara (Berlian).", [{text:"Oke, aku cari dulu", action:closeDialogue}], npc.imgSrc);
                }
            }},
            {text: "Dah", action: closeDialogue}
        ], npc.imgSrc);
    }

    // NEW: INTERAKSI PEMANCING MISTERIUS (Jual Ikan Mahal)
    else if(npc.id === 'pemancing_misterius') {
        showDialogue(npc.name, "Angin laut sore ini tenang sekali... Ikan-ikan besar biasanya muncul saat matahari terbenam.", [
            {text: "Jual Ikan (Harga Spesial 2000G)", action: () => {
                const fish = STATE.player.inventory['ikan_segar'] || 0;
                if(fish > 0) {
                    const price = 2000; 
                    const total = fish * price;
                    STATE.player.inventory['ikan_segar'] = 0;
                    STATE.player.money += total;
                    showToast(`Terjual ${fish} Ikan seharga ${total.toLocaleString()} G!`);
                    if(typeof AudioService !== 'undefined') AudioService.playSFX('item');
                    closeDialogue();
                } else {
                    showDialogue(npc.name, "Embermu kosong, nak. Memancinglah dulu di ujung dermaga.", [{text:"Baiklah", action:closeDialogue}], npc.imgSrc);
                }
            }},
            // --- UPDATE: TAMBAHAN INFO JENIS IKAN ---
            {text: "Info Jenis Ikan ", action: () => {
                showDialogue(npc.name, 
                    "Di perairan Pulau Arsa ini hidup 4 tingkatan ikan:\n\n" +
                    " **Ikan Kecil**: Sangat umum. Lumayan untuk ganjal perut (+10 Energi).\n" +
                    " **Ikan Sedang**: Lebih bertenaga. Enak dibakar (+25 Energi).\n" +
                    " **Ikan Besar**: Tangkapan mantap! Sangat mengenyangkan (+50 Energi).\n" +
                    " **Ikan Legendaris**: RAJA LAUTAN! Sangat langka, bersisik emas, dan harganya mahal sekali! (Full Energi)\n\n" +
                    "Berdoalah pada dewa laut agar kailmu disambar yang Legendaris.", 
                    [{text:"Wah, aku ingin yang Legendary!", action:()=>interactNPC(npc)}], npc.imgSrc);
            }},
            {text: "Tips Memancing", action: () => {
                showDialogue(npc.name, "Kunci memancing adalah sabar. Tekan tombol aksi tepat saat indikator berada di area hijau. Jangan terburu-buru.", [{text:"Terima kasih", action:closeDialogue}], npc.imgSrc);
            }},
            {text: "Sampai jumpa", action: closeDialogue}
        ], npc.imgSrc);
    }

    // --- NEW: INTERAKSI DEWI ARSA (EVENT BULAN PURNAMA) ---
    else if(npc.id === 'dewi_arsa') {
        showDialogue("DEWI ARSA", "Wahai anak manusia... Kau menemukanku di saat bulan purnama bersinar paling terang.", [
            {text: "Siapa engkau? (Berkah)", action: () => {
                showDialogue("DEWI ARSA", "Aku adalah manifestasi roh Pulau Arsa. Karena ketulusanmu datang di jam suci ini, terimalah berkahku.", [
                    {text: "Terima Berkah (Full Heal + Permata)", action: () => {
                        STATE.player.hp = STATE.player.maxHp;
                        STATE.player.energy = 100;
                        addItem('permata', 1); // Hadiah item mahal
                        showToast(" Diberkati Dewi Arsa (Status Pulih & Dapat Permata)");
                        createParticle(npc.x*TILE_SIZE, npc.y*TILE_SIZE, '#fbbf24');
                        if(typeof AudioService !== 'undefined') AudioService.playSFX('item');
                        closeDialogue();
                    }}
                ], npc.imgSrc);
            }},
            /* NEW: DIALOG TENTANG KEDEWASAAN & KEBIJAKSANAAN */
            {text: "Makna Kedewasaan", action: () => {
                 showDialogue("DEWI ARSA", "Kedewasaan bukan sekadar bertambahnya angka usia, Nak. \n\nDewasa adalah saat kau berhenti menyalahkan dunia atas lukamu, dan mulai mengambil tanggung jawab untuk menyembuhkannya sendiri.", 
                 [
                     {text: "Lalu, apa itu Kebijaksanaan?", action: () => {
                         showDialogue("DEWI ARSA", "Kebijaksanaan adalah seni mengetahui apa yang harus diabaikan.\n\nIa adalah ketika kau memiliki kekuatan untuk membalas rasa sakit, namun kau memilih untuk memutus rantai kebencian itu dengan memaafkan.", 
                         [{
                             text: "Terima kasih... (Ethics +10)", 
                             action: () => {
                                 STATE.player.ethics += 10;
                                 STATE.player.reputation += 5;
                                 gainExp(100); // Bonus EXP Besar untuk Wisdom
                                 createParticle(STATE.player.x, STATE.player.y, '#ffffff');
                                 showToast(" Jiwa Menjadi Tenang (+10 Ethics)");
                                 closeDialogue();
                             }
                         }], npc.imgSrc);
                     }}
                 ], npc.imgSrc);
            }},
            {text: "Hanya kebetulan lewat", action: closeDialogue}
        ], npc.imgSrc);
    }

    /* NEW: INTERAKSI KURCACI TANI (EVENT PANEN RAYA) */
    else if(npc.id === 'kurcaci_tani') {
        // Cek jika sudah dipekerjakan
        if (STATE.player.hiredDwarf) {
             showDialogue("KURCACI TANI", "Hohoho! Tenang saja Bos, lahan pertanianmu aman di tanganku. \nSetiap pagi aku akan menyiram tanamanmu secara otomatis!", [{text:"Kerja Bagus Kek!", action:closeDialogue}], npc.imgSrc);
             return;
        }

        showDialogue("KURCACI TANI", "Hohoho! Selamat Panen Raya! \nMusim panas adalah waktu terbaik untuk bersyukur pada alam.", [
            {text: "Terima Kasih, Kek!", action: () => {
                // Cek apakah sudah terima hadiah tahun ini (menggunakan tahun game)
                const currentYear = Math.ceil(STATE.day / 120);
                
                if (STATE.player.lastHarvestGiftYear !== currentYear) {
                    STATE.player.lastHarvestGiftYear = currentYear;
                    
                    addItem('gandum', 5);
                    showToast("Dapat 5 Gandum! ");
                    createParticle(npc.x*TILE_SIZE, npc.y*TILE_SIZE, '#facc15');
                    if(typeof AudioService !== 'undefined') AudioService.playSFX('item');
                    
                    showDialogue("KURCACI TANI", "Ini benih gandum berkah untukmu. Gunakan dengan bijak!", [{text:"Siap!", action:closeDialogue}], npc.imgSrc);
                    
                    manualSave(); // Simpan flag
                } else {
                    showDialogue("KURCACI TANI", "Nikmati festivalnya, anak muda! Jangan lupa makan yang banyak.", [{text:"Dah", action:closeDialogue}], npc.imgSrc);
                }
            }},
            
            // --- NEW: OPSI MEMPEKERJAKAN KURCACI ---
            {text: " Pekerjakan (Otomatisasi Tani)", action: () => {
                showDialogue("KURCACI TANI", 
                    "Kau ingin aku mengurus ladangmu? Hohoho, aku butuh tempat tinggal yang layak dan bayaran setimpal!\n\n**SYARAT KONTRAK KERJA:**\n1.  **Rumah Kurcaci** (Beli di Katalog Furnitur).\n2.  **Uang Muka 200.000 G**.\n3.  **Ikan Legendaris** (Makanan favoritku).", 
                    [
                        {text: "Sepakat! (Penuhi Syarat)", action: () => {
                            // Cek Syarat
                            const hasHouse = STATE.player.furniture.includes('rumah_kurcaci');
                            const hasMoney = STATE.player.money >= 200000;
                            const hasFish = (STATE.player.inventory['ikan_legendary'] || 0) > 0;
                            
                            if (hasHouse && hasMoney && hasFish) {
                                // Potong Biaya
                                STATE.player.money -= 200000;
                                STATE.player.inventory['ikan_legendary']--;
                                if(STATE.player.inventory['ikan_legendary']<=0) delete STATE.player.inventory['ikan_legendary'];
                                
                                // Set Flag
                                STATE.player.hiredDwarf = true;
                                
                                // Efek Sukses
                                createParticle(npc.x*TILE_SIZE, npc.y*TILE_SIZE, '#10b981'); // Hijau
                                if(typeof AudioService !== 'undefined') AudioService.playSFX('item');
                                showToast("KURCACI DIPEKERJAKAN! ");
                                
                                showDialogue("KURCACI TANI", "Hohoho! Mantap! Ikan ini terlihat lezat.\n\nMulai besok, aku akan tinggal di Rumah Kurcaci itu dan mengurus ladangmu setiap pagi. Kau bisa santai!", [{text:"Terima kasih Kek!", action:closeDialogue}], npc.imgSrc);
                                manualSave();
                            } else {
                                // Tampilkan apa yang kurang
                                let missing = [];
                                if(!hasHouse) missing.push("Rumah Kurcaci");
                                if(!hasMoney) missing.push("Uang 200k");
                                if(!hasFish) missing.push("Ikan Legendaris");
                                
                                showDialogue("SYARAT KURANG", `Maaf anak muda, syaratmu belum lengkap.\n\n**KURANG:**\n- ${missing.join('\n- ')}`, [{text:"Aku lengkapi dulu", action:closeDialogue}], npc.imgSrc);
                            }
                        }},
                        {text: "Mahal banget...", action: closeDialogue}
                    ], 
                    npc.imgSrc
                );
            }},
            
            {text: "Dah", action: closeDialogue}
        ], npc.imgSrc);
    }

    /* NEW: INTERAKSI PERI PANEN (EVENT PESTA ANGGUR - AUTUMN) */
    /* NEW: INTERAKSI PERI PANEN (EVENT PESTA ANGGUR - AUTUMN) */
    else if(npc.id === 'peripanen') {
        // Cek jika sudah dipekerjakan
        if (STATE.player.hiredFairy) {
             showDialogue("PERI PANEN", "Hai Bos! \nTenang saja, setiap ada tanaman yang matang, aku akan memanennya otomatis setiap pagi. Cek tasmu ya!", [{text:"Kerja Bagus Peri!", action:closeDialogue}], npc.imgSrc);
             return;
        }

        showDialogue("PERI PANEN", "Salam, anak bumi! \nMusim Gugur telah tiba. Aku sebenarnya mencari **Bunga Keabadian (Rafflesia)**.\nJika kau memilikinya, aku bersedia mengabdi padamu.", [
            {text: "Minta Berkah Anggur", action: () => {
                // Logika hadiah anggur (tetap sama seperti sebelumnya)
                const currentYear = Math.ceil(STATE.day / 120);
                if (STATE.player.lastGrapeGiftYear !== currentYear) {
                    STATE.player.lastGrapeGiftYear = currentYear;
                    addItem('tonic_stamina', 2);
                    showToast("Dapat 2 Sari Anggur (Tonic)! ");
                    createParticle(npc.x*TILE_SIZE, npc.y*TILE_SIZE, '#a855f7');
                    if(typeof AudioService !== 'undefined') AudioService.playSFX('item');
                    showDialogue("PERI PANEN", "Terimalah Sari Anggur Murni ini.\nMinumlah saat kau lelah.", [{text:"Terima kasih!", action:closeDialogue}], npc.imgSrc);
                    manualSave(); 
                } else {
                    showDialogue("PERI PANEN", "Kembalilah tahun depan untuk anggur gratis.", [{text:"Oke", action:closeDialogue}], npc.imgSrc);
                }
            }},
            
            // --- [BARU] OPSI PEKERJAKAN PERI PANEN ---
            {text: " Pekerjakan (Butuh: Rafflesia)", action: () => {
                // Cek apakah punya Bunga Rafflesia (Hasil Panen)
                if ((STATE.player.inventory['bunga_rafflesia'] || 0) > 0) {
                    showDialogue("PERI PANEN", "Aroma ini... **Bunga Rafflesia Arnoldi**!\nKau berhasil menanamnya? Luar biasa!\n\nSesuai janjiku, jika kau berikan bunga itu padaku, aku akan menjadi **Asisten Panen**-mu selamanya.\n\nAku akan memanen semua tanaman matang secara otomatis setiap pagi.", 
                    [
                        {text: "Sepakat! (Serahkan Bunga)", action: () => {
                            // Hapus Item Bunga
                            STATE.player.inventory['bunga_rafflesia']--;
                            if(STATE.player.inventory['bunga_rafflesia']<=0) delete STATE.player.inventory['bunga_rafflesia'];
                            
                            // Set Status Hire
                            STATE.player.hiredFairy = true;
                            
                            // Efek Sukses
                            createParticle(npc.x*TILE_SIZE, npc.y*TILE_SIZE, '#d946ef'); // Ungu
                            if(typeof AudioService !== 'undefined') AudioService.playSFX('item');
                            showToast("PERI PANEN DIPEKERJAKAN! ");
                            
                            showDialogue("PERI PANEN", "Terima kasih! Aromanya sangat memikat.\n\nMulai besok, semua hasil panenmu akan langsung masuk ke Tas saat kau bangun tidur.", [{text:"Mantap!", action:closeDialogue}], npc.imgSrc);
                            manualSave();
                        }},
                        {text: "Sayang ah, nanti aja", action: closeDialogue}
                    ], npc.imgSrc);
                } else {
                    showDialogue("PERI PANEN", "Maaf, kau tidak punya **Bunga Rafflesia**.\n\n**CARANYA:**\n1. Dapatkan Bibit dari Dewi Roro (Candi).\n2. Tanam di ladang hingga panen.\n3. Bawa Bunganya ke sini.", [{text:"Siap, aku cari dulu", action:closeDialogue}], npc.imgSrc);
                }
            }},
            
            {text: "Dah Peri", action: closeDialogue}
        ], npc.imgSrc);
    }
	
    /* NEW: INTERAKSI DEWI RORO (PENJAGA CANDI) */
    else if(npc.id === 'dewi_roro') {
        showDialogue("DEWI RORO", "Selamat datang di Candi Aethelgard, wahai pengelana. \nSaya Roro, roh penjaga kesucian tempat ini. Apa yang membawamu kemari?", [
            {text: "Minta Berkah (Full Heal)", action: () => {
                STATE.player.hp = STATE.player.maxHp;
                STATE.player.energy = 100;
                showToast(" Diberkati Dewi Roro (Pulih Sepenuhnya)");
                createParticle(npc.x*TILE_SIZE, npc.y*TILE_SIZE, '#fbbf24');
                if(typeof AudioService !== 'undefined') AudioService.playSFX('item');
                closeDialogue();
            }},
            
            // --- NEW: MISI RAFFLESIA ARNOLDI ---
            {text: " Misi Bunga Abadi (Rafflesia)", action: () => {
                // Cek apakah sudah punya Bibit/Bunga
                if (STATE.player.inventory['bibit_rafflesia'] || STATE.player.inventory['bunga_rafflesia']) {
                     showDialogue("DEWI RORO", "Kau sudah memiliki pusaka itu. \nTanamlah bibitnya dan rawat hingga mekar.", [{text:"Baik Dewi", action:closeDialogue}], npc.imgSrc);
                     return;
                }

                // Cek Syarat: 7 Bunga Liar + 1 Permata
                const flowers = STATE.player.inventory['bunga'] || 0;
                const gems = STATE.player.inventory['permata'] || 0;
                const reqFlowers = 7;
                const reqGems = 1;

                showDialogue("MISI DEWI RORO", 
                    `Aku bisa memanggil **Bunga Rafflesia Arnoldi** yang legendaris, namun aku butuh energi alam untuk mewujudkannya.\n\n**SYARAT PERSEMBAHAN:**\n **Bunga Liar**: ${flowers}/${reqFlowers}\n **Permata**: ${gems}/${reqGems}\n\n(Bunga Liar tumbuh di desa setiap pagi. Permata didapat dari Monster/Toko).`, 
                    [
                        {text: "Serahkan Persembahan", action: () => {
                            if (flowers >= reqFlowers && gems >= reqGems) {
                                // Kurangi Item
                                STATE.player.inventory['bunga'] -= reqFlowers;
                                STATE.player.inventory['permata'] -= reqGems;
                                if(STATE.player.inventory['bunga']<=0) delete STATE.player.inventory['bunga'];
                                if(STATE.player.inventory['permata']<=0) delete STATE.player.inventory['permata'];

                               // [PERBAIKAN] BERI BIBIT, BUKAN BUNGA JADI
                                addItem('bibit_rafflesia', 1); 
                                
                                // Efek Visual & Audio Spesial
                                createParticle(npc.x*TILE_SIZE, npc.y*TILE_SIZE, '#ef4444'); // Merah
                                createParticle(npc.x*TILE_SIZE, npc.y*TILE_SIZE, '#fbbf24'); // Emas
                                if(typeof AudioService !== 'undefined') AudioService.playSFX('item');

                                // Dialog Sukses (Update Teks agar jelas)
                                showDialogue("DEWI RORO", "Terimalah benih kehidupan ini... **Bibit Rafflesia Arnoldi**.\n\nTanamlah di ladangmu. Walaupun kamu punya Kurcaci, kamu tetap harus menanamnya sendiri.\n\nRawatlah hingga mekar menjadi bunga abadi.", 
                                    [{text: "Terima Kasih Dewi! (Dapat Bibit)", action: closeDialogue}], 
                                    'images/rafflesia.png' 
                                );
                                manualSave();
                            } else {
                                showToast("Syarat belum terpenuhi!");
                            }
                        }},
                        {text: "Aku cari dulu...", action: closeDialogue}
                    ], 
                    npc.imgSrc
                );
            }},

            {text: "Tentang Candi Ini", action: () => {
                showDialogue("DEWI RORO", "Candi ini dibangun ribuan tahun lalu oleh leluhurmu. Di sini tersimpan energi magis yang menahan segel Dungeon agar tidak meluap ke desa.", [{text:"Terima kasih infonya", action:closeDialogue}], npc.imgSrc);
            }},
            {text: "Legenda Roro Jonggrang?", action: () => {
                showDialogue("DEWI RORO", "Hihihi... Itu kisah dari tanah seberang. Saya hanya memiliki nama yang mirip, namun tugas saya berbeda. Saya menjaga keseimbangan, bukan meminta seribu candi.", [{text:"Ooh begitu...", action:closeDialogue}], npc.imgSrc);
            }},
            {text: "Hormat & Pamit", action: closeDialogue}
        ], npc.imgSrc);
    }

    // NEW: INTERAKSI SENIMAN
    else if(npc.id === 'seniman') {
        showDialogue(npc.name, "Jreng... jreng... Hidup itu seperti nada, kadang tinggi, kadang rendah. Nikmati saja iramanya.", [
            {text: "Request Lagu (50G) - Pulihkan Energi", action: () => {
                if(STATE.player.money >= 50) {
                    STATE.player.money -= 50;
                    STATE.player.energy = Math.min(100, STATE.player.energy + 20); // Heal Energy
                    showToast(" Energi +20 (Musik yang menenangkan)");
                    if(typeof AudioService !== 'undefined') AudioService.playSFX('item');
                    showDialogue(npc.name, "Terima kasih apresiasinya! Ini lagu spesial buat kamu... ", [{text:"Asik!", action:closeDialogue}], npc.imgSrc);
                } else {
                    showToast("Uang tidak cukup untuk sawer.");
                }
            }},
            {text: "Puji Musiknya", action: () => {
                showDialogue(npc.name, "Wah, kamu punya selera bagus. Gitar ini teman setia saya berkeliling Nusantara.", [{text:"Keren", action:closeDialogue}], npc.imgSrc);
            }},
            {text: "Dah", action: closeDialogue}
        ], npc.imgSrc);
    }

    // NEW: INTERAKSI PENYANYI
    else if(npc.id === 'penyanyi') {
        showDialogue(npc.name, "La la la~  Bernyanyi bersama petikan gitar Seniman membuat hariku berwarna.", [
            {text: "Suaramu merdu sekali!", action: () => {
                showDialogue(npc.name, "Terima kasih! Kami sedang berlatih untuk festival desa nanti. Doakan lancar ya!", [{text:"Pasti!", action:closeDialogue}], npc.imgSrc);
            }},
            {text: "Kalian serasi (Duet)", action: () => {
                showDialogue(npc.name, "Hehe, kami memang partner musik terbaik. Musik menyatukan jiwa kami.", [{text:"Mantap", action:closeDialogue}], npc.imgSrc);
            }},
            {text: "Dah", action: closeDialogue}
        ], npc.imgSrc);
    }

    // NEW: INTERAKSI PERENANG
    else if(npc.type === 'swimmer') {
        showDialogue(npc.name, "Byuurr... Air lautnya segar sekali hari ini! Kamu tidak mau ikutan?", [
            {text: "Nanti basah kuyup...", action: () => {
                showDialogue(npc.name, "Hahaha! Namanya juga main air. Hati-hati jangan terlalu jauh, konon ada monster laut.", [{text:"Oke", action:closeDialogue}], npc.imgSrc);
            }},
            {text: "Dah", action: closeDialogue}
        ], npc.imgSrc);
    }

    // --- NEW: INTERAKSI ANAK-ANAK ---
    else if(npc.id.includes('child')) {
        let childTalk = "Kakak mau main kejar-kejaran nggak? Aku yang lari, kakak yang ngejar! Wlek! ";
        if(npc.name === 'Gadis Kecil') childTalk = "Cita-citaku ingin jadi seperti Putri Duyung! Katanya dia cantik banget.";
        
        showDialogue(npc.name, childTalk, [
            {text: "Belajar yang rajin ya", action: () => {
                showDialogue(npc.name, "Iya kak... tapi main dulu sebentar hehehe.", [{text:"Dasar bocah", action:closeDialogue}], npc.imgSrc);
            }},
            {text: "Kasih Permen (Coklat)", action: () => {
                if(STATE.player.inventory['coklat'] > 0) {
                    STATE.player.inventory['coklat']--;
                    createParticle(npc.x*TILE_SIZE, npc.y*TILE_SIZE, '#fbbf24');
                    showToast("Memberi Coklat ke Anak Kecil ");
                    showDialogue(npc.name, "Wahhh! Makasih Kakak! Kakak baik banget deh! (Hati Senang)", [{text:"Sama-sama", action:closeDialogue}], npc.imgSrc);
                } else {
                    showToast("Kamu tidak punya Coklat.");
                }
            }},
            {text: "Dah", action: closeDialogue}
        ], npc.imgSrc);
    }

    // --- NEW: INTERAKSI MAHASISWA SANTAI (LAZY STUDENT) ---
    else if(npc.id === 'student2') {
        showDialogue(npc.name, "Hhh... (Menguap)  \nDosennya ngomong apa sih dari tadi? Aku cuma numpang absen doang.", [
            {text: "Jangan malas dong", action: () => {
                showDialogue(npc.name, "Biarin... yang penting lulus. Lagian aku mau jadi Pro Player game aja nanti.", [{text:"Terserah deh", action:closeDialogue}], npc.imgSrc);
            }},
            {text: "Pinjam Catatan", action: () => {
                showDialogue(npc.name, "Catatan? Kertas aku masih bersih nih. Gak ada isinya. Hahaha!", [{text:"Dasar...", action:closeDialogue}], npc.imgSrc);
            }},
            {text: "Dah", action: closeDialogue}
        ], npc.imgSrc);
    }

    // --- NEW: INTERAKSI AYA (KEMBARAN AYU) ---
    else if(npc.id === 'aya_twin') {
        showDialogue(npc.name, "Hai! Jangan salah panggil ya, aku Aya, bukan Ayu. \nKami memang kembar identik, tapi kepribadian kami beda lho.", [
            {text: "Apa bedanya?", action: () => {
                showDialogue(npc.name, "Ayu itu anak *outdoor*, dia suka berkebun dan keliling desa menyapa orang. \nKalau aku anak *indoor*, lebih suka beres-beres rumah, memasak, dan membaca buku.", [{text:"Ooh begitu, menarik", action:closeDialogue}], npc.imgSrc);
            }},
            {text: "Kalian akur?", action: () => {
                showDialogue(npc.name, "Banget! Walaupun kadang rebutan baju sih. Hehe. \nOiya, kalau kamu cari Ayu, dia biasanya ada di sebelah kanan ruangan ini atau sedang keluar.", [{text:"Oke makasih", action:closeDialogue}], npc.imgSrc);
            }},
            {text: "Masakanmu enak?", action: () => {
                showDialogue(npc.name, "Tentu saja! Kue Labu buatan Ayu itu resep dari aku lho. \nKapan-kapan mampir lagi ya kalau lapar.", [{text:"Siap!", action:closeDialogue}], npc.imgSrc);
            }},
            {text: "Dah Aya", action: closeDialogue}
        ], npc.imgSrc);
    }

    // --- NEW: INTERAKSI PENJAGA DUNGEON (ADVICE & INFO LENGKAP) ---
    else if(npc.id === 'penjagadungeon') {
        showDialogue("PENJAGA GERBANG", "Berhenti! Area di depan sangat berbahaya. Hanya untuk yang bernyali besar.", [
            {text: "Tentang Dungeon ", action: () => {
                showDialogue("PENJAGA GERBANG", "Dungeon ini terdiri dari 5 Lantai. Semakin dalam kamu masuk, monster semakin ganas.\nDi Lantai 5, bersemayam Boss yang menjaga harta karun sesungguhnya.", [{text:"Paham", action:()=>interactNPC(npc)}], npc.imgSrc);
            }},
            {text: "Tutorial Combat ", action: () => {
                showDialogue("PENJAGA GERBANG", "Dasar pemula... Dengar baik-baik!\n\n **TOMBOL SERANG**: Di dalam, tombol aksi berubah jadi Pedang.\n **SISTEM COMBO**: Tekan cepat berirama! Serangan ke-3 adalah FINISHER (Damage Besar).\n **STAMINA**: Menyerang butuh tenaga. Jangan spam kalau lelah!", [{text:"Siap Paham!", action:()=>interactNPC(npc)}], npc.imgSrc);
            }},
            {text: "Info Item Legend ", action: () => {
                showDialogue("PENJAGA GERBANG", "Harta karun utama Boss Lantai 5:\n1.  **Zirah Abadi**: Membuat kulitmu sekeras baja (Damage musuh berkurang drastis).\n2.  **Cincin Raja**: Aura kekayaan (Bonus Gold +50%) dan **syarat wajib untuk MENIKAH**!\n\nTanpa cincin ini, jangan harap lamaranmu diterima!", [{text:"Penting banget!", action:()=>interactNPC(npc)}], npc.imgSrc);
            }},
            {text: "Drop Boss Lainnya? ", action: () => {
                showDialogue("PENJAGA GERBANG", "Selain pusaka, Boss juga menyimpan ramuan langka:\n1.  **Tonic Kebal**: Memberikan **SHIELD/KEBAL** serangan selama 10 detik.\n2.  **Tonic Stamina**: Memulihkan tenaga seketika.\n\nSangat berguna saat terdesak!", [{text:"Siap hunting!", action:()=>interactNPC(npc)}], npc.imgSrc);
            }},
            {text: "Item Monster Biasa? ", action: () => {
                showDialogue("PENJAGA GERBANG", "Monster biasa menjatuhkan material berharga:\n- **Bijih Besi & Permata**: Jual di Merchant, harganya mahal.\n- **Gulungan Kuno**: Baca untuk menambah Ilmu (EXP).\n\nKumpulkan semuanya untuk jadi kaya!", [{text:"Siap!", action:()=>interactNPC(npc)}], npc.imgSrc);
            }},
            {text: "Ngobrol Santai ", action: () => {
                const quotes = [
                    "Anak muda, dengar nasehatku: **Jangan mikirin pacaran dulu!** Dompetmu masih tipis. Isi dulu dengan Gold, baru cari jodoh.",
                    "Cinta itu butuh biaya. Kalau kamu sukses dan punya rumah mewah, pasangan terbaik akan datang sendiri. Fokus kerja keras!",
                    "Hidup itu seperti Dungeon. Penuh rintangan dan monster. Tapi kalau kamu berani maju, ada harta karun menanti.",
                    "Menabunglah selagi muda. Jangan habiskan uangmu untuk gaya hidup. Investasikan untuk Zirah atau Upgrade Rumah.",
                    "Sakit hati karena cinta? Obatnya cuma satu: SUKSES. Ayo masuk Dungeon dan cari uang!"
                ];
                const randQuote = quotes[Math.floor(Math.random() * quotes.length)];
                showDialogue("PENJAGA GERBANG", randQuote, [{text:"Siap Pak!", action:closeDialogue}], npc.imgSrc);
            }},
            {text: "Tutup", action: closeDialogue}
        ], npc.imgSrc);
    }

    // --- NEW: INTERAKSI PEDAGANG KELILING (JUAL BIBIT & PUPUK) ---
    else if(npc.id === 'trader_outside') {
        showDialogue(npc.name, "Permisi! Saya membawa perlengkapan tani terbaik.\nLahan di belakang rumahmu sayang kalau dibiarkan kosong lho.", [
            {text: " Beli Bibit & Pupuk", action: () => {
                showDialogue("TOKO BIBIT KELILING", "Silakan pilih bibit unggul (Panen 2-3 Hari):", [
                    {text: "Bibit Padi (500 G) ", action: () => buyItem('bibit_padi', 500)},
                    {text: "Bibit Jagung (300 G) ", action: () => buyItem('bibit_jagung', 300)},
                    {text: "Bibit Tomat (250 G) ", action: () => buyItem('bibit_tomat', 250)},
                    {text: "Pupuk Organik (100 G) ", action: () => buyItem('pupuk', 100)},
                    {text: "Kembali", action: () => interactNPC(npc)}
                ], npc.imgSrc);
            }},
            {text: "Cara Bertani", action: () => {
                showDialogue(npc.name, "Mudah kok! Pergi ke lahan di belakang rumahmu:\n1. Gunakan Cangkul (jika ada).\n2. Tanam Bibit.\n3. Siram tiap pagi.\n4. Panen saat matang dan jual ke Merchant!", [{text:"Siap!", action:closeDialogue}], npc.imgSrc);
            }},
            {text: "Beli Alat Tani?", action: () => {
                showDialogue(npc.name, "Untuk Cangkul dan Penyiram, silakan beli di **Toko Merchant** (Gedung Selatan). Saya hanya jual bibitnya.", [{text:"Oke", action:closeDialogue}], npc.imgSrc);
            }},
            {text: "Tutup", action: closeDialogue}
        ], npc.imgSrc);
    }

    // --- NEW: INTERAKSI ISTRI BOS DI DALAM TOKO (MALAM HARI) ---
    else if(npc.id === 'trader_wife_inside') {
        showDialogue(npc.name, "Hufft... Akhirnya bisa ngadem di toko. Jualan keliling panas banget lho! \nSuamiku (Bos Merchant) kadang galak, tapi dia pekerja keras.", [
            {text: "Masih jualan Bu?", action: () => {
                showDialogue(npc.name, "Tentu saja! Namanya juga pedagang. \nMau beli bibit buat ditanam besok pagi?", [
                    {text: "Bibit Padi (500 G) ", action: () => buyItem('bibit_padi', 500)},
                    {text: "Bibit Jagung (300 G) ", action: () => buyItem('bibit_jagung', 300)},
                    {text: "Bibit Tomat (250 G) ", action: () => buyItem('bibit_tomat', 250)},
                    {text: "Pupuk Organik (100 G) ", action: () => buyItem('pupuk', 100)},
                    {text: "Kembali", action: () => interactNPC(npc)}
                ], npc.imgSrc);
            }},
            {text: "Tentang Suami", action: () => {
                showDialogue(npc.name, "Dia itu pelit ngasih diskon, tapi kalau soal kualitas barang, dia nggak main-main. \nKami merintis toko ini dari nol lho.", [{text:"Hebat Bu", action:closeDialogue}], npc.imgSrc);
            }},
            {text: "Istirahatlah Bu", action: closeDialogue}
        ], npc.imgSrc);
    }

    else {
        const lifeChats = [
            "Duh, harga sembako naik lagi. Pintar-pintar atur gaji ya dek.",
            "Tetangga sebelah sukses karena dia rajin menabung sejak sekolah.",
            "Hati-hati investasi bodong. Cepat kaya itu mustahil.",
            "Jangan lupa bayar pajak kalau sudah berpenghasilan nanti.",
            "Jaga kesehatan. Biaya rumah sakit itu mahal lho."
        ];
        showDialogue(npc.name, lifeChats[Math.floor(Math.random() * lifeChats.length)], [{text:"Nasehat Bagus", action:closeDialogue}], npc.imgSrc);
    }
}

function buyItem(item, cost) {
    if(STATE.player.money >= cost) {
        STATE.player.money -= cost;
        if(!STATE.player.inventory) STATE.player.inventory = {};
        if(!STATE.player.inventory[item]) STATE.player.inventory[item] = 0;
        STATE.player.inventory[item]++;
        showToast(`Beli ${item} sukses!`);
        if(typeof AudioService !== 'undefined') AudioService.playSFX('item'); // SFX Beli Item
        closeDialogue();

        // --- NEW: POPUP SPESIAL SAAT BELI BAJU PENGANTIN ---
        if (item === 'pakaian_nikah') {
            setTimeout(() => {
                showDialogue("ITEM SPESIAL! ", 
                    "Selamat! Kamu berhasil membeli **BAJU PENGANTIN**.\n\nBusana anggun dari sutra terbaik.\n(Cek Lemari Pakaian di rumah untuk memakainya)", 
                    [{text: "Cantik Sekali!", action: closeDialogue}], 
                    'images/lemari.png'
                );
                if(typeof AudioService !== 'undefined') AudioService.playSFX('item');
            }, 1000);
        }

    } else showToast("Uang kurang!");
}

// --- UPDATE: DYNAMIC GIFT MENU ---
function openGiftMenu(npc) {
    const inv = STATE.player.inventory || {};
    const opts = [];
    
    // Daftar item yang bisa dihadiahkan
    const giftableItems = [
        {id: 'coklat', name: 'Coklat'},
        {id: 'bunga', name: 'Bunga'},
        {id: 'ikan_segar', name: 'Ikan Segar'},
        {id: 'gandum', name: 'Gandum'},
        {id: 'kain', name: 'Kain Sutra'},
        {id: 'besi', name: 'Bijih Besi'},
        {id: 'permata', name: 'Berlian'},
        {id: 'tonic_stamina', name: 'Tonic Stamina'},
        {id: 'buku_tesis', name: 'Buku Tesis'}
    ];

    giftableItems.forEach(g => {
        if (inv[g.id] > 0) {
            opts.push({
                text: `${g.name} (x${inv[g.id]})`, 
                action: () => giveGift(npc, g.id)
            });
        }
    });
    
    opts.push({text: "Kembali", action: () => interactNPC(npc)});
    
    if(opts.length === 1) showDialogue(npc.name, "Tas kamu kosong! Beli hadiah di Merchant atau cari item dulu.", opts, npc.imgSrc);
    else showDialogue(npc.name, "Mau kasih apa?", opts, npc.imgSrc);
}

// --- UPDATE: PREFERENCE & REACTION SYSTEM ---
function openTradingMenu(npc) {
    const opts = [];
    
    COMMODITIES.forEach(c => {
        const currentPrice = getDailyPrice(c.id, c.base, c.volatility);
        const owned = (STATE.player.inventory[c.id] || 0);
        
        let trendIcon = "";
        if(currentPrice < c.base * 0.9) trendIcon = " MURAH";
        else if(currentPrice > c.base * 1.1) trendIcon = " MAHAL";
        
        opts.push({
            text: `${c.name}: ${currentPrice.toLocaleString()} G (Punya: ${owned}) [${trendIcon}]`,
            action: () => showCommodityAction(c, currentPrice, npc)
        });
    });
    
    opts.push({text: "Kembali", action: () => interactNPC(npc)});
    
    showDialogue("PASAR KOMODITAS", `Hari ke-${STATE.day}. Harga berfluktuasi setiap pagi. \nModal: ${STATE.player.money.toLocaleString()} G`, opts, npc.imgSrc);
}

function giveGift(npc, item) {
    // 1. DEFINISI KESUKAAN (PREFERENCES)
    const preferences = {
        'lover1girl': { // AYU (Ceria)
            likes: ['bunga', 'coklat', 'gandum', 'kain', 'permata'], 
            dislikes: ['besi', 'ikan_segar', 'tonic_stamina'] 
        },
        'lover2girl': { // PUTRI (Pemalu/Scholar)
            likes: ['buku_tesis', 'bunga', 'permata', 'kain'], 
            dislikes: ['ikan_segar', 'besi', 'tonic_stamina'] 
        },
        'lover2boy': { // SATRIA (Ksatria/Tegas)
            likes: ['besi', 'tonic_stamina', 'ikan_segar', 'permata'], 
            dislikes: ['bunga', 'coklat', 'kain'] 
        },
        'lover1boy': { // DR. BUDI (Dokter/Loveable)
            likes: ['ikan_segar', 'gandum', 'tonic_stamina', 'bunga'], 
            dislikes: ['coklat', 'besi'] 
        },
        // NEW: PREFERENSI CINTA MATRE (Hanya Suka Barang Mahal)
        'lover_matre_girl': { 
            likes: ['permata', 'kain', 'cincin_legend', 'zirah_legend'], // Suka Luxury
            dislikes: ['ikan_segar', 'besi', 'gandum', 'bunga', 'coklat'] // Gak suka barang murah/biasa
        },
        'lover_matre_boy': { 
            likes: ['permata', 'besi', 'tonic_stamina'], // Suka barang berharga/gym
            dislikes: ['bunga', 'gandum', 'kain'] 
        }
    };

    // 2. TENTUKAN DAMPAK & TIPE REAKSI
    let impact = 1; // Default Neutral (+1)
    let reactionType = 'neutral';
    
    if (preferences[npc.id]) {
        if (preferences[npc.id].likes.includes(item)) {
            impact = 5; // Suka (+5)
            reactionType = 'love';
        } else if (preferences[npc.id].dislikes.includes(item)) {
            impact = -2; // Tidak Suka (-2)
            reactionType = 'hate';
        }
    }

    // 3. KURANGI ITEM
    STATE.player.inventory[item]--;
    if(STATE.player.inventory[item] <= 0) delete STATE.player.inventory[item];

    // 4. UPDATE HUBUNGAN VISUAL
    // Gunakan "Cinta" jika naik, "Kecewa" jika turun
    let label = impact > 0 ? "Cinta" : "Kecewa";
    updateRelationship(npc, impact, label);

    // 5. RESPO DIALOG BERDASARKAN KEPRIBADIAN
    let dialogueText = "";

    // --- AYU (CERIA) ---
    if (npc.id === 'lover1girl') {
        if (reactionType === 'love') dialogueText = "Wahhh! Ini kesukaanku! Kamu tau banget sih! Makasih ya! ";
        else if (reactionType === 'hate') dialogueText = "Eh... makasih... tapi aku kurang suka ginian. Baunya aneh/nggak cocok buatku. ";
        else dialogueText = "Makasih ya! Kamu baik deh ngasih ini."; // Neutral
    }
    // --- PUTRI (PEMALU) ---
    else if (npc.id === 'lover2girl') {
        if (reactionType === 'love') dialogueText = "I-ini... beneran buat aku? A-aku suka banget... T-terima kasih... >///<";
        else if (reactionType === 'hate') dialogueText = "A-anu... maaf... a-aku agak takut sama benda ini... T_T";
        else dialogueText = "Terima kasih... aku simpan ya."; // Neutral
    }
    // --- SATRIA (TEGAS) ---
    else if (npc.id === 'lover2boy') {
        if (reactionType === 'love') dialogueText = "Luar biasa! Ini item yang berguna untuk memperkuat diri. Terima kasih atas dukunganmu.";
        else if (reactionType === 'hate') dialogueText = "Maaf, saya prajurit. Saya tidak butuh benda-benda lembek seperti ini.";
        else dialogueText = "Terima kasih. Akan saya gunakan sebaik-baiknya."; // Neutral
    }
    // --- DR. BUDI (MANIS) ---
    else if (npc.id === 'lover1boy') {
        if (reactionType === 'love') dialogueText = "Wah, nutrisinya pas banget! Kamu perhatian banget sama kesehatan saya. Makasih manis! ";
        else if (reactionType === 'hate') dialogueText = "Waduh, ini kurang sehat lho. Jangan sering-sering pegang ginian ya.";
        else dialogueText = "Makasih ya! Nanti saya cek kegunaannya."; // Neutral
    }
    // --- NEW: RESPON MATRE ---
    else if (npc.id.includes('matre')) {
        if (reactionType === 'love') dialogueText = "Wahhh! Mahal nih pasti! Kamu emang paling ngerti seleraku. Makasih ya sayang! (Hati: Naik Pesat) ";
        else if (reactionType === 'hate') dialogueText = "Iuh... apaan ini? Murahan banget. Jauh-jauh deh, nanti tanganku kotor.";
        else dialogueText = "Hmm, lumayan. Tapi lain kali kasih yang lebih mahal ya?";
    }
    // --- NPC BIASA (MENTOR DLL) ---
    else {
        if (reactionType === 'love') dialogueText = "Wow! Terima kasih banyak!";
        else if (reactionType === 'hate') dialogueText = "Hmm, aku kurang butuh ini.";
        else dialogueText = "Terima kasih.";
    }

    showDialogue(npc.name, dialogueText, [{text:"Sama-sama", action:closeDialogue}], npc.imgSrc);
}

function showCommodityAction(item, price, npc) {
    const p = STATE.player;
    const owned = p.inventory[item.id] || 0;
    
    showDialogue(`TRANSAKSI: ${item.name}`, 
        `Harga Pasar: ${price.toLocaleString()} G \n(Normal: ${item.base.toLocaleString()} G) \n\nUangmu: ${p.money.toLocaleString()} G \nStokmu: ${owned}`, 
        [
            {text: `Beli 1 (-${price.toLocaleString()})`, action: () => executeTrade(item.id, price, 1, 'buy', npc)},
            {text: `Beli 5 (-${(price*5).toLocaleString()})`, action: () => executeTrade(item.id, price, 5, 'buy', npc)},
            {text: `Jual 1 (+${price.toLocaleString()})`, action: () => executeTrade(item.id, price, 1, 'sell', npc)},
            {text: `Jual SEMUA`, action: () => executeTrade(item.id, price, 'all', 'sell', npc)},
            {text: "Kembali", action: () => openTradingMenu(npc)}
        ], npc.imgSrc);
}

function executeTrade(id, price, qty, type, npc) {
    const p = STATE.player;
    if(!p.inventory[id]) p.inventory[id] = 0;

    if(type === 'buy') {
        const cost = price * qty;
        if(p.money >= cost) {
            p.money -= cost;
            p.inventory[id] += qty;
            showToast(`Membeli ${qty} ${id.toUpperCase()}`);
            if(typeof AudioService !== 'undefined') AudioService.playSFX('item'); // SFX Trading Beli
        } else {
            showToast("Uang tidak cukup!");
        }
    } else if(type === 'sell') {
        let amount = qty;
        if(qty === 'all') amount = p.inventory[id];
        
        if(p.inventory[id] >= amount && amount > 0) {
            const profit = price * amount;
            p.inventory[id] -= amount;
            p.money += profit;
            showToast(`Menjual ${amount} ${id.toUpperCase()} (+${profit})`);
            if(typeof AudioService !== 'undefined') AudioService.playSFX('item'); // SFX Trading Jual
        } else {
            showToast("Barang tidak cukup!");
        }
    }
    showCommodityAction(COMMODITIES.find(c=>c.id===id), price, npc);
}

// --- FIX: MENGHAPUS FUNGSI DUPLIKAT YANG MENYEBABKAN ERROR REPUTASI ---
// Fungsi giveGift(npc, item, value) di bawah ini telah dihapus karena menimpa logika giveGift utama.
// Sistem sekarang akan menggunakan fungsi giveGift(npc, item) yang memiliki database likes/dislikes di atas.

// --- NEW FUNCTION: GENERATE PLAIN TEXT MISSION LIST ---
function getMissionBoardText() {
    const p = STATE.player;
    const role = p.role;
    const day = STATE.day;
    
    // Helpers Visual Teks (Tanpa HTML)
    const chk = (cond) => cond ? "" : "";
    const prg = (cur, target, unit='') => `(${cur}/${target}${unit})`;

    let txt = `=== PAPAN MISI (HARI KE-${day}) ===\n\n`;

    // 1. MISI UMUM
    txt += `[UMUM]\n`;
    txt += `${chk(p.energy < 100)} Gunakan Energi (Aktivitas)\n`;
    
    // 2. MISI ROLE
    if(role !== 'none') {
        txt += `\n[ROLE: ${role.toUpperCase()}]\n`;
        if(role === 'worker') {
            // FIX: Tambahkan Misi Lamar Kerja jika menganggur
            if(p.jobStatus === 'unemployed') {
                txt += `${chk(false)} Pergi ke Merchant (Selatan)\n`;
                txt += `${chk(false)} Lamar Kerja pada Bos\n`;
            } else {
                // UPDATE: TEXT HARI AHAD
                const dayIndex = (day - 1) % 7;
                if (dayIndex === 6) {
                    txt += ` Libur Kerja (Hari Ahad)\n`;
                } else {
                    txt += `${chk(p.shiftStarted)} Masuk Shift (08:00-16:00)\n`;
                }
                txt += `${chk(p.energy < 50)} Latihan Fisik/Kerja ${chk(p.energy < 50) === "" ? "(Selesai)" : "(Belum)"}\n`;
            }
        } else if(role === 'student') {
            // UPDATE: TEKS MISI SAAT LIBUR
            const dayIndex = (day - 1) % 7;
            const isWeekend = (dayIndex === 5 || dayIndex === 6);

            if (isWeekend) {
                txt += ` Kuliah Libur (Akhir Pekan)\n`;
            } else {
                // FIX: Gunakan p.lastAttendanceDay agar konsisten dengan Jurnal Quest
                const isKuliah = p.lastAttendanceDay === day; 
                txt += `${chk(isKuliah)} Hadir Kuliah (Kampus)\n`;
            }
            txt += `${chk(p.energy < 70)} Belajar Mandiri\n`;
            txt += `${chk(STATE.location === 'library_interior')} Riset di Perpustakaan\n`;
        } else if(role === 'entrepreneur') {
            // UPDATE: TEKS MISI WIRAUSAHA DI PAPAN
            txt += `${chk(STATE.location === 'merchant_interior')} Pantau Harga Pasar (Merchant)\n`;
            txt += `${chk(Object.values(p.inventory).some(v=>v>0))} Stok Komoditas Dagang\n`;
            txt += `${chk(p.biz >= p.level*2)} Riset Bisnis (BIZ)\n`;
        } else if(role === 'family') {
            txt += `${chk(p.energy < 80)} Bantu Tetangga\n`;
            txt += `${chk(false)} Sapa 2 Orang Berbeda\n`;
        }
    } else {
        txt += `\n[MISI UTAMA]\n`;
        txt += `${chk(false)} Temui Mentor Budi\n`;
        txt += `${chk(false)} Tidur & Pilih Role\n`;
    }

    // 3. TARGET MINGGUAN SINGKAT
    const week = Math.ceil(day / 7);
    const weekLvlTarget = week * 2;
    txt += `\n[MINGGUAN - Week ${week}]\n`;
    txt += `${chk(p.level >= weekLvlTarget)} Capai Level ${weekLvlTarget}\n`;
    
    // Tambahkan Info Dungeon jika Winter
    if(STATE.season === 'winter') {
        txt += `\n[MUSIM DINGIN]\n`;
        txt += `${chk(STATE.dungeonLevel >= 2)} Eksplorasi Dungeon Lt.2\n`;
    }

        return txt;
}

// --- NEW FUNCTION: GUILD BOUNTY SYSTEM ---
function handleGuildMissions() {
    const p = STATE.player;
    
    // Inisialisasi atau Reset Harian (Jika hari berganti, reset status klaim)
    if (!p.guildMissionClaims || p.guildMissionClaims.day !== STATE.day) {
        p.guildMissionClaims = { 
            day: STATE.day, 
            hunt: false, 
            collect_iron: false, 
            collect_scroll: false 
        };
    }
    
    const claims = p.guildMissionClaims;
    const killCount = p.dailyMonsterKills || 0;
    
    // Cek Stok Item di Tas
    const hasIron = (p.inventory['besi'] || 0) >= 2;
    const hasScroll = (p.inventory['scroll_exp'] || 0) >= 1;

    // --- MISI 1: PEMBURU MONSTER (Daily Kills) ---
    // Target: 3 Kill. Reward: 500 G
    let m1Text = " **Misi Pemburu**: Basmi 3 Monster";
    let m1Action = null;
    
    if (claims.hunt) {
        m1Text += " ( SELESAI)";
        m1Action = () => showToast("Misi ini sudah diambil hari ini.");
    } else if (killCount >= 3) {
        m1Text += " ( SIAP KLAIM!)";
        m1Action = () => claimGuildMission('hunt', 500, null, 0);
    } else {
        m1Text += ` ( Progress: ${killCount}/3)`;
        m1Action = () => showToast("Kalahkan monster di Dungeon!");
    }

    // --- MISI 2: PENGUMPUL BESI (Item Request) ---
    // Target: 2 Bijih Besi. Reward: 800 G
    let m2Text = " **Misi Logam**: Setor 2 Bijih Besi";
    let m2Action = null;

    if (claims.collect_iron) {
        m2Text += " ( SELESAI)";
        m2Action = () => showToast("Sudah disetor.");
    } else if (hasIron) {
        m2Text += " ( SIAP SETOR!)";
        m2Action = () => claimGuildMission('collect_iron', 800, 'besi', 2);
    } else {
        m2Text += " ( Belum Cukup)";
        m2Action = () => showToast("Cari Bijih Besi (Drop Monster/Boss)");
    }

    // --- MISI 3: PENCARI ILMU (Rare Item Request) ---
    // Target: 1 Gulungan Kuno. Reward: 1500 G
    let m3Text = " **Misi Artefak**: Setor 1 Gulungan Kuno";
    let m3Action = null;

    if (claims.collect_scroll) {
        m3Text += " ( SELESAI)";
        m3Action = () => showToast("Sudah disetor.");
    } else if (hasScroll) {
        m3Text += " ( SIAP SETOR!)";
        m3Action = () => claimGuildMission('collect_scroll', 1500, 'scroll_exp', 1);
    } else {
        m3Text += " ( Belum Punya)";
        m3Action = () => showToast("Cari Gulungan Kuno (Drop Rare di Dungeon)");
    }

    // Tampilkan Dialog
    const opts = [
        { text: m1Text, action: m1Action },
        { text: m2Text, action: m2Action },
        { text: m3Text, action: m3Action },
        { text: "Tutup", action: closeDialogue }
    ];

    showDialogue("GUILD BOUNTY BOARD", 
        "Daftar Buronan & Permintaan Logistik Hari Ini.\n(Reset setiap jam 24:00)", 
        opts, 
        'images/papanguild.png'
    );
}

function claimGuildMission(missionKey, rewardGold, itemReq, itemQty) {
    const p = STATE.player;

    // Jika ada syarat item, kurangi dari inventory
    if (itemReq) {
        if ((p.inventory[itemReq] || 0) < itemQty) {
            showToast("Item tidak cukup!");
            return;
        }
        p.inventory[itemReq] -= itemQty;
        if (p.inventory[itemReq] <= 0) delete p.inventory[itemReq];
    }

    // Beri Hadiah
    p.money += rewardGold;
    gainExp(50); // Bonus EXP
    
    // Tandai Selesai
    p.guildMissionClaims[missionKey] = true;

    // Efek Visual
    if(typeof AudioService !== 'undefined') AudioService.playSFX('item');
    createParticle(STATE.player.x, STATE.player.y, '#fbbf24');
    showToast(`Misi Sukses! +${rewardGold} G`);
    
    // Refresh Menu agar status terupdate
    handleGuildMissions();
    
    // Auto Save
    manualSave();
}

function interactObject(obj) {
    // --- NEW: HANDLING KHUSUS ARTIFAK CANDI (Agar Guci, Prasasti, Altar, Lilin bisa diinteraksi) ---
    if (STATE.location === 'candi_interior' && (obj.type === 'sign' || obj.type === 'shelf' || obj.type === 'table')) {
        let title = "ARTIFAK KUNO";
        // Ambil judul dari teks (sebelum titik dua)
        if (obj.text && obj.text.includes(":")) {
            title = obj.text.split(":")[0].toUpperCase();
        } else if (obj.text && obj.text.includes("Altar")) {
            title = "ALTAR SUCI";
        }
        
        showDialogue(title, obj.text || "...", [{text:"Tutup", action:closeDialogue}], obj.img);
        if(typeof AudioService !== 'undefined') AudioService.playSFX('item');
        return;
    }

    // --- NEW: INTERAKSI BUNGA LIAR (PETIK) ---
    if(obj.type === 'wild_flower') {
        showDialogue("BUNGA LIAR", "Sekuntum bunga cantik tumbuh di sini. Harumnya segar.", [
            {text: "Petik ", action: () => {
                // Tambah Item
                addItem('bunga', 1);
                showToast("Memetik Bunga Liar (+1 Bunga)");
                
                // Efek Audio & Visual
                if(typeof AudioService !== 'undefined') AudioService.playSFX('item');
                createParticle(obj.x * TILE_SIZE, obj.y * TILE_SIZE, '#f472b6'); // Pink particles
                
                // Hapus Objek dari Map
                const map = maps[STATE.location];
                const idx = map.objects.indexOf(obj);
                if(idx > -1) {
                    map.objects.splice(idx, 1);
                }
                
                // Tutup Dialog
                closeDialogue();
            }},
            {text: "Biarkan Tumbuh", action: closeDialogue}
        ], 'images/bunga.png'); // Tampilkan gambar bunga di dialog
        return;
    }

// --- [BARU] INTERAKSI BONEKA SALJU ---
    else if(obj.type === 'snowman') {
        if(typeof AudioService !== 'undefined') AudioService.playSFX('item'); // Suara lucu
        
        showDialogue("BONEKA SALJU ", 
            "Brrr... Dingin sekali ya? \n(Boneka salju ini tersenyum padamu dengan hidung wortelnya.)", 
            [
                {
                    text: "Hancurkan (Iseng)", 
                    action: () => {
                        // Hapus boneka salju
                        const map = maps[STATE.location];
                        const idx = map.objects.indexOf(obj);
                        if(idx > -1) {
                            map.objects.splice(idx, 1);
                            createParticle(obj.x*TILE_SIZE, obj.y*TILE_SIZE, '#ffffff');
                            showToast("Kamu menghancurkan boneka salju! ");
                            closeDialogue();
                        }
                    }
                },
                {text: "Lucu sekali", action: closeDialogue}
            ], 
            obj.img // Tampilkan gambar snowman
        );
        return;
    }   



   // FIX: Mengubah 'else if' menjadi 'if' karena ini adalah kondisi pertama
    if(obj.type === 'sign') {
        // --- UPDATE: LOGIKA DINAMIS UNTUK PAPAN MISI ---
        if (obj.id === 'papan_misi') {
            // Gunakan showDialogue agar teks panjang mudah dibaca, 
            // tapi format teksnya list sederhana (seperti request).
            const dynamicText = getMissionBoardText();
            showDialogue("PAPAN PENGUMUMAN", dynamicText, [{text:"Tutup", action:closeDialogue}], null);
        } 
        // --- NEW: PAPAN MISI GUILD (BOUNTY) ---
        else if (obj.id === 'guild_board') {
            handleGuildMissions();
        }
        else {
            // Sign biasa tetap pakai toast
            showToast(obj.text);
        }
    }
    // --- NEW: INTERAKSI BANGKU KAMPUS (BELAJAR TKJ) ---
    else if(obj.type === 'table' && STATE.location === 'school_interior') {
        showDialogue("BANGKU KAMPUS", "Ingin duduk sebentar dan mengasah pengetahuan seputar TKJ (Teknik Komputer & Jaringan)?", [
            {
                text: " Kerjakan Soal TKJ (Energi -10)", 
                action: () => {
                    closeDialogue();
                    startTKJStudy();
                }
            },
            {
                text: "Duduk santai saja", 
                action: () => {
                    showToast("Duduk beristirahat sejenak...");
                    closeDialogue();
                }
            },
            {text: "Tutup", action: closeDialogue}
        ], 'images/kursimahasiswa.png');
        return;
    }

    // --- NEW: INTEGRASI LOGIKA KERJA (MERCHANT SHELF & COUNTER) ---
    // Cek dulu apakah ini objek toko dan pemain adalah pekerja
    else if ((obj.type === 'shelf' || obj.type === 'counter') && STATE.location === 'merchant_interior' && STATE.player.role === 'worker') {
        handleWorkerInteraction(obj);
        return; // Stop di sini agar tidak lanjut ke logika shelf/counter umum (jika ada)
    }
    // --- NEW: INTERAKSI TOKO PLAYER (MANAJEMEN TOKO) ---
    else if (STATE.location === 'player_shop_interior' && STATE.player.role === 'entrepreneur') {
        if (obj.type === 'counter') {
            // Manajemen Toko (Collect Profit)
            const income = Math.floor(STATE.player.biz * 10 * (1 + Math.random())); // Simple passive income
            
            showDialogue("MANAJEMEN TOKO", `Level Bisnis: ${STATE.player.biz}\nEstimasi Pendapatan Harian: ${STATE.player.biz * 10} - ${STATE.player.biz * 20} G`, [
                {text: "Cek Penjualan (Collect)", action: () => {
                    // Hanya bisa collect sekali sehari (gunakan flag)
                    if (STATE.player.lastShopCollect !== STATE.day) {
                        STATE.player.money += income;
                        STATE.player.lastShopCollect = STATE.day;
                        // Tambah skill bisnis sedikit
                        STATE.player.biz += 1;
                        showToast(` Profit Hari Ini: ${income} G`);
                        if(typeof AudioService !== 'undefined') AudioService.playSFX('item');
                        closeDialogue();
                    } else {
                        showToast("Sudah ambil omset hari ini!");
                    }
                }},
                {text: "Tutup", action: closeDialogue}
            ], 'images/mejadosen.png');
            return;
        } else if (obj.type === 'shelf') {
            // UPDATE: Cek apakah ini Lemari Pakaian atau Rak Barang Dagangan
            // Jika namanya mengandung "Lemari", biarkan lanjut ke logika ganti baju di bawah
            if (!obj.text.includes("Lemari")) {
                showToast(" Rak Display Barang (Stok Otomatis)");
                return;
            }
        }
    }

// --- [BARU] INTERAKSI ETALASE TOKO (BELI ALAT & BARANG) ---
    else if (obj.type === 'shelf' && STATE.location === 'merchant_interior') {
        // Cek Nama Rak
        if (obj.text === "Etalase Perkakas") {
            showDialogue("TOKO PERKAKAS", "Menyediakan alat pertanian berkualitas.", [
                {text: " Beli Cangkul (500 G)", action: () => buyItem('cangkul', 500)},
                {text: " Beli Penyiram (300 G)", action: () => buyItem('penyiram', 300)}, // Opsional jika mau pakai item
                {text: "Tutup", action: closeDialogue}
            ], 'images/etalasetoko1.png');
            return;
        } 
        else if (obj.text === "Etalase Sembako") {
            showDialogue("TOKO SEMBAKO", "Bahan makanan pokok.", [
                {text: " Beli Roti (100 G)", action: () => buyItem('gandum', 100)}, // Anggap roti = gandum diolah
                {text: " Beli Ikan (150 G)", action: () => buyItem('ikan_segar', 150)},
                {text: "Tutup", action: closeDialogue}
            ], 'images/etalasetoko1.png');
            return;
        }
        // Biarkan rak lain menampilkan toast biasa
        showToast(obj.text);
        return;
    }
	
    // --- NEW: INTERAKSI LEMARI PAKAIAN (HOUSE & SHOP) - 4 OUTFIT SYSTEM ---
    // UPDATE: Kondisi ditambahkan untuk support 'player_shop_interior'
    else if (obj.type === 'shelf' && (STATE.location === 'house' || (STATE.location === 'player_shop_interior' && obj.text.includes("Lemari")))) {
        const p = STATE.player;
        
        // Helper ganti baju (lokal scope)
        const changeOutfit = (type) => {
		
			// --- TAMBAHAN BARU: SIMPAN JENIS BAJU KE STATE ---
            STATE.player.outfit = type; 
            // -------------------------------------------------
            const gender = p.gender;
            let suffix = "";
            let outfitName = "Seragam Sekolah";

            if (type === 'default') {
                suffix = ""; 
                outfitName = "Seragam Sekolah";
            } else if (type === 'wedding') {
                suffix = "-weding"; // Sesuai aset yang ada (typo di aset lama 'weding')
                outfitName = "Baju Pengantin";
            } else if (type === 'armor') {
                suffix = "-armor"; // Aset baru (pastikan file ada atau fallback)
                outfitName = "Zirah Abadi";
            } else if (type === 'special') {
                suffix = "-special"; // Aset baru
                outfitName = "Kostum Spesial";
            }

            // Update Source Gambar Player
            // Kita reset src image objek yang sudah ada di STATE.player
            if(p.spriteIdle) p.spriteIdle.src = `images/${gender}-idle${suffix}.png`;
            if(p.spriteWalk) p.spriteWalk.src = `images/${gender}-walk${suffix}.png`;
            if(p.spriteWalkUp) p.spriteWalkUp.src = `images/${gender}-atas${suffix}.png`;
            if(p.spriteWalkDown) p.spriteWalkDown.src = `images/${gender}-bawah${suffix}.png`;
            if(p.spriteAttack) p.spriteAttack.src = `images/${gender}-pukul${suffix}.png`;

            // Setup Fallback Error (Jika gambar baju belum ada, balik ke default)
            // Cukup pasang di spriteIdle sebagai indikator utama
            if(p.spriteIdle) {
                p.spriteIdle.onerror = function() { 
                    this.src = `images/${gender}-idle.png`; 
                    showToast(`Visual ${outfitName} belum tersedia, kembali ke default.`);
                };
            }

            showToast(`Berganti ke: ${outfitName}`);
            
            // Efek Partikel Ganti Baju
            createParticle(p.x, p.y, '#ffffff');
            if(typeof AudioService !== 'undefined') AudioService.playSFX('item');
            
            closeDialogue();
        };

        // Menu Pilihan Baju
        let clothesOpts = [];

        // 1. Seragam Sekolah (Default) - Selalu Ada
        clothesOpts.push({
            text: "Seragam Sekolah (Default)", 
            action: () => changeOutfit('default')
        });

        // 2. Baju Nikah (Syarat: Punya item 'pakaian_nikah' ATAU Sudah Menikah)
        if(p.inventory['pakaian_nikah'] || p.married) {
            clothesOpts.push({
                text: " Baju Pengantin", 
                action: () => changeOutfit('wedding')
            });
        } else {
            clothesOpts.push({
                text: " ??? (Baju Pengantin)", 
                action: () => showToast("Dapatkan 'Baju Pengantin' dari Marine (Penjahit) atau Misi.")
            });
        }

        // 3. Baju Zirah (Syarat: Punya item 'zirah_legend')
        if(p.inventory['zirah_legend']) {
            clothesOpts.push({
                text: " Zirah Abadi", 
                action: () => changeOutfit('armor')
            });
        } else {
            clothesOpts.push({
                text: " ??? (Drop Boss Dungeon)", 
                action: () => showToast("Kalahkan Boss Dungeon untuk dapat Zirah Abadi!")
            });
        }

        // 4. Baju Special (Syarat: Level 10 atau Item Khusus)
        // Kita buat syarat Level 10 sebagai 'Special'
        if(p.level >= 10 || p.inventory['kostum_special']) {
            clothesOpts.push({
                text: " Kostum Spesial (Lv 10)", 
                action: () => changeOutfit('special')
            });
        } else {
            clothesOpts.push({
                text: " ??? (Capai Level 10)", 
                action: () => showToast("Tingkatkan Levelmu sampai 10 untuk membuka!")
            });
        }

        clothesOpts.push({text: "Tutup", action: closeDialogue});

        showDialogue("LEMARI PAKAIAN", "Pilih pakaian untuk dikenakan hari ini:", clothesOpts, 'images/lemari.png');
        return;
    }

    else if(obj.type === 'bookshelf') {
        if(typeof AudioService !== 'undefined') AudioService.playSFX('item');
        showToast(` Membaca: "${obj.text}"`);
        // Sedikit EXP untuk membaca
        if(Math.random() < 0.3) { 
            gainExp(1); 
        }
    }
    // UPDATE: Logika Interaksi Kalender (Quest & Goal Tracker)
    else if(obj.type === 'calendar') {
        // Panggil fungsi UI Kalender Baru
        openCalendar();
    }
    // UPDATE: Logika Interaksi Kotak Surat (Inbox) dengan Arsip
    else if(obj.type === 'mailbox') {
        const msgs = STATE.player.messages || [];
        const unread = msgs.filter(m => !m.read);
        
        let dialogueText = "";
        let actions = [];

        if(msgs.length === 0) {
            dialogueText = "Kotak surat kosong. Belum ada pesan dari Guru.";
            actions = [{text: "Tutup", action: closeDialogue}];
        } else {
            // Tampilkan cuplikan pesan terbaru
            if(unread.length > 0) {
                dialogueText = `Anda memiliki ${unread.length} pesan baru!\n\nPesan Terbaru:\n"${msgs[msgs.length-1].text}"`;
                actions.push({text: "Tandai Semua Dibaca", action: () => {
                    STATE.player.messages.forEach(m => m.read = true);
                    showToast("Semua pesan ditandai dibaca ");
                    // Tetap di dialog agar bisa buka arsip setelah baca
                    interactObject(obj); 
                }});
            } else {
                dialogueText = "Tidak ada pesan baru. \nPesan Terakhir:\n" + `"${msgs[msgs.length-1].text}"`;
            }

            // TOMBOL BUKA ARSIP
            actions.push({text: " Lihat Arsip Pesan", action: () => {
                closeDialogue();
                openMessageArchive();
            }});

            actions.push({text: "Tutup", action: closeDialogue});
        }

        showDialogue("KOTAK SURAT", dialogueText, actions, 'images/pos.png');
    }
    /* Dungeon exit is now auto-triggered, removing manual interaction */
    /*
    else if(obj.type === 'dungeon_exit') {
        showDialogue("KELUAR DUNGEON", "Apakah kamu ingin kembali ke desa?", [
            {text: "YA", action: () => {
                STATE.location = 'village';
                STATE.player.x = 48 * TILE_SIZE; 
                STATE.player.y = 22 * TILE_SIZE;
                closeDialogue();
                showToast("Kembali ke Desa");
            }},
            {text: "TIDAK", action: closeDialogue}
        ], null);
    }
    */
    else if(obj.type === 'fishing_spot') {
        startFishingMinigame(); 
    }
    // --- NEW: INTERAKSI KASUR (TIDUR) ---
    else if(obj.type === 'bed') {
        if(typeof AudioService !== 'undefined') AudioService.playSFX('item'); 
        
        // UPDATE: Dialog Tidur yang lebih langsung sesuai request
        // UPDATE: Ganti gambar potret dialog ke images/bed.png
        showDialogue("KASUR EMPUK", "Apakah kamu mau tidur sekarang?", [
            {text: "Ya, Tidur (Save & Next Day) ", action: () => {
                // Cek apakah sudah nulis jurnal hari ini?
                const hasJournalToday = STATE.player.reflections.some(r => r.day === STATE.day);
                
                if (hasJournalToday) {
                    closeDialogue();
                    handleSleep();
                } else {
                    // UPDATE: Prompt Jurnal sebelum tidur
                    showDialogue("REFLEKSI HARIAN", 
                        "Sebelum tidur, mari refleksikan harimu sejenak di Jurnal.\n\n(Hadiah: +500 Gold & +50 EXP)", 
                        [{
                            text: " Tulis Jurnal", 
                            action: () => {
                                closeDialogue();
                                openJournalModal(true); // true = mode tidur setelah simpan
                            }
                        }, {
                            text: "Batal Tidur", 
                            action: closeDialogue
                        }], 
                        'images/buku.png'
                    );
                }
            }},
            {text: "Belum ngantuk", action: closeDialogue}
        ], 'images/bed.png');
    }
    else if(obj.type === 'diary') {
        // UPDATE: Ganti 'bg' ke 'item' agar bunyi saat interaksi awal
        if(typeof AudioService !== 'undefined') AudioService.playSFX('item'); 

        let questText = "Simpan progress?";
        if(STATE.player.role === 'worker') {
            questText = "QUEST PEKERJA:\n1. Pergi ke Merchant (Gedung).\n2. Bicara pada Bos & Lamar Kerja.\n3. Masuk kerja jam 08:00 setiap pagi.\n4. Jangan terlambat agar tidak dipecat!";
        } else if(STATE.player.role === 'student') {
            questText = "QUEST SISWA:\n1. Masuk Kampus setiap pagi.\n2. Baca buku di rumah untuk INT.\n3. Kejar Beasiswa.";
        } else if(STATE.player.role === 'entrepreneur') {
             questText = "QUEST WIRAUSAHA:\n1. Beli murah di Merchant.\n2. Jual saat harga naik di Menu Trading.\n3. Kumpulkan 100k Gold.";
        } else if(STATE.player.role === 'family') {
             questText = "QUEST KELUARGA:\n1. Sapa tetangga (Interact).\n2. Cari pasangan di desa.\n3. Nabung untuk nikah.";
        }

        showDialogue("BUKU HARIAN", questText, [
            {text: " Penjelasan Status", action: () => {
                 showDialogue("PANDUAN STATUS", 
                 " STR: Kekuatan fisik. Berguna untuk kerja kasar & lawan monster.\n INT: Kecerdasan. Berguna untuk nilai kuliah & dialog pintar.\n BIZ: Bisnis. Meningkatkan profit dagang & diskon.\n REP: Reputasi. Penting untuk hubungan sosial & menikah.",
                 [{text: "Kembali", action: () => interactObject(obj)}], 'images/buku.png');
            }},
            
            /* --- NEW: MENU BELAJAR MANDIRI --- */
            {text: " Belajar Mandiri (Energy -15)", action: () => {
                closeDialogue();
                openSelfStudyMenu();
            }},
            
            /* UPDATE: HAPUS OPSI JURNAL & TIDUR DARI BUKU (SUDAH PINDAH KE KASUR) */
            
            {text: " Simpan Game (Save)", action: () => {
                manualSave();
                if(typeof AudioService !== 'undefined') AudioService.playSFX('item');
                showToast("Data Tersimpan! ");
                closeDialogue();
            }},
            
            {text: "Tutup", action: closeDialogue}
        ], 'images/buku.png'); // FIX: Menggunakan 'images/buku.png' untuk ikon dialog, tapi objeknya 'mejabuku.png'
    }
    else if(obj.type === 'catalog') {
        showDialogue("KATALOG BELANJA", "Beli Furnitur & Upgrade:", [
            {text: "Karpet Merah (50k)", action: () => buyFurniture('carpet_red', 50000)},
            {text: "TV Layar Datar (150k)", action: () => buyFurniture('tv_flat', 150000)},
            // --- NEW: RUMAH KURCACI DI KATALOG ---
            {text: " Rumah Kurcaci (150k)", action: () => buyFurniture('rumah_kurcaci', 150000)},
            {text: `UPGRADE RUMAH (LV ${STATE.player.houseLevel+1})`, action: () => upgradeHouse()},
            {text: "Tutup", action: closeDialogue}
        ], null);
    }
}

// --- NEW: LOGIKA SISTEM JURNAL & REWARD ---
let isSleepPending = false; // Flag global untuk menandai niat tidur

// --- NEW: DAFTAR PERTANYAAN REFLEKSI ACAK ---
const REFLECTION_QUESTIONS = [
    "Bagaimana harimu di dunia Nusantara Arsa?",
    "Bagaimana progress kehidupanmu di Nusantara Arsa sejauh ini?",
    "Hal apa yang paling seru di dunia Nusantara Arsa hari ini?",
    "Apa tantangan terbesar yang kamu hadapi hari ini?",
    "Siapa NPC yang paling berkesan bagimu hari ini?",
    "Apa rencanamu untuk hari esok?",
    "Pelajaran apa yang kamu dapatkan hari ini?",
    "Bagaimana kondisi keuanganmu? Apakah sudah cukup makmur?",
    "Apakah kamu sudah mendekati target impianmu (Lulus/Kaya/Nikah)?",
    "Adakah momen lucu atau menyedihkan hari ini?"
];

// --- NEW FUNCTION: BELAJAR MANDIRI ---
function openSelfStudyMenu() {
    const subjects = STATE.player.learnedSubjects || [];
    
    if (subjects.length === 0) {
        showDialogue("CATATAN KOSONG", 
            "Kamu belum memiliki catatan materi kuliah.\n\n**Hadir kuliah** (Jam 08:00 - 14:00) untuk mendapatkan ilmu yang bisa dipelajari ulang di sini.", 
            [{text: "Baiklah", action: closeDialogue}], 
            'images/buku.png'
        );
        return;
    }

    // Buat daftar opsi materi (Ambil 3 terakhir biar gak kepanjangan)
    const opts = [];
    // Reverse agar materi terbaru di atas
    const recentSubjects = [...subjects].reverse().slice(0, 3);

    recentSubjects.forEach(sub => {
        opts.push({
            text: ` ${sub.t}`,
            action: () => {
                if(STATE.player.energy >= 15) {
                    STATE.player.energy -= 15;
                    STATE.player.int += 1; // Reward kecil
                    gainExp(10);
                    
                    if(typeof AudioService !== 'undefined') AudioService.playSFX('item');
                    createParticle(STATE.player.x, STATE.player.y, '#3b82f6');
                    
                    showDialogue(`REVIEW: ${sub.t}`, 
                        `"${sub.c}"\n\n(Kamu mempelajari ulang materi ini. Pemahamanmu semakin dalam!)`, 
                        [{text: "Selesai Belajar", action: closeDialogue}], 
                        'images/buku.png'
                    );
                } else {
                    showToast("Energi tidak cukup (Butuh 15)!");
                }
            }
        });
    });

    opts.push({text: "Kembali", action: closeDialogue});

    showDialogue("BELAJAR MANDIRI", "Pilih materi untuk dipelajari ulang (INT +1, EXP +10):", opts, 'images/buku.png');
}

function openJournalModal(fromSleep = false) {
    isSleepPending = fromSleep;
    const modal = document.getElementById('journal-modal');
    
    // --- UPDATE: PILIH PERTANYAAN ACAK ---
    const randomQ = REFLECTION_QUESTIONS[Math.floor(Math.random() * REFLECTION_QUESTIONS.length)];
    const qElement = document.getElementById('journal-question');
    if(qElement) {
        qElement.innerText = randomQ;
    }

    // Reset textarea
    document.getElementById('journal-input').value = "";
    modal.style.display = 'flex';
    STATE.screen = 'modal';
}

function closeJournal() {
    const modal = document.getElementById('journal-modal');
    modal.style.display = 'none';
    STATE.screen = 'play';
    isSleepPending = false; // Reset flag jika batal
    
    // FIX: Kembalikan ke Fullscreen setelah menutup jurnal (karena keyboard menutup fullscreen)
    toggleFullScreen();
}

// --- NEW FUNCTION: MESSAGE ARCHIVE LOGIC ---
function openMessageArchive() {
    if(typeof AudioService !== 'undefined') AudioService.playSFX('item');
    
    const modal = document.getElementById('message-archive-modal');
    const list = document.getElementById('message-list');
    const msgs = STATE.player.messages || [];
    
    list.innerHTML = '';
    
    if(msgs.length === 0) {
        list.innerHTML = '<div style="text-align:center; color:#94a3b8; padding:20px;">Belum ada pesan yang tersimpan.</div>';
    } else {
        // Tampilkan dari yang terbaru ke terlama
        [...msgs].reverse().forEach(m => {
            // Format Waktu
            let dateStr = "Waktu Tidak Diketahui";
            if(m.time) {
                const date = new Date(m.time);
                dateStr = `${date.getDate()}/${date.getMonth()+1} ${date.getHours()}:${date.getMinutes().toString().padStart(2,'0')}`;
            }
            
            const div = document.createElement('div');
            div.style.cssText = "background:rgba(255,255,255,0.05); padding:12px; margin-bottom:10px; border-left:4px solid var(--secondary); border-radius:4px;";
            div.innerHTML = `
                <div style="font-size:10px; color:#94a3b8; display:flex; justify-content:space-between; margin-bottom:6px; border-bottom:1px dashed rgba(255,255,255,0.1); padding-bottom:4px;">
                    <span style="font-weight:bold; color:var(--primary);">DARI: GURU</span>
                    <span> ${dateStr}</span>
                </div>
                <div style="font-size:13px; color:#e2e8f0; line-height:1.5; font-family:'Exo 2'; white-space: pre-wrap;">${m.text}</div>
            `;
            list.appendChild(div);
        });
    }
    
    modal.style.display = 'flex';
    STATE.screen = 'modal';
}

function closeMessageArchive() {
    document.getElementById('message-archive-modal').style.display = 'none';
    STATE.screen = 'play';
}

function saveJournal() {
    const input = document.getElementById('journal-input');
    const text = input.value.trim();
    
    if (text.length < 5) {
        alert("Tulislah refleksi yang bermakna (min. 5 karakter)! Guru ingin tahu kegiatanmu.");
        return;
    }

    // 1. Simpan Data Jurnal
    const entry = {
        day: STATE.day,
        date: Date.now(), // Real timestamp
        text: text
    };
    
    if (!STATE.player.reflections) STATE.player.reflections = [];
    STATE.player.reflections.push(entry);

    // 2. Beri Reward (Gold + EXP)
    const goldReward = 500;
    const expReward = 50;
    STATE.player.money += goldReward;
    gainExp(expReward);

    // FIX: Paksa simpan ke database/cloud segera agar data Jurnal tidak hilang/delay
    // Sebelumnya hanya mengandalkan auto-save per 2 detik, yang berisiko data belum terkirim.
    showToast(" Mengirim Jurnal ke Cloud..."); // Feedback Visual
    manualSave();

    // 3. Feedback Visual & Audio
    if(typeof AudioService !== 'undefined') AudioService.playSFX('item');
    // showToast diganti di atas agar tidak tertumpuk cepat
    
    createParticle(STATE.player.x, STATE.player.y, '#fbbf24'); // Partikel Emas

    // 4. Tutup Modal
    const modal = document.getElementById('journal-modal');
    modal.style.display = 'none';
    STATE.screen = 'play';

    // 5. Cek apakah ini triggered dari Tidur?
    if (isSleepPending) {
        isSleepPending = false;
        
        // FIX: GANTI CONFIRM BROWSER DENGAN DIALOG GAME
        // Confirm() bawaan browser menyebabkan mobile keluar dari fullscreen.
        // Kita ganti dengan showDialogue agar tetap imersif.
        setTimeout(() => {
            showDialogue("JURNAL TERSIMPAN", "Data refleksi berhasil dicatat.\nApakah kamu ingin melanjutkan tidur?", [
                {
                    text: "Ya, Tidur Sekarang (Zzz) ", 
                    action: () => {
                        // FIX: Panggil toggleFullScreen() lagi untuk memastikan layar penuh
                        // Browser butuh interaksi user (klik tombol ini) untuk trigger fullscreen
                        toggleFullScreen(); 
                        handleSleep();
                    }
                },
                {
                    text: "Nanti Dulu", 
                    action: () => {
                        closeDialogue();
                        toggleFullScreen(); // Kembalikan fullscreen jika batal
                    }
                }
            ], 'images/buku.png');
        }, 500);
    } else {
        // Jika jurnal manual (bukan mau tidur), kembalikan fullscreen langsung
        toggleFullScreen();
        showToast(` Jurnal Tersimpan! (+${goldReward}G)`);
    }
}

function startFishingMinigame() {
    if(STATE.player.energy < 10) {
        showToast("Energi tidak cukup!");
        return;
    }
    STATE.player.energy -= 10;
    STATE.fishing.active = true;
    STATE.fishing.barX = 0;
    STATE.fishing.targetStart = 30 + Math.random() * 40; 
    STATE.fishing.targetWidth = 15;
    STATE.screen = 'play'; 
    showToast("Tekan AKSI (Space/Tombol) saat di Hijau!");
}

function checkFishing() {
    if(!STATE.fishing.active) return;
    STATE.fishing.active = false;
    
    if(STATE.fishing.barX >= STATE.fishing.targetStart && STATE.fishing.barX <= (STATE.fishing.targetStart + STATE.fishing.targetWidth)) {
        // --- UPDATE: SISTEM MANCING DENGAN TIER IKAN & RARITY ---
        
        // UPDATE: TAMBAH COUNTER MANCING BERHASIL
        STATE.player.dailyFishingCount = (STATE.player.dailyFishingCount || 0) + 1;

        const rand = Math.random() * 100;
        let fishId = 'ikan_kecil';
        let fishName = 'Ikan Kecil';
        let fishImg = 'images/ikankecil.png'; // Default Image
        let rarityLabel = '[COMMON]';
        let rarityColor = '#94a3b8'; // Abu-abu
        let expGain = 15;
        let value = 200;

        // Probabilitas Rarity (Total 100%):
        // 0 - 3    (3%)  : LEGENDARY (Ikan Legendaris)
        // 3 - 18   (15%) : RARE (Ikan Besar)
        // 18 - 50  (32%) : UNCOMMON (Ikan Sedang)
        // 50 - 100 (50%) : COMMON (Ikan Kecil)
        
        if (rand < 3) { 
            fishId = 'ikan_legendary'; 
            fishName = ' IKAN LEGENDARIS ';
            rarityLabel = '[LEGENDARY]';
            rarityColor = '#fbbf24'; // Emas
            fishImg = 'images/ikanlegendary.png';
            expGain = 200;
            value = 5000;
        } else if (rand < 18) {
            fishId = 'ikan_besar';
            fishName = 'Ikan Besar';
            rarityLabel = '[RARE]';
            rarityColor = '#f472b6'; // Pink/Ungu
            fishImg = 'images/ikanbesar.png';
            expGain = 50;
            value = 1500;
        } else if (rand < 50) {
            fishId = 'ikan_sedang';
            fishName = 'Ikan Sedang';
            rarityLabel = '[UNCOMMON]';
            rarityColor = '#38bdf8'; // Biru Muda
            fishImg = 'images/ikansedang.png';
            expGain = 25;
            value = 600;
        } else {
            fishId = 'ikan_kecil';
            fishName = 'Ikan Kecil';
            rarityLabel = '[COMMON]';
            rarityColor = '#cbd5e1'; // Putih Abu
            fishImg = 'images/ikankecil.png';
            expGain = 10;
            value = 200;
        }
        
        if(!STATE.player.inventory[fishId]) STATE.player.inventory[fishId] = 0;
        STATE.player.inventory[fishId]++;
        
        // Reward EXP for success
        gainExp(expGain);

        // Feedback Visual & Audio
        if(typeof AudioService !== 'undefined') AudioService.playSFX('item'); // SFX Mancing Dapat Ikan
        createParticle(STATE.player.x, STATE.player.y, rarityColor); // Partikel sesuai warna rarity

        // --- UPDATE: TAMPILAN GAMBAR BESAR (POPUP DIALOG) ---
        // Menampilkan Dialog "Mendapatkan Item" dengan Gambar Ikan Besar di Kiri
        showDialogue(
            "TANGKAPAN BERHASIL!", 
            `Kamu mendapatkan:\n**${fishName}**\n\n(Item telah dimasukkan ke dalam Tas)`, 
            [{
                text: "Simpan ", 
                action: closeDialogue
            }], 
            fishImg // Gambar Ikan ditampilkan besar di sini
        );

    } else {
        showToast("GAGAL... Ikan lepas.");
    }
}

// --- NEW FUNCTION: GAIN EXP ---
function gainExp(amount) {
    STATE.player.exp += amount;
    showToast(`+${amount} EXP`);
    
    if(STATE.player.exp >= STATE.player.maxExp) {
        STATE.player.exp = STATE.player.exp - STATE.player.maxExp; // Sisa EXP dibawa ke level berikutnya
        STATE.player.maxExp = Math.floor(STATE.player.maxExp * 1.5);
        STATE.player.level++;
        
        // 1. Recover HP/Energy (Full Heal saat Level Up)
        STATE.player.energy = 100; 
        STATE.player.hp = STATE.player.maxHp;
        
        // 2. Base Stat Increase (Semua naik sedikit)
        STATE.player.str += 1;
        STATE.player.int += 1;
        STATE.player.biz += 1;
        STATE.player.reputation += 1;
        STATE.player.maxHp += 5; // Tambah darah sedikit

        // 3. Bonus Role Stat (Spesialisasi naik banyak)
        let bonusText = "";
        if(STATE.player.role === 'worker') { STATE.player.str += 2; bonusText = "STR++"; }
        else if(STATE.player.role === 'student') { STATE.player.int += 2; bonusText = "INT++"; }
        else if(STATE.player.role === 'entrepreneur') { STATE.player.biz += 2; bonusText = "BIZ++"; }
        else if(STATE.player.role === 'family') { STATE.player.reputation += 2; bonusText = "REP++"; }

        showToast(`LEVEL UP! LV ${STATE.player.level} (All Stats+1, ${bonusText}) `);
        createParticle(STATE.player.x, STATE.player.y, '#6366f1');
        
        // --- NEW: POPUP UNLOCK KOSTUM SPESIAL (LEVEL 10) ---
        if (STATE.player.level === 10) {
            setTimeout(() => {
                showDialogue("HADIAH LEVEL 10! ", 
                    "Selamat! Kamu telah mencapai Level 10.\n\nSebagai penghargaan, **KOSTUM SPESIAL** kini telah terbuka di Lemari Pakaianmu!\n\n(Cek Lemari di Rumah untuk memakainya)", 
                    [{text: "Keren! Terima Kasih!", action: closeDialogue}], 
                    'images/lemari.png'
                );
                if(typeof AudioService !== 'undefined') AudioService.playSFX('item');
            }, 1000);
        }
        
        // Play SFX Level Up (Reuse Item SFX or add new one)
        if(typeof AudioService !== 'undefined') AudioService.playSFX('item');
        
        // Update HUD langsung
        updateHUDInfo();
        
        // Auto Save saat level up untuk mengamankan progress
        manualSave();
    }
}

// --- NEW FUNCTION: MANUAL SAVE ---
function manualSave() {
    DataService.saveGame({
        // 1. Waktu & Lingkungan
        day: STATE.day,
        time: STATE.time, // Penting agar tidak reset ke pagi
        season: STATE.season,
        weather: STATE.weather,

        // 2. Status Fisik & Level
        hp: STATE.player.hp,
        maxHp: STATE.player.maxHp,
        energy: STATE.player.energy,
        money: STATE.player.money,
        level: STATE.player.level,
        exp: STATE.player.exp,
        maxExp: STATE.player.maxExp,
        gender: STATE.player.gender,
		
		// --- TAMBAHAN BARU: SIMPAN DATA OUTFIT ---
        outfit: STATE.player.outfit, 
        // -----------------------------------------

        // 3. Role & Career
        role: STATE.player.role,
        major: STATE.player.major,
        scholarship: STATE.player.scholarship,
        jobStatus: STATE.player.jobStatus,
        bossReputation: STATE.player.bossReputation,
        // NEW: SAVE JOB LEVEL
        jobLevel: STATE.player.jobLevel,
        
        shiftStarted: STATE.player.shiftStarted, // Simpan status sedang kerja
        salaryDays: STATE.player.salaryDays,
        lastAttendanceDay: STATE.player.lastAttendanceDay,

        // 4. Stats Attribute
        str: STATE.player.str,
        int: STATE.player.int,
        biz: STATE.player.biz,
        reputation: STATE.player.reputation,
        ethics: STATE.player.ethics,
        
        // 5. Inventory & Aset
        inventory: STATE.player.inventory, // PENTING: Tas
        houseLevel: STATE.player.houseLevel,
        furniture: STATE.player.furniture,
        // NEW: SIMPAN STATUS KURCACI
        hiredDwarf: STATE.player.hiredDwarf,
		hiredFairy: STATE.player.hiredFairy, // <--- TAMBAHKAN INI

        // 6. Hubungan Sosial
        relationships: STATE.player.relationships, // PENTING: Hati NPC
        married: STATE.player.married,
        spouseId: STATE.player.spouseId,

        // 7. Quest & Progress Dungeon
        activeQuest: STATE.player.activeQuest,
        questProgress: STATE.questProgress,
        dungeonLevel: STATE.dungeonLevel,

        // 8. Game State Flags
        gameFinished: STATE.gameFinished,
        freeRoamMode: STATE.freeRoamMode,
        isPrologue: STATE.isPrologue,

        // 9. Claims & Trackers Reward
        lastDailyClaim: STATE.player.lastDailyClaim,
        lastWeeklyClaim: STATE.player.lastWeeklyClaim,
        lastMonthlyClaim: STATE.player.lastMonthlyClaim,
        claimedLifeTrial: STATE.player.claimedLifeTrial,
        lastHarvestGiftYear: STATE.player.lastHarvestGiftYear, // NEW: Simpan Status Hadiah Kurcaci
        lastGrapeGiftYear: STATE.player.lastGrapeGiftYear, // NEW: Simpan Status Hadiah Peri Panen
        hasSeenDungeonTutorial: STATE.player.hasSeenDungeonTutorial,
        hasSeenFishingTutorial: STATE.player.hasSeenFishingTutorial, // NEW: Save Fishing Tutorial
        
        // NEW: SIMPAN PROGRESS HARIAN
        dailyFishingCount: STATE.player.dailyFishingCount || 0,
        dailyMonsterKills: STATE.player.dailyMonsterKills || 0,
        dailyTalkCount: STATE.player.dailyTalkCount || 0, // Save Talk Count

        // 10. Pesan & Jurnal & MATERI KULIAH
        reflections: STATE.player.reflections,
        messages: STATE.player.messages,
        learnedSubjects: STATE.player.learnedSubjects || [] // FIX: Simpan Array Mata Pelajaran
    });
}

// --- FIX: FUNGSI MEMANCING YANG DIPERBAIKI (TIDAK DUPLIKAT) ---
function startFishingMinigame() {
    // --- NEW: TUTORIAL MEMANCING (FIRST TIME ONLY) ---
    if (!STATE.player.hasSeenFishingTutorial) {
        showDialogue("TUTORIAL MEMANCING ", 
            "Halo pemula! Ingin menangkap ikan? Caranya mudah:\n\n1. Perhatikan **Bar Indikator** yang bergerak.\n2. Tekan **Tombol Aksi ()** atau **Spasi** tepat saat garis putih berada di area **HIJAU**.\n\nSetiap kali melempar kail, kamu butuh **10 Energi**. Ikan yang didapat bisa dimakan untuk pulihkan tenaga atau dijual!", 
            [{
                text: "Siap, Saya Mengerti!", 
                action: () => {
                    STATE.player.hasSeenFishingTutorial = true;
                    manualSave(); // Simpan agar tidak muncul lagi
                    closeDialogue();
                    // Jeda sedikit sebelum mulai minigame
                    setTimeout(startFishingMinigame, 500);
                }
            }], 
            'images/nelayan.png' // Menggunakan gambar Pak Nelayan sebagai tutor
        );
        return;
    }

    if(STATE.player.energy < 10) {
        showToast("Energi tidak cukup!");
        return;
    }
    
    // Kurangi Energi & Mulai Minigame
    STATE.player.energy -= 10;
    STATE.fishing.active = true;
    STATE.fishing.barX = 0;
    STATE.fishing.barDir = 1; // FIX: Reset Arah Gerak agar tidak macet
    STATE.fishing.targetStart = 30 + Math.random() * 40; 
    STATE.fishing.targetWidth = 15;
    
    STATE.screen = 'play'; 
    showToast("Tekan AKSI (Space/Tombol) saat di Hijau!");
}

// --- FIX: FUNGSI CEK HASIL PANCINGAN (DIPASTIKAN ADA) ---
function checkFishing() {
    if(!STATE.fishing.active) return;
    STATE.fishing.active = false; // Stop bar movement
    
    // Cek apakah barX berada di dalam area target (Hijau)
    if(STATE.fishing.barX >= STATE.fishing.targetStart && STATE.fishing.barX <= (STATE.fishing.targetStart + STATE.fishing.targetWidth)) {
        
        // UPDATE: TAMBAH COUNTER MANCING BERHASIL
        STATE.player.dailyFishingCount = (STATE.player.dailyFishingCount || 0) + 1;

        const rand = Math.random() * 100;
        let fishId = 'ikan_kecil';
        let fishName = 'Ikan Kecil';
        let fishImg = 'images/ikankecil.png';
        let rarityColor = '#94a3b8'; // Abu-abu
        let expGain = 15;

        // Probabilitas Rarity
        if (rand < 3) { 
            fishId = 'ikan_legendary'; fishName = ' IKAN LEGENDARIS '; rarityColor = '#fbbf24'; fishImg = 'images/ikanlegendary.png'; expGain = 200;
        } else if (rand < 18) {
            fishId = 'ikan_besar'; fishName = 'Ikan Besar'; rarityColor = '#f472b6'; fishImg = 'images/ikanbesar.png'; expGain = 50;
        } else if (rand < 50) {
            fishId = 'ikan_sedang'; fishName = 'Ikan Sedang'; rarityColor = '#38bdf8'; fishImg = 'images/ikansedang.png'; expGain = 25;
        } else {
            fishId = 'ikan_kecil'; fishName = 'Ikan Kecil'; rarityColor = '#cbd5e1'; fishImg = 'images/ikankecil.png'; expGain = 10;
        }
        
        if(!STATE.player.inventory[fishId]) STATE.player.inventory[fishId] = 0;
        STATE.player.inventory[fishId]++;
        
        gainExp(expGain);

        if(typeof AudioService !== 'undefined') AudioService.playSFX('item'); 
        createParticle(STATE.player.x, STATE.player.y, rarityColor);

        showDialogue("TANGKAPAN BERHASIL!", 
            `Kamu mendapatkan:\n**${fishName}**\n\n(Item telah dimasukkan ke dalam Tas)`, 
            [{text: "Simpan ", action: closeDialogue}], 
            fishImg
        );

    } else {
        showToast("GAGAL... Ikan lepas.");
        if(typeof AudioService !== 'undefined') AudioService.playSFX('hit');
    }
}

// --- NEW FUNCTION: HANDLE FAINT (PINGSAN) ---
function handleFaint() {
    // FIX: Tambahkan cek flag isDayChanging
    if(STATE.screen === 'cutscene' || STATE.isDayChanging) return;
    
    // FIX CRITICAL: Panggil closeDialogue DULUAN sebelum set cutscene
    // Karena closeDialogue() mereset screen jadi 'play'
    closeDialogue(); 
    
    STATE.screen = 'cutscene';
    STATE.isDayChanging = true; // Kunci proses ganti hari
    
    showToast(" Kamu Pingsan karena kelelahan...");
    if(typeof AudioService !== 'undefined') AudioService.playSFX('hit');

    // Overlay Hitam
    const overlay = document.createElement('div');
    overlay.style.position = 'fixed';
    overlay.style.top = '0'; overlay.style.left = '0';
    overlay.style.width = '100%'; overlay.style.height = '100%';
    overlay.style.background = 'black';
    overlay.style.zIndex = '9999';
    overlay.style.opacity = '0';
    overlay.style.transition = 'opacity 1s';
    overlay.innerHTML = `<div style="display:flex; justify-content:center; align-items:center; height:100%; color:#ef4444; font-family:Cinzel; font-size:24px; flex-direction:column;">
        <h1>PINGSAN</h1>
        <p style="font-size:12px; color:#cbd5e1;">Dibawa ke Klinik oleh Warga...</p>
    </div>`;
    document.body.appendChild(overlay);

    // Fade In
    setTimeout(() => {
        overlay.style.opacity = '1';
    }, 100);

    setTimeout(() => {
        // Logic Reset
        STATE.day = parseInt(STATE.day) + 1;
        STATE.time = 800; // Bangun jam 8 pagi (telat karena sakit)
        STATE.player.energy = 50; // Bangun tidak full energy
        STATE.player.hp = STATE.player.maxHp;
        
        // Penalty
        const penalty = 500;
        STATE.player.money = Math.max(0, STATE.player.money - penalty);
        
        // Respawn at Clinic (UPDATE: DI DALAM KLINIK - SAMPING KASUR)
        // Posisi Baru: clinic_interior -> Tile (10, 8) (Samping Bed Kanan, Area Kosong)
        STATE.location = 'clinic_interior';
        STATE.player.x = 10 * TILE_SIZE; 
        STATE.player.y = 8 * TILE_SIZE;
        STATE.player.direction = 'left'; // Menghadap ruangan

        // Pastikan area spawn bersih (walaupun (10,8) diset kosong)
        clearSpawnZone('clinic_interior', 10, 8);

        randomizeWeather();
        manualSave();

        // Fade Out & Wake Up
        overlay.style.opacity = '0';
        setTimeout(() => {
            if(document.body.contains(overlay)) document.body.removeChild(overlay);
            
            showToast("Bangun di Klinik. Biaya: 500G");
            
            // Update Date/Time UI immediately
            const currentDayName = DAYS_OF_WEEK[(STATE.day - 1) % 7];
            const totalDays = STATE.day - 1;
            const year = Math.floor(totalDays / (DAYS_PER_SEASON * 4)) + 1;
            document.getElementById('full-date-display').innerText = `${currentDayName}, D${(totalDays % DAYS_PER_SEASON) + 1} ${STATE.season.toUpperCase()} Y${year}`;
            document.getElementById('clock-display').innerText = "08:00";

            // Tambahkan Dialog Dokter agar lebih imersif
            setTimeout(() => {
                 showDialogue("DR. BUDI", "Wah, kamu sudah sadar? Kemarin kamu pingsan di jalan karena kelelahan.\n\nUntung ada warga yang membawamu ke Klinik. Saya sudah mengobati lukamu dan memberikan vitamin.\n\nLain kali, perhatikan batas energimu ya. Kesehatan itu mahal harganya.", [{text:"Terima kasih Dok", action:closeDialogue}], 'images/lover1boy.png');
            }, 500);

            updateHUDInfo();
            STATE.screen = 'play'; 
            STATE.isDayChanging = false; // Buka kunci
        }, 1000);
    }, 2000);
}

// --- NEW FUNCTION: SLEEP LOGIC ---
function handleSleep() {
    // FIX: Tambahkan cek flag isDayChanging
    if(STATE.screen === 'cutscene' || STATE.isDayChanging) return;

    // --- NEW: CAPTURE WAKTU TIDUR UNTUK LOGIKA PULANG TELAT ---
    const lastSleepTime = STATE.time;

    closeDialogue();
    STATE.screen = 'cutscene'; // FIX: Stop update loop saat tidur
    STATE.isDayChanging = true; // Kunci proses
    
    let oversleep = false;
    // MECHANIC: OVERSLEEP IF ENERGY LOW
    if(STATE.player.energy < 20) {
        oversleep = true;
    }

    showToast("Zzz... Tidur...");
    
    // Overlay Hitam Sementara
    const overlay = document.createElement('div');
    overlay.style.position = 'fixed';
    overlay.style.top = '0'; overlay.style.left = '0';
    overlay.style.width = '100%'; overlay.style.height = '100%';
    overlay.style.background = 'black';
    overlay.style.zIndex = '9999';
    overlay.style.opacity = '0';
    overlay.style.transition = 'opacity 1s';
    
    // Hitung hari besok untuk tampilan layar hitam
    const nextDayName = DAYS_OF_WEEK[STATE.day % 7]; // STATE.day sudah +1 nanti, jadi %7 saja (karena array 0-6)
    
    overlay.innerHTML = `<div style="display:flex; justify-content:center; align-items:center; height:100%; color:white; font-family:Cinzel; font-size:24px;">Day ${parseInt(STATE.day) + 1} (${nextDayName})</div>`;
    document.body.appendChild(overlay);

    // Animasi Fade Out
    setTimeout(() => {
        overlay.style.opacity = '1';
        
        // LOGIKA GANTI HARI DI BALIK LAYAR
        setTimeout(() => {
            // FIX: Pastikan penambahan hari aman (Integer)
            STATE.day = parseInt(STATE.day) + 1;
            
            if (oversleep) {
                STATE.time = 1000; // Bangun jam 10:00 (Telat)
            } else {
                STATE.time = 600; // Bangun jam 06:00
            }
            
            STATE.player.energy = 100; // Pulihkan Energi
            STATE.player.hp = STATE.player.maxHp; // Pulihkan HP
            
            // Logika Shift Kerja (Jika lupa pulang)
            if(STATE.player.shiftStarted) {
                STATE.player.shiftStarted = false;
                STATE.player.bossReputation -= 5;
            }

            randomizeWeather(); // Ubah Cuaca
            manualSave(); // Simpan Otomatis saat tidur

            // Animasi Fade In
            overlay.style.opacity = '0';
            setTimeout(() => {
                document.body.removeChild(overlay);
                
                // Ambil Nama Hari Baru
                const currentDayName = DAYS_OF_WEEK[(STATE.day - 1) % 7];
                
                if(oversleep) {
                    showToast(` KESIANGAN! Bangun jam 10:00 karena kelelahan.`);
                } else {
                    showToast(`Selamat Pagi! Hari ${currentDayName}`);
                }
                
                // Update tampilan tanggal/jam segera (termasuk hari)
                const totalDays = STATE.day - 1;
                const year = Math.floor(totalDays / (DAYS_PER_SEASON * 4)) + 1;
                const dayInSeason = (totalDays % DAYS_PER_SEASON) + 1;
                
                document.getElementById('full-date-display').innerText = `${currentDayName}, D${dayInSeason} ${STATE.season.toUpperCase()} Y${year}`;
                document.getElementById('clock-display').innerText = oversleep ? "10:00" : "06:00";
                
                STATE.screen = 'play'; // FIX: Resume game setelah bangun
                STATE.isDayChanging = false; // Buka kunci

                // --- NEW: RESPAWN BUNGA LIAR SETIAP PAGI ---
                spawnWildFlowers();

                // --- NEW: LOGIKA NAFKAH HARIAN & DRAMA NIKAH MUDA ---
                if (STATE.player.married && STATE.location === 'house') {
                    // Cari data NPC Pasangan
                    const spouseId = STATE.player.spouseId;
                    const spouse = maps['house'].npcs.find(n => n.id === spouseId);
                    
                    if (spouse) {
                        setTimeout(() => {
                            const dailyCost = 2500;
                            // CEK TELAT: Pulang setelah jam 18:00 (1800) atau Dini Hari (< 600)
                            const isLate = lastSleepTime >= 1800 || lastSleepTime < 600;
                            
                            // 1. TERAPKAN PENALTI DULUAN (SIMULASI DI MEMORI)
                            // Agar kita bisa cek apakah hubungan jadi 0 gara-gara kejadian semalam
                            let currentRel = STATE.player.relationships[spouseId] || 0;
                            let penaltyApplied = 0;

                            if (isLate) penaltyApplied -= 5;
                            if (STATE.player.money < dailyCost) penaltyApplied -= 5;

                            // Update nilai asli di state
                            if (penaltyApplied !== 0) {
                                updateRelationship(spouse, penaltyApplied, "Masalah Rumah Tangga");
                                currentRel = STATE.player.relationships[spouseId]; // Ambil nilai baru
                            }

                            // 2. CEK APAKAH INI GONG PERCERAIAN? (Love <= 0)
                            if (currentRel <= 0) {
                                handleDivorceSequence(spouse);
                                manualSave();
                                return; // Stop flow uang belanja
                            }

                            // 3. JIKA MASIH AMAN (>0), LANJUT FLOW NORMAL (Uang Belanja / Drama)
                            
                            // --- FITUR BARU: RISIKO NIKAH MUDA ---
                            // Semakin rendah INT (Kedewasaan) & Uang, semakin tinggi peluang Drama
                            let dramaChance = 0.15; // Base 15%
                            if (STATE.player.int < 30) dramaChance += 0.25; // +25% jika belum dewasa (INT rendah)
                            if (STATE.player.money < 20000) dramaChance += 0.20; // +20% jika ekonomi sulit
                            
                            // Roll Drama (Hanya terjadi jika tidak telat)
                            const isDrama = Math.random() < dramaChance;

                            // Cek Saldo
                            if (STATE.player.money >= dailyCost) {
                                // Mampu Bayar
                                STATE.player.money -= dailyCost;
                                
                                if (isLate) {
                                    // --- PASANGAN MARAH KARENA TELAT ---
                                    updateRelationship(spouse, -5, "Pulang Telat");
                                    if(typeof AudioService !== 'undefined') AudioService.playSFX('hit'); // Suara kecewa
                                    
                                    showDialogue(spouse.name, 
                                        `Kamu pulang jam berapa kemarin?! \n\nKita kan sudah sepakat **wajib pulang sebelum jam 6 sore**!\nAku nungguin kamu sampai ketiduran.\n\nAku kecewa. (Cinta -5)\n*Dia mengambil 2.500 Gold dengan kasar untuk belanja.*`, 
                                        [{
                                            text: `Maaf sayang... (Sisa: ${STATE.player.money.toLocaleString()} G)`, 
                                            action: closeDialogue
                                        }], 
                                        spouse.imgSrc
                                    );
                                } 
                                else if (isDrama) {
                                    // --- REALITA NIKAH MUDA (DRAMA) ---
                                    if(typeof AudioService !== 'undefined') AudioService.playSFX('hit'); // Suara kaget/sedih
                                    
                                    const dramas = [
                                        {
                                            title: "MENTAL BELUM SIAP",
                                            text: "Jujur... aku iri liat story teman-temanku. Mereka lagi asik nongkrong dan traveling, sedangkan aku di sini terjebak ngurus rumah.\n\nKadang aku nyesel kita buru-buru nikah... Aku merasa masa mudaku hilang! ",
                                            effect: () => {
                                                updateRelationship(spouse, -5, "Penyesalan");
                                                STATE.player.energy = Math.max(0, STATE.player.energy - 30); // Stress bikin lemas
                                            },
                                            btn: "Maafkan aku... (Cinta -5, Energi -30)"
                                        },
                                        {
                                            title: "EMOSI LABIL",
                                            text: "KAMU TUH GAK PEKA BANGET SIH! \n\nAku capek! Aku maunya dimengerti! Jangan diem aja dong!\n\n(Dia marah-marah tanpa alasan jelas. Emosinya sangat tidak stabil hari ini).",
                                            effect: () => {
                                                updateRelationship(spouse, -8, "Emosi Labil");
                                            },
                                            btn: "Sabar... Sabar... (Cinta -8)"
                                        },
                                        {
                                            title: "GUNCANGAN EKONOMI",
                                            text: "Uang 2.500 ini cuma cukup buat makan! Belum bayar listrik, belum skincare, belum kuota...\n\nKita tuh miskin banget sih! Aku malu sama tetangga yang mobilnya baru! Kamu harus kerja lebih keras dong!",
                                            effect: () => {
                                                updateRelationship(spouse, -5, "Tuntutan Hidup");
                                                STATE.player.reputation = Math.max(0, STATE.player.reputation - 5);
                                            },
                                            btn: "Aku akan berusaha... (Reputasi -5)"
                                        },
                                        {
                                            title: "CEMBURU BUTA",
                                            text: "Tadi aku liat kamu senyum-senyum sama orang lain di desa.\n\nNgaku! Kamu pasti bosen kan sama aku?! Kamu mau selingkuh ya?!\n\n(Ketidakamanan diri alias Insecure khas remaja yang menikah dini)",
                                            effect: () => {
                                                updateRelationship(spouse, -10, "Insecure");
                                            },
                                            btn: "Enggak sayang, sumpah! (Cinta -10)"
                                        }
                                    ];

                                    const drama = dramas[Math.floor(Math.random() * dramas.length)];
                                    drama.effect();

                                    showDialogue(`${spouse.name} (Drama)`, 
                                        `**[REALITA NIKAH MUDA: ${drama.title}]**\n\n"${drama.text}"\n\n*Uang belanja 2.500 G diambil dengan ketus.*`, 
                                        [{
                                            text: drama.btn, 
                                            action: closeDialogue
                                        }], 
                                        spouse.imgSrc
                                    );

                                } else {
                                    // --- PASANGAN BAHAGIA (NORMAL) ---
                                    // Efek Visual
                                    createParticle(STATE.player.x, STATE.player.y, '#fbbf24');
                                    if(typeof AudioService !== 'undefined') AudioService.playSFX('item');
                                    
                                    showDialogue(spouse.name, 
                                        `Selamat pagi sayang! \n\nTerima kasih sudah pulang tepat waktu kemarin.\nSeperti biasa, aku ambil **2.500 Gold** untuk belanja pasar ya.\n\nSarapan sudah siap!`, 
                                        [{
                                            text: `Ikhlas (Sisa: ${STATE.player.money.toLocaleString()} G)`, 
                                            action: () => {
                                                updateRelationship(spouse, 1); // Tambah cinta sedikit
                                                closeDialogue();
                                            }
                                        }], 
                                        spouse.imgSrc
                                    );
                                }
                            } else {
                                // Tidak Mampu Bayar (Hutang/Minus)
                                STATE.player.money -= dailyCost; // Saldo jadi minus
                                
                                // Hukuman Dasar
                                STATE.player.reputation = Math.max(0, STATE.player.reputation - 5);
                                updateRelationship(spouse, -5, "Ekonomi Sulit");
                                
                                if(typeof AudioService !== 'undefined') AudioService.playSFX('hit'); // Suara sedih/hit

                                let msg = `Selamat pagi... sayang? \n\nUang belanja di laci habis... Tukang sayur sudah menagih.\nAku terpaksa ngutang dulu.`;
                                
                                if (isLate) {
                                    // Hukuman Ganda jika Telat + Miskin
                                    updateRelationship(spouse, -5, "Combo Telat");
                                    msg = `Sudah pulang telat, uang belanja juga nggak ada?! \n\nKamu niat berumah tangga nggak sih?! Aku malu sama tetangga!`;
                                }

                                showDialogue(spouse.name, 
                                    msg + `\n\n(Saldo Minus! Reputasi & Cinta Berkurang)`, 
                                    [{
                                        text: `Maafkan aku... (Sisa: ${STATE.player.money.toLocaleString()} G)`, 
                                        action: closeDialogue
                                    }], 
                                    spouse.imgSrc
                                );
                            }
                            
                            // Simpan lagi setelah transaksi otomatis
                            manualSave();
                        }, 1200); // Jeda setelah bangun tidur
                    }
                }

            }, 1000);

        }, 2000); // Durasi layar hitam
    }, 100);
}

const jobWords = ["Yth.", "Bapak/Ibu", "Saya", "Ingin", "Melamar", "Kerja", "Disini", "Terima Kasih"];
let jobSelected = [];

function openJobMinigame() {
    closeDialogue();
    STATE.minigame = 'job_app';
    STATE.screen = 'minigame';
    
    const overlay = document.getElementById('job-app-game');
    const container = document.getElementById('job-app-words');
    const result = document.getElementById('job-app-result-area');
    
    overlay.style.display = 'flex';
    container.innerHTML = '';
    result.innerText = '';
    jobSelected = [];
    
    const shuffled = [...jobWords].sort(() => Math.random() - 0.5);
    
    shuffled.forEach(word => {
        const chip = document.createElement('div');
        chip.className = 'word-chip';
        chip.innerText = word;
        chip.onclick = () => {
            if(chip.classList.contains('selected')) return;
            chip.classList.add('selected');
            jobSelected.push(word);
            result.innerText = jobSelected.join(" ");
        };
        container.appendChild(chip);
    });
}

function checkJobApp() {
    const sentence = jobSelected.join(" ");
    if(sentence.includes("Saya Ingin Melamar Kerja") && sentence.includes("Terima Kasih")) {
        STATE.player.jobStatus = 'employed';
        STATE.player.bossReputation = 50;
        alert("SELAMAT! Lamaran diterima. Datanglah besok jam 08:00.");
        
        // Reward EXP for getting job
        gainExp(50);
        
        closeMinigame();
    } else {
        alert("Lamaran ditolak! Susunan kalimat kurang sopan. Coba lagi.");
        openJobMinigame();
    }
}

function closeMinigame() {
    document.getElementById('job-app-game').style.display = 'none';
    STATE.minigame = null;
    STATE.screen = 'play';
}

function buyFurniture(id, cost) {
    if(STATE.player.money >= cost) {
        if(!STATE.player.furniture.includes(id)) {
            STATE.player.money -= cost;
            STATE.player.furniture.push(id);
            gainExp(20); // Shopping gives exp
            showToast("Item terbeli! ");
            if(typeof AudioService !== 'undefined') AudioService.playSFX('item'); // SFX Beli Furniture
            closeDialogue();
        } else {
            showToast("Sudah punya item ini!");
        }
    } else {
        showToast("Uang tidak cukup!");
    }
}

function upgradeHouse() {
    const nextLevel = STATE.player.houseLevel + 1;
    const cost = nextLevel * 500000; 

    if(STATE.player.houseLevel >= 5) {
        showToast("Level Rumah Maksimal!");
        return;
    }

    if(STATE.player.money >= cost) {
        STATE.player.money -= cost;
        STATE.player.houseLevel = nextLevel;
        showToast(`RUMAH UPGRADE KE LEVEL ${nextLevel}! `);
        createParticle(18*TILE_SIZE, 8*TILE_SIZE, '#fbbf24');
        gainExp(200); // Big EXP for upgrade
        
        // --- REGENERATE MAP AFTER UPGRADE ---
        regenerateHouseMap();
        
        closeDialogue();
    } else {
        showDialogue("ARSITEK", `Butuh ${cost.toLocaleString()} Gold untuk Level ${nextLevel}.`, [{text:"Nanti saja", action:closeDialogue}]);
    }
}

// --- NEW FUNCTION: START RUINS BATTLE (QUEST SKRIPSI) ---
function startRuinsBattle() {
    // 1. Pindah Lokasi ke Arena Reruntuhan
    STATE.location = 'ruins_battle';
    
    // Spawn Player di bagian bawah tengah
    STATE.player.x = 11 * TILE_SIZE;
    STATE.player.y = 12 * TILE_SIZE;
    STATE.teleportCooldown = 60;

    // 2. Spawn Monster Spesial (Thief)
    STATE.enemies = [];
    STATE.enemies.push({
        x: 11 * TILE_SIZE, // Tengah
        y: 5 * TILE_SIZE,  // Atas
        w: 50, h: 50,      // Sedikit lebih besar dari player
        hp: 400,           // HP Tebal (Mini Boss)
        maxHp: 400,
        speed: 1.4,        // Cukup lincah (Pencuri)
        knockback: {x:0, y:0},
        color: '#d97706',
        animOffset: 0,
        angle: 0,
        imgKey: 'thief',   // Gambar Monster Thief
        isQuestTarget: true // Flag khusus drop item skripsi
    });

    // 3. Efek Visual & Audio
    showToast(" FIGHT START! Rebut Draft Skripsi!");
    if(typeof AudioService !== 'undefined') AudioService.playBGM('boss'); // Musik Tegang
    
    // Intro Dialog Singkat dari Monster
    setTimeout(() => {
        showDialogue("PENCURI NASKAH", "Hehehe! Mau ambil buku ini? Langkahi dulu mayatku!", [{text:"Maju sini!", action:closeDialogue}], 'images/monster-thief.png');
    }, 500);
}

function spawnEnemies() {
    STATE.enemies = [];
    if(STATE.location !== 'dungeon') return;

    // Reset Flags
    STATE.bossSpawned = false;

    // Reset Map Buildings
    // LOGIKA BARU: Hapus semua portal dulu, sisakan hanya Batu (Obstacles)
    const map = maps['dungeon'];
    map.buildings = map.buildings.filter(b => b.id.includes('rock'));

    const level = STATE.dungeonLevel || 1;

    // FITUR HARDCORE: Portal Exit hanya ada di Level 1
    // Level 2 ke atas tidak ada jalan kembali kecuali Menang atau Mati (Game Over)
    if (level === 1) {
        map.buildings.push({ 
            id: 'dungeon_exit', x: 2, y: 2, w: 1, h: 1, 
            type: 'trigger', entrance: {x: 2, y: 2}, name: "Keluar Dungeon" 
        });
    }

    let count = 3 + (level * 2); // Level 1: 5, Level 5: 13
    let hpMulti = level;
    let sizeMulti = 1;
    
    // --- LOGIKA LEVEL 5 (WAVE 1: ELITE GUARDS) ---
    if (level === 5) {
        showToast(` LEVEL 5: ELITE GUARDS!`);
        
        // Spawn 5 Monster Level 5 (Elite)
        for(let i=0; i<5; i++) {
            let safeX, safeY;
            do {
                safeX = Math.floor((Math.random() * (DUNGEON_W - 4)) + 2); 
                safeY = Math.floor((Math.random() * (DUNGEON_H - 4)) + 2);
            } while(safeX < 8 && safeY < 8); // Jauh dari pintu masuk

            STATE.enemies.push({
                x: safeX * TILE_SIZE,
                y: safeY * TILE_SIZE,
                w: 40, h: 40, // Lebih besar dari biasa
                hp: 300, 
                maxHp: 300,
                speed: 1.5, // Agak cepat
                knockback: {x:0, y:0},
                color: '#1e3a8a', // Biru Tua (Fallback)
                animOffset: Math.random() * 100, 
                angle: 0,
                imgKey: 'enemy5' // Gambar Monster Level 5
            });
        }
        return; // Selesai spawn wave 1, boss nanti di updateEnemies
    }

    // --- LOGIKA LEVEL 1-4 ---
    showToast(` DUNGEON LEVEL ${level} START!`);

    for(let i=0; i<count; i++) {
        let safeX, safeY;
        do {
            safeX = Math.floor((Math.random() * (DUNGEON_W - 4)) + 2); 
            safeY = Math.floor((Math.random() * (DUNGEON_H - 4)) + 2);
        } while(safeX < 8 && safeY < 8); 
        
        // --- LOGIKA VARIASI MONSTER BERDASARKAN LEVEL ---
        // Level 1: Hanya Tier 1
        // Level 2: Tier 1 & 2
        // Level 3: Tier 1, 2, 3
        // Level 4+: Tier 1, 2, 3, 4
        let maxTier = 1;
        if (level >= 2) maxTier = 2;
        if (level >= 3) maxTier = 3;
        if (level >= 4) maxTier = 4;

        const tier = Math.floor(Math.random() * maxTier) + 1;
        
        // Stats scaling berdasarkan Tier monster juga
        const tierHpBonus = 1 + (tier * 0.2); // Tier tinggi lebih tebal sedikit

        STATE.enemies.push({
            x: safeX * TILE_SIZE,
            y: safeY * TILE_SIZE,
            w: 24 + (tier * 2), h: 24 + (tier * 2), // Tier tinggi sedikit lebih besar
            hp: 50 * hpMulti * tierHpBonus, 
            maxHp: 50 * hpMulti * tierHpBonus,
            speed: 1.0 + (level * 0.1) + (tier * 0.05), 
            knockback: {x:0, y:0},
            color: tier === 1 ? '#ef4444' : (tier === 2 ? '#f97316' : (tier === 3 ? '#eab308' : '#84cc16')), // Warna fallback beda-beda
            animOffset: Math.random() * 100, 
            angle: 0,
            imgKey: 'enemy' + tier // Set gambar sesuai tier (enemy1, enemy2, dst)
        });
    }
}

function gameOver() {
    showDialogue("DEFEAT", "Kamu dikalahkan monster. Gold berkurang 10%.", [{text:"Respawn (Klinik)", action:()=>{
        STATE.player.hp = 100;
        STATE.player.energy = 50; // Respawn tired
        STATE.player.money = Math.floor(STATE.player.money * 0.9);
        
        STATE.location = 'village';
        STATE.player.x = 20 * TILE_SIZE; 
        STATE.player.y = 20 * TILE_SIZE; 
        
        // FIX: Gunakan parseInt agar hari tidak menjadi string "11" (1+1) saat Game Over
        STATE.day = parseInt(STATE.day) + 1;
        
        STATE.enemies = []; 
        closeDialogue();
        showToast("Dirawat oleh Dr. Budi ");
    }}], null);
}

function showDialogue(title, text, opts, imgSrc) {
    const box = document.getElementById('dialogue-wrapper'); 
    const portrait = document.getElementById('dialogue-portrait');
    
    document.getElementById('dialogue-title').innerText = title;
    document.getElementById('dialogue-text').innerText = text;
    
    if(imgSrc) {
        portrait.src = imgSrc;
        portrait.style.display = 'block';
    } else {
        portrait.style.display = 'none';
    }

    const grp = document.getElementById('dialogue-options');
    grp.innerHTML = '';
    opts.forEach(o => {
        const b = document.createElement('button');
        b.innerText = o.text;
        b.onclick = o.action;
        grp.appendChild(b);
    });
    box.style.display = 'block';
    STATE.screen = 'dialogue';
}
function closeDialogue() {
    document.getElementById('dialogue-wrapper').style.display = 'none'; 
    STATE.screen = 'play';
    // FIX: RESET INPUT SETIAP KALI DIALOG DITUTUP (Agar tidak jalan sendiri)
    resetInputs();
}
function showToast(msg) {
    const t = document.getElementById('toast');
    t.innerText = msg;
    t.style.opacity = 1;
    setTimeout(()=>t.style.opacity=0, 2000);
}
function createParticle(x,y,c) {
    STATE.particles.push({x:x,y:y,vx:(Math.random()-.5)*5, vy:(Math.random()-.5)*5, life:15, color:c});
}

function draw() {
    // FIX: Tambahkan 'cutscene' agar canvas tetap dirender saat animasi pernikahan berjalan
    if(STATE.screen !== 'play' && STATE.screen !== 'dialogue' && STATE.screen !== 'modal' && STATE.screen !== 'minigame' && STATE.screen !== 'cutscene') return;

    ctx.fillStyle = '#0f172a'; 
    ctx.fillRect(0,0,canvas.width, canvas.height); // Gunakan canvas.width/height dinamis
    
    // SAFETY CHECK: Pastikan Map Ada
    if (!maps[STATE.location]) {
        console.error("Map not found:", STATE.location);
        ctx.fillStyle = "white";
        ctx.font = "20px Arial";
        ctx.fillText("Error: Map Loading Failed", 50, 50);
        return;
    }

    ctx.save();
    
    // --- OPTIMASI: DYNAMIC SCALING ---
    // Hitung skala berdasarkan resolusi canvas saat ini (bisa 2x atau 4x)
    const scaleFactor = canvas.width / GAME_WIDTH; 
    ctx.scale(scaleFactor, scaleFactor); 
    
    // FIX: Mengaktifkan smoothing agar sprite NPC HD terlihat halus dan tidak patah-patah
    ctx.imageSmoothingEnabled = true; 

    let shakeX = 0;
    let shakeY = 0;
    if(STATE.shakeTimer > 0) {
        shakeX = (Math.random() - 0.5) * 10;
        shakeY = (Math.random() - 0.5) * 10;
    }

    ctx.translate(-STATE.camera.x + shakeX, -STATE.camera.y + shakeY);
    
    const map = maps[STATE.location];
    
    const scaledWidth = GAME_WIDTH;
    const scaledHeight = GAME_HEIGHT;
    
    const startCol = Math.floor(STATE.camera.x / TILE_SIZE);
    const endCol = startCol + (scaledWidth / TILE_SIZE) + 1;
    const startRow = Math.floor(STATE.camera.y / TILE_SIZE);
    const endRow = startRow + (scaledHeight / TILE_SIZE) + 1;

    let isBgLoaded = false;
    if(STATE.location === 'village') {
        const bgImg = bgSeasons[STATE.season]; 
        
        if(bgImg && bgImg.complete && bgImg.naturalWidth !== 0) {
            ctx.drawImage(bgImg, 0, 0, ISLAND_W * TILE_SIZE, ISLAND_H * TILE_SIZE);
            isBgLoaded = true;
        } else {
            if(bgSeasons.spring.complete && bgSeasons.spring.naturalWidth !== 0) {
                ctx.drawImage(bgSeasons.spring, 0, 0, ISLAND_W * TILE_SIZE, ISLAND_H * TILE_SIZE);
                isBgLoaded = true;
            }
        }
    } else if (STATE.location === 'house') {
        // UPDATE: Hapus Background Image Rumah agar menggunakan Tile Tembok & Lantai
        /*
        const level = STATE.player.houseLevel || 1;
        const bgImg = houseBgAssets['level' + level];
        if (bgImg && bgImg.complete && bgImg.naturalWidth !== 0) {
            const map = maps['house'];
            ctx.drawImage(bgImg, 0, 0, map.w * TILE_SIZE, map.h * TILE_SIZE);
            isBgLoaded = true;
        }
        */
        isBgLoaded = false; // Paksa render sistem Tile
    }

    for(let y=startRow; y<=endRow; y++) {
        for(let x=startCol; x<=endCol; x++) {
            if(y>=0 && y<map.h && x>=0 && x<map.w) {
                const t = map.tiles[y*map.w+x];
                
                if(isBgLoaded) {
                    if (STATE.location === 'village') {
                        // UPDATE: Tambahkan t !== 7 agar Tile Reruntuhan (ID 7) digambar di atas background
                        if(t !== 9 && t !== 2 && t !== 12 && t !== 1 && t !== 0 && t !== 5 && t !== 7) continue; 
                    } else if (STATE.location === 'house') {
                        // Skip floor (10) and wall (11) if BG is loaded so we see the image
                        if(t === 10 || t === 11) continue; 
                    }
                }

                let c = '#0f172a'; 
                if(t===1) c = '#1e293b'; 
                if(t===3) c = '#334155'; 
                if(t===4) c = '#3f3f46'; // Dungeon Floor Base Color
                if(t===5) c = '#92400e'; 
                if(t===6) c = '#4c1d95'; 
                if(t===7) c = '#57534e'; // NEW: Ruins Base Color
                if(t===9) c = '#000'; 
                if(t===10) c = STATE.player.houseLevel===2 ? '#fcd34d' : '#78350f'; 
                if(t===11) c = '#f1f5f9'; 
                if(t===8) c = '#d97706'; 
                
                if(STATE.location === 'village') {
                    if(t===5) { 
                         if(STATE.season === 'winter') c = '#94a3b8'; 
                    }
                }

                // DRAW TILE BASE
                ctx.fillStyle = c;
                
                // Handle Dungeon/Candi Floor (ID 4)
                // UPDATE: Memisahkan logika Candi Interior agar menggunakan 'lantaicandi.png'
                if (t === 4) {
                    if (STATE.location === 'candi_interior') {
                        // RENDER LANTAI CANDI KHUSUS
                        if(candiAssets.floor.complete && candiAssets.floor.naturalWidth !== 0) {
                            ctx.drawImage(candiAssets.floor, x*TILE_SIZE, y*TILE_SIZE, TILE_SIZE, TILE_SIZE);
                        } else {
                            // Fallback warna batu candi
                            ctx.fillStyle = '#44403c'; 
                            ctx.fillRect(x*TILE_SIZE, y*TILE_SIZE, TILE_SIZE, TILE_SIZE);
                        }
                    } 
                    else if (STATE.location === 'dungeon' || STATE.location === 'ruins_battle') {
                        // RENDER LANTAI DUNGEON BIASA
                        if(dungeonAssets.floor.complete && dungeonAssets.floor.naturalWidth !== 0) {
                            ctx.drawImage(dungeonAssets.floor, x*TILE_SIZE, y*TILE_SIZE, TILE_SIZE, TILE_SIZE);
                        } else {
                            ctx.fillStyle = '#3f3f46'; // Fallback warna lantai jika gambar belum load
                            ctx.fillRect(x*TILE_SIZE, y*TILE_SIZE, TILE_SIZE, TILE_SIZE);
                        }
                    }
                }

                // NEW: HANDLE MAGIC FLOOR / RED CARPET (ID 6)
                else if (t === 6) {
                    if (STATE.location === 'candi_interior') {
                        // RENDER LANTAI MERAH CANDI
                        if(candiAssets.redFloor.complete && candiAssets.redFloor.naturalWidth !== 0) {
                            ctx.drawImage(candiAssets.redFloor, x*TILE_SIZE, y*TILE_SIZE, TILE_SIZE, TILE_SIZE);
                        } else {
                            // Fallback warna merah marun
                            ctx.fillStyle = '#991b1b'; 
                            ctx.fillRect(x*TILE_SIZE, y*TILE_SIZE, TILE_SIZE, TILE_SIZE);
                        }
                    } else {
                        // Default Magic Floor (Ungu - Desa dll)
                        ctx.fillStyle = '#4c1d95';
                        ctx.fillRect(x*TILE_SIZE, y*TILE_SIZE, TILE_SIZE, TILE_SIZE);
                    }
                }
                
                // NEW: Handle House Floor (ID 10 in House) - MENGGUNAKAN TILE LANTAI KAYU (Sama dengan Kampus)
                else if (t === 10 && STATE.location === 'house') {
                    if (wallAssets.schoolFloor.complete && wallAssets.schoolFloor.naturalWidth !== 0) {
                        ctx.drawImage(wallAssets.schoolFloor, x*TILE_SIZE, y*TILE_SIZE, TILE_SIZE, TILE_SIZE);
                    } else {
                        ctx.fillStyle = '#78350f'; // Warna kayu
                        ctx.fillRect(x*TILE_SIZE, y*TILE_SIZE, TILE_SIZE, TILE_SIZE);
                    }
                }

                /* REVISI: Handle Merchant Floor (ID 10) - Menggunakan images/tilelantaikampus.png */
                else if (t === 10 && STATE.location === 'merchant_interior') {
                    if (wallAssets.schoolFloor.complete && wallAssets.schoolFloor.naturalWidth !== 0) {
                        ctx.drawImage(wallAssets.schoolFloor, x*TILE_SIZE, y*TILE_SIZE, TILE_SIZE, TILE_SIZE);
                    } else {
                        // Fallback ke warna dasar jika gambar belum load
                        ctx.fillStyle = '#78350f'; 
                        ctx.fillRect(x*TILE_SIZE, y*TILE_SIZE, TILE_SIZE, TILE_SIZE);
                    }
                }

                /* REVISI: Handle Mentor Floor (ID 10) - UPDATE: Menggunakan images/lantaimentor.png */
                else if (t === 10 && STATE.location === 'mentor_interior') {
                    if (mentorAssets.floor.complete && mentorAssets.floor.naturalWidth !== 0) {
                        ctx.drawImage(mentorAssets.floor, x*TILE_SIZE, y*TILE_SIZE, TILE_SIZE, TILE_SIZE);
                    } else {
                        // Fallback ke warna dasar jika gambar belum load
                        ctx.fillStyle = '#78350f'; 
                        ctx.fillRect(x*TILE_SIZE, y*TILE_SIZE, TILE_SIZE, TILE_SIZE);
                    }
                }

                // NEW: Handle School Floor (ID 10 in School Interior)
                else if (t === 10 && STATE.location === 'school_interior') {
                    if (wallAssets.schoolFloor.complete && wallAssets.schoolFloor.naturalWidth !== 0) {
                        ctx.drawImage(wallAssets.schoolFloor, x*TILE_SIZE, y*TILE_SIZE, TILE_SIZE, TILE_SIZE);
                    } else {
                        // Fallback ke warna dasar jika gambar belum load
                        ctx.fillRect(x*TILE_SIZE, y*TILE_SIZE, TILE_SIZE, TILE_SIZE);
                    }
                }

                // NEW: Handle Library Floor (ID 10 in Library Interior)
                else if (t === 10 && STATE.location === 'library_interior') {
                    if (wallAssets.libraryFloor.complete && wallAssets.libraryFloor.naturalWidth !== 0) {
                        ctx.drawImage(wallAssets.libraryFloor, x*TILE_SIZE, y*TILE_SIZE, TILE_SIZE, TILE_SIZE);
                    } else {
                        // Fallback ke warna dasar
                        ctx.fillRect(x*TILE_SIZE, y*TILE_SIZE, TILE_SIZE, TILE_SIZE);
                    }
                }

                // NEW: Handle Guild Floor (ID 10 in Guild Interior)
                else if (t === 10 && STATE.location === 'guild_interior') {
                    if (wallAssets.guildFloor.complete && wallAssets.guildFloor.naturalWidth !== 0) {
                        ctx.drawImage(wallAssets.guildFloor, x*TILE_SIZE, y*TILE_SIZE, TILE_SIZE, TILE_SIZE);
                    } else {
                        // Fallback ke warna dasar
                        ctx.fillRect(x*TILE_SIZE, y*TILE_SIZE, TILE_SIZE, TILE_SIZE);
                    }
                }

                // NEW: Handle Clinic Floor (ID 10 in Clinic Interior)
                // UPDATE: Menggunakan images/lantaiklinik.png
                else if (t === 10 && STATE.location === 'clinic_interior') {
                    if (clinicAssets.floor.complete && clinicAssets.floor.naturalWidth !== 0) {
                        ctx.drawImage(clinicAssets.floor, x*TILE_SIZE, y*TILE_SIZE, TILE_SIZE, TILE_SIZE);
                    } else {
                        // Fallback ke warna putih/abu
                        ctx.fillStyle = '#f8fafc';
                        ctx.fillRect(x*TILE_SIZE, y*TILE_SIZE, TILE_SIZE, TILE_SIZE);
                    }
                }

                // NEW: Handle Blacksmith Floor (ID 10 in Blacksmith Interior)
                // UPDATE: Menggunakan Lantai Mentor (Kayu) agar sama dengan tetangga
                else if (t === 10 && STATE.location === 'blacksmith_interior') {
                    if (mentorAssets.floor.complete && mentorAssets.floor.naturalWidth !== 0) {
                        ctx.drawImage(mentorAssets.floor, x*TILE_SIZE, y*TILE_SIZE, TILE_SIZE, TILE_SIZE);
                    } else {
                        // Fallback ke warna kayu
                        ctx.fillStyle = '#78350f';
                        ctx.fillRect(x*TILE_SIZE, y*TILE_SIZE, TILE_SIZE, TILE_SIZE);
                    }
                }

                // NEW: Handle Guild Wall (ID 2 in Guild Interior)
                else if (t === 2 && STATE.location === 'guild_interior') {
                    if (wallAssets.guildWall.complete && wallAssets.guildWall.naturalWidth !== 0) {
                        ctx.drawImage(wallAssets.guildWall, x*TILE_SIZE, y*TILE_SIZE, TILE_SIZE, TILE_SIZE);
                    } else {
                        ctx.fillStyle = '#475569'; // Fallback warna tembok
                        ctx.fillRect(x*TILE_SIZE, y*TILE_SIZE, TILE_SIZE, TILE_SIZE);
                    }
                }

                // NEW: Handle Blacksmith Wall (ID 2 in Blacksmith Interior)
                else if (t === 2 && STATE.location === 'blacksmith_interior') {
                    if (wallAssets.blacksmithWall.complete && wallAssets.blacksmithWall.naturalWidth !== 0) {
                        ctx.drawImage(wallAssets.blacksmithWall, x*TILE_SIZE, y*TILE_SIZE, TILE_SIZE, TILE_SIZE);
                    } else {
                        ctx.fillStyle = '#262626'; // Fallback warna tembok
                        ctx.fillRect(x*TILE_SIZE, y*TILE_SIZE, TILE_SIZE, TILE_SIZE);
                    }
                }

                // --- NEW: HANDLE ANIMASI OMBAK LAUT (VILLAGE WATER) ---
                else if (t === 0 && STATE.location === 'village') {
                    // Jika BG tidak load, gambar warna dasar air
                    if(!isBgLoaded) {
                        // UPDATE: Ganti warna air jadi BIRU TERANG agar ikan hitam terlihat jelas
                        ctx.fillStyle = '#0ea5e9'; // Sebelumnya #0f172a (Terlalu gelap)
                        ctx.fillRect(x*TILE_SIZE, y*TILE_SIZE, TILE_SIZE, TILE_SIZE);
                    }

                    // GAMBAR OMBAK BERGERAK (Visual Effect)
                    // ... existing wave logic ...
                    if (((x * 17 + y * 23) % 7) === 0) { 
                        
                        // Kalkulasi Gerakan Sinusoidal (Naik Turun halus)
                        const time = Date.now() / 600; // Kecepatan ombak
                        const waveY = Math.sin(time + x * 0.5) * 2; // Offset Y
                        
                        ctx.strokeStyle = 'rgba(255, 255, 255, 0.25)'; // Putih Transparan
                        ctx.lineWidth = 1.5;
                        ctx.lineCap = 'round';
                        
                        const wx = x * TILE_SIZE;
                        const wy = y * TILE_SIZE + 15; // Tengah Tile
                        
                        ctx.beginPath();
                        // Gambar kurva gelombang kecil
                        ctx.moveTo(wx + 5, wy + waveY);
                        ctx.quadraticCurveTo(wx + 15, wy + waveY - 4, wx + 25, wy + waveY);
                        ctx.stroke();
                    }
                }

                // --- NEW: Handle Ruins Wall (ID 2 in Ruins Battle) ---
                else if (t === 2 && STATE.location === 'ruins_battle') {
                    // FIX: Gambar background warna dulu agar tidak bolong/hitam jika gambar gagal load
                    ctx.fillStyle = '#57534e'; // Warna batu abu-abu (lebih terang dari background)
                    ctx.fillRect(x*TILE_SIZE, y*TILE_SIZE, TILE_SIZE, TILE_SIZE);

                    if (ruinsAssets.wall.complete && ruinsAssets.wall.naturalWidth !== 0) {
                        ctx.drawImage(ruinsAssets.wall, x*TILE_SIZE, y*TILE_SIZE, TILE_SIZE, TILE_SIZE);
                    } else {
                        // Fallback texture visual tembok jika gambar belum muncul
                        ctx.fillStyle = '#292524'; // Detail gelap (batu-batu)
                        ctx.fillRect(x*TILE_SIZE+5, y*TILE_SIZE+5, 10, 10);
                        ctx.fillRect(x*TILE_SIZE+15, y*TILE_SIZE+15, 10, 10);
                        // Border biar kelihatan tembok
                        ctx.strokeStyle = '#a8a29e';
                        ctx.lineWidth = 1;
                        ctx.strokeRect(x*TILE_SIZE, y*TILE_SIZE, TILE_SIZE, TILE_SIZE);
                    }
                }

                // Handle Dungeon/Candi Wall (ID 2)
                // UPDATE: Menggunakan tekstur tembok dungeon untuk Candi juga
                else if (t === 2 && (STATE.location === 'dungeon' || STATE.location === 'candi_interior')) {
                    // PERBAIKAN: Gambar Lantai DULU di bawah Tembok agar batu terlihat 'nempel' di lantai, tidak bolong
                    if(dungeonAssets.floor.complete && dungeonAssets.floor.naturalWidth !== 0) {
                        ctx.drawImage(dungeonAssets.floor, x*TILE_SIZE, y*TILE_SIZE, TILE_SIZE, TILE_SIZE);
                    } else {
                        ctx.fillStyle = '#3f3f46'; // Fallback warna lantai jika gambar belum load
                        ctx.fillRect(x*TILE_SIZE, y*TILE_SIZE, TILE_SIZE, TILE_SIZE);
                    }

                    // Baru gambar tembok/batu di atasnya
                    if(dungeonAssets.wall.complete && dungeonAssets.wall.naturalWidth !== 0) {
                        ctx.drawImage(dungeonAssets.wall, x*TILE_SIZE, y*TILE_SIZE, TILE_SIZE, TILE_SIZE);
                    } else {
                        // Fallback Wall Style
                        ctx.fillStyle = '#1e293b'; // Dark Wall
                        ctx.fillRect(x*TILE_SIZE, y*TILE_SIZE, TILE_SIZE, TILE_SIZE);
                        ctx.fillStyle = '#000'; // Shadow/Detail
                        ctx.fillRect(x*TILE_SIZE, y*TILE_SIZE + 25, TILE_SIZE, 5);
                    }
                }
                
                // NEW: Handle House Wall (ID 11 in House & Mentor) - UPDATE: Masukkan mentor_interior
                else if (t === 11 && (STATE.location === 'house' || STATE.location === 'mentor_interior')) {
                    if (wallAssets.houseWall.complete && wallAssets.houseWall.naturalWidth !== 0) {
                        ctx.drawImage(wallAssets.houseWall, x*TILE_SIZE, y*TILE_SIZE, TILE_SIZE, TILE_SIZE);
                    } else {
                        ctx.fillStyle = '#f1f5f9';
                        ctx.fillRect(x*TILE_SIZE, y*TILE_SIZE, TILE_SIZE, TILE_SIZE);
                    }
                }

                // NEW: Handle House Wall Bottom (ID 13 in House & Mentor) - UPDATE: Masukkan mentor_interior
                else if (t === 13 && (STATE.location === 'house' || STATE.location === 'mentor_interior')) {
                    if (wallAssets.houseWallBottom.complete && wallAssets.houseWallBottom.naturalWidth !== 0) {
                        ctx.drawImage(wallAssets.houseWallBottom, x*TILE_SIZE, y*TILE_SIZE, TILE_SIZE, TILE_SIZE);
                    } else {
                        ctx.fillStyle = '#f1f5f9'; // Fallback
                        ctx.fillRect(x*TILE_SIZE, y*TILE_SIZE, TILE_SIZE, TILE_SIZE);
                    }
                }

                // NEW: Handle School Wall (ID 11 in School Interior)
                else if (t === 11 && STATE.location === 'school_interior') {
                    if (wallAssets.school.complete && wallAssets.school.naturalWidth !== 0) {
                        ctx.drawImage(wallAssets.school, x*TILE_SIZE, y*TILE_SIZE, TILE_SIZE, TILE_SIZE);
                    } else {
                        // Fallback jika gambar belum diload (Warna Putih/Abu)
                        ctx.fillRect(x*TILE_SIZE, y*TILE_SIZE, TILE_SIZE, TILE_SIZE);
                    }
                }

                // NEW: Handle Library Wall (ID 11 in Library Interior)
                else if (t === 11 && STATE.location === 'library_interior') {
                    if (wallAssets.libraryWall.complete && wallAssets.libraryWall.naturalWidth !== 0) {
                        ctx.drawImage(wallAssets.libraryWall, x*TILE_SIZE, y*TILE_SIZE, TILE_SIZE, TILE_SIZE);
                    } else {
                        // Fallback jika gambar belum diload
                        ctx.fillRect(x*TILE_SIZE, y*TILE_SIZE, TILE_SIZE, TILE_SIZE);
                    }
                }

                // NEW: Handle Clinic Wall (ID 11 in Clinic Interior)
                // Menggunakan tembok perpus (putih)
                else if (t === 11 && STATE.location === 'clinic_interior') {
                    if (wallAssets.libraryWall.complete && wallAssets.libraryWall.naturalWidth !== 0) {
                        ctx.drawImage(wallAssets.libraryWall, x*TILE_SIZE, y*TILE_SIZE, TILE_SIZE, TILE_SIZE);
                    } else {
                        // Fallback
                        ctx.fillRect(x*TILE_SIZE, y*TILE_SIZE, TILE_SIZE, TILE_SIZE);
                    }
                }

                // NEW: Handle Wedding Wall & Floor (ID 11 & 10 in Wedding Interior)
                else if ((t === 11 || t === 10) && STATE.location === 'wedding_interior') {
                    if (t === 11) { // Wall
                        if (wallAssets.libraryWall.complete && wallAssets.libraryWall.naturalWidth !== 0) {
                            ctx.drawImage(wallAssets.libraryWall, x*TILE_SIZE, y*TILE_SIZE, TILE_SIZE, TILE_SIZE);
                        } else {
                            ctx.fillRect(x*TILE_SIZE, y*TILE_SIZE, TILE_SIZE, TILE_SIZE);
                        }
                    } else if (t === 10) { // Floor
                        if (wallAssets.libraryFloor.complete && wallAssets.libraryFloor.naturalWidth !== 0) {
                            ctx.drawImage(wallAssets.libraryFloor, x*TILE_SIZE, y*TILE_SIZE, TILE_SIZE, TILE_SIZE);
                        } else {
                            // Fallback Floor
                            ctx.fillStyle = '#fdf2f8'; // Pinkish white
                            ctx.fillRect(x*TILE_SIZE, y*TILE_SIZE, TILE_SIZE, TILE_SIZE);
                        }
                    }
                }
                
                // NEW: Handle Ayu's House Wall & Floor (ID 11 & 10 in Lover1 Interior)
                else if ((t === 11 || t === 10) && STATE.location === 'lover1_interior') {
                    if (t === 11) { // Wall (Pakai Wall Rumah Player)
                        if (wallAssets.houseWall.complete && wallAssets.houseWall.naturalWidth !== 0) {
                            ctx.drawImage(wallAssets.houseWall, x*TILE_SIZE, y*TILE_SIZE, TILE_SIZE, TILE_SIZE);
                        } else {
                            ctx.fillStyle = '#fef3c7'; // Cream wall
                            ctx.fillRect(x*TILE_SIZE, y*TILE_SIZE, TILE_SIZE, TILE_SIZE);
                        }
                    } else if (t === 10) { // Floor (UPDATE: Pakai Lantai Mentor)
                        if (mentorAssets.floor.complete && mentorAssets.floor.naturalWidth !== 0) {
                            ctx.drawImage(mentorAssets.floor, x*TILE_SIZE, y*TILE_SIZE, TILE_SIZE, TILE_SIZE);
                        } else {
                            ctx.fillStyle = '#78350f'; 
                            ctx.fillRect(x*TILE_SIZE, y*TILE_SIZE, TILE_SIZE, TILE_SIZE);
                        }
                    }
                }
                
                // NEW: Handle Fisherman House Wall & Floor (ID 11 & 10 in Fisherman Interior)
                else if ((t === 11 || t === 10) && STATE.location === 'fisherman_interior') {
                    if (t === 11) { // Wall
                        if (wallAssets.houseWall.complete && wallAssets.houseWall.naturalWidth !== 0) {
                            ctx.drawImage(wallAssets.houseWall, x*TILE_SIZE, y*TILE_SIZE, TILE_SIZE, TILE_SIZE);
                        } else {
                            ctx.fillStyle = '#e2e8f0'; // Slate white
                            ctx.fillRect(x*TILE_SIZE, y*TILE_SIZE, TILE_SIZE, TILE_SIZE);
                        }
                    } else if (t === 10) { // Floor (UPDATE: Pakai Lantai Mentor)
                        if (mentorAssets.floor.complete && mentorAssets.floor.naturalWidth !== 0) {
                            ctx.drawImage(mentorAssets.floor, x*TILE_SIZE, y*TILE_SIZE, TILE_SIZE, TILE_SIZE); 
                        } else {
                            ctx.fillStyle = '#b45309'; 
                            ctx.fillRect(x*TILE_SIZE, y*TILE_SIZE, TILE_SIZE, TILE_SIZE);
                        }
                    }
                }

                // Handle Other Tiles (UPDATE: Exclude t=0/Water from this fallback)
                else if(t !== 2 && t !== 12 && t !== 4 && t !== 0) {
                    if(!(isBgLoaded && (t === 9 || t === 1))) {
                        ctx.fillRect(x*TILE_SIZE, y*TILE_SIZE, TILE_SIZE, TILE_SIZE);
                    }
                }

                // Handle Trees (Village only for ID 2 & 12)
                // UPDATE: Hanya gambar pohon jika di Village (Agar tidak muncul di Blacksmith/Guild yang pakai ID 2)
                if((t===2 || t===12) && STATE.location === 'village') {
                    if(!isBgLoaded) {
                        ctx.fillStyle = '#1e293b'; 
                        ctx.fillRect(x*TILE_SIZE, y*TILE_SIZE, TILE_SIZE, TILE_SIZE);
                    }

                    let trunkImg = (t === 12) ? treeAssets.sakuraTrunk : treeAssets.trunk;
                    
                    if (trunkImg && trunkImg.complete && trunkImg.naturalWidth !== 0) {
                        ctx.drawImage(trunkImg, x*TILE_SIZE, y*TILE_SIZE, TILE_SIZE, TILE_SIZE);
                    } else {
                        ctx.fillStyle = '#5D4037';
                        const trunkW = 12; const trunkH = 24;
                        const tx = x*TILE_SIZE + (TILE_SIZE - trunkW)/2;
                        const ty = y*TILE_SIZE + (TILE_SIZE - trunkH);
                        ctx.fillRect(tx, ty, trunkW, trunkH);
                    }
                }

                // FIX: Menghapus syarat !isBgLoaded agar lahan pertanian selalu digambar
                if(t===5) { 
                    // NEW: Ambil Data Pertanian (Tilled/Crop)
                    const farmKey = `${x}_${y}`;
                    const farmData = STATE.player.farming ? STATE.player.farming[farmKey] : null;

                    // UPDATE: MENGGUNAKAN GAMBAR LAHAN LIAR (images/lahan-liar.png)
                    if (farmAssets.lahanLiar.complete && farmAssets.lahanLiar.naturalWidth !== 0) {
                        ctx.drawImage(farmAssets.lahanLiar, x*TILE_SIZE, y*TILE_SIZE, TILE_SIZE, TILE_SIZE);
                        
                        // NEW: VISUAL TANAH GEMBUR (TILLED) - Overlay Gelap + Garis
                        if (farmData && farmData.tilled) {
                            ctx.fillStyle = 'rgba(0, 0, 0, 0.3)'; // Overlay Gelap
                            ctx.fillRect(x*TILE_SIZE + 2, y*TILE_SIZE + 2, TILE_SIZE - 4, TILE_SIZE - 4);
                            
                            // Garis Bajak (Detail)
                            ctx.fillStyle = 'rgba(60, 30, 10, 0.4)';
                            ctx.fillRect(x*TILE_SIZE + 4, y*TILE_SIZE + 8, TILE_SIZE - 8, 2);
                            ctx.fillRect(x*TILE_SIZE + 4, y*TILE_SIZE + 15, TILE_SIZE - 8, 2);
                            ctx.fillRect(x*TILE_SIZE + 4, y*TILE_SIZE + 22, TILE_SIZE - 8, 2);
                        }

                        // NEW: VISUAL TANAMAN (CROP) & STATUS AIR
                        if (farmData && farmData.type) {
                            // Indikator Tanah Basah (Watered)
                            if(farmData.watered) {
                                ctx.fillStyle = 'rgba(56, 189, 248, 0.5)'; // Biru Transparan
                                ctx.fillRect(x*TILE_SIZE, y*TILE_SIZE, TILE_SIZE, TILE_SIZE);
                            }

                            // Ikon Tanaman Berdasarkan Stage
                            const stage = farmData.stage || 1;
                            let icon = ''; // Stage 1 (Bibit/Tunas)
                            
                            if (stage === 2) {
                                icon = ''; // Stage 2 Default (Tanaman Muda)
                                
                                // KHUSUS RAFFLESIA: Tampilkan Kuncup/Bunga Mati saat kecil
                                if (farmData.type === 'rafflesia') icon = ''; 
                                // KHUSUS JAGUNG/TOMAT: Tampilkan tanaman hijau lebih besar
                                else if (farmData.type === 'jagung' || farmData.type === 'tomat') icon = '';
                            }
                            
                            if (stage >= 3) { // Stage 3 (Siap Panen - Sempurna)
                                if (farmData.type === 'padi') icon = '';
                                else if (farmData.type === 'jagung') icon = '';
                                else if (farmData.type === 'tomat') icon = '';
                                else if (farmData.type === 'rafflesia') icon = ''; // Visual Rafflesia Mekar
                            }
                            
                            ctx.font = '20px Arial';
                            ctx.textAlign = 'center';
                            ctx.textBaseline = 'middle';
                            // Shadow biar jelas
                            ctx.fillStyle = 'rgba(0,0,0,0.5)';
                            ctx.fillText(icon, x*TILE_SIZE + 16, y*TILE_SIZE + 17);
                            ctx.fillStyle = '#fff';
                            ctx.fillText(icon, x*TILE_SIZE + 15, y*TILE_SIZE + 15);
                        }

                        // Efek Salju di atas lahan saat Winter
                        if(STATE.season === 'winter') {
                             ctx.fillStyle = 'rgba(255, 255, 255, 0.4)';
                             ctx.fillRect(x*TILE_SIZE, y*TILE_SIZE, TILE_SIZE, TILE_SIZE);
                        }
                    } else {
                        // Fallback ke Kotak Coklat Lama (Jika gambar belum load)
                        ctx.fillStyle = STATE.season === 'winter' ? 'rgba(148, 163, 184, 0.8)' : 'rgba(146, 64, 14, 0.6)'; 
                        ctx.fillRect(x*TILE_SIZE, y*TILE_SIZE, TILE_SIZE, TILE_SIZE);
                        
                        // Gambar gundukan tanah (detail)
                        ctx.fillStyle = STATE.season === 'winter' ? '#cbd5e1' : '#d97706'; 
                        // Pola gundukan tanah
                        ctx.fillRect(x*TILE_SIZE+5, y*TILE_SIZE+5, TILE_SIZE-10, TILE_SIZE-10);
                    }
                }

                // NEW: DRAW RUINS FLOOR (ID 7)
                if(t===7) {
                    // FIX: LAYERED RENDERING (LANTAI DI ATAS TEMBOK)
                    // Sesuai request: Lantai tetap gambar lama, tapi lubang di tengah diisi tembok.
                    
                    // 1. LAYER BAWAH: Gambar Tembok (Untuk mengisi bagian yang bolong/transparan)
                    if (ruinsAssets.wall.complete && ruinsAssets.wall.naturalWidth !== 0) {
                        ctx.drawImage(ruinsAssets.wall, x*TILE_SIZE, y*TILE_SIZE, TILE_SIZE, TILE_SIZE);
                    } else {
                        // Fallback warna batu jika gambar tembok belum load
                        ctx.fillStyle = '#57534e'; 
                        ctx.fillRect(x*TILE_SIZE, y*TILE_SIZE, TILE_SIZE, TILE_SIZE);
                    }

                    // 2. LAYER ATAS: Gambar Lantai Reruntuhan (Overlay Utama)
                    if (ruinsAssets.floor.complete && ruinsAssets.floor.naturalWidth !== 0) {
                        ctx.drawImage(ruinsAssets.floor, x*TILE_SIZE, y*TILE_SIZE, TILE_SIZE, TILE_SIZE);
                    } else {
                        // Fallback detail jika gambar lantai gagal
                        ctx.strokeStyle = '#44403c';
                        ctx.lineWidth = 1;
                        ctx.beginPath();
                        ctx.moveTo(x*TILE_SIZE, y*TILE_SIZE);
                        ctx.lineTo(x*TILE_SIZE+10, y*TILE_SIZE+10);
                        ctx.stroke();
                    }
                }
                
                if(t===9) { 
                    ctx.fillStyle = '#06b6d4';
                    const pulse = Math.sin(Date.now()/200)*2;
                    ctx.beginPath(); ctx.arc(x*TILE_SIZE+15, y*TILE_SIZE+15, 10 + pulse, 0, 6.28); ctx.fill();
                    
                    ctx.font = 'bold 8px "Exo 2"';
                    ctx.fillStyle = '#fff';
                    ctx.textAlign = 'center';
                    ctx.fillText("ENTER", x*TILE_SIZE+15, y*TILE_SIZE-5 + pulse);
                }
            }
        }
    }

    // --- NEW: RENDER SILUET IKAN (LAYER BAWAH - UNDERWATER) ---
    // Digambar setelah Tiles/Background tapi SEBELUM Objek/Player/Dermaga
    if (STATE.location === 'village') {
        STATE.critters.forEach(c => {
            if (c.type === 'fish_silhouette') {
                ctx.save();
                ctx.translate(c.x, c.y);
                
                // Rotasi sesuai arah gerak
                const angle = Math.atan2(c.vy, c.vx);
                ctx.rotate(angle);
                
                // UPDATE: Warna dipertegas (Hitam Pekat 0.8) agar kontras dengan air biru
                ctx.fillStyle = 'rgba(0, 0, 0, 0.8)'; 
                
                // 1. Badan Ikan (Oval)
                ctx.beginPath();
                ctx.ellipse(0, 0, 10 * c.size, 4 * c.size, 0, 0, Math.PI*2);
                ctx.fill();
                
                // 2. Ekor Ikan (Segitiga di belakang)
                ctx.beginPath();
                ctx.moveTo(-8 * c.size, 0);
                ctx.lineTo(-14 * c.size, -4 * c.size);
                ctx.lineTo(-14 * c.size, 4 * c.size);
                ctx.fill();

                // 3. Sirip Samping (Kecil)
                ctx.beginPath();
                ctx.moveTo(2 * c.size, 2 * c.size);
                ctx.lineTo(-2 * c.size, 6 * c.size);
                ctx.lineTo(-2 * c.size, 2 * c.size);
                ctx.fill();
                
                ctx.restore();
            }
        });
    }

    // --- FIX: HAPUS BLOK KODE "GHOST" INI ---
    // Blok kode di bawah ini menggambar objek TANPA cek musim, menyebabkan Snowman muncul terus.
    // Kita hapus karena objek sudah digambar ulang dengan benar di 'renderList' di bawahnya.
    
    /*
    map.objects.forEach(o => {
        ctx.fillStyle = 'rgba(0,0,0,0.3)';
        
        // UPDATE: Bayangan mengikuti ukuran objek
        const shadowW = (o.w || 1) * 12;
        const centerX = (o.x * TILE_SIZE) + ((o.w || 1) * TILE_SIZE / 2);
        const centerY = (o.y * TILE_SIZE) + ((o.h || 1) * TILE_SIZE) - 2;
        
        ctx.beginPath(); 
        ctx.ellipse(centerX, centerY, shadowW, 4, 0, 0, Math.PI*2); 
        ctx.fill();
        
        // PERBAIKAN: Support Gambar untuk Object (Buku & Telpon)
        if (o.img) {
            if (!o.loadedImg) {
                o.loadedImg = new Image();
                o.loadedImg.src = o.img;
            }
            
            if (o.loadedImg.complete && o.loadedImg.naturalWidth !== 0) {
                // UPDATE: Gambar object sesuai ukuran custom (w/h)
                const drawW = (o.w || 1) * TILE_SIZE;
                const drawH = (o.h || 1) * TILE_SIZE;
                ctx.drawImage(o.loadedImg, o.x*TILE_SIZE, o.y*TILE_SIZE, drawW, drawH);
            } else {
                // Fallback ke Icon jika gambar belum load/error
                ctx.font = '20px Arial';
                ctx.fillText(o.icon, o.x*TILE_SIZE+5, o.y*TILE_SIZE+25);
            }
        } else {
            // Default Icon Rendering
            ctx.font = '20px Arial';
            ctx.fillText(o.icon, o.x*TILE_SIZE+5, o.y*TILE_SIZE+25);
        }
    });
    */

    if(DEBUG_MAP_BOUNDARIES && STATE.location === 'village') {
        ctx.save();
        ctx.strokeStyle = 'red';
        ctx.lineWidth = 5;
        /* Gunakan konstanta atau nilai besar untuk debug boundary */
        ctx.strokeRect(5 * TILE_SIZE, 5 * TILE_SIZE, 50 * TILE_SIZE, 30 * TILE_SIZE);
        
        ctx.fillStyle = 'red';
        ctx.font = 'bold 30px Arial';
        ctx.fillText("BATAS PULAU", 5 * TILE_SIZE + 20, 5 * TILE_SIZE + 50);
        ctx.restore();
    }

    if(STATE.location === 'house') {
        const furn = STATE.player.furniture;
        if(furn.includes('carpet_red')) {
            ctx.fillStyle = '#b91c1c';
            ctx.transform(1, 0, -0.2, 1, 0, 0); 
            ctx.fillRect(4*TILE_SIZE + 10, 4*TILE_SIZE, 7*TILE_SIZE, 4*TILE_SIZE);
            ctx.transform(1, 0, 0.2, 1, 0, 0); 
        }
        if(furn.includes('tv_flat')) {
            ctx.fillStyle = '#111';
            ctx.fillRect(6*TILE_SIZE, 1*TILE_SIZE+10, 3*TILE_SIZE, 5);
            ctx.fillStyle = '#000';
            ctx.fillRect(6*TILE_SIZE, 1*TILE_SIZE, 3*TILE_SIZE, 15);
            ctx.fillStyle = '#222'; 
            ctx.fillRect(6*TILE_SIZE, 1*TILE_SIZE, 3*TILE_SIZE, 1);
        }
    }

    let renderList = [];

    // UPDATE: Pindahkan Objek ke RenderList agar support Z-Sorting (Pemain bisa di belakang kursi)
    // Sebelumnya objek digambar langsung sebelum loop ini, sekarang digabung.
    if (map.objects) {
	
        map.objects.forEach(o => {
			
		// --- [BARU] CEK MUSIM SAAT RENDERING ---
            if (o.seasonReq && o.seasonReq !== STATE.season) return;
            // ---------------------------------------
			
            // Sort berdasarkan bagian bawah objek
            const h = (o.h || 1);
            let sortY = (o.y + h) * TILE_SIZE;
            
            // Sedikit penyesuaian agar tidak flickering dengan pemain
            if(o.type === 'table') sortY -= 5; 

            renderList.push({
                type: 'object',
                y: sortY,
                data: o
            });
        });
    }

    if(map.buildings) {
        map.buildings.forEach(b => {
             if(typeof b.y !== 'number' || typeof b.h !== 'number') return;
             
             // FIX: Menentukan prioritas gambar (Z-Index)
             // Default: Urutkan berdasarkan kaki bangunan (Y + Height) agar pemain bisa tertutup saat di belakangnya
             let sortY = (b.y + b.h) * TILE_SIZE;

             // EXCEPTION: Untuk 'port' (Dermaga) yang merupakan lantai datar/walkable,
             // kita set sortY ke bagian paling atas bangunan.
             // Ini memaksa Dermaga digambar LEBIH DULU daripada pemain, sehingga pemain terlihat BERDIRI DI ATASNYA.
             if (b.id === 'port') {
                 sortY = (b.y * TILE_SIZE); 
             }

             renderList.push({
                type: 'building',
                y: sortY, 
                data: b
             });
        });
    }

    renderList.push({
        type: 'player',
        y: STATE.player.y + STATE.player.h, 
        data: STATE.player
    });
	
	// --- NEW: RENDER HANTU PEMAIN LAIN ---
    if (STATE.ghosts && STATE.ghosts.length > 0) {
        STATE.ghosts.forEach(g => {
            // Hanya gambar jika berada di lokasi (map) yang sama
            if (g.location === STATE.location) {
                 renderList.push({
                    type: 'ghost',
                    y: g.y + 20, // Estimasi kaki
                    data: g
                });
            }
        });
    }

    map.npcs.forEach(n => {
        if (!isNPCActive(n)) return;

        // --- UPDATE: Z-INDEX SORTING FIX ---
        // Masalah: Player terlihat "menginjak" NPC saat berjalan di belakangnya.
        // Penyebab: Sorting sebelumnya menggunakan Grid Tile (n.y * 30 + 30).
        // Solusi: Gunakan tinggi visual NPC (h=60) untuk sorting. 
        // Rumus: Y Kaki Visual = (n.y * 30) + Tinggi Sprite (n.h) - Offset Gambar (5)
        
        const visualHeight = n.h || 48; // Default tinggi sprite
        const sortY = (n.y * TILE_SIZE) + visualHeight - 5;

        renderList.push({
            type: 'npc',
            y: sortY, 
            data: n
        });
    });

    if(STATE.location === 'dungeon') {
        STATE.enemies.forEach(e => {
            renderList.push({
                type: 'enemy',
                y: e.y + e.h,
                data: e
            });
        });
    }

    renderList.sort((a, b) => a.y - b.y);

    renderList.forEach(item => {
        try {
            if(item.type === 'building') drawBuilding(ctx, item.data);
            else if(item.type === 'player') drawPlayer(ctx, item.data);
			else if(item.type === 'ghost') drawGhost(ctx, item.data); // <--- TAMBAHAN
            else if(item.type === 'npc') drawNPC(ctx, item.data);
            else if(item.type === 'enemy') drawEnemy(ctx, item.data);
            else if(item.type === 'object') drawObject(ctx, item.data); // NEW: Handle drawObject
        } catch(e) {
            console.error("Render error:", e);
        }
    });

    if(STATE.location === 'village') {
        for(let y=startRow; y<=endRow; y++) {
            for(let x=startCol; x<=endCol; x++) {
                if(y>=0 && y<map.h && x>=0 && x<map.w) {
                    const t = map.tiles[y*map.w+x];
                    
                    if(t===2 || t===12) {
                        let canopyImg = (t === 12) ? treeAssets.sakuraCanopy : treeAssets.canopy;

                        if (canopyImg && canopyImg.complete && canopyImg.naturalWidth !== 0) {
                            
                            const canopyW = 64; 
                            const canopyH = 64;
                            const cx = (x * TILE_SIZE) - (canopyW - TILE_SIZE)/2; 
                            const cy = (y * TILE_SIZE) - (canopyH - 10); 

                            ctx.drawImage(canopyImg, cx, cy, canopyW, canopyH);
							
							 // --- NEW: EFEK SALJU MENEMPEL DI POHON ---
                            if(STATE.season === 'winter') {
                                ctx.fillStyle = 'rgba(255, 255, 255, 0.9)'; // Putih Salju
                                // Gambar gumpalan salju di atas kanopi
                                ctx.beginPath();
                                ctx.arc(cx + canopyW/2, cy + 20, 15, Math.PI, 0); // Setengah lingkaran atas
                                ctx.fill();
                                
                                // Gumpalan kecil tambahan
                                ctx.beginPath();
                                ctx.arc(cx + canopyW/2 - 15, cy + 30, 8, 0, Math.PI*2);
                                ctx.fill();
                                ctx.beginPath();
                                ctx.arc(cx + canopyW/2 + 15, cy + 30, 8, 0, Math.PI*2);
                                ctx.fill();
                            }
                            // -----------------------------------------
							
                            
                            if(t === 12 && Math.random() < 0.05) {
                                createParticle((x*TILE_SIZE)+16, (y*TILE_SIZE)-10, '#fbcfe8');
                            }
                        } else {
                            let leafColor = (t === 12) ? '#f472b6' : '#15803d'; 
                            if(STATE.season === 'autumn' && t!==12) leafColor = '#d97706';
                            // Jika Winter dan tidak ada gambar, ganti warna daun jadi putih
                            if(STATE.season === 'winter' && t!==12) leafColor = '#e2e8f0';
							
							
							
                            ctx.fillStyle = leafColor;
                            const centerX = x * TILE_SIZE + 16;
                            const centerY = y * TILE_SIZE - 20; 
                            ctx.beginPath();
                            ctx.arc(centerX, centerY, 25, 0, Math.PI*2);
                            ctx.fill();
                        }
                    }
                }
            }
        }
    }

    // --- UPDATE: RENDER CRITTERS UDARA (BIRD & BUTTERFLY) ---
    // Ikan sudah dirender di layer bawah, jadi di sini skip ikan
    STATE.critters.forEach(c => {
        // SKIP IKAN (Sudah digambar di layer bawah)
        if (c.type === 'fish_silhouette') return;

        if(c.type === 'bird') {
            ctx.strokeStyle = '#fff'; 
            if(STATE.time > 1500) ctx.strokeStyle = '#cbd5e1'; 
            
            ctx.lineWidth = 1.5;
            ctx.beginPath();
            
            const flapY = Math.sin(c.flap) * 3;
            
            ctx.moveTo(c.x, c.y);
            ctx.lineTo(c.x - 5, c.y - 2 + flapY); 
            ctx.moveTo(c.x, c.y);
            ctx.lineTo(c.x + 5, c.y - 2 + flapY); 
            ctx.stroke();
            
            ctx.fillStyle = 'rgba(0,0,0,0.1)';
            ctx.beginPath();
            ctx.ellipse(c.x - 20, c.y + 40, 4, 2, 0, 0, Math.PI*2);
            ctx.fill();
        } 
        /* LOGIKA IKAN DIHAPUS DARI SINI (PINDAH KE drawFish DI ATAS) */
        else if(c.type === 'butterfly') {
            ctx.fillStyle = c.color;
            const flapW = Math.abs(Math.sin(Date.now()/100)) * 3;
            ctx.beginPath();
            ctx.ellipse(c.x - 2, c.y, flapW, 3, 0, 0, Math.PI*2);
            ctx.fill();
            ctx.beginPath();
            ctx.ellipse(c.x + 2, c.y, flapW, 3, 0, 0, Math.PI*2);
            ctx.fill();
        }
    });

    if(STATE.fishing.active) {
        ctx.save();
        ctx.translate(STATE.player.x, STATE.player.y - 30); 
        
        ctx.fillStyle = '#334155';
        ctx.fillRect(-25, 0, 50, 10);
        
        const tStart = (STATE.fishing.targetStart / 100) * 50 - 25;
        const tWidth = (STATE.fishing.targetWidth / 100) * 50;
        ctx.fillStyle = '#4ade80';
        ctx.fillRect(tStart, 0, tWidth, 10);
        
        const indX = (STATE.fishing.barX / 100) * 50 - 25;
        ctx.fillStyle = '#fff';
        ctx.fillRect(indX, -2, 2, 14);
        
        ctx.restore();
    }

    STATE.particles.forEach(p => {
        // --- UPDATE: RENDER PARTIKEL NADA MUSIK ---
        if(p.type === 'note') {
            ctx.save();
            ctx.font = `bold ${p.size}px Arial`;
            ctx.fillStyle = p.color;
            ctx.globalAlpha = p.life / 80; // Fade out effect
            ctx.fillText(p.icon, p.x, p.y);
            ctx.restore();
        } 
        // NEW: RENDER PARTIKEL CIPRATAN AIR
        else if (p.type === 'splash') {
            ctx.save();
            ctx.fillStyle = p.color;
            ctx.globalAlpha = p.life / 25; // Fade out seiring umur
            ctx.beginPath();
            ctx.arc(p.x, p.y, p.size, 0, Math.PI*2); // Bentuk bulat air
            ctx.fill();
            ctx.restore();
        }
        // --- NEW: RENDER LOVE BUBBLE (Gelembung Hati) ---
        else if (p.type === 'love_bubble') {
            ctx.save();
            ctx.translate(p.x, p.y);
            
            // Animasi Pop-up (Membesar saat muncul)
            let scale = 1;
            if (p.life > 50) scale = (60 - p.life) / 10;
            ctx.scale(scale, scale);

            // Bubble Background (Lingkaran Putih)
            ctx.fillStyle = 'rgba(255, 255, 255, 0.95)';
            ctx.strokeStyle = '#fda4af'; // Pink pastel border
            ctx.lineWidth = 2;
            
            ctx.beginPath();
            ctx.arc(0, 0, 14, 0, Math.PI*2);
            ctx.fill();
            ctx.stroke();
            
            // Ekor Bubble Kecil (Biar kayak chat)
            ctx.beginPath();
            ctx.moveTo(0, 12);
            ctx.lineTo(-4, 18);
            ctx.lineTo(4, 16);
            ctx.fillStyle = 'rgba(255, 255, 255, 0.95)';
            ctx.fill();

            // Icon Heart di Tengah
            ctx.font = "16px Arial";
            ctx.textAlign = "center";
            ctx.textBaseline = "middle";
            ctx.fillStyle = "#ef4444"; // Merah Hati
            ctx.fillText("", 0, 2); // Sedikit turun agar pas tengah visual
            
            ctx.restore();
        }
        // --- FIX: RENDER CHAT BUBBLE (GELEMBUNG BICARA "...") ---
        else if (p.type === 'chat_bubble') {
            ctx.save();
            ctx.translate(p.x, p.y);
            
            // Efek Pop-up (Membesar saat muncul)
            let scale = 1;
            if (p.life > 60) scale = (70 - p.life) / 10;
            ctx.scale(scale, scale);

            // 1. Gambar Bubble Putih (Oval)
            ctx.fillStyle = 'rgba(255, 255, 255, 0.95)';
            ctx.strokeStyle = '#64748b'; // Border abu-abu
            ctx.lineWidth = 1;
            
            ctx.beginPath();
            ctx.ellipse(0, 0, 14, 10, 0, 0, Math.PI*2); // Lebar 14, Tinggi 10
            ctx.fill();
            ctx.stroke();
            
            // 2. Ekor Bubble
            ctx.beginPath();
            ctx.moveTo(-2, 8);   // Kiri bawah oval
            ctx.lineTo(-5, 14);  // Ujung ekor
            ctx.lineTo(2, 9);    // Kanan bawah oval
            ctx.fillStyle = 'rgba(255, 255, 255, 0.95)';
            ctx.fill();
            // Opsional: stroke ekor (biasanya tidak perlu agar menyatu)

            // 3. Teks "..." di Tengah
            ctx.fillStyle = '#0f172a'; // Teks Hitam
            ctx.font = "bold 12px Arial";
            ctx.textAlign = "center";
            ctx.textBaseline = "middle";
            ctx.fillText("...", 0, -2); // Sedikit naik agar pas di tengah
            
            ctx.restore();
        }
        // --- NEW: RENDER DUST PARTICLE (JEJAK LARI) ---
        else if (p.type === 'dust') {
            ctx.save();
            ctx.fillStyle = p.color;
            // Efek Fade Out: Transparansi berkurang seiring sisa umur (life)
            ctx.globalAlpha = Math.max(0, p.life / 30); 
            
            ctx.beginPath();
            ctx.arc(p.x, p.y, p.size, 0, Math.PI*2); // Lingkaran debu
            ctx.fill();
            
            // Efek Shrink: Mengecil perlahan
            if(p.size > 0.5) p.size *= 0.95;
            
            ctx.restore();
        }
        // --- NEW: RENDER SPIRIT AURA (PARTIKEL DEWI RORO) ---
        else if (p.type === 'spirit_aura') {
            ctx.save();
            ctx.fillStyle = p.color;
            ctx.shadowColor = p.color;
            ctx.shadowBlur = 8; // Glow effect
            ctx.globalAlpha = p.life / 80; // Fade out halus
            
            ctx.beginPath();
            ctx.arc(p.x, p.y, p.size, 0, Math.PI*2);
            ctx.fill();
            
            ctx.restore();
        }
        else {
            // Render Partikel Kotak Biasa
            ctx.fillStyle = p.color;
            ctx.fillRect(p.x, p.y, 4, 4);
        }
    });

    // --- NEW: DRAW FLOATING TEXTS ---
    STATE.floatingTexts.forEach(ft => {
        ctx.save();
        ctx.font = `bold ${ft.size}px "Exo 2"`;
        ctx.fillStyle = ft.color;
        ctx.strokeStyle = 'black';
        ctx.lineWidth = 2;
        ctx.strokeText(ft.text, ft.x, ft.y);
        ctx.fillText(ft.text, ft.x, ft.y);
        ctx.restore();
    });

    if(STATE.lightningTimer > 10) { 
        ctx.save();
        ctx.strokeStyle = '#fff';
        ctx.lineWidth = 2;
        ctx.shadowColor = '#fff';
        ctx.shadowBlur = 20;
        ctx.beginPath();
        
        let lx = STATE.camera.x + (Math.random() * GAME_WIDTH); 
        let ly = STATE.camera.y - 50; 
        
        ctx.moveTo(lx, ly);
        while(ly < STATE.camera.y + GAME_HEIGHT) {
            lx += (Math.random() - 0.5) * 50; 
            ly += (Math.random() * 40) + 20;  
            ctx.lineTo(lx, ly);
        }
        ctx.stroke();
        ctx.restore();
    }

    ctx.restore(); 

    let overlayColor = 'rgba(0,0,0,0)';
    
    if(STATE.location === 'village') {
        if(STATE.weather === 'rain') {
            overlayColor = 'rgba(10, 15, 40, 0.5)'; 
            
            if(STATE.time >= 2000 || STATE.time < 400) {
                overlayColor = 'rgba(5, 5, 20, 0.7)';
            }
        } 
        else {
            if(STATE.time > 1700 && STATE.time < 2000) overlayColor = 'rgba(255, 100, 0, 0.2)'; 
            else if(STATE.time >= 2000 || STATE.time < 400) overlayColor = 'rgba(0, 0, 50, 0.5)'; 
        }
    }

    if(overlayColor !== 'rgba(0,0,0,0)') {
        
        ctx.save();
        
        ctx.fillStyle = overlayColor;
        ctx.fillRect(0, 0, canvas.width, canvas.height); 

        // LOGIKA PENCAHAYAAN (LIGHTING SYSTEM)
        if(STATE.time >= 1800 || STATE.time < 500 || STATE.weather === 'rain') {
            
            // FIX: Hitung Scale Factor Dinamis (Penting untuk Mobile vs PC)
            // Sebelumnya hardcode * 4, sekarang menyesuaikan canvas.width aktual
            const scaleFactor = canvas.width / GAME_WIDTH;

            // 1. CAHAYA PEMAIN (SENTER/OBOR)
            // Tambahkan shakeX/Y agar cahaya ikut bergetar saat gempa/damage
            let shakeX = 0, shakeY = 0;
            if(STATE.shakeTimer > 0) {
                shakeX = (Math.random() - 0.5) * 10;
                shakeY = (Math.random() - 0.5) * 10;
            }

            const screenX = (STATE.player.x + 10) - STATE.camera.x + shakeX;
            const screenY = (STATE.player.y + 10) - STATE.camera.y + shakeY;
            
            if(screenX > -50 && screenX < GAME_WIDTH + 50 && screenY > -50 && screenY < GAME_HEIGHT + 50) {
                
                // UPDATE: Gunakan scaleFactor untuk posisi presisi
                const realX = screenX * scaleFactor;
                const realY = screenY * scaleFactor;
                
                // UPDATE: Radius juga disesuaikan skala agar proporsional
                const r1 = 5 * scaleFactor;    // Radius dalam
                const r2 = 37.5 * scaleFactor; // Radius luar (Cahaya menyebar)
                
                const rad = ctx.createRadialGradient(realX, realY, r1, realX, realY, r2);
                rad.addColorStop(0, 'rgba(255, 255, 200, 0.3)'); 
                rad.addColorStop(1, 'rgba(255, 255, 200, 0)');   

                ctx.fillStyle = rad;
                ctx.globalCompositeOperation = 'overlay'; 
                ctx.beginPath();
                ctx.arc(realX, realY, r2, 0, Math.PI*2);
                ctx.fill();
                // Reset composite sementara agar cahaya bangunan bisa ditumpuk
                ctx.globalCompositeOperation = 'source-over'; 
            }

            // 2. NEW: CAHAYA BANGUNAN (LAMPU JENDELA/PINTU)
            if (map.buildings) {
                ctx.globalCompositeOperation = 'overlay'; // Mode pencampuran cahaya

                map.buildings.forEach(b => {
                    // Cek apakah bangunan punya jam operasional
                    let isLightsOn = false;

                    // Jika buka 24 jam, lampu nyala terus saat malam
                    if (b.open24h) {
                        isLightsOn = true;
                    } 
                    // Jika punya jam buka/tutup, cek waktu sekarang
                    else if (b.openTime && b.closeTime) {
                        if (STATE.time >= b.openTime && STATE.time < b.closeTime) {
                            isLightsOn = true;
                        }
                    }

                    // Khusus Rumah Player: Selalu nyala
                    if (b.id === 'player_house') isLightsOn = true;

                    if (isLightsOn) {
                        // Tentukan titik sumber cahaya (Di pintu atau tengah bangunan)
                        let lightGameX, lightGameY;
                        
                        if (b.entrance) {
                            lightGameX = (b.entrance.x * TILE_SIZE) + (TILE_SIZE / 2);
                            lightGameY = (b.entrance.y * TILE_SIZE) + (TILE_SIZE / 2);
                        } else {
                            lightGameX = (b.x * TILE_SIZE) + (b.w * TILE_SIZE / 2);
                            lightGameY = (b.y * TILE_SIZE) + (b.h * TILE_SIZE / 2);
                        }

                        // Konversi ke koordinat layar (+ Shake effect sinkron kamera)
                        const bScreenX = lightGameX - STATE.camera.x + shakeX;
                        const bScreenY = lightGameY - STATE.camera.y + shakeY;

                        // Cek apakah masuk layar (Optimasi render)
                        if(bScreenX > -100 && bScreenX < GAME_WIDTH + 100 && bScreenY > -100 && bScreenY < GAME_HEIGHT + 100) {
                            // UPDATE: Gunakan scaleFactor
                            const realBX = bScreenX * scaleFactor;
                            const realBY = bScreenY * scaleFactor;

                            // Efek Kedip Lampu (Sedikit)
                            const flicker = Math.sin(Date.now() / 200 + b.x) * 5; 
                            
                            // Radius base disesuaikan skala
                            const baseRadius = 30 * scaleFactor; 
                            const radius = baseRadius + flicker; 

                            // Warna Lampu Hangat (Kuning/Oranye)
                            const lightGrad = ctx.createRadialGradient(realBX, realBY, 2.5 * scaleFactor, realBX, realBY, radius);
                            lightGrad.addColorStop(0, 'rgba(255, 220, 100, 0.5)'); // Pusat terang
                            lightGrad.addColorStop(0.5, 'rgba(255, 180, 50, 0.2)'); // Tengah hangat
                            lightGrad.addColorStop(1, 'rgba(0, 0, 0, 0)'); // Pinggir transparan

                            ctx.fillStyle = lightGrad;
                            ctx.beginPath();
                            ctx.arc(realBX, realBY, radius, 0, Math.PI*2);
                            ctx.fill();
                        }
                    }
                });
                
                ctx.globalCompositeOperation = 'source-over'; // Kembalikan ke normal
            }
        }
        ctx.restore();
    }

    if(STATE.lightningTimer > 0) {
        const flashOpacity = (STATE.lightningTimer / 15) * 0.6; 
        ctx.fillStyle = `rgba(255, 255, 255, ${flashOpacity})`;
        ctx.fillRect(0, 0, canvas.width, canvas.height);
    }

    if(STATE.weather !== 'clear' && STATE.location === 'village') {
        ctx.save();
        
        STATE.weatherParticles.forEach(p => {
            if(p.type === 'rain') {
                ctx.fillStyle = 'rgba(100, 100, 255, 0.6)';
                ctx.fillRect(p.x, p.y, 2, 10); 
            } 
            else if(p.type === 'snow') {
                ctx.fillStyle = 'rgba(255, 255, 255, 0.8)';
                ctx.beginPath(); ctx.arc(p.x, p.y, 3, 0, Math.PI*2); ctx.fill();
            }
            else if(p.type === 'sakura') {
                ctx.fillStyle = '#fbcfe8';
                ctx.beginPath(); ctx.ellipse(p.x, p.y, 4, 2, Math.PI/4, 0, Math.PI*2); ctx.fill();
            }
            else if(p.type === 'fall_leaves') {
                ctx.fillStyle = '#d97706';
                ctx.beginPath(); ctx.moveTo(p.x, p.y); 
                ctx.lineTo(p.x+5, p.y+2); ctx.lineTo(p.x, p.y+5); ctx.fill();
            }
        });
        ctx.restore();
    }

    // --- FIX: PANGGIL MINIMAP SETIAP FRAME ---
    drawMinimap();
}

// NEW FUNCTION: DRAW OBJECT (Dipisah dari loop utama draw)
function drawObject(ctx, o) {
    ctx.fillStyle = 'rgba(0,0,0,0.3)';
    
    // Bayangan mengikuti ukuran objek
    const shadowW = (o.w || 1) * 12;
    const centerX = (o.x * TILE_SIZE) + ((o.w || 1) * TILE_SIZE / 2);
    const centerY = (o.y * TILE_SIZE) + ((o.h || 1) * TILE_SIZE) - 2;
    
    ctx.beginPath(); 
    ctx.ellipse(centerX, centerY, shadowW, 4, 0, 0, Math.PI*2); 
    ctx.fill();
    
    // Support Gambar untuk Object
    if (o.img) {
        if (!o.loadedImg) {
            o.loadedImg = new Image();
            o.loadedImg.src = o.img;
            
            // --- FIX: ADD ERROR HANDLER & FALLBACK FOR OBJECT IMAGES ---
            o.loadedImg.onerror = function() {
                this.onerror = null;
                const src = o.img || "";

                // Fallback khusus untuk kotak surat (Mailbox Merah)
                if (o.type === 'mailbox') {
                    this.src = 'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIzMiIgaGVpZ2h0PSIzMiI+PHBhdGggZD0iTTE0IDMyIEwxNCAxNSBMOSAxNSBMOSAxMCBMMjMgMTAgTDIzIDE1IEwxOCAxNSBMMTggMzIgWiIgZmlsbD0iIzU5MzgxMSIvPjxwYXRoIGQ9Ik02IDUgTDI2IDUgTDI2IDEyIEMyNiAxNCA2IDE0IDYgMTIgWiIgZmlsbD0iI0RDMjYyNiIvPjxyZWN0IHg9IjgiIHk9IjciIHdpZHRoPSIxNiIgaGVpZ2h0PSIyIiBmaWxsPSIjRkZGRkZGIiBvcGFjaXR5PSIwLjUiLz48L3N2Zz4=';
                } 
                // NEW: FALLBACK KASUR (Visual Bed)
                // UPDATE: Cek juga nama file 'bed' agar fallback tetap jalan jika images/bed.png gagal load
                else if (src.includes('kasur') || src.includes('bed')) {
                    this.src = 'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI2NCIgaGVpZ2h0PSI5NiI+PHJlY3QgeD0iNCIgeT0iMTAiIHdpZHRoPSI1NiIgaGVpZ2h0PSI4MCIgZmlsbD0iIzhCNEMzOSIgcng9IjQiLz48cmVjdCB4PSI4IiB5PSIyNSIgd2lkdGg9IjQ4IiBoZWlnaHQ9IjYwIiBmaWxsPSIjRkZGRkZGIiByeD0iMiIvPjxyZWN0IHg9IjgiIHk9IjEyIiB3aWR0aD0iNDgiIGhlaWdodD0iMTIiIGZpbGw9IiNmZmYiIHJ4PSI0Ii8+PC9zdmc+';
                }
                // NEW: FALLBACK MEJA BUKU (Meja Kayu + Buku Biru)
                /* REVISI: Menambahkan 'mejabelajar' ke kondisi fallback agar tetap aman */
                else if (src.includes('mejabuku') || src.includes('mejabelajar')) {
                    this.src = 'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI2NCIgaGVpZ2h0PSIzMiI+PHJlY3QgeD0iMiIgeT0iOCIgd2lkdGg9IjYwIiBoZWlnaHQ9IjIwIiBmaWxsPSIjOEU1NDJCIiBzdHJva2U9IiM1RDQwMzciIHN0cm9rZS13aWR0aD0iMiIvPjxyZWN0IHg9IjIwIiB5PSI0IiB3aWR0aD0iMjQiIGhlaWdodD0iMTYiIGZpbGw9IiMzYjgyZjYiIHN0cm9rZT0iIzFkNGVkOCIgc3Ryb2tlLXdpZHRoPSIxIi8+PHBhdGggZD0iTTI2IDQgTDI2IDIwIiBzdHJva2U9IndoaXRlIi8+PC9zdmc+';
                }
                // NEW: FALLBACK MEJA TELPON (Meja Kayu + Telpon Merah)
                else if (src.includes('mejatelpon') || src.includes('telpon')) {
                    this.src = 'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIzMiIgaGVpZ2h0PSIzMiI+PHJlY3QgeD0iNCIgeT0iMTIiIHdpZHRoPSIyNCIgaGVpZ2h0PSIyMCIgZmlsbD0iIzhFNTQyQiIgc3Ryb2tlPSIjNUQ0MDM3Ii8+PHJlY3QgeD0iMTAiIHk9IjQiIHdpZHRoPSIxMiIgaGVpZ2h0PSI4IiBmaWxsPSIjZWY0NDQ0Ii8+PC9zdmc+';
                }
                // NEW: FALLBACK MEJA KASUR (Meja Kayu + Mesin Kasir Abu-abu)
                else if (src.includes('mejakasir')) {
                    this.src = 'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIzMiIgaGVpZ2h0PSIzMiI+PHJlY3QgeD0iMiIgeT0iMTIiIHdpZHRoPSIyOCIgaGVpZ2h0PSIxNiIgZmlsbD0iIzhCNEMzOSIgc3Ryb2tlPSIjNUQ0MDM3IiBzdHJva2Utd2lkdGg9IjIiLz48cmVjdCB4PSI4IiB5PSI2IiB3aWR0aD0iMTYiIGhlaWdodD0iMTAiIGZpbGw9IiM5NDkzOTgiIHN0cm9rZT0iIzMzNDE1NSIvPjxyZWN0IHg9IjEyIiB5PSI4IiB3aWR0aD0iOCIgaGVpZ2h0PSIyIiBmaWxsPSIjMWU0MDVmIi8+PC9zdmc+';
                }
                // NEW: FALLBACK ORANG SAWAH (Stick Figure Sederhana)
                else if (src.includes('orangsawah')) {
                    this.src = 'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIzMiIgaGVpZ2h0PSIzMiI+PGxpbmUgeDE9IjE2IiB5MT0iNCIgeDI9IjE2IiB5Mj0iMzIiIHN0cm9rZT0iIzhCNEMzOSIgc3Ryb2tlLXdpZHRoPSIyIi8+PGxpbmUgeDE9IjgiIHkxPSIxMiIgeDI9IjI0IiB5Mj0iMTIiIHN0cm9rZT0iIzhCNEMzOSIgc3Ryb2tlLXdpZHRoPSIyIi8+PGNpcmNsZSBjeD0iMTYiIGN5PSI4IiByPSI0IiBmaWxsPSIjZmZjMTA3Ii8+PC9zdmc+';
                }
                // NEW: FALLBACK TUNGKU (Kotak Batu dengan Api)
                else if (src.includes('tungku')) {
                    this.src = 'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI2NCIgaGVpZ2h0PSI2NCI+PHJlY3QgeD0iNCIgeT0iNCIgd2lkdGg9IjU2IiBoZWlnaHQ9IjU2IiBmaWxsPSIjNDQ0MDNjIiBzdHJva2U9IiM1ZDQwMzciIHN0cm9rZS13aWR0aD0iNCIvPjxyZWN0IHg9IjE2IiB5PSIzMiIgd2lkdGg9IjMyIiBoZWlnaHQ9IjIwIiBmaWxsPSIjMWUxZTFlIi8+PHBhdGggZD0iTTI0IDQ4IEwzMiAzMiBMNDAgNDgiIGZpbGw9IiNlZjQ0NDQiLz48cGF0aCBkPSJNMjggNDggTDM2IDQwIEw0NCA0OCIgZmlsbD0iI2Y1OWUwYiIgb3BhY2l0eT0iMC44Ii8+PC9zdmc+';
                }
                // NEW: FALLBACK PARON (Anvil)
                else if (src.includes('paron')) {
                    this.src = 'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIzMiIgaGVpZ2h0PSIzMiI+PHBhdGggZD0iTTIgMTAgTDMwIDEwIEwyOCAxNCBMMjAgMTYgTDIwIDI2IEwyOCAyNiBMMjggMzAgTDQgMzAgTDQgMjYgTDEyIDI2IEwxMiAxNiBMNCAxMiBaIiBmaWxsPSIjNzg5MDljIiBzdHJva2U9IiMzMzMiIHN0cm9rZS13aWR0aD0iMiIvPjwvc3ZnPg==';
                }
                // NEW: FALLBACK RAK SENJATA
                else if (src.includes('raksenjata') || src.includes('raksenajata')) {
                    this.src = 'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI2NCIgaGVpZ2h0PSI2NCI+PHJlY3QgeD0iNCIgeT0iNCIgd2lkdGg9IjU2IiBoZWlnaHQ9IjU2IiBmaWxsPSJub25lIiBzdHJva2U9IiM1ZDQwMzciIHN0cm9rZS13aWR0aD0iNCIvPjxsaW5lIHgxPSIxMCIgeTE9IjIwIiB4Mj0iNTQiIHkyPSIyMCIgc3Ryb2tlPSIjOTRhM2I4IiBzdHJva2Utd2lkdGg9IjQiLz48bGluZSB4MT0iMTAiIHkxPSI0MCIgeDI9IjU0IiB5Mj0iNDAiIHN0cm9rZT0iIzk0YTNiOCIgc3Ryb2tlLXdpZHRoPSI0Ii8+PHBhdGggZD0iTTIwIDE1IEwyMCA0NSBNNDQgMTUgTDQ0IDQ1IiBzdHJva2U9IiM1ZDQwMzciIHN0cm9rZS13aWR0aD0iMiIvPjwvc3ZnPg==';
                }
                // NEW: FALLBACK MEJA JAHIT
                else if (src.includes('mejajahit')) {
                    this.src = 'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI2NCIgaGVpZ2h0PSI2NCI+PHJlY3QgeD0iNCIgeT0iMTIiIHdpZHRoPSI1NiIgaGVpZ2h0PSI0MCIgZmlsbD0iIzhCNEMzOSIgc3Ryb2tlPSIjNUQ0MDM3IiBzdHJva2Utd2lkdGg9IjIiLz48cmVjdCB4PSIxMCIgeT0iOCIgd2lkdGg9IjEyIiBoZWlnaHQ9IjgiIGZpbGw9IiM5NDkzOTgiLz48cGF0aCBkPSJNMzAgMjAgTDUwIDIwIEw0MCA0MCBaIiBmaWxsPSIjZTkxZTYzIiBvcGFjaXR5PSIwLjgiLz48Y2lyY2xlIGN4PSI1MCIgY3k9IjE1IiByPSIzIiBmaWxsPSIjZmZmIi8+PC9zdmc+';
                }
                // NEW: FALLBACK BIJIH BESI
                else if (src.includes('bijihbesi')) {
                    this.src = 'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIzMiIgaGVpZ2h0PSIzMiI+PHBhdGggZD0iTTE2IDI0IEw4IDE2IEwxNiA4IEwyNCAxNiBaIiBmaWxsPSIjNzU3NTc1IiBzdHJva2U9IiM0MjQyNDIiIHN0cm9rZS13aWR0aD0iMiIvPjxwYXRoIGQ9Ik02IDI0IEwxMCAyOCBMMTggMjggTDIyIDI0IiBmaWxsPSIjNzU3NTc1IiBzdHJva2U9IiM0MjQyNDIiIHN0cm9rZS13aWR0aD0iMiIvPjwvc3ZnPg==';
                }
                // NEW: FALLBACK KAYU BAKAR
                else if (src.includes('kayubakar')) {
                    this.src = 'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIzMiIgaGVpZ2h0PSIzMiI+PGNpcmNsZSBjeD0iMTAiIGN5PSIyMCIgcj0iNiIgZmlsbD0iIzVENDAzNyIgc3Ryb2tlPSIjM2UyNzIzIiBzdHJva2Utd2lkdGg9IjIiLz48Y2lyY2xlIGN4PSIyMiIgY3k9IjIwIiByPSI2IiBmaWxsPSIjNUQ0MDM3IiBzdHJva2U9IiMzZTI3MjMiIHN0cm9rZS13aWR0aD0iMiIvPjxjaXJjbGUgY3g9IjE2IiBjeT0iMTIigcj0iNiIgZmlsbD0iIzVENDAzNyIgc3Ryb2tlPSIjM2UyNzIzIiBzdHJva2Utd2lkdGg9IjIiLz48L3N2Zz4=';
                }
                // NEW: FALLBACK LEMARI (Wardrobe tall box)
                else if (src.includes('lemari')) {
                    this.src = 'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI2NCIgaGVpZ2h0PSI5NiI+PHJlY3QgeD0iNCIgeT0iMiIgd2lkdGg9IjU2IiBoZWlnaHQ9IjkyIiBmaWxsPSIjOEU1NDJCIiBzdHJva2U9IiM1RDQwMzciIHN0cm9rZS13aWR0aD0iMiIvPjxyZWN0IHg9IjgiIHk9IjYiIHdpZHRoPSIyMiIgaGVpZ2h0PSI4NCIgZmlsbD0iIzhCNEMzOSIgc3Ryb2tlPSIjNUQ0MDM3Ii8+PHJlY3QgeD0iMzQiIHk9IjYiIHdpZHRoPSIyMiIgaGVpZ2h0PSI4NCIgZmlsbD0iIzhCNEMzOSIgc3Ryb2tlPSIjNUQ0MDM3Ii8+PGNpcmNsZSBjeD0iMjYiIGN5PSI1MCIgcj0iMiIgZmlsbD0iI2ZmZiIvPjxjaXJjbGUgY3g9IjM4IiBjeT0iNTAiIHI9IjIiIGZpbGw9IiNmZmYiLz48L3N2Zz4=';
                }
                // NEW: FALLBACK VAS MERAH
                else if (src.includes('vasmerah')) {
                    this.src = 'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIzMiIgaGVpZ2h0PSIzMiI+PHBhdGggZD0iTTEwIDI0IEwxMCAxMiBDMTAgNiAyMiA2IDIyIDEyIEwyMiAyNCBDMjIgMzAgMTAgMzAgMTAgMjQgWiIgZmlsbD0iI2VmNDQ0NCIgc3Ryb2tlPSIjYjkxYzFjIiBzdHJva2Utd2lkdGg9IjIiLz48ZWxsaXBzZSBjeD0iMTYiIGN5PSI4IiByeD0iNCIgcnk9IjIiIGZpbGw9IiNmZmYiLz48L3N2Zz4=';
                }
                // NEW: FALLBACK JARING IKAN
                else if (src.includes('jaringikan')) {
                    this.src = 'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI5NiIgaGVpZ2h0PSI2NCI+PHBhdGggZD0iTTAgMCBMOTYgNjQgTTk2IDAgTTAgNjQgTTQ8IDAgTDQ4IDY0IE0wIDMyIEw5NiAzMiBNMjQgMCBMMjQgNjQgTTcyIDAgTDcyIDY0IE0wIDE2IEw5NiAxNiBNMCA0OCBMOTYgNDgiIHN0cm9rZT0iI2EzYTNhMyIgc3Ryb2tlLXdpZHRoPSIxIi8+PC9zdmc+';
                }
                // NEW: FALLBACK RAK PANCING
                else if (src.includes('rakpancing')) {
                    this.src = 'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIzMiIgaGVpZ2h0PSIzMiI+PHJlY3QgeD0iMiIgeT0iMiIgd2lkdGg9IjI4IiBoZWlnaHQ9IjI4IiBmaWxsPSIjOEU1NDJiIiBzdHJva2U9IiM1RDQwMzciIHN0cm9rZS13aWR0aD0iMiIvPjxsaW5lIHgxPSI2IiB5MT0iMjgiIHgyPSIyNiIgeTI9IjQiIHN0cm9rZT0iIzU1NSIgc3Ryb2tlLXdpZHRoPSIyIi8+PGxpbmUgeDE9IjEwIiB5MT0iMjgiIHgyPSIyOCIgeTI9IjEwIiBzdHJva2U9IiM1NTUiIHN0cm9rZS13aWR0aD0iMiIvPjxsaW5lIHgxPSIyIiB5MT0iMjgiIHgyPSIyMiIgeTI9IjgiIHN0cm9rZT0iIzU1NSIgc3Ryb2tlLXdpZHRoPSIyIi8+PC9zdmc+';
                }
                // NEW: FALLBACK EMBER IKAN
                else if (src.includes('emberikan')) {
                    this.src = 'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIzMiIgaGVpZ2h0PSIzMiI+PHBhdGggZD0iTTYgMTAgTDggMjggTDI0IDI4IEwyNiAxMCBaIiBmaWxsPSIjOTBBNEFFIiBzdHJva2U9IiM1NTUiIHN0cm9rZS13aWR0aD0iMiIvPjxwYXRoIGQ9Ik02IDEwIFExNiAyIDI2IDEwIiBzdHJva2U9IiM1NTUiIHN0cm9rZS13aWR0aD0iMiIgZmlsbD0ibm9uZSIvPjxwYXRoIGQ9Ik0xMCA4IEw4IDQgTDEyIDQgWiIgZmlsbD0iIzY0QjVGNiIvPjxwYXRoIGQ9Ik0yMiA4IEwyMCA0IEwyNCA0IFoiIGZpbGw9IiM2NEI1RjYiLz48L3N2Zz4=';
                }
                // NEW: FALLBACK BOXES (Kotak Biru/Coolbox)
                else if (src.includes('boxes')) {
                    this.src = 'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIzMiIgaGVpZ2h0PSIzMiI+PHJlY3QgeD0iMiIgeT0iOCIgd2lkdGg9IjI4IiBoZWlnaHQ9IjIyIiBmaWxsPSIjNjRiNWY2IiBzdHJva2U9IiMzMzQxNTUiIHN0cm9rZS13aWR0aD0iMiIvPjxsaW5lIHgxPSIyIiB5MT0iMTQiIHgyPSIzMCIgeTI9IjE0IiBzdHJva2U9IiMzMzQxNTUiIHN0cm9rZS13aWR0aD0iMiIvPjwvc3ZnPg==';
                }
                // NEW: FALLBACK KASUR NELAYAN
                else if (src.includes('kasurnelayan')) {
                    this.src = 'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI2NCIgaGVpZ2h0PSI5NiI+PHJlY3QgeD0iNCIgeT0iMTAiIHdpZHRoPSI1NiIgaGVpZ2h0PSI4MCIgZmlsbD0iIzVENEAzNyIgcng9IjQiLz48cmVjdCB4PSI4IiB5PSIyNSIgd2lkdGg9IjQ4IiBoZWlnaHQ9IjYwIiBmaWxsPSIjZjRmNmY4IiByeD0iMiIvPjxyZWN0IHg9IjgiIHk9IjEyIiB3aWR0aD0iNDgiIGhlaWdodD0iMTIiIGZpbGw9IiNjYmQ1ZTEiIHJ4PSI0Ii8+PC9zdmc+';
                }
                // NEW: FALLBACK RAK PIALA IKAN
                else if (src.includes('rakpialaikan')) {
                    this.src = 'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIzMiIgaGVpZ2h0PSIzMiIgdmlld0JveD0iMCAwIDMyIDMyIj48cGF0aCBkPSJNNiA2IEwyNiA2IEwyNCAxNiBDMjQgMjAgMjAgMjIgMTYgMjIgQzEyIDIyIDggMjAgOCAxNiBMNiA2IFoiIGZpbGw9IiNGRkQ3MDAiIHN0cm9rZT0iI0I4ODYwQiIgc3Ryb2tlLXdpZHRoPSIyIi8+PHJlY3QgeD0iMTQiIHk9IjIyIiB3aWR0aD0iNCIgaGVpZ2h0PSI2IiBmaWxsPSIjQjg4NjBCIi8+PHJlY3QgeD0iMTAiIHk9IjI4IiB3aWR0aD0iMTIiIGhlaWdodD0iNCIgZmlsbD0iIzhCNDUxMyIvPjxjaXJjbGUgY3g9IjI2IiBjeT0iMTAiIHI9IjMiIGZpbGw9Im5vbmUiIHN0cm9rZT0iI0ZGRDcwMCIgc3Ryb2tlLXdpZHRoPSIyIi8+PGNpcmNsZSBjeD0iNiIgY3k9IjEwIiByPSIzIiBmaWxsPSJub25lIiBzdHJva2U9IiNGRkQ3MDAiIHN0cm9rZS13aWR0aD0iMiIvPjwvc3ZnPg==';
                }
                // NEW: FALLBACK MEJA MAKAN IKAN
                else if (src.includes('mejamakanikan')) {
                    this.src = 'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIzMiIgaGVpZ2h0PSIzMiI+PHJlY3QgeD0iMiIgeT0iMTAiIHdpZHRoPSIyOCIgaGVpZ2h0PSIxNCIgZmlsbD0iI0EwNTIyRCIgc3Ryb2tlPSIjNUQ0MDM3IiBzdHJva2Utd2lkdGg9IjIiLz48cmVjdCB4PSI0IiB5PSIyNCIgd2lkdGg9IjQiIGhlaWdodD0iNiIgZmlsbD0iI0EwNTIyRCIvPjxyZWN0IHg9IjI0IiB5PSIyNCIgd2lkdGg9IjQiIGhlaWdodD0iNiIgZmlsbD0iI0EwNTIyRCIvPjxlbGxpcHNlIGN4PSIxNiIgY3k9IjE2IiByeD0iOCIgcnk9IjMiIGZpbGw9IiNGRkYiLz48cGF0aCBkPSJNMTIgMTYgTDIwIDE2IiBzdHJva2U9IiMwMDAiIHN0cm9rZS13aWR0aD0iMSIvPjwvc3ZnPg==';
                }
                // NEW: FALLBACK ARSIP REKAM MEDIS (Laci Besi Abu-abu)
                else if (src.includes('arsiprekammedis')) {
                    this.src = 'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIzMiIgaGVpZ2h0PSIzMiI+PHJlY3QgeD0iNCIgeT0iMiIgd2lkdGg9IjI4IiBoZWlnaHQ9IjI4IiBmaWxsPSIjOTRhM2I4IiBzdHJva2U9IiM0NzU1NjkiIHN0cm9rZS13aWR0aD0iMiIvPjxyZWN0IHg9IjYiIHk9IjYiIHdpZHRoPSIyMCIgaGVpZ2h0PSI2IiBmaWxsPSIjYzFjN2Q2IiBzdHJva2U9IiM2NDc0OGIiIHN0cm9rZS13aWR0aD0iMSIvPjxyZWN0IHg9IjYiIHk9IjE0IiB3aWR0aD0iMjAiIGhlaWdodD0iNiIgZmlsbD0iI2MxYzdkNiIgc3Ryb2tlPSIjNjQ3NDhiIiBzdHJva2Utd2lkdGg9IjEiLz48cmVjdCB4PSI2IiB5PSIyMiIgd2lkdGg9IjIwIiBoZWlnaHQ9IjYiIGZpbGw9IiNjMWM3ZDYiIHN0cm9rZT0iIzY0NzQ4YiIgc3Ryb2tlLXdpZHRoPSIxIi8+PGxpbmUgeDE9IjE0IiB5MT0iOSIgeDI9IjE4IiB5Mj0iOSIgc3Ryb2tlPSIjMzM0MTU1IiBzdHJva2Utd2lkdGg9IjIiLz48bGluZSB4MT0iMTQiIHkxPSIxNyIgeDI9IjE4IiB5Mj0iMTciIHN0cm9rZT0iIzMzNDE1NSIgc3Ryb2tlLXdpZHRoPSIyIi8+PGxpbmUgeDE9IjE0IiB5MT0iMjUiIHgyPSIxOCIgeTI9IjI1IiBzdHJva2U9IiMzMzQxNTUiIHN0cm9rZS13aWR0aD0iMiIvPjwvc3ZnPg==';
                }
                // NEW: FALLBACK KEBUN AYU (Taman Bunga)
                else if (src.includes('kebunayu')) {
                    this.src = 'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxMjgiIGhlaWdodD0iOTYiPjxyZWN0IHg9IjQiIHk9IjQiIHdpZHRoPSIxMjAiIGhlaWdodD0iODgiIGZpbGw9IiM1ZDQwMzciIHN0cm9rZT0iIzNjMjQxNSIgc3Ryb2tlLXdpZHRoPSI0Ii8+PGNpcmNsZSBjeD0iMzAiIGN5PSIzMCIgcj0iMTAiIGZpbGw9IiNlOTFlNjMiLz48Y2lyY2xlIGN4PSI2NCIgY3k9IjMwIiByPSIxMCIgZmlsbD0iI2Y1OWUwYiIvPjxjaXJjbGUgY3g9Ijk4IiBjeT0iMzAiIHI9IjEwIiBmaWxsPSIjM2I4MmY2Ii8+PGNpcmNsZSBjeD0iMzAiIGN5PSI2NCIgcj0iMTAiIGZpbGw9IiNmZmViM2IiLz48Y2lyY2xlIGN4PSI2NCIgY3k9IjY0IiByPSIxMCIgZmlsbD0iI2U5MWU2MyIvPjxjaXJjbGUgY3g9Ijk4IiBjeT0iNjQiIHI9IjEwIiBmaWxsPSIjZjU5ZTBiIi8+PC9zdmc+';
                }
                // NEW: FALLBACK PIALA MENTOR (Piala Emas Besar)
                else if (src.includes('pialamentor')) {
                    this.src = 'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIzMiIgaGVpZ2h0PSIzMiIgdmlld0JveD0iMCAwIDMyIDMyIj48cGF0aCBkPSJNOCA2IEwyNCA2IEwyMiAxNiBDMjIgMjAgMTggMjIgMTYgMjIgQzE0IDIyIDEwIDIwIDEwIDE2IEw4IDYgWiIgZmlsbD0iI0ZGRDcwMCIgc3Ryb2tlPSIjQjg4NjBCIiBzdHJva2Utd2lkdGg9IjIiLz48cmVjdCB4PSIxNCIgeT0iMjIiIHdpZHRoPSI0IiBoZWlnaHQ9IjYiIGZpbGw9IiNCODg2MEIiLz48cmVjdCB4PSI4IiB5PSIyOCIgd2lkdGg9IjE2IiBoZWlnaHQ9IjQiIGZpbGw9IiM4QjQ1MTMiLz48Y2lyY2xlIGN4PSIyNCIgY3k9IjEwIiByPSI0IiBmaWxsPSJub25lIiBzdHJva2U9IiNGRkQ3MDAiIHN0cm9rZS13aWR0aD0iMiIvPjxjaXJjbGUgY3g9IjgiIGN5PSIxMCIgcj0iNCIgZmlsbD0ibm9uZSIgc3Ryb2tlPSIjRkZDNzAwIiBzdHJva2Utd2lkdGg9IjIiLz48cGF0aCBkPSJNMTYgMTAgTDE2IDE2IiBzdHJva2U9IiNCODg2MEIiIG9wYWNpdHk9IjAuMyIvPjwvc3ZnPg==';
                }
                // NEW: FALLBACK VAS MENTOR (Vas Biru Elegan)
                else if (src.includes('vasmentor')) {
                    this.src = 'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIzMiIgaGVpZ2h0PSIzMiI+PHBhdGggZD0iTTEwIDI0IEwxMCAxMiBDMTAgNiAyMiA2IDIyIDEyIEwyMiAyNCBDMjIgMzAgMTAgMzAgMTAgMjQgWiIgZmlsbD0iIzNiODJmNiIgc3Ryb2tlPSIjMWQ0ZWQ4IiBzdHJva2Utd2lkdGg9IjIiLz48ZWxsaXBzZSBjeD0iMTYiIGN5PSI4IiByeD0iNCIgcnk9IjIiIGZpbGw9IiNmZmYiLz48L3N2Zz4=';
                }
                // NEW: FALLBACK TUMPUKAN KERTAS (Tumpukan Dokumen Putih)
                else if (src.includes('tumpukankertas')) {
                    this.src = 'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIzMiIgaGVpZ2h0PSIzMiI+PHJlY3QgeD0iNCIgeT0iMTIiIHdpZHRoPSIyNCIgaGVpZ2h0PSIyMCIgZmlsbD0iI2ZmZiIgc3Ryb2tlPSIjY2JkNWUxIiBzdHJva2Utd2lkdGg9IjEiLz48bGluZSB4MT0iOCIgeTE9IjE2IiB4Mj0iMjQiIHkyPSIxNiIgc3Ryb2tlPSIjMDAwIi8+PGxpbmUgeDE9IjgiIHkxPSIyMCIgeDI9IjI0IiB5Mj0iMjAiIHN0cm9rZT0iIzAwMCIvPjwvc3ZnPg==';
                }
                // NEW: FALLBACK FOTO MENTOR (Bingkai Foto Kayu)
                else if (src.includes('fotomentor')) {
                    this.src = 'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIzMiIgaGVpZ2h0PSIzMiI+PHJlY3QgeD0iMiIgeT0iNCIgd2lkdGg9IjI4IiBoZWlnaHQ9IjI0IiBmaWxsPSIjOEU1NDJCIiBzdHJva2U9IiM1RDQwMzciIHN0cm9rZS13aWR0aD0iMiIvPjxyZWN0IHg9IjYiIHk9IjgiIHdpZHRoPSIyMCIgaGVpZ2h0PSIxNiIgZmlsbD0iI2ZmZiIvPjxjaXJjbGUgY3g9IjE2IiBjeT0iMTYiIHI9IjQiIGZpbGw9IiM5NDkzOTgiLz48L3N2Zz4=';
                }
                // Fallback: RAK BUKU (Gambar Rak dengan Buku Warna-warni) - UPDATE: Tambahkan fallback untuk lemariobat dan rakmentor
                else if (src.includes('rakbuku') || src.includes('lemariobat') || src.includes('rakmentor')) {
                    this.src = 'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIzMiIgaGVpZ2h0PSIzMiI+PHJlY3QgeD0iMiIgeT0iMiIgd2lkdGg9IjI4IiBoZWlnaHQ9IjI4IiBmaWxsPSIjOEU1NDJiIiBzdHJva2U9IiM1RDQwMzciIHN0cm9rZS13aWR0aD0iMiIvPjxyZWN0IHg9IjUiIHk9IjYiIHdpZHRoPSI0IiBoZWlnaHQ9IjIwIiBmaWxsPSIjZWY0NDQ0Ii8+PHJlY3QgeD0iMTAiIHk9IjYiIHdpZHRoPSI0IiBoZWlnaHQ9IjIwIiBmaWxsPSIjM2I4MmY2Ii8+PHJlY3QgeD0iMTUiIHk9IjYiIHdpZHRoPSI0IiBoZWlnaHQ9IjIwIiBmaWxsPSIjMTBiOTgxIi8+PHJlY3QgeD0iMjAiIHk9IjYiIHdpZHRoPSI0IiBoZWlnaHQ9IjIwIiBmaWxsPSIjZTkxZTYzIi8+PC9zdmc+';
                }
                // Fallback: PAPAN TULIS (Hijau/Hitam dengan Bingkai)
                else if (src.includes('papan')) {
                    this.src = 'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI2NCIgaGVpZ2h0PSIzMiI+PHJlY3QgeD0iMiIgeT0iMiIgd2lkdGg9IjYwIiBoZWlnaHQ9IjI4IiBmaWxsPSIjMDY0ZTNGIiBzdHJva2U9IiM4YTUwMjUiIHN0cm9rZS13aWR0aD0iNCIvPjx0ZXh0IHg9IjMyIiB5PSIyMCIgZm9udC1mYW1pbHk9Im1vbm9zcGFjZSIgZm9udC1zaXplPSIxMCIgZmlsbD0id2hpdGUiIHRleHQtYW5jaG9yPSJtaWRkbGUiPjEyMzwvdGV4dD48L3N2Zz4=';
                }
                // Fallback: KURSI (Bentuk Kursi Kayu)
                else if (src.includes('kursi')) {
                    this.src = 'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIzMiIgaGVpZ2h0PSIzMiI+PHBhdGggZD0iTTEwIDIwIEwxMCAxMCBMMjIgMTAgTDIyIDIwIEwyMiAyOCBMMjAgMjggTDIwIDIyIEwxMiAyMiBMMTIgMjggTDEwIDI4IFoiIGZpbGw9IiM4YTUwMjUiIHN0cm9rZT0iIzU5MzUxMSIgc3Ryb2tlLXdpZHRoPSIyIi8+PC9zdmc+';
                }
                // Fallback: MEJA DOSEN (Meja Guru), MEJA DOKTER, ATAU MEJA MENTOR
                else if (src.includes('mejadosen') || src.includes('mejadokter') || src.includes('mejamentor')) {
                    this.src = 'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIzMiIgaGVpZ2h0PSIzMiI+PHJlY3QgeD0iMiIgeT0iMTIiIHdpZHRoPSIyOCIgaGVpZ2h0PSIxMiIgZmlsbD0iIzVENDAzNyIgc3Ryb2tlPSIjM2UyNzIzIiBzdHJva2Utd2lkdGg9IjIiLz48cmVjdCB4PSI0IiB5PSIyNCIgd2lkdGg9IjQiIGhlaWdodD0iNCIgZmlsbD0iIzVENDAzNyIvPjxyZWN0IHg9IjI0IiB5PSIyNCIgd2lkdGg9IjQiIGhlaWdodD0iNCIgZmlsbD0iIzVENDAzNyIvPjwvc3ZnPg==';
                }
                // Fallback: MEJA MODIN (Meja Akad dengan Taplak Putih)
                else if (src.includes('mejamodin')) {
                    this.src = 'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIzMiIgaGVpZ2h0PSIzMiI+PHJlY3QgeD0iMiIgeT0iMTIiIHdpZHRoPSIyOCIgaGVpZ2h0PSIxMiIgZmlsbD0iIzVENDAzNyIgc3Ryb2tlPSIjM2UyNzIzIiBzdHJva2Utd2lkdGg9IjIiLz48cmVjdCB4PSI0IiB5PSIyNCIgd2lkdGg9IjQiIGhlaWdodD0iNCIgZmlsbD0iIzVENDAzNyIvPjxyZWN0IHg9IjI0IiB5PSIyNCIgd2lkdGg9IjQiIGhlaWdodD0iNCIgZmlsbD0iIzVENDAzNyIvPjxyZWN0IHg9IjgiIHk9IjgiIHdpZHRoPSIxNiIgaGVpZ2h0PSI0IiBmaWxsPSIjRkZGRkZGIiBvcGFjaXR5PSIwLjkiLz48L3N2Zz4=';
                }
                // NEW: FALLBACK ALTAR (Gerbang/Dekorasi Bunga)
                else if (src.includes('altar')) {
                    this.src = 'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI5NiIgaGVpZ2h0PSI2NCI+PHJlY3QgeD0iMTAiIHk9IjEwIiB3aWR0aD0iNzYiIGhlaWdodD0iNTQiIGZpbGw9Im5vbmUiIHN0cm9rZT0iI0Q0QUYzNyIgc3Ryb2tlLXdpZHRoPSI0Ii8+PHBhdGggZD0iTTEwIDEwIFEgNDggLTIwIDg2IDEwIiBmaWxsPSJub25lIiBzdHJva2U9IiNENEFGMzciIHN0cm9rZS13aWR0aD0iNCIvPjxjaXJjbGUgY3g9IjEwIiBjeT0iMTAiIHI9IjYiIGZpbGw9IiNmMjhiODIiLz48Y2lyY2xlIGN4PSI4NiIgY3k9IjEwIiByPSI2IiBmaWxsPSIjZjI4YjgyIi8+PHJlY3QgeD0iMjAiIHk9IjIwIiB3aWR0aD0iNTYiIGhlaWdodD0iNDQiIGZpbGw9IiNmZmYiIG9wYWNpdHk9IjAuMyIvPjwvc3ZnPg==';
                }
                // Fallback Umum (Box Kayu)
                else {
                    this.src = 'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIzMiIgaGVpZ2h0PSIzMiI+PHJlY3QgeD0iMiIgeT0iMiIgd2lkdGg9IjI4IiBoZWlnaHQ9IjI4IiBmaWxsPSIjOEU1NDJiIiBzdHJva2U9IiM1RDQwMzciIHN0cm9rZS13aWR0aD0iMiIvPjxsaW5lIHgxPSIyIiB5MT0iMiIgeDI9IjMwIiB5Mj0iMzAiIHN0cm9rZT0iIzVENDAzNyIgc3Ryb2tlLXdpZHRoPSIyIi8+PGxpbmUgeDE9IjMwIiB5MT0iMiIgeDI9IjIiIHkyPSIzMCIgc3Ryb2tlPSIjNUQ0MDM3IiBzdHJva2Utd2lkdGg9IjIiLz48L3N2Zz4=';
                }
            };
        }
        
        if (o.loadedImg.complete && o.loadedImg.naturalWidth !== 0) {
            // Gambar object sesuai ukuran custom (w/h)
            const drawW = (o.w || 1) * TILE_SIZE;
            const drawH = (o.h || 1) * TILE_SIZE;
            ctx.drawImage(o.loadedImg, o.x*TILE_SIZE, o.y*TILE_SIZE, drawW, drawH);
        } else {
            // Fallback Text Icon jika gambar benar-benar gagal
            ctx.font = '20px Arial';
            ctx.fillStyle = '#fff';
            ctx.fillText(o.icon, o.x*TILE_SIZE+5, o.y*TILE_SIZE+25);
        }
    } else {
        // Default Icon Rendering
        ctx.font = '20px Arial';
        ctx.fillStyle = '#fff'; // Pastikan warna terlihat
        ctx.fillText(o.icon, o.x*TILE_SIZE+5, o.y*TILE_SIZE+25);
    }

    // --- NEW: IDENTITAS MAILBOX MELAYANG (Agar Player Tahu Ini Pos) ---
    if(o.type === 'mailbox') {
        const centerX = (o.x * TILE_SIZE) + (TILE_SIZE / 2);
        const topY = (o.y * TILE_SIZE) - 15; // Di atas objek
        
        // Animasi Melayang (Slow Bobbing)
        const floatOffset = Math.sin(Date.now() / 500) * 3;

        ctx.save();
        ctx.font = '16px Arial';
        ctx.textAlign = 'center';
        ctx.shadowColor = 'rgba(0,0,0,0.8)';
        ctx.shadowBlur = 4;
        
        // Gambar Amplop Putih
        ctx.fillText('', centerX, topY + floatOffset);
        
        // Label Kecil "POS" (Opsional, agar lebih jelas)
        ctx.font = 'bold 8px "Exo 2"';
        ctx.fillStyle = '#fbbf24'; // Emas
        ctx.fillText("POS", centerX, topY + floatOffset + 8);
        
        ctx.restore();
    }

    // --- NEW: INDIKATOR PESAN BELUM DIBACA (KHUSUS MAILBOX) ---
    if(o.type === 'mailbox') {
        const msgs = STATE.player.messages || [];
        const unreadCount = msgs.filter(m => !m.read).length;
        
        if(unreadCount > 0) {
            // Gambar Notifikasi Merah Melayang (Lebih tinggi sedikit agar tidak menumpuk ikon amplop)
            const bx = (o.x * TILE_SIZE) + (TILE_SIZE/2) + 10; // Geser ke kanan sedikit
            const by = (o.y * TILE_SIZE) - 25; // Lebih ke atas
            
            const floatY = Math.sin(Date.now() / 200) * 3; // Animasi lebih cepat (urgensi)
            
            ctx.fillStyle = '#ef4444'; // Merah
            ctx.beginPath();
            ctx.arc(bx, by + floatY, 7, 0, Math.PI*2);
            ctx.fill();
            
            // Border Putih
            ctx.strokeStyle = '#fff';
            ctx.lineWidth = 1.5;
            ctx.stroke();
            
            ctx.fillStyle = '#fff';
            ctx.font = 'bold 10px Arial';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            // Tampilkan jumlah pesan jika > 1, jika tidak tanda seru
            const badgeText = unreadCount > 9 ? '9+' : (unreadCount > 1 ? unreadCount : '!');
            ctx.fillText(badgeText, bx, by + floatY + 1);
        }
    }
}

function drawBuilding(ctx, b) {
    if (b.type === 'trigger') {
        // Trigger invisible, but usually draws entrance circle below
    } else {
        let src = b.img;
        
        if(b.id === 'player_house') {
            // UPDATE: Jika Role Entrepreneur, ganti gambar rumah jadi Toko Player
            if (STATE.player.role === 'entrepreneur') {
                src = 'images/tokoplayer.png';
            } else {
                src = `images/houselevel${STATE.player.houseLevel}.png`;
            }
        }
        if(b.id === 'merchant' && STATE.player.role === 'entrepreneur') {
            // src = 'images/tokoplayer.png'; // REMOVED: Jangan ubah Merchant NPC
        }
        // PERBAIKAN: Handle Gambar Batu Dungeon
        if(b.type === 'dungeon_rock') {
            // Gunakan aset khusus rock (batudidungeon.png)
            if(dungeonAssets.rock.complete && dungeonAssets.rock.naturalWidth !== 0) {
                // Gambar batu sebagai objek
                ctx.drawImage(dungeonAssets.rock, b.x * TILE_SIZE, b.y * TILE_SIZE, TILE_SIZE, TILE_SIZE);
            } else {
                // Fallback jika gambar belum load (Coba pakai wall dulu atau bentuk bulat)
                if(dungeonAssets.wall.complete && dungeonAssets.wall.naturalWidth !== 0) {
                     ctx.drawImage(dungeonAssets.wall, b.x * TILE_SIZE, b.y * TILE_SIZE, TILE_SIZE, TILE_SIZE);
                } else {
                    ctx.fillStyle = '#1e293b'; 
                    ctx.beginPath(); ctx.arc(b.x*TILE_SIZE + 15, b.y*TILE_SIZE + 15, 12, 0, Math.PI*2); ctx.fill();
                }
            }
            return; // Selesai gambar batu, skip sisanya
        }

        // --- [FIX] LOGIKA UPDATE GAMBAR DINAMIS ---
        // Cek: Jika belum ada loadedImg ATAU src-nya sudah berubah (misal habis upgrade rumah)
        // Maka load ulang gambar baru
        if(!b.loadedImg || (b.loadedImg.src && !b.loadedImg.src.includes(src))) {
            b.loadedImg = new Image();
            b.loadedImg.src = src;
            b.loadedImg.onerror = function() { this.error = true; };
        }

        if(b.loadedImg.complete && !b.loadedImg.error && b.loadedImg.naturalWidth !== 0) {
                ctx.drawImage(b.loadedImg, b.x * TILE_SIZE, b.y * TILE_SIZE, b.w * TILE_SIZE, b.h * TILE_SIZE);
        } else {
            ctx.fillStyle = b.id === 'player_house' ? '#d97706' : '#475569';
            ctx.fillRect(b.x * TILE_SIZE, b.y * TILE_SIZE, b.w * TILE_SIZE, b.h * TILE_SIZE);
            ctx.fillStyle = '#fff';
            ctx.font = '10px Arial';
            ctx.fillText(b.name || "Building", b.x*TILE_SIZE, b.y*TILE_SIZE + 20);
        }
    }
	
	 // --- NEW: EFEK SALJU MENEMPEL DI ATAP BANGUNAN ---
    if (STATE.season === 'winter' && STATE.location === 'village' && b.type !== 'trigger' && b.type !== 'dungeon_rock') {
        ctx.save();
        ctx.fillStyle = 'rgba(255, 255, 255, 0.8)'; // Warna Salju Transparan
        
        // Buat bentuk tumpukan salju di atas atap
        const bx = b.x * TILE_SIZE;
        const by = b.y * TILE_SIZE;
        const bw = b.w * TILE_SIZE;
        
        // Gambar Ellipse pipih di bagian atas bangunan (Atap)
        ctx.beginPath();
        // Pusat di tengah atas bangunan
        ctx.ellipse(bx + bw/2, by + 10, bw/2 - 5, 10, 0, 0, Math.PI * 2);
        ctx.fill();
        
        // Tambahkan tetesan es (Icicles) kecil
        ctx.fillStyle = 'rgba(200, 230, 255, 0.9)';
        for(let i=0; i<b.w; i++) {
            if (i % 2 === 0) { // Selang seling
                ctx.fillRect(bx + (i * TILE_SIZE) + 10, by + 15, 4, 8 + Math.random()*5);
            }
        }
        
        ctx.restore();
    }
    // --------------------------------------------------

    if(b.entrance) {
        const ex = b.entrance.x * TILE_SIZE;
        const ey = b.entrance.y * TILE_SIZE;
        const pulse = Math.abs(Math.sin(Date.now() / 300));
        
        // UPDATE: Warna indikator berbeda untuk Exit vs Enter
        const isExit = b.id.includes('exit') || b.id.includes('out') || (b.name && b.name.toLowerCase().includes('keluar'));
        
        // Orange untuk Masuk, Merah/Putih untuk Keluar
        let indColor = b.id === 'player_house' ? `rgba(251, 191, 36, ${pulse})` : `rgba(6, 182, 212, ${pulse})`;
        if(isExit) indColor = `rgba(239, 68, 68, ${pulse})`;
        
        // NEW: Warna Ungu untuk Portal Next Level
        if(b.id === 'dungeon_next') indColor = `rgba(147, 51, 234, ${pulse})`; // Purple

        ctx.fillStyle = indColor;
        ctx.beginPath();
        ctx.arc(ex + 15, ey + 15, 10, 0, Math.PI*2);
        ctx.fill();
        
        ctx.strokeStyle = '#fff';
        ctx.lineWidth = 1;
        ctx.beginPath();
        ctx.arc(ex + 15, ey + 15, 10 + (pulse*5), 0, Math.PI*2);
        ctx.stroke();

        ctx.font = 'bold 8px "Exo 2"';
        ctx.fillStyle = '#fff';
        ctx.textAlign = 'center';
        
        // UPDATE: Teks otomatis berubah jadi KELUAR jika ID/Nama mengandung kata kunci exit/keluar
        let label = isExit ? "KELUAR" : "MASUK";
        if(b.id === 'dungeon_next') label = "NEXT LVL"; // Label khusus
        if(b.id === 'papan_misi') label = "LIHAT"; // Label khusus Papan
        
        ctx.fillText(label, ex + 15, ey - 5);
    }

    // --- NEW: LABEL BANGUNAN PREMIUM (PILL STYLE) ---
    if (b.name && b.type !== 'trigger' && b.type !== 'dungeon_rock') {
        ctx.save();
        
        const bx = b.x * TILE_SIZE;
        const by = b.y * TILE_SIZE;
        const bw = b.w * TILE_SIZE;
        
        // Cek Status Buka/Tutup
        let isClosed = false;
        let isRenovating = false;

        if (b.entrance && b.entrance.map && !maps[b.entrance.map]) {
            isRenovating = true;
        } else if (b.openTime && b.closeTime && !b.open24h) {
            if (STATE.time < b.openTime || STATE.time >= b.closeTime) {
                isClosed = true;
            }
        }

        // --- KONFIGURASI STYLE ---
        let labelText = b.name.toUpperCase();
        let bgColor = 'rgba(15, 23, 42, 0.9)'; // Default: Dark Slate (Modis)
        let borderColor = 'rgba(148, 163, 184, 0.8)'; // Border Abu-abu
        let textColor = '#f8fafc'; // Putih
        let icon = '';

        // Style Khusus Bangunan Utama (Emas)
        if (b.roleSpecific || b.id === 'player_house') {
            bgColor = 'rgba(66, 32, 6, 0.95)'; // Coklat Tua
            borderColor = '#fbbf24'; // Emas
            textColor = '#fffbeb'; 
        }

        // Style Khusus Status
        if (isRenovating) {
            bgColor = 'rgba(113, 63, 18, 0.95)'; // Kuning Tua
            borderColor = '#fcd34d'; 
            icon = ' ';
        } else if (isClosed) {
            bgColor = 'rgba(127, 29, 29, 0.95)'; // Merah Tua
            borderColor = '#ef4444'; 
            icon = ' ';
        } else {
            // Ikon Bangunan Saat Buka
            if(b.id.includes('merchant')) icon = ' ';
            else if(b.id.includes('clinic')) icon = ' ';
            else if(b.id.includes('school')) icon = ' ';
            else if(b.id.includes('guild')) icon = ' ';
            else if(b.id.includes('blacksmith')) icon = ' ';
            else if(b.id.includes('library')) icon = ' ';
            else if(b.id.includes('wedding')) icon = ' '; // Sudah ada
            else if(b.id.includes('port')) icon = ' ';
        }

        const fullText = icon + labelText;

        // Hitung Ukuran Label
        ctx.font = 'bold 9px "Exo 2", sans-serif'; // Ukuran font pas
        const textMetrics = ctx.measureText(fullText);
        const textWidth = textMetrics.width;
        
        const paddingX = 8;
        const paddingY = 4;
        const pillW = textWidth + (paddingX * 2);
        const pillH = 18; // Tinggi label
        
        // Posisi Label (Tengah bangunan, melayang di atas atap)
        const pillX = bx + (bw / 2) - (pillW / 2);
        const pillY = by - 28; // Jarak float dari atap

        // --- DRAW SHADOW (Efek Melayang) ---
        ctx.shadowColor = 'rgba(0,0,0,0.6)';
        ctx.shadowBlur = 6;
        ctx.shadowOffsetY = 3;

        // --- DRAW PILL BACKGROUND (Rounded Rect) ---
        ctx.fillStyle = bgColor;
        ctx.beginPath();
        const r = 5; // Radius sudut
        ctx.moveTo(pillX + r, pillY);
        ctx.lineTo(pillX + pillW - r, pillY);
        ctx.quadraticCurveTo(pillX + pillW, pillY, pillX + pillW, pillY + r);
        ctx.lineTo(pillX + pillW, pillY + pillH - r);
        ctx.quadraticCurveTo(pillX + pillW, pillY + pillH, pillX + pillW - r, pillY + pillH);
        ctx.lineTo(pillX + r, pillY + pillH);
        ctx.quadraticCurveTo(pillX, pillY + pillH, pillX, pillY + pillH - r);
        ctx.lineTo(pillX, pillY + r);
        ctx.quadraticCurveTo(pillX, pillY, pillX + r, pillY);
        ctx.fill();

        // --- DRAW BORDER ---
        ctx.shadowBlur = 0; // Hilangkan shadow untuk border agar tajam
        ctx.shadowOffsetY = 0;
        ctx.strokeStyle = borderColor;
        ctx.lineWidth = 1.5;
        ctx.stroke();

        // --- DRAW TEXT ---
        ctx.fillStyle = textColor;
        ctx.textAlign = 'center';
        ctx.textBaseline = 'middle';
        // Gambar teks di tengah pill
        ctx.fillText(fullText, pillX + (pillW / 2), pillY + (pillH / 2));

        // --- DRAW ARROW/POINTER KE BAWAH (Segitiga kecil) ---
        ctx.fillStyle = bgColor;
        ctx.beginPath();
        ctx.moveTo(pillX + (pillW/2) - 4, pillY + pillH);
        ctx.lineTo(pillX + (pillW/2) + 4, pillY + pillH);
        ctx.lineTo(pillX + (pillW/2), pillY + pillH + 4);
        ctx.fill();
        
        // Border segitiga (opsional, agar nyatu)
        ctx.strokeStyle = borderColor;
        ctx.lineWidth = 1;
        ctx.beginPath();
        ctx.moveTo(pillX + (pillW/2) - 4, pillY + pillH);
        ctx.lineTo(pillX + (pillW/2), pillY + pillH + 4);
        ctx.lineTo(pillX + (pillW/2) + 4, pillY + pillH);
        ctx.stroke();

        ctx.restore();
    }
}

function drawPlayer(ctx, p) {
    // --- NEW: VISUAL SHIELD EFEK (TONIC KEBAL) ---
    if(p.invincible) {
        ctx.save();
        const pulse = 1 + Math.sin(Date.now() / 100) * 0.1;
        ctx.translate(p.x + p.w/2, p.y + p.h/2);
        ctx.scale(pulse, pulse);
        
        ctx.strokeStyle = '#60a5fa'; // Cyan/Blue Shield
        ctx.lineWidth = 2;
        ctx.beginPath();
        ctx.arc(0, 0, 25, 0, Math.PI*2);
        ctx.stroke();
        
        ctx.fillStyle = 'rgba(96, 165, 250, 0.2)';
        ctx.fill();
        ctx.restore();
    }

    // [MOVED] Indikator Keringat dipindah ke bawah setelah sprite digambar

    ctx.fillStyle = 'rgba(0,0,0,0.4)';
    ctx.beginPath(); 
    ctx.ellipse(p.x + 10, p.y + 28, 10, 4, 0, 0, Math.PI*2); 
    ctx.fill();

    let sprite = p.spriteIdle;
    
    // FIX: Mengganti touchState (yang tidak ada) menjadi inputState.active
    let isMoving = keys['ArrowUp'] || keys['ArrowDown'] || keys['ArrowLeft'] || keys['ArrowRight'] || 
                   keys['KeyW'] || keys['KeyS'] || keys['KeyA'] || keys['KeyD'] ||
                   inputState.active; // Gunakan inputState dari touch controls
                   
    // UPDATE: Prioritas Sprite (Attack > Walk > Idle)
    if (p.isAttacking && p.spriteAttack) {
        sprite = p.spriteAttack;
    } else if(isMoving) {
        if (p.direction === 'up' && p.spriteWalkUp) {
            sprite = p.spriteWalkUp;
        } 
        else if (p.direction === 'down' && p.spriteWalkDown) {
            sprite = p.spriteWalkDown;
        } else {
            sprite = p.spriteWalk;
        }
    }

    if(sprite && sprite.complete && sprite.naturalWidth !== 0) {
        ctx.save();
        ctx.translate(p.x + p.w/2, p.y + p.h/2);
        
        // --- NEW: DAMAGE BLINK EFFECT (HURT ANIMATION) ---
        // Jika sedang sakit (hurtTimer > 0), buat efek berkedip merah
        if (p.hurtTimer > 0) {
            p.hurtTimer--; // Kurangi timer setiap frame
            
            // Efek guncangan pada sprite
            const shakeSprite = (Math.random() - 0.5) * 4;
            ctx.translate(shakeSprite, 0);

            // Efek Tint Merah (Composite Operation)
            // Kita gambar sprite normal dulu, lalu tumpuk warna merah di atasnya
            // Menggunakan globalAlpha untuk kedip
            if (Math.floor(Date.now() / 50) % 2 === 0) {
                ctx.globalAlpha = 0.7; // Sedikit transparan
                // Note: Efek merah murni agak berat di performa canvas standard, 
                // jadi kita pakai filter sederhana atau opacity + shake sudah cukup terasa.
                // Jika browser support filter:
                ctx.filter = 'sepia(1) hue-rotate(-50deg) saturate(5)'; // Merah pekat
            }
        }

        if(!isMoving && !p.isAttacking) {
            // UPDATE: Efek bernapas diperhalus (0.03 -> 0.015) agar tidak terlihat naik-turun drastis
            const breathe = 1 + Math.sin(Date.now() / 300) * 0.015; 
            ctx.scale(1, breathe);
        }

        if(p.direction === 'left') ctx.scale(-1, 1); 
        
        if (p.isAttacking) {
            ctx.drawImage(sprite, -32, -49, 64, 64); 
        } else {
            // UPDATE: UKURAN PLAYER DISESUAIKAN KE 38x58 (Sesuai Request)
            // Posisi X digeser -19 (setengah dari 38)
            // Posisi Y digeser -46 agar kaki tetap menapak pas di bayangan (y+12 dari titik tengah)
            ctx.drawImage(sprite, -19, -46, 38, 58); 
        }
        
        ctx.restore();
    } else {
        // ... fallback rendering ...
        ctx.fillStyle = p.color || '#fbbf24';
        if (p.hurtTimer > 0) ctx.fillStyle = '#ef4444'; // Merah jika sakit (fallback)
        ctx.fillRect(p.x, p.y, 20, 20);
        // ...
    }

    // --- UPDATE: VISUAL INDIKATOR STAMINA RENDAH (KERINGAT KECIL DI KEPALA) ---
    // Dipindah ke sini agar digambar DI DEPAN player
    if(p.energy <= 25) {
        ctx.save();
        // Animasi naik turun (bobbing)
        const sweatBob = Math.sin(Date.now() / 200) * 2;
        
        // Posisi relatif terhadap kepala (berdasarkan offset sprite visual)
        // Sprite digambar di y-45 dari tengah, jadi kepala ada di sekitar y-35 dari tengah logic
        // Kita taruh di dahi sebelah kanan
        const headX = p.x + (p.w/2) + 8; // Sedikit di kanan tengah wajah
        const headY = p.y + (p.h/2) - 38 + sweatBob; // Area dahi atas
        
        ctx.translate(headX, headY);
        
        ctx.fillStyle = '#38bdf8'; // Biru Muda (Air)
        
        // Gambar Tetesan Keringat Vector Kecil (Manual Path)
        ctx.beginPath();
        ctx.arc(0, 0, 2.5, 0, Math.PI * 2); // Bulatan bawah (r=2.5)
        ctx.moveTo(-2.5, -1);
        ctx.lineTo(0, -6); // Lancip atas (seperti tetesan air jatuh)
        ctx.lineTo(2.5, -1);
        ctx.fill();
        
        ctx.restore();
    }

    // --- NEW: HP BAR DI ATAS KEPALA (PREMIUM STYLE) ---
    // UPDATE: SEKARANG MUNCUL DI SEMUA LOKASI (TERMASUK DUNGEON)
    // Menghapus syarat 'if (STATE.location !== 'dungeon')' agar bar melayang selalu muncul
    {
        // Posisi sedikit lebih tinggi dari kepala sprite (y-55)
        const barW = 36;
        const barH = 5;
        const barX = p.x + 10 - barW/2;
        const barY = p.y - 55; 

        const hpPct = Math.max(0, p.hp / p.maxHp);
        
        // Warna Dinamis (Hijau -> Kuning -> Merah)
        let colTop, colBot;
        if (hpPct > 0.5) { colTop = '#4ade80'; colBot = '#15803d'; } // Hijau Sehat
        else if (hpPct > 0.25) { colTop = '#facc15'; colBot = '#a16207'; } // Kuning Waspada
        else { colTop = '#ef4444'; colBot = '#7f1d1d'; } // Merah Bahaya

        ctx.save();
        
        // 1. Shadow Background (Hitam semi-transparan untuk outline)
        ctx.fillStyle = 'rgba(0, 0, 0, 0.8)';
        // Gambar background sedikit lebih besar dari bar (+1px border effect)
        ctx.fillRect(barX - 1, barY - 1, barW + 2, barH + 2);
        
        // 2. Bar Kosong (Abu gelap)
        ctx.fillStyle = '#334155';
        ctx.fillRect(barX, barY, barW, barH);

        if (hpPct > 0) {
            // 3. Gradient Fill
            const grad = ctx.createLinearGradient(barX, barY, barX, barY + barH);
            grad.addColorStop(0, colTop);
            grad.addColorStop(1, colBot);
            
            ctx.fillStyle = grad;
            const fillW = Math.max(0, barW * hpPct);
            ctx.fillRect(barX, barY, fillW, barH);
            
            // 4. Efek Shine (Kilap di separuh atas)
            ctx.fillStyle = 'rgba(255,255,255,0.25)';
            ctx.fillRect(barX, barY, fillW, barH/2);
        }
        
        // 5. Border Halus
        ctx.strokeStyle = 'rgba(255,255,255,0.1)';
        ctx.lineWidth = 1;
        ctx.strokeRect(barX - 0.5, barY - 0.5, barW + 1, barH + 1);

        ctx.restore();
    }

    // --- UPDATE: MARKER SEGITIGA (Lebih Tinggi Lagi menyesuaikan Bar baru) ---
    // Marker digeser ke y-68 agar aman di atas HP Bar
    const floatY = Math.sin(Date.now() / 150) * 5;
    ctx.fillStyle = '#fbbf24'; 
    ctx.beginPath();
    ctx.moveTo(p.x + 10, p.y - 68 + floatY); // Ujung Bawah
    ctx.lineTo(p.x + 5, p.y - 78 + floatY);  // Kiri Atas
    ctx.lineTo(p.x + 15, p.y - 78 + floatY); // Kanan Atas
    ctx.fill();
    
    // Shadow/Glow Marker
    ctx.shadowColor = '#fbbf24';
    ctx.shadowBlur = 10;
    ctx.fill();
    ctx.shadowBlur = 0; 
    
    if(p.isAttacking) {
        ctx.save();
        ctx.translate(p.x+10, p.y+10);
        ctx.rotate(p.direction==='left'?-1.5:1.5);
        ctx.strokeStyle = '#fff'; ctx.lineWidth = 2;
        ctx.beginPath(); ctx.arc(0, 0, 25, -0.5, 0.5); ctx.stroke();
        ctx.restore();
    }
}

// --- NEW FUNCTION: DRAW GHOST (PEMAIN LAIN) ---
function drawGhost(ctx, g) {
    // 1. Setup Visual Hantu (Transparan)
    ctx.save();
    ctx.globalAlpha = 0.6; // Setengah transparan
    
    // Tentukan Posisi
    // (Data hantu x,y adalah koordinat murni, kita perlu sesuaikan pivot)
    const gx = g.x;
    const gy = g.y;
    
    // 2. Gambar Sprite (Sesuai Gender & Outfit)
    // Kita gunakan aset yang sudah diload di memori browser
    let spriteSrc = `images/${g.gender}-idle.png`; // Default
    
    // Cek Outfit (Sederhana)
    if (g.outfit === 'wedding') spriteSrc = `images/${g.gender}-idle-weding.png`;
    else if (g.outfit === 'armor') spriteSrc = `images/${g.gender}-idle-armor.png`;
    
    // Karena kita tidak bisa load image sync di sini, kita coba buat Image object baru
    // Browser biasanya mengambil dari cache jika sudah pernah diload player
    const img = new Image();
    img.src = spriteSrc;
    
    if (img.complete && img.naturalWidth !== 0) {
        // Gambar sprite
        // Ukuran disamakan dengan player (38x58)
        // Offset disesuaikan (-19, -46) dari titik kaki
        ctx.drawImage(img, gx, gy - 46, 38, 58);
    } else {
        // Fallback jika gambar belum siap: Kotak Putih Hantu
        ctx.fillStyle = '#ffffff';
        ctx.fillRect(gx, gy - 20, 20, 20);
    }

    // 3. Gambar Nama (Nametag)
    ctx.globalAlpha = 0.8; // Nama lebih jelas dikit
    ctx.font = 'bold 10px "Exo 2"';
    ctx.textAlign = 'center';
    
    // Background nama
    const textW = ctx.measureText(g.name).width;
    ctx.fillStyle = 'rgba(0, 0, 0, 0.5)';
    ctx.fillRect(gx + 10 - (textW/2) - 2, gy - 60, textW + 4, 12);
    
    // Teks Nama
    ctx.fillStyle = '#38bdf8'; // Biru Cyan
    ctx.fillText(g.name, gx + 10, gy - 51);

    // 4. Gambar Role (Opsional, kecil di bawah nama)
    /*
    ctx.font = '8px Arial';
    ctx.fillStyle = '#cbd5e1';
    ctx.fillText(`<${g.role.toUpperCase()}>`, gx + 10, gy - 40);
    */

    ctx.restore();
}


// --- FIX: MENAMBAHKAN FUNGSI DRAW NPC YANG HILANG ---
function drawNPC(ctx, n) {
    // 1. Cek Apakah NPC Aktif (Sesuai Jadwal/Syarat)
    // Jika tidak aktif, jangan gambar apapun
    if (!isNPCActive(n)) return;

    const x = n.x * TILE_SIZE;
    const y = n.y * TILE_SIZE;

    // UPDATE: Gunakan ukuran Custom jika ada, default 32x48
    const dw = n.w || 32;
    const dh = n.h || 48;

    // 2. Gambar Bayangan (Dinamis mengikuti ukuran)
    // Bayangan tetap di tanah (y asli) meskipun NPC melayang
    ctx.fillStyle = 'rgba(0,0,0,0.3)';
    ctx.beginPath();
    ctx.ellipse(x + dw/2, y + dh - 5, dw/3, 4, 0, 0, Math.PI * 2);
    ctx.fill();

    // --- NEW: LOGIKA MELAYANG (FLOATING) KHUSUS DEWI RORO ---
    let visualY = y;
    if (n.id === 'dewi_roro') {
        // Animasi Sinusoidal: Naik turun 10px, periode 1 detik
        const floatOffset = Math.sin(Date.now() / 500) * 10 - 15; // -15 biar agak tinggi dari tanah
        visualY = y + floatOffset;
    }

    // 3. Load & Gambar Sprite NPC
    if (!n.loadedImg) {
        n.loadedImg = new Image();
        n.loadedImg.src = n.imgSrc;
        
        // --- NEW: FALLBACK GAMBAR NPC JIKA GAGAL LOAD ---
        n.loadedImg.onerror = function() {
            this.onerror = null; // Prevent loop
            // Fallback spesifik
            if (n.id.includes('kaia')) this.src = 'images/girl-idle.png'; // Fallback Kaia ke Girl
            else if (n.id.includes('child')) this.src = 'images/boy-idle.png'; // Fallback Anak ke Boy
            else if (n.id.includes('lover1girl')) this.src = 'images/girl.png';
            else this.src = 'images/boy.png'; // Default umum
            console.warn(`Fallback image loaded for NPC: ${n.name}`);
        };
    }

    if (n.loadedImg.complete && n.loadedImg.naturalWidth !== 0) {
        ctx.save();
        
        // --- NEW: EFEK CAHAYA BULAN (KHUSUS DEWI ARSA) ---
        if (n.id === 'dewi_arsa') {
            // A. Aura Lingkaran Bercahaya (Gradient)
            const cx = x + dw/2;
            const cy = visualY + dh/2; // Gunakan visualY
            const pulse = 1 + Math.sin(Date.now() / 600) * 0.15; // Denyut cahaya pelan
            
            // Gradient: Putih Terang -> Kuning Pucat -> Transparan
            const grad = ctx.createRadialGradient(cx, cy, 15, cx, cy, 55 * pulse);
            grad.addColorStop(0, 'rgba(255, 255, 255, 0.6)'); 
            grad.addColorStop(0.5, 'rgba(254, 240, 138, 0.25)'); // Kuning rembulan
            grad.addColorStop(1, 'rgba(255, 255, 255, 0)');
            
            ctx.fillStyle = grad;
            ctx.beginPath();
            ctx.arc(cx, cy, 60, 0, Math.PI*2);
            ctx.fill();

            // B. Efek Kilauan Bintang (Sparkles)
            // Muncul acak di sekitar area tubuh
            if(Math.random() < 0.3) { // 30% chance per frame render
                 ctx.fillStyle = '#fff';
                 // Random posisi di sekitar NPC
                 const sx = x + (Math.random() * dw * 1.5) - (dw * 0.25);
                 const sy = visualY + (Math.random() * dh * 1.2) - (dh * 0.1);
                 
                 // Gambar bintang kecil (Cross shape)
                 const size = Math.random() * 3;
                 ctx.fillRect(sx, sy, size, 1);
                 ctx.fillRect(sx + (size/2) - 0.5, sy - (size/2) + 0.5, 1, size);
            }
            
            // C. Glow pada Sprite Karakter
            ctx.shadowColor = '#fef08a'; // Kuning Muda Bercahaya
            ctx.shadowBlur = 25;
        }

        // --- NEW: EFEK CAHAYA BUNGA & SPIRIT (KHUSUS DEWI RORO) ---
        if (n.id === 'dewi_roro') {
            // A. Aura Suci (Pink & Putih Lembut)
            const cx = x + dw/2;
            const cy = visualY + dh/2; // Aura mengikuti posisi melayang
            const pulse = 1 + Math.sin(Date.now() / 400) * 0.1; // Denyut lebih cepat
            
            const grad = ctx.createRadialGradient(cx, cy, 20, cx, cy, 50 * pulse);
            grad.addColorStop(0, 'rgba(255, 255, 255, 0.5)'); 
            grad.addColorStop(0.6, 'rgba(244, 114, 182, 0.3)'); // Pink lembut
            grad.addColorStop(1, 'rgba(255, 255, 255, 0)');
            
            ctx.fillStyle = grad;
            ctx.beginPath();
            ctx.arc(cx, cy, 55, 0, Math.PI*2);
            ctx.fill();

            // B. Spawn Partikel Bunga & Spirit Melayang
            if(Math.random() < 0.2) { // 20% chance per frame
                 // Random: Kadang bunga (Note Icon), Kadang Spirit Orb (Lingkaran)
                 const pType = Math.random() < 0.3 ? 'note' : 'spirit_aura'; 
                 
                 STATE.particles.push({
                    x: cx + (Math.random() * 50 - 25),
                    y: cy + (Math.random() * 60 - 20),
                    vx: (Math.random() - 0.5) * 0.3, // Goyang horizontal pelan
                    vy: -0.5 - Math.random(), // Naik ke atas
                    life: 80,
                    color: pType === 'note' ? '#fbcfe8' : '#ffffff', // Bunga Pink atau Spirit Putih
                    type: pType,
                    icon: '', // Icon Bunga jika type note
                    size: pType === 'note' ? 10 : (2 + Math.random() * 3) // Ukuran Orb
                });
            }

            // C. Glow Pink pada Karakter
            ctx.shadowColor = '#f9a8d4'; // Pink Glow
            ctx.shadowBlur = 20;
        }

        // --- NEW: RENDER IKON HATI DI ATAS KEPALA PASANGAN (JIKA MENIKAH) ---
        if (STATE.player.married && STATE.player.spouseId === n.id) {
            ctx.save();
            const floatY = Math.sin(Date.now() / 400) * 3; // Animasi naik turun halus
            
            ctx.font = '16px Arial';
            ctx.textAlign = 'center';
            ctx.shadowColor = 'rgba(255,255,255,0.8)';
            ctx.shadowBlur = 5;
            
            // Gambar Hati di atas kepala (y - 20 dari posisi kaki - tinggi sprite)
            // Tinggi sprite rata-rata ~50px
            ctx.fillText('', x + dw/2, visualY - dh + 10 + floatY);
            
            ctx.restore();
        }

        // UPDATE: Logika Animasi (Static vs Moving)
        // Semua NPC Darat (Static, Wander, Animal) sekarang menggunakan efek BERNAFAS yang sama
        if (n.type !== 'swimmer') {
            // Efek Bernapas: Scale Y berubah sedikit (1.0 hingga 1.02) agar terlihat hidup
            const breathe = 1 + Math.sin(Date.now() / 300) * 0.02; 
            
            // Set Pivot ke Kaki Tengah agar tumbuh ke atas (menapak tanah)
            // Posisi Y dikurangi 5 (Offset Shadow)
            // FIX: Gunakan Math.round() untuk menghindari posisi desimal (patah-patah)
            // UPDATE: Menggunakan visualY untuk efek melayang
            ctx.translate(Math.round(x + dw/2), Math.round(visualY + dh - 5)); 
            ctx.scale(1, breathe);
            
            // Cek Arah Gerak untuk Flip Horizontal
            if (n.vx < 0) {
                ctx.scale(-1, 1); // Hadap Kiri
            }
            
            // Gambar Image (Offset negatif karena pivot ada di bawah tengah)
            ctx.drawImage(n.loadedImg, -dw/2, -dh, dw, dh);
        } 
        else {
            // Khusus NPC Perenang (Swimmer): Tetap mengapung (bobbing) di air
            const animY = Math.sin(Date.now() / 300) * 2; 
            
            const drawY = y - 5 + animY;
            
            if (n.vx < 0) {
                ctx.translate(x + dw, drawY); 
                ctx.scale(-1, 1);
                ctx.drawImage(n.loadedImg, 0, 0, dw, dh); 
            } else {
                ctx.drawImage(n.loadedImg, x, drawY, dw, dh);
            }
        }
        
        ctx.restore();
    } else {
        // Fallback: Kotak Warna jika gambar belum load
        ctx.fillStyle = '#fca5a5';
        ctx.fillRect(x + 5, y, dw - 10, dh - 10);
    }

    // 4. Nama NPC & Indikator Quest
    /* UPDATE: LABEL NAMA NPC DIHILANGKAN SESUAI REQUEST (CUKUP BANGUNAN SAJA) */
    /*
    ctx.font = 'bold 8px "Exo 2"';
    ctx.textAlign = 'center';
    
    // Stroke Hitam untuk nama agar terbaca
    ctx.strokeStyle = 'black';
    ctx.lineWidth = 2;
    ctx.strokeText(n.name, x + dw/2, y - 8);
    
    ctx.fillStyle = '#fff';
    ctx.fillText(n.name, x + dw/2, y - 8);
    */

    // Indikator Quest/Interaksi (Tanda Seru) jika dekat
    // Opsional: Bisa ditambahkan logika jarak jika ingin
}

// --- FIX: MENAMBAHKAN FUNGSI DRAW ENEMY YANG HILANG (INI PENYEBAB MONSTER INVISIBLE) ---
function drawEnemy(ctx, e) {
    // 1. Gambar Bayangan
    ctx.fillStyle = 'rgba(0,0,0,0.4)';
    ctx.beginPath();
    ctx.ellipse(e.x + e.w/2, e.y + e.h - 2, e.w/2 - 5, 5, 0, 0, Math.PI*2);
    ctx.fill();

    // 2. Efek Hit Flash (Kedip saat dipukul)
    if (e.hp < e.maxHp && Math.random() < 0.1) {
        ctx.globalAlpha = 0.7; // Transparan sebentar
    }

    // 3. Tentukan Gambar Monster (Berdasarkan Tier/Boss)
    let img = null;
    
    // Cek apakah monster punya key gambar spesifik (enemy1, enemy2, dst)
    if (e.imgKey && dungeonAssets[e.imgKey]) {
        img = dungeonAssets[e.imgKey];
    } 
    // Fallback untuk Boss
    else if (e.isBoss) {
        img = dungeonAssets.boss;
    } 
    // Fallback default
    else {
        img = dungeonAssets.enemy1; 
    }

    if (img && img.complete && img.naturalWidth !== 0) {
        ctx.save();
        
        // Efek Bernapas/Wobble Monster (Agar terlihat hidup)
        const wobble = Math.sin(Date.now() / 150 + e.animOffset) * 0.05;
        const scaleX = 1 + wobble;
        const scaleY = 1 - wobble;

        // Pivot di tengah monster
        const cx = e.x + e.w/2;
        const cy = e.y + e.h/2;

        ctx.translate(cx, cy);
        // Flip jika musuh bergerak ke kiri (mengejar player di kiri)
        // Hitung arah berdasarkan posisi player relative
        if (STATE.player.x < e.x) ctx.scale(-scaleX, scaleY);
        else ctx.scale(scaleX, scaleY);
        
        // Gambar sprite
        // Pastikan drawImage menggunakan ukuran e.w dan e.h
        ctx.drawImage(img, -e.w/2, -e.h/2, e.w, e.h);
        
        ctx.restore();
    } else {
        // Fallback: Kotak Merah jika gambar gagal load
        ctx.fillStyle = e.color || '#ef4444';
        ctx.fillRect(e.x, e.y, e.w, e.h);
    }

    ctx.globalAlpha = 1.0; // Reset Alpha

    // 4. HP Bar Monster
    const hpPct = Math.max(0, e.hp / e.maxHp);
    const barW = e.w;
    const barH = 4;
    
    // Background Bar
    ctx.fillStyle = '#000';
    ctx.fillRect(e.x, e.y - 10, barW, barH);
    
    // Fill Bar
    ctx.fillStyle = e.isBoss ? '#b91c1c' : '#fbbf24'; // Merah tua utk Boss, Kuning utk Kroco
    ctx.fillRect(e.x, e.y - 10, barW * hpPct, barH);
}

// --- NEW FUNCTION: RENDER INVENTORY (DENGAN ACTION KLIK) ---
function renderInventory() {
    const grid = document.getElementById('inventory-grid');
    grid.innerHTML = '';
    
    const inv = STATE.player.inventory || {};
    let hasItem = false;

    // DATABASE ITEM UPDATE: Tambahkan Item Dungeon & Legendary & Consumables
    const ITEM_DB = {
        // --- NEW: ITEM IJAZAH SARJANA ---
        'ijazah_teknologi': { name: 'Ijazah S.Kom', icon: '', desc: 'Bukti kelulusan Sarjana Teknologi.', img: 'images/ijazah-teknologi.png' },
        'ijazah_sejarah': { name: 'Ijazah S.Hum', icon: '', desc: 'Bukti kelulusan Sarjana Sejarah.', img: 'images/ijazah-sejarah.png' },
        
        // --- NEW: ITEM SERTIFIKAT PEKERJA ---
        'sertifikat_manajer': { name: 'Sertifikat Profesi', icon: '', desc: 'Sertifikat Kompetensi Manajer Profesional (BNSP).', img: 'images/sertifikat-manajer.png' },
		// --- [FIX] BIBIT RAFFLESIA (AGAR BISA DITANAM) ---
        'bibit_rafflesia': { 
            name: 'Bibit Rafflesia', 
            icon: '', 
            type: 'consumable', 
            action: 'plant_rafflesia', // <--- PENTING: Aksi menanam
            desc: 'Bibit bunga legendaris. Tanam di ladang.',
            img: 'images/biji.png' 
        },
		// --- NEW: BUNGA RAFFLESIA ARNOLDI (HASIL PANEN) ---
        'bunga_rafflesia': { 
            name: 'Rafflesia Arnoldi', 
            icon: '', 
            desc: 'Pusaka Alam Legendaris. Hasil panen yang sangat mahal.', 
            img: 'images/rafflesia.png' 
        },


        // --- UPDATE: IKAN-IKAN BARU ---
        'ikan_kecil': { name: 'Ikan Kecil', img: 'images/ikankecil.png', type: 'consumable', action: 'eat_fish_small', desc: 'Makan: +10 Energi. Ikan mungil biasa.' },
        'ikan_sedang': { name: 'Ikan Sedang', img: 'images/ikansedang.png', type: 'consumable', action: 'eat_fish_medium', desc: 'Makan: +25 Energi. Lumayan mengenyangkan.' },
        'ikan_besar': { name: 'Ikan Besar', img: 'images/ikanbesar.png', type: 'consumable', action: 'eat_fish_large', desc: 'Makan: +50 Energi. Ikan tangkapan mantap!' },
        'ikan_legendary': { name: 'Ikan Legendaris', img: 'images/ikanlegendary.png', type: 'consumable', action: 'eat_fish_legend', desc: 'Makan: FULL Energi. Sangat langka & mahal!' },

        // Komoditas & Makanan (Sekarang Bisa Dimakan!)
        'ikan_segar': { name: 'Ikan Bakar', icon: '', type: 'consumable', action: 'eat_fish', desc: 'Makan: Energi +15' }, // Legacy item
        'gandum': { name: 'Roti Gandum', icon: '', type: 'consumable', action: 'eat_bread', desc: 'Makan: Energi +20' },
        'coklat': { name: 'Coklat Bar', icon: '', type: 'consumable', action: 'eat_choco', desc: 'Ngemil: Energi +10' },
        
        'kain': { name: 'Kain Sutra', icon: '', desc: 'Bahan tekstil halus.' },
        'bunga': { name: 'Bunga', icon: '', desc: 'Hadiah romantis.' },
        
        // Item Dungeon (Tiered)
        'besi': { name: 'Bijih Besi', icon: '', desc: 'Material dasar (Rare).' },
        'permata': { name: 'Berlian', icon: '', desc: 'Batu mulia (Epic).' },
        'scroll_exp': { name: 'Gulungan Kuno', icon: '', desc: 'Berisi ilmu kuno (+EXP).' },
        
        // Legendary Boss Drops
        'zirah_legend': { name: 'Zirah Abadi', icon: '', desc: 'Armor Legendaris (Pasif: Def++).' },
        'cincin_legend': { name: 'Cincin Raja', icon: '', desc: 'Cincin Legendaris (Pasif: Gold++).' },
        
        // NEW: ITEM BIBIT PERTANIAN (UPDATE: DIBUAT CONSUMABLE)
        'bibit_padi': { name: 'Bibit Padi', icon: '', type: 'consumable', action: 'plant_padi', desc: 'Tanam di lahan. Panen jadi Gabah/Beras.' },
        'bibit_jagung': { name: 'Bibit Jagung', icon: '', type: 'consumable', action: 'plant_jagung', desc: 'Bibit jagung manis unggulan.' },
        'bibit_tomat': { name: 'Bibit Tomat', icon: '', type: 'consumable', action: 'plant_tomat', desc: 'Cepat tumbuh dan segar.' },
        'pupuk': { name: 'Pupuk', icon: '', type: 'consumable', action: 'use_pupuk', desc: 'Mempercepat pertumbuhan tanaman.' },

        // NEW: ITEM CINCIN KAYU (ROLE FAMILY)
        'cincin_kayu': { name: 'Cincin Kayu', icon: '', desc: 'Cincin sederhana untuk melamar pasangan.' },
        // NEW: ITEM PAKAIAN NIKAH (ROLE FAMILY)
        'pakaian_nikah': { name: 'Baju Pengantin', icon: '', desc: 'Busana sakral untuk akad nikah.' },

        // Consumables (Bisa Dipakai)
        'tonic_stamina': { name: 'Tonic Stamina', icon: '', type: 'consumable', action: 'useStamina', desc: 'Pulihkan 100% Energi.' },
        'tonic_kebal': { name: 'Tonic Kebal', icon: '', type: 'consumable', action: 'useImmune', desc: 'Kebal serangan 10 detik.' },
        
        // Quest Items (Gambar Dinamis via Logic di bawah)
        'draft_proposal': { name: 'Draft Skripsi', icon: '', desc: 'Bahan proposal (Quest Tahun 3).' },
        'buku_tesis': { name: 'Buku Tesis', icon: '', desc: 'Syarat kelulusan.' }
    };

    for (let key in inv) {
        if (inv[key] > 0) {
            hasItem = true;
            // Clone objek agar tidak merubah DB asli saat modifikasi dinamis
            let itemData = { ...(ITEM_DB[key] || { name: key.toUpperCase(), icon: '', desc: 'Item.' }) };
            
            // --- LOGIKA GAMBAR DINAMIS BERDASARKAN JURUSAN ---
            const major = STATE.player.major || 'teknologi';

            // 1. UPDATE IMAGE BUKU TESIS
            if (key === 'buku_tesis') {
                if (major === 'sejarah') {
                    itemData.img = 'images/buku-tesis-sejarah.png';
                    itemData.name = 'Tesis Sejarah';
                } else {
                    itemData.img = 'images/buku-tesis-teknologi.png';
                    itemData.name = 'Tesis Teknologi';
                }
            }
            
            // 2. UPDATE IMAGE DRAFT PROPOSAL (Konsistensi dengan Dialog)
            if (key === 'draft_proposal') {
                if (major === 'sejarah') {
                    itemData.img = 'images/draftskripsi-sejarah.png';
                } else {
                    itemData.img = 'images/draftskripsi-teknologi.png';
                }
            }

            const div = document.createElement('div');
            div.className = 'inv-item';
            
            // Tambahkan efek klik jika consumable
            if(itemData.type === 'consumable') {
                div.style.cursor = 'pointer';
                div.style.borderColor = '#10b981'; // Green border for usable
                div.onclick = () => useInventoryItem(key, itemData.action);
                div.title = "KLIK UNTUK MENGGUNAKAN: " + itemData.desc;
            } else {
                div.title = itemData.desc || "Item Koleksi";
				
				 // NEW: KLIK UNTUK LIHAT INFO (PENGGANTI TOOLTIP DI HP)
                div.onclick = () => {
                    if(typeof AudioService !== 'undefined') AudioService.playSFX('item');
                    showDialogue(
                        `INFO: ${itemData.name.toUpperCase()}`, 
                        itemData.desc || "Sebuah item misterius yang ditemukan di Nusantara Arsa.", 
                        [{text: "Tutup", action: closeDialogue}], 
                        itemData.img
                    );
                };
            
            }

            // Render Image jika ada (Prioritas), fallback ke Icon Emoji
            let visualContent = `<div style="font-size:30px; margin-bottom:5px;">${itemData.icon}</div>`;
            
            if (itemData.img) {
                // Fallback icon jika gambar gagal load
                const fallbackIcon = itemData.icon || '';
                visualContent = `<img src="${itemData.img}" style="width:32px; height:32px; margin-bottom:5px; object-fit:contain;" 
                                onerror="this.style.display='none';this.nextElementSibling.style.display='block'">
                                <div style="font-size:30px; margin-bottom:5px; display:none;">${fallbackIcon}</div>`;
            }

            div.innerHTML = `
                <div class="inv-qty">${inv[key]}</div>
                ${visualContent}
                <span>${itemData.name}</span>
                <span style="font-size:8px; color:#94a3b8; margin-top:2px;">${itemData.type === 'consumable' ? '(Pakai/Makan)' : ''}</span>
            `;
            grid.appendChild(div);
        }
    }

    if (!hasItem) {
        grid.innerHTML = '<div class="inv-empty-msg">Tas Kosong...<br>Belum ada item yang didapat.</div>';
    }
}

// --- NEW FUNCTION: USE ITEM LOGIC (EAT & DRINK) ---
function useInventoryItem(id, action) {
    let consumed = false;

    // 1. TONIC STAMINA (FULL)
    if(action === 'useStamina') {
        if(STATE.player.energy >= 100) {
            showToast("Energi sudah penuh!");
            return;
        }
        STATE.player.energy = 100;
        showToast(" STAMINA PULIH PENUH!");
        if(typeof AudioService !== 'undefined') AudioService.playSFX('item');
        createParticle(STATE.player.x, STATE.player.y, '#fbbf24');
		 spawnFloatingText(STATE.player.x, STATE.player.y - 40, "MAX ENERGY!", "#fbbf24", 16); // Visual Teks
        consumed = true;
    } 
    // 2. TONIC KEBAL
    else if(action === 'useImmune') {
        if(STATE.player.invincible) {
            showToast("Efek Kebal Masih Aktif!");
            return;
        }
        STATE.player.invincible = true;
        STATE.player.shieldTimer = 600; // 10 detik (60fps)
        showToast(" MODE KEBAL AKTIF (10 Detik)!");
        if(typeof AudioService !== 'undefined') AudioService.playSFX('item');
		spawnFloatingText(STATE.player.x, STATE.player.y - 40, "SHIELD ON!", "#60a5fa", 16); // Visual Teks
        consumed = true;
    }
   
   // 3. MAKANAN & IKAN (FISH, BREAD, CHOCO)
    else if (action.startsWith('eat_')) {
        // ... (Kode makan tetap sama) ...
        consumed = true;
        // Logic makan sederhana (hardcoded di sini karena sebelumnya terpotong)
        const energyGain = {
            'eat_fish': 15, 'eat_bread': 20, 'eat_choco': 10,
            'eat_fish_small': 10, 'eat_fish_medium': 25, 'eat_fish_large': 50, 'eat_fish_legend': 100
        }[action] || 10;
        
       if(STATE.player.energy >= 100) {
            showToast("Kenyang! (Energi Penuh)");
            return;
        }
        STATE.player.energy = Math.min(100, STATE.player.energy + energyGain);
        showToast(`Nyam! (+${energyGain} Energi)`);
        
        // Visual Teks di Game World (Meski tertutup inventori, bagus jika transparansi diubah)
        spawnFloatingText(STATE.player.x, STATE.player.y - 40, `+${energyGain} `, "#4ade80", 14);
		
        if(typeof AudioService !== 'undefined') AudioService.playSFX('item');
    }


    // --- [TAMBAHAN BARU] LOGIKA MENCANGKUL (HOE) ---
    else if (action === 'use_hoe') {
        // 1. Cek Lokasi (Harus di Desa/Luar)
        if (STATE.location !== 'village') {
            showToast("Hanya bisa mencangkul di Luar Ruangan!");
            return;
        }

        // 2. Cek Energi (Butuh 5)
        if (STATE.player.energy < 5) {
            showToast("Energi tidak cukup! (Butuh 5)");
            return;
        }

        // 3. Hitung Posisi Tile di Bawah Kaki Pemain
        const tx = Math.floor((STATE.player.x + 10) / TILE_SIZE);
        const ty = Math.floor((STATE.player.y + 15) / TILE_SIZE);
        const map = maps['village'];
        const tIdx = ty * map.w + tx;

        // 4. Cek Apakah Berdiri di Lahan Pertanian (Tile ID 5)
        if (map.tiles[tIdx] !== 5) {
            showToast("Ini bukan lahan pertanian! Cari tanah coklat.");
            return;
        }

        // 5. Cek Status Tanah
        const farmKey = `${tx}_${ty}`;
        if (!STATE.player.farming) STATE.player.farming = {};
        
        const crop = STATE.player.farming[farmKey];

        if (crop && (crop.tilled || crop.type)) {
            showToast("Tanah sudah gembur atau ada tanaman.");
        } else {
            // PROSES CANGKUL BERHASIL
            STATE.player.energy -= 5;
            
            // Set status tanah jadi tilled (gembur)
            STATE.player.farming[farmKey] = { tilled: true };
            
            // Efek Visual & Audio
            createParticle(tx * TILE_SIZE, ty * TILE_SIZE, '#d97706'); // Partikel Tanah Coklat
            if(typeof AudioService !== 'undefined') AudioService.playSFX('item');
            showToast("Tanah berhasil digemburkan! ");
            
            // Simpan Progress
            manualSave();
        }
        
        // Cangkul adalah ALAT, jadi tidak dikonsumsi (consumed = false)
        return; 
    }
	
	
	
	
	
	

    // --- [TAMBAHAN BARU] LOGIKA MENANAM BIBIT ---
    else if (action.startsWith('plant_')) {
        // 1. Cek Lokasi (Harus di Desa/Luar)
        if (STATE.location !== 'village') {
            showToast("Hanya bisa menanam di Luar Ruangan!");
            return;
        }
		
		     // --- NEW: CEK MUSIM DINGIN (WINTER) ---
        if (STATE.season === 'winter') {
            showToast(" Tanah membeku! Tidak bisa menanam di Musim Dingin.");
            // Mainkan suara error jika ada
            if(typeof AudioService !== 'undefined') AudioService.playSFX('hit');
            return;
        }
        // --------------------------------------

        // 2. Hitung Posisi Tile di Bawah Kaki Pemain
        // (x+10, y+15 adalah titik tengah kaki player 20x20)
        const tx = Math.floor((STATE.player.x + 10) / TILE_SIZE);
        const ty = Math.floor((STATE.player.y + 15) / TILE_SIZE);
        
        // 3. Cek Apakah Berdiri di Atas Lahan Pertanian (Tile ID 5)
        const map = maps['village'];
        const tIdx = ty * map.w + tx;
        if (map.tiles[tIdx] !== 5) {
            showToast("Harus berdiri di Lahan Pertanian (Tanah Coklat)!");
            return;
        }

        // 4. Cek Status Tanah (Harus Tilled & Belum Ada Tanaman)
        const farmKey = `${tx}_${ty}`;
        
        // Safety init
        if (!STATE.player.farming) STATE.player.farming = {};
        
        // Ambil data tanah saat ini
        const farmData = STATE.player.farming[farmKey];

        // UPDATE: VALIDASI TANAH GEMBUR
        // Jika data tanah tidak ada ATAU belum dicangkul (tilled), tolak.
        if (!farmData || !farmData.tilled) {
             showToast("Tanah harus dicangkul dulu! (Gunakan Cangkul )");
             return;
        }
        
        // Jika sudah ada tanaman (type terisi), tolak.
        if (farmData.type) {
            showToast("Sudah ada tanaman di sini!");
            return;
        }

        // 5. PROSES TANAM
        // Ambil tipe tanaman dari action (contoh: 'plant_padi' -> 'padi')
        const cropType = action.split('_')[1]; 
        
        // Update data tanah yang sudah ada (pertahankan status tilled)
        farmData.type = cropType;
        farmData.stage = 1;       // 1 = Benih
        farmData.watered = false; // Reset siram saat tanam baru

        // Efek Visual & Audio
        createParticle(tx * TILE_SIZE, ty * TILE_SIZE, '#4ade80'); // Partikel Hijau
        if(typeof AudioService !== 'undefined') AudioService.playSFX('item');
        showToast(`Berhasil menanam ${cropType.toUpperCase()}! `);

        consumed = true; // Tandai item berhasil dipakai (untuk dikurangi)
        
        // Opsional: Tutup tas otomatis biar langsung kelihatan hasilnya
        toggleInventory(); 
    }
    // --- LOGIKA PUPUK (INSTANT GROW) ---
    else if (action === 'use_pupuk') {
        if (STATE.location !== 'village') {
            showToast("Hanya bisa dipakai di ladang!");
            return;
        }
        
        const tx = Math.floor((STATE.player.x + 10) / TILE_SIZE);
        const ty = Math.floor((STATE.player.y + 15) / TILE_SIZE);
        const farmKey = `${tx}_${ty}`;
        
        if (STATE.player.farming && STATE.player.farming[farmKey]) {
            const crop = STATE.player.farming[farmKey];
            if (crop.stage < 3) {
                crop.stage++; // Langsung tumbuh 1 tahap
                showToast("Tanaman tumbuh instan! ");
                createParticle(tx * TILE_SIZE, ty * TILE_SIZE, '#fbbf24');
                if(typeof AudioService !== 'undefined') AudioService.playSFX('item');
                consumed = true;
                toggleInventory();
            } else {
                showToast("Tanaman sudah siap panen!");
            }
        } else {
            showToast("Tidak ada tanaman di sini.");
        }
    }
    // --- [AKHIR TAMBAHAN] ---

    // Kurangi Item jika berhasil dikonsumsi
    if(consumed && STATE.player.inventory[id] > 0) {
        STATE.player.inventory[id]--;
        if(STATE.player.inventory[id] <= 0) delete STATE.player.inventory[id];
        renderInventory(); // Refresh tampilan tas
    }
}

// --- NEW FUNCTION: HANDLE DROPS (BOSS & NORMAL) ---
function handleEnemyDrop(en) {
    // 1. Reward Dasar
    let gold = 2500;
    let exp = 20;

    // --- NEW: BONUS CINCIN RAJA (PASIF GOLD++) ---
    let ringBonusText = "";
    if ((STATE.player.inventory['cincin_legend'] || 0) > 0) {
        gold = Math.floor(gold * 1.5); // +50% Gold dari Monster
        ringBonusText = " ";
    }
    
    // FIX: TAMBAHKAN REWARD KE STATUS PLAYER
    STATE.player.money += gold;
    STATE.player.reputation += 1; 

    // NEW: TAMBAH COUNTER KILL MONSTER HARIAN
    STATE.player.dailyMonsterKills = (STATE.player.dailyMonsterKills || 0) + 1;

    // --- KHUSUS QUEST MONSTER ---
    if(en.isQuestTarget) {
        // Drop Item Quest Pasti
        addItem('draft_proposal', 1);
        STATE.player.activeQuest = null; // Quest selesai (tahap cari)
        
        showDialogue("BERHASIL!", "Kamu menemukan **Draft Skripsi** yang dicuri! \nKembalikan ke Senior Kutubuku di Perpustakaan.", [
            {text: "Ok, Kembali ke Desa", action: () => {
                STATE.location = 'village';
                STATE.player.x = 50 * TILE_SIZE; // Balik ke depan Candi
                STATE.player.y = 15 * TILE_SIZE;
                closeDialogue();
                if(typeof AudioService !== 'undefined') AudioService.playBGM('village');
            }}
        ], 'images/monster-thief.png');
        
        if(typeof AudioService !== 'undefined') AudioService.playSFX('item');
        return; // Stop logic drop biasa
    }

    if(en.isBoss) {
        STATE.player.str += 5;
        STATE.player.int += 5;
        STATE.player.biz += 5;
        STATE.player.reputation += 10;
        STATE.player.maxHp += 50; // HP Tebal Permanen
        STATE.player.hp = STATE.player.maxHp; // Full Heal
        STATE.player.energy = 100; // Full Energy
        
        showToast(" KEKUATAN BOSS DISERAP! (ALL STATS +5, MAX HP +50)");
    }

    gainExp(exp);

    // 2. Drop Item Logic
    let dropText = "";
    let floatedItem = ""; // Text untuk floating text
    const lvl = STATE.dungeonLevel || 1;

    if (en.isBoss) {
        // --- BOSS SMART DROP SYSTEM (10% Chance) ---
        if(Math.random() <= 0.20) { 
            const hasArmor = (STATE.player.inventory['zirah_legend'] || 0) > 0;
            const hasRing = (STATE.player.inventory['cincin_legend'] || 0) > 0;
            let rareDrop = "";

            if (!hasArmor) {
                rareDrop = 'zirah_legend';
                dropText = " LEGENDARY DROP: ZIRAH ABADI!";
                floatedItem = "ZIRAH ABADI";
            } else if (!hasRing) {
                rareDrop = 'cincin_legend';
                dropText = " LEGENDARY DROP: CINCIN RAJA!";
                floatedItem = "CINCIN RAJA";
            } else {
                rareDrop = Math.random() < 0.5 ? 'tonic_stamina' : 'tonic_kebal';
                dropText = ` DROP LANGKA: ${rareDrop.replace('_', ' ').toUpperCase()}!`;
                floatedItem = rareDrop.replace('_', ' ').toUpperCase();
            }

            addItem(rareDrop, 1);
            
            // --- NEW: POPUP SAAT DAPAT ZIRAH ABADI ---
            if (rareDrop === 'zirah_legend') {
                setTimeout(() => {
                    showDialogue("LEGENDARY ITEM! ", 
                        "LUAR BIASA! Kamu mendapatkan **ZIRAH ABADI** dari Boss!\n\nIni adalah pakaian pertahanan terkuat. \n(Efek Pasif: Damage musuh berkurang drastis)\n\n**Cek Lemari Pakaian** di rumahmu untuk segera menggunakannya!", 
                        [{text: "Mantap! Terima Kasih!", action: closeDialogue}], 
                        'images/lemari.png'
                    );
                    if(typeof AudioService !== 'undefined') AudioService.playSFX('item');
                }, 1500); // Muncul 1.5 detik setelah monster mati
            }
            // ------------------------------------------

            if(typeof AudioService !== 'undefined') AudioService.playSFX('item');
        } else {
            dropText = " (Boss Defeated)";
        }
    } else {
        // --- NORMAL DROP SYSTEM (Tiered by Level) ---
        const chance = 0.4 + (lvl * 0.05); // Base 40% + bonus level
        
        if (Math.random() < chance) {
            let pool = [];
            
            // Level 1: Common
            if (lvl === 1) pool = ['gandum', 'kain'];
            // Level 2: Uncommon
            else if (lvl === 2) pool = ['coklat', 'bunga', 'kain'];
            // Level 3: Rare
            else if (lvl === 3) pool = ['besi', 'bunga', 'ikan_segar'];
            // Level 4: Very Rare
            else if (lvl === 4) pool = ['permata', 'besi', 'coklat'];
            // Level 5: Epic
            else if (lvl >= 5) pool = ['permata', 'scroll_exp'];

            const item = pool[Math.floor(Math.random() * pool.length)];
            
            if(item === 'scroll_exp') {
                gainExp(100);
                dropText = " &  Ancient Scroll (+100 EXP)";
                floatedItem = "SCROLL EXP";
            } else {
                addItem(item, 1);
                dropText = ` & Dapat ${item.toUpperCase()} `;
                floatedItem = item.toUpperCase();
            }
        }
    }

    // 3. Feedback Visual & Audio (Disatukan disini)
    showToast(`+${gold.toLocaleString()} G${dropText}${ringBonusText}`);
    
    // NEW: Floating Text Indikator di posisi monster
    spawnFloatingText(en.x, en.y, `+${gold} G${ringBonusText}`, '#fbbf24', 12);
    if(floatedItem) {
        spawnFloatingText(en.x, en.y - 15, `+ ${floatedItem}`, '#4ade80', 12);
    }

    createParticle(en.x, en.y, '#fbbf24');
    if(typeof AudioService !== 'undefined') AudioService.playSFX('item');
}

function addItem(id, qty) {
    if(!STATE.player.inventory[id]) STATE.player.inventory[id] = 0;
    STATE.player.inventory[id] += qty;
}

// UPDATE ENEMY UNTUK CEK INVINCIBLE & DAMAGE REDUCTION
function updateEnemies() {
    STATE.enemies.forEach((en, i) => {
        // ... existing movement logic ...
        en.x += en.knockback.x; en.y += en.knockback.y;
        en.knockback.x *= 0.8; en.knockback.y *= 0.8;
        
        if(Math.abs(en.knockback.x) < 0.5) {
            const ang = Math.atan2(STATE.player.y - en.y, STATE.player.x - en.x);
            en.angle = ang;
            en.x += Math.cos(ang) * en.speed;
            en.y += Math.sin(ang) * en.speed;
        }

        const d = Math.hypot(STATE.player.x - en.x, STATE.player.y - en.y);
        
        // LOGIC HIT PEMAIN
        if(d < 20) {
            if(!STATE.player.invincible) {
                // Damage Calculation dengan Zirah
                let dmg = 0.5;
                if(STATE.player.inventory['zirah_legend']) dmg = 0.2; // Diskon damage 60% jika punya zirah

                STATE.player.hp -= dmg;
                
                // --- NEW: TRIGGER DAMAGE EFFECTS ---
                // Hanya trigger efek visual setiap beberapa frame agar tidak epilepsi (interval 30 frame / 0.5 detik)
                if (!STATE.player.damageCooldown || STATE.player.damageCooldown <= 0) {
                    
                    // 1. Set Timer Animasi Player (Sprite Merah)
                    STATE.player.hurtTimer = 15; // 15 Frame (~0.25 detik)
                    
                    // 2. Trigger Overlay Merah (CSS Animation)
                    const dmgOverlay = document.getElementById('damage-overlay');
                    if (dmgOverlay) {
                        dmgOverlay.classList.remove('damage-active');
                        void dmgOverlay.offsetWidth; // Trigger Reflow
                        dmgOverlay.classList.add('damage-active');
                    }

                    // 3. Trigger Screen Shake (CSS Animation pada Container)
                    const gameContainer = document.getElementById('game-container');
                    if (gameContainer) {
                        gameContainer.classList.remove('shake-screen');
                        void gameContainer.offsetWidth; // Trigger Reflow
                        gameContainer.classList.add('shake-screen');
                    }

                    // 4. Efek Suara
                    if(typeof AudioService !== 'undefined') AudioService.playSFX('hit');
                    
                    // 5. Partikel Darah
                    createParticle(STATE.player.x, STATE.player.y, '#ef4444');
                    createParticle(STATE.player.x, STATE.player.y, '#b91c1c');

                    // Cooldown visual agar tidak spamming
                    STATE.player.damageCooldown = 40; 
                }

                if(STATE.player.damageCooldown > 0) STATE.player.damageCooldown--;

                // if(Math.random()<0.1) createParticle(STATE.player.x, STATE.player.y, '#ef4444'); // Removed, replaced by deterministic particle above
                if(STATE.player.hp <= 0) gameOver();
            } else {
                // Jika Kebal, Musuh Mental
                 en.knockback = { x: (en.x - STATE.player.x)*0.5, y: (en.y - STATE.player.y)*0.5 };
            }
        }

        if(en.hp <= 0) {
            STATE.enemies.splice(i, 1);
            // PANGGIL DROP LOGIC BARU
            handleEnemyDrop(en);
        }
    });

    // --- NEW: UPDATE SHIELD TIMER ---
    if(STATE.player.shieldTimer > 0) {
        STATE.player.shieldTimer--;
        if(STATE.player.shieldTimer <= 0) {
            STATE.player.invincible = false;
            showToast(" Efek Kebal Habis.");
        }
    }

    // CEK CLEARED CONDITION SEPERTI BIASA
    if (STATE.location === 'dungeon' && STATE.enemies.length === 0) {
        if (STATE.dungeonLevel === 5 && !STATE.bossSpawned) {
            spawnFinalBoss(); 
            return; 
        }

        const map = maps['dungeon'];
        // Cek apakah portal sudah ada
        const hasPortal = map.buildings.find(b => b.id === 'dungeon_next' || (b.id === 'dungeon_exit' && b.x === 20));
        
        if (!hasPortal) {
            if (STATE.dungeonLevel < 5) {
                // UPDATE POSISI: Spawn Portal di Dinding Atas (Utara) agar seperti pintu
                // Koordinat X: 19 (Tengah), Y: 1 (Lantai paling atas)
                map.buildings.push({ 
                    id: 'dungeon_next', 
                    x: 19, y: 1, w: 2, h: 2, 
                    type: 'trigger', 
                    entrance: {x: 19.5, y: 1.5, map: 'dungeon'}, // Titik tengah visual
                    name: `Portal Level ${STATE.dungeonLevel + 1}`,
                    open24h: true
                });
                
                // FIX: TAMBAHKAN EFEK SUARA SAAT PORTAL MUNCUL
                if(typeof AudioService !== 'undefined') AudioService.playSFX('item');
                
                showToast(" PORTAL TERBUKA! Lanjut ke Level Berikutnya (Cek Dinding Atas).");
            } else {
                // Level 5 (Boss) Selesai
                showToast(" DUNGEON CLEARED! Kamu mengalahkan BOSS!");
                // Beri hadiah besar
                STATE.player.money += 50000;
                STATE.player.reputation += 50;
                gainExp(500);
                if(typeof AudioService !== 'undefined') AudioService.playSFX('item'); 
                
                // NEW: Munculkan Portal Pulang di Tengah Ruangan (Karena exit di pojok sudah hilang)
                map.buildings.push({ 
                    id: 'dungeon_exit', 
                    x: 20, y: 15, w: 2, h: 2, 
                    type: 'trigger', 
                    entrance: {x: 21, y: 16}, 
                    name: "KEMBALI KE DESA (MENANG)",
                    open24h: true
                });
            }
        }
    }
}

function gameOver() {
    // UPDATE: Gunakan gambar monster atau penjaga dungeon untuk dialog Game Over
    showDialogue("DEFEAT (KALAH)", "Kamu dikalahkan oleh monster ganas...\nPandanganmu menggelap. (Gold berkurang 10%)", [{text:"... (Sadar di Klinik)", action:()=>{
        STATE.player.hp = 100;
        STATE.player.energy = 50; // Bangun lemas
        STATE.player.money = Math.floor(STATE.player.money * 0.9);
        
        // FIX: UPDATE LOKASI RESPAWN KE DALAM KLINIK (SAMAKAN DENGAN PINGSAN ENERGI)
        // Sebelumnya: STATE.location = 'village'; (Ini yang bikin muncul di luar)
        STATE.location = 'clinic_interior';
        STATE.player.x = 10 * TILE_SIZE; // Samping Bed Kanan
        STATE.player.y = 8 * TILE_SIZE; 
        STATE.player.direction = 'left';
        
        // FIX: Lompati hari (karena pingsan butuh pemulihan)
        STATE.day = parseInt(STATE.day) + 1;
        STATE.time = 800; // Bangun jam 08:00 Pagi
        
        STATE.enemies = []; 
        closeDialogue();
        
        // Update UI Waktu Segera
        const currentDayName = DAYS_OF_WEEK[(STATE.day - 1) % 7];
        const totalDays = STATE.day - 1;
        const year = Math.floor(totalDays / (DAYS_PER_SEASON * 4)) + 1;
        document.getElementById('full-date-display').innerText = `${currentDayName}, D${(totalDays % DAYS_PER_SEASON) + 1} ${STATE.season.toUpperCase()} Y${year}`;
        document.getElementById('clock-display').innerText = "08:00";

        showToast("Dirawat Intensif oleh Dr. Budi ");
        manualSave();

        // FIX: Munculkan Dialog Dokter Budi di Dalam Klinik
        setTimeout(() => {
             showDialogue("DR. BUDI", "Astaga! Kamu terluka parah di Dungeon!\n\nUntung Tim Penyelamat Guild menemukanmu tepat waktu dan membawamu ke sini.\n\nLuka-lukamu cukup serius. Saya sarankan jangan memaksakan diri melawan monster level tinggi jika belum siap.", [{text:"Terima kasih Dok", action:closeDialogue}], 'images/lover1boy.png');
        }, 500);

    }}], 'images/monster.png');
}

// --- FIX: KEMBALIKAN FUNGSI MINIMAP YANG BENAR (SEBELUMNYA SALAH NAMA showDialogue) ---
function drawMinimap() {
    const miniCanvas = document.getElementById('minimapCanvas');
    if(!miniCanvas) return;
    const mCtx = miniCanvas.getContext('2d');

    // Clear Area Minimap
    mCtx.clearRect(0, 0, miniCanvas.width, miniCanvas.height);

    // Ambil data map aktif (bisa desa, dungeon, atau interior rumah/toko)
    const currentMap = maps[STATE.location];
    if(!currentMap) return;

    // Hitung dimensi map dalam pixel
    const mapW = currentMap.w * TILE_SIZE;
    const mapH = currentMap.h * TILE_SIZE;
    
    // Hitung Scale agar map pas di canvas minimap
    // Gunakan Math.min untuk scale agar aspek rasio tetap terjaga jika mapnya kotak/persegi panjang
    // Tapi untuk memenuhi kotak, kita bisa stretch sedikit atau center.
    // Kode sebelumnya menggunakan stretch fill:
    const scaleX = miniCanvas.width / mapW;
    const scaleY = miniCanvas.height / mapH;
    
    // Update Label Minimap
    const labelEl = document.getElementById('minimap-label');
    if(labelEl) {
        if(STATE.location === 'dungeon') labelEl.innerText = `LV ${STATE.dungeonLevel}`;
        else if(STATE.location === 'village') labelEl.innerText = "DESA";
        else {
            // Nama lokasi interior
            let locName = "INDOOR";
            if(STATE.location === 'house') locName = "RUMAH";
            else if(STATE.location === 'merchant_interior') locName = "TOKO";
            else if(STATE.location === 'school_interior') locName = "KAMPUS";
            else if(STATE.location === 'library_interior') locName = "PERPUS"; // NEW
            else if(STATE.location === 'guild_interior') locName = "GUILD"; // NEW
            else if(STATE.location === 'candi_interior') locName = "CANDI"; // NEW: Label Candi
            labelEl.innerText = locName;
        }
    }
    
    // 1. DRAW BUILDINGS & PORTALS (Termasuk Pintu Keluar/Masuk)
    if(currentMap.buildings) {
        currentMap.buildings.forEach(b => {
            // Tentukan Warna di Minimap
            if(b.id === 'player_house') {
                mCtx.fillStyle = '#f59e0b'; // Rumah (Emas)
            } else if(b.type === 'trigger' || b.id.includes('exit') || b.id.includes('next')) {
                mCtx.fillStyle = '#a855f7'; // Portal/Teleport (Ungu) - Sangat penting di Indoor untuk melihat pintu keluar
            } else if(b.roleSpecific || b.openTime) {
                mCtx.fillStyle = '#3b82f6'; // Toko/Bangunan Penting (Biru)
            } else if (b.type === 'dungeon_rock') {
                mCtx.fillStyle = '#334155'; // Batu (Abu Gelap)
            } else {
                mCtx.fillStyle = '#475569'; // Bangunan Lain (Abu)
            }

            const bx = (b.x * TILE_SIZE) * scaleX;
            const by = (b.y * TILE_SIZE) * scaleY;
            const bw = (b.w * TILE_SIZE) * scaleX;
            const bh = (b.h * TILE_SIZE) * scaleY;
            mCtx.fillRect(bx, by, bw, bh);
        });
    }

    // 2. NEW: DRAW INTERACTABLE OBJECTS (Benda yang bisa disentuh)
    if(currentMap.objects) {
        mCtx.fillStyle = '#22d3ee'; // Cyan (Biru Muda Terang)
        currentMap.objects.forEach(o => {
            // Objek biasanya 1x1 tile
            const ox = (o.x * TILE_SIZE) * scaleX;
            const oy = (o.y * TILE_SIZE) * scaleY;
            
            // UPDATE: Support Custom Size di Minimap
            const ow = ((o.w || 1) * TILE_SIZE) * scaleX;
            const oh = ((o.h || 1) * TILE_SIZE) * scaleY;
            
            // Gambar kotak kecil untuk objek
            mCtx.fillRect(ox, oy, ow, oh);
        });
    }

    // 3. DRAW NPCS (Berlaku untuk SEMUA map sekarang, termasuk Indoor)
    if(currentMap.npcs) {
        currentMap.npcs.forEach(n => {
            if(!isNPCActive(n)) return; 
            
            const nx = (n.x * TILE_SIZE) * scaleX;
            const ny = (n.y * TILE_SIZE) * scaleY;
            
            // Titik NPC diperbesar sedikit agar terlihat jelas di map kecil
            mCtx.fillStyle = '#fff'; 
            mCtx.beginPath();
            mCtx.arc(nx, ny, 2, 0, Math.PI*2); // Radius 2
            mCtx.fill();
        });
    }

    // 4. DRAW ENEMIES (Dungeon Only)
    if(STATE.location === 'dungeon') {
        STATE.enemies.forEach(e => {
            const ex = e.x * scaleX;
            const ey = e.y * scaleY;
            const size = e.isBoss ? 4 : 2;
            mCtx.fillStyle = e.isBoss ? '#b91c1c' : '#ef4444'; 
            mCtx.beginPath();
            mCtx.arc(ex, ey, size, 0, Math.PI*2);
            mCtx.fill();
        });
    }

    // 5. DRAW PLAYER
    const px = STATE.player.x * scaleX;
    const py = STATE.player.y * scaleY;
    
    // UPDATE: Ganti Dot dengan Kepala Player (Avatar dari HUD)
    const avatarImg = document.getElementById('hud-avatar-img');
    const headSize = 12; // Ukuran kepala di minimap (pixel)

    if (avatarImg && avatarImg.complete && avatarImg.naturalWidth > 0) {
        mCtx.save();
        
        // 1. Clipping Mask (Membuat gambar jadi bulat)
        mCtx.beginPath();
        mCtx.arc(px, py, headSize/2, 0, Math.PI*2);
        mCtx.closePath();
        mCtx.clip();
        
        // 2. Gambar Avatar (Tengah di posisi px, py)
        mCtx.drawImage(avatarImg, px - headSize/2, py - headSize/2, headSize, headSize);
        
        mCtx.restore();

        // 3. Border Emas di sekeliling kepala
        mCtx.strokeStyle = '#fbbf24'; // Warna Emas
        mCtx.lineWidth = 1.5;
        mCtx.beginPath();
        mCtx.arc(px, py, headSize/2, 0, Math.PI*2);
        mCtx.stroke();

    } else {
        // Fallback: Player Dot (Jika gambar gagal load)
        mCtx.fillStyle = '#fbbf24'; 
        mCtx.beginPath(); 
        mCtx.arc(px, py, 4, 0, Math.PI*2); 
        mCtx.fill();
    }
    
    // Player Ring (Radar Effect) - Diperbesar agar melingkupi kepala
    mCtx.strokeStyle = 'rgba(251, 191, 36, 0.5)';
    mCtx.beginPath();
    mCtx.arc(px, py, headSize/2 + 3, 0, Math.PI*2);
    mCtx.stroke();
}


// --- [KODE BARU: SISTEM PERTANIAN LENGKAP] ---

// 1. Fungsi Utama Interaksi (Dipanggil saat tombol aksi ditekan di ladang)
function handleFarmingInteraction(tx, ty) {
    const farmKey = `${tx}_${ty}`;
    
    // Pastikan data farming aman
    if (!STATE.player.farming) STATE.player.farming = {};
    const crop = STATE.player.farming[farmKey];

    // SKENARIO A: TANAH KOSONG (Sudah Dicangkul) -> MENU PILIH BIBIT
    if (!crop || !crop.type) {
        if (crop && crop.tilled) {
            showSeedMenu(tx, ty);
        } else {
            showToast("Tanah harus dicangkul dulu! (Gunakan ikon )");
        }
        return;
    }

    // SKENARIO B: ADA TANAMAN -> MENU PERAWATAN
    const cropName = crop.type.toUpperCase();
    let stageInfo = " Benih";
    if (crop.stage === 2) stageInfo = " Tumbuh";
    if (crop.stage === 3) stageInfo = " Siap Panen";
    
    // Siapkan Opsi Dialog
    let opts = [];

    // Opsi 1: Panen (Muncul jika Stage 3)
    if (crop.stage >= 3) {
        opts.push({
            text: ` PANEN ${cropName} (+EXP)`, 
            action: () => harvestCrop(tx, ty)
        });
    } 
    // Opsi 2: Siram (Muncul jika belum disiram & belum panen)
    else if (!crop.watered) {
        opts.push({
            text: ` SIRAM AIR (Energi -2)`, 
            action: () => waterCrop(tx, ty)
        });
    }

    // Opsi 3: Cek Status
    opts.push({
        text: " Cek Kondisi", 
        action: () => {
            let statusMsg = `Tanaman: **${cropName}**\nFase: ${stageInfo} (Stage ${crop.stage}/3)\nAir: ${crop.watered ? ' Basah (Akan Tumbuh)' : ' Kering (Butuh Air)'}`;
            showDialogue("INFO TANAMAN", statusMsg, [{text:"Mengerti", action:closeDialogue}], 'images/lahan-liar.png');
        }
    });

    // Opsi 4: Cabut (Hapus tanaman jika salah tanam)
    opts.push({
        text: " Cabut/Buang Tanaman", 
        action: () => {
            // Hapus data tanaman, tapi biarkan tanah tetap gembur (tilled)
            delete STATE.player.farming[farmKey].type;
            delete STATE.player.farming[farmKey].stage;
            delete STATE.player.farming[farmKey].watered;
            
            showToast("Tanaman dicabut.");
            if(typeof AudioService !== 'undefined') AudioService.playSFX('item');
            closeDialogue();
            manualSave();
        }
    });

    opts.push({text: "Tutup", action: closeDialogue});

    showDialogue(`TANAMAN: ${cropName}`, `Apa yang ingin kamu lakukan?`, opts, 'images/lahan-liar.png');
}


// 2. Fungsi Menampilkan Menu Bibit (Cek Isi Tas)
function showSeedMenu(tx, ty) {
    const inv = STATE.player.inventory || {};
    let opts = [];

    // Daftar bibit yang didukung (UPDATE: Tambah Rafflesia)
    const seeds = [
        {id: 'bibit_padi', name: 'Padi'},
        {id: 'bibit_jagung', name: 'Jagung'},
        {id: 'bibit_tomat', name: 'Tomat'},
        {id: 'bibit_rafflesia', name: 'RAFFLESIA (Langka!)'} // <--- BARU
    ];

    seeds.forEach(s => {
        // Cek apakah punya bibit ini di tas
        if (inv[s.id] > 0) {
            opts.push({
                text: ` Tanam ${s.name} (Sisa: ${inv[s.id]})`,
                action: () => {
                    // Panggil fungsi tanam
                    // Format action: plant_padi, plant_rafflesia, dst.
                    useInventoryItem(s.id, `plant_${s.id.split('_')[1]}`); 
                    closeDialogue();
                }
            });
        }
    });

    opts.push({text: "Batal", action: closeDialogue});

    if (opts.length === 1) { // Cuma ada tombol Batal
        showDialogue("TIDAK ADA BIBIT", "Tas kamu kosong!\nBeli bibit di **Pedagang Keliling** atau dapatkan Bibit Langka dari Quest.", [{text:"Oke", action:closeDialogue}], 'images/lahan-liar.png');
    } else {
        showDialogue("PILIH BIBIT", "Mau tanam apa di petak ini?", opts, 'images/lahan-liar.png');
    }
}
// 3. Fungsi Menyiram Tanaman
function waterCrop(tx, ty) {
    if (STATE.player.energy < 2) {
        showToast("Energi habis! Makan dulu.");
        return;
    }

    const farmKey = `${tx}_${ty}`;
    const crop = STATE.player.farming[farmKey];

    if (crop) {
        STATE.player.energy -= 2;
        crop.watered = true; // Tandai sudah disiram
        
        // Efek Visual
        createParticle(tx * TILE_SIZE, ty * TILE_SIZE, '#38bdf8'); // Partikel Biru
        if(typeof AudioService !== 'undefined') AudioService.playSFX('item'); 
        
        showToast("Tanaman disiram! ");
        closeDialogue();
        manualSave();
    }
}

// 4. Fungsi Panen
// 4. Fungsi Panen
function harvestCrop(tx, ty) {
    const farmKey = `${tx}_${ty}`;
    const crop = STATE.player.farming[farmKey];

    if (crop && crop.stage >= 3) {
        // Tentukan Hasil Panen Default
        let resultItem = 'gandum'; 
        let qty = 1;
        let xpGain = 15;
        let particleColor = '#fbbf24'; // Emas

        // Logika Hasil Panen
        if (crop.type === 'padi') { 
            resultItem = 'gandum'; qty = 2; xpGain = 20; 
        }
        else if (crop.type === 'jagung') { 
            resultItem = 'gandum'; qty = 3; xpGain = 25; 
        }
        else if (crop.type === 'tomat') { 
            resultItem = 'gandum'; qty = 2; xpGain = 15; 
        }
        // --- LOGIKA RAFFLESIA ---
         // --- LOGIKA PANEN RAFFLESIA (BENAR) ---
        else if (crop.type === 'rafflesia') {
            resultItem = 'bunga_rafflesia'; // Panen jadi Bunga (Item Mahal/Syarat)
            qty = 1; 
            xpGain = 500; 
            particleColor = '#ef4444'; 
            showToast("PANEN LEGENDARIS! ");
        }

        // Tambah Item ke Tas
        addItem(resultItem, qty);
        gainExp(xpGain);

        // Reset Tanaman (Jadi tanah kosong tapi tetap gembur)
        delete crop.type;
        delete crop.stage;
        delete crop.watered;
        // crop.tilled tetap true

        // Efek Visual Panen
        createParticle(tx * TILE_SIZE, ty * TILE_SIZE, particleColor); 
        if(typeof AudioService !== 'undefined') AudioService.playSFX('item');
        
        let msg = `Kamu memanen **${qty} ${resultItem.toUpperCase().replace('_', ' ')}**!\n(+${xpGain} EXP)`;
        if (crop.type === 'rafflesia') msg = "LUAR BIASA! Kamu berhasil membudidayakan **Bunga Rafflesia**!\n(+500 EXP)";

        showDialogue("PANEN RAYA!", msg, [{text:"Mantap", action:closeDialogue}], 'images/lahan-liar.png');
        
        manualSave();
    }
}

// --- NEW: FUNGSI TAMBAHAN FESTIVAL & LEADERBOARD (PASTE DI BAGIAN BAWAH SEBELUM CLOSING SCRIPT) ---

// 1. FUNGSI HANDLER LEADERBOARD DARI PATUNG
function showLeaderboardFromStatue() {
     showDialogue("HALL OF FAME", "Sedang mengambil data peringkat server...", [], 'images/statue.png');
     
     DataService.getAllStudents().then(students => {
         let validStudents = students.filter(s => s.saveData);
         
         validStudents.sort((a, b) => {
             const scoreA = calculateGrade(a.saveData);
             const scoreB = calculateGrade(b.saveData);
             return scoreB - scoreA;
         });

         let rankText = " PERINGKAT TERTINGGI NUSANTARA ARSA:\n\n";
         const top3 = validStudents.slice(0, 3);
         
         if(top3.length === 0) {
             rankText += "Belum ada petualang yang terdaftar.";
         } else {
             top3.forEach((s, idx) => {
                 const medal = idx === 0 ? "" : (idx === 1 ? "" : "");
                 const score = calculateGrade(s.saveData);
                 const dName = s.name.length > 12 ? s.name.substring(0,10)+".." : s.name;
                 const role = s.saveData.role !== 'none' ? s.saveData.role.toUpperCase() : 'NOVICE';
                 rankText += `${medal} ${dName} [${role}] - Skor: ${score}\n`;
             });
         }

         if(DataService.user) {
             const myRank = validStudents.findIndex(s => s.email === DataService.user.email) + 1;
             if (myRank > 3) {
                 const myScore = calculateGrade(DataService.user.saveData);
                 rankText += `\n...\n#${myRank} ${DataService.user.name} (Kamu) - Skor: ${myScore}`;
             } else if (myRank > 0) {
                 rankText += `\n(Kamu berada di Puncak Klasemen!)`;
             } else {
                 rankText += `\n(Data kamu belum terdaftar di server)`;
             }
         }

         showDialogue("HALL OF FAME", rankText, [{text:"Saya Pasti Bisa Top 1!", action:closeDialogue}], 'images/statue.png');
         
     }).catch(err => {
         console.error("Leaderboard Error:", err);
         showDialogue("HALL OF FAME", "Gagal terhubung ke server peringkat.\nCek koneksi internetmu.", [{text:"Tutup", action:closeDialogue}], 'images/statue.png');
     });
}

// 2. LOGIKA EVENT FESTIVAL
function startFestivalEvent(eventData) {
    const p = STATE.player;
    const name = eventData.name;
    
    if(typeof AudioService !== 'undefined') AudioService.playSFX('item'); 
    
    createParticle(p.x, p.y, '#facc15');
    createParticle(p.x+10, p.y-10, '#f472b6');
    createParticle(p.x-10, p.y-10, '#60a5fa');

    // 1. TAHUN BARU
    if (name.includes("Tahun Baru")) {
        showDialogue("FESTIVAL TAHUN BARU", 
            "Kembang api menghiasi langit siang ini! (Imajiner)\nKepala Desa membagikan **Angpao** untuk modal awal tahun.", 
            [{
                text: "Terima Angpao (+2000 G)", 
                action: () => {
                    p.money += 2000;
                    showToast("Dapat Angpao 2000G! ");
                    closeDialogue();
                }
            }], 'images/statue.png');
    }
    // 2. VALENTINE
    else if (name.includes("Valentine") || name.includes("Bunga")) {
        showDialogue("FESTIVAL KASIH SAYANG", 
            "Hari ini adalah hari terbaik untuk mengungkapkan perasaan.\nBunga Mawar dijual murah khusus hari ini!", 
            [
                {
                    text: "Beli Bunga Spesial (100 G)", 
                    action: () => {
                        if (p.money >= 100) {
                            p.money -= 100;
                            addItem('bunga', 3);
                            showToast("Dapat 3 Bunga Mawar! ");
                            showDialogue("ROMANTIS", "Berikan bunga ini pada orang yang kamu sukai. Efek cintanya 2x lipat hari ini!", [{text:"Siap!", action:closeDialogue}], 'images/bunga.png');
                        } else showToast("Uang tidak cukup.");
                    }
                },
                {text: "Hanya melihat-lihat", action: closeDialogue}
            ], 'images/bunga.png');
    }
    // 3. PACUAN KUDA
    else if (name.includes("Pacuan Kuda")) {
        const horses = ["Si Kancil (Hitam)", "Bintang (Putih)", "Halilintar (Coklat)"];
        const opts = horses.map(h => ({
            text: `Taruhan: ${h} (500 G)`,
            action: () => {
                if (p.money >= 500) {
                    p.money -= 500;
                    const winnerIdx = Math.floor(Math.random() * horses.length);
                    const winnerName = horses[winnerIdx];
                    if (h === winnerName) {
                        const prize = 2000;
                        p.money += prize;
                        showDialogue("MENANG BESAR! ", `Kudamu **${h}** finish di posisi pertama!\nHadiah: ${prize} G`, [{text:"Yesss!", action:closeDialogue}], 'images/kuda.png');
                    } else {
                        showDialogue("KALAH...", `Pemenangnya adalah **${winnerName}**.\nKudamu finish di posisi terakhir. Uang hangus.`, [{text:"Sial...", action:closeDialogue}], 'images/kuda.png');
                    }
                } else showToast("Uang kurang.");
            }
        }));
        opts.push({text: "Nonton saja", action: closeDialogue});
        showDialogue("PACUAN KUDA DESA", "Ayo dukung kuda jagoanmu! Tiket taruhan 500 G.", opts, 'images/kuda.png');
    }
    // 4. LOMBA MEMASAK
    else if (name.includes("Memasak")) {
        showDialogue("KITCHEN STADIUM", "Tema tahun ini: **Sup Ikan**. Juri akan menilai bahan dan skill memasakmu.", 
            [
                {
                    text: "Ikut Lomba (Butuh Ikan + INT)", 
                    action: () => {
                        if ((p.inventory['ikan_segar'] || 0) > 0) {
                            p.inventory['ikan_segar']--; 
                            const score = Math.floor(Math.random() * 50) + p.int;
                            if (score > 60) {
                                addItem('tonic_stamina', 3);
                                showDialogue("JUARA 1! ", `Rasanya sempurna! Juri menangis terharu.\nHadiah: **3 Tonic Stamina**.`, [{text:"Hore!", action:closeDialogue}], 'images/dapurayaayu.png');
                            } else if (score > 30) {
                                addItem('gandum', 2);
                                showDialogue("JUARA HARAPAN", "Rasanya lumayan, tapi kurang asin.\nHadiah: **2 Gandum**.", [{text:"Lumayan", action:closeDialogue}], 'images/dapurayaayu.png');
                            } else {
                                showDialogue("GOSONG...", "Masakanmu gosong. Juri sakit perut. Kamu didiskualifikasi.", [{text:"Maaf...", action:closeDialogue}], 'images/tungku.png');
                            }
                        } else {
                            showToast("Kamu tidak punya Ikan Segar!");
                        }
                    }
                },
                {text: "Jadi Penonton (Makan Gratis)", action: () => {
                    p.energy = 100;
                    showToast("Kenyang makan tester! Energi Full.");
                    closeDialogue();
                }}
            ], 'images/dapurayaayu.png');
    }
    // 5. FESTIVAL AYAM
    else if (name.includes("Ayam")) {
        const hasPetChicken = p.dailyTalkCount > 0;
        if (hasPetChicken) {
            showDialogue("KONTES AYAM", "Ayam milikmu terlihat sehat dan bahagia! Juri terkesan.", [{
                text: "Terima Hadiah Telur Emas (500G)", 
                action: () => {
                    p.money += 500;
                    showToast("Hadiah Juara: 500 G");
                    closeDialogue();
                }
            }], 'images/ayam.png');
        } else {
            showDialogue("KONTES AYAM", "Kamu tidak membawa ayam atau belum merawat ayam hari ini.\nNonton saja ya.", [{text:"Oke", action:closeDialogue}], 'images/ayam.png');
        }
    }
    // 6. LOMBA BERENANG
    else if (name.includes("Berenang")) {
        showDialogue("LOMBA RENANG PANTAI", "Siapa yang paling kuat menahan napas dan berenang ke tengah laut?", 
            [{
                text: "Ikut Lomba (Butuh 50 Energi)", 
                action: () => {
                    if (p.energy >= 50) {
                        p.energy -= 40;
                        if (p.str >= 15) {
                            addItem('permata', 1);
                            showDialogue("JUARA RENANG! ", "Ototmu luar biasa! Kamu mengalahkan Pak Nelayan.\nHadiah: **1 Berlian**.", [{text:"Segar!", action:closeDialogue}], 'images/pantai-boy.png');
                        } else {
                            showDialogue("KALAH...", "Kamu kram di tengah jalan dan harus ditolong tim SAR.\nLatih lagi STR-mu.", [{text:"Malu...", action:closeDialogue}], 'images/pantai-boy.png');
                        }
                    } else showToast("Energimu kurang untuk lomba.");
                }
            }, {text: "Batal", action: closeDialogue}], 'images/pantai-girl.png');
    }
    // 7. HALLOWEEN
    else if (name.includes("Hantu") || name.includes("Halloween")) {
        showDialogue("MALAM HANTU ", "Anak-anak berkeliaran pakai kostum. 'Trick or Treat!'", 
            [
                {
                    text: "Beri Permen (Coklat) -> Dapat Hadiah", 
                    action: () => {
                        if ((p.inventory['coklat'] || 0) > 0) {
                            p.inventory['coklat']--;
                            const rewards = ['besi', 'kain', 'gandum'];
                            const reward = rewards[Math.floor(Math.random()*rewards.length)];
                            addItem(reward, 2);
                            showDialogue("TRICK OR TREAT!", `Anak-anak senang! Mereka memberimu **2 ${reward.toUpperCase()}** sebagai balasan.`, [{text:"Seru!", action:closeDialogue}], 'images/anakkecil1.png');
                        } else {
                            showToast("Kamu tidak punya Coklat!");
                        }
                    }
                },
                {
                    text: "Minta Permen (Dikasih Sampah)",
                    action: () => {
                        showDialogue("ZONK", "Kamu kan sudah gede! Nih dikasih bungkusnya aja.", [{text:"Pelit...", action:closeDialogue}], 'images/monster.png');
                    }
                }
            ], 'images/monster.png');
    }
    // 8. MANCING ES
    else if (name.includes("Mancing")) {
        showDialogue("TURNAMEN MANCING ES", "Danau membeku, ikan-ikan bersembunyi di dalam. Siapa dapat ikan paling banyak?", 
            [{
                text: "Setor Ikan (Dari Tas)", 
                action: () => {
                    const fish = (p.inventory['ikan_segar'] || 0) + (p.inventory['ikan_besar'] || 0) + (p.inventory['ikan_legendary'] || 0);
                    if (fish >= 3) {
                        addItem('scroll_exp', 1);
                        showDialogue("PEMANCING HANDAL ", `Kamu membawa ${fish} ikan! Juri takjub.\nHadiah: **Gulungan Kuno (+EXP)**.`, [{text:"Mantap", action:closeDialogue}], 'images/rakpialaikan.png');
                    } else {
                        showDialogue("KURANG...", "Minimal bawa 3 ikan untuk ikut penilaian.", [{text:"Aku mancing dulu", action:closeDialogue}], 'images/emberikan.png');
                    }
                }
            }, {text: "Batal", action: closeDialogue}], 'images/rakpancing.png');
    }
    // 9. NATAL
    else if (name.includes("Natal") || name.includes("Bintang")) {
        showDialogue("MALAM BINTANG ", "Pohon Natal raksasa berdiri di alun-alun. Ada kado di bawahnya untukmu.", 
            [{
                text: "Buka Kado Misterius ", 
                action: () => {
                    const year = Math.ceil(STATE.day / 120);
                    if (p.lastXmasYear !== year) {
                        p.lastXmasYear = year;
                        const randGift = Math.random() < 0.5 ? 'cincin_kayu' : 'baju_hangat'; 
                        if (randGift === 'cincin_kayu') {
                            addItem('cincin_kayu', 1);
                            showDialogue("SELAMAT NATAL!", "Kamu mendapat **Cincin Kayu**! Bisa dipakai melamar seseorang.", [{text:"Terima kasih Santa!", action:closeDialogue}], 'images/lemari.png');
                        } else {
                            addItem('kain', 3);
                            showDialogue("SELAMAT NATAL!", "Kamu mendapat **3 Kain Sutra**! Hangat sekali.", [{text:"Terima kasih!", action:closeDialogue}], 'images/lemari.png');
                        }
                    } else {
                        showToast("Kamu sudah ambil kado tahun ini!");
                        closeDialogue();
                    }
                }
            }], 'images/statue.png');
    }
    // DEFAULT
    else {
        showDialogue(`MERAYAKAN ${name.toUpperCase()}`, 
            "Kamu menikmati suasana festival yang meriah. Makan enak, musik asik, teman baik.", 
            [{
                text: "Nikmati (Energi Penuh)", 
                action: () => {
                    p.energy = 100;
                    p.reputation += 2;
                    showToast("Energi Pulih & Reputasi +2");
                    closeDialogue();
                }
            }], 'images/statue.png');
    }
}

// --- [AKHIR KODE PERTANIAN] ---

// --- NEW: PWA SERVICE WORKER (FITUR SIMPAN ASET OFFLINE) ---
// Kode ini membuat browser menyimpan gambar secara agresif agar tidak download ulang
// [UPDATE] Dinonaktifkan sementara karena Blob URL tidak didukung di lingkungan preview ini
/*
if ('serviceWorker' in navigator) {
    window.addEventListener('load', function() {
        // Kita gunakan Blob untuk membuat Service Worker tanpa file eksternal (Single File Magic)
        const swCode = `
            const CACHE_NAME = 'nusantara-arsa-cache-v1';
            
            self.addEventListener('install', event => {
                self.skipWaiting(); // Langsung aktifkan
            });

            self.addEventListener('fetch', event => {
                event.respondWith(
                    caches.match(event.request)
                        .then(response => {
                            // 1. Jika ada di Cache, gunakan itu (Hemat Kuota)
                            if (response) {
                                return response;
                            }
                            // 2. Jika tidak, download dari internet lalu simpan ke Cache
                            return fetch(event.request).then(
                                function(networkResponse) {
                                    // Cek validitas respon
                                    if(!networkResponse || networkResponse.status !== 200 || networkResponse.type !== 'basic') {
                                        return networkResponse;
                                    }
                                    
                                    // Filter: Hanya cache file Gambar dan Audio
                                    if(event.request.url.match(/\\.(png|jpg|jpeg|svg|mp3)$/)) {
                                        var responseToCache = networkResponse.clone();
                                        caches.open(CACHE_NAME)
                                            .then(function(cache) {
                                                cache.put(event.request, responseToCache);
                                            });
                                    }
                                    return networkResponse;
                                }
                            );
                        })
                );
            });
        `;
        
        // Buat URL virtual untuk script Service Worker
        const blob = new Blob([swCode], {type: 'text/javascript'});
        const swUrl = URL.createObjectURL(blob);
        
        navigator.serviceWorker.register(swUrl).then(function(registration) {
            console.log('ServiceWorker PWA registered with scope:', registration.scope);
        }).catch(function(err) {
            console.log('ServiceWorker registration failed:', err);
        });
    });
}
*/

        // Fungsi untuk memaksa masuk Full Screen kembali
        function resumeFullscreen() {
            var elem = document.documentElement;

            // 1. Minta Fullscreen
            if (elem.requestFullscreen) {
                elem.requestFullscreen().then(() => {
                    // 2. SETELAH Fullscreen Berhasil, BARU Paksa Landscape
                    // Ini kunci agar layar HP otomatis miring
                    if (screen.orientation && screen.orientation.lock) {
                        screen.orientation.lock('landscape').catch(e => console.log(e));
                    }
                }).catch(err => {
                    console.log("Gagal Fullscreen: ", err);
                });
            } else if (elem.webkitRequestFullscreen) { /* Safari */
                elem.webkitRequestFullscreen();
            } else if (elem.msRequestFullscreen) { /* IE11 */
                elem.msRequestFullscreen();
            }

            // 3. Hilangkan layar hitam
            document.getElementById('resume-overlay').style.display = 'none';
        }

        // Event Listener: Mata-mata yang memantau apakah kita pindah tab/aplikasi
        document.addEventListener("visibilitychange", function() {
            // Jika halaman sedang AKTIF (Kita kembali ke tab Chrome ini)
            if (!document.hidden) {
                console.log("Pengguna kembali ke game.");

                // Cek: Apakah Fullscreen-nya lepas?
                // (Biasanya 'null' kalau lepas)
                if (!document.fullscreenElement && !document.webkitFullscreenElement) {
                    
                    // JIKA LEPAS: Munculkan layar hitam agar user menekan tombol lagi
                    document.getElementById('resume-overlay').style.display = 'flex';
                }
            }
        });

        // Tambahan: Kadang di HP orientasi berubah bikin fullscreen lepas
        window.addEventListener("resize", function() {
            // Cek tinggi layar, jika mendadak kecil (status bar muncul), tawarkan fullscreen lagi
            if (window.innerHeight < screen.height * 0.8) {
                // Jangan langsung paksa (browser blokir), tapi tampilkan tombol overlay jika belum ada
                // Logic ini opsional, yang utama adalah 'visibilitychange' di atas.
            }
        });

// --- FITUR BARU: WARNET & FREELANCE ---
const WARNET_SOAL = [
    { q: "Apa singkatan dari CPU?", a: "Central Processing Unit", b: "Central Process Umbrella", valid: 0 },
    { q: "Bahasa untuk struktur web?", a: "HTML", b: "Snake", valid: 0 },
    { q: "Untuk menghias tampilan web?", a: "CSS", b: "PDF", valid: 0 },
    { q: "1 Byte berapa bit?", a: "10 Bit", b: "8 Bit", valid: 1 },
    { q: "Shortcut Copy?", a: "Ctrl+C", b: "Alt+F4", valid: 0 }
];
let currentWarnetSoal = null;

// --- UPDATE FUNGSI WARNET MENU (GANTI LOGIKA MAIN GAME) ---
        function openWarnetMenu() {
            showDialogue("WARNET DESA", "Selamat datang! \nKoneksi kencang, PC spek dewa. \nTarif: 500 Gold / Sesi.", [
                {text: " Kerja Freelance (Dapat Uang)", action: () => {
                    if(STATE.player.money >= 500) {
                        if(STATE.player.energy >= 20) {
                            STATE.player.money -= 500;
                            STATE.player.energy -= 20;
                            closeDialogue();
                            openWarnetGame(); // Buka Minigame Coding
                        } else showToast("Energi kurang (Butuh 20)");
                    } else showToast("Uang sewa kurang (500 G)");
                }},
                // --- UPDATE: Panggil Game Balap ---
                {text: " Main Balap Liar (Dapat Energi)", action: () => {
                     startRacingGame();
                }},
                {text: "Batal", action: closeDialogue}
            ], 'images/warnet.png');
        }
		
		 let raceState = {
            active: false,
            score: 0,
            carX: 130, // Posisi Tengah (Lane 2)
            enemies: [],
            scenery: [], // Pohon/Batu
            speed: 5,
            animationId: null
        };

        function startRacingGame() {
            // Cek Uang
            if(STATE.player.money < 500) {
                showToast("Uang tidak cukup (Butuh 500 G)");
                return;
            }
            
            // Bayar
            STATE.player.money -= 500;
            
            // Tutup Dialog Menu Warnet
            closeDialogue();
            
            // Buka Overlay
            document.getElementById('racing-minigame').style.display = 'flex';
            STATE.screen = 'minigame';
            
            // Reset State
            raceState.score = 0;
            raceState.carX = 130;
            raceState.enemies = [];
            raceState.scenery = [];
            raceState.speed = 4; // Start speed lebih cepat dikit
            raceState.active = false; // Tunggu tap start
            
            // Update UI Awal
            updateRaceUI();
            
            // Reset Visual ke Gambar Mobil
            const pCar = document.getElementById('player-car');
            pCar.style.transform = 'none'; // Reset rotasi jika sebelumnya diset oleh error
            // FIX: Terapkan perbaikan yang sama pada string injeksi HTML
            pCar.innerHTML = '<img src="images/player-race.png" style="width: 100%; height: 100%; object-fit: contain;" onerror="var p=this.parentElement; this.style.display=\'none\'; p.innerText=\'\'; p.style.fontSize=\'40px\'; p.style.transform=\'rotate(-90deg)\'">';
            pCar.classList.remove('explosion');
            
            // Mulai animasi jalan
            document.getElementById('road-lines').classList.add('road-moving');

            document.getElementById('score-race').innerText = "SKOR: 0";
            document.getElementById('start-msg-race').style.display = 'block';
            
            // Bersihkan musuh lama & scenery
            const track = document.getElementById('race-track');
            const oldEnemies = track.querySelectorAll('.enemy-car');
            oldEnemies.forEach(e => e.remove());
            
            const oldScenery = track.querySelectorAll('.scenery-item');
            oldScenery.forEach(s => s.remove());
            
            // UPDATE: Hapus listener klik manual karena sudah diganti div overlay
            document.getElementById('race-track').onclick = null; 
        }

        function initRace() {
            raceState.active = true;
            document.getElementById('start-msg-race').style.display = 'none';
            document.getElementById('race-track').onclick = null; // Hapus listener start
            raceLoop();
        }

        function moveCar(dir) {
            // Jika game belum mulai, tap tombol juga bisa trigger start
            if (!raceState.active && document.getElementById('racing-minigame').style.display === 'flex') {
                // Jangan start lewat tombol arah
                return;
            }
            
            // Pindah Jalur (Kiri/Kanan) sejauh 100px
            raceState.carX += dir * 100; 
            
            // Batasi Jalur (Clamp)
            if (raceState.carX < 30) raceState.carX = 30; // Lane 1
            if (raceState.carX > 230) raceState.carX = 230; // Lane 3
            
            updateRaceUI();
        }

        function updateRaceUI() {
            const pCar = document.getElementById('player-car');
            pCar.style.left = raceState.carX + 'px';
        }

        function raceLoop() {
            if (!raceState.active) return;
            
            const track = document.getElementById('race-track');

            // --- 1. SPAWN SCENERY (PINGGIR JALAN) ---
            if(Math.random() < 0.1) { // 10% chance
                const side = Math.random() < 0.5 ? 'left' : 'right';
                const type = Math.random() < 0.7 ? '' : ''; // Pohon atau Batu
                
                const el = document.createElement('div');
                el.innerText = type;
                el.className = 'scenery-item';
                el.style.position = 'absolute';
                el.style.top = '-30px';
                el.style.fontSize = '20px';
                
                if(side === 'left') el.style.left = (Math.random() * 10) + 'px';
                else el.style.right = (Math.random() * 10) + 'px';
                
                track.appendChild(el);
                raceState.scenery.push({ y: -30, el: el });
            }

            // Move Scenery
            for(let i = raceState.scenery.length - 1; i >= 0; i--) {
                let item = raceState.scenery[i];
                item.y += raceState.speed;
                item.el.style.top = item.y + 'px';
                if(item.y > 420) {
                    item.el.remove();
                    raceState.scenery.splice(i, 1);
                }
            }

            // --- 2. SPAWN ENEMY (MOBIL/TRUK) ---
            // Peluang spawn meningkat seiring skor
            if (Math.random() < 0.015 + (raceState.score * 0.001)) {
                spawnEnemyCar();
            }
            
            // Update posisi musuh
            for (let i = raceState.enemies.length - 1; i >= 0; i--) {
                let en = raceState.enemies[i];
                en.y += raceState.speed; // Ikuti kecepatan player seolah player maju
                
                // Buat elemen DOM jika belum ada
                if (!en.el) {
                    en.el = document.createElement('div');
                    en.el.className = 'enemy-car';
                    // en.el.innerText = en.icon; // OLD: Text Only
                    en.el.style.position = 'absolute';
                    en.el.style.fontSize = '35px'; // Ukuran mobil (Fallback Icon)
                    en.el.style.width = '40px';
                    en.el.style.height = '40px';
                    en.el.style.display = 'flex';
                    en.el.style.justifyContent = 'center';
                    en.el.style.alignItems = 'center';
                    
                    // UPDATE: Jangan putar container secara default (Hanya putar jika Fallback ke Icon)
                    // Agar gambar Top-Down tidak miring
                    // en.el.style.transform = 'rotate(-90deg)'; <-- DIHAPUS
                    
                    en.el.style.top = en.y + 'px';
                    en.el.style.left = en.x + 'px';
                    
                    // UPDATE: Render Gambar jika ada, Fallback ke Icon dengan Rotasi
                    if (en.img) {
                        // Jika gambar gagal (onerror), baru kita putar parent-nya -90deg dan tampilkan icon
                        en.el.innerHTML = `<img src="${en.img}" style="width: 100%; height: 100%; object-fit: contain;" onerror="var p=this.parentElement; this.style.display='none'; p.innerText='${en.icon}'; p.style.fontSize='40px'; p.style.transform='rotate(-90deg)'">`;
                    } else {
                        en.el.innerText = en.icon;
                        en.el.style.transform = 'rotate(-90deg)'; // Putar jika hanya icon
                    }

                    // Truk sedikit lebih besar visualnya (Fallback font size)
                    if(en.type === 'truck') en.el.style.fontSize = '45px';
                    
                    track.appendChild(en.el);
                } else {
                    en.el.style.top = en.y + 'px';
                }
                
                // Cek Tabrakan (Hitbox Sederhana)
                // Mobil Player Y = Bottom 20px (Sekitar 340-380px dari atas)
                // X harus sama (satu jalur)
                if (Math.abs(en.x - raceState.carX) < 20 && en.y > 320 && en.y < 380) {
                    gameOverRace();
                    return;
                }
                
                // Cek Lewat (Score)
                if (en.y > 420) {
                    en.el.remove(); // Hapus dari DOM
                    raceState.enemies.splice(i, 1); // Hapus dari Array
                    raceState.score++;
                    
                    // Makin lama makin cepat
                    if(raceState.score % 5 === 0) raceState.speed += 0.5;
                }
            }
            
            document.getElementById('score-race').innerText = "SKOR: " + raceState.score;
            raceState.animationId = requestAnimationFrame(raceLoop);
        }

        function spawnEnemyCar() {
            // 3 Jalur: 30, 130, 230 (Sesuai posisi player)
            const lanes = [30, 130, 230];
            const x = lanes[Math.floor(Math.random() * lanes.length)];
            
            // Variasi Musuh (UPDATE: Tambahkan Property Gambar)
            const types = [
                {icon: '', type: 'truck', img: 'images/truck-race.png'}, // Truk (Besar)
                {icon: '', type: 'taxi', img: 'images/taxi-race.png'},
                {icon: '', type: 'suv', img: 'images/suv-race.png'},
                {icon: '', type: 'bike', img: 'images/bike-race.png'}
            ];
            const chosen = types[Math.floor(Math.random() * types.length)];

            // Jangan spawn jika jalur itu baru saja ada mobil (biar gak numpuk)
            const tooClose = raceState.enemies.some(e => e.x === x && e.y < 80);
            if (!tooClose) {
                // UPDATE: Push dengan properti img
                raceState.enemies.push({ x: x, y: -60, el: null, icon: chosen.icon, type: chosen.type, img: chosen.img });
            }
        }

        function gameOverRace() {
            raceState.active = false;
            cancelAnimationFrame(raceState.animationId);
            
            // Hentikan animasi jalan
            document.getElementById('road-lines').classList.remove('road-moving');

            // EFEK LEDAKAN
            const pCar = document.getElementById('player-car');
            pCar.innerText = ''; // Ganti jadi ledakan
            pCar.classList.add('explosion'); // Tambah animasi CSS
            
            if(typeof AudioService !== 'undefined') AudioService.playSFX('hit');

            // Delay agar ledakan terlihat dulu
            setTimeout(() => {
                // Konversi Skor ke Energi (1 Skor = 1 Energi, Max 100)
                const energyGain = Math.min(100, raceState.score); 
                STATE.player.energy = Math.min(100, STATE.player.energy + energyGain);
                
                // UPDATE: GANTI ALERT DENGAN DIALOGUE AGAR TIDAK KELUAR FULLSCREEN
                quitRacing(); // Tutup overlay balap dulu
                
                showDialogue("TABRAKAN MAUT! ", 
                    `Mobilmu hancur!\n\nSkor Akhir: **${raceState.score}**\nEnergi Pulih: **+${energyGain}**`, 
                    [{
                        text: "Lanjut Main", 
                        action: () => {
                            closeDialogue();
                            // Paksa fullscreen lagi jaga-jaga
                            toggleFullScreen();
                        }
                    }], 
                    'images/player-race.png'
                );
                
            }, 800);
        }

        function quitRacing() {
            raceState.active = false;
            if(raceState.animationId) cancelAnimationFrame(raceState.animationId);
            document.getElementById('racing-minigame').style.display = 'none';
            STATE.screen = 'play';
        }
        
function openWarnetGame() {
    STATE.screen = 'minigame';
    document.getElementById('warnet-modal').style.display = 'flex';
    
    // Pilih Soal Acak
    const idx = Math.floor(Math.random() * WARNET_SOAL.length);
    currentWarnetSoal = WARNET_SOAL[idx];
    
    // Tampilkan Soal
    document.getElementById('warnet-task-desc').innerText = "KLIEN BERTANYA: " + currentWarnetSoal.q;
    document.getElementById('warnet-code-display').innerText = "PILIH JAWABAN YANG BENAR";
    document.getElementById('btn-code-a').innerText = currentWarnetSoal.a;
    document.getElementById('btn-code-b').innerText = currentWarnetSoal.b;
}

function checkWarnetAnswer(pilihan) {
    if(pilihan === currentWarnetSoal.valid) {
        // Menang
        const gaji = 1500 + (STATE.player.int * 50);
        STATE.player.money += gaji;
        STATE.player.int += 1; // Nambah pinter
        gainExp(50);
        showToast(`Project Selesai! Dibayar ${gaji} G`);
        if(typeof AudioService !== 'undefined') AudioService.playSFX('item');
    } else {
        // Kalah
        showToast("Project Gagal... Klien Marah (Bug!)");
        if(typeof AudioService !== 'undefined') AudioService.playSFX('hit');
    }
    closeWarnetGame();
}

function closeWarnetGame() {
    document.getElementById('warnet-modal').style.display = 'none';
    STATE.screen = 'play';
}
</script>
</body>
</html>
